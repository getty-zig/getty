<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>build/LibExeObjStep.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../std.zig&quot;</span>);</span>
<span class="line" id="L3"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> log = std.log;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> fs = std.fs;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> panic = std.debug.panic;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> ArrayList = std.ArrayList;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> StringHashMap = std.StringHashMap;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> Sha256 = std.crypto.hash.sha2.Sha256;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> Allocator = mem.Allocator;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> build = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../build.zig&quot;</span>);</span>
<span class="line" id="L13"><span class="tok-kw">const</span> Step = build.Step;</span>
<span class="line" id="L14"><span class="tok-kw">const</span> Builder = build.Builder;</span>
<span class="line" id="L15"><span class="tok-kw">const</span> CrossTarget = std.zig.CrossTarget;</span>
<span class="line" id="L16"><span class="tok-kw">const</span> NativeTargetInfo = std.zig.system.NativeTargetInfo;</span>
<span class="line" id="L17"><span class="tok-kw">const</span> FileSource = std.build.FileSource;</span>
<span class="line" id="L18"><span class="tok-kw">const</span> PkgConfigPkg = Builder.PkgConfigPkg;</span>
<span class="line" id="L19"><span class="tok-kw">const</span> PkgConfigError = Builder.PkgConfigError;</span>
<span class="line" id="L20"><span class="tok-kw">const</span> ExecError = Builder.ExecError;</span>
<span class="line" id="L21"><span class="tok-kw">const</span> Pkg = std.build.Pkg;</span>
<span class="line" id="L22"><span class="tok-kw">const</span> VcpkgRoot = std.build.VcpkgRoot;</span>
<span class="line" id="L23"><span class="tok-kw">const</span> InstallDir = std.build.InstallDir;</span>
<span class="line" id="L24"><span class="tok-kw">const</span> InstallArtifactStep = std.build.InstallArtifactStep;</span>
<span class="line" id="L25"><span class="tok-kw">const</span> GeneratedFile = std.build.GeneratedFile;</span>
<span class="line" id="L26"><span class="tok-kw">const</span> InstallRawStep = std.build.InstallRawStep;</span>
<span class="line" id="L27"><span class="tok-kw">const</span> EmulatableRunStep = std.build.EmulatableRunStep;</span>
<span class="line" id="L28"><span class="tok-kw">const</span> CheckObjectStep = std.build.CheckObjectStep;</span>
<span class="line" id="L29"><span class="tok-kw">const</span> RunStep = std.build.RunStep;</span>
<span class="line" id="L30"><span class="tok-kw">const</span> OptionsStep = std.build.OptionsStep;</span>
<span class="line" id="L31"><span class="tok-kw">const</span> LibExeObjStep = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L32"></span>
<span class="line" id="L33"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> base_id = .lib_exe_obj;</span>
<span class="line" id="L34"></span>
<span class="line" id="L35">step: Step,</span>
<span class="line" id="L36">builder: *Builder,</span>
<span class="line" id="L37">name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L38">target: CrossTarget = CrossTarget{},</span>
<span class="line" id="L39">target_info: NativeTargetInfo,</span>
<span class="line" id="L40">linker_script: ?FileSource = <span class="tok-null">null</span>,</span>
<span class="line" id="L41">version_script: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L42">out_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L43">linkage: ?Linkage = <span class="tok-null">null</span>,</span>
<span class="line" id="L44">version: ?std.builtin.Version,</span>
<span class="line" id="L45">build_mode: std.builtin.Mode,</span>
<span class="line" id="L46">kind: Kind,</span>
<span class="line" id="L47">major_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L48">name_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L49">strip: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L50">unwind_tables: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L51"><span class="tok-comment">// keep in sync with src/link.zig:CompressDebugSections</span>
</span>
<span class="line" id="L52">compress_debug_sections: <span class="tok-kw">enum</span> { none, zlib } = .none,</span>
<span class="line" id="L53">lib_paths: ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L54">rpaths: ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L55">framework_dirs: ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L56">frameworks: StringHashMap(FrameworkLinkInfo),</span>
<span class="line" id="L57">verbose_link: <span class="tok-type">bool</span>,</span>
<span class="line" id="L58">verbose_cc: <span class="tok-type">bool</span>,</span>
<span class="line" id="L59">emit_analysis: EmitOption = .default,</span>
<span class="line" id="L60">emit_asm: EmitOption = .default,</span>
<span class="line" id="L61">emit_bin: EmitOption = .default,</span>
<span class="line" id="L62">emit_docs: EmitOption = .default,</span>
<span class="line" id="L63">emit_implib: EmitOption = .default,</span>
<span class="line" id="L64">emit_llvm_bc: EmitOption = .default,</span>
<span class="line" id="L65">emit_llvm_ir: EmitOption = .default,</span>
<span class="line" id="L66"><span class="tok-comment">// Lots of things depend on emit_h having a consistent path,</span>
</span>
<span class="line" id="L67"><span class="tok-comment">// so it is not an EmitOption for now.</span>
</span>
<span class="line" id="L68">emit_h: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L69">bundle_compiler_rt: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L70">single_threaded: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L71">stack_protector: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L72">disable_stack_probing: <span class="tok-type">bool</span>,</span>
<span class="line" id="L73">disable_sanitize_c: <span class="tok-type">bool</span>,</span>
<span class="line" id="L74">sanitize_thread: <span class="tok-type">bool</span>,</span>
<span class="line" id="L75">rdynamic: <span class="tok-type">bool</span>,</span>
<span class="line" id="L76">import_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L77">import_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L78">export_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L79">initial_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L80">max_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L81">shared_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L82">global_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L83">c_std: Builder.CStd,</span>
<span class="line" id="L84">override_lib_dir: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L85">main_pkg_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L86">exec_cmd_args: ?[]<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L87">name_prefix: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L88">filter: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L89">test_evented_io: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L90">test_runner: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L91">code_model: std.builtin.CodeModel = .default,</span>
<span class="line" id="L92">wasi_exec_model: ?std.builtin.WasiExecModel = <span class="tok-null">null</span>,</span>
<span class="line" id="L93"><span class="tok-comment">/// Symbols to be exported when compiling to wasm</span></span>
<span class="line" id="L94">export_symbol_names: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = &amp;.{},</span>
<span class="line" id="L95"></span>
<span class="line" id="L96">root_src: ?FileSource,</span>
<span class="line" id="L97">out_h_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L98">out_lib_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L99">out_pdb_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L100">packages: ArrayList(Pkg),</span>
<span class="line" id="L101"></span>
<span class="line" id="L102">object_src: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L103"></span>
<span class="line" id="L104">link_objects: ArrayList(LinkObject),</span>
<span class="line" id="L105">include_dirs: ArrayList(IncludeDir),</span>
<span class="line" id="L106">c_macros: ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L107">output_dir: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L108">is_linking_libc: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L109">is_linking_libcpp: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L110">vcpkg_bin_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L111"></span>
<span class="line" id="L112"><span class="tok-comment">/// This may be set in order to override the default install directory</span></span>
<span class="line" id="L113">override_dest_dir: ?InstallDir,</span>
<span class="line" id="L114">installed_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L115">install_step: ?*InstallArtifactStep,</span>
<span class="line" id="L116"></span>
<span class="line" id="L117"><span class="tok-comment">/// Base address for an executable image.</span></span>
<span class="line" id="L118">image_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L119"></span>
<span class="line" id="L120">libc_file: ?FileSource = <span class="tok-null">null</span>,</span>
<span class="line" id="L121"></span>
<span class="line" id="L122">valgrind_support: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L123">each_lib_rpath: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L124"><span class="tok-comment">/// On ELF targets, this will emit a link section called &quot;.note.gnu.build-id&quot;</span></span>
<span class="line" id="L125"><span class="tok-comment">/// which can be used to coordinate a stripped binary with its debug symbols.</span></span>
<span class="line" id="L126"><span class="tok-comment">/// As an example, the bloaty project refuses to work unless its inputs have</span></span>
<span class="line" id="L127"><span class="tok-comment">/// build ids, in order to prevent accidental mismatches.</span></span>
<span class="line" id="L128"><span class="tok-comment">/// The default is to not include this section because it slows down linking.</span></span>
<span class="line" id="L129">build_id: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L130"></span>
<span class="line" id="L131"><span class="tok-comment">/// Create a .eh_frame_hdr section and a PT_GNU_EH_FRAME segment in the ELF</span></span>
<span class="line" id="L132"><span class="tok-comment">/// file.</span></span>
<span class="line" id="L133">link_eh_frame_hdr: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L134">link_emit_relocs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L135"></span>
<span class="line" id="L136"><span class="tok-comment">/// Place every function in its own section so that unused ones may be</span></span>
<span class="line" id="L137"><span class="tok-comment">/// safely garbage-collected during the linking phase.</span></span>
<span class="line" id="L138">link_function_sections: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L139"></span>
<span class="line" id="L140"><span class="tok-comment">/// Remove functions and data that are unreachable by the entry point or</span></span>
<span class="line" id="L141"><span class="tok-comment">/// exported symbols.</span></span>
<span class="line" id="L142">link_gc_sections: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L143"></span>
<span class="line" id="L144">linker_allow_shlib_undefined: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L145"></span>
<span class="line" id="L146"><span class="tok-comment">/// Permit read-only relocations in read-only segments. Disallowed by default.</span></span>
<span class="line" id="L147">link_z_notext: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L148"></span>
<span class="line" id="L149"><span class="tok-comment">/// Force all relocations to be read-only after processing.</span></span>
<span class="line" id="L150">link_z_relro: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L151"></span>
<span class="line" id="L152"><span class="tok-comment">/// Allow relocations to be lazily processed after load.</span></span>
<span class="line" id="L153">link_z_lazy: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L154"></span>
<span class="line" id="L155"><span class="tok-comment">/// (Darwin) Install name for the dylib</span></span>
<span class="line" id="L156">install_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L157"></span>
<span class="line" id="L158"><span class="tok-comment">/// (Darwin) Path to entitlements file</span></span>
<span class="line" id="L159">entitlements: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L160"></span>
<span class="line" id="L161"><span class="tok-comment">/// (Darwin) Size of the pagezero segment.</span></span>
<span class="line" id="L162">pagezero_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L163"></span>
<span class="line" id="L164"><span class="tok-comment">/// (Darwin) Search strategy for searching system libraries. Either `paths_first` or `dylibs_first`.</span></span>
<span class="line" id="L165"><span class="tok-comment">/// The former lowers to `-search_paths_first` linker option, while the latter to `-search_dylibs_first`</span></span>
<span class="line" id="L166"><span class="tok-comment">/// option.</span></span>
<span class="line" id="L167"><span class="tok-comment">/// By default, if no option is specified, the linker assumes `paths_first` as the default</span></span>
<span class="line" id="L168"><span class="tok-comment">/// search strategy.</span></span>
<span class="line" id="L169">search_strategy: ?<span class="tok-kw">enum</span> { paths_first, dylibs_first } = <span class="tok-null">null</span>,</span>
<span class="line" id="L170"></span>
<span class="line" id="L171"><span class="tok-comment">/// (Darwin) Set size of the padding between the end of load commands</span></span>
<span class="line" id="L172"><span class="tok-comment">/// and start of `__TEXT,__text` section.</span></span>
<span class="line" id="L173">headerpad_size: ?<span class="tok-type">u32</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L174"></span>
<span class="line" id="L175"><span class="tok-comment">/// (Darwin) Automatically Set size of the padding between the end of load commands</span></span>
<span class="line" id="L176"><span class="tok-comment">/// and start of `__TEXT,__text` section to a value fitting all paths expanded to MAXPATHLEN.</span></span>
<span class="line" id="L177">headerpad_max_install_names: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L178"></span>
<span class="line" id="L179"><span class="tok-comment">/// (Darwin) Remove dylibs that are unreachable by the entry point or exported symbols.</span></span>
<span class="line" id="L180">dead_strip_dylibs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L181"></span>
<span class="line" id="L182"><span class="tok-comment">/// Position Independent Code</span></span>
<span class="line" id="L183">force_pic: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L184"></span>
<span class="line" id="L185"><span class="tok-comment">/// Position Independent Executable</span></span>
<span class="line" id="L186">pie: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L187"></span>
<span class="line" id="L188">red_zone: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L189"></span>
<span class="line" id="L190">omit_frame_pointer: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L191">dll_export_fns: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L192"></span>
<span class="line" id="L193">subsystem: ?std.Target.SubSystem = <span class="tok-null">null</span>,</span>
<span class="line" id="L194"></span>
<span class="line" id="L195">entry_symbol_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L196"></span>
<span class="line" id="L197"><span class="tok-comment">/// Overrides the default stack size</span></span>
<span class="line" id="L198">stack_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L199"></span>
<span class="line" id="L200">want_lto: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L201">use_llvm: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L202">use_lld: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">output_path_source: GeneratedFile,</span>
<span class="line" id="L205">output_lib_path_source: GeneratedFile,</span>
<span class="line" id="L206">output_h_path_source: GeneratedFile,</span>
<span class="line" id="L207">output_pdb_path_source: GeneratedFile,</span>
<span class="line" id="L208"></span>
<span class="line" id="L209"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CSourceFiles = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L210">    files: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L211">    flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L212">};</span>
<span class="line" id="L213"></span>
<span class="line" id="L214"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CSourceFile = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L215">    source: FileSource,</span>
<span class="line" id="L216">    args: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L217"></span>
<span class="line" id="L218">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dupe</span>(self: CSourceFile, b: *Builder) CSourceFile {</span>
<span class="line" id="L219">        <span class="tok-kw">return</span> .{</span>
<span class="line" id="L220">            .source = self.source.dupe(b),</span>
<span class="line" id="L221">            .args = b.dupeStrings(self.args),</span>
<span class="line" id="L222">        };</span>
<span class="line" id="L223">    }</span>
<span class="line" id="L224">};</span>
<span class="line" id="L225"></span>
<span class="line" id="L226"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkObject = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L227">    static_path: FileSource,</span>
<span class="line" id="L228">    other_step: *LibExeObjStep,</span>
<span class="line" id="L229">    system_lib: SystemLib,</span>
<span class="line" id="L230">    assembly_file: FileSource,</span>
<span class="line" id="L231">    c_source_file: *CSourceFile,</span>
<span class="line" id="L232">    c_source_files: *CSourceFiles,</span>
<span class="line" id="L233">};</span>
<span class="line" id="L234"></span>
<span class="line" id="L235"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SystemLib = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L236">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L237">    needed: <span class="tok-type">bool</span>,</span>
<span class="line" id="L238">    weak: <span class="tok-type">bool</span>,</span>
<span class="line" id="L239">    use_pkg_config: <span class="tok-kw">enum</span> {</span>
<span class="line" id="L240">        <span class="tok-comment">/// Don't use pkg-config, just pass -lfoo where foo is name.</span></span>
<span class="line" id="L241">        no,</span>
<span class="line" id="L242">        <span class="tok-comment">/// Try to get information on how to link the library from pkg-config.</span></span>
<span class="line" id="L243">        <span class="tok-comment">/// If that fails, fall back to passing -lfoo where foo is name.</span></span>
<span class="line" id="L244">        yes,</span>
<span class="line" id="L245">        <span class="tok-comment">/// Try to get information on how to link the library from pkg-config.</span></span>
<span class="line" id="L246">        <span class="tok-comment">/// If that fails, error out.</span></span>
<span class="line" id="L247">        force,</span>
<span class="line" id="L248">    },</span>
<span class="line" id="L249">};</span>
<span class="line" id="L250"></span>
<span class="line" id="L251"><span class="tok-kw">const</span> FrameworkLinkInfo = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L252">    needed: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L253">    weak: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L254">};</span>
<span class="line" id="L255"></span>
<span class="line" id="L256"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IncludeDir = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L257">    raw_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L258">    raw_path_system: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L259">    other_step: *LibExeObjStep,</span>
<span class="line" id="L260">};</span>
<span class="line" id="L261"></span>
<span class="line" id="L262"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kind = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L263">    exe,</span>
<span class="line" id="L264">    lib,</span>
<span class="line" id="L265">    obj,</span>
<span class="line" id="L266">    @&quot;test&quot;,</span>
<span class="line" id="L267">    test_exe,</span>
<span class="line" id="L268">};</span>
<span class="line" id="L269"></span>
<span class="line" id="L270"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SharedLibKind = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L271">    versioned: std.builtin.Version,</span>
<span class="line" id="L272">    unversioned: <span class="tok-type">void</span>,</span>
<span class="line" id="L273">};</span>
<span class="line" id="L274"></span>
<span class="line" id="L275"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Linkage = <span class="tok-kw">enum</span> { dynamic, static };</span>
<span class="line" id="L276"></span>
<span class="line" id="L277"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EmitOption = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L278">    default: <span class="tok-type">void</span>,</span>
<span class="line" id="L279">    no_emit: <span class="tok-type">void</span>,</span>
<span class="line" id="L280">    emit: <span class="tok-type">void</span>,</span>
<span class="line" id="L281">    emit_to: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L282"></span>
<span class="line" id="L283">    <span class="tok-kw">fn</span> <span class="tok-fn">getArg</span>(self: <span class="tok-builtin">@This</span>(), b: *Builder, arg_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L284">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self) {</span>
<span class="line" id="L285">            .no_emit =&gt; b.fmt(<span class="tok-str">&quot;-fno-{s}&quot;</span>, .{arg_name}),</span>
<span class="line" id="L286">            .default =&gt; <span class="tok-null">null</span>,</span>
<span class="line" id="L287">            .emit =&gt; b.fmt(<span class="tok-str">&quot;-f{s}&quot;</span>, .{arg_name}),</span>
<span class="line" id="L288">            .emit_to =&gt; |path| b.fmt(<span class="tok-str">&quot;-f{s}={s}&quot;</span>, .{ arg_name, path }),</span>
<span class="line" id="L289">        };</span>
<span class="line" id="L290">    }</span>
<span class="line" id="L291">};</span>
<span class="line" id="L292"></span>
<span class="line" id="L293"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createSharedLibrary</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: ?FileSource, kind: SharedLibKind) *LibExeObjStep {</span>
<span class="line" id="L294">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .lib, .dynamic, <span class="tok-kw">switch</span> (kind) {</span>
<span class="line" id="L295">        .versioned =&gt; |ver| ver,</span>
<span class="line" id="L296">        .unversioned =&gt; <span class="tok-null">null</span>,</span>
<span class="line" id="L297">    });</span>
<span class="line" id="L298">}</span>
<span class="line" id="L299"></span>
<span class="line" id="L300"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createStaticLibrary</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: ?FileSource) *LibExeObjStep {</span>
<span class="line" id="L301">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .lib, .static, <span class="tok-null">null</span>);</span>
<span class="line" id="L302">}</span>
<span class="line" id="L303"></span>
<span class="line" id="L304"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createObject</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: ?FileSource) *LibExeObjStep {</span>
<span class="line" id="L305">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .obj, <span class="tok-null">null</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L306">}</span>
<span class="line" id="L307"></span>
<span class="line" id="L308"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createExecutable</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: ?FileSource) *LibExeObjStep {</span>
<span class="line" id="L309">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .exe, <span class="tok-null">null</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L310">}</span>
<span class="line" id="L311"></span>
<span class="line" id="L312"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createTest</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: FileSource) *LibExeObjStep {</span>
<span class="line" id="L313">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .@&quot;test&quot;, <span class="tok-null">null</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L314">}</span>
<span class="line" id="L315"></span>
<span class="line" id="L316"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">createTestExe</span>(builder: *Builder, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, root_src: FileSource) *LibExeObjStep {</span>
<span class="line" id="L317">    <span class="tok-kw">return</span> initExtraArgs(builder, name, root_src, .test_exe, <span class="tok-null">null</span>, <span class="tok-null">null</span>);</span>
<span class="line" id="L318">}</span>
<span class="line" id="L319"></span>
<span class="line" id="L320"><span class="tok-kw">fn</span> <span class="tok-fn">initExtraArgs</span>(</span>
<span class="line" id="L321">    builder: *Builder,</span>
<span class="line" id="L322">    name_raw: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L323">    root_src_raw: ?FileSource,</span>
<span class="line" id="L324">    kind: Kind,</span>
<span class="line" id="L325">    linkage: ?Linkage,</span>
<span class="line" id="L326">    ver: ?std.builtin.Version,</span>
<span class="line" id="L327">) *LibExeObjStep {</span>
<span class="line" id="L328">    <span class="tok-kw">const</span> name = builder.dupe(name_raw);</span>
<span class="line" id="L329">    <span class="tok-kw">const</span> root_src: ?FileSource = <span class="tok-kw">if</span> (root_src_raw) |rsrc| rsrc.dupe(builder) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L330">    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;/&quot;</span>) != <span class="tok-null">null</span> <span class="tok-kw">or</span> mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;\\&quot;</span>) != <span class="tok-null">null</span>) {</span>
<span class="line" id="L331">        panic(<span class="tok-str">&quot;invalid name: '{s}'. It looks like a file path, but it is supposed to be the library or application name.&quot;</span>, .{name});</span>
<span class="line" id="L332">    }</span>
<span class="line" id="L333"></span>
<span class="line" id="L334">    <span class="tok-kw">const</span> self = builder.allocator.create(LibExeObjStep) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L335">    self.* = LibExeObjStep{</span>
<span class="line" id="L336">        .strip = <span class="tok-null">null</span>,</span>
<span class="line" id="L337">        .unwind_tables = <span class="tok-null">null</span>,</span>
<span class="line" id="L338">        .builder = builder,</span>
<span class="line" id="L339">        .verbose_link = <span class="tok-null">false</span>,</span>
<span class="line" id="L340">        .verbose_cc = <span class="tok-null">false</span>,</span>
<span class="line" id="L341">        .build_mode = std.builtin.Mode.Debug,</span>
<span class="line" id="L342">        .linkage = linkage,</span>
<span class="line" id="L343">        .kind = kind,</span>
<span class="line" id="L344">        .root_src = root_src,</span>
<span class="line" id="L345">        .name = name,</span>
<span class="line" id="L346">        .frameworks = StringHashMap(FrameworkLinkInfo).init(builder.allocator),</span>
<span class="line" id="L347">        .step = Step.init(base_id, name, builder.allocator, make),</span>
<span class="line" id="L348">        .version = ver,</span>
<span class="line" id="L349">        .out_filename = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L350">        .out_h_filename = builder.fmt(<span class="tok-str">&quot;{s}.h&quot;</span>, .{name}),</span>
<span class="line" id="L351">        .out_lib_filename = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L352">        .out_pdb_filename = builder.fmt(<span class="tok-str">&quot;{s}.pdb&quot;</span>, .{name}),</span>
<span class="line" id="L353">        .major_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L354">        .name_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L355">        .packages = ArrayList(Pkg).init(builder.allocator),</span>
<span class="line" id="L356">        .include_dirs = ArrayList(IncludeDir).init(builder.allocator),</span>
<span class="line" id="L357">        .link_objects = ArrayList(LinkObject).init(builder.allocator),</span>
<span class="line" id="L358">        .c_macros = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(builder.allocator),</span>
<span class="line" id="L359">        .lib_paths = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(builder.allocator),</span>
<span class="line" id="L360">        .rpaths = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(builder.allocator),</span>
<span class="line" id="L361">        .framework_dirs = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(builder.allocator),</span>
<span class="line" id="L362">        .object_src = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L363">        .c_std = Builder.CStd.C99,</span>
<span class="line" id="L364">        .override_lib_dir = <span class="tok-null">null</span>,</span>
<span class="line" id="L365">        .main_pkg_path = <span class="tok-null">null</span>,</span>
<span class="line" id="L366">        .exec_cmd_args = <span class="tok-null">null</span>,</span>
<span class="line" id="L367">        .name_prefix = <span class="tok-str">&quot;&quot;</span>,</span>
<span class="line" id="L368">        .filter = <span class="tok-null">null</span>,</span>
<span class="line" id="L369">        .test_runner = <span class="tok-null">null</span>,</span>
<span class="line" id="L370">        .disable_stack_probing = <span class="tok-null">false</span>,</span>
<span class="line" id="L371">        .disable_sanitize_c = <span class="tok-null">false</span>,</span>
<span class="line" id="L372">        .sanitize_thread = <span class="tok-null">false</span>,</span>
<span class="line" id="L373">        .rdynamic = <span class="tok-null">false</span>,</span>
<span class="line" id="L374">        .output_dir = <span class="tok-null">null</span>,</span>
<span class="line" id="L375">        .override_dest_dir = <span class="tok-null">null</span>,</span>
<span class="line" id="L376">        .installed_path = <span class="tok-null">null</span>,</span>
<span class="line" id="L377">        .install_step = <span class="tok-null">null</span>,</span>
<span class="line" id="L378"></span>
<span class="line" id="L379">        .output_path_source = GeneratedFile{ .step = &amp;self.step },</span>
<span class="line" id="L380">        .output_lib_path_source = GeneratedFile{ .step = &amp;self.step },</span>
<span class="line" id="L381">        .output_h_path_source = GeneratedFile{ .step = &amp;self.step },</span>
<span class="line" id="L382">        .output_pdb_path_source = GeneratedFile{ .step = &amp;self.step },</span>
<span class="line" id="L383"></span>
<span class="line" id="L384">        .target_info = <span class="tok-null">undefined</span>, <span class="tok-comment">// populated in computeOutFileNames</span>
</span>
<span class="line" id="L385">    };</span>
<span class="line" id="L386">    self.computeOutFileNames();</span>
<span class="line" id="L387">    <span class="tok-kw">if</span> (root_src) |rs| rs.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L388">    <span class="tok-kw">return</span> self;</span>
<span class="line" id="L389">}</span>
<span class="line" id="L390"></span>
<span class="line" id="L391"><span class="tok-kw">fn</span> <span class="tok-fn">computeOutFileNames</span>(self: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L392">    self.target_info = NativeTargetInfo.detect(self.target) <span class="tok-kw">catch</span></span>
<span class="line" id="L393">        <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L394"></span>
<span class="line" id="L395">    <span class="tok-kw">const</span> target = self.target_info.target;</span>
<span class="line" id="L396"></span>
<span class="line" id="L397">    self.out_filename = std.zig.binNameAlloc(self.builder.allocator, .{</span>
<span class="line" id="L398">        .root_name = self.name,</span>
<span class="line" id="L399">        .target = target,</span>
<span class="line" id="L400">        .output_mode = <span class="tok-kw">switch</span> (self.kind) {</span>
<span class="line" id="L401">            .lib =&gt; .Lib,</span>
<span class="line" id="L402">            .obj =&gt; .Obj,</span>
<span class="line" id="L403">            .exe, .@&quot;test&quot;, .test_exe =&gt; .Exe,</span>
<span class="line" id="L404">        },</span>
<span class="line" id="L405">        .link_mode = <span class="tok-kw">if</span> (self.linkage) |some| <span class="tok-builtin">@as</span>(std.builtin.LinkMode, <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L406">            .dynamic =&gt; .Dynamic,</span>
<span class="line" id="L407">            .static =&gt; .Static,</span>
<span class="line" id="L408">        }) <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L409">        .version = self.version,</span>
<span class="line" id="L410">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L411"></span>
<span class="line" id="L412">    <span class="tok-kw">if</span> (self.kind == .lib) {</span>
<span class="line" id="L413">        <span class="tok-kw">if</span> (self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .static) {</span>
<span class="line" id="L414">            self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L415">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L416">            <span class="tok-kw">if</span> (target.isDarwin()) {</span>
<span class="line" id="L417">                self.major_only_filename = self.builder.fmt(<span class="tok-str">&quot;lib{s}.{d}.dylib&quot;</span>, .{</span>
<span class="line" id="L418">                    self.name,</span>
<span class="line" id="L419">                    version.major,</span>
<span class="line" id="L420">                });</span>
<span class="line" id="L421">                self.name_only_filename = self.builder.fmt(<span class="tok-str">&quot;lib{s}.dylib&quot;</span>, .{self.name});</span>
<span class="line" id="L422">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L423">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target.os.tag == .windows) {</span>
<span class="line" id="L424">                self.out_lib_filename = self.builder.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L425">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L426">                self.major_only_filename = self.builder.fmt(<span class="tok-str">&quot;lib{s}.so.{d}&quot;</span>, .{ self.name, version.major });</span>
<span class="line" id="L427">                self.name_only_filename = self.builder.fmt(<span class="tok-str">&quot;lib{s}.so&quot;</span>, .{self.name});</span>
<span class="line" id="L428">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L429">            }</span>
<span class="line" id="L430">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L431">            <span class="tok-kw">if</span> (target.isDarwin()) {</span>
<span class="line" id="L432">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L433">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target.os.tag == .windows) {</span>
<span class="line" id="L434">                self.out_lib_filename = self.builder.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L435">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L436">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L437">            }</span>
<span class="line" id="L438">        }</span>
<span class="line" id="L439">        <span class="tok-kw">if</span> (self.output_dir != <span class="tok-null">null</span>) {</span>
<span class="line" id="L440">            self.output_lib_path_source.path = self.builder.pathJoin(</span>
<span class="line" id="L441">                &amp;.{ self.output_dir.?, self.out_lib_filename },</span>
<span class="line" id="L442">            );</span>
<span class="line" id="L443">        }</span>
<span class="line" id="L444">    }</span>
<span class="line" id="L445">}</span>
<span class="line" id="L446"></span>
<span class="line" id="L447"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setTarget</span>(self: *LibExeObjStep, target: CrossTarget) <span class="tok-type">void</span> {</span>
<span class="line" id="L448">    self.target = target;</span>
<span class="line" id="L449">    self.computeOutFileNames();</span>
<span class="line" id="L450">}</span>
<span class="line" id="L451"></span>
<span class="line" id="L452"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setOutputDir</span>(self: *LibExeObjStep, dir: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L453">    self.output_dir = self.builder.dupePath(dir);</span>
<span class="line" id="L454">}</span>
<span class="line" id="L455"></span>
<span class="line" id="L456"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">install</span>(self: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L457">    self.builder.installArtifact(self);</span>
<span class="line" id="L458">}</span>
<span class="line" id="L459"></span>
<span class="line" id="L460"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installRaw</span>(self: *LibExeObjStep, dest_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, options: InstallRawStep.CreateOptions) *InstallRawStep {</span>
<span class="line" id="L461">    <span class="tok-kw">return</span> self.builder.installRaw(self, dest_filename, options);</span>
<span class="line" id="L462">}</span>
<span class="line" id="L463"></span>
<span class="line" id="L464"><span class="tok-comment">/// Creates a `RunStep` with an executable built with `addExecutable`.</span></span>
<span class="line" id="L465"><span class="tok-comment">/// Add command line arguments with `addArg`.</span></span>
<span class="line" id="L466"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">run</span>(exe: *LibExeObjStep) *RunStep {</span>
<span class="line" id="L467">    assert(exe.kind == .exe <span class="tok-kw">or</span> exe.kind == .test_exe);</span>
<span class="line" id="L468"></span>
<span class="line" id="L469">    <span class="tok-comment">// It doesn't have to be native. We catch that if you actually try to run it.</span>
</span>
<span class="line" id="L470">    <span class="tok-comment">// Consider that this is declarative; the run step may not be run unless a user</span>
</span>
<span class="line" id="L471">    <span class="tok-comment">// option is supplied.</span>
</span>
<span class="line" id="L472">    <span class="tok-kw">const</span> run_step = RunStep.create(exe.builder, exe.builder.fmt(<span class="tok-str">&quot;run {s}&quot;</span>, .{exe.step.name}));</span>
<span class="line" id="L473">    run_step.addArtifactArg(exe);</span>
<span class="line" id="L474"></span>
<span class="line" id="L475">    <span class="tok-kw">if</span> (exe.kind == .test_exe) {</span>
<span class="line" id="L476">        run_step.addArg(exe.builder.zig_exe);</span>
<span class="line" id="L477">    }</span>
<span class="line" id="L478"></span>
<span class="line" id="L479">    <span class="tok-kw">if</span> (exe.vcpkg_bin_path) |path| {</span>
<span class="line" id="L480">        run_step.addPathDir(path);</span>
<span class="line" id="L481">    }</span>
<span class="line" id="L482"></span>
<span class="line" id="L483">    <span class="tok-kw">return</span> run_step;</span>
<span class="line" id="L484">}</span>
<span class="line" id="L485"></span>
<span class="line" id="L486"><span class="tok-comment">/// Creates an `EmulatableRunStep` with an executable built with `addExecutable`.</span></span>
<span class="line" id="L487"><span class="tok-comment">/// Allows running foreign binaries through emulation platforms such as Qemu or Rosetta.</span></span>
<span class="line" id="L488"><span class="tok-comment">/// When a binary cannot be ran through emulation or the option is disabled, a warning</span></span>
<span class="line" id="L489"><span class="tok-comment">/// will be printed and the binary will *NOT* be ran.</span></span>
<span class="line" id="L490"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">runEmulatable</span>(exe: *LibExeObjStep) *EmulatableRunStep {</span>
<span class="line" id="L491">    assert(exe.kind == .exe <span class="tok-kw">or</span> exe.kind == .test_exe);</span>
<span class="line" id="L492"></span>
<span class="line" id="L493">    <span class="tok-kw">const</span> run_step = EmulatableRunStep.create(exe.builder, exe.builder.fmt(<span class="tok-str">&quot;run {s}&quot;</span>, .{exe.step.name}), exe);</span>
<span class="line" id="L494">    <span class="tok-kw">if</span> (exe.vcpkg_bin_path) |path| {</span>
<span class="line" id="L495">        RunStep.addPathDirInternal(&amp;run_step.step, exe.builder, path);</span>
<span class="line" id="L496">    }</span>
<span class="line" id="L497">    <span class="tok-kw">return</span> run_step;</span>
<span class="line" id="L498">}</span>
<span class="line" id="L499"></span>
<span class="line" id="L500"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">checkObject</span>(self: *LibExeObjStep, obj_format: std.Target.ObjectFormat) *CheckObjectStep {</span>
<span class="line" id="L501">    <span class="tok-kw">return</span> CheckObjectStep.create(self.builder, self.getOutputSource(), obj_format);</span>
<span class="line" id="L502">}</span>
<span class="line" id="L503"></span>
<span class="line" id="L504"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLinkerScriptPath</span>(self: *LibExeObjStep, source: FileSource) <span class="tok-type">void</span> {</span>
<span class="line" id="L505">    self.linker_script = source.dupe(self.builder);</span>
<span class="line" id="L506">    source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L507">}</span>
<span class="line" id="L508"></span>
<span class="line" id="L509"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFramework</span>(self: *LibExeObjStep, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L510">    self.frameworks.put(self.builder.dupe(framework_name), .{}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L511">}</span>
<span class="line" id="L512"></span>
<span class="line" id="L513"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkNeeded</span>(self: *LibExeObjStep, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L514">    self.frameworks.put(self.builder.dupe(framework_name), .{</span>
<span class="line" id="L515">        .needed = <span class="tok-null">true</span>,</span>
<span class="line" id="L516">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L517">}</span>
<span class="line" id="L518"></span>
<span class="line" id="L519"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkWeak</span>(self: *LibExeObjStep, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L520">    self.frameworks.put(self.builder.dupe(framework_name), .{</span>
<span class="line" id="L521">        .weak = <span class="tok-null">true</span>,</span>
<span class="line" id="L522">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L523">}</span>
<span class="line" id="L524"></span>
<span class="line" id="L525"><span class="tok-comment">/// Returns whether the library, executable, or object depends on a particular system library.</span></span>
<span class="line" id="L526"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dependsOnSystemLibrary</span>(self: LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L527">    <span class="tok-kw">if</span> (isLibCLibrary(name)) {</span>
<span class="line" id="L528">        <span class="tok-kw">return</span> self.is_linking_libc;</span>
<span class="line" id="L529">    }</span>
<span class="line" id="L530">    <span class="tok-kw">if</span> (isLibCppLibrary(name)) {</span>
<span class="line" id="L531">        <span class="tok-kw">return</span> self.is_linking_libcpp;</span>
<span class="line" id="L532">    }</span>
<span class="line" id="L533">    <span class="tok-kw">for</span> (self.link_objects.items) |link_object| {</span>
<span class="line" id="L534">        <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L535">            .system_lib =&gt; |lib| <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, lib.name, name)) <span class="tok-kw">return</span> <span class="tok-null">true</span>,</span>
<span class="line" id="L536">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L537">        }</span>
<span class="line" id="L538">    }</span>
<span class="line" id="L539">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L540">}</span>
<span class="line" id="L541"></span>
<span class="line" id="L542"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibrary</span>(self: *LibExeObjStep, lib: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L543">    assert(lib.kind == .lib);</span>
<span class="line" id="L544">    self.linkLibraryOrObject(lib);</span>
<span class="line" id="L545">}</span>
<span class="line" id="L546"></span>
<span class="line" id="L547"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isDynamicLibrary</span>(self: *LibExeObjStep) <span class="tok-type">bool</span> {</span>
<span class="line" id="L548">    <span class="tok-kw">return</span> self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic;</span>
<span class="line" id="L549">}</span>
<span class="line" id="L550"></span>
<span class="line" id="L551"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">producesPdbFile</span>(self: *LibExeObjStep) <span class="tok-type">bool</span> {</span>
<span class="line" id="L552">    <span class="tok-kw">if</span> (!self.target.isWindows() <span class="tok-kw">and</span> !self.target.isUefi()) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L553">    <span class="tok-kw">if</span> (self.strip != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.strip.?) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L554">    <span class="tok-kw">return</span> self.isDynamicLibrary() <span class="tok-kw">or</span> self.kind == .exe <span class="tok-kw">or</span> self.kind == .test_exe;</span>
<span class="line" id="L555">}</span>
<span class="line" id="L556"></span>
<span class="line" id="L557"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibC</span>(self: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L558">    <span class="tok-kw">if</span> (!self.is_linking_libc) {</span>
<span class="line" id="L559">        self.is_linking_libc = <span class="tok-null">true</span>;</span>
<span class="line" id="L560">        self.link_objects.append(.{</span>
<span class="line" id="L561">            .system_lib = .{</span>
<span class="line" id="L562">                .name = <span class="tok-str">&quot;c&quot;</span>,</span>
<span class="line" id="L563">                .needed = <span class="tok-null">false</span>,</span>
<span class="line" id="L564">                .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L565">                .use_pkg_config = .no,</span>
<span class="line" id="L566">            },</span>
<span class="line" id="L567">        }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L568">    }</span>
<span class="line" id="L569">}</span>
<span class="line" id="L570"></span>
<span class="line" id="L571"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibCpp</span>(self: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L572">    <span class="tok-kw">if</span> (!self.is_linking_libcpp) {</span>
<span class="line" id="L573">        self.is_linking_libcpp = <span class="tok-null">true</span>;</span>
<span class="line" id="L574">        self.link_objects.append(.{</span>
<span class="line" id="L575">            .system_lib = .{</span>
<span class="line" id="L576">                .name = <span class="tok-str">&quot;c++&quot;</span>,</span>
<span class="line" id="L577">                .needed = <span class="tok-null">false</span>,</span>
<span class="line" id="L578">                .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L579">                .use_pkg_config = .no,</span>
<span class="line" id="L580">            },</span>
<span class="line" id="L581">        }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L582">    }</span>
<span class="line" id="L583">}</span>
<span class="line" id="L584"></span>
<span class="line" id="L585"><span class="tok-comment">/// If the value is omitted, it is set to 1.</span></span>
<span class="line" id="L586"><span class="tok-comment">/// `name` and `value` need not live longer than the function call.</span></span>
<span class="line" id="L587"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">defineCMacro</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L588">    <span class="tok-kw">const</span> macro = std.build.constructCMacro(self.builder.allocator, name, value);</span>
<span class="line" id="L589">    self.c_macros.append(macro) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L590">}</span>
<span class="line" id="L591"></span>
<span class="line" id="L592"><span class="tok-comment">/// name_and_value looks like [name]=[value]. If the value is omitted, it is set to 1.</span></span>
<span class="line" id="L593"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">defineCMacroRaw</span>(self: *LibExeObjStep, name_and_value: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L594">    self.c_macros.append(self.builder.dupe(name_and_value)) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L595">}</span>
<span class="line" id="L596"></span>
<span class="line" id="L597"><span class="tok-comment">/// This one has no integration with anything, it just puts -lname on the command line.</span></span>
<span class="line" id="L598"><span class="tok-comment">/// Prefer to use `linkSystemLibrary` instead.</span></span>
<span class="line" id="L599"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryName</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L600">    self.link_objects.append(.{</span>
<span class="line" id="L601">        .system_lib = .{</span>
<span class="line" id="L602">            .name = self.builder.dupe(name),</span>
<span class="line" id="L603">            .needed = <span class="tok-null">false</span>,</span>
<span class="line" id="L604">            .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L605">            .use_pkg_config = .no,</span>
<span class="line" id="L606">        },</span>
<span class="line" id="L607">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L608">}</span>
<span class="line" id="L609"></span>
<span class="line" id="L610"><span class="tok-comment">/// This one has no integration with anything, it just puts -needed-lname on the command line.</span></span>
<span class="line" id="L611"><span class="tok-comment">/// Prefer to use `linkSystemLibraryNeeded` instead.</span></span>
<span class="line" id="L612"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeededName</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L613">    self.link_objects.append(.{</span>
<span class="line" id="L614">        .system_lib = .{</span>
<span class="line" id="L615">            .name = self.builder.dupe(name),</span>
<span class="line" id="L616">            .needed = <span class="tok-null">true</span>,</span>
<span class="line" id="L617">            .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L618">            .use_pkg_config = .no,</span>
<span class="line" id="L619">        },</span>
<span class="line" id="L620">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L621">}</span>
<span class="line" id="L622"></span>
<span class="line" id="L623"><span class="tok-comment">/// Darwin-only. This one has no integration with anything, it just puts -weak-lname on the</span></span>
<span class="line" id="L624"><span class="tok-comment">/// command line. Prefer to use `linkSystemLibraryWeak` instead.</span></span>
<span class="line" id="L625"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryWeakName</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L626">    self.link_objects.append(.{</span>
<span class="line" id="L627">        .system_lib = .{</span>
<span class="line" id="L628">            .name = self.builder.dupe(name),</span>
<span class="line" id="L629">            .needed = <span class="tok-null">false</span>,</span>
<span class="line" id="L630">            .weak = <span class="tok-null">true</span>,</span>
<span class="line" id="L631">            .use_pkg_config = .no,</span>
<span class="line" id="L632">        },</span>
<span class="line" id="L633">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L634">}</span>
<span class="line" id="L635"></span>
<span class="line" id="L636"><span class="tok-comment">/// This links against a system library, exclusively using pkg-config to find the library.</span></span>
<span class="line" id="L637"><span class="tok-comment">/// Prefer to use `linkSystemLibrary` instead.</span></span>
<span class="line" id="L638"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryPkgConfigOnly</span>(self: *LibExeObjStep, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L639">    self.link_objects.append(.{</span>
<span class="line" id="L640">        .system_lib = .{</span>
<span class="line" id="L641">            .name = self.builder.dupe(lib_name),</span>
<span class="line" id="L642">            .needed = <span class="tok-null">false</span>,</span>
<span class="line" id="L643">            .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L644">            .use_pkg_config = .force,</span>
<span class="line" id="L645">        },</span>
<span class="line" id="L646">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L647">}</span>
<span class="line" id="L648"></span>
<span class="line" id="L649"><span class="tok-comment">/// This links against a system library, exclusively using pkg-config to find the library.</span></span>
<span class="line" id="L650"><span class="tok-comment">/// Prefer to use `linkSystemLibraryNeeded` instead.</span></span>
<span class="line" id="L651"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeededPkgConfigOnly</span>(self: *LibExeObjStep, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L652">    self.link_objects.append(.{</span>
<span class="line" id="L653">        .system_lib = .{</span>
<span class="line" id="L654">            .name = self.builder.dupe(lib_name),</span>
<span class="line" id="L655">            .needed = <span class="tok-null">true</span>,</span>
<span class="line" id="L656">            .weak = <span class="tok-null">false</span>,</span>
<span class="line" id="L657">            .use_pkg_config = .force,</span>
<span class="line" id="L658">        },</span>
<span class="line" id="L659">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L660">}</span>
<span class="line" id="L661"></span>
<span class="line" id="L662"><span class="tok-comment">/// Run pkg-config for the given library name and parse the output, returning the arguments</span></span>
<span class="line" id="L663"><span class="tok-comment">/// that should be passed to zig to link the given library.</span></span>
<span class="line" id="L664"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">runPkgConfig</span>(self: *LibExeObjStep, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L665">    <span class="tok-kw">const</span> pkg_name = match: {</span>
<span class="line" id="L666">        <span class="tok-comment">// First we have to map the library name to pkg config name. Unfortunately,</span>
</span>
<span class="line" id="L667">        <span class="tok-comment">// there are several examples where this is not straightforward:</span>
</span>
<span class="line" id="L668">        <span class="tok-comment">// -lSDL2 -&gt; pkg-config sdl2</span>
</span>
<span class="line" id="L669">        <span class="tok-comment">// -lgdk-3 -&gt; pkg-config gdk-3.0</span>
</span>
<span class="line" id="L670">        <span class="tok-comment">// -latk-1.0 -&gt; pkg-config atk</span>
</span>
<span class="line" id="L671">        <span class="tok-kw">const</span> pkgs = <span class="tok-kw">try</span> getPkgConfigList(self.builder);</span>
<span class="line" id="L672"></span>
<span class="line" id="L673">        <span class="tok-comment">// Exact match means instant winner.</span>
</span>
<span class="line" id="L674">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L675">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name, lib_name)) {</span>
<span class="line" id="L676">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L677">            }</span>
<span class="line" id="L678">        }</span>
<span class="line" id="L679"></span>
<span class="line" id="L680">        <span class="tok-comment">// Next we'll try ignoring case.</span>
</span>
<span class="line" id="L681">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L682">            <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, lib_name)) {</span>
<span class="line" id="L683">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L684">            }</span>
<span class="line" id="L685">        }</span>
<span class="line" id="L686"></span>
<span class="line" id="L687">        <span class="tok-comment">// Now try appending &quot;.0&quot;.</span>
</span>
<span class="line" id="L688">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L689">            <span class="tok-kw">if</span> (std.ascii.indexOfIgnoreCase(pkg.name, lib_name)) |pos| {</span>
<span class="line" id="L690">                <span class="tok-kw">if</span> (pos != <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L691">                <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name[lib_name.len..], <span class="tok-str">&quot;.0&quot;</span>)) {</span>
<span class="line" id="L692">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L693">                }</span>
<span class="line" id="L694">            }</span>
<span class="line" id="L695">        }</span>
<span class="line" id="L696"></span>
<span class="line" id="L697">        <span class="tok-comment">// Trimming &quot;-1.0&quot;.</span>
</span>
<span class="line" id="L698">        <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, lib_name, <span class="tok-str">&quot;-1.0&quot;</span>)) {</span>
<span class="line" id="L699">            <span class="tok-kw">const</span> trimmed_lib_name = lib_name[<span class="tok-number">0</span> .. lib_name.len - <span class="tok-str">&quot;-1.0&quot;</span>.len];</span>
<span class="line" id="L700">            <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L701">                <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, trimmed_lib_name)) {</span>
<span class="line" id="L702">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L703">                }</span>
<span class="line" id="L704">            }</span>
<span class="line" id="L705">        }</span>
<span class="line" id="L706"></span>
<span class="line" id="L707">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PackageNotFound;</span>
<span class="line" id="L708">    };</span>
<span class="line" id="L709"></span>
<span class="line" id="L710">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L711">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">if</span> (self.builder.execAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{</span>
<span class="line" id="L712">        <span class="tok-str">&quot;pkg-config&quot;</span>,</span>
<span class="line" id="L713">        pkg_name,</span>
<span class="line" id="L714">        <span class="tok-str">&quot;--cflags&quot;</span>,</span>
<span class="line" id="L715">        <span class="tok-str">&quot;--libs&quot;</span>,</span>
<span class="line" id="L716">    }, &amp;code, .Ignore)) |stdout| stdout <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L717">        <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L718">        <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L719">        <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L720">        <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L721">        <span class="tok-kw">error</span>.ChildExecFailed =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L722">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L723">    };</span>
<span class="line" id="L724"></span>
<span class="line" id="L725">    <span class="tok-kw">var</span> zig_args = std.ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(self.builder.allocator);</span>
<span class="line" id="L726">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L727"></span>
<span class="line" id="L728">    <span class="tok-kw">var</span> it = mem.tokenize(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot; \r\n\t&quot;</span>);</span>
<span class="line" id="L729">    <span class="tok-kw">while</span> (it.next()) |tok| {</span>
<span class="line" id="L730">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L731">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L732">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-I&quot;</span>, dir });</span>
<span class="line" id="L733">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L734">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L735">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L736">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L737">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-L&quot;</span>, dir });</span>
<span class="line" id="L738">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L739">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L740">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L741">            <span class="tok-kw">const</span> lib = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L742">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-l&quot;</span>, lib });</span>
<span class="line" id="L743">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L744">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L745">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L746">            <span class="tok-kw">const</span> macro = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L747">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-D&quot;</span>, macro });</span>
<span class="line" id="L748">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L749">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L750">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.builder.verbose) {</span>
<span class="line" id="L751">            log.warn(<span class="tok-str">&quot;Ignoring pkg-config flag '{s}'&quot;</span>, .{tok});</span>
<span class="line" id="L752">        }</span>
<span class="line" id="L753">    }</span>
<span class="line" id="L754"></span>
<span class="line" id="L755">    <span class="tok-kw">return</span> zig_args.toOwnedSlice();</span>
<span class="line" id="L756">}</span>
<span class="line" id="L757"></span>
<span class="line" id="L758"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibrary</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L759">    self.linkSystemLibraryInner(name, .{});</span>
<span class="line" id="L760">}</span>
<span class="line" id="L761"></span>
<span class="line" id="L762"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeeded</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L763">    self.linkSystemLibraryInner(name, .{ .needed = <span class="tok-null">true</span> });</span>
<span class="line" id="L764">}</span>
<span class="line" id="L765"></span>
<span class="line" id="L766"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryWeak</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L767">    self.linkSystemLibraryInner(name, .{ .weak = <span class="tok-null">true</span> });</span>
<span class="line" id="L768">}</span>
<span class="line" id="L769"></span>
<span class="line" id="L770"><span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryInner</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, opts: <span class="tok-kw">struct</span> {</span>
<span class="line" id="L771">    needed: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L772">    weak: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L773">}) <span class="tok-type">void</span> {</span>
<span class="line" id="L774">    <span class="tok-kw">if</span> (isLibCLibrary(name)) {</span>
<span class="line" id="L775">        self.linkLibC();</span>
<span class="line" id="L776">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L777">    }</span>
<span class="line" id="L778">    <span class="tok-kw">if</span> (isLibCppLibrary(name)) {</span>
<span class="line" id="L779">        self.linkLibCpp();</span>
<span class="line" id="L780">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L781">    }</span>
<span class="line" id="L782"></span>
<span class="line" id="L783">    self.link_objects.append(.{</span>
<span class="line" id="L784">        .system_lib = .{</span>
<span class="line" id="L785">            .name = self.builder.dupe(name),</span>
<span class="line" id="L786">            .needed = opts.needed,</span>
<span class="line" id="L787">            .weak = opts.weak,</span>
<span class="line" id="L788">            .use_pkg_config = .yes,</span>
<span class="line" id="L789">        },</span>
<span class="line" id="L790">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L791">}</span>
<span class="line" id="L792"></span>
<span class="line" id="L793"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setNamePrefix</span>(self: *LibExeObjStep, text: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L794">    assert(self.kind == .@&quot;test&quot; <span class="tok-kw">or</span> self.kind == .test_exe);</span>
<span class="line" id="L795">    self.name_prefix = self.builder.dupe(text);</span>
<span class="line" id="L796">}</span>
<span class="line" id="L797"></span>
<span class="line" id="L798"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setFilter</span>(self: *LibExeObjStep, text: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L799">    assert(self.kind == .@&quot;test&quot; <span class="tok-kw">or</span> self.kind == .test_exe);</span>
<span class="line" id="L800">    self.filter = <span class="tok-kw">if</span> (text) |t| self.builder.dupe(t) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L801">}</span>
<span class="line" id="L802"></span>
<span class="line" id="L803"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setTestRunner</span>(self: *LibExeObjStep, path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L804">    assert(self.kind == .@&quot;test&quot; <span class="tok-kw">or</span> self.kind == .test_exe);</span>
<span class="line" id="L805">    self.test_runner = <span class="tok-kw">if</span> (path) |p| self.builder.dupePath(p) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L806">}</span>
<span class="line" id="L807"></span>
<span class="line" id="L808"><span class="tok-comment">/// Handy when you have many C/C++ source files and want them all to have the same flags.</span></span>
<span class="line" id="L809"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFiles</span>(self: *LibExeObjStep, files: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L810">    <span class="tok-kw">const</span> c_source_files = self.builder.allocator.create(CSourceFiles) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L811"></span>
<span class="line" id="L812">    <span class="tok-kw">const</span> files_copy = self.builder.dupeStrings(files);</span>
<span class="line" id="L813">    <span class="tok-kw">const</span> flags_copy = self.builder.dupeStrings(flags);</span>
<span class="line" id="L814"></span>
<span class="line" id="L815">    c_source_files.* = .{</span>
<span class="line" id="L816">        .files = files_copy,</span>
<span class="line" id="L817">        .flags = flags_copy,</span>
<span class="line" id="L818">    };</span>
<span class="line" id="L819">    self.link_objects.append(.{ .c_source_files = c_source_files }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L820">}</span>
<span class="line" id="L821"></span>
<span class="line" id="L822"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFile</span>(self: *LibExeObjStep, file: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L823">    self.addCSourceFileSource(.{</span>
<span class="line" id="L824">        .args = flags,</span>
<span class="line" id="L825">        .source = .{ .path = file },</span>
<span class="line" id="L826">    });</span>
<span class="line" id="L827">}</span>
<span class="line" id="L828"></span>
<span class="line" id="L829"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFileSource</span>(self: *LibExeObjStep, source: CSourceFile) <span class="tok-type">void</span> {</span>
<span class="line" id="L830">    <span class="tok-kw">const</span> c_source_file = self.builder.allocator.create(CSourceFile) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L831">    c_source_file.* = source.dupe(self.builder);</span>
<span class="line" id="L832">    self.link_objects.append(.{ .c_source_file = c_source_file }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L833">    source.source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L834">}</span>
<span class="line" id="L835"></span>
<span class="line" id="L836"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseLink</span>(self: *LibExeObjStep, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L837">    self.verbose_link = value;</span>
<span class="line" id="L838">}</span>
<span class="line" id="L839"></span>
<span class="line" id="L840"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseCC</span>(self: *LibExeObjStep, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L841">    self.verbose_cc = value;</span>
<span class="line" id="L842">}</span>
<span class="line" id="L843"></span>
<span class="line" id="L844"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setBuildMode</span>(self: *LibExeObjStep, mode: std.builtin.Mode) <span class="tok-type">void</span> {</span>
<span class="line" id="L845">    self.build_mode = mode;</span>
<span class="line" id="L846">}</span>
<span class="line" id="L847"></span>
<span class="line" id="L848"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">overrideZigLibDir</span>(self: *LibExeObjStep, dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L849">    self.override_lib_dir = self.builder.dupePath(dir_path);</span>
<span class="line" id="L850">}</span>
<span class="line" id="L851"></span>
<span class="line" id="L852"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setMainPkgPath</span>(self: *LibExeObjStep, dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L853">    self.main_pkg_path = self.builder.dupePath(dir_path);</span>
<span class="line" id="L854">}</span>
<span class="line" id="L855"></span>
<span class="line" id="L856"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLibCFile</span>(self: *LibExeObjStep, libc_file: ?FileSource) <span class="tok-type">void</span> {</span>
<span class="line" id="L857">    self.libc_file = <span class="tok-kw">if</span> (libc_file) |f| f.dupe(self.builder) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L858">}</span>
<span class="line" id="L859"></span>
<span class="line" id="L860"><span class="tok-comment">/// Returns the generated executable, library or object file.</span></span>
<span class="line" id="L861"><span class="tok-comment">/// To run an executable built with zig build, use `run`, or create an install step and invoke it.</span></span>
<span class="line" id="L862"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getOutputSource</span>(self: *LibExeObjStep) FileSource {</span>
<span class="line" id="L863">    <span class="tok-kw">return</span> FileSource{ .generated = &amp;self.output_path_source };</span>
<span class="line" id="L864">}</span>
<span class="line" id="L865"></span>
<span class="line" id="L866"><span class="tok-comment">/// Returns the generated import library. This function can only be called for libraries.</span></span>
<span class="line" id="L867"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getOutputLibSource</span>(self: *LibExeObjStep) FileSource {</span>
<span class="line" id="L868">    assert(self.kind == .lib);</span>
<span class="line" id="L869">    <span class="tok-kw">return</span> FileSource{ .generated = &amp;self.output_lib_path_source };</span>
<span class="line" id="L870">}</span>
<span class="line" id="L871"></span>
<span class="line" id="L872"><span class="tok-comment">/// Returns the generated header file.</span></span>
<span class="line" id="L873"><span class="tok-comment">/// This function can only be called for libraries or object files which have `emit_h` set.</span></span>
<span class="line" id="L874"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getOutputHSource</span>(self: *LibExeObjStep) FileSource {</span>
<span class="line" id="L875">    assert(self.kind != .exe <span class="tok-kw">and</span> self.kind != .test_exe <span class="tok-kw">and</span> self.kind != .@&quot;test&quot;);</span>
<span class="line" id="L876">    assert(self.emit_h);</span>
<span class="line" id="L877">    <span class="tok-kw">return</span> FileSource{ .generated = &amp;self.output_h_path_source };</span>
<span class="line" id="L878">}</span>
<span class="line" id="L879"></span>
<span class="line" id="L880"><span class="tok-comment">/// Returns the generated PDB file. This function can only be called for Windows and UEFI.</span></span>
<span class="line" id="L881"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getOutputPdbSource</span>(self: *LibExeObjStep) FileSource {</span>
<span class="line" id="L882">    <span class="tok-comment">// TODO: Is this right? Isn't PDB for *any* PE/COFF file?</span>
</span>
<span class="line" id="L883">    assert(self.target.isWindows() <span class="tok-kw">or</span> self.target.isUefi());</span>
<span class="line" id="L884">    <span class="tok-kw">return</span> FileSource{ .generated = &amp;self.output_pdb_path_source };</span>
<span class="line" id="L885">}</span>
<span class="line" id="L886"></span>
<span class="line" id="L887"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAssemblyFile</span>(self: *LibExeObjStep, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L888">    self.link_objects.append(.{</span>
<span class="line" id="L889">        .assembly_file = .{ .path = self.builder.dupe(path) },</span>
<span class="line" id="L890">    }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L891">}</span>
<span class="line" id="L892"></span>
<span class="line" id="L893"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAssemblyFileSource</span>(self: *LibExeObjStep, source: FileSource) <span class="tok-type">void</span> {</span>
<span class="line" id="L894">    <span class="tok-kw">const</span> source_duped = source.dupe(self.builder);</span>
<span class="line" id="L895">    self.link_objects.append(.{ .assembly_file = source_duped }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L896">    source_duped.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L897">}</span>
<span class="line" id="L898"></span>
<span class="line" id="L899"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjectFile</span>(self: *LibExeObjStep, source_file: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L900">    self.addObjectFileSource(.{ .path = source_file });</span>
<span class="line" id="L901">}</span>
<span class="line" id="L902"></span>
<span class="line" id="L903"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjectFileSource</span>(self: *LibExeObjStep, source: FileSource) <span class="tok-type">void</span> {</span>
<span class="line" id="L904">    self.link_objects.append(.{ .static_path = source.dupe(self.builder) }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L905">    source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L906">}</span>
<span class="line" id="L907"></span>
<span class="line" id="L908"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObject</span>(self: *LibExeObjStep, obj: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L909">    assert(obj.kind == .obj);</span>
<span class="line" id="L910">    self.linkLibraryOrObject(obj);</span>
<span class="line" id="L911">}</span>
<span class="line" id="L912"></span>
<span class="line" id="L913"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> addSystemIncludeDir = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use addSystemIncludePath&quot;</span>);</span>
<span class="line" id="L914"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> addIncludeDir = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use addIncludePath&quot;</span>);</span>
<span class="line" id="L915"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> addLibPath = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated, use addLibraryPath&quot;</span>);</span>
<span class="line" id="L916"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> addFrameworkDir = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated, use addFrameworkPath&quot;</span>);</span>
<span class="line" id="L917"></span>
<span class="line" id="L918"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemIncludePath</span>(self: *LibExeObjStep, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L919">    self.include_dirs.append(IncludeDir{ .raw_path_system = self.builder.dupe(path) }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L920">}</span>
<span class="line" id="L921"></span>
<span class="line" id="L922"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addIncludePath</span>(self: *LibExeObjStep, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L923">    self.include_dirs.append(IncludeDir{ .raw_path = self.builder.dupe(path) }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L924">}</span>
<span class="line" id="L925"></span>
<span class="line" id="L926"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addLibraryPath</span>(self: *LibExeObjStep, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L927">    self.lib_paths.append(self.builder.dupe(path)) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L928">}</span>
<span class="line" id="L929"></span>
<span class="line" id="L930"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addRPath</span>(self: *LibExeObjStep, path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L931">    self.rpaths.append(self.builder.dupe(path)) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L932">}</span>
<span class="line" id="L933"></span>
<span class="line" id="L934"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addFrameworkPath</span>(self: *LibExeObjStep, dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L935">    self.framework_dirs.append(self.builder.dupe(dir_path)) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L936">}</span>
<span class="line" id="L937"></span>
<span class="line" id="L938"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addPackage</span>(self: *LibExeObjStep, package: Pkg) <span class="tok-type">void</span> {</span>
<span class="line" id="L939">    self.packages.append(self.builder.dupePkg(package)) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L940">    self.addRecursiveBuildDeps(package);</span>
<span class="line" id="L941">}</span>
<span class="line" id="L942"></span>
<span class="line" id="L943"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addOptions</span>(self: *LibExeObjStep, package_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, options: *OptionsStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L944">    self.addPackage(options.getPackage(package_name));</span>
<span class="line" id="L945">}</span>
<span class="line" id="L946"></span>
<span class="line" id="L947"><span class="tok-kw">fn</span> <span class="tok-fn">addRecursiveBuildDeps</span>(self: *LibExeObjStep, package: Pkg) <span class="tok-type">void</span> {</span>
<span class="line" id="L948">    package.source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L949">    <span class="tok-kw">if</span> (package.dependencies) |deps| {</span>
<span class="line" id="L950">        <span class="tok-kw">for</span> (deps) |dep| {</span>
<span class="line" id="L951">            self.addRecursiveBuildDeps(dep);</span>
<span class="line" id="L952">        }</span>
<span class="line" id="L953">    }</span>
<span class="line" id="L954">}</span>
<span class="line" id="L955"></span>
<span class="line" id="L956"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addPackagePath</span>(self: *LibExeObjStep, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, pkg_index_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L957">    self.addPackage(Pkg{</span>
<span class="line" id="L958">        .name = self.builder.dupe(name),</span>
<span class="line" id="L959">        .source = .{ .path = self.builder.dupe(pkg_index_path) },</span>
<span class="line" id="L960">    });</span>
<span class="line" id="L961">}</span>
<span class="line" id="L962"></span>
<span class="line" id="L963"><span class="tok-comment">/// If Vcpkg was found on the system, it will be added to include and lib</span></span>
<span class="line" id="L964"><span class="tok-comment">/// paths for the specified target.</span></span>
<span class="line" id="L965"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addVcpkgPaths</span>(self: *LibExeObjStep, linkage: LibExeObjStep.Linkage) !<span class="tok-type">void</span> {</span>
<span class="line" id="L966">    <span class="tok-comment">// Ideally in the Unattempted case we would call the function recursively</span>
</span>
<span class="line" id="L967">    <span class="tok-comment">// after findVcpkgRoot and have only one switch statement, but the compiler</span>
</span>
<span class="line" id="L968">    <span class="tok-comment">// cannot resolve the error set.</span>
</span>
<span class="line" id="L969">    <span class="tok-kw">switch</span> (self.builder.vcpkg_root) {</span>
<span class="line" id="L970">        .unattempted =&gt; {</span>
<span class="line" id="L971">            self.builder.vcpkg_root = <span class="tok-kw">if</span> (<span class="tok-kw">try</span> findVcpkgRoot(self.builder.allocator)) |root|</span>
<span class="line" id="L972">                VcpkgRoot{ .found = root }</span>
<span class="line" id="L973">            <span class="tok-kw">else</span></span>
<span class="line" id="L974">                .not_found;</span>
<span class="line" id="L975">        },</span>
<span class="line" id="L976">        .not_found =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.VcpkgNotFound,</span>
<span class="line" id="L977">        .found =&gt; {},</span>
<span class="line" id="L978">    }</span>
<span class="line" id="L979"></span>
<span class="line" id="L980">    <span class="tok-kw">switch</span> (self.builder.vcpkg_root) {</span>
<span class="line" id="L981">        .unattempted =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L982">        .not_found =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.VcpkgNotFound,</span>
<span class="line" id="L983">        .found =&gt; |root| {</span>
<span class="line" id="L984">            <span class="tok-kw">const</span> allocator = self.builder.allocator;</span>
<span class="line" id="L985">            <span class="tok-kw">const</span> triplet = <span class="tok-kw">try</span> self.target.vcpkgTriplet(allocator, <span class="tok-kw">if</span> (linkage == .static) .Static <span class="tok-kw">else</span> .Dynamic);</span>
<span class="line" id="L986">            <span class="tok-kw">defer</span> self.builder.allocator.free(triplet);</span>
<span class="line" id="L987"></span>
<span class="line" id="L988">            <span class="tok-kw">const</span> include_path = self.builder.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;include&quot;</span> });</span>
<span class="line" id="L989">            <span class="tok-kw">errdefer</span> allocator.free(include_path);</span>
<span class="line" id="L990">            <span class="tok-kw">try</span> self.include_dirs.append(IncludeDir{ .raw_path = include_path });</span>
<span class="line" id="L991"></span>
<span class="line" id="L992">            <span class="tok-kw">const</span> lib_path = self.builder.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;lib&quot;</span> });</span>
<span class="line" id="L993">            <span class="tok-kw">try</span> self.lib_paths.append(lib_path);</span>
<span class="line" id="L994"></span>
<span class="line" id="L995">            self.vcpkg_bin_path = self.builder.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;bin&quot;</span> });</span>
<span class="line" id="L996">        },</span>
<span class="line" id="L997">    }</span>
<span class="line" id="L998">}</span>
<span class="line" id="L999"></span>
<span class="line" id="L1000"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setExecCmd</span>(self: *LibExeObjStep, args: []<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1001">    assert(self.kind == .@&quot;test&quot;);</span>
<span class="line" id="L1002">    <span class="tok-kw">const</span> duped_args = self.builder.allocator.alloc(?[]<span class="tok-type">u8</span>, args.len) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1003">    <span class="tok-kw">for</span> (args) |arg, i| {</span>
<span class="line" id="L1004">        duped_args[i] = <span class="tok-kw">if</span> (arg) |a| self.builder.dupe(a) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L1005">    }</span>
<span class="line" id="L1006">    self.exec_cmd_args = duped_args;</span>
<span class="line" id="L1007">}</span>
<span class="line" id="L1008"></span>
<span class="line" id="L1009"><span class="tok-kw">fn</span> <span class="tok-fn">linkLibraryOrObject</span>(self: *LibExeObjStep, other: *LibExeObjStep) <span class="tok-type">void</span> {</span>
<span class="line" id="L1010">    self.step.dependOn(&amp;other.step);</span>
<span class="line" id="L1011">    self.link_objects.append(.{ .other_step = other }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1012">    self.include_dirs.append(.{ .other_step = other }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1013">}</span>
<span class="line" id="L1014"></span>
<span class="line" id="L1015"><span class="tok-kw">fn</span> <span class="tok-fn">makePackageCmd</span>(self: *LibExeObjStep, pkg: Pkg, zig_args: *ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>)) <span class="tok-kw">error</span>{OutOfMemory}!<span class="tok-type">void</span> {</span>
<span class="line" id="L1016">    <span class="tok-kw">const</span> builder = self.builder;</span>
<span class="line" id="L1017"></span>
<span class="line" id="L1018">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--pkg-begin&quot;</span>);</span>
<span class="line" id="L1019">    <span class="tok-kw">try</span> zig_args.append(pkg.name);</span>
<span class="line" id="L1020">    <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(pkg.source.getPath(self.builder)));</span>
<span class="line" id="L1021"></span>
<span class="line" id="L1022">    <span class="tok-kw">if</span> (pkg.dependencies) |dependencies| {</span>
<span class="line" id="L1023">        <span class="tok-kw">for</span> (dependencies) |sub_pkg| {</span>
<span class="line" id="L1024">            <span class="tok-kw">try</span> self.makePackageCmd(sub_pkg, zig_args);</span>
<span class="line" id="L1025">        }</span>
<span class="line" id="L1026">    }</span>
<span class="line" id="L1027"></span>
<span class="line" id="L1028">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--pkg-end&quot;</span>);</span>
<span class="line" id="L1029">}</span>
<span class="line" id="L1030"></span>
<span class="line" id="L1031"><span class="tok-kw">fn</span> <span class="tok-fn">make</span>(step: *Step) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1032">    <span class="tok-kw">const</span> self = <span class="tok-builtin">@fieldParentPtr</span>(LibExeObjStep, <span class="tok-str">&quot;step&quot;</span>, step);</span>
<span class="line" id="L1033">    <span class="tok-kw">const</span> builder = self.builder;</span>
<span class="line" id="L1034"></span>
<span class="line" id="L1035">    <span class="tok-kw">if</span> (self.root_src == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.link_objects.items.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1036">        log.err(<span class="tok-str">&quot;{s}: linker needs 1 or more objects to link&quot;</span>, .{self.step.name});</span>
<span class="line" id="L1037">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NeedAnObject;</span>
<span class="line" id="L1038">    }</span>
<span class="line" id="L1039"></span>
<span class="line" id="L1040">    <span class="tok-kw">var</span> zig_args = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(builder.allocator);</span>
<span class="line" id="L1041">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L1042"></span>
<span class="line" id="L1043">    zig_args.append(builder.zig_exe) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1044"></span>
<span class="line" id="L1045">    <span class="tok-kw">const</span> cmd = <span class="tok-kw">switch</span> (self.kind) {</span>
<span class="line" id="L1046">        .lib =&gt; <span class="tok-str">&quot;build-lib&quot;</span>,</span>
<span class="line" id="L1047">        .exe =&gt; <span class="tok-str">&quot;build-exe&quot;</span>,</span>
<span class="line" id="L1048">        .obj =&gt; <span class="tok-str">&quot;build-obj&quot;</span>,</span>
<span class="line" id="L1049">        .@&quot;test&quot; =&gt; <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L1050">        .test_exe =&gt; <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L1051">    };</span>
<span class="line" id="L1052">    zig_args.append(cmd) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1053"></span>
<span class="line" id="L1054">    <span class="tok-kw">if</span> (builder.color != .auto) {</span>
<span class="line" id="L1055">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--color&quot;</span>);</span>
<span class="line" id="L1056">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-builtin">@tagName</span>(builder.color));</span>
<span class="line" id="L1057">    }</span>
<span class="line" id="L1058"></span>
<span class="line" id="L1059">    <span class="tok-kw">if</span> (builder.reference_trace) |some| {</span>
<span class="line" id="L1060">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, <span class="tok-str">&quot;-freference-trace={d}&quot;</span>, .{some}));</span>
<span class="line" id="L1061">    }</span>
<span class="line" id="L1062"></span>
<span class="line" id="L1063">    <span class="tok-kw">if</span> (self.use_llvm) |use_llvm| {</span>
<span class="line" id="L1064">        <span class="tok-kw">if</span> (use_llvm) {</span>
<span class="line" id="L1065">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fLLVM&quot;</span>);</span>
<span class="line" id="L1066">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1067">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-LLVM&quot;</span>);</span>
<span class="line" id="L1068">        }</span>
<span class="line" id="L1069">    }</span>
<span class="line" id="L1070"></span>
<span class="line" id="L1071">    <span class="tok-kw">if</span> (self.use_lld) |use_lld| {</span>
<span class="line" id="L1072">        <span class="tok-kw">if</span> (use_lld) {</span>
<span class="line" id="L1073">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fLLD&quot;</span>);</span>
<span class="line" id="L1074">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1075">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-LLD&quot;</span>);</span>
<span class="line" id="L1076">        }</span>
<span class="line" id="L1077">    }</span>
<span class="line" id="L1078"></span>
<span class="line" id="L1079">    <span class="tok-kw">if</span> (self.target.ofmt) |ofmt| {</span>
<span class="line" id="L1080">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, <span class="tok-str">&quot;-ofmt={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(ofmt)}));</span>
<span class="line" id="L1081">    }</span>
<span class="line" id="L1082"></span>
<span class="line" id="L1083">    <span class="tok-kw">if</span> (self.entry_symbol_name) |entry| {</span>
<span class="line" id="L1084">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--entry&quot;</span>);</span>
<span class="line" id="L1085">        <span class="tok-kw">try</span> zig_args.append(entry);</span>
<span class="line" id="L1086">    }</span>
<span class="line" id="L1087"></span>
<span class="line" id="L1088">    <span class="tok-kw">if</span> (self.stack_size) |stack_size| {</span>
<span class="line" id="L1089">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--stack&quot;</span>);</span>
<span class="line" id="L1090">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, <span class="tok-str">&quot;{}&quot;</span>, .{stack_size}));</span>
<span class="line" id="L1091">    }</span>
<span class="line" id="L1092"></span>
<span class="line" id="L1093">    <span class="tok-kw">if</span> (self.root_src) |root_src| <span class="tok-kw">try</span> zig_args.append(root_src.getPath(builder));</span>
<span class="line" id="L1094"></span>
<span class="line" id="L1095">    <span class="tok-kw">var</span> prev_has_extra_flags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1096"></span>
<span class="line" id="L1097">    <span class="tok-comment">// Resolve transitive dependencies</span>
</span>
<span class="line" id="L1098">    {</span>
<span class="line" id="L1099">        <span class="tok-kw">var</span> transitive_dependencies = std.ArrayList(LinkObject).init(builder.allocator);</span>
<span class="line" id="L1100">        <span class="tok-kw">defer</span> transitive_dependencies.deinit();</span>
<span class="line" id="L1101"></span>
<span class="line" id="L1102">        <span class="tok-kw">for</span> (self.link_objects.items) |link_object| {</span>
<span class="line" id="L1103">            <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L1104">                .other_step =&gt; |other| {</span>
<span class="line" id="L1105">                    <span class="tok-comment">// Inherit dependency on system libraries</span>
</span>
<span class="line" id="L1106">                    <span class="tok-kw">for</span> (other.link_objects.items) |other_link_object| {</span>
<span class="line" id="L1107">                        <span class="tok-kw">switch</span> (other_link_object) {</span>
<span class="line" id="L1108">                            .system_lib =&gt; <span class="tok-kw">try</span> transitive_dependencies.append(other_link_object),</span>
<span class="line" id="L1109">                            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1110">                        }</span>
<span class="line" id="L1111">                    }</span>
<span class="line" id="L1112"></span>
<span class="line" id="L1113">                    <span class="tok-comment">// Inherit dependencies on darwin frameworks</span>
</span>
<span class="line" id="L1114">                    <span class="tok-kw">if</span> (!other.isDynamicLibrary()) {</span>
<span class="line" id="L1115">                        <span class="tok-kw">var</span> it = other.frameworks.iterator();</span>
<span class="line" id="L1116">                        <span class="tok-kw">while</span> (it.next()) |framework| {</span>
<span class="line" id="L1117">                            self.frameworks.put(framework.key_ptr.*, framework.value_ptr.*) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1118">                        }</span>
<span class="line" id="L1119">                    }</span>
<span class="line" id="L1120">                },</span>
<span class="line" id="L1121">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L1122">            }</span>
<span class="line" id="L1123">        }</span>
<span class="line" id="L1124"></span>
<span class="line" id="L1125">        <span class="tok-kw">try</span> self.link_objects.appendSlice(transitive_dependencies.items);</span>
<span class="line" id="L1126">    }</span>
<span class="line" id="L1127"></span>
<span class="line" id="L1128">    <span class="tok-kw">for</span> (self.link_objects.items) |link_object| {</span>
<span class="line" id="L1129">        <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L1130">            .static_path =&gt; |static_path| <span class="tok-kw">try</span> zig_args.append(static_path.getPath(builder)),</span>
<span class="line" id="L1131"></span>
<span class="line" id="L1132">            .other_step =&gt; |other| <span class="tok-kw">switch</span> (other.kind) {</span>
<span class="line" id="L1133">                .exe =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Cannot link with an executable build artifact&quot;</span>),</span>
<span class="line" id="L1134">                .test_exe =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Cannot link with an executable build artifact&quot;</span>),</span>
<span class="line" id="L1135">                .@&quot;test&quot; =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Cannot link with a test&quot;</span>),</span>
<span class="line" id="L1136">                .obj =&gt; {</span>
<span class="line" id="L1137">                    <span class="tok-kw">try</span> zig_args.append(other.getOutputSource().getPath(builder));</span>
<span class="line" id="L1138">                },</span>
<span class="line" id="L1139">                .lib =&gt; {</span>
<span class="line" id="L1140">                    <span class="tok-kw">const</span> full_path_lib = other.getOutputLibSource().getPath(builder);</span>
<span class="line" id="L1141">                    <span class="tok-kw">try</span> zig_args.append(full_path_lib);</span>
<span class="line" id="L1142"></span>
<span class="line" id="L1143">                    <span class="tok-kw">if</span> (other.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> other.linkage.? == .dynamic <span class="tok-kw">and</span> !self.target.isWindows()) {</span>
<span class="line" id="L1144">                        <span class="tok-kw">if</span> (fs.path.dirname(full_path_lib)) |dirname| {</span>
<span class="line" id="L1145">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rpath&quot;</span>);</span>
<span class="line" id="L1146">                            <span class="tok-kw">try</span> zig_args.append(dirname);</span>
<span class="line" id="L1147">                        }</span>
<span class="line" id="L1148">                    }</span>
<span class="line" id="L1149">                },</span>
<span class="line" id="L1150">            },</span>
<span class="line" id="L1151"></span>
<span class="line" id="L1152">            .system_lib =&gt; |system_lib| {</span>
<span class="line" id="L1153">                <span class="tok-kw">const</span> prefix: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = prefix: {</span>
<span class="line" id="L1154">                    <span class="tok-kw">if</span> (system_lib.needed) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-needed-l&quot;</span>;</span>
<span class="line" id="L1155">                    <span class="tok-kw">if</span> (system_lib.weak) {</span>
<span class="line" id="L1156">                        <span class="tok-kw">if</span> (self.target.isDarwin()) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-weak-l&quot;</span>;</span>
<span class="line" id="L1157">                        log.warn(<span class="tok-str">&quot;Weak library import used for a non-darwin target, this will be converted to normally library import `-lname`&quot;</span>, .{});</span>
<span class="line" id="L1158">                    }</span>
<span class="line" id="L1159">                    <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-l&quot;</span>;</span>
<span class="line" id="L1160">                };</span>
<span class="line" id="L1161">                <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1162">                    .no =&gt; <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{ prefix, system_lib.name })),</span>
<span class="line" id="L1163">                    .yes, .force =&gt; {</span>
<span class="line" id="L1164">                        <span class="tok-kw">if</span> (self.runPkgConfig(system_lib.name)) |args| {</span>
<span class="line" id="L1165">                            <span class="tok-kw">try</span> zig_args.appendSlice(args);</span>
<span class="line" id="L1166">                        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1167">                            <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L1168">                            <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L1169">                            <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L1170">                            <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L1171">                            <span class="tok-kw">error</span>.PackageNotFound,</span>
<span class="line" id="L1172">                            =&gt; <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1173">                                .yes =&gt; {</span>
<span class="line" id="L1174">                                    <span class="tok-comment">// pkg-config failed, so fall back to linking the library</span>
</span>
<span class="line" id="L1175">                                    <span class="tok-comment">// by name directly.</span>
</span>
<span class="line" id="L1176">                                    <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1177">                                        prefix,</span>
<span class="line" id="L1178">                                        system_lib.name,</span>
<span class="line" id="L1179">                                    }));</span>
<span class="line" id="L1180">                                },</span>
<span class="line" id="L1181">                                .force =&gt; {</span>
<span class="line" id="L1182">                                    panic(<span class="tok-str">&quot;pkg-config failed for library {s}&quot;</span>, .{system_lib.name});</span>
<span class="line" id="L1183">                                },</span>
<span class="line" id="L1184">                                .no =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1185">                            },</span>
<span class="line" id="L1186"></span>
<span class="line" id="L1187">                            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1188">                        }</span>
<span class="line" id="L1189">                    },</span>
<span class="line" id="L1190">                }</span>
<span class="line" id="L1191">            },</span>
<span class="line" id="L1192"></span>
<span class="line" id="L1193">            .assembly_file =&gt; |asm_file| {</span>
<span class="line" id="L1194">                <span class="tok-kw">if</span> (prev_has_extra_flags) {</span>
<span class="line" id="L1195">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-extra-cflags&quot;</span>);</span>
<span class="line" id="L1196">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1197">                    prev_has_extra_flags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1198">                }</span>
<span class="line" id="L1199">                <span class="tok-kw">try</span> zig_args.append(asm_file.getPath(builder));</span>
<span class="line" id="L1200">            },</span>
<span class="line" id="L1201"></span>
<span class="line" id="L1202">            .c_source_file =&gt; |c_source_file| {</span>
<span class="line" id="L1203">                <span class="tok-kw">if</span> (c_source_file.args.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1204">                    <span class="tok-kw">if</span> (prev_has_extra_flags) {</span>
<span class="line" id="L1205">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1206">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1207">                        prev_has_extra_flags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1208">                    }</span>
<span class="line" id="L1209">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1210">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1211">                    <span class="tok-kw">for</span> (c_source_file.args) |arg| {</span>
<span class="line" id="L1212">                        <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1213">                    }</span>
<span class="line" id="L1214">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1215">                }</span>
<span class="line" id="L1216">                <span class="tok-kw">try</span> zig_args.append(c_source_file.source.getPath(builder));</span>
<span class="line" id="L1217">            },</span>
<span class="line" id="L1218"></span>
<span class="line" id="L1219">            .c_source_files =&gt; |c_source_files| {</span>
<span class="line" id="L1220">                <span class="tok-kw">if</span> (c_source_files.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1221">                    <span class="tok-kw">if</span> (prev_has_extra_flags) {</span>
<span class="line" id="L1222">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1223">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1224">                        prev_has_extra_flags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1225">                    }</span>
<span class="line" id="L1226">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1227">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1228">                    <span class="tok-kw">for</span> (c_source_files.flags) |flag| {</span>
<span class="line" id="L1229">                        <span class="tok-kw">try</span> zig_args.append(flag);</span>
<span class="line" id="L1230">                    }</span>
<span class="line" id="L1231">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1232">                }</span>
<span class="line" id="L1233">                <span class="tok-kw">for</span> (c_source_files.files) |file| {</span>
<span class="line" id="L1234">                    <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(file));</span>
<span class="line" id="L1235">                }</span>
<span class="line" id="L1236">            },</span>
<span class="line" id="L1237">        }</span>
<span class="line" id="L1238">    }</span>
<span class="line" id="L1239"></span>
<span class="line" id="L1240">    <span class="tok-kw">if</span> (self.image_base) |image_base| {</span>
<span class="line" id="L1241">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--image-base&quot;</span>);</span>
<span class="line" id="L1242">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;0x{x}&quot;</span>, .{image_base}));</span>
<span class="line" id="L1243">    }</span>
<span class="line" id="L1244"></span>
<span class="line" id="L1245">    <span class="tok-kw">if</span> (self.filter) |filter| {</span>
<span class="line" id="L1246">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-filter&quot;</span>);</span>
<span class="line" id="L1247">        <span class="tok-kw">try</span> zig_args.append(filter);</span>
<span class="line" id="L1248">    }</span>
<span class="line" id="L1249"></span>
<span class="line" id="L1250">    <span class="tok-kw">if</span> (self.test_evented_io) {</span>
<span class="line" id="L1251">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-evented-io&quot;</span>);</span>
<span class="line" id="L1252">    }</span>
<span class="line" id="L1253"></span>
<span class="line" id="L1254">    <span class="tok-kw">if</span> (self.name_prefix.len != <span class="tok-number">0</span>) {</span>
<span class="line" id="L1255">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-name-prefix&quot;</span>);</span>
<span class="line" id="L1256">        <span class="tok-kw">try</span> zig_args.append(self.name_prefix);</span>
<span class="line" id="L1257">    }</span>
<span class="line" id="L1258"></span>
<span class="line" id="L1259">    <span class="tok-kw">if</span> (self.test_runner) |test_runner| {</span>
<span class="line" id="L1260">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-runner&quot;</span>);</span>
<span class="line" id="L1261">        <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(test_runner));</span>
<span class="line" id="L1262">    }</span>
<span class="line" id="L1263"></span>
<span class="line" id="L1264">    <span class="tok-kw">for</span> (builder.debug_log_scopes) |log_scope| {</span>
<span class="line" id="L1265">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-log&quot;</span>);</span>
<span class="line" id="L1266">        <span class="tok-kw">try</span> zig_args.append(log_scope);</span>
<span class="line" id="L1267">    }</span>
<span class="line" id="L1268"></span>
<span class="line" id="L1269">    <span class="tok-kw">if</span> (builder.debug_compile_errors) {</span>
<span class="line" id="L1270">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-compile-errors&quot;</span>);</span>
<span class="line" id="L1271">    }</span>
<span class="line" id="L1272"></span>
<span class="line" id="L1273">    <span class="tok-kw">if</span> (builder.verbose_cimport) zig_args.append(<span class="tok-str">&quot;--verbose-cimport&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1274">    <span class="tok-kw">if</span> (builder.verbose_air) zig_args.append(<span class="tok-str">&quot;--verbose-air&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1275">    <span class="tok-kw">if</span> (builder.verbose_llvm_ir) zig_args.append(<span class="tok-str">&quot;--verbose-llvm-ir&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1276">    <span class="tok-kw">if</span> (builder.verbose_link <span class="tok-kw">or</span> self.verbose_link) zig_args.append(<span class="tok-str">&quot;--verbose-link&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1277">    <span class="tok-kw">if</span> (builder.verbose_cc <span class="tok-kw">or</span> self.verbose_cc) zig_args.append(<span class="tok-str">&quot;--verbose-cc&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1278">    <span class="tok-kw">if</span> (builder.verbose_llvm_cpu_features) zig_args.append(<span class="tok-str">&quot;--verbose-llvm-cpu-features&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1279"></span>
<span class="line" id="L1280">    <span class="tok-kw">if</span> (self.emit_analysis.getArg(builder, <span class="tok-str">&quot;emit-analysis&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1281">    <span class="tok-kw">if</span> (self.emit_asm.getArg(builder, <span class="tok-str">&quot;emit-asm&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1282">    <span class="tok-kw">if</span> (self.emit_bin.getArg(builder, <span class="tok-str">&quot;emit-bin&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1283">    <span class="tok-kw">if</span> (self.emit_docs.getArg(builder, <span class="tok-str">&quot;emit-docs&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1284">    <span class="tok-kw">if</span> (self.emit_implib.getArg(builder, <span class="tok-str">&quot;emit-implib&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1285">    <span class="tok-kw">if</span> (self.emit_llvm_bc.getArg(builder, <span class="tok-str">&quot;emit-llvm-bc&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1286">    <span class="tok-kw">if</span> (self.emit_llvm_ir.getArg(builder, <span class="tok-str">&quot;emit-llvm-ir&quot;</span>)) |arg| <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1287"></span>
<span class="line" id="L1288">    <span class="tok-kw">if</span> (self.emit_h) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-h&quot;</span>);</span>
<span class="line" id="L1289"></span>
<span class="line" id="L1290">    <span class="tok-kw">if</span> (self.strip) |strip| {</span>
<span class="line" id="L1291">        <span class="tok-kw">if</span> (strip) {</span>
<span class="line" id="L1292">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fstrip&quot;</span>);</span>
<span class="line" id="L1293">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1294">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-strip&quot;</span>);</span>
<span class="line" id="L1295">        }</span>
<span class="line" id="L1296">    }</span>
<span class="line" id="L1297"></span>
<span class="line" id="L1298">    <span class="tok-kw">if</span> (self.unwind_tables) |unwind_tables| {</span>
<span class="line" id="L1299">        <span class="tok-kw">if</span> (unwind_tables) {</span>
<span class="line" id="L1300">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-funwind-tables&quot;</span>);</span>
<span class="line" id="L1301">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1302">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-unwind-tables&quot;</span>);</span>
<span class="line" id="L1303">        }</span>
<span class="line" id="L1304">    }</span>
<span class="line" id="L1305"></span>
<span class="line" id="L1306">    <span class="tok-kw">switch</span> (self.compress_debug_sections) {</span>
<span class="line" id="L1307">        .none =&gt; {},</span>
<span class="line" id="L1308">        .zlib =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--compress-debug-sections=zlib&quot;</span>),</span>
<span class="line" id="L1309">    }</span>
<span class="line" id="L1310"></span>
<span class="line" id="L1311">    <span class="tok-kw">if</span> (self.link_eh_frame_hdr) {</span>
<span class="line" id="L1312">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--eh-frame-hdr&quot;</span>);</span>
<span class="line" id="L1313">    }</span>
<span class="line" id="L1314">    <span class="tok-kw">if</span> (self.link_emit_relocs) {</span>
<span class="line" id="L1315">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--emit-relocs&quot;</span>);</span>
<span class="line" id="L1316">    }</span>
<span class="line" id="L1317">    <span class="tok-kw">if</span> (self.link_function_sections) {</span>
<span class="line" id="L1318">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-ffunction-sections&quot;</span>);</span>
<span class="line" id="L1319">    }</span>
<span class="line" id="L1320">    <span class="tok-kw">if</span> (self.link_gc_sections) |x| {</span>
<span class="line" id="L1321">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;--gc-sections&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;--no-gc-sections&quot;</span>);</span>
<span class="line" id="L1322">    }</span>
<span class="line" id="L1323">    <span class="tok-kw">if</span> (self.linker_allow_shlib_undefined) |x| {</span>
<span class="line" id="L1324">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;-fallow-shlib-undefined&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;-fno-allow-shlib-undefined&quot;</span>);</span>
<span class="line" id="L1325">    }</span>
<span class="line" id="L1326">    <span class="tok-kw">if</span> (self.link_z_notext) {</span>
<span class="line" id="L1327">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1328">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;notext&quot;</span>);</span>
<span class="line" id="L1329">    }</span>
<span class="line" id="L1330">    <span class="tok-kw">if</span> (!self.link_z_relro) {</span>
<span class="line" id="L1331">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1332">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;norelro&quot;</span>);</span>
<span class="line" id="L1333">    }</span>
<span class="line" id="L1334">    <span class="tok-kw">if</span> (self.link_z_lazy) {</span>
<span class="line" id="L1335">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1336">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;lazy&quot;</span>);</span>
<span class="line" id="L1337">    }</span>
<span class="line" id="L1338"></span>
<span class="line" id="L1339">    <span class="tok-kw">if</span> (self.libc_file) |libc_file| {</span>
<span class="line" id="L1340">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1341">        <span class="tok-kw">try</span> zig_args.append(libc_file.getPath(self.builder));</span>
<span class="line" id="L1342">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (builder.libc_file) |libc_file| {</span>
<span class="line" id="L1343">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1344">        <span class="tok-kw">try</span> zig_args.append(libc_file);</span>
<span class="line" id="L1345">    }</span>
<span class="line" id="L1346"></span>
<span class="line" id="L1347">    <span class="tok-kw">switch</span> (self.build_mode) {</span>
<span class="line" id="L1348">        .Debug =&gt; {}, <span class="tok-comment">// Skip since it's the default.</span>
</span>
<span class="line" id="L1349">        <span class="tok-kw">else</span> =&gt; zig_args.append(builder.fmt(<span class="tok-str">&quot;-O{s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(self.build_mode)})) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1350">    }</span>
<span class="line" id="L1351"></span>
<span class="line" id="L1352">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--cache-dir&quot;</span>);</span>
<span class="line" id="L1353">    <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(builder.cache_root));</span>
<span class="line" id="L1354"></span>
<span class="line" id="L1355">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--global-cache-dir&quot;</span>);</span>
<span class="line" id="L1356">    <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(builder.global_cache_root));</span>
<span class="line" id="L1357"></span>
<span class="line" id="L1358">    zig_args.append(<span class="tok-str">&quot;--name&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1359">    zig_args.append(self.name) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1360"></span>
<span class="line" id="L1361">    <span class="tok-kw">if</span> (self.linkage) |some| <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L1362">        .dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dynamic&quot;</span>),</span>
<span class="line" id="L1363">        .static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-static&quot;</span>),</span>
<span class="line" id="L1364">    };</span>
<span class="line" id="L1365">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic) {</span>
<span class="line" id="L1366">        <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L1367">            zig_args.append(<span class="tok-str">&quot;--version&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1368">            zig_args.append(builder.fmt(<span class="tok-str">&quot;{}&quot;</span>, .{version})) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1369">        }</span>
<span class="line" id="L1370"></span>
<span class="line" id="L1371">        <span class="tok-kw">if</span> (self.target.isDarwin()) {</span>
<span class="line" id="L1372">            <span class="tok-kw">const</span> install_name = self.install_name <span class="tok-kw">orelse</span> builder.fmt(<span class="tok-str">&quot;@rpath/{s}{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1373">                self.target.libPrefix(),</span>
<span class="line" id="L1374">                self.name,</span>
<span class="line" id="L1375">                self.target.dynamicLibSuffix(),</span>
<span class="line" id="L1376">            });</span>
<span class="line" id="L1377">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-install_name&quot;</span>);</span>
<span class="line" id="L1378">            <span class="tok-kw">try</span> zig_args.append(install_name);</span>
<span class="line" id="L1379">        }</span>
<span class="line" id="L1380">    }</span>
<span class="line" id="L1381"></span>
<span class="line" id="L1382">    <span class="tok-kw">if</span> (self.entitlements) |entitlements| {</span>
<span class="line" id="L1383">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--entitlements&quot;</span>, entitlements });</span>
<span class="line" id="L1384">    }</span>
<span class="line" id="L1385">    <span class="tok-kw">if</span> (self.pagezero_size) |pagezero_size| {</span>
<span class="line" id="L1386">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, <span class="tok-str">&quot;{x}&quot;</span>, .{pagezero_size});</span>
<span class="line" id="L1387">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-pagezero_size&quot;</span>, size });</span>
<span class="line" id="L1388">    }</span>
<span class="line" id="L1389">    <span class="tok-kw">if</span> (self.search_strategy) |strat| <span class="tok-kw">switch</span> (strat) {</span>
<span class="line" id="L1390">        .paths_first =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_paths_first&quot;</span>),</span>
<span class="line" id="L1391">        .dylibs_first =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_dylibs_first&quot;</span>),</span>
<span class="line" id="L1392">    };</span>
<span class="line" id="L1393">    <span class="tok-kw">if</span> (self.headerpad_size) |headerpad_size| {</span>
<span class="line" id="L1394">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, <span class="tok-str">&quot;{x}&quot;</span>, .{headerpad_size});</span>
<span class="line" id="L1395">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-headerpad&quot;</span>, size });</span>
<span class="line" id="L1396">    }</span>
<span class="line" id="L1397">    <span class="tok-kw">if</span> (self.headerpad_max_install_names) {</span>
<span class="line" id="L1398">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-headerpad_max_install_names&quot;</span>);</span>
<span class="line" id="L1399">    }</span>
<span class="line" id="L1400">    <span class="tok-kw">if</span> (self.dead_strip_dylibs) {</span>
<span class="line" id="L1401">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dead_strip_dylibs&quot;</span>);</span>
<span class="line" id="L1402">    }</span>
<span class="line" id="L1403"></span>
<span class="line" id="L1404">    <span class="tok-kw">if</span> (self.bundle_compiler_rt) |x| {</span>
<span class="line" id="L1405">        <span class="tok-kw">if</span> (x) {</span>
<span class="line" id="L1406">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fcompiler-rt&quot;</span>);</span>
<span class="line" id="L1407">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1408">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-compiler-rt&quot;</span>);</span>
<span class="line" id="L1409">        }</span>
<span class="line" id="L1410">    }</span>
<span class="line" id="L1411">    <span class="tok-kw">if</span> (self.single_threaded) |single_threaded| {</span>
<span class="line" id="L1412">        <span class="tok-kw">if</span> (single_threaded) {</span>
<span class="line" id="L1413">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fsingle-threaded&quot;</span>);</span>
<span class="line" id="L1414">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1415">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-single-threaded&quot;</span>);</span>
<span class="line" id="L1416">        }</span>
<span class="line" id="L1417">    }</span>
<span class="line" id="L1418">    <span class="tok-kw">if</span> (self.disable_stack_probing) {</span>
<span class="line" id="L1419">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-stack-check&quot;</span>);</span>
<span class="line" id="L1420">    }</span>
<span class="line" id="L1421">    <span class="tok-kw">if</span> (self.stack_protector) |stack_protector| {</span>
<span class="line" id="L1422">        <span class="tok-kw">if</span> (stack_protector) {</span>
<span class="line" id="L1423">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fstack-protector&quot;</span>);</span>
<span class="line" id="L1424">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1425">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-stack-protector&quot;</span>);</span>
<span class="line" id="L1426">        }</span>
<span class="line" id="L1427">    }</span>
<span class="line" id="L1428">    <span class="tok-kw">if</span> (self.red_zone) |red_zone| {</span>
<span class="line" id="L1429">        <span class="tok-kw">if</span> (red_zone) {</span>
<span class="line" id="L1430">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mred-zone&quot;</span>);</span>
<span class="line" id="L1431">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1432">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mno-red-zone&quot;</span>);</span>
<span class="line" id="L1433">        }</span>
<span class="line" id="L1434">    }</span>
<span class="line" id="L1435">    <span class="tok-kw">if</span> (self.omit_frame_pointer) |omit_frame_pointer| {</span>
<span class="line" id="L1436">        <span class="tok-kw">if</span> (omit_frame_pointer) {</span>
<span class="line" id="L1437">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fomit-frame-pointer&quot;</span>);</span>
<span class="line" id="L1438">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1439">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-omit-frame-pointer&quot;</span>);</span>
<span class="line" id="L1440">        }</span>
<span class="line" id="L1441">    }</span>
<span class="line" id="L1442">    <span class="tok-kw">if</span> (self.dll_export_fns) |dll_export_fns| {</span>
<span class="line" id="L1443">        <span class="tok-kw">if</span> (dll_export_fns) {</span>
<span class="line" id="L1444">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fdll-export-fns&quot;</span>);</span>
<span class="line" id="L1445">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1446">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-dll-export-fns&quot;</span>);</span>
<span class="line" id="L1447">        }</span>
<span class="line" id="L1448">    }</span>
<span class="line" id="L1449">    <span class="tok-kw">if</span> (self.disable_sanitize_c) {</span>
<span class="line" id="L1450">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-sanitize-c&quot;</span>);</span>
<span class="line" id="L1451">    }</span>
<span class="line" id="L1452">    <span class="tok-kw">if</span> (self.sanitize_thread) {</span>
<span class="line" id="L1453">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fsanitize-thread&quot;</span>);</span>
<span class="line" id="L1454">    }</span>
<span class="line" id="L1455">    <span class="tok-kw">if</span> (self.rdynamic) {</span>
<span class="line" id="L1456">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rdynamic&quot;</span>);</span>
<span class="line" id="L1457">    }</span>
<span class="line" id="L1458">    <span class="tok-kw">if</span> (self.import_memory) {</span>
<span class="line" id="L1459">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-memory&quot;</span>);</span>
<span class="line" id="L1460">    }</span>
<span class="line" id="L1461">    <span class="tok-kw">if</span> (self.import_table) {</span>
<span class="line" id="L1462">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-table&quot;</span>);</span>
<span class="line" id="L1463">    }</span>
<span class="line" id="L1464">    <span class="tok-kw">if</span> (self.export_table) {</span>
<span class="line" id="L1465">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--export-table&quot;</span>);</span>
<span class="line" id="L1466">    }</span>
<span class="line" id="L1467">    <span class="tok-kw">if</span> (self.initial_memory) |initial_memory| {</span>
<span class="line" id="L1468">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;--initial-memory={d}&quot;</span>, .{initial_memory}));</span>
<span class="line" id="L1469">    }</span>
<span class="line" id="L1470">    <span class="tok-kw">if</span> (self.max_memory) |max_memory| {</span>
<span class="line" id="L1471">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;--max-memory={d}&quot;</span>, .{max_memory}));</span>
<span class="line" id="L1472">    }</span>
<span class="line" id="L1473">    <span class="tok-kw">if</span> (self.shared_memory) {</span>
<span class="line" id="L1474">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--shared-memory&quot;</span>);</span>
<span class="line" id="L1475">    }</span>
<span class="line" id="L1476">    <span class="tok-kw">if</span> (self.global_base) |global_base| {</span>
<span class="line" id="L1477">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;--global-base={d}&quot;</span>, .{global_base}));</span>
<span class="line" id="L1478">    }</span>
<span class="line" id="L1479"></span>
<span class="line" id="L1480">    <span class="tok-kw">if</span> (self.code_model != .default) {</span>
<span class="line" id="L1481">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mcmodel&quot;</span>);</span>
<span class="line" id="L1482">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-builtin">@tagName</span>(self.code_model));</span>
<span class="line" id="L1483">    }</span>
<span class="line" id="L1484">    <span class="tok-kw">if</span> (self.wasi_exec_model) |model| {</span>
<span class="line" id="L1485">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;-mexec-model={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(model)}));</span>
<span class="line" id="L1486">    }</span>
<span class="line" id="L1487">    <span class="tok-kw">for</span> (self.export_symbol_names) |symbol_name| {</span>
<span class="line" id="L1488">        <span class="tok-kw">try</span> zig_args.append(builder.fmt(<span class="tok-str">&quot;--export={s}&quot;</span>, .{symbol_name}));</span>
<span class="line" id="L1489">    }</span>
<span class="line" id="L1490"></span>
<span class="line" id="L1491">    <span class="tok-kw">if</span> (!self.target.isNative()) {</span>
<span class="line" id="L1492">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-target&quot;</span>);</span>
<span class="line" id="L1493">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> self.target.zigTriple(builder.allocator));</span>
<span class="line" id="L1494"></span>
<span class="line" id="L1495">        <span class="tok-comment">// TODO this logic can disappear if cpu model + features becomes part of the target triple</span>
</span>
<span class="line" id="L1496">        <span class="tok-kw">const</span> cross = self.target.toTarget();</span>
<span class="line" id="L1497">        <span class="tok-kw">const</span> all_features = cross.cpu.arch.allFeaturesList();</span>
<span class="line" id="L1498">        <span class="tok-kw">var</span> populated_cpu_features = cross.cpu.model.features;</span>
<span class="line" id="L1499">        populated_cpu_features.populateDependencies(all_features);</span>
<span class="line" id="L1500"></span>
<span class="line" id="L1501">        <span class="tok-kw">if</span> (populated_cpu_features.eql(cross.cpu.features)) {</span>
<span class="line" id="L1502">            <span class="tok-comment">// The CPU name alone is sufficient.</span>
</span>
<span class="line" id="L1503">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mcpu&quot;</span>);</span>
<span class="line" id="L1504">            <span class="tok-kw">try</span> zig_args.append(cross.cpu.model.name);</span>
<span class="line" id="L1505">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1506">            <span class="tok-kw">var</span> mcpu_buffer = std.ArrayList(<span class="tok-type">u8</span>).init(builder.allocator);</span>
<span class="line" id="L1507"></span>
<span class="line" id="L1508">            <span class="tok-kw">try</span> mcpu_buffer.writer().print(<span class="tok-str">&quot;-mcpu={s}&quot;</span>, .{cross.cpu.model.name});</span>
<span class="line" id="L1509"></span>
<span class="line" id="L1510">            <span class="tok-kw">for</span> (all_features) |feature, i_usize| {</span>
<span class="line" id="L1511">                <span class="tok-kw">const</span> i = <span class="tok-builtin">@intCast</span>(std.Target.Cpu.Feature.Set.Index, i_usize);</span>
<span class="line" id="L1512">                <span class="tok-kw">const</span> in_cpu_set = populated_cpu_features.isEnabled(i);</span>
<span class="line" id="L1513">                <span class="tok-kw">const</span> in_actual_set = cross.cpu.features.isEnabled(i);</span>
<span class="line" id="L1514">                <span class="tok-kw">if</span> (in_cpu_set <span class="tok-kw">and</span> !in_actual_set) {</span>
<span class="line" id="L1515">                    <span class="tok-kw">try</span> mcpu_buffer.writer().print(<span class="tok-str">&quot;-{s}&quot;</span>, .{feature.name});</span>
<span class="line" id="L1516">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (!in_cpu_set <span class="tok-kw">and</span> in_actual_set) {</span>
<span class="line" id="L1517">                    <span class="tok-kw">try</span> mcpu_buffer.writer().print(<span class="tok-str">&quot;+{s}&quot;</span>, .{feature.name});</span>
<span class="line" id="L1518">                }</span>
<span class="line" id="L1519">            }</span>
<span class="line" id="L1520"></span>
<span class="line" id="L1521">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> mcpu_buffer.toOwnedSlice());</span>
<span class="line" id="L1522">        }</span>
<span class="line" id="L1523"></span>
<span class="line" id="L1524">        <span class="tok-kw">if</span> (self.target.dynamic_linker.get()) |dynamic_linker| {</span>
<span class="line" id="L1525">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--dynamic-linker&quot;</span>);</span>
<span class="line" id="L1526">            <span class="tok-kw">try</span> zig_args.append(dynamic_linker);</span>
<span class="line" id="L1527">        }</span>
<span class="line" id="L1528">    }</span>
<span class="line" id="L1529"></span>
<span class="line" id="L1530">    <span class="tok-kw">if</span> (self.linker_script) |linker_script| {</span>
<span class="line" id="L1531">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--script&quot;</span>);</span>
<span class="line" id="L1532">        <span class="tok-kw">try</span> zig_args.append(linker_script.getPath(builder));</span>
<span class="line" id="L1533">    }</span>
<span class="line" id="L1534"></span>
<span class="line" id="L1535">    <span class="tok-kw">if</span> (self.version_script) |version_script| {</span>
<span class="line" id="L1536">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--version-script&quot;</span>);</span>
<span class="line" id="L1537">        <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(version_script));</span>
<span class="line" id="L1538">    }</span>
<span class="line" id="L1539"></span>
<span class="line" id="L1540">    <span class="tok-kw">if</span> (self.kind == .@&quot;test&quot;) {</span>
<span class="line" id="L1541">        <span class="tok-kw">if</span> (self.exec_cmd_args) |exec_cmd_args| {</span>
<span class="line" id="L1542">            <span class="tok-kw">for</span> (exec_cmd_args) |cmd_arg| {</span>
<span class="line" id="L1543">                <span class="tok-kw">if</span> (cmd_arg) |arg| {</span>
<span class="line" id="L1544">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1545">                    <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1546">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1547">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1548">                }</span>
<span class="line" id="L1549">            }</span>
<span class="line" id="L1550">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1551">            <span class="tok-kw">const</span> need_cross_glibc = self.target.isGnuLibC() <span class="tok-kw">and</span> self.is_linking_libc;</span>
<span class="line" id="L1552"></span>
<span class="line" id="L1553">            <span class="tok-kw">switch</span> (self.builder.host.getExternalExecutor(self.target_info, .{</span>
<span class="line" id="L1554">                .qemu_fixes_dl = need_cross_glibc <span class="tok-kw">and</span> builder.glibc_runtimes_dir != <span class="tok-null">null</span>,</span>
<span class="line" id="L1555">                .link_libc = self.is_linking_libc,</span>
<span class="line" id="L1556">            })) {</span>
<span class="line" id="L1557">                .native =&gt; {},</span>
<span class="line" id="L1558">                .bad_dl, .bad_os_or_cpu =&gt; {</span>
<span class="line" id="L1559">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1560">                },</span>
<span class="line" id="L1561">                .rosetta =&gt; <span class="tok-kw">if</span> (builder.enable_rosetta) {</span>
<span class="line" id="L1562">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1563">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1564">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1565">                },</span>
<span class="line" id="L1566">                .qemu =&gt; |bin_name| ok: {</span>
<span class="line" id="L1567">                    <span class="tok-kw">if</span> (builder.enable_qemu) qemu: {</span>
<span class="line" id="L1568">                        <span class="tok-kw">const</span> glibc_dir_arg = <span class="tok-kw">if</span> (need_cross_glibc)</span>
<span class="line" id="L1569">                            builder.glibc_runtimes_dir <span class="tok-kw">orelse</span> <span class="tok-kw">break</span> :qemu</span>
<span class="line" id="L1570">                        <span class="tok-kw">else</span></span>
<span class="line" id="L1571">                            <span class="tok-null">null</span>;</span>
<span class="line" id="L1572">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1573">                        <span class="tok-kw">try</span> zig_args.append(bin_name);</span>
<span class="line" id="L1574">                        <span class="tok-kw">if</span> (glibc_dir_arg) |dir| {</span>
<span class="line" id="L1575">                            <span class="tok-comment">// TODO look into making this a call to `linuxTriple`. This</span>
</span>
<span class="line" id="L1576">                            <span class="tok-comment">// needs the directory to be called &quot;i686&quot; rather than</span>
</span>
<span class="line" id="L1577">                            <span class="tok-comment">// &quot;x86&quot; which is why we do it manually here.</span>
</span>
<span class="line" id="L1578">                            <span class="tok-kw">const</span> fmt_str = <span class="tok-str">&quot;{s}&quot;</span> ++ fs.path.sep_str ++ <span class="tok-str">&quot;{s}-{s}-{s}&quot;</span>;</span>
<span class="line" id="L1579">                            <span class="tok-kw">const</span> cpu_arch = self.target.getCpuArch();</span>
<span class="line" id="L1580">                            <span class="tok-kw">const</span> os_tag = self.target.getOsTag();</span>
<span class="line" id="L1581">                            <span class="tok-kw">const</span> abi = self.target.getAbi();</span>
<span class="line" id="L1582">                            <span class="tok-kw">const</span> cpu_arch_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-kw">if</span> (cpu_arch == .x86)</span>
<span class="line" id="L1583">                                <span class="tok-str">&quot;i686&quot;</span></span>
<span class="line" id="L1584">                            <span class="tok-kw">else</span></span>
<span class="line" id="L1585">                                <span class="tok-builtin">@tagName</span>(cpu_arch);</span>
<span class="line" id="L1586">                            <span class="tok-kw">const</span> full_dir = <span class="tok-kw">try</span> std.fmt.allocPrint(builder.allocator, fmt_str, .{</span>
<span class="line" id="L1587">                                dir, cpu_arch_name, <span class="tok-builtin">@tagName</span>(os_tag), <span class="tok-builtin">@tagName</span>(abi),</span>
<span class="line" id="L1588">                            });</span>
<span class="line" id="L1589"></span>
<span class="line" id="L1590">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1591">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-L&quot;</span>);</span>
<span class="line" id="L1592">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1593">                            <span class="tok-kw">try</span> zig_args.append(full_dir);</span>
<span class="line" id="L1594">                        }</span>
<span class="line" id="L1595">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1596">                        <span class="tok-kw">break</span> :ok;</span>
<span class="line" id="L1597">                    }</span>
<span class="line" id="L1598">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1599">                },</span>
<span class="line" id="L1600">                .wine =&gt; |bin_name| <span class="tok-kw">if</span> (builder.enable_wine) {</span>
<span class="line" id="L1601">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1602">                    <span class="tok-kw">try</span> zig_args.append(bin_name);</span>
<span class="line" id="L1603">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1604">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1605">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1606">                },</span>
<span class="line" id="L1607">                .wasmtime =&gt; |bin_name| <span class="tok-kw">if</span> (builder.enable_wasmtime) {</span>
<span class="line" id="L1608">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1609">                    <span class="tok-kw">try</span> zig_args.append(bin_name);</span>
<span class="line" id="L1610">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1611">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--dir=.&quot;</span>);</span>
<span class="line" id="L1612">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1613">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--allow-unknown-exports&quot;</span>); <span class="tok-comment">// TODO: Remove when stage2 is default compiler</span>
</span>
<span class="line" id="L1614">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1615">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1616">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1617">                },</span>
<span class="line" id="L1618">                .darling =&gt; |bin_name| <span class="tok-kw">if</span> (builder.enable_darling) {</span>
<span class="line" id="L1619">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1620">                    <span class="tok-kw">try</span> zig_args.append(bin_name);</span>
<span class="line" id="L1621">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1622">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1623">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1624">                },</span>
<span class="line" id="L1625">            }</span>
<span class="line" id="L1626">        }</span>
<span class="line" id="L1627">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.kind == .test_exe) {</span>
<span class="line" id="L1628">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-no-exec&quot;</span>);</span>
<span class="line" id="L1629">    }</span>
<span class="line" id="L1630"></span>
<span class="line" id="L1631">    <span class="tok-kw">for</span> (self.packages.items) |pkg| {</span>
<span class="line" id="L1632">        <span class="tok-kw">try</span> self.makePackageCmd(pkg, &amp;zig_args);</span>
<span class="line" id="L1633">    }</span>
<span class="line" id="L1634"></span>
<span class="line" id="L1635">    <span class="tok-kw">for</span> (self.include_dirs.items) |include_dir| {</span>
<span class="line" id="L1636">        <span class="tok-kw">switch</span> (include_dir) {</span>
<span class="line" id="L1637">            .raw_path =&gt; |include_path| {</span>
<span class="line" id="L1638">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-I&quot;</span>);</span>
<span class="line" id="L1639">                <span class="tok-kw">try</span> zig_args.append(self.builder.pathFromRoot(include_path));</span>
<span class="line" id="L1640">            },</span>
<span class="line" id="L1641">            .raw_path_system =&gt; |include_path| {</span>
<span class="line" id="L1642">                <span class="tok-kw">if</span> (builder.sysroot != <span class="tok-null">null</span>) {</span>
<span class="line" id="L1643">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-iwithsysroot&quot;</span>);</span>
<span class="line" id="L1644">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1645">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-isystem&quot;</span>);</span>
<span class="line" id="L1646">                }</span>
<span class="line" id="L1647"></span>
<span class="line" id="L1648">                <span class="tok-kw">const</span> resolved_include_path = self.builder.pathFromRoot(include_path);</span>
<span class="line" id="L1649"></span>
<span class="line" id="L1650">                <span class="tok-kw">const</span> common_include_path = <span class="tok-kw">if</span> (builtin.os.tag == .windows <span class="tok-kw">and</span> builder.sysroot != <span class="tok-null">null</span> <span class="tok-kw">and</span> fs.path.isAbsolute(resolved_include_path)) blk: {</span>
<span class="line" id="L1651">                    <span class="tok-comment">// We need to check for disk designator and strip it out from dir path so</span>
</span>
<span class="line" id="L1652">                    <span class="tok-comment">// that zig/clang can concat resolved_include_path with sysroot.</span>
</span>
<span class="line" id="L1653">                    <span class="tok-kw">const</span> disk_designator = fs.path.diskDesignatorWindows(resolved_include_path);</span>
<span class="line" id="L1654"></span>
<span class="line" id="L1655">                    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, resolved_include_path, disk_designator)) |where| {</span>
<span class="line" id="L1656">                        <span class="tok-kw">break</span> :blk resolved_include_path[where + disk_designator.len ..];</span>
<span class="line" id="L1657">                    }</span>
<span class="line" id="L1658"></span>
<span class="line" id="L1659">                    <span class="tok-kw">break</span> :blk resolved_include_path;</span>
<span class="line" id="L1660">                } <span class="tok-kw">else</span> resolved_include_path;</span>
<span class="line" id="L1661"></span>
<span class="line" id="L1662">                <span class="tok-kw">try</span> zig_args.append(common_include_path);</span>
<span class="line" id="L1663">            },</span>
<span class="line" id="L1664">            .other_step =&gt; |other| <span class="tok-kw">if</span> (other.emit_h) {</span>
<span class="line" id="L1665">                <span class="tok-kw">const</span> h_path = other.getOutputHSource().getPath(self.builder);</span>
<span class="line" id="L1666">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-isystem&quot;</span>);</span>
<span class="line" id="L1667">                <span class="tok-kw">try</span> zig_args.append(fs.path.dirname(h_path).?);</span>
<span class="line" id="L1668">            },</span>
<span class="line" id="L1669">        }</span>
<span class="line" id="L1670">    }</span>
<span class="line" id="L1671"></span>
<span class="line" id="L1672">    <span class="tok-kw">for</span> (self.lib_paths.items) |lib_path| {</span>
<span class="line" id="L1673">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-L&quot;</span>);</span>
<span class="line" id="L1674">        <span class="tok-kw">try</span> zig_args.append(lib_path);</span>
<span class="line" id="L1675">    }</span>
<span class="line" id="L1676"></span>
<span class="line" id="L1677">    <span class="tok-kw">for</span> (self.rpaths.items) |rpath| {</span>
<span class="line" id="L1678">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rpath&quot;</span>);</span>
<span class="line" id="L1679">        <span class="tok-kw">try</span> zig_args.append(rpath);</span>
<span class="line" id="L1680">    }</span>
<span class="line" id="L1681"></span>
<span class="line" id="L1682">    <span class="tok-kw">for</span> (self.c_macros.items) |c_macro| {</span>
<span class="line" id="L1683">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-D&quot;</span>);</span>
<span class="line" id="L1684">        <span class="tok-kw">try</span> zig_args.append(c_macro);</span>
<span class="line" id="L1685">    }</span>
<span class="line" id="L1686"></span>
<span class="line" id="L1687">    <span class="tok-kw">if</span> (self.target.isDarwin()) {</span>
<span class="line" id="L1688">        <span class="tok-kw">for</span> (self.framework_dirs.items) |dir| {</span>
<span class="line" id="L1689">            <span class="tok-kw">if</span> (builder.sysroot != <span class="tok-null">null</span>) {</span>
<span class="line" id="L1690">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-iframeworkwithsysroot&quot;</span>);</span>
<span class="line" id="L1691">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1692">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-iframework&quot;</span>);</span>
<span class="line" id="L1693">            }</span>
<span class="line" id="L1694">            <span class="tok-kw">try</span> zig_args.append(dir);</span>
<span class="line" id="L1695">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-F&quot;</span>);</span>
<span class="line" id="L1696">            <span class="tok-kw">try</span> zig_args.append(dir);</span>
<span class="line" id="L1697">        }</span>
<span class="line" id="L1698"></span>
<span class="line" id="L1699">        <span class="tok-kw">var</span> it = self.frameworks.iterator();</span>
<span class="line" id="L1700">        <span class="tok-kw">while</span> (it.next()) |entry| {</span>
<span class="line" id="L1701">            <span class="tok-kw">const</span> name = entry.key_ptr.*;</span>
<span class="line" id="L1702">            <span class="tok-kw">const</span> info = entry.value_ptr.*;</span>
<span class="line" id="L1703">            <span class="tok-kw">if</span> (info.needed) {</span>
<span class="line" id="L1704">                zig_args.append(<span class="tok-str">&quot;-needed_framework&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1705">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (info.weak) {</span>
<span class="line" id="L1706">                zig_args.append(<span class="tok-str">&quot;-weak_framework&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1707">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1708">                zig_args.append(<span class="tok-str">&quot;-framework&quot;</span>) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1709">            }</span>
<span class="line" id="L1710">            zig_args.append(name) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1711">        }</span>
<span class="line" id="L1712">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1713">        <span class="tok-kw">if</span> (self.framework_dirs.items.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1714">            log.info(<span class="tok-str">&quot;Framework directories have been added for a non-darwin target, this will have no affect on the build&quot;</span>, .{});</span>
<span class="line" id="L1715">        }</span>
<span class="line" id="L1716"></span>
<span class="line" id="L1717">        <span class="tok-kw">if</span> (self.frameworks.count() &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1718">            log.info(<span class="tok-str">&quot;Frameworks have been added for a non-darwin target, this will have no affect on the build&quot;</span>, .{});</span>
<span class="line" id="L1719">        }</span>
<span class="line" id="L1720">    }</span>
<span class="line" id="L1721"></span>
<span class="line" id="L1722">    <span class="tok-kw">if</span> (builder.sysroot) |sysroot| {</span>
<span class="line" id="L1723">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--sysroot&quot;</span>, sysroot });</span>
<span class="line" id="L1724">    }</span>
<span class="line" id="L1725"></span>
<span class="line" id="L1726">    <span class="tok-kw">for</span> (builder.search_prefixes.items) |search_prefix| {</span>
<span class="line" id="L1727">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-L&quot;</span>);</span>
<span class="line" id="L1728">        <span class="tok-kw">try</span> zig_args.append(builder.pathJoin(&amp;.{</span>
<span class="line" id="L1729">            search_prefix, <span class="tok-str">&quot;lib&quot;</span>,</span>
<span class="line" id="L1730">        }));</span>
<span class="line" id="L1731">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-I&quot;</span>);</span>
<span class="line" id="L1732">        <span class="tok-kw">try</span> zig_args.append(builder.pathJoin(&amp;.{</span>
<span class="line" id="L1733">            search_prefix, <span class="tok-str">&quot;include&quot;</span>,</span>
<span class="line" id="L1734">        }));</span>
<span class="line" id="L1735">    }</span>
<span class="line" id="L1736"></span>
<span class="line" id="L1737">    <span class="tok-kw">if</span> (self.valgrind_support) |valgrind_support| {</span>
<span class="line" id="L1738">        <span class="tok-kw">if</span> (valgrind_support) {</span>
<span class="line" id="L1739">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fvalgrind&quot;</span>);</span>
<span class="line" id="L1740">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1741">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-valgrind&quot;</span>);</span>
<span class="line" id="L1742">        }</span>
<span class="line" id="L1743">    }</span>
<span class="line" id="L1744"></span>
<span class="line" id="L1745">    <span class="tok-kw">if</span> (self.each_lib_rpath) |each_lib_rpath| {</span>
<span class="line" id="L1746">        <span class="tok-kw">if</span> (each_lib_rpath) {</span>
<span class="line" id="L1747">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-feach-lib-rpath&quot;</span>);</span>
<span class="line" id="L1748">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1749">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-each-lib-rpath&quot;</span>);</span>
<span class="line" id="L1750">        }</span>
<span class="line" id="L1751">    }</span>
<span class="line" id="L1752"></span>
<span class="line" id="L1753">    <span class="tok-kw">if</span> (self.build_id) |build_id| {</span>
<span class="line" id="L1754">        <span class="tok-kw">if</span> (build_id) {</span>
<span class="line" id="L1755">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fbuild-id&quot;</span>);</span>
<span class="line" id="L1756">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1757">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-build-id&quot;</span>);</span>
<span class="line" id="L1758">        }</span>
<span class="line" id="L1759">    }</span>
<span class="line" id="L1760"></span>
<span class="line" id="L1761">    <span class="tok-kw">if</span> (self.override_lib_dir) |dir| {</span>
<span class="line" id="L1762">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--zig-lib-dir&quot;</span>);</span>
<span class="line" id="L1763">        <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(dir));</span>
<span class="line" id="L1764">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.builder.override_lib_dir) |dir| {</span>
<span class="line" id="L1765">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--zig-lib-dir&quot;</span>);</span>
<span class="line" id="L1766">        <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(dir));</span>
<span class="line" id="L1767">    }</span>
<span class="line" id="L1768"></span>
<span class="line" id="L1769">    <span class="tok-kw">if</span> (self.main_pkg_path) |dir| {</span>
<span class="line" id="L1770">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--main-pkg-path&quot;</span>);</span>
<span class="line" id="L1771">        <span class="tok-kw">try</span> zig_args.append(builder.pathFromRoot(dir));</span>
<span class="line" id="L1772">    }</span>
<span class="line" id="L1773"></span>
<span class="line" id="L1774">    <span class="tok-kw">if</span> (self.force_pic) |pic| {</span>
<span class="line" id="L1775">        <span class="tok-kw">if</span> (pic) {</span>
<span class="line" id="L1776">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fPIC&quot;</span>);</span>
<span class="line" id="L1777">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1778">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-PIC&quot;</span>);</span>
<span class="line" id="L1779">        }</span>
<span class="line" id="L1780">    }</span>
<span class="line" id="L1781"></span>
<span class="line" id="L1782">    <span class="tok-kw">if</span> (self.pie) |pie| {</span>
<span class="line" id="L1783">        <span class="tok-kw">if</span> (pie) {</span>
<span class="line" id="L1784">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fPIE&quot;</span>);</span>
<span class="line" id="L1785">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1786">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-PIE&quot;</span>);</span>
<span class="line" id="L1787">        }</span>
<span class="line" id="L1788">    }</span>
<span class="line" id="L1789"></span>
<span class="line" id="L1790">    <span class="tok-kw">if</span> (self.want_lto) |lto| {</span>
<span class="line" id="L1791">        <span class="tok-kw">if</span> (lto) {</span>
<span class="line" id="L1792">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-flto&quot;</span>);</span>
<span class="line" id="L1793">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1794">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-lto&quot;</span>);</span>
<span class="line" id="L1795">        }</span>
<span class="line" id="L1796">    }</span>
<span class="line" id="L1797"></span>
<span class="line" id="L1798">    <span class="tok-kw">if</span> (self.subsystem) |subsystem| {</span>
<span class="line" id="L1799">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--subsystem&quot;</span>);</span>
<span class="line" id="L1800">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (subsystem) {</span>
<span class="line" id="L1801">            .Console =&gt; <span class="tok-str">&quot;console&quot;</span>,</span>
<span class="line" id="L1802">            .Windows =&gt; <span class="tok-str">&quot;windows&quot;</span>,</span>
<span class="line" id="L1803">            .Posix =&gt; <span class="tok-str">&quot;posix&quot;</span>,</span>
<span class="line" id="L1804">            .Native =&gt; <span class="tok-str">&quot;native&quot;</span>,</span>
<span class="line" id="L1805">            .EfiApplication =&gt; <span class="tok-str">&quot;efi_application&quot;</span>,</span>
<span class="line" id="L1806">            .EfiBootServiceDriver =&gt; <span class="tok-str">&quot;efi_boot_service_driver&quot;</span>,</span>
<span class="line" id="L1807">            .EfiRom =&gt; <span class="tok-str">&quot;efi_rom&quot;</span>,</span>
<span class="line" id="L1808">            .EfiRuntimeDriver =&gt; <span class="tok-str">&quot;efi_runtime_driver&quot;</span>,</span>
<span class="line" id="L1809">        });</span>
<span class="line" id="L1810">    }</span>
<span class="line" id="L1811"></span>
<span class="line" id="L1812">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--enable-cache&quot;</span>);</span>
<span class="line" id="L1813"></span>
<span class="line" id="L1814">    <span class="tok-comment">// Windows has an argument length limit of 32,766 characters, macOS 262,144 and Linux</span>
</span>
<span class="line" id="L1815">    <span class="tok-comment">// 2,097,152. If our args exceed 30 KiB, we instead write them to a &quot;response file&quot; and</span>
</span>
<span class="line" id="L1816">    <span class="tok-comment">// pass that to zig, e.g. via 'zig build-lib @args.rsp'</span>
</span>
<span class="line" id="L1817">    <span class="tok-comment">// See @file syntax here: https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html</span>
</span>
<span class="line" id="L1818">    <span class="tok-kw">var</span> args_length: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1819">    <span class="tok-kw">for</span> (zig_args.items) |arg| {</span>
<span class="line" id="L1820">        args_length += arg.len + <span class="tok-number">1</span>; <span class="tok-comment">// +1 to account for null terminator</span>
</span>
<span class="line" id="L1821">    }</span>
<span class="line" id="L1822">    <span class="tok-kw">if</span> (args_length &gt;= <span class="tok-number">30</span> * <span class="tok-number">1024</span>) {</span>
<span class="line" id="L1823">        <span class="tok-kw">const</span> args_dir = <span class="tok-kw">try</span> fs.path.join(</span>
<span class="line" id="L1824">            builder.allocator,</span>
<span class="line" id="L1825">            &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ builder.pathFromRoot(<span class="tok-str">&quot;zig-cache&quot;</span>), <span class="tok-str">&quot;args&quot;</span> },</span>
<span class="line" id="L1826">        );</span>
<span class="line" id="L1827">        <span class="tok-kw">try</span> std.fs.cwd().makePath(args_dir);</span>
<span class="line" id="L1828"></span>
<span class="line" id="L1829">        <span class="tok-kw">var</span> args_arena = std.heap.ArenaAllocator.init(builder.allocator);</span>
<span class="line" id="L1830">        <span class="tok-kw">defer</span> args_arena.deinit();</span>
<span class="line" id="L1831"></span>
<span class="line" id="L1832">        <span class="tok-kw">const</span> args_to_escape = zig_args.items[<span class="tok-number">2</span>..];</span>
<span class="line" id="L1833">        <span class="tok-kw">var</span> escaped_args = <span class="tok-kw">try</span> ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).initCapacity(args_arena.allocator(), args_to_escape.len);</span>
<span class="line" id="L1834"></span>
<span class="line" id="L1835">        arg_blk: <span class="tok-kw">for</span> (args_to_escape) |arg| {</span>
<span class="line" id="L1836">            <span class="tok-kw">for</span> (arg) |c, arg_idx| {</span>
<span class="line" id="L1837">                <span class="tok-kw">if</span> (c == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> c == <span class="tok-str">'&quot;'</span>) {</span>
<span class="line" id="L1838">                    <span class="tok-comment">// Slow path for arguments that need to be escaped. We'll need to allocate and copy</span>
</span>
<span class="line" id="L1839">                    <span class="tok-kw">var</span> escaped = <span class="tok-kw">try</span> ArrayList(<span class="tok-type">u8</span>).initCapacity(args_arena.allocator(), arg.len + <span class="tok-number">1</span>);</span>
<span class="line" id="L1840">                    <span class="tok-kw">const</span> writer = escaped.writer();</span>
<span class="line" id="L1841">                    writer.writeAll(arg[<span class="tok-number">0</span>..arg_idx]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1842">                    <span class="tok-kw">for</span> (arg[arg_idx..]) |to_escape| {</span>
<span class="line" id="L1843">                        <span class="tok-kw">if</span> (to_escape == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> to_escape == <span class="tok-str">'&quot;'</span>) <span class="tok-kw">try</span> writer.writeByte(<span class="tok-str">'\\'</span>);</span>
<span class="line" id="L1844">                        <span class="tok-kw">try</span> writer.writeByte(to_escape);</span>
<span class="line" id="L1845">                    }</span>
<span class="line" id="L1846">                    escaped_args.appendAssumeCapacity(escaped.items);</span>
<span class="line" id="L1847">                    <span class="tok-kw">continue</span> :arg_blk;</span>
<span class="line" id="L1848">                }</span>
<span class="line" id="L1849">            }</span>
<span class="line" id="L1850">            escaped_args.appendAssumeCapacity(arg); <span class="tok-comment">// no escaping needed so just use original argument</span>
</span>
<span class="line" id="L1851">        }</span>
<span class="line" id="L1852"></span>
<span class="line" id="L1853">        <span class="tok-comment">// Write the args to zig-cache/args/&lt;SHA256 hash of args&gt; to avoid conflicts with</span>
</span>
<span class="line" id="L1854">        <span class="tok-comment">// other zig build commands running in parallel.</span>
</span>
<span class="line" id="L1855">        <span class="tok-kw">const</span> partially_quoted = <span class="tok-kw">try</span> std.mem.join(builder.allocator, <span class="tok-str">&quot;\&quot; \&quot;&quot;</span>, escaped_args.items);</span>
<span class="line" id="L1856">        <span class="tok-kw">const</span> args = <span class="tok-kw">try</span> std.mem.concat(builder.allocator, <span class="tok-type">u8</span>, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;\&quot;&quot;</span>, partially_quoted, <span class="tok-str">&quot;\&quot;&quot;</span> });</span>
<span class="line" id="L1857"></span>
<span class="line" id="L1858">        <span class="tok-kw">var</span> args_hash: [Sha256.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1859">        Sha256.hash(args, &amp;args_hash, .{});</span>
<span class="line" id="L1860">        <span class="tok-kw">var</span> args_hex_hash: [Sha256.digest_length * <span class="tok-number">2</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1861">        _ = <span class="tok-kw">try</span> std.fmt.bufPrint(</span>
<span class="line" id="L1862">            &amp;args_hex_hash,</span>
<span class="line" id="L1863">            <span class="tok-str">&quot;{s}&quot;</span>,</span>
<span class="line" id="L1864">            .{std.fmt.fmtSliceHexLower(&amp;args_hash)},</span>
<span class="line" id="L1865">        );</span>
<span class="line" id="L1866"></span>
<span class="line" id="L1867">        <span class="tok-kw">const</span> args_file = <span class="tok-kw">try</span> fs.path.join(builder.allocator, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ args_dir, args_hex_hash[<span class="tok-number">0</span>..] });</span>
<span class="line" id="L1868">        <span class="tok-kw">try</span> std.fs.cwd().writeFile(args_file, args);</span>
<span class="line" id="L1869"></span>
<span class="line" id="L1870">        zig_args.shrinkRetainingCapacity(<span class="tok-number">2</span>);</span>
<span class="line" id="L1871">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.mem.concat(builder.allocator, <span class="tok-type">u8</span>, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;@&quot;</span>, args_file }));</span>
<span class="line" id="L1872">    }</span>
<span class="line" id="L1873"></span>
<span class="line" id="L1874">    <span class="tok-kw">const</span> output_dir_nl = <span class="tok-kw">try</span> builder.execFromStep(zig_args.items, &amp;self.step);</span>
<span class="line" id="L1875">    <span class="tok-kw">const</span> build_output_dir = mem.trimRight(<span class="tok-type">u8</span>, output_dir_nl, <span class="tok-str">&quot;\r\n&quot;</span>);</span>
<span class="line" id="L1876"></span>
<span class="line" id="L1877">    <span class="tok-kw">if</span> (self.output_dir) |output_dir| {</span>
<span class="line" id="L1878">        <span class="tok-kw">var</span> src_dir = <span class="tok-kw">try</span> std.fs.cwd().openIterableDir(build_output_dir, .{});</span>
<span class="line" id="L1879">        <span class="tok-kw">defer</span> src_dir.close();</span>
<span class="line" id="L1880"></span>
<span class="line" id="L1881">        <span class="tok-comment">// Create the output directory if it doesn't exist.</span>
</span>
<span class="line" id="L1882">        <span class="tok-kw">try</span> std.fs.cwd().makePath(output_dir);</span>
<span class="line" id="L1883"></span>
<span class="line" id="L1884">        <span class="tok-kw">var</span> dest_dir = <span class="tok-kw">try</span> std.fs.cwd().openDir(output_dir, .{});</span>
<span class="line" id="L1885">        <span class="tok-kw">defer</span> dest_dir.close();</span>
<span class="line" id="L1886"></span>
<span class="line" id="L1887">        <span class="tok-kw">var</span> it = src_dir.iterate();</span>
<span class="line" id="L1888">        <span class="tok-kw">while</span> (<span class="tok-kw">try</span> it.next()) |entry| {</span>
<span class="line" id="L1889">            <span class="tok-comment">// The compiler can put these files into the same directory, but we don't</span>
</span>
<span class="line" id="L1890">            <span class="tok-comment">// want to copy them over.</span>
</span>
<span class="line" id="L1891">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, entry.name, <span class="tok-str">&quot;llvm-ar.id&quot;</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L1892">                mem.eql(<span class="tok-type">u8</span>, entry.name, <span class="tok-str">&quot;libs.txt&quot;</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L1893">                mem.eql(<span class="tok-type">u8</span>, entry.name, <span class="tok-str">&quot;builtin.zig&quot;</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L1894">                mem.eql(<span class="tok-type">u8</span>, entry.name, <span class="tok-str">&quot;zld.id&quot;</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L1895">                mem.eql(<span class="tok-type">u8</span>, entry.name, <span class="tok-str">&quot;lld.id&quot;</span>)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1896"></span>
<span class="line" id="L1897">            _ = <span class="tok-kw">try</span> src_dir.dir.updateFile(entry.name, dest_dir, entry.name, .{});</span>
<span class="line" id="L1898">        }</span>
<span class="line" id="L1899">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1900">        self.output_dir = build_output_dir;</span>
<span class="line" id="L1901">    }</span>
<span class="line" id="L1902"></span>
<span class="line" id="L1903">    <span class="tok-comment">// This will ensure all output filenames will now have the output_dir available!</span>
</span>
<span class="line" id="L1904">    self.computeOutFileNames();</span>
<span class="line" id="L1905"></span>
<span class="line" id="L1906">    <span class="tok-comment">// Update generated files</span>
</span>
<span class="line" id="L1907">    <span class="tok-kw">if</span> (self.output_dir != <span class="tok-null">null</span>) {</span>
<span class="line" id="L1908">        self.output_path_source.path = builder.pathJoin(</span>
<span class="line" id="L1909">            &amp;.{ self.output_dir.?, self.out_filename },</span>
<span class="line" id="L1910">        );</span>
<span class="line" id="L1911"></span>
<span class="line" id="L1912">        <span class="tok-kw">if</span> (self.emit_h) {</span>
<span class="line" id="L1913">            self.output_h_path_source.path = builder.pathJoin(</span>
<span class="line" id="L1914">                &amp;.{ self.output_dir.?, self.out_h_filename },</span>
<span class="line" id="L1915">            );</span>
<span class="line" id="L1916">        }</span>
<span class="line" id="L1917"></span>
<span class="line" id="L1918">        <span class="tok-kw">if</span> (self.target.isWindows() <span class="tok-kw">or</span> self.target.isUefi()) {</span>
<span class="line" id="L1919">            self.output_pdb_path_source.path = builder.pathJoin(</span>
<span class="line" id="L1920">                &amp;.{ self.output_dir.?, self.out_pdb_filename },</span>
<span class="line" id="L1921">            );</span>
<span class="line" id="L1922">        }</span>
<span class="line" id="L1923">    }</span>
<span class="line" id="L1924"></span>
<span class="line" id="L1925">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic <span class="tok-kw">and</span> self.version != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.target.wantSharedLibSymLinks()) {</span>
<span class="line" id="L1926">        <span class="tok-kw">try</span> doAtomicSymLinks(builder.allocator, self.getOutputSource().getPath(builder), self.major_only_filename.?, self.name_only_filename.?);</span>
<span class="line" id="L1927">    }</span>
<span class="line" id="L1928">}</span>
<span class="line" id="L1929"></span>
<span class="line" id="L1930"><span class="tok-kw">fn</span> <span class="tok-fn">isLibCLibrary</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L1931">    <span class="tok-kw">const</span> libc_libraries = [_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;c&quot;</span>, <span class="tok-str">&quot;m&quot;</span>, <span class="tok-str">&quot;dl&quot;</span>, <span class="tok-str">&quot;rt&quot;</span>, <span class="tok-str">&quot;pthread&quot;</span> };</span>
<span class="line" id="L1932">    <span class="tok-kw">for</span> (libc_libraries) |libc_lib_name| {</span>
<span class="line" id="L1933">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, name, libc_lib_name))</span>
<span class="line" id="L1934">            <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1935">    }</span>
<span class="line" id="L1936">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L1937">}</span>
<span class="line" id="L1938"></span>
<span class="line" id="L1939"><span class="tok-kw">fn</span> <span class="tok-fn">isLibCppLibrary</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L1940">    <span class="tok-kw">const</span> libcpp_libraries = [_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;c++&quot;</span>, <span class="tok-str">&quot;stdc++&quot;</span> };</span>
<span class="line" id="L1941">    <span class="tok-kw">for</span> (libcpp_libraries) |libcpp_lib_name| {</span>
<span class="line" id="L1942">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, name, libcpp_lib_name))</span>
<span class="line" id="L1943">            <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L1944">    }</span>
<span class="line" id="L1945">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L1946">}</span>
<span class="line" id="L1947"></span>
<span class="line" id="L1948"><span class="tok-comment">/// Returned slice must be freed by the caller.</span></span>
<span class="line" id="L1949"><span class="tok-kw">fn</span> <span class="tok-fn">findVcpkgRoot</span>(allocator: Allocator) !?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L1950">    <span class="tok-kw">const</span> appdata_path = <span class="tok-kw">try</span> fs.getAppDataDir(allocator, <span class="tok-str">&quot;vcpkg&quot;</span>);</span>
<span class="line" id="L1951">    <span class="tok-kw">defer</span> allocator.free(appdata_path);</span>
<span class="line" id="L1952"></span>
<span class="line" id="L1953">    <span class="tok-kw">const</span> path_file = <span class="tok-kw">try</span> fs.path.join(allocator, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ appdata_path, <span class="tok-str">&quot;vcpkg.path.txt&quot;</span> });</span>
<span class="line" id="L1954">    <span class="tok-kw">defer</span> allocator.free(path_file);</span>
<span class="line" id="L1955"></span>
<span class="line" id="L1956">    <span class="tok-kw">const</span> file = fs.cwd().openFile(path_file, .{}) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L1957">    <span class="tok-kw">defer</span> file.close();</span>
<span class="line" id="L1958"></span>
<span class="line" id="L1959">    <span class="tok-kw">const</span> size = <span class="tok-builtin">@intCast</span>(<span class="tok-type">usize</span>, <span class="tok-kw">try</span> file.getEndPos());</span>
<span class="line" id="L1960">    <span class="tok-kw">const</span> vcpkg_path = <span class="tok-kw">try</span> allocator.alloc(<span class="tok-type">u8</span>, size);</span>
<span class="line" id="L1961">    <span class="tok-kw">const</span> size_read = <span class="tok-kw">try</span> file.read(vcpkg_path);</span>
<span class="line" id="L1962">    std.debug.assert(size == size_read);</span>
<span class="line" id="L1963"></span>
<span class="line" id="L1964">    <span class="tok-kw">return</span> vcpkg_path;</span>
<span class="line" id="L1965">}</span>
<span class="line" id="L1966"></span>
<span class="line" id="L1967"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">doAtomicSymLinks</span>(allocator: Allocator, output_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, filename_major_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, filename_name_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1968">    <span class="tok-kw">const</span> out_dir = fs.path.dirname(output_path) <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>;</span>
<span class="line" id="L1969">    <span class="tok-kw">const</span> out_basename = fs.path.basename(output_path);</span>
<span class="line" id="L1970">    <span class="tok-comment">// sym link for libfoo.so.1 to libfoo.so.1.2.3</span>
</span>
<span class="line" id="L1971">    <span class="tok-kw">const</span> major_only_path = fs.path.join(</span>
<span class="line" id="L1972">        allocator,</span>
<span class="line" id="L1973">        &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ out_dir, filename_major_only },</span>
<span class="line" id="L1974">    ) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1975">    fs.atomicSymLink(allocator, out_basename, major_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L1976">        log.err(<span class="tok-str">&quot;Unable to symlink {s} -&gt; {s}&quot;</span>, .{ major_only_path, out_basename });</span>
<span class="line" id="L1977">        <span class="tok-kw">return</span> err;</span>
<span class="line" id="L1978">    };</span>
<span class="line" id="L1979">    <span class="tok-comment">// sym link for libfoo.so to libfoo.so.1</span>
</span>
<span class="line" id="L1980">    <span class="tok-kw">const</span> name_only_path = fs.path.join(</span>
<span class="line" id="L1981">        allocator,</span>
<span class="line" id="L1982">        &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ out_dir, filename_name_only },</span>
<span class="line" id="L1983">    ) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1984">    fs.atomicSymLink(allocator, filename_major_only, name_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L1985">        log.err(<span class="tok-str">&quot;Unable to symlink {s} -&gt; {s}&quot;</span>, .{ name_only_path, filename_major_only });</span>
<span class="line" id="L1986">        <span class="tok-kw">return</span> err;</span>
<span class="line" id="L1987">    };</span>
<span class="line" id="L1988">}</span>
<span class="line" id="L1989"></span>
<span class="line" id="L1990"><span class="tok-kw">fn</span> <span class="tok-fn">execPkgConfigList</span>(self: *Builder, out_code: *<span class="tok-type">u8</span>) (PkgConfigError || ExecError)![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L1991">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">try</span> self.execAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;pkg-config&quot;</span>, <span class="tok-str">&quot;--list-all&quot;</span> }, out_code, .Ignore);</span>
<span class="line" id="L1992">    <span class="tok-kw">var</span> list = ArrayList(PkgConfigPkg).init(self.allocator);</span>
<span class="line" id="L1993">    <span class="tok-kw">errdefer</span> list.deinit();</span>
<span class="line" id="L1994">    <span class="tok-kw">var</span> line_it = mem.tokenize(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot;\r\n&quot;</span>);</span>
<span class="line" id="L1995">    <span class="tok-kw">while</span> (line_it.next()) |line| {</span>
<span class="line" id="L1996">        <span class="tok-kw">if</span> (mem.trim(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>).len == <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1997">        <span class="tok-kw">var</span> tok_it = mem.tokenize(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>);</span>
<span class="line" id="L1998">        <span class="tok-kw">try</span> list.append(PkgConfigPkg{</span>
<span class="line" id="L1999">            .name = tok_it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L2000">            .desc = tok_it.rest(),</span>
<span class="line" id="L2001">        });</span>
<span class="line" id="L2002">    }</span>
<span class="line" id="L2003">    <span class="tok-kw">return</span> list.toOwnedSlice();</span>
<span class="line" id="L2004">}</span>
<span class="line" id="L2005"></span>
<span class="line" id="L2006"><span class="tok-kw">fn</span> <span class="tok-fn">getPkgConfigList</span>(self: *Builder) ![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L2007">    <span class="tok-kw">if</span> (self.pkg_config_pkg_list) |res| {</span>
<span class="line" id="L2008">        <span class="tok-kw">return</span> res;</span>
<span class="line" id="L2009">    }</span>
<span class="line" id="L2010">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2011">    <span class="tok-kw">if</span> (execPkgConfigList(self, &amp;code)) |list| {</span>
<span class="line" id="L2012">        self.pkg_config_pkg_list = list;</span>
<span class="line" id="L2013">        <span class="tok-kw">return</span> list;</span>
<span class="line" id="L2014">    } <span class="tok-kw">else</span> |err| {</span>
<span class="line" id="L2015">        <span class="tok-kw">const</span> result = <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2016">            <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L2017">            <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L2018">            <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L2019">            <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L2020">            <span class="tok-kw">error</span>.InvalidName =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L2021">            <span class="tok-kw">error</span>.PkgConfigInvalidOutput =&gt; <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L2022">            <span class="tok-kw">error</span>.ChildExecFailed =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L2023">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L2024">        };</span>
<span class="line" id="L2025">        self.pkg_config_pkg_list = result;</span>
<span class="line" id="L2026">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L2027">    }</span>
<span class="line" id="L2028">}</span>
<span class="line" id="L2029"></span>
<span class="line" id="L2030"><span class="tok-kw">test</span> <span class="tok-str">&quot;addPackage&quot;</span> {</span>
<span class="line" id="L2031">    <span class="tok-kw">if</span> (builtin.os.tag == .wasi) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SkipZigTest;</span>
<span class="line" id="L2032"></span>
<span class="line" id="L2033">    <span class="tok-kw">var</span> arena = std.heap.ArenaAllocator.init(std.testing.allocator);</span>
<span class="line" id="L2034">    <span class="tok-kw">defer</span> arena.deinit();</span>
<span class="line" id="L2035"></span>
<span class="line" id="L2036">    <span class="tok-kw">var</span> builder = <span class="tok-kw">try</span> Builder.create(</span>
<span class="line" id="L2037">        arena.allocator(),</span>
<span class="line" id="L2038">        <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L2039">        <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L2040">        <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L2041">        <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L2042">    );</span>
<span class="line" id="L2043">    <span class="tok-kw">defer</span> builder.destroy();</span>
<span class="line" id="L2044"></span>
<span class="line" id="L2045">    <span class="tok-kw">const</span> pkg_dep = Pkg{</span>
<span class="line" id="L2046">        .name = <span class="tok-str">&quot;pkg_dep&quot;</span>,</span>
<span class="line" id="L2047">        .source = .{ .path = <span class="tok-str">&quot;/not/a/pkg_dep.zig&quot;</span> },</span>
<span class="line" id="L2048">    };</span>
<span class="line" id="L2049">    <span class="tok-kw">const</span> pkg_top = Pkg{</span>
<span class="line" id="L2050">        .name = <span class="tok-str">&quot;pkg_dep&quot;</span>,</span>
<span class="line" id="L2051">        .source = .{ .path = <span class="tok-str">&quot;/not/a/pkg_top.zig&quot;</span> },</span>
<span class="line" id="L2052">        .dependencies = &amp;[_]Pkg{pkg_dep},</span>
<span class="line" id="L2053">    };</span>
<span class="line" id="L2054"></span>
<span class="line" id="L2055">    <span class="tok-kw">var</span> exe = builder.addExecutable(<span class="tok-str">&quot;not_an_executable&quot;</span>, <span class="tok-str">&quot;/not/an/executable.zig&quot;</span>);</span>
<span class="line" id="L2056">    exe.addPackage(pkg_top);</span>
<span class="line" id="L2057"></span>
<span class="line" id="L2058">    <span class="tok-kw">try</span> std.testing.expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>), exe.packages.items.len);</span>
<span class="line" id="L2059"></span>
<span class="line" id="L2060">    <span class="tok-kw">const</span> dupe = exe.packages.items[<span class="tok-number">0</span>];</span>
<span class="line" id="L2061">    <span class="tok-kw">try</span> std.testing.expectEqualStrings(pkg_top.name, dupe.name);</span>
<span class="line" id="L2062">}</span>
<span class="line" id="L2063"></span>
</code></pre></body>
</html>