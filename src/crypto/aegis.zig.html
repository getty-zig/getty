<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>crypto/aegis.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L3"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> AesBlock = std.crypto.core.aes.Block;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> AuthenticationError = std.crypto.errors.AuthenticationError;</span>
<span class="line" id="L6"></span>
<span class="line" id="L7"><span class="tok-kw">const</span> State128L = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L8">    blocks: [<span class="tok-number">8</span>]AesBlock,</span>
<span class="line" id="L9"></span>
<span class="line" id="L10">    <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(key: [<span class="tok-number">16</span>]<span class="tok-type">u8</span>, nonce: [<span class="tok-number">16</span>]<span class="tok-type">u8</span>) State128L {</span>
<span class="line" id="L11">        <span class="tok-kw">const</span> c1 = AesBlock.fromBytes(&amp;[<span class="tok-number">16</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0xdb</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0x55</span>, <span class="tok-number">0x6d</span>, <span class="tok-number">0xc2</span>, <span class="tok-number">0x2f</span>, <span class="tok-number">0xf1</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0xb5</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0xdd</span> });</span>
<span class="line" id="L12">        <span class="tok-kw">const</span> c2 = AesBlock.fromBytes(&amp;[<span class="tok-number">16</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x0</span>, <span class="tok-number">0x1</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x22</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0x90</span>, <span class="tok-number">0xe9</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x62</span> });</span>
<span class="line" id="L13">        <span class="tok-kw">const</span> key_block = AesBlock.fromBytes(&amp;key);</span>
<span class="line" id="L14">        <span class="tok-kw">const</span> nonce_block = AesBlock.fromBytes(&amp;nonce);</span>
<span class="line" id="L15">        <span class="tok-kw">const</span> blocks = [<span class="tok-number">8</span>]AesBlock{</span>
<span class="line" id="L16">            key_block.xorBlocks(nonce_block),</span>
<span class="line" id="L17">            c1,</span>
<span class="line" id="L18">            c2,</span>
<span class="line" id="L19">            c1,</span>
<span class="line" id="L20">            key_block.xorBlocks(nonce_block),</span>
<span class="line" id="L21">            key_block.xorBlocks(c2),</span>
<span class="line" id="L22">            key_block.xorBlocks(c1),</span>
<span class="line" id="L23">            key_block.xorBlocks(c2),</span>
<span class="line" id="L24">        };</span>
<span class="line" id="L25">        <span class="tok-kw">var</span> state = State128L{ .blocks = blocks };</span>
<span class="line" id="L26">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L27">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">10</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L28">            state.update(nonce_block, key_block);</span>
<span class="line" id="L29">        }</span>
<span class="line" id="L30">        <span class="tok-kw">return</span> state;</span>
<span class="line" id="L31">    }</span>
<span class="line" id="L32"></span>
<span class="line" id="L33">    <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">update</span>(state: *State128L, d1: AesBlock, d2: AesBlock) <span class="tok-type">void</span> {</span>
<span class="line" id="L34">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L35">        <span class="tok-kw">const</span> tmp = blocks[<span class="tok-number">7</span>];</span>
<span class="line" id="L36">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">7</span>;</span>
<span class="line" id="L37">        <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &gt; <span class="tok-number">0</span>) : (i -= <span class="tok-number">1</span>) {</span>
<span class="line" id="L38">            blocks[i] = blocks[i - <span class="tok-number">1</span>].encrypt(blocks[i]);</span>
<span class="line" id="L39">        }</span>
<span class="line" id="L40">        blocks[<span class="tok-number">0</span>] = tmp.encrypt(blocks[<span class="tok-number">0</span>]);</span>
<span class="line" id="L41">        blocks[<span class="tok-number">0</span>] = blocks[<span class="tok-number">0</span>].xorBlocks(d1);</span>
<span class="line" id="L42">        blocks[<span class="tok-number">4</span>] = blocks[<span class="tok-number">4</span>].xorBlocks(d2);</span>
<span class="line" id="L43">    }</span>
<span class="line" id="L44"></span>
<span class="line" id="L45">    <span class="tok-kw">fn</span> <span class="tok-fn">absorb</span>(state: *State128L, src: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L46">        <span class="tok-kw">const</span> msg0 = AesBlock.fromBytes(src[<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L47">        <span class="tok-kw">const</span> msg1 = AesBlock.fromBytes(src[<span class="tok-number">16</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L48">        state.update(msg0, msg1);</span>
<span class="line" id="L49">    }</span>
<span class="line" id="L50"></span>
<span class="line" id="L51">    <span class="tok-kw">fn</span> <span class="tok-fn">enc</span>(state: *State128L, dst: *[<span class="tok-number">32</span>]<span class="tok-type">u8</span>, src: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L52">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L53">        <span class="tok-kw">const</span> msg0 = AesBlock.fromBytes(src[<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L54">        <span class="tok-kw">const</span> msg1 = AesBlock.fromBytes(src[<span class="tok-number">16</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L55">        <span class="tok-kw">var</span> tmp0 = msg0.xorBlocks(blocks[<span class="tok-number">6</span>]).xorBlocks(blocks[<span class="tok-number">1</span>]);</span>
<span class="line" id="L56">        <span class="tok-kw">var</span> tmp1 = msg1.xorBlocks(blocks[<span class="tok-number">2</span>]).xorBlocks(blocks[<span class="tok-number">5</span>]);</span>
<span class="line" id="L57">        tmp0 = tmp0.xorBlocks(blocks[<span class="tok-number">2</span>].andBlocks(blocks[<span class="tok-number">3</span>]));</span>
<span class="line" id="L58">        tmp1 = tmp1.xorBlocks(blocks[<span class="tok-number">6</span>].andBlocks(blocks[<span class="tok-number">7</span>]));</span>
<span class="line" id="L59">        dst[<span class="tok-number">0</span>..<span class="tok-number">16</span>].* = tmp0.toBytes();</span>
<span class="line" id="L60">        dst[<span class="tok-number">16</span>..<span class="tok-number">32</span>].* = tmp1.toBytes();</span>
<span class="line" id="L61">        state.update(msg0, msg1);</span>
<span class="line" id="L62">    }</span>
<span class="line" id="L63"></span>
<span class="line" id="L64">    <span class="tok-kw">fn</span> <span class="tok-fn">dec</span>(state: *State128L, dst: *[<span class="tok-number">32</span>]<span class="tok-type">u8</span>, src: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L65">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L66">        <span class="tok-kw">var</span> msg0 = AesBlock.fromBytes(src[<span class="tok-number">0</span>..<span class="tok-number">16</span>]).xorBlocks(blocks[<span class="tok-number">6</span>]).xorBlocks(blocks[<span class="tok-number">1</span>]);</span>
<span class="line" id="L67">        <span class="tok-kw">var</span> msg1 = AesBlock.fromBytes(src[<span class="tok-number">16</span>..<span class="tok-number">32</span>]).xorBlocks(blocks[<span class="tok-number">2</span>]).xorBlocks(blocks[<span class="tok-number">5</span>]);</span>
<span class="line" id="L68">        msg0 = msg0.xorBlocks(blocks[<span class="tok-number">2</span>].andBlocks(blocks[<span class="tok-number">3</span>]));</span>
<span class="line" id="L69">        msg1 = msg1.xorBlocks(blocks[<span class="tok-number">6</span>].andBlocks(blocks[<span class="tok-number">7</span>]));</span>
<span class="line" id="L70">        dst[<span class="tok-number">0</span>..<span class="tok-number">16</span>].* = msg0.toBytes();</span>
<span class="line" id="L71">        dst[<span class="tok-number">16</span>..<span class="tok-number">32</span>].* = msg1.toBytes();</span>
<span class="line" id="L72">        state.update(msg0, msg1);</span>
<span class="line" id="L73">    }</span>
<span class="line" id="L74"></span>
<span class="line" id="L75">    <span class="tok-kw">fn</span> <span class="tok-fn">mac</span>(state: *State128L, adlen: <span class="tok-type">usize</span>, mlen: <span class="tok-type">usize</span>) [<span class="tok-number">16</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L76">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L77">        <span class="tok-kw">var</span> sizes: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L78">        mem.writeIntLittle(<span class="tok-type">u64</span>, sizes[<span class="tok-number">0</span>..<span class="tok-number">8</span>], adlen * <span class="tok-number">8</span>);</span>
<span class="line" id="L79">        mem.writeIntLittle(<span class="tok-type">u64</span>, sizes[<span class="tok-number">8</span>..<span class="tok-number">16</span>], mlen * <span class="tok-number">8</span>);</span>
<span class="line" id="L80">        <span class="tok-kw">const</span> tmp = AesBlock.fromBytes(&amp;sizes).xorBlocks(blocks[<span class="tok-number">2</span>]);</span>
<span class="line" id="L81">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L82">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">7</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L83">            state.update(tmp, tmp);</span>
<span class="line" id="L84">        }</span>
<span class="line" id="L85">        <span class="tok-kw">return</span> blocks[<span class="tok-number">0</span>].xorBlocks(blocks[<span class="tok-number">1</span>]).xorBlocks(blocks[<span class="tok-number">2</span>]).xorBlocks(blocks[<span class="tok-number">3</span>]).xorBlocks(blocks[<span class="tok-number">4</span>])</span>
<span class="line" id="L86">            .xorBlocks(blocks[<span class="tok-number">5</span>]).xorBlocks(blocks[<span class="tok-number">6</span>]).toBytes();</span>
<span class="line" id="L87">    }</span>
<span class="line" id="L88">};</span>
<span class="line" id="L89"></span>
<span class="line" id="L90"><span class="tok-comment">/// AEGIS is a very fast authenticated encryption system built on top of the core AES function.</span></span>
<span class="line" id="L91"><span class="tok-comment">///</span></span>
<span class="line" id="L92"><span class="tok-comment">/// The 128L variant of AEGIS has a 128 bit key, a 128 bit nonce, and processes 256 bit message blocks.</span></span>
<span class="line" id="L93"><span class="tok-comment">/// It was designed to fully exploit the parallelism and built-in AES support of recent Intel and ARM CPUs.</span></span>
<span class="line" id="L94"><span class="tok-comment">///</span></span>
<span class="line" id="L95"><span class="tok-comment">/// https://datatracker.ietf.org/doc/draft-irtf-cfrg-aegis-aead/</span></span>
<span class="line" id="L96"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Aegis128L = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L97">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> tag_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L98">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L99">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L100">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L101"></span>
<span class="line" id="L102">    <span class="tok-kw">const</span> State = State128L;</span>
<span class="line" id="L103"></span>
<span class="line" id="L104">    <span class="tok-comment">/// c: ciphertext: output buffer should be of size m.len</span></span>
<span class="line" id="L105">    <span class="tok-comment">/// tag: authentication tag: output MAC</span></span>
<span class="line" id="L106">    <span class="tok-comment">/// m: message</span></span>
<span class="line" id="L107">    <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L108">    <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L109">    <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L110">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(c: []<span class="tok-type">u8</span>, tag: *[tag_length]<span class="tok-type">u8</span>, m: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, key: [key_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L111">        assert(c.len == m.len);</span>
<span class="line" id="L112">        <span class="tok-kw">var</span> state = State128L.init(key, npub);</span>
<span class="line" id="L113">        <span class="tok-kw">var</span> src: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L114">        <span class="tok-kw">var</span> dst: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L115">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L116">        <span class="tok-kw">while</span> (i + <span class="tok-number">32</span> &lt;= ad.len) : (i += <span class="tok-number">32</span>) {</span>
<span class="line" id="L117">            state.absorb(ad[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L118">        }</span>
<span class="line" id="L119">        <span class="tok-kw">if</span> (ad.len % <span class="tok-number">32</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L120">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L121">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. ad.len % <span class="tok-number">32</span>], ad[i .. i + ad.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L122">            state.absorb(&amp;src);</span>
<span class="line" id="L123">        }</span>
<span class="line" id="L124">        i = <span class="tok-number">0</span>;</span>
<span class="line" id="L125">        <span class="tok-kw">while</span> (i + <span class="tok-number">32</span> &lt;= m.len) : (i += <span class="tok-number">32</span>) {</span>
<span class="line" id="L126">            state.enc(c[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>], m[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L127">        }</span>
<span class="line" id="L128">        <span class="tok-kw">if</span> (m.len % <span class="tok-number">32</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L129">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L130">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. m.len % <span class="tok-number">32</span>], m[i .. i + m.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L131">            state.enc(&amp;dst, &amp;src);</span>
<span class="line" id="L132">            mem.copy(<span class="tok-type">u8</span>, c[i .. i + m.len % <span class="tok-number">32</span>], dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L133">        }</span>
<span class="line" id="L134">        tag.* = state.mac(ad.len, m.len);</span>
<span class="line" id="L135">    }</span>
<span class="line" id="L136"></span>
<span class="line" id="L137">    <span class="tok-comment">/// m: message: output buffer should be of size c.len</span></span>
<span class="line" id="L138">    <span class="tok-comment">/// c: ciphertext</span></span>
<span class="line" id="L139">    <span class="tok-comment">/// tag: authentication tag</span></span>
<span class="line" id="L140">    <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L141">    <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L142">    <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L143">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decrypt</span>(m: []<span class="tok-type">u8</span>, c: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, tag: [tag_length]<span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, key: [key_length]<span class="tok-type">u8</span>) AuthenticationError!<span class="tok-type">void</span> {</span>
<span class="line" id="L144">        assert(c.len == m.len);</span>
<span class="line" id="L145">        <span class="tok-kw">var</span> state = State128L.init(key, npub);</span>
<span class="line" id="L146">        <span class="tok-kw">var</span> src: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L147">        <span class="tok-kw">var</span> dst: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L148">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L149">        <span class="tok-kw">while</span> (i + <span class="tok-number">32</span> &lt;= ad.len) : (i += <span class="tok-number">32</span>) {</span>
<span class="line" id="L150">            state.absorb(ad[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L151">        }</span>
<span class="line" id="L152">        <span class="tok-kw">if</span> (ad.len % <span class="tok-number">32</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L153">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L154">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. ad.len % <span class="tok-number">32</span>], ad[i .. i + ad.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L155">            state.absorb(&amp;src);</span>
<span class="line" id="L156">        }</span>
<span class="line" id="L157">        i = <span class="tok-number">0</span>;</span>
<span class="line" id="L158">        <span class="tok-kw">while</span> (i + <span class="tok-number">32</span> &lt;= m.len) : (i += <span class="tok-number">32</span>) {</span>
<span class="line" id="L159">            state.dec(m[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>], c[i..][<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L160">        }</span>
<span class="line" id="L161">        <span class="tok-kw">if</span> (m.len % <span class="tok-number">32</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L162">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L163">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. m.len % <span class="tok-number">32</span>], c[i .. i + m.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L164">            state.dec(&amp;dst, &amp;src);</span>
<span class="line" id="L165">            mem.copy(<span class="tok-type">u8</span>, m[i .. i + m.len % <span class="tok-number">32</span>], dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">32</span>]);</span>
<span class="line" id="L166">            mem.set(<span class="tok-type">u8</span>, dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">32</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L167">            <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L168">            blocks[<span class="tok-number">0</span>] = blocks[<span class="tok-number">0</span>].xorBlocks(AesBlock.fromBytes(dst[<span class="tok-number">0</span>..<span class="tok-number">16</span>]));</span>
<span class="line" id="L169">            blocks[<span class="tok-number">4</span>] = blocks[<span class="tok-number">4</span>].xorBlocks(AesBlock.fromBytes(dst[<span class="tok-number">16</span>..<span class="tok-number">32</span>]));</span>
<span class="line" id="L170">        }</span>
<span class="line" id="L171">        <span class="tok-kw">const</span> computed_tag = state.mac(ad.len, m.len);</span>
<span class="line" id="L172">        <span class="tok-kw">var</span> acc: <span class="tok-type">u8</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L173">        <span class="tok-kw">for</span> (computed_tag) |_, j| {</span>
<span class="line" id="L174">            acc |= (computed_tag[j] ^ tag[j]);</span>
<span class="line" id="L175">        }</span>
<span class="line" id="L176">        <span class="tok-kw">if</span> (acc != <span class="tok-number">0</span>) {</span>
<span class="line" id="L177">            mem.set(<span class="tok-type">u8</span>, m, <span class="tok-number">0xaa</span>);</span>
<span class="line" id="L178">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AuthenticationFailed;</span>
<span class="line" id="L179">        }</span>
<span class="line" id="L180">    }</span>
<span class="line" id="L181">};</span>
<span class="line" id="L182"></span>
<span class="line" id="L183"><span class="tok-kw">const</span> State256 = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L184">    blocks: [<span class="tok-number">6</span>]AesBlock,</span>
<span class="line" id="L185"></span>
<span class="line" id="L186">    <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, nonce: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) State256 {</span>
<span class="line" id="L187">        <span class="tok-kw">const</span> c1 = AesBlock.fromBytes(&amp;[<span class="tok-number">16</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0xdb</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0x55</span>, <span class="tok-number">0x6d</span>, <span class="tok-number">0xc2</span>, <span class="tok-number">0x2f</span>, <span class="tok-number">0xf1</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0xb5</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0xdd</span> });</span>
<span class="line" id="L188">        <span class="tok-kw">const</span> c2 = AesBlock.fromBytes(&amp;[<span class="tok-number">16</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x0</span>, <span class="tok-number">0x1</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x22</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0x90</span>, <span class="tok-number">0xe9</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x62</span> });</span>
<span class="line" id="L189">        <span class="tok-kw">const</span> key_block1 = AesBlock.fromBytes(key[<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L190">        <span class="tok-kw">const</span> key_block2 = AesBlock.fromBytes(key[<span class="tok-number">16</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L191">        <span class="tok-kw">const</span> nonce_block1 = AesBlock.fromBytes(nonce[<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L192">        <span class="tok-kw">const</span> nonce_block2 = AesBlock.fromBytes(nonce[<span class="tok-number">16</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L193">        <span class="tok-kw">const</span> kxn1 = key_block1.xorBlocks(nonce_block1);</span>
<span class="line" id="L194">        <span class="tok-kw">const</span> kxn2 = key_block2.xorBlocks(nonce_block2);</span>
<span class="line" id="L195">        <span class="tok-kw">const</span> blocks = [<span class="tok-number">6</span>]AesBlock{</span>
<span class="line" id="L196">            kxn1,</span>
<span class="line" id="L197">            kxn2,</span>
<span class="line" id="L198">            c1,</span>
<span class="line" id="L199">            c2,</span>
<span class="line" id="L200">            key_block1.xorBlocks(c2),</span>
<span class="line" id="L201">            key_block2.xorBlocks(c1),</span>
<span class="line" id="L202">        };</span>
<span class="line" id="L203">        <span class="tok-kw">var</span> state = State256{ .blocks = blocks };</span>
<span class="line" id="L204">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L205">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">4</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L206">            state.update(key_block1);</span>
<span class="line" id="L207">            state.update(key_block2);</span>
<span class="line" id="L208">            state.update(kxn1);</span>
<span class="line" id="L209">            state.update(kxn2);</span>
<span class="line" id="L210">        }</span>
<span class="line" id="L211">        <span class="tok-kw">return</span> state;</span>
<span class="line" id="L212">    }</span>
<span class="line" id="L213"></span>
<span class="line" id="L214">    <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">update</span>(state: *State256, d: AesBlock) <span class="tok-type">void</span> {</span>
<span class="line" id="L215">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L216">        <span class="tok-kw">const</span> tmp = blocks[<span class="tok-number">5</span>].encrypt(blocks[<span class="tok-number">0</span>]);</span>
<span class="line" id="L217">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">5</span>;</span>
<span class="line" id="L218">        <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &gt; <span class="tok-number">0</span>) : (i -= <span class="tok-number">1</span>) {</span>
<span class="line" id="L219">            blocks[i] = blocks[i - <span class="tok-number">1</span>].encrypt(blocks[i]);</span>
<span class="line" id="L220">        }</span>
<span class="line" id="L221">        blocks[<span class="tok-number">0</span>] = tmp.xorBlocks(d);</span>
<span class="line" id="L222">    }</span>
<span class="line" id="L223"></span>
<span class="line" id="L224">    <span class="tok-kw">fn</span> <span class="tok-fn">absorb</span>(state: *State256, src: *<span class="tok-kw">const</span> [<span class="tok-number">16</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L225">        <span class="tok-kw">const</span> msg = AesBlock.fromBytes(src);</span>
<span class="line" id="L226">        state.update(msg);</span>
<span class="line" id="L227">    }</span>
<span class="line" id="L228"></span>
<span class="line" id="L229">    <span class="tok-kw">fn</span> <span class="tok-fn">enc</span>(state: *State256, dst: *[<span class="tok-number">16</span>]<span class="tok-type">u8</span>, src: *<span class="tok-kw">const</span> [<span class="tok-number">16</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L230">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L231">        <span class="tok-kw">const</span> msg = AesBlock.fromBytes(src);</span>
<span class="line" id="L232">        <span class="tok-kw">var</span> tmp = msg.xorBlocks(blocks[<span class="tok-number">5</span>]).xorBlocks(blocks[<span class="tok-number">4</span>]).xorBlocks(blocks[<span class="tok-number">1</span>]);</span>
<span class="line" id="L233">        tmp = tmp.xorBlocks(blocks[<span class="tok-number">2</span>].andBlocks(blocks[<span class="tok-number">3</span>]));</span>
<span class="line" id="L234">        dst.* = tmp.toBytes();</span>
<span class="line" id="L235">        state.update(msg);</span>
<span class="line" id="L236">    }</span>
<span class="line" id="L237"></span>
<span class="line" id="L238">    <span class="tok-kw">fn</span> <span class="tok-fn">dec</span>(state: *State256, dst: *[<span class="tok-number">16</span>]<span class="tok-type">u8</span>, src: *<span class="tok-kw">const</span> [<span class="tok-number">16</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L239">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L240">        <span class="tok-kw">var</span> msg = AesBlock.fromBytes(src).xorBlocks(blocks[<span class="tok-number">5</span>]).xorBlocks(blocks[<span class="tok-number">4</span>]).xorBlocks(blocks[<span class="tok-number">1</span>]);</span>
<span class="line" id="L241">        msg = msg.xorBlocks(blocks[<span class="tok-number">2</span>].andBlocks(blocks[<span class="tok-number">3</span>]));</span>
<span class="line" id="L242">        dst.* = msg.toBytes();</span>
<span class="line" id="L243">        state.update(msg);</span>
<span class="line" id="L244">    }</span>
<span class="line" id="L245"></span>
<span class="line" id="L246">    <span class="tok-kw">fn</span> <span class="tok-fn">mac</span>(state: *State256, adlen: <span class="tok-type">usize</span>, mlen: <span class="tok-type">usize</span>) [<span class="tok-number">16</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L247">        <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L248">        <span class="tok-kw">var</span> sizes: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L249">        mem.writeIntLittle(<span class="tok-type">u64</span>, sizes[<span class="tok-number">0</span>..<span class="tok-number">8</span>], adlen * <span class="tok-number">8</span>);</span>
<span class="line" id="L250">        mem.writeIntLittle(<span class="tok-type">u64</span>, sizes[<span class="tok-number">8</span>..<span class="tok-number">16</span>], mlen * <span class="tok-number">8</span>);</span>
<span class="line" id="L251">        <span class="tok-kw">const</span> tmp = AesBlock.fromBytes(&amp;sizes).xorBlocks(blocks[<span class="tok-number">3</span>]);</span>
<span class="line" id="L252">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L253">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">7</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L254">            state.update(tmp);</span>
<span class="line" id="L255">        }</span>
<span class="line" id="L256">        <span class="tok-kw">return</span> blocks[<span class="tok-number">0</span>].xorBlocks(blocks[<span class="tok-number">1</span>]).xorBlocks(blocks[<span class="tok-number">2</span>]).xorBlocks(blocks[<span class="tok-number">3</span>]).xorBlocks(blocks[<span class="tok-number">4</span>])</span>
<span class="line" id="L257">            .xorBlocks(blocks[<span class="tok-number">5</span>]).toBytes();</span>
<span class="line" id="L258">    }</span>
<span class="line" id="L259">};</span>
<span class="line" id="L260"></span>
<span class="line" id="L261"><span class="tok-comment">/// AEGIS is a very fast authenticated encryption system built on top of the core AES function.</span></span>
<span class="line" id="L262"><span class="tok-comment">///</span></span>
<span class="line" id="L263"><span class="tok-comment">/// The 256 bit variant of AEGIS has a 256 bit key, a 256 bit nonce, and processes 128 bit message blocks.</span></span>
<span class="line" id="L264"><span class="tok-comment">///</span></span>
<span class="line" id="L265"><span class="tok-comment">/// https://datatracker.ietf.org/doc/draft-irtf-cfrg-aegis-aead/</span></span>
<span class="line" id="L266"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Aegis256 = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L267">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> tag_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L268">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L269">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L270">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L271"></span>
<span class="line" id="L272">    <span class="tok-kw">const</span> State = State256;</span>
<span class="line" id="L273"></span>
<span class="line" id="L274">    <span class="tok-comment">/// c: ciphertext: output buffer should be of size m.len</span></span>
<span class="line" id="L275">    <span class="tok-comment">/// tag: authentication tag: output MAC</span></span>
<span class="line" id="L276">    <span class="tok-comment">/// m: message</span></span>
<span class="line" id="L277">    <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L278">    <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L279">    <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L280">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(c: []<span class="tok-type">u8</span>, tag: *[tag_length]<span class="tok-type">u8</span>, m: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, key: [key_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L281">        assert(c.len == m.len);</span>
<span class="line" id="L282">        <span class="tok-kw">var</span> state = State256.init(key, npub);</span>
<span class="line" id="L283">        <span class="tok-kw">var</span> src: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L284">        <span class="tok-kw">var</span> dst: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L285">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L286">        <span class="tok-kw">while</span> (i + <span class="tok-number">16</span> &lt;= ad.len) : (i += <span class="tok-number">16</span>) {</span>
<span class="line" id="L287">            state.enc(&amp;dst, ad[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L288">        }</span>
<span class="line" id="L289">        <span class="tok-kw">if</span> (ad.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L290">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L291">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. ad.len % <span class="tok-number">16</span>], ad[i .. i + ad.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L292">            state.enc(&amp;dst, &amp;src);</span>
<span class="line" id="L293">        }</span>
<span class="line" id="L294">        i = <span class="tok-number">0</span>;</span>
<span class="line" id="L295">        <span class="tok-kw">while</span> (i + <span class="tok-number">16</span> &lt;= m.len) : (i += <span class="tok-number">16</span>) {</span>
<span class="line" id="L296">            state.enc(c[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>], m[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L297">        }</span>
<span class="line" id="L298">        <span class="tok-kw">if</span> (m.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L299">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L300">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. m.len % <span class="tok-number">16</span>], m[i .. i + m.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L301">            state.enc(&amp;dst, &amp;src);</span>
<span class="line" id="L302">            mem.copy(<span class="tok-type">u8</span>, c[i .. i + m.len % <span class="tok-number">16</span>], dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L303">        }</span>
<span class="line" id="L304">        tag.* = state.mac(ad.len, m.len);</span>
<span class="line" id="L305">    }</span>
<span class="line" id="L306"></span>
<span class="line" id="L307">    <span class="tok-comment">/// m: message: output buffer should be of size c.len</span></span>
<span class="line" id="L308">    <span class="tok-comment">/// c: ciphertext</span></span>
<span class="line" id="L309">    <span class="tok-comment">/// tag: authentication tag</span></span>
<span class="line" id="L310">    <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L311">    <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L312">    <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L313">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decrypt</span>(m: []<span class="tok-type">u8</span>, c: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, tag: [tag_length]<span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, key: [key_length]<span class="tok-type">u8</span>) AuthenticationError!<span class="tok-type">void</span> {</span>
<span class="line" id="L314">        assert(c.len == m.len);</span>
<span class="line" id="L315">        <span class="tok-kw">var</span> state = State256.init(key, npub);</span>
<span class="line" id="L316">        <span class="tok-kw">var</span> src: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L317">        <span class="tok-kw">var</span> dst: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> <span class="tok-kw">align</span>(<span class="tok-number">16</span>) = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L318">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L319">        <span class="tok-kw">while</span> (i + <span class="tok-number">16</span> &lt;= ad.len) : (i += <span class="tok-number">16</span>) {</span>
<span class="line" id="L320">            state.enc(&amp;dst, ad[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L321">        }</span>
<span class="line" id="L322">        <span class="tok-kw">if</span> (ad.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L323">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L324">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. ad.len % <span class="tok-number">16</span>], ad[i .. i + ad.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L325">            state.enc(&amp;dst, &amp;src);</span>
<span class="line" id="L326">        }</span>
<span class="line" id="L327">        i = <span class="tok-number">0</span>;</span>
<span class="line" id="L328">        <span class="tok-kw">while</span> (i + <span class="tok-number">16</span> &lt;= m.len) : (i += <span class="tok-number">16</span>) {</span>
<span class="line" id="L329">            state.dec(m[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>], c[i..][<span class="tok-number">0</span>..<span class="tok-number">16</span>]);</span>
<span class="line" id="L330">        }</span>
<span class="line" id="L331">        <span class="tok-kw">if</span> (m.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L332">            mem.set(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span>..], <span class="tok-number">0</span>);</span>
<span class="line" id="L333">            mem.copy(<span class="tok-type">u8</span>, src[<span class="tok-number">0</span> .. m.len % <span class="tok-number">16</span>], c[i .. i + m.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L334">            state.dec(&amp;dst, &amp;src);</span>
<span class="line" id="L335">            mem.copy(<span class="tok-type">u8</span>, m[i .. i + m.len % <span class="tok-number">16</span>], dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">16</span>]);</span>
<span class="line" id="L336">            mem.set(<span class="tok-type">u8</span>, dst[<span class="tok-number">0</span> .. m.len % <span class="tok-number">16</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L337">            <span class="tok-kw">const</span> blocks = &amp;state.blocks;</span>
<span class="line" id="L338">            blocks[<span class="tok-number">0</span>] = blocks[<span class="tok-number">0</span>].xorBlocks(AesBlock.fromBytes(&amp;dst));</span>
<span class="line" id="L339">        }</span>
<span class="line" id="L340">        <span class="tok-kw">const</span> computed_tag = state.mac(ad.len, m.len);</span>
<span class="line" id="L341">        <span class="tok-kw">var</span> acc: <span class="tok-type">u8</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L342">        <span class="tok-kw">for</span> (computed_tag) |_, j| {</span>
<span class="line" id="L343">            acc |= (computed_tag[j] ^ tag[j]);</span>
<span class="line" id="L344">        }</span>
<span class="line" id="L345">        <span class="tok-kw">if</span> (acc != <span class="tok-number">0</span>) {</span>
<span class="line" id="L346">            mem.set(<span class="tok-type">u8</span>, m, <span class="tok-number">0xaa</span>);</span>
<span class="line" id="L347">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AuthenticationFailed;</span>
<span class="line" id="L348">        }</span>
<span class="line" id="L349">    }</span>
<span class="line" id="L350">};</span>
<span class="line" id="L351"></span>
<span class="line" id="L352"><span class="tok-comment">/// The AEGIS-128L message authentication function outputs 128 bit tags.</span></span>
<span class="line" id="L353"><span class="tok-comment">/// In addition to being extremely fast, its large state, non-linearity</span></span>
<span class="line" id="L354"><span class="tok-comment">/// and non-invertibility provides the following properties:</span></span>
<span class="line" id="L355"><span class="tok-comment">/// - 128 bit security, stronger than GHash/Polyval/Poly1305.</span></span>
<span class="line" id="L356"><span class="tok-comment">/// - Recovering the secret key from the state would require ~2^128 attempts,</span></span>
<span class="line" id="L357"><span class="tok-comment">///   which is infeasible for any practical adversary.</span></span>
<span class="line" id="L358"><span class="tok-comment">/// - It has a large security margin against internal collisions.</span></span>
<span class="line" id="L359"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Aegis128LMac = AegisMac(Aegis128L);</span>
<span class="line" id="L360"></span>
<span class="line" id="L361"><span class="tok-comment">/// The AEGIS-256 message authentication function has a 256-bit key size,</span></span>
<span class="line" id="L362"><span class="tok-comment">/// but outputs 128 bit tags. Unless theoretical multi-target attacks are a</span></span>
<span class="line" id="L363"><span class="tok-comment">/// concern, the AEGIS-128L variant should be preferred.</span></span>
<span class="line" id="L364"><span class="tok-comment">/// AEGIS' large state, non-linearity and non-invertibility provides the</span></span>
<span class="line" id="L365"><span class="tok-comment">/// following properties:</span></span>
<span class="line" id="L366"><span class="tok-comment">/// - 128 bit security, stronger than GHash/Polyval/Poly1305.</span></span>
<span class="line" id="L367"><span class="tok-comment">/// - Recovering the secret key from the state would require ~2^128 attempts,</span></span>
<span class="line" id="L368"><span class="tok-comment">///   which is infeasible for any practical adversary.</span></span>
<span class="line" id="L369"><span class="tok-comment">/// - It has a large security margin against internal collisions.</span></span>
<span class="line" id="L370"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Aegis256Mac = AegisMac(Aegis256);</span>
<span class="line" id="L371"></span>
<span class="line" id="L372"><span class="tok-kw">fn</span> <span class="tok-fn">AegisMac</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L373">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L374">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L375"></span>
<span class="line" id="L376">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> mac_length = T.tag_length;</span>
<span class="line" id="L377">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = T.key_length;</span>
<span class="line" id="L378">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = T.block_length;</span>
<span class="line" id="L379"></span>
<span class="line" id="L380">        state: T.State,</span>
<span class="line" id="L381">        buf: [block_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L382">        off: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L383">        msg_len: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L384"></span>
<span class="line" id="L385">        <span class="tok-comment">/// Initialize a state for the MAC function</span></span>
<span class="line" id="L386">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(key: *<span class="tok-kw">const</span> [key_length]<span class="tok-type">u8</span>) Self {</span>
<span class="line" id="L387">            <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** T.nonce_length;</span>
<span class="line" id="L388">            <span class="tok-kw">return</span> Self{</span>
<span class="line" id="L389">                .state = T.State.init(key.*, nonce),</span>
<span class="line" id="L390">            };</span>
<span class="line" id="L391">        }</span>
<span class="line" id="L392"></span>
<span class="line" id="L393">        <span class="tok-comment">/// Add data to the state</span></span>
<span class="line" id="L394">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">update</span>(self: *Self, b: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L395">            self.msg_len += b.len;</span>
<span class="line" id="L396"></span>
<span class="line" id="L397">            <span class="tok-kw">const</span> len_partial = <span class="tok-builtin">@min</span>(b.len, block_length - self.off);</span>
<span class="line" id="L398">            mem.copy(<span class="tok-type">u8</span>, self.buf[self.off..][<span class="tok-number">0</span>..len_partial], b[<span class="tok-number">0</span>..len_partial]);</span>
<span class="line" id="L399">            self.off += len_partial;</span>
<span class="line" id="L400">            <span class="tok-kw">if</span> (self.off &lt; block_length) {</span>
<span class="line" id="L401">                <span class="tok-kw">return</span>;</span>
<span class="line" id="L402">            }</span>
<span class="line" id="L403">            self.state.absorb(&amp;self.buf);</span>
<span class="line" id="L404"></span>
<span class="line" id="L405">            <span class="tok-kw">var</span> i = len_partial;</span>
<span class="line" id="L406">            self.off = <span class="tok-number">0</span>;</span>
<span class="line" id="L407">            <span class="tok-kw">while</span> (i + block_length &lt;= b.len) : (i += block_length) {</span>
<span class="line" id="L408">                self.state.absorb(b[i..][<span class="tok-number">0</span>..block_length]);</span>
<span class="line" id="L409">            }</span>
<span class="line" id="L410">            <span class="tok-kw">if</span> (i != b.len) {</span>
<span class="line" id="L411">                mem.copy(<span class="tok-type">u8</span>, self.buf[<span class="tok-number">0</span>..], b[i..]);</span>
<span class="line" id="L412">                self.off = b.len - i;</span>
<span class="line" id="L413">            }</span>
<span class="line" id="L414">        }</span>
<span class="line" id="L415"></span>
<span class="line" id="L416">        <span class="tok-comment">/// Return an authentication tag for the current state</span></span>
<span class="line" id="L417">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">final</span>(self: *Self, out: *[mac_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L418">            <span class="tok-kw">if</span> (self.off &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L419">                <span class="tok-kw">var</span> pad = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** block_length;</span>
<span class="line" id="L420">                mem.copy(<span class="tok-type">u8</span>, pad[<span class="tok-number">0</span>..], self.buf[<span class="tok-number">0</span>..self.off]);</span>
<span class="line" id="L421">                self.state.absorb(&amp;pad);</span>
<span class="line" id="L422">            }</span>
<span class="line" id="L423">            out.* = self.state.mac(self.msg_len, <span class="tok-number">0</span>);</span>
<span class="line" id="L424">        }</span>
<span class="line" id="L425"></span>
<span class="line" id="L426">        <span class="tok-comment">/// Return an authentication tag for a message and a key</span></span>
<span class="line" id="L427">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">create</span>(out: *[mac_length]<span class="tok-type">u8</span>, msg: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, key: *<span class="tok-kw">const</span> [key_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L428">            <span class="tok-kw">var</span> ctx = Self.init(key);</span>
<span class="line" id="L429">            ctx.update(msg);</span>
<span class="line" id="L430">            ctx.final(out);</span>
<span class="line" id="L431">        }</span>
<span class="line" id="L432"></span>
<span class="line" id="L433">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Error = <span class="tok-kw">error</span>{};</span>
<span class="line" id="L434">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Writer = std.io.Writer(*Self, Error, write);</span>
<span class="line" id="L435"></span>
<span class="line" id="L436">        <span class="tok-kw">fn</span> <span class="tok-fn">write</span>(self: *Self, bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) Error!<span class="tok-type">usize</span> {</span>
<span class="line" id="L437">            self.update(bytes);</span>
<span class="line" id="L438">            <span class="tok-kw">return</span> bytes.len;</span>
<span class="line" id="L439">        }</span>
<span class="line" id="L440"></span>
<span class="line" id="L441">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">writer</span>(self: *Self) Writer {</span>
<span class="line" id="L442">            <span class="tok-kw">return</span> .{ .context = self };</span>
<span class="line" id="L443">        }</span>
<span class="line" id="L444">    };</span>
<span class="line" id="L445">}</span>
<span class="line" id="L446"></span>
<span class="line" id="L447"><span class="tok-kw">const</span> htest = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;test.zig&quot;</span>);</span>
<span class="line" id="L448"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L449"></span>
<span class="line" id="L450"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis128L test vector 1&quot;</span> {</span>
<span class="line" id="L451">    <span class="tok-kw">const</span> key: [Aegis128L.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x10</span>, <span class="tok-number">0x01</span> } ++ [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">14</span>;</span>
<span class="line" id="L452">    <span class="tok-kw">const</span> nonce: [Aegis128L.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x10</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x02</span> } ++ [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">13</span>;</span>
<span class="line" id="L453">    <span class="tok-kw">const</span> ad = [<span class="tok-number">8</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span> };</span>
<span class="line" id="L454">    <span class="tok-kw">const</span> m = [<span class="tok-number">32</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x0a</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x0e</span>, <span class="tok-number">0x0f</span>, <span class="tok-number">0x10</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x13</span>, <span class="tok-number">0x14</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x1b</span>, <span class="tok-number">0x1c</span>, <span class="tok-number">0x1d</span>, <span class="tok-number">0x1e</span>, <span class="tok-number">0x1f</span> };</span>
<span class="line" id="L455">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L456">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L457">    <span class="tok-kw">var</span> tag: [Aegis128L.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L458"></span>
<span class="line" id="L459">    Aegis128L.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L460">    <span class="tok-kw">try</span> Aegis128L.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L461">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L462"></span>
<span class="line" id="L463">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;79d94593d8c2119d7e8fd9b8fc77845c5c077a05b2528b6ac54b563aed8efe84&quot;</span>, &amp;c);</span>
<span class="line" id="L464">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;cc6f3372f6aa1bb82388d695c3962d9a&quot;</span>, &amp;tag);</span>
<span class="line" id="L465"></span>
<span class="line" id="L466">    c[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L467">    <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, Aegis128L.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key));</span>
<span class="line" id="L468">    c[<span class="tok-number">0</span>] -%= <span class="tok-number">1</span>;</span>
<span class="line" id="L469">    tag[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L470">    <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, Aegis128L.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key));</span>
<span class="line" id="L471">}</span>
<span class="line" id="L472"></span>
<span class="line" id="L473"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis128L test vector 2&quot;</span> {</span>
<span class="line" id="L474">    <span class="tok-kw">const</span> key: [Aegis128L.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L475">    <span class="tok-kw">const</span> nonce: [Aegis128L.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L476">    <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L477">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L478">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L479">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L480">    <span class="tok-kw">var</span> tag: [Aegis128L.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L481"></span>
<span class="line" id="L482">    Aegis128L.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L483">    <span class="tok-kw">try</span> Aegis128L.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L484">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L485"></span>
<span class="line" id="L486">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;41de9000a7b5e40e2d68bb64d99ebb19&quot;</span>, &amp;c);</span>
<span class="line" id="L487">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;f4d997cc9b94227ada4fe4165422b1c8&quot;</span>, &amp;tag);</span>
<span class="line" id="L488">}</span>
<span class="line" id="L489"></span>
<span class="line" id="L490"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis128L test vector 3&quot;</span> {</span>
<span class="line" id="L491">    <span class="tok-kw">const</span> key: [Aegis128L.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L492">    <span class="tok-kw">const</span> nonce: [Aegis128L.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L493">    <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L494">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L495">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L496">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L497">    <span class="tok-kw">var</span> tag: [Aegis128L.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L498"></span>
<span class="line" id="L499">    Aegis128L.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L500">    <span class="tok-kw">try</span> Aegis128L.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L501">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L502"></span>
<span class="line" id="L503">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;83cc600dc4e3e7e62d4055826174f149&quot;</span>, &amp;tag);</span>
<span class="line" id="L504">}</span>
<span class="line" id="L505"></span>
<span class="line" id="L506"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis256 test vector 1&quot;</span> {</span>
<span class="line" id="L507">    <span class="tok-kw">const</span> key: [Aegis256.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x10</span>, <span class="tok-number">0x01</span> } ++ [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">30</span>;</span>
<span class="line" id="L508">    <span class="tok-kw">const</span> nonce: [Aegis256.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x10</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x02</span> } ++ [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">29</span>;</span>
<span class="line" id="L509">    <span class="tok-kw">const</span> ad = [<span class="tok-number">8</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span> };</span>
<span class="line" id="L510">    <span class="tok-kw">const</span> m = [<span class="tok-number">32</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x0a</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x0e</span>, <span class="tok-number">0x0f</span>, <span class="tok-number">0x10</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x13</span>, <span class="tok-number">0x14</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x1b</span>, <span class="tok-number">0x1c</span>, <span class="tok-number">0x1d</span>, <span class="tok-number">0x1e</span>, <span class="tok-number">0x1f</span> };</span>
<span class="line" id="L511">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L512">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L513">    <span class="tok-kw">var</span> tag: [Aegis256.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L514"></span>
<span class="line" id="L515">    Aegis256.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L516">    <span class="tok-kw">try</span> Aegis256.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L517">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L518"></span>
<span class="line" id="L519">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;f373079ed84b2709faee373584585d60accd191db310ef5d8b11833df9dec711&quot;</span>, &amp;c);</span>
<span class="line" id="L520">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;8d86f91ee606e9ff26a01b64ccbdd91d&quot;</span>, &amp;tag);</span>
<span class="line" id="L521"></span>
<span class="line" id="L522">    c[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L523">    <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, Aegis256.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key));</span>
<span class="line" id="L524">    c[<span class="tok-number">0</span>] -%= <span class="tok-number">1</span>;</span>
<span class="line" id="L525">    tag[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L526">    <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, Aegis256.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key));</span>
<span class="line" id="L527">}</span>
<span class="line" id="L528"></span>
<span class="line" id="L529"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis256 test vector 2&quot;</span> {</span>
<span class="line" id="L530">    <span class="tok-kw">const</span> key: [Aegis256.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L531">    <span class="tok-kw">const</span> nonce: [Aegis256.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L532">    <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L533">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L534">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L535">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L536">    <span class="tok-kw">var</span> tag: [Aegis256.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L537"></span>
<span class="line" id="L538">    Aegis256.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L539">    <span class="tok-kw">try</span> Aegis256.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L540">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L541"></span>
<span class="line" id="L542">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;b98f03a947807713d75a4fff9fc277a6&quot;</span>, &amp;c);</span>
<span class="line" id="L543">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;478f3b50dc478ef7d5cf2d0f7cc13180&quot;</span>, &amp;tag);</span>
<span class="line" id="L544">}</span>
<span class="line" id="L545"></span>
<span class="line" id="L546"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis256 test vector 3&quot;</span> {</span>
<span class="line" id="L547">    <span class="tok-kw">const</span> key: [Aegis256.key_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L548">    <span class="tok-kw">const</span> nonce: [Aegis256.nonce_length]<span class="tok-type">u8</span> = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L549">    <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L550">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{};</span>
<span class="line" id="L551">    <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L552">    <span class="tok-kw">var</span> m2: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L553">    <span class="tok-kw">var</span> tag: [Aegis256.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L554"></span>
<span class="line" id="L555">    Aegis256.encrypt(&amp;c, &amp;tag, &amp;m, &amp;ad, nonce, key);</span>
<span class="line" id="L556">    <span class="tok-kw">try</span> Aegis256.decrypt(&amp;m2, &amp;c, tag, &amp;ad, nonce, key);</span>
<span class="line" id="L557">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;m, &amp;m2);</span>
<span class="line" id="L558"></span>
<span class="line" id="L559">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;f7a0878f68bd083e8065354071fc27c3&quot;</span>, &amp;tag);</span>
<span class="line" id="L560">}</span>
<span class="line" id="L561"></span>
<span class="line" id="L562"><span class="tok-kw">test</span> <span class="tok-str">&quot;Aegis MAC&quot;</span> {</span>
<span class="line" id="L563">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** Aegis128LMac.key_length;</span>
<span class="line" id="L564">    <span class="tok-kw">var</span> msg: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L565">    <span class="tok-kw">for</span> (msg) |*m, i| {</span>
<span class="line" id="L566">        m.* = <span class="tok-builtin">@truncate</span>(<span class="tok-type">u8</span>, i);</span>
<span class="line" id="L567">    }</span>
<span class="line" id="L568">    <span class="tok-kw">const</span> st_init = Aegis128LMac.init(&amp;key);</span>
<span class="line" id="L569">    <span class="tok-kw">var</span> st = st_init;</span>
<span class="line" id="L570">    <span class="tok-kw">var</span> tag: [Aegis128LMac.mac_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L571"></span>
<span class="line" id="L572">    st.update(msg[<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L573">    st.update(msg[<span class="tok-number">32</span>..]);</span>
<span class="line" id="L574">    st.final(&amp;tag);</span>
<span class="line" id="L575">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;b4e8e46cee04a401ec67bad73df4aa60&quot;</span>, &amp;tag);</span>
<span class="line" id="L576"></span>
<span class="line" id="L577">    st = st_init;</span>
<span class="line" id="L578">    st.update(msg[<span class="tok-number">0</span>..<span class="tok-number">31</span>]);</span>
<span class="line" id="L579">    st.update(msg[<span class="tok-number">31</span>..]);</span>
<span class="line" id="L580">    st.final(&amp;tag);</span>
<span class="line" id="L581">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;b4e8e46cee04a401ec67bad73df4aa60&quot;</span>, &amp;tag);</span>
<span class="line" id="L582"></span>
<span class="line" id="L583">    st = st_init;</span>
<span class="line" id="L584">    st.update(msg[<span class="tok-number">0</span>..<span class="tok-number">14</span>]);</span>
<span class="line" id="L585">    st.update(msg[<span class="tok-number">14</span>..<span class="tok-number">30</span>]);</span>
<span class="line" id="L586">    st.update(msg[<span class="tok-number">30</span>..]);</span>
<span class="line" id="L587">    st.final(&amp;tag);</span>
<span class="line" id="L588">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;b4e8e46cee04a401ec67bad73df4aa60&quot;</span>, &amp;tag);</span>
<span class="line" id="L589"></span>
<span class="line" id="L590">    <span class="tok-kw">var</span> empty: [<span class="tok-number">0</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L591">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{<span class="tok-number">0x00</span>} ** Aegis128L.nonce_length;</span>
<span class="line" id="L592">    Aegis128L.encrypt(&amp;empty, &amp;tag, &amp;empty, &amp;msg, nonce, key);</span>
<span class="line" id="L593">    <span class="tok-kw">try</span> htest.assertEqual(<span class="tok-str">&quot;b4e8e46cee04a401ec67bad73df4aa60&quot;</span>, &amp;tag);</span>
<span class="line" id="L594">}</span>
<span class="line" id="L595"></span>
</code></pre></body>
</html>