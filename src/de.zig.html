<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>de.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! Deserialization framework.</span></span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L4"></span>
<span class="line" id="L5"><span class="tok-comment">/// Deserializer interface.</span></span>
<span class="line" id="L6"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Deserializer = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/deserializer.zig&quot;</span>).Deserializer;</span>
<span class="line" id="L7"></span>
<span class="line" id="L8"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> default_dt = .{</span>
<span class="line" id="L9">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L10">    <span class="tok-comment">// Standard Library</span>
</span>
<span class="line" id="L11">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L12"></span>
<span class="line" id="L13">    de.blocks.ArrayList,</span>
<span class="line" id="L14">    de.blocks.BufMap,</span>
<span class="line" id="L15">    de.blocks.HashMap,</span>
<span class="line" id="L16">    de.blocks.LinkedList,</span>
<span class="line" id="L17">    de.blocks.TailQueue,</span>
<span class="line" id="L18"></span>
<span class="line" id="L19">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L20">    <span class="tok-comment">// Primitives</span>
</span>
<span class="line" id="L21">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L22"></span>
<span class="line" id="L23">    de.blocks.Array,</span>
<span class="line" id="L24">    de.blocks.Bool,</span>
<span class="line" id="L25">    de.blocks.Enum,</span>
<span class="line" id="L26">    de.blocks.Float,</span>
<span class="line" id="L27">    de.blocks.Int,</span>
<span class="line" id="L28">    de.blocks.Optional,</span>
<span class="line" id="L29">    de.blocks.Pointer,</span>
<span class="line" id="L30">    de.blocks.Slice,</span>
<span class="line" id="L31">    de.blocks.Struct,</span>
<span class="line" id="L32">    de.blocks.Tuple,</span>
<span class="line" id="L33">    de.blocks.Union,</span>
<span class="line" id="L34">    de.blocks.Void,</span>
<span class="line" id="L35">};</span>
<span class="line" id="L36"></span>
<span class="line" id="L37"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> concepts = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L38">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/block.zig&quot;</span>);</span>
<span class="line" id="L39">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/deserializer.zig&quot;</span>);</span>
<span class="line" id="L40">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/map_access.zig&quot;</span>);</span>
<span class="line" id="L41">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/seed.zig&quot;</span>);</span>
<span class="line" id="L42">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/seq_access.zig&quot;</span>);</span>
<span class="line" id="L43">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/union_access.zig&quot;</span>);</span>
<span class="line" id="L44">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/variant_access.zig&quot;</span>);</span>
<span class="line" id="L45">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/concepts/visitor.zig&quot;</span>);</span>
<span class="line" id="L46">};</span>
<span class="line" id="L47"></span>
<span class="line" id="L48"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> traits = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L49">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/traits/block.zig&quot;</span>);</span>
<span class="line" id="L50">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/traits/attributes.zig&quot;</span>);</span>
<span class="line" id="L51">};</span>
<span class="line" id="L52"></span>
<span class="line" id="L53"><span class="tok-comment">/// Namespace for deserialization-specific types and functions.</span></span>
<span class="line" id="L54"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> de = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L55">    <span class="tok-comment">/// A generic error set for `getty.Deserializer` implementations.</span></span>
<span class="line" id="L56">    <span class="tok-comment">///</span></span>
<span class="line" id="L57">    <span class="tok-comment">/// This error set must always be included in a `getty.Deserializer`</span></span>
<span class="line" id="L58">    <span class="tok-comment">/// implementation's error set.</span></span>
<span class="line" id="L59">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Error = std.mem.Allocator.Error || <span class="tok-kw">error</span>{</span>
<span class="line" id="L60">        DuplicateField,</span>
<span class="line" id="L61">        InvalidLength,</span>
<span class="line" id="L62">        InvalidType,</span>
<span class="line" id="L63">        InvalidValue,</span>
<span class="line" id="L64">        MissingField,</span>
<span class="line" id="L65">        MissingVariant,</span>
<span class="line" id="L66">        UnknownField,</span>
<span class="line" id="L67">        UnknownVariant,</span>
<span class="line" id="L68">        Unsupported,</span>
<span class="line" id="L69">    };</span>
<span class="line" id="L70"></span>
<span class="line" id="L71">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> MapAccess = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/map_access.zig&quot;</span>).MapAccess;</span>
<span class="line" id="L72">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> SeqAccess = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/seq_access.zig&quot;</span>).SeqAccess;</span>
<span class="line" id="L73">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> UnionAccess = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/union_access.zig&quot;</span>).UnionAccess;</span>
<span class="line" id="L74">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> VariantAccess = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/variant_access.zig&quot;</span>).VariantAccess;</span>
<span class="line" id="L75"></span>
<span class="line" id="L76">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Visitor = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/visitor.zig&quot;</span>).Visitor;</span>
<span class="line" id="L77"></span>
<span class="line" id="L78">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Seed = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/interfaces/seed.zig&quot;</span>).Seed;</span>
<span class="line" id="L79">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DefaultSeed = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/impls/seed/default.zig&quot;</span>).DefaultSeed;</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Ignored = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/impls/ignored.zig&quot;</span>).Ignored;</span>
<span class="line" id="L82"></span>
<span class="line" id="L83">    <span class="tok-comment">/// Frees resources allocated during Getty deserialization.</span></span>
<span class="line" id="L84">    <span class="tok-comment">///</span></span>
<span class="line" id="L85">    <span class="tok-comment">/// Values that cannot be deallocated, such as `bool` values, are ignored.</span></span>
<span class="line" id="L86">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">free</span>(</span>
<span class="line" id="L87">        <span class="tok-comment">/// A memory allocator.</span></span>
<span class="line" id="L88">        allocator: std.mem.Allocator,</span>
<span class="line" id="L89">        <span class="tok-comment">/// A value to deallocate.</span></span>
<span class="line" id="L90">        value: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L91">    ) <span class="tok-type">void</span> {</span>
<span class="line" id="L92">        <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(value);</span>
<span class="line" id="L93">        <span class="tok-kw">const</span> name = <span class="tok-builtin">@typeName</span>(T);</span>
<span class="line" id="L94"></span>
<span class="line" id="L95">        <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L96">            .AnyFrame, .Bool, .Float, .ComptimeFloat, .Int, .ComptimeInt, .Enum, .EnumLiteral, .Fn, .Null, .Opaque, .Frame, .Void =&gt; {},</span>
<span class="line" id="L97">            .Array =&gt; <span class="tok-kw">for</span> (value) |v| free(allocator, v),</span>
<span class="line" id="L98">            .Optional =&gt; <span class="tok-kw">if</span> (value) |v| free(allocator, v),</span>
<span class="line" id="L99">            .Pointer =&gt; |info| <span class="tok-kw">switch</span> (<span class="tok-kw">comptime</span> std.meta.trait.isZigString(T)) {</span>
<span class="line" id="L100">                <span class="tok-null">true</span> =&gt; allocator.free(value),</span>
<span class="line" id="L101">                <span class="tok-null">false</span> =&gt; <span class="tok-kw">switch</span> (info.size) {</span>
<span class="line" id="L102">                    .One =&gt; {</span>
<span class="line" id="L103">                        <span class="tok-comment">// Trying to free `anyopaque` or `fn` values here</span>
</span>
<span class="line" id="L104">                        <span class="tok-comment">// triggers the errors in the following issue:</span>
</span>
<span class="line" id="L105">                        <span class="tok-comment">//</span>
</span>
<span class="line" id="L106">                        <span class="tok-comment">//   https://github.com/getty-zig/getty/issues/37.</span>
</span>
<span class="line" id="L107">                        <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(info.child)) {</span>
<span class="line" id="L108">                            .Fn, .Opaque =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L109">                            <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L110">                                free(allocator, value.*);</span>
<span class="line" id="L111">                                allocator.destroy(value);</span>
<span class="line" id="L112">                            },</span>
<span class="line" id="L113">                        }</span>
<span class="line" id="L114">                    },</span>
<span class="line" id="L115">                    .Slice =&gt; {</span>
<span class="line" id="L116">                        <span class="tok-kw">for</span> (value) |v| free(allocator, v);</span>
<span class="line" id="L117">                        allocator.free(value);</span>
<span class="line" id="L118">                    },</span>
<span class="line" id="L119">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L120">                },</span>
<span class="line" id="L121">            },</span>
<span class="line" id="L122">            .Union =&gt; |info| <span class="tok-kw">if</span> (info.tag_type) |Tag| {</span>
<span class="line" id="L123">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (info.fields) |field| {</span>
<span class="line" id="L124">                    <span class="tok-kw">if</span> (value == <span class="tok-builtin">@field</span>(Tag, field.name)) {</span>
<span class="line" id="L125">                        free(allocator, <span class="tok-builtin">@field</span>(value, field.name));</span>
<span class="line" id="L126">                        <span class="tok-kw">break</span>;</span>
<span class="line" id="L127">                    }</span>
<span class="line" id="L128">                }</span>
<span class="line" id="L129">            },</span>
<span class="line" id="L130">            .Struct =&gt; |info| {</span>
<span class="line" id="L131">                <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;array_list.ArrayListAlignedUnmanaged&quot;</span>)) {</span>
<span class="line" id="L132">                    <span class="tok-kw">for</span> (value.items) |v| free(allocator, v);</span>
<span class="line" id="L133">                    <span class="tok-kw">var</span> mut = value;</span>
<span class="line" id="L134">                    mut.deinit(allocator);</span>
<span class="line" id="L135">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;array_list.ArrayList&quot;</span>)) {</span>
<span class="line" id="L136">                    <span class="tok-kw">for</span> (value.items) |v| free(allocator, v);</span>
<span class="line" id="L137">                    value.deinit();</span>
<span class="line" id="L138">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == std.BufMap) {</span>
<span class="line" id="L139">                    <span class="tok-kw">var</span> it = value.hash_map.iterator();</span>
<span class="line" id="L140">                    <span class="tok-kw">while</span> (it.next()) |entry| {</span>
<span class="line" id="L141">                        free(allocator, entry.key_ptr.*);</span>
<span class="line" id="L142">                        free(allocator, entry.value_ptr.*);</span>
<span class="line" id="L143">                    }</span>
<span class="line" id="L144">                    <span class="tok-kw">var</span> mut = value;</span>
<span class="line" id="L145">                    mut.hash_map.deinit();</span>
<span class="line" id="L146">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;hash_map.HashMapUnmanaged&quot;</span>)) {</span>
<span class="line" id="L147">                    <span class="tok-kw">var</span> iterator = value.iterator();</span>
<span class="line" id="L148">                    <span class="tok-kw">while</span> (iterator.next()) |entry| {</span>
<span class="line" id="L149">                        free(allocator, entry.key_ptr.*);</span>
<span class="line" id="L150">                        free(allocator, entry.value_ptr.*);</span>
<span class="line" id="L151">                    }</span>
<span class="line" id="L152">                    <span class="tok-kw">var</span> mut = value;</span>
<span class="line" id="L153">                    mut.deinit(allocator);</span>
<span class="line" id="L154">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;hash_map.HashMap&quot;</span>)) {</span>
<span class="line" id="L155">                    <span class="tok-kw">var</span> iterator = value.iterator();</span>
<span class="line" id="L156">                    <span class="tok-kw">while</span> (iterator.next()) |entry| {</span>
<span class="line" id="L157">                        free(allocator, entry.key_ptr.*);</span>
<span class="line" id="L158">                        free(allocator, entry.value_ptr.*);</span>
<span class="line" id="L159">                    }</span>
<span class="line" id="L160">                    <span class="tok-kw">var</span> mut = value;</span>
<span class="line" id="L161">                    mut.deinit();</span>
<span class="line" id="L162">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;linked_list&quot;</span>)) {</span>
<span class="line" id="L163">                    <span class="tok-kw">var</span> iterator = value.first;</span>
<span class="line" id="L164">                    <span class="tok-kw">while</span> (iterator) |node| {</span>
<span class="line" id="L165">                        free(allocator, node.data);</span>
<span class="line" id="L166">                        iterator = node.next;</span>
<span class="line" id="L167">                        allocator.destroy(node);</span>
<span class="line" id="L168">                    }</span>
<span class="line" id="L169">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L170">                    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (info.fields) |field| {</span>
<span class="line" id="L171">                        <span class="tok-kw">if</span> (!field.is_comptime) free(allocator, <span class="tok-builtin">@field</span>(value, field.name));</span>
<span class="line" id="L172">                    }</span>
<span class="line" id="L173">                }</span>
<span class="line" id="L174">            },</span>
<span class="line" id="L175">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L176">        }</span>
<span class="line" id="L177">    }</span>
<span class="line" id="L178"></span>
<span class="line" id="L179">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> blocks = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L180">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L181">        <span class="tok-comment">// Standard Library</span>
</span>
<span class="line" id="L182">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L183"></span>
<span class="line" id="L184">        <span class="tok-comment">/// Deserialization block for `std.ArrayList` values.</span></span>
<span class="line" id="L185">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ArrayList = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/array_list.zig&quot;</span>);</span>
<span class="line" id="L186"></span>
<span class="line" id="L187">        <span class="tok-comment">/// Deserialization block for `std.BufMap` values.</span></span>
<span class="line" id="L188">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> BufMap = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/buf_map.zig&quot;</span>);</span>
<span class="line" id="L189"></span>
<span class="line" id="L190">        <span class="tok-comment">/// Deserialization block for `std.HashMap` values.</span></span>
<span class="line" id="L191">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> HashMap = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/hash_map.zig&quot;</span>);</span>
<span class="line" id="L192"></span>
<span class="line" id="L193">        <span class="tok-comment">/// Deserialization block for `std.SinglyLinkedList` values.</span></span>
<span class="line" id="L194">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkedList = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/linked_list.zig&quot;</span>);</span>
<span class="line" id="L195"></span>
<span class="line" id="L196">        <span class="tok-comment">/// Deserialization block for `std.TailQueue`.</span></span>
<span class="line" id="L197">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> TailQueue = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/tail_queue.zig&quot;</span>);</span>
<span class="line" id="L198"></span>
<span class="line" id="L199">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L200">        <span class="tok-comment">// Primitives</span>
</span>
<span class="line" id="L201">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L202"></span>
<span class="line" id="L203">        <span class="tok-comment">/// Deserializaton block for array values.</span></span>
<span class="line" id="L204">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Array = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/array.zig&quot;</span>);</span>
<span class="line" id="L205"></span>
<span class="line" id="L206">        <span class="tok-comment">/// Deserialization block for `bool` values.</span></span>
<span class="line" id="L207">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Bool = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/bool.zig&quot;</span>);</span>
<span class="line" id="L208"></span>
<span class="line" id="L209">        <span class="tok-comment">/// Deserialization block for `enum` values.</span></span>
<span class="line" id="L210">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Enum = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/enum.zig&quot;</span>);</span>
<span class="line" id="L211"></span>
<span class="line" id="L212">        <span class="tok-comment">/// Deserialization block for floating-point values.</span></span>
<span class="line" id="L213">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Float = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/float.zig&quot;</span>);</span>
<span class="line" id="L214"></span>
<span class="line" id="L215">        <span class="tok-comment">/// Deserialization block for integer values.</span></span>
<span class="line" id="L216">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Int = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/int.zig&quot;</span>);</span>
<span class="line" id="L217"></span>
<span class="line" id="L218">        <span class="tok-comment">/// Deserialization block for optional values.</span></span>
<span class="line" id="L219">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Optional = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/optional.zig&quot;</span>);</span>
<span class="line" id="L220"></span>
<span class="line" id="L221">        <span class="tok-comment">/// Deserialization block for pointer values.</span></span>
<span class="line" id="L222">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Pointer = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/pointer.zig&quot;</span>);</span>
<span class="line" id="L223"></span>
<span class="line" id="L224">        <span class="tok-comment">/// Deserialization block for slice values.</span></span>
<span class="line" id="L225">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Slice = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/slice.zig&quot;</span>);</span>
<span class="line" id="L226"></span>
<span class="line" id="L227">        <span class="tok-comment">/// Deserialization block for `struct` values.</span></span>
<span class="line" id="L228">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Struct = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/struct.zig&quot;</span>);</span>
<span class="line" id="L229"></span>
<span class="line" id="L230">        <span class="tok-comment">/// Deserialization block for tuple values.</span></span>
<span class="line" id="L231">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Tuple = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/tuple.zig&quot;</span>);</span>
<span class="line" id="L232"></span>
<span class="line" id="L233">        <span class="tok-comment">/// Deserialization block for `union` values.</span></span>
<span class="line" id="L234">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Union = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/union.zig&quot;</span>);</span>
<span class="line" id="L235"></span>
<span class="line" id="L236">        <span class="tok-comment">/// Deserialization block for `void` values.</span></span>
<span class="line" id="L237">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Void = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;de/blocks/void.zig&quot;</span>);</span>
<span class="line" id="L238">    };</span>
<span class="line" id="L239"></span>
<span class="line" id="L240">    <span class="tok-comment">/// Returns the attributes for a type. If none exists, `null` is returned.</span></span>
<span class="line" id="L241">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getAttributes</span>(</span>
<span class="line" id="L242">        <span class="tok-comment">/// A type with attributes.</span></span>
<span class="line" id="L243">        <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L244">        <span class="tok-comment">/// A `getty.Deserializer` interface type.</span></span>
<span class="line" id="L245">        <span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>,</span>
<span class="line" id="L246">    ) blk: {</span>
<span class="line" id="L247">        <span class="tok-comment">// Process user DBs.</span>
</span>
<span class="line" id="L248">        <span class="tok-kw">for</span> (D.user_dt) |db| {</span>
<span class="line" id="L249">            <span class="tok-kw">if</span> (db.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, db)) {</span>
<span class="line" id="L250">                <span class="tok-kw">break</span> :blk ?<span class="tok-builtin">@TypeOf</span>(db.attributes);</span>
<span class="line" id="L251">            }</span>
<span class="line" id="L252">        }</span>
<span class="line" id="L253"></span>
<span class="line" id="L254">        <span class="tok-comment">// Process type DBs.</span>
</span>
<span class="line" id="L255">        <span class="tok-kw">if</span> (traits.has_db(T)) {</span>
<span class="line" id="L256">            <span class="tok-kw">const</span> db = T.@&quot;getty.db&quot;;</span>
<span class="line" id="L257"></span>
<span class="line" id="L258">            <span class="tok-kw">if</span> (traits.has_attributes(T, db)) {</span>
<span class="line" id="L259">                <span class="tok-kw">break</span> :blk ?<span class="tok-builtin">@TypeOf</span>(db.attributes);</span>
<span class="line" id="L260">            }</span>
<span class="line" id="L261">        }</span>
<span class="line" id="L262"></span>
<span class="line" id="L263">        <span class="tok-kw">break</span> :blk ?<span class="tok-type">void</span>;</span>
<span class="line" id="L264">    } {</span>
<span class="line" id="L265">        <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L266">            <span class="tok-comment">// Process user DBTs.</span>
</span>
<span class="line" id="L267">            <span class="tok-kw">for</span> (D.user_dt) |db| {</span>
<span class="line" id="L268">                <span class="tok-kw">if</span> (db.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, db)) {</span>
<span class="line" id="L269">                    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(?<span class="tok-builtin">@TypeOf</span>(db.attributes), db.attributes);</span>
<span class="line" id="L270">                }</span>
<span class="line" id="L271">            }</span>
<span class="line" id="L272"></span>
<span class="line" id="L273">            <span class="tok-comment">// Process type DBTs.</span>
</span>
<span class="line" id="L274">            <span class="tok-kw">if</span> (traits.has_db(T)) {</span>
<span class="line" id="L275">                <span class="tok-kw">const</span> db = T.@&quot;getty.db&quot;;</span>
<span class="line" id="L276"></span>
<span class="line" id="L277">                <span class="tok-kw">if</span> (traits.has_attributes(T, db)) {</span>
<span class="line" id="L278">                    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(?<span class="tok-builtin">@TypeOf</span>(db.attributes), db.attributes);</span>
<span class="line" id="L279">                }</span>
<span class="line" id="L280">            }</span>
<span class="line" id="L281"></span>
<span class="line" id="L282">            <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L283">        }</span>
<span class="line" id="L284">    }</span>
<span class="line" id="L285"></span>
<span class="line" id="L286">    <span class="tok-comment">// TODO: Swap function parameters.</span>
</span>
<span class="line" id="L287">    <span class="tok-comment">/// Returns the highest priority Deserialization Block for a type.</span></span>
<span class="line" id="L288">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">find_db</span>(</span>
<span class="line" id="L289">        <span class="tok-comment">/// A `getty.Deserializer` interface type.</span></span>
<span class="line" id="L290">        <span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>,</span>
<span class="line" id="L291">        <span class="tok-comment">/// The type being deserialized into.</span></span>
<span class="line" id="L292">        <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L293">    ) <span class="tok-type">type</span> {</span>
<span class="line" id="L294">        <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L295">            concepts.@&quot;getty.Deserializer&quot;(D);</span>
<span class="line" id="L296"></span>
<span class="line" id="L297">            <span class="tok-comment">// Process user DBs.</span>
</span>
<span class="line" id="L298">            <span class="tok-kw">for</span> (D.user_dt) |db| {</span>
<span class="line" id="L299">                <span class="tok-kw">if</span> (db.is(T)) {</span>
<span class="line" id="L300">                    <span class="tok-kw">return</span> db;</span>
<span class="line" id="L301">                }</span>
<span class="line" id="L302">            }</span>
<span class="line" id="L303"></span>
<span class="line" id="L304">            <span class="tok-comment">// Process type DBs.</span>
</span>
<span class="line" id="L305">            <span class="tok-kw">if</span> (traits.has_db(T)) {</span>
<span class="line" id="L306">                <span class="tok-kw">return</span> T.@&quot;getty.db&quot;;</span>
<span class="line" id="L307">            }</span>
<span class="line" id="L308"></span>
<span class="line" id="L309">            <span class="tok-comment">// Process deserializer DBs.</span>
</span>
<span class="line" id="L310">            <span class="tok-kw">for</span> (D.deserializer_dt) |db| {</span>
<span class="line" id="L311">                <span class="tok-kw">if</span> (db.is(T)) {</span>
<span class="line" id="L312">                    <span class="tok-kw">return</span> db;</span>
<span class="line" id="L313">                }</span>
<span class="line" id="L314">            }</span>
<span class="line" id="L315"></span>
<span class="line" id="L316">            <span class="tok-comment">// Process default DBs.</span>
</span>
<span class="line" id="L317">            <span class="tok-kw">for</span> (default_dt) |db| {</span>
<span class="line" id="L318">                <span class="tok-kw">if</span> (db.is(T)) {</span>
<span class="line" id="L319">                    <span class="tok-kw">return</span> db;</span>
<span class="line" id="L320">                }</span>
<span class="line" id="L321">            }</span>
<span class="line" id="L322"></span>
<span class="line" id="L323">            <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;type is not supported: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T));</span>
<span class="line" id="L324">        }</span>
<span class="line" id="L325">    }</span>
<span class="line" id="L326">};</span>
<span class="line" id="L327"></span>
<span class="line" id="L328"><span class="tok-comment">/// Deserializes a value.</span></span>
<span class="line" id="L329"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">deserialize</span>(</span>
<span class="line" id="L330">    <span class="tok-comment">/// An optional memory allocator.</span></span>
<span class="line" id="L331">    allocator: ?std.mem.Allocator,</span>
<span class="line" id="L332">    <span class="tok-comment">/// The type to deserialize into.</span></span>
<span class="line" id="L333">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L334">    <span class="tok-comment">/// A `getty.Deserializer` interface value.</span></span>
<span class="line" id="L335">    deserializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L336">) blk: {</span>
<span class="line" id="L337">    <span class="tok-kw">const</span> D = <span class="tok-builtin">@TypeOf</span>(deserializer);</span>
<span class="line" id="L338"></span>
<span class="line" id="L339">    concepts.@&quot;getty.Deserializer&quot;(D);</span>
<span class="line" id="L340"></span>
<span class="line" id="L341">    <span class="tok-kw">break</span> :blk D.Error!T;</span>
<span class="line" id="L342">} {</span>
<span class="line" id="L343">    <span class="tok-kw">const</span> db = <span class="tok-kw">comptime</span> de.find_db(<span class="tok-builtin">@TypeOf</span>(deserializer), T);</span>
<span class="line" id="L344"></span>
<span class="line" id="L345">    <span class="tok-kw">var</span> v = blk: {</span>
<span class="line" id="L346">        <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> traits.has_attributes(T, db)) {</span>
<span class="line" id="L347">            <span class="tok-kw">break</span> :blk <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L348">                .Struct =&gt; de.blocks.Struct.Visitor(T){},</span>
<span class="line" id="L349">                .Enum =&gt; de.blocks.Enum.Visitor(T){},</span>
<span class="line" id="L350">                .Union =&gt; de.blocks.Union.Visitor(T){},</span>
<span class="line" id="L351">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unexpected type cannot be deserialized using attributes&quot;</span>),</span>
<span class="line" id="L352">            };</span>
<span class="line" id="L353">        }</span>
<span class="line" id="L354"></span>
<span class="line" id="L355">        <span class="tok-kw">break</span> :blk db.Visitor(T){};</span>
<span class="line" id="L356">    };</span>
<span class="line" id="L357"></span>
<span class="line" id="L358">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> deserializeInternal(allocator, T, deserializer, v.visitor());</span>
<span class="line" id="L359">}</span>
<span class="line" id="L360"></span>
<span class="line" id="L361"><span class="tok-kw">fn</span> <span class="tok-fn">deserializeInternal</span>(allocator: ?std.mem.Allocator, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, deserializer: <span class="tok-kw">anytype</span>, visitor: <span class="tok-kw">anytype</span>) blk: {</span>
<span class="line" id="L362">    <span class="tok-kw">const</span> D = <span class="tok-builtin">@TypeOf</span>(deserializer);</span>
<span class="line" id="L363">    <span class="tok-kw">const</span> V = <span class="tok-builtin">@TypeOf</span>(visitor);</span>
<span class="line" id="L364"></span>
<span class="line" id="L365">    concepts.@&quot;getty.Deserializer&quot;(D);</span>
<span class="line" id="L366">    concepts.@&quot;getty.de.Visitor&quot;(V);</span>
<span class="line" id="L367"></span>
<span class="line" id="L368">    <span class="tok-kw">break</span> :blk D.Error!V.Value;</span>
<span class="line" id="L369">} {</span>
<span class="line" id="L370">    <span class="tok-kw">const</span> db = <span class="tok-kw">comptime</span> de.find_db(<span class="tok-builtin">@TypeOf</span>(deserializer), T);</span>
<span class="line" id="L371"></span>
<span class="line" id="L372">    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> traits.has_attributes(T, db)) {</span>
<span class="line" id="L373">        <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L374">            .Struct =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> de.blocks.Struct.deserialize(allocator, T, deserializer, visitor),</span>
<span class="line" id="L375">            .Enum =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> de.blocks.Enum.deserialize(allocator, T, deserializer, visitor),</span>
<span class="line" id="L376">            .Union =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> de.blocks.Union.deserialize(allocator, T, deserializer, visitor),</span>
<span class="line" id="L377">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unexpected type cannot be deserialized using attributes&quot;</span>),</span>
<span class="line" id="L378">        }</span>
<span class="line" id="L379">    }</span>
<span class="line" id="L380"></span>
<span class="line" id="L381">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> db.deserialize(allocator, T, deserializer, visitor);</span>
<span class="line" id="L382">}</span>
<span class="line" id="L383"></span>
<span class="line" id="L384"><span class="tok-kw">const</span> Token = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;tests/common.zig&quot;</span>).Token;</span>
<span class="line" id="L385"></span>
<span class="line" id="L386"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L387"></span>
<span class="line" id="L388"><span class="tok-kw">const</span> test_allocator = testing.allocator;</span>
<span class="line" id="L389"><span class="tok-kw">const</span> expect = testing.expect;</span>
<span class="line" id="L390"><span class="tok-kw">const</span> expectEqual = testing.expectEqual;</span>
<span class="line" id="L391"><span class="tok-kw">const</span> expectEqualSlices = testing.expectEqualSlices;</span>
<span class="line" id="L392"><span class="tok-kw">const</span> expectEqualStrings = testing.expectEqualStrings;</span>
<span class="line" id="L393"></span>
<span class="line" id="L394"><span class="tok-kw">const</span> TestDeserializer = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L395">    tokens: []<span class="tok-kw">const</span> Token,</span>
<span class="line" id="L396"></span>
<span class="line" id="L397">    <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L398"></span>
<span class="line" id="L399">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(tokens: []<span class="tok-kw">const</span> Token) Self {</span>
<span class="line" id="L400">        <span class="tok-kw">return</span> .{ .tokens = tokens };</span>
<span class="line" id="L401">    }</span>
<span class="line" id="L402"></span>
<span class="line" id="L403">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">remaining</span>(self: Self) <span class="tok-type">usize</span> {</span>
<span class="line" id="L404">        <span class="tok-kw">return</span> self.tokens.len;</span>
<span class="line" id="L405">    }</span>
<span class="line" id="L406"></span>
<span class="line" id="L407">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">nextTokenOpt</span>(self: *Self) ?Token {</span>
<span class="line" id="L408">        <span class="tok-kw">switch</span> (self.remaining()) {</span>
<span class="line" id="L409">            <span class="tok-number">0</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L410">            <span class="tok-kw">else</span> =&gt; |len| {</span>
<span class="line" id="L411">                <span class="tok-kw">const</span> first = self.tokens[<span class="tok-number">0</span>];</span>
<span class="line" id="L412">                self.tokens = <span class="tok-kw">if</span> (len == <span class="tok-number">1</span>) &amp;[_]Token{} <span class="tok-kw">else</span> self.tokens[<span class="tok-number">1</span>..];</span>
<span class="line" id="L413">                <span class="tok-kw">return</span> first;</span>
<span class="line" id="L414">            },</span>
<span class="line" id="L415">        }</span>
<span class="line" id="L416">    }</span>
<span class="line" id="L417"></span>
<span class="line" id="L418">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">nextToken</span>(self: *Self) Token {</span>
<span class="line" id="L419">        <span class="tok-kw">switch</span> (self.remaining()) {</span>
<span class="line" id="L420">            <span class="tok-number">0</span> =&gt; std.debug.panic(<span class="tok-str">&quot;ran out of tokens to deserialize&quot;</span>, .{}),</span>
<span class="line" id="L421">            <span class="tok-kw">else</span> =&gt; |len| {</span>
<span class="line" id="L422">                <span class="tok-kw">const</span> first = self.tokens[<span class="tok-number">0</span>];</span>
<span class="line" id="L423">                self.tokens = <span class="tok-kw">if</span> (len == <span class="tok-number">1</span>) &amp;[_]Token{} <span class="tok-kw">else</span> self.tokens[<span class="tok-number">1</span>..];</span>
<span class="line" id="L424">                <span class="tok-kw">return</span> first;</span>
<span class="line" id="L425">            },</span>
<span class="line" id="L426">        }</span>
<span class="line" id="L427">    }</span>
<span class="line" id="L428"></span>
<span class="line" id="L429">    <span class="tok-kw">fn</span> <span class="tok-fn">peekTokenOpt</span>(self: Self) ?Token {</span>
<span class="line" id="L430">        <span class="tok-kw">return</span> <span class="tok-kw">if</span> (self.tokens.len &gt; <span class="tok-number">0</span>) self.tokens[<span class="tok-number">0</span>] <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L431">    }</span>
<span class="line" id="L432"></span>
<span class="line" id="L433">    <span class="tok-kw">fn</span> <span class="tok-fn">peekToken</span>(self: Self) Token {</span>
<span class="line" id="L434">        <span class="tok-kw">if</span> (self.peekTokenOpt()) |token| {</span>
<span class="line" id="L435">            <span class="tok-kw">return</span> token;</span>
<span class="line" id="L436">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L437">            std.debug.panic(<span class="tok-str">&quot;ran out of tokens to deserialize&quot;</span>, .{});</span>
<span class="line" id="L438">        }</span>
<span class="line" id="L439">    }</span>
<span class="line" id="L440"></span>
<span class="line" id="L441">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> Deserializer(</span>
<span class="line" id="L442">        *Self,</span>
<span class="line" id="L443">        Error,</span>
<span class="line" id="L444">        default_dt,</span>
<span class="line" id="L445">        default_dt,</span>
<span class="line" id="L446">        .{</span>
<span class="line" id="L447">            .deserializeAny = deserializeAny,</span>
<span class="line" id="L448">            .deserializeBool = deserializeAny,</span>
<span class="line" id="L449">            .deserializeEnum = deserializeAny,</span>
<span class="line" id="L450">            .deserializeFloat = deserializeAny,</span>
<span class="line" id="L451">            .deserializeInt = deserializeAny,</span>
<span class="line" id="L452">            .deserializeMap = deserializeAny,</span>
<span class="line" id="L453">            .deserializeOptional = deserializeAny,</span>
<span class="line" id="L454">            .deserializeSeq = deserializeAny,</span>
<span class="line" id="L455">            .deserializeString = deserializeAny,</span>
<span class="line" id="L456">            .deserializeStruct = deserializeAny,</span>
<span class="line" id="L457">            .deserializeUnion = deserializeAny,</span>
<span class="line" id="L458">            .deserializeVoid = deserializeAny,</span>
<span class="line" id="L459">        },</span>
<span class="line" id="L460">    );</span>
<span class="line" id="L461"></span>
<span class="line" id="L462">    <span class="tok-kw">const</span> Error = de.Error || <span class="tok-kw">error</span>{TestExpectedEqual};</span>
<span class="line" id="L463"></span>
<span class="line" id="L464">    <span class="tok-kw">const</span> De = Self.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L465"></span>
<span class="line" id="L466">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeAny</span>(self: *Self, allocator: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) Error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L467">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.nextToken()) {</span>
<span class="line" id="L468">            .Bool =&gt; |v| <span class="tok-kw">try</span> visitor.visitBool(allocator, De, v),</span>
<span class="line" id="L469">            .I8 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L470">            .I16 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L471">            .I32 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L472">            .I64 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L473">            .I128 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L474">            .U8 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L475">            .U16 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L476">            .U32 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L477">            .U64 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L478">            .U128 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L479">            .F16 =&gt; |v| <span class="tok-kw">try</span> visitor.visitFloat(allocator, De, v),</span>
<span class="line" id="L480">            .F32 =&gt; |v| <span class="tok-kw">try</span> visitor.visitFloat(allocator, De, v),</span>
<span class="line" id="L481">            .F64 =&gt; |v| <span class="tok-kw">try</span> visitor.visitFloat(allocator, De, v),</span>
<span class="line" id="L482">            .F128 =&gt; |v| <span class="tok-kw">try</span> visitor.visitFloat(allocator, De, v),</span>
<span class="line" id="L483">            .Enum =&gt; <span class="tok-kw">switch</span> (self.nextToken()) {</span>
<span class="line" id="L484">                .U8 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L485">                .U16 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L486">                .U32 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L487">                .U64 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L488">                .U128 =&gt; |v| <span class="tok-kw">try</span> visitor.visitInt(allocator, De, v),</span>
<span class="line" id="L489">                .String =&gt; |v| <span class="tok-kw">try</span> visitor.visitString(allocator, De, v),</span>
<span class="line" id="L490">                <span class="tok-kw">else</span> =&gt; |v| std.debug.panic(<span class="tok-str">&quot;deserialization did not expect this token: {s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(v)}),</span>
<span class="line" id="L491">            },</span>
<span class="line" id="L492">            .Null =&gt; <span class="tok-kw">try</span> visitor.visitNull(allocator, De),</span>
<span class="line" id="L493">            .Some =&gt; <span class="tok-kw">try</span> visitor.visitSome(allocator, self.deserializer()),</span>
<span class="line" id="L494">            .String =&gt; |v| <span class="tok-kw">try</span> visitor.visitString(allocator, De, v),</span>
<span class="line" id="L495">            .Void =&gt; <span class="tok-kw">try</span> visitor.visitVoid(allocator, De),</span>
<span class="line" id="L496">            .Map =&gt; |v| blk: {</span>
<span class="line" id="L497">                <span class="tok-kw">var</span> m = Map{ .de = self, .len = v.len, .end = .MapEnd };</span>
<span class="line" id="L498">                <span class="tok-kw">var</span> value = <span class="tok-kw">try</span> visitor.visitMap(allocator, De, m.mapAccess());</span>
<span class="line" id="L499"></span>
<span class="line" id="L500">                <span class="tok-kw">try</span> self.assertNextToken(.MapEnd);</span>
<span class="line" id="L501"></span>
<span class="line" id="L502">                <span class="tok-kw">break</span> :blk value;</span>
<span class="line" id="L503">            },</span>
<span class="line" id="L504">            .Seq =&gt; |v| blk: {</span>
<span class="line" id="L505">                <span class="tok-kw">var</span> s = Seq{ .de = self, .len = v.len, .end = .SeqEnd };</span>
<span class="line" id="L506">                <span class="tok-kw">var</span> value = <span class="tok-kw">try</span> visitor.visitSeq(allocator, De, s.seqAccess());</span>
<span class="line" id="L507"></span>
<span class="line" id="L508">                <span class="tok-kw">try</span> self.assertNextToken(.SeqEnd);</span>
<span class="line" id="L509"></span>
<span class="line" id="L510">                <span class="tok-kw">break</span> :blk value;</span>
<span class="line" id="L511">            },</span>
<span class="line" id="L512">            .Struct =&gt; |v| blk: {</span>
<span class="line" id="L513">                <span class="tok-kw">var</span> s = Struct{ .de = self, .len = v.len, .end = .StructEnd };</span>
<span class="line" id="L514">                <span class="tok-kw">var</span> value = <span class="tok-kw">try</span> visitor.visitMap(allocator, De, s.mapAccess());</span>
<span class="line" id="L515"></span>
<span class="line" id="L516">                <span class="tok-kw">try</span> self.assertNextToken(.StructEnd);</span>
<span class="line" id="L517"></span>
<span class="line" id="L518">                <span class="tok-kw">break</span> :blk value;</span>
<span class="line" id="L519">            },</span>
<span class="line" id="L520">            .Union =&gt; blk: {</span>
<span class="line" id="L521">                <span class="tok-kw">var</span> u = Union{ .de = self };</span>
<span class="line" id="L522">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitUnion(allocator, De, u.unionAccess(), u.variantAccess());</span>
<span class="line" id="L523">            },</span>
<span class="line" id="L524"></span>
<span class="line" id="L525">            <span class="tok-comment">// Panic! At The Disco</span>
</span>
<span class="line" id="L526">            <span class="tok-kw">else</span> =&gt; |v| std.debug.panic(<span class="tok-str">&quot;deserialization did not expect this token: {s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(v)}),</span>
<span class="line" id="L527">        };</span>
<span class="line" id="L528">    }</span>
<span class="line" id="L529"></span>
<span class="line" id="L530">    <span class="tok-kw">fn</span> <span class="tok-fn">assertNextToken</span>(self: *Self, expected: Token) !<span class="tok-type">void</span> {</span>
<span class="line" id="L531">        <span class="tok-kw">if</span> (self.nextTokenOpt()) |token| {</span>
<span class="line" id="L532">            <span class="tok-kw">const</span> token_tag = std.meta.activeTag(token);</span>
<span class="line" id="L533">            <span class="tok-kw">const</span> expected_tag = std.meta.activeTag(expected);</span>
<span class="line" id="L534"></span>
<span class="line" id="L535">            <span class="tok-kw">if</span> (token_tag == expected_tag) {</span>
<span class="line" id="L536">                <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L537">                    .MapEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;MapEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;MapEnd&quot;</span>)),</span>
<span class="line" id="L538">                    .SeqEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;SeqEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;SeqEnd&quot;</span>)),</span>
<span class="line" id="L539">                    .StructEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;StructEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;StructEnd&quot;</span>)),</span>
<span class="line" id="L540">                    <span class="tok-kw">else</span> =&gt; |v| std.debug.panic(<span class="tok-str">&quot;unexpected token: {s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(v)}),</span>
<span class="line" id="L541">                }</span>
<span class="line" id="L542">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L543">                <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;expected Token::{} but deserialization wants Token::{}&quot;</span>);</span>
<span class="line" id="L544">            }</span>
<span class="line" id="L545">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L546">            <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;end of tokens but deserialization wants Token::{}&quot;</span>);</span>
<span class="line" id="L547">        }</span>
<span class="line" id="L548">    }</span>
<span class="line" id="L549"></span>
<span class="line" id="L550">    <span class="tok-kw">const</span> Seq = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L551">        de: *TestDeserializer,</span>
<span class="line" id="L552">        len: ?<span class="tok-type">usize</span>,</span>
<span class="line" id="L553">        end: Token,</span>
<span class="line" id="L554"></span>
<span class="line" id="L555">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> de.SeqAccess(</span>
<span class="line" id="L556">            *Seq,</span>
<span class="line" id="L557">            Error,</span>
<span class="line" id="L558">            .{ .nextElementSeed = nextElementSeed },</span>
<span class="line" id="L559">        );</span>
<span class="line" id="L560"></span>
<span class="line" id="L561">        <span class="tok-kw">fn</span> <span class="tok-fn">nextElementSeed</span>(self: *Seq, allocator: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L562">            <span class="tok-kw">if</span> (self.de.peekTokenOpt()) |token| {</span>
<span class="line" id="L563">                <span class="tok-kw">if</span> (std.meta.eql(token, self.end)) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L564">            }</span>
<span class="line" id="L565"></span>
<span class="line" id="L566">            self.len.? -= <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-kw">if</span> (self.len.? &gt; <span class="tok-number">0</span>) <span class="tok-number">1</span> <span class="tok-kw">else</span> <span class="tok-number">0</span>);</span>
<span class="line" id="L567"></span>
<span class="line" id="L568">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(allocator, self.de.deserializer());</span>
<span class="line" id="L569">        }</span>
<span class="line" id="L570">    };</span>
<span class="line" id="L571"></span>
<span class="line" id="L572">    <span class="tok-kw">const</span> Map = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L573">        de: *TestDeserializer,</span>
<span class="line" id="L574">        len: ?<span class="tok-type">usize</span>,</span>
<span class="line" id="L575">        end: Token,</span>
<span class="line" id="L576"></span>
<span class="line" id="L577">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> de.MapAccess(</span>
<span class="line" id="L578">            *Map,</span>
<span class="line" id="L579">            Error,</span>
<span class="line" id="L580">            .{</span>
<span class="line" id="L581">                .nextKeySeed = nextKeySeed,</span>
<span class="line" id="L582">                .nextValueSeed = nextValueSeed,</span>
<span class="line" id="L583">            },</span>
<span class="line" id="L584">        );</span>
<span class="line" id="L585"></span>
<span class="line" id="L586">        <span class="tok-kw">fn</span> <span class="tok-fn">nextKeySeed</span>(self: *Map, allocator: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L587">            <span class="tok-kw">if</span> (self.de.peekTokenOpt()) |token| {</span>
<span class="line" id="L588">                <span class="tok-kw">if</span> (std.meta.eql(token, self.end)) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L589">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L590">                <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L591">            }</span>
<span class="line" id="L592"></span>
<span class="line" id="L593">            self.len.? -= <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-kw">if</span> (self.len.? &gt; <span class="tok-number">0</span>) <span class="tok-number">1</span> <span class="tok-kw">else</span> <span class="tok-number">0</span>);</span>
<span class="line" id="L594"></span>
<span class="line" id="L595">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(allocator, self.de.deserializer());</span>
<span class="line" id="L596">        }</span>
<span class="line" id="L597"></span>
<span class="line" id="L598">        <span class="tok-kw">fn</span> <span class="tok-fn">nextValueSeed</span>(self: *Map, allocator: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L599">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(allocator, self.de.deserializer());</span>
<span class="line" id="L600">        }</span>
<span class="line" id="L601">    };</span>
<span class="line" id="L602"></span>
<span class="line" id="L603">    <span class="tok-kw">const</span> Struct = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L604">        de: *TestDeserializer,</span>
<span class="line" id="L605">        len: ?<span class="tok-type">usize</span>,</span>
<span class="line" id="L606">        end: Token,</span>
<span class="line" id="L607"></span>
<span class="line" id="L608">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> de.MapAccess(</span>
<span class="line" id="L609">            *Struct,</span>
<span class="line" id="L610">            Error,</span>
<span class="line" id="L611">            .{</span>
<span class="line" id="L612">                .nextKeySeed = nextKeySeed,</span>
<span class="line" id="L613">                .nextValueSeed = nextValueSeed,</span>
<span class="line" id="L614">                .isKeyAllocated = isKeyAllocated,</span>
<span class="line" id="L615">            },</span>
<span class="line" id="L616">        );</span>
<span class="line" id="L617"></span>
<span class="line" id="L618">        <span class="tok-kw">fn</span> <span class="tok-fn">nextKeySeed</span>(self: *Struct, _: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L619">            <span class="tok-kw">if</span> (self.de.peekTokenOpt()) |token| {</span>
<span class="line" id="L620">                <span class="tok-kw">if</span> (std.meta.eql(token, self.end)) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L621">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L622">                <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L623">            }</span>
<span class="line" id="L624"></span>
<span class="line" id="L625">            <span class="tok-kw">if</span> (self.de.nextTokenOpt()) |token| {</span>
<span class="line" id="L626">                self.len.? -= <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-kw">if</span> (self.len.? &gt; <span class="tok-number">0</span>) <span class="tok-number">1</span> <span class="tok-kw">else</span> <span class="tok-number">0</span>);</span>
<span class="line" id="L627"></span>
<span class="line" id="L628">                <span class="tok-kw">if</span> (token != .String) {</span>
<span class="line" id="L629">                    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType;</span>
<span class="line" id="L630">                }</span>
<span class="line" id="L631"></span>
<span class="line" id="L632">                <span class="tok-kw">return</span> token.String;</span>
<span class="line" id="L633">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L634">                <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L635">            }</span>
<span class="line" id="L636">        }</span>
<span class="line" id="L637"></span>
<span class="line" id="L638">        <span class="tok-kw">fn</span> <span class="tok-fn">nextValueSeed</span>(self: *Struct, allocator: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L639">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(allocator, self.de.deserializer());</span>
<span class="line" id="L640">        }</span>
<span class="line" id="L641"></span>
<span class="line" id="L642">        <span class="tok-kw">fn</span> <span class="tok-fn">isKeyAllocated</span>(_: *Struct, <span class="tok-kw">comptime</span> _: <span class="tok-type">type</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L643">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L644">        }</span>
<span class="line" id="L645">    };</span>
<span class="line" id="L646"></span>
<span class="line" id="L647">    <span class="tok-kw">const</span> Union = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L648">        de: *TestDeserializer,</span>
<span class="line" id="L649"></span>
<span class="line" id="L650">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> de.UnionAccess(</span>
<span class="line" id="L651">            *Union,</span>
<span class="line" id="L652">            Error,</span>
<span class="line" id="L653">            .{ .variantSeed = variantSeed },</span>
<span class="line" id="L654">        );</span>
<span class="line" id="L655"></span>
<span class="line" id="L656">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> de.VariantAccess(</span>
<span class="line" id="L657">            *Union,</span>
<span class="line" id="L658">            Error,</span>
<span class="line" id="L659">            .{ .payloadSeed = payloadSeed },</span>
<span class="line" id="L660">        );</span>
<span class="line" id="L661"></span>
<span class="line" id="L662">        <span class="tok-kw">fn</span> <span class="tok-fn">variantSeed</span>(self: *Union, _: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L663">            <span class="tok-kw">const</span> token = self.de.nextToken();</span>
<span class="line" id="L664"></span>
<span class="line" id="L665">            <span class="tok-kw">if</span> (token == .String) {</span>
<span class="line" id="L666">                <span class="tok-kw">return</span> token.String;</span>
<span class="line" id="L667">            }</span>
<span class="line" id="L668"></span>
<span class="line" id="L669">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType;</span>
<span class="line" id="L670">        }</span>
<span class="line" id="L671"></span>
<span class="line" id="L672">        <span class="tok-kw">fn</span> <span class="tok-fn">payloadSeed</span>(self: *Union, allocator: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) Error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L673">            <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(seed).Value != <span class="tok-type">void</span>) {</span>
<span class="line" id="L674">                <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(allocator, self.de.deserializer());</span>
<span class="line" id="L675">            }</span>
<span class="line" id="L676"></span>
<span class="line" id="L677">            <span class="tok-kw">if</span> (self.de.nextToken() != .Void) {</span>
<span class="line" id="L678">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnknownVariant;</span>
<span class="line" id="L679">            }</span>
<span class="line" id="L680">        }</span>
<span class="line" id="L681">    };</span>
<span class="line" id="L682">};</span>
<span class="line" id="L683"></span>
<span class="line" id="L684"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - array&quot;</span> {</span>
<span class="line" id="L685">    <span class="tok-kw">try</span> t([_]<span class="tok-type">i32</span>{}, &amp;[_]Token{</span>
<span class="line" id="L686">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L687">        .{ .SeqEnd = {} },</span>
<span class="line" id="L688">    });</span>
<span class="line" id="L689">    <span class="tok-kw">try</span> t([<span class="tok-number">3</span>]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span> }, &amp;[_]Token{</span>
<span class="line" id="L690">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L691">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L692">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L693">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L694">        .{ .SeqEnd = {} },</span>
<span class="line" id="L695">    });</span>
<span class="line" id="L696">    <span class="tok-kw">try</span> t([<span class="tok-number">3</span>][<span class="tok-number">2</span>]<span class="tok-type">i32</span>{ .{ <span class="tok-number">1</span>, <span class="tok-number">2</span> }, .{ <span class="tok-number">3</span>, <span class="tok-number">4</span> }, .{ <span class="tok-number">5</span>, <span class="tok-number">6</span> } }, &amp;[_]Token{</span>
<span class="line" id="L697">        .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L698">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L699">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L700">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L701">        .{ .SeqEnd = {} },</span>
<span class="line" id="L702">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L703">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L704">        .{ .I32 = <span class="tok-number">4</span> },</span>
<span class="line" id="L705">        .{ .SeqEnd = {} },</span>
<span class="line" id="L706">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L707">        .{ .I32 = <span class="tok-number">5</span> },</span>
<span class="line" id="L708">        .{ .I32 = <span class="tok-number">6</span> },</span>
<span class="line" id="L709">        .{ .SeqEnd = {} },</span>
<span class="line" id="L710">        .{ .SeqEnd = {} },</span>
<span class="line" id="L711">    });</span>
<span class="line" id="L712">}</span>
<span class="line" id="L713"></span>
<span class="line" id="L714"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - array list&quot;</span> {</span>
<span class="line" id="L715">    {</span>
<span class="line" id="L716">        <span class="tok-kw">var</span> expected = std.ArrayList(<span class="tok-type">void</span>).init(test_allocator);</span>
<span class="line" id="L717">        <span class="tok-kw">defer</span> expected.deinit();</span>
<span class="line" id="L718"></span>
<span class="line" id="L719">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L720">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L721">            .{ .SeqEnd = {} },</span>
<span class="line" id="L722">        });</span>
<span class="line" id="L723">    }</span>
<span class="line" id="L724"></span>
<span class="line" id="L725">    {</span>
<span class="line" id="L726">        <span class="tok-kw">var</span> expected = std.ArrayList(<span class="tok-type">isize</span>).init(test_allocator);</span>
<span class="line" id="L727">        <span class="tok-kw">defer</span> expected.deinit();</span>
<span class="line" id="L728"></span>
<span class="line" id="L729">        <span class="tok-kw">try</span> expected.append(<span class="tok-number">1</span>);</span>
<span class="line" id="L730">        <span class="tok-kw">try</span> expected.append(<span class="tok-number">2</span>);</span>
<span class="line" id="L731">        <span class="tok-kw">try</span> expected.append(<span class="tok-number">3</span>);</span>
<span class="line" id="L732"></span>
<span class="line" id="L733">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L734">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L735">            .{ .I8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L736">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L737">            .{ .I64 = <span class="tok-number">3</span> },</span>
<span class="line" id="L738">            .{ .SeqEnd = {} },</span>
<span class="line" id="L739">        });</span>
<span class="line" id="L740">    }</span>
<span class="line" id="L741"></span>
<span class="line" id="L742">    {</span>
<span class="line" id="L743">        <span class="tok-kw">const</span> Child = std.ArrayList(<span class="tok-type">isize</span>);</span>
<span class="line" id="L744">        <span class="tok-kw">const</span> Parent = std.ArrayList(Child);</span>
<span class="line" id="L745"></span>
<span class="line" id="L746">        <span class="tok-kw">var</span> expected = Parent.init(test_allocator);</span>
<span class="line" id="L747">        <span class="tok-kw">var</span> a = Child.init(test_allocator);</span>
<span class="line" id="L748">        <span class="tok-kw">var</span> b = Child.init(test_allocator);</span>
<span class="line" id="L749">        <span class="tok-kw">var</span> c = Child.init(test_allocator);</span>
<span class="line" id="L750">        <span class="tok-kw">defer</span> {</span>
<span class="line" id="L751">            expected.deinit();</span>
<span class="line" id="L752">            a.deinit();</span>
<span class="line" id="L753">            b.deinit();</span>
<span class="line" id="L754">            c.deinit();</span>
<span class="line" id="L755">        }</span>
<span class="line" id="L756"></span>
<span class="line" id="L757">        <span class="tok-kw">try</span> b.append(<span class="tok-number">1</span>);</span>
<span class="line" id="L758">        <span class="tok-kw">try</span> c.append(<span class="tok-number">2</span>);</span>
<span class="line" id="L759">        <span class="tok-kw">try</span> c.append(<span class="tok-number">3</span>);</span>
<span class="line" id="L760">        <span class="tok-kw">try</span> expected.append(a);</span>
<span class="line" id="L761">        <span class="tok-kw">try</span> expected.append(b);</span>
<span class="line" id="L762">        <span class="tok-kw">try</span> expected.append(c);</span>
<span class="line" id="L763"></span>
<span class="line" id="L764">        <span class="tok-kw">const</span> tokens = &amp;[_]Token{</span>
<span class="line" id="L765">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L766">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L767">            .{ .SeqEnd = {} },</span>
<span class="line" id="L768">            .{ .Seq = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L769">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L770">            .{ .SeqEnd = {} },</span>
<span class="line" id="L771">            .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L772">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L773">            .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L774">            .{ .SeqEnd = {} },</span>
<span class="line" id="L775">            .{ .SeqEnd = {} },</span>
<span class="line" id="L776">        };</span>
<span class="line" id="L777"></span>
<span class="line" id="L778">        <span class="tok-comment">// Test manually since the `t` function cannot recursively test</span>
</span>
<span class="line" id="L779">        <span class="tok-comment">// user-defined containers containers without ugly hacks.</span>
</span>
<span class="line" id="L780">        <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L781">        <span class="tok-kw">const</span> v = deserialize(test_allocator, Parent, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L782">        <span class="tok-kw">defer</span> de.free(test_allocator, v);</span>
<span class="line" id="L783"></span>
<span class="line" id="L784">        <span class="tok-kw">try</span> expectEqual(expected.capacity, v.capacity);</span>
<span class="line" id="L785">        <span class="tok-kw">for</span> (v.items) |l, i| {</span>
<span class="line" id="L786">            <span class="tok-kw">try</span> expectEqual(expected.items[i].capacity, l.capacity);</span>
<span class="line" id="L787">            <span class="tok-kw">try</span> expectEqualSlices(<span class="tok-type">isize</span>, expected.items[i].items, l.items);</span>
<span class="line" id="L788">        }</span>
<span class="line" id="L789">    }</span>
<span class="line" id="L790">}</span>
<span class="line" id="L791"></span>
<span class="line" id="L792"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - bool&quot;</span> {</span>
<span class="line" id="L793">    <span class="tok-kw">try</span> t(<span class="tok-null">true</span>, &amp;[_]Token{.{ .Bool = <span class="tok-null">true</span> }});</span>
<span class="line" id="L794">    <span class="tok-kw">try</span> t(<span class="tok-null">false</span>, &amp;[_]Token{.{ .Bool = <span class="tok-null">false</span> }});</span>
<span class="line" id="L795">}</span>
<span class="line" id="L796"></span>
<span class="line" id="L797"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - buf map&quot;</span> {</span>
<span class="line" id="L798">    {</span>
<span class="line" id="L799">        <span class="tok-kw">var</span> expected = std.BufMap.init(test_allocator);</span>
<span class="line" id="L800">        <span class="tok-kw">defer</span> expected.deinit();</span>
<span class="line" id="L801"></span>
<span class="line" id="L802">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L803">            .{ .Map = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L804">            .{ .MapEnd = {} },</span>
<span class="line" id="L805">        });</span>
<span class="line" id="L806">    }</span>
<span class="line" id="L807"></span>
<span class="line" id="L808">    {</span>
<span class="line" id="L809">        <span class="tok-kw">var</span> expected = std.BufMap.init(test_allocator);</span>
<span class="line" id="L810">        <span class="tok-kw">defer</span> expected.deinit();</span>
<span class="line" id="L811"></span>
<span class="line" id="L812">        <span class="tok-kw">try</span> expected.put(<span class="tok-str">&quot;one&quot;</span>, <span class="tok-str">&quot;foo&quot;</span>);</span>
<span class="line" id="L813">        <span class="tok-kw">try</span> expected.put(<span class="tok-str">&quot;two&quot;</span>, <span class="tok-str">&quot;bar&quot;</span>);</span>
<span class="line" id="L814">        <span class="tok-kw">try</span> expected.put(<span class="tok-str">&quot;three&quot;</span>, <span class="tok-str">&quot;baz&quot;</span>);</span>
<span class="line" id="L815"></span>
<span class="line" id="L816">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L817">            .{ .Map = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L818">            .{ .String = <span class="tok-str">&quot;one&quot;</span> },</span>
<span class="line" id="L819">            .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L820">            .{ .String = <span class="tok-str">&quot;two&quot;</span> },</span>
<span class="line" id="L821">            .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L822">            .{ .String = <span class="tok-str">&quot;three&quot;</span> },</span>
<span class="line" id="L823">            .{ .String = <span class="tok-str">&quot;baz&quot;</span> },</span>
<span class="line" id="L824">            .{ .MapEnd = {} },</span>
<span class="line" id="L825">        });</span>
<span class="line" id="L826">    }</span>
<span class="line" id="L827">}</span>
<span class="line" id="L828"></span>
<span class="line" id="L829"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - enum&quot;</span> {</span>
<span class="line" id="L830">    <span class="tok-kw">const</span> T = <span class="tok-kw">enum</span> { zero, one, two, three, four };</span>
<span class="line" id="L831"></span>
<span class="line" id="L832">    <span class="tok-kw">try</span> t(T.zero, &amp;[_]Token{ .{ .Enum = {} }, .{ .U8 = <span class="tok-number">0</span> } });</span>
<span class="line" id="L833">    <span class="tok-kw">try</span> t(T.one, &amp;[_]Token{ .{ .Enum = {} }, .{ .U16 = <span class="tok-number">1</span> } });</span>
<span class="line" id="L834">    <span class="tok-kw">try</span> t(T.two, &amp;[_]Token{ .{ .Enum = {} }, .{ .U32 = <span class="tok-number">2</span> } });</span>
<span class="line" id="L835">    <span class="tok-kw">try</span> t(T.three, &amp;[_]Token{ .{ .Enum = {} }, .{ .U64 = <span class="tok-number">3</span> } });</span>
<span class="line" id="L836">    <span class="tok-kw">try</span> t(T.four, &amp;[_]Token{ .{ .Enum = {} }, .{ .U128 = <span class="tok-number">4</span> } });</span>
<span class="line" id="L837"></span>
<span class="line" id="L838">    <span class="tok-kw">try</span> t(T.zero, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;zero&quot;</span> } });</span>
<span class="line" id="L839">    <span class="tok-kw">try</span> t(T.four, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;four&quot;</span> } });</span>
<span class="line" id="L840">}</span>
<span class="line" id="L841"></span>
<span class="line" id="L842"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - float&quot;</span> {</span>
<span class="line" id="L843">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L844">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L845">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L846">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L847">}</span>
<span class="line" id="L848"></span>
<span class="line" id="L849"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - integer&quot;</span> {</span>
<span class="line" id="L850">    <span class="tok-comment">// signed</span>
</span>
<span class="line" id="L851">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I8 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L852">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L853">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L854">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L855">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L856">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">isize</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L857"></span>
<span class="line" id="L858">    <span class="tok-comment">// unsigned</span>
</span>
<span class="line" id="L859">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U8 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L860">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L861">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L862">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L863">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L864">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L865">}</span>
<span class="line" id="L866"></span>
<span class="line" id="L867"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - linked list&quot;</span> {</span>
<span class="line" id="L868">    {</span>
<span class="line" id="L869">        <span class="tok-kw">var</span> expected = std.SinglyLinkedList(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L870"></span>
<span class="line" id="L871">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L872">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L873">            .{ .SeqEnd = {} },</span>
<span class="line" id="L874">        });</span>
<span class="line" id="L875">    }</span>
<span class="line" id="L876"></span>
<span class="line" id="L877">    {</span>
<span class="line" id="L878">        <span class="tok-kw">var</span> expected = std.SinglyLinkedList(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L879">        <span class="tok-kw">var</span> one = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L880">        <span class="tok-kw">var</span> two = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L881">        <span class="tok-kw">var</span> three = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L882"></span>
<span class="line" id="L883">        expected.prepend(&amp;one);</span>
<span class="line" id="L884">        one.insertAfter(&amp;two);</span>
<span class="line" id="L885">        two.insertAfter(&amp;three);</span>
<span class="line" id="L886"></span>
<span class="line" id="L887">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L888">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L889">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L890">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L891">            .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L892">            .{ .SeqEnd = {} },</span>
<span class="line" id="L893">        });</span>
<span class="line" id="L894">    }</span>
<span class="line" id="L895"></span>
<span class="line" id="L896">    {</span>
<span class="line" id="L897">        <span class="tok-kw">const</span> Child = std.SinglyLinkedList(<span class="tok-type">i32</span>);</span>
<span class="line" id="L898">        <span class="tok-kw">const</span> Parent = std.SinglyLinkedList(Child);</span>
<span class="line" id="L899"></span>
<span class="line" id="L900">        <span class="tok-kw">var</span> expected = Parent{};</span>
<span class="line" id="L901">        <span class="tok-kw">var</span> a = Child{};</span>
<span class="line" id="L902">        <span class="tok-kw">var</span> b = Child{};</span>
<span class="line" id="L903">        <span class="tok-kw">var</span> c = Child{};</span>
<span class="line" id="L904"></span>
<span class="line" id="L905">        <span class="tok-kw">var</span> one = Child.Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L906">        <span class="tok-kw">var</span> two = Child.Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L907">        <span class="tok-kw">var</span> three = Child.Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L908">        b.prepend(&amp;one);</span>
<span class="line" id="L909">        c.prepend(&amp;three);</span>
<span class="line" id="L910">        c.prepend(&amp;two);</span>
<span class="line" id="L911"></span>
<span class="line" id="L912">        expected.prepend(&amp;Parent.Node{ .data = c });</span>
<span class="line" id="L913">        expected.prepend(&amp;Parent.Node{ .data = b });</span>
<span class="line" id="L914">        expected.prepend(&amp;Parent.Node{ .data = a });</span>
<span class="line" id="L915"></span>
<span class="line" id="L916">        <span class="tok-kw">const</span> tokens = &amp;[_]Token{</span>
<span class="line" id="L917">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L918">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L919">            .{ .SeqEnd = {} },</span>
<span class="line" id="L920">            .{ .Seq = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L921">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L922">            .{ .SeqEnd = {} },</span>
<span class="line" id="L923">            .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L924">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L925">            .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L926">            .{ .SeqEnd = {} },</span>
<span class="line" id="L927">            .{ .SeqEnd = {} },</span>
<span class="line" id="L928">        };</span>
<span class="line" id="L929"></span>
<span class="line" id="L930">        <span class="tok-comment">// Test manually since the `t` function cannot recursively test</span>
</span>
<span class="line" id="L931">        <span class="tok-comment">// user-defined containers containers without ugly hacks.</span>
</span>
<span class="line" id="L932">        <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L933">        <span class="tok-kw">var</span> v = deserialize(test_allocator, Parent, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L934">        <span class="tok-kw">defer</span> de.free(test_allocator, v);</span>
<span class="line" id="L935"></span>
<span class="line" id="L936">        <span class="tok-kw">try</span> expectEqual(expected.len(), v.len());</span>
<span class="line" id="L937">        <span class="tok-kw">var</span> iterator = expected.first;</span>
<span class="line" id="L938">        <span class="tok-kw">while</span> (iterator) |node| : (iterator = node.next) {</span>
<span class="line" id="L939">            <span class="tok-kw">var</span> got_node = v.popFirst();</span>
<span class="line" id="L940">            <span class="tok-kw">try</span> expect(got_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L941">            <span class="tok-kw">defer</span> test_allocator.destroy(got_node.?);</span>
<span class="line" id="L942"></span>
<span class="line" id="L943">            <span class="tok-kw">try</span> expectEqual(node.data.len(), got_node.?.data.len());</span>
<span class="line" id="L944">            <span class="tok-kw">var</span> inner_iterator = node.data.first;</span>
<span class="line" id="L945">            <span class="tok-kw">while</span> (inner_iterator) |inner_node| : (inner_iterator = inner_node.next) {</span>
<span class="line" id="L946">                <span class="tok-kw">var</span> got_inner_node = got_node.?.data.popFirst();</span>
<span class="line" id="L947">                <span class="tok-kw">try</span> expect(got_inner_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L948">                <span class="tok-kw">defer</span> test_allocator.destroy(got_inner_node.?);</span>
<span class="line" id="L949"></span>
<span class="line" id="L950">                <span class="tok-kw">try</span> expectEqual(inner_node.data, got_inner_node.?.data);</span>
<span class="line" id="L951">            }</span>
<span class="line" id="L952">        }</span>
<span class="line" id="L953">    }</span>
<span class="line" id="L954">}</span>
<span class="line" id="L955"></span>
<span class="line" id="L956"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - optional&quot;</span> {</span>
<span class="line" id="L957">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(?<span class="tok-type">i32</span>, <span class="tok-null">null</span>), &amp;[_]Token{.{ .Null = {} }});</span>
<span class="line" id="L958">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(?<span class="tok-type">i32</span>, <span class="tok-number">0</span>), &amp;[_]Token{ .{ .Some = {} }, .{ .I32 = <span class="tok-number">0</span> } });</span>
<span class="line" id="L959">}</span>
<span class="line" id="L960"></span>
<span class="line" id="L961"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - string&quot;</span> {</span>
<span class="line" id="L962">    {</span>
<span class="line" id="L963">        <span class="tok-kw">var</span> arr = [_]<span class="tok-type">u8</span>{ <span class="tok-str">'a'</span>, <span class="tok-str">'b'</span>, <span class="tok-str">'c'</span> };</span>
<span class="line" id="L964"></span>
<span class="line" id="L965">        <span class="tok-comment">// No sentinel</span>
</span>
<span class="line" id="L966">        <span class="tok-kw">try</span> t(<span class="tok-str">&quot;abc&quot;</span>, &amp;[_]Token{</span>
<span class="line" id="L967">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L968">            .{ .U8 = <span class="tok-str">'a'</span> },</span>
<span class="line" id="L969">            .{ .U8 = <span class="tok-str">'b'</span> },</span>
<span class="line" id="L970">            .{ .U8 = <span class="tok-str">'c'</span> },</span>
<span class="line" id="L971">            .{ .SeqEnd = {} },</span>
<span class="line" id="L972">        });</span>
<span class="line" id="L973"></span>
<span class="line" id="L974">        <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>([]<span class="tok-type">u8</span>, &amp;arr), &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L975">        <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, &amp;arr), &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L976">    }</span>
<span class="line" id="L977"></span>
<span class="line" id="L978">    {</span>
<span class="line" id="L979">        <span class="tok-kw">var</span> arr = [_:<span class="tok-number">0</span>]<span class="tok-type">u8</span>{ <span class="tok-str">'a'</span>, <span class="tok-str">'b'</span>, <span class="tok-str">'c'</span> };</span>
<span class="line" id="L980"></span>
<span class="line" id="L981">        <span class="tok-comment">// Sentinel</span>
</span>
<span class="line" id="L982">        <span class="tok-kw">try</span> t(<span class="tok-str">&quot;abc&quot;</span>, &amp;[_]Token{</span>
<span class="line" id="L983">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L984">            .{ .U8 = <span class="tok-str">'a'</span> },</span>
<span class="line" id="L985">            .{ .U8 = <span class="tok-str">'b'</span> },</span>
<span class="line" id="L986">            .{ .U8 = <span class="tok-str">'c'</span> },</span>
<span class="line" id="L987">            .{ .SeqEnd = {} },</span>
<span class="line" id="L988">        });</span>
<span class="line" id="L989"></span>
<span class="line" id="L990">        <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>([:<span class="tok-number">0</span>]<span class="tok-type">u8</span>, &amp;arr), &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L991">        <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>([:<span class="tok-number">0</span>]<span class="tok-kw">const</span> <span class="tok-type">u8</span>, &amp;arr), &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L992">    }</span>
<span class="line" id="L993">}</span>
<span class="line" id="L994"></span>
<span class="line" id="L995"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - struct&quot;</span> {</span>
<span class="line" id="L996">    <span class="tok-kw">try</span> t(<span class="tok-kw">struct</span> {}{}, &amp;[_]Token{</span>
<span class="line" id="L997">        .{ .Struct = .{ .name = <span class="tok-str">&quot;&quot;</span>, .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L998">        .{ .StructEnd = {} },</span>
<span class="line" id="L999">    });</span>
<span class="line" id="L1000"></span>
<span class="line" id="L1001">    <span class="tok-kw">const</span> T = <span class="tok-kw">struct</span> { a: <span class="tok-type">i32</span>, b: <span class="tok-type">i32</span>, c: <span class="tok-type">i32</span> };</span>
<span class="line" id="L1002"></span>
<span class="line" id="L1003">    <span class="tok-kw">try</span> t(T{ .a = <span class="tok-number">1</span>, .b = <span class="tok-number">2</span>, .c = <span class="tok-number">3</span> }, &amp;[_]Token{</span>
<span class="line" id="L1004">        .{ .Struct = .{ .name = <span class="tok-str">&quot;T&quot;</span>, .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L1005">        .{ .String = <span class="tok-str">&quot;a&quot;</span> },</span>
<span class="line" id="L1006">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1007">        .{ .String = <span class="tok-str">&quot;b&quot;</span> },</span>
<span class="line" id="L1008">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L1009">        .{ .String = <span class="tok-str">&quot;c&quot;</span> },</span>
<span class="line" id="L1010">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L1011">        .{ .StructEnd = {} },</span>
<span class="line" id="L1012">    });</span>
<span class="line" id="L1013">}</span>
<span class="line" id="L1014"></span>
<span class="line" id="L1015"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - tail queue&quot;</span> {</span>
<span class="line" id="L1016">    {</span>
<span class="line" id="L1017">        <span class="tok-kw">var</span> expected = std.TailQueue(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L1018"></span>
<span class="line" id="L1019">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L1020">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L1021">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1022">        });</span>
<span class="line" id="L1023">    }</span>
<span class="line" id="L1024"></span>
<span class="line" id="L1025">    {</span>
<span class="line" id="L1026">        <span class="tok-kw">var</span> expected = std.TailQueue(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L1027">        <span class="tok-kw">var</span> one = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L1028">        <span class="tok-kw">var</span> two = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L1029">        <span class="tok-kw">var</span> three = <span class="tok-builtin">@TypeOf</span>(expected).Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L1030"></span>
<span class="line" id="L1031">        expected.append(&amp;one);</span>
<span class="line" id="L1032">        expected.append(&amp;two);</span>
<span class="line" id="L1033">        expected.append(&amp;three);</span>
<span class="line" id="L1034"></span>
<span class="line" id="L1035">        <span class="tok-kw">try</span> t(expected, &amp;[_]Token{</span>
<span class="line" id="L1036">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L1037">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1038">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L1039">            .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L1040">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1041">        });</span>
<span class="line" id="L1042">    }</span>
<span class="line" id="L1043"></span>
<span class="line" id="L1044">    {</span>
<span class="line" id="L1045">        <span class="tok-kw">const</span> Child = std.TailQueue(<span class="tok-type">i32</span>);</span>
<span class="line" id="L1046">        <span class="tok-kw">const</span> Parent = std.TailQueue(Child);</span>
<span class="line" id="L1047"></span>
<span class="line" id="L1048">        <span class="tok-kw">var</span> expected = Parent{};</span>
<span class="line" id="L1049">        <span class="tok-kw">var</span> a = Child{};</span>
<span class="line" id="L1050">        <span class="tok-kw">var</span> b = Child{};</span>
<span class="line" id="L1051">        <span class="tok-kw">var</span> c = Child{};</span>
<span class="line" id="L1052"></span>
<span class="line" id="L1053">        <span class="tok-kw">var</span> one = Child.Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L1054">        <span class="tok-kw">var</span> two = Child.Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L1055">        <span class="tok-kw">var</span> three = Child.Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L1056">        b.append(&amp;one);</span>
<span class="line" id="L1057">        c.append(&amp;two);</span>
<span class="line" id="L1058">        c.append(&amp;three);</span>
<span class="line" id="L1059"></span>
<span class="line" id="L1060">        expected.append(&amp;Parent.Node{ .data = a });</span>
<span class="line" id="L1061">        expected.append(&amp;Parent.Node{ .data = b });</span>
<span class="line" id="L1062">        expected.append(&amp;Parent.Node{ .data = c });</span>
<span class="line" id="L1063"></span>
<span class="line" id="L1064">        <span class="tok-kw">const</span> tokens = &amp;[_]Token{</span>
<span class="line" id="L1065">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L1066">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L1067">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1068">            .{ .Seq = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L1069">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1070">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1071">            .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L1072">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L1073">            .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L1074">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1075">            .{ .SeqEnd = {} },</span>
<span class="line" id="L1076">        };</span>
<span class="line" id="L1077"></span>
<span class="line" id="L1078">        <span class="tok-comment">// Test manually since the `t` function cannot recursively test</span>
</span>
<span class="line" id="L1079">        <span class="tok-comment">// user-defined containers containers without ugly hacks.</span>
</span>
<span class="line" id="L1080">        <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L1081">        <span class="tok-kw">var</span> v = deserialize(test_allocator, Parent, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L1082">        <span class="tok-kw">defer</span> de.free(test_allocator, v);</span>
<span class="line" id="L1083"></span>
<span class="line" id="L1084">        <span class="tok-kw">try</span> expectEqual(expected.len, v.len);</span>
<span class="line" id="L1085">        <span class="tok-kw">var</span> iterator = expected.first;</span>
<span class="line" id="L1086">        <span class="tok-kw">while</span> (iterator) |node| : (iterator = node.next) {</span>
<span class="line" id="L1087">            <span class="tok-kw">var</span> got_node = v.popFirst();</span>
<span class="line" id="L1088">            <span class="tok-kw">try</span> expect(got_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L1089">            <span class="tok-kw">defer</span> test_allocator.destroy(got_node.?);</span>
<span class="line" id="L1090"></span>
<span class="line" id="L1091">            <span class="tok-kw">try</span> expectEqual(node.data.len, got_node.?.data.len);</span>
<span class="line" id="L1092">            <span class="tok-kw">var</span> inner_iterator = node.data.first;</span>
<span class="line" id="L1093">            <span class="tok-kw">while</span> (inner_iterator) |inner_node| : (inner_iterator = inner_node.next) {</span>
<span class="line" id="L1094">                <span class="tok-kw">var</span> got_inner_node = got_node.?.data.popFirst();</span>
<span class="line" id="L1095">                <span class="tok-kw">try</span> expect(got_inner_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L1096">                <span class="tok-kw">defer</span> test_allocator.destroy(got_inner_node.?);</span>
<span class="line" id="L1097"></span>
<span class="line" id="L1098">                <span class="tok-kw">try</span> expectEqual(inner_node.data, got_inner_node.?.data);</span>
<span class="line" id="L1099">            }</span>
<span class="line" id="L1100">        }</span>
<span class="line" id="L1101">    }</span>
<span class="line" id="L1102">}</span>
<span class="line" id="L1103"></span>
<span class="line" id="L1104"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - tuple&quot;</span> {</span>
<span class="line" id="L1105">    <span class="tok-kw">try</span> t(std.meta.Tuple(&amp;[_]<span class="tok-type">type</span>{ <span class="tok-type">i32</span>, <span class="tok-type">u32</span> }){ <span class="tok-number">1</span>, <span class="tok-number">2</span> }, &amp;[_]Token{</span>
<span class="line" id="L1106">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L1107">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1108">        .{ .U32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L1109">        .{ .SeqEnd = {} },</span>
<span class="line" id="L1110">    });</span>
<span class="line" id="L1111"></span>
<span class="line" id="L1112">    <span class="tok-comment">//try t(std.meta.Tuple(&amp;[_]type{</span>
</span>
<span class="line" id="L1113">    <span class="tok-comment">//std.meta.Tuple(&amp;[_]type{ i32, i32 }),</span>
</span>
<span class="line" id="L1114">    <span class="tok-comment">//std.meta.Tuple(&amp;[_]type{ i32, i32 }),</span>
</span>
<span class="line" id="L1115">    <span class="tok-comment">//std.meta.Tuple(&amp;[_]type{ i32, i32 }),</span>
</span>
<span class="line" id="L1116">    <span class="tok-comment">//}){ .{ 1, 2 }, .{ 3, 4 }, .{ 5, 6 } }, &amp;[_]Token{</span>
</span>
<span class="line" id="L1117">    <span class="tok-comment">//.{ .Seq = .{ .len = 3 } },</span>
</span>
<span class="line" id="L1118">    <span class="tok-comment">//.{ .Seq = .{ .len = 2 } },</span>
</span>
<span class="line" id="L1119">    <span class="tok-comment">//.{ .I32 = 1 },</span>
</span>
<span class="line" id="L1120">    <span class="tok-comment">//.{ .I32 = 2 },</span>
</span>
<span class="line" id="L1121">    <span class="tok-comment">//.{ .SeqEnd = {} },</span>
</span>
<span class="line" id="L1122">    <span class="tok-comment">//.{ .Seq = .{ .len = 2 } },</span>
</span>
<span class="line" id="L1123">    <span class="tok-comment">//.{ .I32 = 3 },</span>
</span>
<span class="line" id="L1124">    <span class="tok-comment">//.{ .I32 = 4 },</span>
</span>
<span class="line" id="L1125">    <span class="tok-comment">//.{ .SeqEnd = {} },</span>
</span>
<span class="line" id="L1126">    <span class="tok-comment">//.{ .Seq = .{ .len = 2 } },</span>
</span>
<span class="line" id="L1127">    <span class="tok-comment">//.{ .I32 = 5 },</span>
</span>
<span class="line" id="L1128">    <span class="tok-comment">//.{ .I32 = 6 },</span>
</span>
<span class="line" id="L1129">    <span class="tok-comment">//.{ .SeqEnd = {} },</span>
</span>
<span class="line" id="L1130">    <span class="tok-comment">//.{ .SeqEnd = {} },</span>
</span>
<span class="line" id="L1131">    <span class="tok-comment">//});</span>
</span>
<span class="line" id="L1132">}</span>
<span class="line" id="L1133"></span>
<span class="line" id="L1134"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - union&quot;</span> {</span>
<span class="line" id="L1135">    <span class="tok-comment">// Tagged</span>
</span>
<span class="line" id="L1136">    {</span>
<span class="line" id="L1137">        <span class="tok-kw">const</span> T = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L1138">            foo: <span class="tok-type">bool</span>,</span>
<span class="line" id="L1139">            bar: <span class="tok-type">void</span>,</span>
<span class="line" id="L1140">        };</span>
<span class="line" id="L1141"></span>
<span class="line" id="L1142">        <span class="tok-kw">try</span> t(T{ .foo = <span class="tok-null">true</span> }, &amp;[_]Token{</span>
<span class="line" id="L1143">            .{ .Union = {} },</span>
<span class="line" id="L1144">            .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L1145">            .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L1146">        });</span>
<span class="line" id="L1147">        <span class="tok-kw">try</span> t(T{ .bar = {} }, &amp;[_]Token{</span>
<span class="line" id="L1148">            .{ .Union = {} },</span>
<span class="line" id="L1149">            .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L1150">            .{ .Void = {} },</span>
<span class="line" id="L1151">        });</span>
<span class="line" id="L1152">    }</span>
<span class="line" id="L1153"></span>
<span class="line" id="L1154">    <span class="tok-comment">// Untagged</span>
</span>
<span class="line" id="L1155">    {</span>
<span class="line" id="L1156">        <span class="tok-kw">const</span> T = <span class="tok-kw">union</span> {</span>
<span class="line" id="L1157">            foo: <span class="tok-type">bool</span>,</span>
<span class="line" id="L1158">            bar: <span class="tok-type">void</span>,</span>
<span class="line" id="L1159">        };</span>
<span class="line" id="L1160"></span>
<span class="line" id="L1161">        {</span>
<span class="line" id="L1162">            <span class="tok-kw">const</span> tokens = &amp;[_]Token{</span>
<span class="line" id="L1163">                .{ .Union = {} },</span>
<span class="line" id="L1164">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L1165">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L1166">            };</span>
<span class="line" id="L1167"></span>
<span class="line" id="L1168">            <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L1169">            <span class="tok-kw">const</span> v = deserialize(test_allocator, T, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L1170"></span>
<span class="line" id="L1171">            <span class="tok-kw">try</span> expectEqual(<span class="tok-null">true</span>, v.foo);</span>
<span class="line" id="L1172">        }</span>
<span class="line" id="L1173"></span>
<span class="line" id="L1174">        {</span>
<span class="line" id="L1175">            <span class="tok-kw">const</span> tokens = &amp;[_]Token{</span>
<span class="line" id="L1176">                .{ .Union = {} },</span>
<span class="line" id="L1177">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L1178">                .{ .Void = {} },</span>
<span class="line" id="L1179">            };</span>
<span class="line" id="L1180"></span>
<span class="line" id="L1181">            <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L1182">            <span class="tok-kw">const</span> v = deserialize(test_allocator, T, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L1183"></span>
<span class="line" id="L1184">            <span class="tok-kw">try</span> expectEqual({}, v.bar);</span>
<span class="line" id="L1185">        }</span>
<span class="line" id="L1186">    }</span>
<span class="line" id="L1187">}</span>
<span class="line" id="L1188"></span>
<span class="line" id="L1189"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - void&quot;</span> {</span>
<span class="line" id="L1190">    <span class="tok-kw">try</span> t({}, &amp;[_]Token{.{ .Void = {} }});</span>
<span class="line" id="L1191">}</span>
<span class="line" id="L1192"></span>
<span class="line" id="L1193"><span class="tok-comment">/// This test function does not support:</span></span>
<span class="line" id="L1194"><span class="tok-comment">///</span></span>
<span class="line" id="L1195"><span class="tok-comment">/// - Untagged unions</span></span>
<span class="line" id="L1196"><span class="tok-comment">/// - Recursive, user-defined containers (e.g., std.ArrayList(std.ArrayList(u8))).</span></span>
<span class="line" id="L1197"><span class="tok-kw">fn</span> <span class="tok-fn">t</span>(expected: <span class="tok-kw">anytype</span>, tokens: []<span class="tok-kw">const</span> Token) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1198">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(expected);</span>
<span class="line" id="L1199"></span>
<span class="line" id="L1200">    <span class="tok-kw">var</span> d = TestDeserializer.init(tokens);</span>
<span class="line" id="L1201">    <span class="tok-kw">var</span> v = deserialize(test_allocator, T, d.deserializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L1202">    <span class="tok-kw">defer</span> de.free(test_allocator, v);</span>
<span class="line" id="L1203"></span>
<span class="line" id="L1204">    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L1205">        .Bool,</span>
<span class="line" id="L1206">        .Enum,</span>
<span class="line" id="L1207">        .Float,</span>
<span class="line" id="L1208">        .Int,</span>
<span class="line" id="L1209">        .Optional,</span>
<span class="line" id="L1210">        .Void,</span>
<span class="line" id="L1211">        =&gt; <span class="tok-kw">try</span> expectEqual(expected, v),</span>
<span class="line" id="L1212">        .Array =&gt; |info| <span class="tok-kw">try</span> expectEqualSlices(info.child, &amp;expected, &amp;v),</span>
<span class="line" id="L1213">        .Pointer =&gt; |info| <span class="tok-kw">switch</span> (<span class="tok-kw">comptime</span> std.meta.trait.isZigString(T)) {</span>
<span class="line" id="L1214">            <span class="tok-null">true</span> =&gt; <span class="tok-kw">try</span> expectEqualStrings(expected, v),</span>
<span class="line" id="L1215">            <span class="tok-null">false</span> =&gt; <span class="tok-kw">switch</span> (info.size) {</span>
<span class="line" id="L1216">                <span class="tok-comment">//.One =&gt; ,</span>
</span>
<span class="line" id="L1217">                .Slice =&gt; <span class="tok-kw">try</span> expectEqualSlices(info.child, expected, v),</span>
<span class="line" id="L1218">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1219">            },</span>
<span class="line" id="L1220">        },</span>
<span class="line" id="L1221">        .Struct =&gt; |info| {</span>
<span class="line" id="L1222">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, <span class="tok-builtin">@typeName</span>(T), <span class="tok-str">&quot;array_list&quot;</span>)) {</span>
<span class="line" id="L1223">                <span class="tok-kw">try</span> expectEqual(expected.capacity, v.capacity);</span>
<span class="line" id="L1224">                <span class="tok-kw">try</span> expectEqualSlices(std.meta.Child(T.Slice), expected.items, v.items);</span>
<span class="line" id="L1225">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, <span class="tok-builtin">@typeName</span>(T), <span class="tok-str">&quot;linked_list.SinglyLinkedList&quot;</span>)) {</span>
<span class="line" id="L1226">                <span class="tok-kw">try</span> expectEqual(expected.len(), v.len());</span>
<span class="line" id="L1227">                <span class="tok-kw">var</span> iterator = expected.first;</span>
<span class="line" id="L1228"></span>
<span class="line" id="L1229">                <span class="tok-kw">while</span> (iterator) |node| : (iterator = node.next) {</span>
<span class="line" id="L1230">                    <span class="tok-kw">var</span> got_node = v.popFirst();</span>
<span class="line" id="L1231">                    <span class="tok-kw">try</span> expect(got_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L1232">                    <span class="tok-kw">defer</span> test_allocator.destroy(got_node.?);</span>
<span class="line" id="L1233"></span>
<span class="line" id="L1234">                    <span class="tok-kw">try</span> expectEqual(node.data, got_node.?.data);</span>
<span class="line" id="L1235">                }</span>
<span class="line" id="L1236">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.startsWith(<span class="tok-type">u8</span>, <span class="tok-builtin">@typeName</span>(T), <span class="tok-str">&quot;linked_list.TailQueue&quot;</span>)) {</span>
<span class="line" id="L1237">                <span class="tok-kw">try</span> expectEqual(expected.len, v.len);</span>
<span class="line" id="L1238">                <span class="tok-kw">var</span> iterator = expected.first;</span>
<span class="line" id="L1239"></span>
<span class="line" id="L1240">                <span class="tok-kw">while</span> (iterator) |node| : (iterator = node.next) {</span>
<span class="line" id="L1241">                    <span class="tok-kw">var</span> got_node = v.popFirst();</span>
<span class="line" id="L1242">                    <span class="tok-kw">try</span> expect(got_node != <span class="tok-null">null</span>);</span>
<span class="line" id="L1243">                    <span class="tok-kw">defer</span> test_allocator.destroy(got_node.?);</span>
<span class="line" id="L1244"></span>
<span class="line" id="L1245">                    <span class="tok-kw">try</span> expectEqual(node.data, got_node.?.data);</span>
<span class="line" id="L1246">                }</span>
<span class="line" id="L1247">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (T == std.BufMap) {</span>
<span class="line" id="L1248">                <span class="tok-kw">try</span> expectEqual(expected.count(), v.count());</span>
<span class="line" id="L1249"></span>
<span class="line" id="L1250">                <span class="tok-kw">var</span> it = expected.iterator();</span>
<span class="line" id="L1251">                <span class="tok-kw">while</span> (it.next()) |kv| {</span>
<span class="line" id="L1252">                    <span class="tok-kw">try</span> expectEqualSlices(<span class="tok-type">u8</span>, expected.get(kv.key_ptr.*).?, v.get(kv.key_ptr.*).?);</span>
<span class="line" id="L1253">                }</span>
<span class="line" id="L1254">            } <span class="tok-kw">else</span> <span class="tok-kw">switch</span> (info.is_tuple) {</span>
<span class="line" id="L1255">                <span class="tok-null">true</span> =&gt; {</span>
<span class="line" id="L1256">                    <span class="tok-kw">const</span> length = std.meta.fields(T).len;</span>
<span class="line" id="L1257">                    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1258"></span>
<span class="line" id="L1259">                    <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; length) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1260">                        <span class="tok-kw">try</span> expectEqual(expected[i], v[i]);</span>
<span class="line" id="L1261">                    }</span>
<span class="line" id="L1262">                },</span>
<span class="line" id="L1263">                <span class="tok-null">false</span> =&gt; <span class="tok-kw">try</span> expectEqual(expected, v),</span>
<span class="line" id="L1264">            }</span>
<span class="line" id="L1265">        },</span>
<span class="line" id="L1266">        .Union =&gt; |info| {</span>
<span class="line" id="L1267">            <span class="tok-kw">if</span> (info.tag_type == <span class="tok-null">null</span>) {</span>
<span class="line" id="L1268">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;untagged unions are not supported by this function&quot;</span>);</span>
<span class="line" id="L1269">            }</span>
<span class="line" id="L1270"></span>
<span class="line" id="L1271">            <span class="tok-kw">try</span> expectEqual(expected, v);</span>
<span class="line" id="L1272">        },</span>
<span class="line" id="L1273">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1274">    }</span>
<span class="line" id="L1275"></span>
<span class="line" id="L1276">    <span class="tok-kw">try</span> expect(d.remaining() == <span class="tok-number">0</span>);</span>
<span class="line" id="L1277">}</span>
<span class="line" id="L1278"></span>
<span class="line" id="L1279"><span class="tok-kw">comptime</span> {</span>
<span class="line" id="L1280">    std.testing.refAllDecls(<span class="tok-builtin">@This</span>());</span>
<span class="line" id="L1281">}</span>
<span class="line" id="L1282"></span>
</code></pre></body>
</html>