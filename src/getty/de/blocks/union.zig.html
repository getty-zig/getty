<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>de/blocks/union.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> DeserializerInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/deserializer.zig&quot;</span>).Deserializer;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> getAttributes = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../attributes.zig&quot;</span>).getAttributes;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> getty_deserialize = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../deserialize.zig&quot;</span>).deserialize;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> getty_error = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../error.zig&quot;</span>).Error;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> getty_free = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../free.zig&quot;</span>).free;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> MapAccessInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/map_access.zig&quot;</span>).MapAccess;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> SeqAccessInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/seq_access.zig&quot;</span>).SeqAccess;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> Tag = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../../attributes.zig&quot;</span>).Tag;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> testing = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../testing.zig&quot;</span>);</span>
<span class="line" id="L12"><span class="tok-kw">const</span> UnionAccessInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/union_access.zig&quot;</span>).UnionAccess;</span>
<span class="line" id="L13"><span class="tok-kw">const</span> UnionVisitor = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../impls/visitor/union.zig&quot;</span>).Visitor;</span>
<span class="line" id="L14"><span class="tok-kw">const</span> VariantAccessInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/variant_access.zig&quot;</span>).VariantAccess;</span>
<span class="line" id="L15"><span class="tok-kw">const</span> VisitorInterface = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../interfaces/visitor.zig&quot;</span>).Visitor;</span>
<span class="line" id="L16"></span>
<span class="line" id="L17"><span class="tok-comment">/// Specifies all types that can be deserialized by this block.</span></span>
<span class="line" id="L18"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">is</span>(</span>
<span class="line" id="L19">    <span class="tok-comment">/// The type being deserialized into.</span></span>
<span class="line" id="L20">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L21">) <span class="tok-type">bool</span> {</span>
<span class="line" id="L22">    <span class="tok-kw">return</span> <span class="tok-builtin">@typeInfo</span>(T) == .Union;</span>
<span class="line" id="L23">}</span>
<span class="line" id="L24"></span>
<span class="line" id="L25"><span class="tok-comment">/// Specifies the deserialization process for types relevant to this block.</span></span>
<span class="line" id="L26"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">deserialize</span>(</span>
<span class="line" id="L27">    <span class="tok-comment">/// An optional memory allocator.</span></span>
<span class="line" id="L28">    ally: ?std.mem.Allocator,</span>
<span class="line" id="L29">    <span class="tok-comment">/// The type being deserialized into.</span></span>
<span class="line" id="L30">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L31">    <span class="tok-comment">/// A `getty.Deserializer` interface value.</span></span>
<span class="line" id="L32">    deserializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L33">    <span class="tok-comment">/// A `getty.de.Visitor` interface value.</span></span>
<span class="line" id="L34">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L35">) <span class="tok-builtin">@TypeOf</span>(deserializer).Error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L36">    <span class="tok-kw">const</span> tag: Tag = <span class="tok-kw">comptime</span> blk: {</span>
<span class="line" id="L37">        <span class="tok-kw">const</span> attributes = getAttributes(T, <span class="tok-builtin">@TypeOf</span>(deserializer));</span>
<span class="line" id="L38"></span>
<span class="line" id="L39">        <span class="tok-kw">if</span> (attributes) |attrs| {</span>
<span class="line" id="L40">            <span class="tok-kw">if</span> (<span class="tok-builtin">@hasField</span>(<span class="tok-builtin">@TypeOf</span>(attrs), <span class="tok-str">&quot;Container&quot;</span>)) {</span>
<span class="line" id="L41">                <span class="tok-kw">if</span> (<span class="tok-builtin">@hasField</span>(<span class="tok-builtin">@TypeOf</span>(attrs.Container), <span class="tok-str">&quot;tag&quot;</span>)) {</span>
<span class="line" id="L42">                    <span class="tok-kw">break</span> :blk attrs.Container.tag;</span>
<span class="line" id="L43">                }</span>
<span class="line" id="L44">            }</span>
<span class="line" id="L45">        }</span>
<span class="line" id="L46"></span>
<span class="line" id="L47">        <span class="tok-kw">break</span> :blk .external;</span>
<span class="line" id="L48">    };</span>
<span class="line" id="L49"></span>
<span class="line" id="L50">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (tag) {</span>
<span class="line" id="L51">        .external =&gt; <span class="tok-kw">try</span> deserializeExternallyTaggedUnion(ally, deserializer, visitor),</span>
<span class="line" id="L52">        .untagged =&gt; <span class="tok-kw">try</span> deserializeUntaggedUnion(ally, T, deserializer, visitor),</span>
<span class="line" id="L53">        .internal =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;TODO: internally tagged representation&quot;</span>),</span>
<span class="line" id="L54">    };</span>
<span class="line" id="L55">}</span>
<span class="line" id="L56"></span>
<span class="line" id="L57"><span class="tok-kw">fn</span> <span class="tok-fn">deserializeExternallyTaggedUnion</span>(</span>
<span class="line" id="L58">    ally: ?std.mem.Allocator,</span>
<span class="line" id="L59">    deserializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L60">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L61">) <span class="tok-builtin">@TypeOf</span>(deserializer).Error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L62">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> deserializer.deserializeUnion(ally, visitor);</span>
<span class="line" id="L63">}</span>
<span class="line" id="L64"></span>
<span class="line" id="L65"><span class="tok-comment">// Untagged unions are only supported in self-describing formats.</span>
</span>
<span class="line" id="L66"><span class="tok-kw">fn</span> <span class="tok-fn">deserializeUntaggedUnion</span>(</span>
<span class="line" id="L67">    ally: ?std.mem.Allocator,</span>
<span class="line" id="L68">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L69">    deserializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L70">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L71">) <span class="tok-builtin">@TypeOf</span>(deserializer).Error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L72">    <span class="tok-comment">// Deserialize the input data into a Content value.</span>
</span>
<span class="line" id="L73">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L74">    <span class="tok-comment">// This intermediate value allows us to repeatedly attempt deserialization</span>
</span>
<span class="line" id="L75">    <span class="tok-comment">// for each variant of the untagged union, without further modifying the</span>
</span>
<span class="line" id="L76">    <span class="tok-comment">// actual input data of the deserializer.</span>
</span>
<span class="line" id="L77">    <span class="tok-kw">var</span> content = <span class="tok-kw">try</span> getty_deserialize(ally, Content, deserializer);</span>
<span class="line" id="L78">    <span class="tok-kw">defer</span> <span class="tok-kw">switch</span> (content) {</span>
<span class="line" id="L79">        .Int, .Map, .Seq, .String, .Some =&gt; {</span>
<span class="line" id="L80">            <span class="tok-comment">// If content was successfully deserialized, and we're here, then</span>
</span>
<span class="line" id="L81">            <span class="tok-comment">// that means allocator must've not been null.</span>
</span>
<span class="line" id="L82">            std.debug.assert(ally != <span class="tok-null">null</span>);</span>
<span class="line" id="L83">            getty_free(ally.?, <span class="tok-builtin">@TypeOf</span>(deserializer), content);</span>
<span class="line" id="L84">        },</span>
<span class="line" id="L85">        <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L86">    };</span>
<span class="line" id="L87"></span>
<span class="line" id="L88">    <span class="tok-comment">// Deserialize the Content value into a value of type T.</span>
</span>
<span class="line" id="L89">    <span class="tok-kw">var</span> cd = ContentDeserializer{ .content = content };</span>
<span class="line" id="L90">    <span class="tok-kw">const</span> d = cd.deserializer();</span>
<span class="line" id="L91"></span>
<span class="line" id="L92">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (std.meta.fields(T)) |field| {</span>
<span class="line" id="L93">        <span class="tok-kw">if</span> (getty_deserialize(ally, field.<span class="tok-type">type</span>, d)) |value| {</span>
<span class="line" id="L94">            <span class="tok-kw">var</span> tuva = TransparentUnionVariantAccess(<span class="tok-builtin">@TypeOf</span>(field.name), <span class="tok-builtin">@TypeOf</span>(value)){</span>
<span class="line" id="L95">                .variant = field.name,</span>
<span class="line" id="L96">                .payload = value,</span>
<span class="line" id="L97">            };</span>
<span class="line" id="L98">            <span class="tok-kw">const</span> ua = tuva.unionAccess();</span>
<span class="line" id="L99">            <span class="tok-kw">const</span> va = tuva.variantAccess();</span>
<span class="line" id="L100"></span>
<span class="line" id="L101">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitUnion(ally, <span class="tok-builtin">@TypeOf</span>(d), ua, va);</span>
<span class="line" id="L102">        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L103">            <span class="tok-kw">error</span>.DuplicateField,</span>
<span class="line" id="L104">            <span class="tok-kw">error</span>.InvalidLength,</span>
<span class="line" id="L105">            <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L106">            <span class="tok-kw">error</span>.MissingField,</span>
<span class="line" id="L107">            <span class="tok-kw">error</span>.MissingVariant,</span>
<span class="line" id="L108">            <span class="tok-kw">error</span>.UnknownField,</span>
<span class="line" id="L109">            <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L110">            =&gt; {},</span>
<span class="line" id="L111">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L112">        }</span>
<span class="line" id="L113">    }</span>
<span class="line" id="L114"></span>
<span class="line" id="L115">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingVariant;</span>
<span class="line" id="L116">}</span>
<span class="line" id="L117"></span>
<span class="line" id="L118"><span class="tok-kw">const</span> ContentMap = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L119">    key: Content,</span>
<span class="line" id="L120">    value: Content,</span>
<span class="line" id="L121">};</span>
<span class="line" id="L122"></span>
<span class="line" id="L123"><span class="tok-kw">const</span> ContentDeserializerMap = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L124">    key: ContentDeserializer,</span>
<span class="line" id="L125">    value: ContentDeserializer,</span>
<span class="line" id="L126">};</span>
<span class="line" id="L127"></span>
<span class="line" id="L128"><span class="tok-kw">const</span> ContentMultiArrayList = std.MultiArrayList(ContentMap);</span>
<span class="line" id="L129"><span class="tok-kw">const</span> ContentDeserializerMultiArrayList = std.MultiArrayList(ContentDeserializerMap);</span>
<span class="line" id="L130"></span>
<span class="line" id="L131"><span class="tok-comment">// Does not support compile-time known types.</span>
</span>
<span class="line" id="L132"><span class="tok-kw">const</span> Content = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L133">    Bool: <span class="tok-type">bool</span>,</span>
<span class="line" id="L134">    F16: <span class="tok-type">f16</span>,</span>
<span class="line" id="L135">    F32: <span class="tok-type">f32</span>,</span>
<span class="line" id="L136">    F64: <span class="tok-type">f64</span>,</span>
<span class="line" id="L137">    F128: <span class="tok-type">f128</span>,</span>
<span class="line" id="L138">    Int: std.math.big.int.Managed,</span>
<span class="line" id="L139">    Map: ContentMultiArrayList,</span>
<span class="line" id="L140">    Null,</span>
<span class="line" id="L141">    Seq: std.ArrayList(Content),</span>
<span class="line" id="L142">    Some: *Content,</span>
<span class="line" id="L143">    String: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L144">    Void,</span>
<span class="line" id="L145"></span>
<span class="line" id="L146">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">deinit</span>(self: Content, ally: std.mem.Allocator) <span class="tok-type">void</span> {</span>
<span class="line" id="L147">        <span class="tok-kw">switch</span> (self) {</span>
<span class="line" id="L148">            .Int =&gt; |v| {</span>
<span class="line" id="L149">                <span class="tok-kw">var</span> mut = v;</span>
<span class="line" id="L150">                mut.deinit();</span>
<span class="line" id="L151">            },</span>
<span class="line" id="L152">            .Seq =&gt; |v| {</span>
<span class="line" id="L153">                <span class="tok-kw">for</span> (v.items) |elem| elem.deinit(ally);</span>
<span class="line" id="L154">                v.deinit();</span>
<span class="line" id="L155">            },</span>
<span class="line" id="L156">            .Map =&gt; |v| {</span>
<span class="line" id="L157">                <span class="tok-kw">for</span> (v.items(.key), v.items(.value)) |key, value| {</span>
<span class="line" id="L158">                    key.deinit(ally);</span>
<span class="line" id="L159">                    value.deinit(ally);</span>
<span class="line" id="L160">                }</span>
<span class="line" id="L161">                <span class="tok-kw">var</span> mut = v;</span>
<span class="line" id="L162">                mut.deinit(ally);</span>
<span class="line" id="L163">            },</span>
<span class="line" id="L164">            .String =&gt; |v| ally.free(v),</span>
<span class="line" id="L165">            .Some =&gt; |v| {</span>
<span class="line" id="L166">                v.deinit(ally);</span>
<span class="line" id="L167">                ally.destroy(v);</span>
<span class="line" id="L168">            },</span>
<span class="line" id="L169">            <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L170">        }</span>
<span class="line" id="L171">    }</span>
<span class="line" id="L172"></span>
<span class="line" id="L173">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L174">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">deserialize</span>(</span>
<span class="line" id="L175">            ally: ?std.mem.Allocator,</span>
<span class="line" id="L176">            <span class="tok-kw">comptime</span> _: <span class="tok-type">type</span>,</span>
<span class="line" id="L177">            deserializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L178">            visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L179">        ) !<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L180">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> deserializer.deserializeAny(ally, visitor);</span>
<span class="line" id="L181">        }</span>
<span class="line" id="L182"></span>
<span class="line" id="L183">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Visitor</span>(<span class="tok-kw">comptime</span> _: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L184">            <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L185">                <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> VisitorInterface(</span>
<span class="line" id="L186">                    <span class="tok-builtin">@This</span>(),</span>
<span class="line" id="L187">                    Content,</span>
<span class="line" id="L188">                    .{</span>
<span class="line" id="L189">                        .visitBool = visitBool,</span>
<span class="line" id="L190">                        .visitFloat = visitFloat,</span>
<span class="line" id="L191">                        .visitInt = visitInt,</span>
<span class="line" id="L192">                        .visitMap = visitMap,</span>
<span class="line" id="L193">                        .visitNull = visitNull,</span>
<span class="line" id="L194">                        .visitSeq = visitSeq,</span>
<span class="line" id="L195">                        .visitSome = visitSome,</span>
<span class="line" id="L196">                        .visitString = visitString,</span>
<span class="line" id="L197">                        .visitUnion = visitUnion,</span>
<span class="line" id="L198">                        .visitVoid = visitVoid,</span>
<span class="line" id="L199">                    },</span>
<span class="line" id="L200">                );</span>
<span class="line" id="L201"></span>
<span class="line" id="L202">                <span class="tok-kw">fn</span> <span class="tok-fn">visitBool</span>(_: <span class="tok-builtin">@This</span>(), _: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, input: <span class="tok-type">bool</span>) Deserializer.Error!Content {</span>
<span class="line" id="L203">                    <span class="tok-kw">return</span> .{ .Bool = input };</span>
<span class="line" id="L204">                }</span>
<span class="line" id="L205"></span>
<span class="line" id="L206">                <span class="tok-kw">fn</span> <span class="tok-fn">visitFloat</span>(_: <span class="tok-builtin">@This</span>(), _: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, input: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L207">                    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-builtin">@TypeOf</span>(input)) {</span>
<span class="line" id="L208">                        <span class="tok-type">f16</span> =&gt; .{ .F16 = input },</span>
<span class="line" id="L209">                        <span class="tok-type">f32</span> =&gt; .{ .F32 = input },</span>
<span class="line" id="L210">                        <span class="tok-type">f64</span> =&gt; .{ .F64 = input },</span>
<span class="line" id="L211">                        <span class="tok-type">f128</span> =&gt; .{ .F128 = input },</span>
<span class="line" id="L212">                        <span class="tok-type">comptime_float</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;comptime_float is not supported&quot;</span>),</span>
<span class="line" id="L213">                        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// UNREACHABLE: The Visitor interface guarantees that input is a float.</span>
</span>
<span class="line" id="L214">                    };</span>
<span class="line" id="L215">                }</span>
<span class="line" id="L216"></span>
<span class="line" id="L217">                <span class="tok-kw">fn</span> <span class="tok-fn">visitInt</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, input: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L218">                    <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L219">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L220">                    }</span>
<span class="line" id="L221"></span>
<span class="line" id="L222">                    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(input))) {</span>
<span class="line" id="L223">                        .Int =&gt; .{ .Int = <span class="tok-kw">try</span> std.math.big.int.Managed.initSet(ally.?, input) },</span>
<span class="line" id="L224">                        .ComptimeInt =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;comptime_int is not supported&quot;</span>),</span>
<span class="line" id="L225">                        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>, <span class="tok-comment">// UNREACHABLE: The Visitor interface guarantees that input is an integer.</span>
</span>
<span class="line" id="L226">                    };</span>
<span class="line" id="L227">                }</span>
<span class="line" id="L228"></span>
<span class="line" id="L229">                <span class="tok-kw">fn</span> <span class="tok-fn">visitMap</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, mapAccess: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L230">                    <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L231">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L232">                    }</span>
<span class="line" id="L233"></span>
<span class="line" id="L234">                    <span class="tok-kw">var</span> map = ContentMultiArrayList{};</span>
<span class="line" id="L235">                    <span class="tok-kw">errdefer</span> map.deinit(ally.?);</span>
<span class="line" id="L236"></span>
<span class="line" id="L237">                    <span class="tok-kw">while</span> (<span class="tok-kw">try</span> mapAccess.nextKey(ally.?, Content)) |key| {</span>
<span class="line" id="L238">                        <span class="tok-kw">errdefer</span> <span class="tok-kw">if</span> (mapAccess.isKeyAllocated(<span class="tok-builtin">@TypeOf</span>(key))) {</span>
<span class="line" id="L239">                            getty_free(ally.?, Deserializer, key);</span>
<span class="line" id="L240">                        };</span>
<span class="line" id="L241"></span>
<span class="line" id="L242">                        <span class="tok-kw">const</span> value = <span class="tok-kw">try</span> mapAccess.nextValue(ally, Content);</span>
<span class="line" id="L243">                        <span class="tok-kw">errdefer</span> getty_free(ally.?, Deserializer, value);</span>
<span class="line" id="L244"></span>
<span class="line" id="L245">                        <span class="tok-kw">try</span> map.append(ally.?, .{</span>
<span class="line" id="L246">                            .key = key,</span>
<span class="line" id="L247">                            .value = value,</span>
<span class="line" id="L248">                        });</span>
<span class="line" id="L249">                    }</span>
<span class="line" id="L250"></span>
<span class="line" id="L251">                    <span class="tok-kw">return</span> .{ .Map = map };</span>
<span class="line" id="L252">                }</span>
<span class="line" id="L253"></span>
<span class="line" id="L254">                <span class="tok-kw">fn</span> <span class="tok-fn">visitNull</span>(_: <span class="tok-builtin">@This</span>(), _: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>) Deserializer.Error!Content {</span>
<span class="line" id="L255">                    <span class="tok-kw">return</span> .{ .Null = {} };</span>
<span class="line" id="L256">                }</span>
<span class="line" id="L257"></span>
<span class="line" id="L258">                <span class="tok-kw">fn</span> <span class="tok-fn">visitSeq</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, seqAccess: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L259">                    <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L260">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L261">                    }</span>
<span class="line" id="L262"></span>
<span class="line" id="L263">                    <span class="tok-kw">var</span> list = std.ArrayList(Content).init(ally.?);</span>
<span class="line" id="L264">                    <span class="tok-kw">errdefer</span> list.deinit();</span>
<span class="line" id="L265"></span>
<span class="line" id="L266">                    <span class="tok-kw">while</span> (<span class="tok-kw">try</span> seqAccess.nextElement(ally.?, Content)) |elem| {</span>
<span class="line" id="L267">                        <span class="tok-kw">try</span> list.append(elem);</span>
<span class="line" id="L268">                    }</span>
<span class="line" id="L269"></span>
<span class="line" id="L270">                    <span class="tok-kw">return</span> .{ .Seq = list };</span>
<span class="line" id="L271">                }</span>
<span class="line" id="L272"></span>
<span class="line" id="L273">                <span class="tok-kw">fn</span> <span class="tok-fn">visitSome</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, deserializer: <span class="tok-kw">anytype</span>) <span class="tok-builtin">@TypeOf</span>(deserializer).Error!Content {</span>
<span class="line" id="L274">                    <span class="tok-kw">return</span> .{ .Some = <span class="tok-kw">try</span> getty_deserialize(ally, *Content, deserializer) };</span>
<span class="line" id="L275">                }</span>
<span class="line" id="L276"></span>
<span class="line" id="L277">                <span class="tok-kw">fn</span> <span class="tok-fn">visitString</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, input: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L278">                    <span class="tok-kw">const</span> output = <span class="tok-kw">try</span> ally.?.alloc(<span class="tok-type">u8</span>, input.len);</span>
<span class="line" id="L279">                    std.mem.copy(<span class="tok-type">u8</span>, output, input);</span>
<span class="line" id="L280"></span>
<span class="line" id="L281">                    <span class="tok-kw">return</span> .{ .String = output };</span>
<span class="line" id="L282">                }</span>
<span class="line" id="L283"></span>
<span class="line" id="L284">                <span class="tok-kw">fn</span> <span class="tok-fn">visitUnion</span>(_: <span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>, ua: <span class="tok-kw">anytype</span>, va: <span class="tok-kw">anytype</span>) Deserializer.Error!Content {</span>
<span class="line" id="L285">                    <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L286">                        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L287">                    }</span>
<span class="line" id="L288"></span>
<span class="line" id="L289">                    <span class="tok-kw">var</span> variant = <span class="tok-kw">try</span> ua.variant(ally, Content);</span>
<span class="line" id="L290">                    <span class="tok-kw">errdefer</span> <span class="tok-kw">if</span> (ua.isVariantAllocated(<span class="tok-builtin">@TypeOf</span>(variant))) {</span>
<span class="line" id="L291">                        getty_free(ally.?, Deserializer, variant);</span>
<span class="line" id="L292">                    };</span>
<span class="line" id="L293"></span>
<span class="line" id="L294">                    <span class="tok-kw">var</span> payload = <span class="tok-kw">try</span> va.payload(ally.?, Content);</span>
<span class="line" id="L295">                    <span class="tok-kw">errdefer</span> getty_free(ally.?, Deserializer, payload);</span>
<span class="line" id="L296"></span>
<span class="line" id="L297">                    <span class="tok-kw">var</span> map = ContentMultiArrayList{};</span>
<span class="line" id="L298">                    <span class="tok-kw">errdefer</span> map.deinit(ally.?);</span>
<span class="line" id="L299"></span>
<span class="line" id="L300">                    <span class="tok-kw">try</span> map.append(ally.?, .{</span>
<span class="line" id="L301">                        .key = variant,</span>
<span class="line" id="L302">                        .value = payload,</span>
<span class="line" id="L303">                    });</span>
<span class="line" id="L304"></span>
<span class="line" id="L305">                    <span class="tok-kw">return</span> .{ .Map = map };</span>
<span class="line" id="L306">                }</span>
<span class="line" id="L307"></span>
<span class="line" id="L308">                <span class="tok-kw">fn</span> <span class="tok-fn">visitVoid</span>(_: <span class="tok-builtin">@This</span>(), _: ?std.mem.Allocator, <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>) Deserializer.Error!Content {</span>
<span class="line" id="L309">                    <span class="tok-kw">return</span> .{ .Void = {} };</span>
<span class="line" id="L310">                }</span>
<span class="line" id="L311">            };</span>
<span class="line" id="L312">        }</span>
<span class="line" id="L313"></span>
<span class="line" id="L314">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">free</span>(ally: std.mem.Allocator, <span class="tok-kw">comptime</span> _: <span class="tok-type">type</span>, value: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L315">            <span class="tok-kw">switch</span> (value) {</span>
<span class="line" id="L316">                .Int, .Map, .Seq, .String, .Some =&gt; value.deinit(ally),</span>
<span class="line" id="L317">                <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L318">            }</span>
<span class="line" id="L319">        }</span>
<span class="line" id="L320">    };</span>
<span class="line" id="L321">};</span>
<span class="line" id="L322"></span>
<span class="line" id="L323"><span class="tok-kw">const</span> ContentDeserializer = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L324">    content: Content,</span>
<span class="line" id="L325"></span>
<span class="line" id="L326">    <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L327"></span>
<span class="line" id="L328">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> DeserializerInterface(</span>
<span class="line" id="L329">        Self,</span>
<span class="line" id="L330">        getty_error,</span>
<span class="line" id="L331">        <span class="tok-null">null</span>,</span>
<span class="line" id="L332">        <span class="tok-null">null</span>,</span>
<span class="line" id="L333">        .{</span>
<span class="line" id="L334">            .deserializeAny = deserializeAny,</span>
<span class="line" id="L335">            .deserializeBool = deserializeBool,</span>
<span class="line" id="L336">            .deserializeEnum = deserializeEnum,</span>
<span class="line" id="L337">            .deserializeFloat = deserializeFloat,</span>
<span class="line" id="L338">            .deserializeInt = deserializeInt,</span>
<span class="line" id="L339">            .deserializeIgnored = deserializeIgnored,</span>
<span class="line" id="L340">            .deserializeMap = deserializeMap,</span>
<span class="line" id="L341">            .deserializeOptional = deserializeOptional,</span>
<span class="line" id="L342">            .deserializeSeq = deserializeSeq,</span>
<span class="line" id="L343">            .deserializeString = deserializeString,</span>
<span class="line" id="L344">            .deserializeStruct = deserializeMap,</span>
<span class="line" id="L345">            .deserializeUnion = deserializeUnion,</span>
<span class="line" id="L346">            .deserializeVoid = deserializeVoid,</span>
<span class="line" id="L347">        },</span>
<span class="line" id="L348">    );</span>
<span class="line" id="L349"></span>
<span class="line" id="L350">    <span class="tok-kw">const</span> De = Self.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L351"></span>
<span class="line" id="L352">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeAny</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L353">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L354">            .Bool =&gt; <span class="tok-kw">try</span> self.deserializeBool(ally, visitor),</span>
<span class="line" id="L355">            <span class="tok-kw">inline</span> .F16, .F32, .F64, .F128 =&gt; <span class="tok-kw">try</span> self.deserializeFloat(ally, visitor),</span>
<span class="line" id="L356">            .Int =&gt; blk: {</span>
<span class="line" id="L357">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> self.deserializeInt(ally, visitor);</span>
<span class="line" id="L358">            },</span>
<span class="line" id="L359">            .Map =&gt; |v| <span class="tok-kw">try</span> visitContentMap(ally, v, visitor),</span>
<span class="line" id="L360">            .Null =&gt; <span class="tok-kw">try</span> visitor.visitNull(ally, De),</span>
<span class="line" id="L361">            .Seq =&gt; |v| <span class="tok-kw">try</span> visitContentSeq(ally, v, visitor),</span>
<span class="line" id="L362">            .Some =&gt; |v| blk: {</span>
<span class="line" id="L363">                <span class="tok-kw">var</span> cd = Self{ .content = v.* };</span>
<span class="line" id="L364">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitSome(ally, cd.deserializer());</span>
<span class="line" id="L365">            },</span>
<span class="line" id="L366">            .String =&gt; <span class="tok-kw">try</span> self.deserializeString(ally, visitor),</span>
<span class="line" id="L367">            .Void =&gt; <span class="tok-kw">try</span> self.deserializeVoid(ally, visitor),</span>
<span class="line" id="L368">        };</span>
<span class="line" id="L369">    }</span>
<span class="line" id="L370"></span>
<span class="line" id="L371">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeBool</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L372">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L373">            .Bool =&gt; |v| <span class="tok-kw">try</span> visitor.visitBool(ally, De, v),</span>
<span class="line" id="L374">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L375">        };</span>
<span class="line" id="L376">    }</span>
<span class="line" id="L377"></span>
<span class="line" id="L378">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeEnum</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L379">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L380">            .Int =&gt; |v| blk: {</span>
<span class="line" id="L381">                <span class="tok-kw">const</span> int = v.to(<span class="tok-builtin">@TypeOf</span>(visitor).Value) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L382">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitInt(ally, De, int);</span>
<span class="line" id="L383">            },</span>
<span class="line" id="L384">            .String =&gt; |v| <span class="tok-kw">try</span> visitor.visitString(ally, De, v),</span>
<span class="line" id="L385">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L386">        };</span>
<span class="line" id="L387">    }</span>
<span class="line" id="L388"></span>
<span class="line" id="L389">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeFloat</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L390">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L391">            <span class="tok-kw">inline</span> .F16, .F32, .F64, .F128 =&gt; |v| <span class="tok-kw">try</span> visitor.visitFloat(ally, De, v),</span>
<span class="line" id="L392">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L393">        };</span>
<span class="line" id="L394">    }</span>
<span class="line" id="L395"></span>
<span class="line" id="L396">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeIgnored</span>(_: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L397">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitVoid(ally, De);</span>
<span class="line" id="L398">    }</span>
<span class="line" id="L399"></span>
<span class="line" id="L400">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeInt</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L401">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L402">            .Int =&gt; |v| blk: {</span>
<span class="line" id="L403">                <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> Value = <span class="tok-builtin">@TypeOf</span>(visitor).Value;</span>
<span class="line" id="L404"></span>
<span class="line" id="L405">                <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(Value) == .Int) {</span>
<span class="line" id="L406">                    <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitInt(ally, De, v.to(Value) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>);</span>
<span class="line" id="L407">                }</span>
<span class="line" id="L408"></span>
<span class="line" id="L409">                <span class="tok-kw">if</span> (v.isPositive()) {</span>
<span class="line" id="L410">                    <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitInt(ally, De, v.to(<span class="tok-type">u128</span>) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidValue);</span>
<span class="line" id="L411">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L412">                    <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitInt(ally, De, v.to(<span class="tok-type">i128</span>) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidValue);</span>
<span class="line" id="L413">                }</span>
<span class="line" id="L414">            },</span>
<span class="line" id="L415">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L416">        };</span>
<span class="line" id="L417">    }</span>
<span class="line" id="L418"></span>
<span class="line" id="L419">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeMap</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L420">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L421">            .Map =&gt; |v| <span class="tok-kw">try</span> visitContentMap(ally, v, visitor),</span>
<span class="line" id="L422">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L423">        };</span>
<span class="line" id="L424">    }</span>
<span class="line" id="L425"></span>
<span class="line" id="L426">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeOptional</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L427">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L428">            .Null =&gt; <span class="tok-kw">try</span> visitor.visitNull(ally, De),</span>
<span class="line" id="L429">            .Some =&gt; |v| blk: {</span>
<span class="line" id="L430">                <span class="tok-kw">var</span> cd = Self{ .content = v.* };</span>
<span class="line" id="L431">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitSome(ally, cd.deserializer());</span>
<span class="line" id="L432">            },</span>
<span class="line" id="L433">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L434">        };</span>
<span class="line" id="L435">    }</span>
<span class="line" id="L436"></span>
<span class="line" id="L437">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeSeq</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L438">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L439">            .Seq =&gt; |v| <span class="tok-kw">try</span> visitContentSeq(ally, v, visitor),</span>
<span class="line" id="L440">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L441">        };</span>
<span class="line" id="L442">    }</span>
<span class="line" id="L443"></span>
<span class="line" id="L444">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeString</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L445">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L446">            .String =&gt; |v| <span class="tok-kw">try</span> visitor.visitString(ally, De, v),</span>
<span class="line" id="L447">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L448">        };</span>
<span class="line" id="L449">    }</span>
<span class="line" id="L450"></span>
<span class="line" id="L451">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeUnion</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L452">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L453">            .Map =&gt; |mal| blk: {</span>
<span class="line" id="L454">                <span class="tok-kw">const</span> keys = mal.items(.key);</span>
<span class="line" id="L455">                <span class="tok-kw">const</span> values = mal.items(.value);</span>
<span class="line" id="L456"></span>
<span class="line" id="L457">                <span class="tok-kw">if</span> (mal.len != <span class="tok-number">1</span> <span class="tok-kw">or</span> keys.len != <span class="tok-number">1</span> <span class="tok-kw">or</span> values.len != <span class="tok-number">1</span>) {</span>
<span class="line" id="L458">                    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidValue;</span>
<span class="line" id="L459">                }</span>
<span class="line" id="L460"></span>
<span class="line" id="L461">                <span class="tok-kw">var</span> uva = UnionVariantAccess{ .key = keys[<span class="tok-number">0</span>], .value = values[<span class="tok-number">0</span>] };</span>
<span class="line" id="L462">                <span class="tok-kw">const</span> ua = uva.unionAccess();</span>
<span class="line" id="L463">                <span class="tok-kw">const</span> va = uva.variantAccess();</span>
<span class="line" id="L464"></span>
<span class="line" id="L465">                <span class="tok-kw">break</span> :blk <span class="tok-kw">try</span> visitor.visitUnion(ally, De, ua, va);</span>
<span class="line" id="L466">            },</span>
<span class="line" id="L467">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L468">        };</span>
<span class="line" id="L469">    }</span>
<span class="line" id="L470"></span>
<span class="line" id="L471">    <span class="tok-kw">fn</span> <span class="tok-fn">deserializeVoid</span>(self: Self, ally: ?std.mem.Allocator, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L472">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (self.content) {</span>
<span class="line" id="L473">            .Void =&gt; <span class="tok-kw">try</span> visitor.visitVoid(ally, De),</span>
<span class="line" id="L474">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L475">        };</span>
<span class="line" id="L476">    }</span>
<span class="line" id="L477"></span>
<span class="line" id="L478">    <span class="tok-kw">fn</span> <span class="tok-fn">visitContentMap</span>(ally: ?std.mem.Allocator, content: ContentMultiArrayList, visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L479">        <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L480">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L481">        }</span>
<span class="line" id="L482"></span>
<span class="line" id="L483">        <span class="tok-kw">var</span> map = ContentDeserializerMultiArrayList{};</span>
<span class="line" id="L484">        <span class="tok-kw">try</span> map.ensureTotalCapacity(ally.?, content.len);</span>
<span class="line" id="L485">        <span class="tok-kw">defer</span> map.deinit(ally.?);</span>
<span class="line" id="L486"></span>
<span class="line" id="L487">        <span class="tok-kw">for</span> (content.items(.key), content.items(.value)) |k, v| {</span>
<span class="line" id="L488">            map.appendAssumeCapacity(.{</span>
<span class="line" id="L489">                .key = ContentDeserializer{ .content = k },</span>
<span class="line" id="L490">                .value = ContentDeserializer{ .content = v },</span>
<span class="line" id="L491">            });</span>
<span class="line" id="L492">        }</span>
<span class="line" id="L493"></span>
<span class="line" id="L494">        <span class="tok-kw">var</span> ma = MapAccess{ .deserializers = map };</span>
<span class="line" id="L495">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitMap(ally.?, De, ma.mapAccess());</span>
<span class="line" id="L496">    }</span>
<span class="line" id="L497"></span>
<span class="line" id="L498">    <span class="tok-kw">fn</span> <span class="tok-fn">visitContentSeq</span>(ally: ?std.mem.Allocator, content: std.ArrayList(Content), visitor: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L499">        <span class="tok-kw">if</span> (ally == <span class="tok-null">null</span>) {</span>
<span class="line" id="L500">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MissingAllocator;</span>
<span class="line" id="L501">        }</span>
<span class="line" id="L502"></span>
<span class="line" id="L503">        <span class="tok-kw">var</span> seq = <span class="tok-kw">try</span> std.ArrayList(ContentDeserializer).initCapacity(ally.?, content.items.len);</span>
<span class="line" id="L504">        <span class="tok-kw">defer</span> seq.deinit();</span>
<span class="line" id="L505"></span>
<span class="line" id="L506">        <span class="tok-kw">for</span> (content.items) |c| {</span>
<span class="line" id="L507">            seq.appendAssumeCapacity(ContentDeserializer{ .content = c });</span>
<span class="line" id="L508">        }</span>
<span class="line" id="L509"></span>
<span class="line" id="L510">        <span class="tok-kw">var</span> sa = SeqAccess{ .deserializers = seq };</span>
<span class="line" id="L511">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitSeq(ally.?, De, sa.seqAccess());</span>
<span class="line" id="L512">    }</span>
<span class="line" id="L513">};</span>
<span class="line" id="L514"></span>
<span class="line" id="L515"><span class="tok-kw">const</span> MapAccess = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L516">    pos: <span class="tok-type">u64</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L517">    deserializers: ContentDeserializerMultiArrayList,</span>
<span class="line" id="L518"></span>
<span class="line" id="L519">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> MapAccessInterface(</span>
<span class="line" id="L520">        *<span class="tok-builtin">@This</span>(),</span>
<span class="line" id="L521">        getty_error,</span>
<span class="line" id="L522">        .{</span>
<span class="line" id="L523">            .nextKeySeed = nextKeySeed,</span>
<span class="line" id="L524">            .nextValueSeed = nextValueSeed,</span>
<span class="line" id="L525">        },</span>
<span class="line" id="L526">    );</span>
<span class="line" id="L527"></span>
<span class="line" id="L528">    <span class="tok-kw">fn</span> <span class="tok-fn">nextKeySeed</span>(self: *<span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L529">        <span class="tok-kw">if</span> (self.pos &gt;= self.deserializers.items(.key).len) {</span>
<span class="line" id="L530">            <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L531">        }</span>
<span class="line" id="L532"></span>
<span class="line" id="L533">        <span class="tok-kw">var</span> d = self.deserializers.items(.key)[self.pos];</span>
<span class="line" id="L534">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(ally, d.deserializer());</span>
<span class="line" id="L535">    }</span>
<span class="line" id="L536"></span>
<span class="line" id="L537">    <span class="tok-kw">fn</span> <span class="tok-fn">nextValueSeed</span>(self: *<span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L538">        <span class="tok-kw">var</span> d = self.deserializers.items(.value)[self.pos];</span>
<span class="line" id="L539">        self.pos += <span class="tok-number">1</span>;</span>
<span class="line" id="L540">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(ally, d.deserializer());</span>
<span class="line" id="L541">    }</span>
<span class="line" id="L542">};</span>
<span class="line" id="L543"></span>
<span class="line" id="L544"><span class="tok-kw">const</span> SeqAccess = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L545">    pos: <span class="tok-type">u64</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L546">    deserializers: std.ArrayList(ContentDeserializer),</span>
<span class="line" id="L547"></span>
<span class="line" id="L548">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> SeqAccessInterface(</span>
<span class="line" id="L549">        *<span class="tok-builtin">@This</span>(),</span>
<span class="line" id="L550">        getty_error,</span>
<span class="line" id="L551">        .{ .nextElementSeed = nextElementSeed },</span>
<span class="line" id="L552">    );</span>
<span class="line" id="L553"></span>
<span class="line" id="L554">    <span class="tok-kw">fn</span> <span class="tok-fn">nextElementSeed</span>(self: *<span class="tok-builtin">@This</span>(), ally: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L555">        <span class="tok-kw">if</span> (self.pos &gt;= self.deserializers.items.len) {</span>
<span class="line" id="L556">            <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L557">        }</span>
<span class="line" id="L558"></span>
<span class="line" id="L559">        <span class="tok-kw">var</span> d = self.deserializers.items[self.pos];</span>
<span class="line" id="L560">        self.pos += <span class="tok-number">1</span>;</span>
<span class="line" id="L561"></span>
<span class="line" id="L562">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(ally, d.deserializer());</span>
<span class="line" id="L563">    }</span>
<span class="line" id="L564">};</span>
<span class="line" id="L565"></span>
<span class="line" id="L566"><span class="tok-kw">fn</span> <span class="tok-fn">TransparentUnionVariantAccess</span>(<span class="tok-kw">comptime</span> Variant: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> Payload: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L567">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L568">        variant: Variant,</span>
<span class="line" id="L569">        payload: Payload,</span>
<span class="line" id="L570"></span>
<span class="line" id="L571">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L572"></span>
<span class="line" id="L573">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> UnionAccessInterface(</span>
<span class="line" id="L574">            Self,</span>
<span class="line" id="L575">            getty_error,</span>
<span class="line" id="L576">            .{</span>
<span class="line" id="L577">                .variantSeed = variantSeed,</span>
<span class="line" id="L578">                .isVariantAllocated = isAllocated,</span>
<span class="line" id="L579">            },</span>
<span class="line" id="L580">        );</span>
<span class="line" id="L581"></span>
<span class="line" id="L582">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> VariantAccessInterface(</span>
<span class="line" id="L583">            Self,</span>
<span class="line" id="L584">            getty_error,</span>
<span class="line" id="L585">            .{</span>
<span class="line" id="L586">                .payloadSeed = payloadSeed,</span>
<span class="line" id="L587">                .isPayloadAllocated = isAllocated,</span>
<span class="line" id="L588">            },</span>
<span class="line" id="L589">        );</span>
<span class="line" id="L590"></span>
<span class="line" id="L591">        <span class="tok-kw">fn</span> <span class="tok-fn">variantSeed</span>(self: Self, _: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L592">            <span class="tok-kw">return</span> self.variant;</span>
<span class="line" id="L593">        }</span>
<span class="line" id="L594"></span>
<span class="line" id="L595">        <span class="tok-kw">fn</span> <span class="tok-fn">payloadSeed</span>(self: Self, _: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L596">            <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(seed).Value != Payload) {</span>
<span class="line" id="L597">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType;</span>
<span class="line" id="L598">            }</span>
<span class="line" id="L599"></span>
<span class="line" id="L600">            <span class="tok-kw">return</span> self.payload;</span>
<span class="line" id="L601">        }</span>
<span class="line" id="L602"></span>
<span class="line" id="L603">        <span class="tok-kw">fn</span> <span class="tok-fn">isAllocated</span>(_: Self, <span class="tok-kw">comptime</span> _: <span class="tok-type">type</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L604">            <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L605">        }</span>
<span class="line" id="L606">    };</span>
<span class="line" id="L607">}</span>
<span class="line" id="L608"><span class="tok-kw">const</span> UnionVariantAccess = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L609">    key: Content,</span>
<span class="line" id="L610">    value: Content,</span>
<span class="line" id="L611"></span>
<span class="line" id="L612">    <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L613"></span>
<span class="line" id="L614">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> UnionAccessInterface(</span>
<span class="line" id="L615">        *Self,</span>
<span class="line" id="L616">        getty_error,</span>
<span class="line" id="L617">        .{ .variantSeed = variantSeed },</span>
<span class="line" id="L618">    );</span>
<span class="line" id="L619"></span>
<span class="line" id="L620">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> VariantAccessInterface(</span>
<span class="line" id="L621">        *Self,</span>
<span class="line" id="L622">        getty_error,</span>
<span class="line" id="L623">        .{ .payloadSeed = payloadSeed },</span>
<span class="line" id="L624">    );</span>
<span class="line" id="L625"></span>
<span class="line" id="L626">    <span class="tok-kw">fn</span> <span class="tok-fn">variantSeed</span>(self: *Self, ally: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L627">        <span class="tok-kw">var</span> cd = ContentDeserializer{ .content = self.key };</span>
<span class="line" id="L628">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(ally, cd.deserializer());</span>
<span class="line" id="L629">    }</span>
<span class="line" id="L630"></span>
<span class="line" id="L631">    <span class="tok-kw">fn</span> <span class="tok-fn">payloadSeed</span>(self: *Self, ally: ?std.mem.Allocator, seed: <span class="tok-kw">anytype</span>) getty_error!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L632">        <span class="tok-kw">var</span> cd = ContentDeserializer{ .content = self.value };</span>
<span class="line" id="L633">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(ally, cd.deserializer());</span>
<span class="line" id="L634">    }</span>
<span class="line" id="L635">};</span>
<span class="line" id="L636"></span>
<span class="line" id="L637"><span class="tok-comment">/// Returns a type that implements `getty.de.Visitor`.</span></span>
<span class="line" id="L638"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Visitor</span>(</span>
<span class="line" id="L639">    <span class="tok-comment">/// The type being deserialized into.</span></span>
<span class="line" id="L640">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L641">) <span class="tok-type">type</span> {</span>
<span class="line" id="L642">    <span class="tok-kw">return</span> UnionVisitor(T);</span>
<span class="line" id="L643">}</span>
<span class="line" id="L644"></span>
<span class="line" id="L645"><span class="tok-comment">/// Frees resources allocated by Getty during deserialization.</span></span>
<span class="line" id="L646"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">free</span>(</span>
<span class="line" id="L647">    <span class="tok-comment">/// A memory allocator.</span></span>
<span class="line" id="L648">    ally: std.mem.Allocator,</span>
<span class="line" id="L649">    <span class="tok-comment">/// A `getty.Deserializer` interface type.</span></span>
<span class="line" id="L650">    <span class="tok-kw">comptime</span> Deserializer: <span class="tok-type">type</span>,</span>
<span class="line" id="L651">    <span class="tok-comment">/// A value to deallocate.</span></span>
<span class="line" id="L652">    value: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L653">) <span class="tok-type">void</span> {</span>
<span class="line" id="L654">    <span class="tok-kw">const</span> info = <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(value)).Union;</span>
<span class="line" id="L655"></span>
<span class="line" id="L656">    <span class="tok-kw">if</span> (info.tag_type) |T| {</span>
<span class="line" id="L657">        <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (info.fields) |field| {</span>
<span class="line" id="L658">            <span class="tok-kw">if</span> (value == <span class="tok-builtin">@field</span>(T, field.name)) {</span>
<span class="line" id="L659">                getty_free(ally, Deserializer, <span class="tok-builtin">@field</span>(value, field.name));</span>
<span class="line" id="L660">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L661">            }</span>
<span class="line" id="L662">        }</span>
<span class="line" id="L663">    }</span>
<span class="line" id="L664">}</span>
<span class="line" id="L665"></span>
<span class="line" id="L666"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - union&quot;</span> {</span>
<span class="line" id="L667">    <span class="tok-kw">const</span> Tagged = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L668">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L669">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L670">    };</span>
<span class="line" id="L671"></span>
<span class="line" id="L672">    <span class="tok-kw">const</span> Bare = <span class="tok-kw">union</span> {</span>
<span class="line" id="L673">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L674">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L675">    };</span>
<span class="line" id="L676"></span>
<span class="line" id="L677">    <span class="tok-kw">const</span> tests = .{</span>
<span class="line" id="L678">        .{</span>
<span class="line" id="L679">            .name = <span class="tok-str">&quot;tagged, void variant&quot;</span>,</span>
<span class="line" id="L680">            .tokens = &amp;.{</span>
<span class="line" id="L681">                .{ .Union = {} },</span>
<span class="line" id="L682">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L683">                .{ .Void = {} },</span>
<span class="line" id="L684">            },</span>
<span class="line" id="L685">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L686">            .want = Tagged{ .foo = {} },</span>
<span class="line" id="L687">        },</span>
<span class="line" id="L688">        .{</span>
<span class="line" id="L689">            .name = <span class="tok-str">&quot;tagged, non-void variant&quot;</span>,</span>
<span class="line" id="L690">            .tokens = &amp;.{</span>
<span class="line" id="L691">                .{ .Union = {} },</span>
<span class="line" id="L692">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L693">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L694">            },</span>
<span class="line" id="L695">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L696">            .want = Tagged{ .bar = <span class="tok-null">true</span> },</span>
<span class="line" id="L697">        },</span>
<span class="line" id="L698">        .{</span>
<span class="line" id="L699">            .name = <span class="tok-str">&quot;untagged, void variant&quot;</span>,</span>
<span class="line" id="L700">            .tokens = &amp;.{</span>
<span class="line" id="L701">                .{ .Union = {} },</span>
<span class="line" id="L702">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L703">                .{ .Void = {} },</span>
<span class="line" id="L704">            },</span>
<span class="line" id="L705">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L706">            .tag = <span class="tok-str">&quot;foo&quot;</span>,</span>
<span class="line" id="L707">            .want = {},</span>
<span class="line" id="L708">        },</span>
<span class="line" id="L709">        .{</span>
<span class="line" id="L710">            .name = <span class="tok-str">&quot;untagged, non-void variant&quot;</span>,</span>
<span class="line" id="L711">            .tokens = &amp;.{</span>
<span class="line" id="L712">                .{ .Union = {} },</span>
<span class="line" id="L713">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L714">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L715">            },</span>
<span class="line" id="L716">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L717">            .tag = <span class="tok-str">&quot;bar&quot;</span>,</span>
<span class="line" id="L718">            .want = <span class="tok-null">true</span>,</span>
<span class="line" id="L719">        },</span>
<span class="line" id="L720">    };</span>
<span class="line" id="L721"></span>
<span class="line" id="L722">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (tests) |t| {</span>
<span class="line" id="L723">        <span class="tok-kw">try</span> runTest(t, <span class="tok-kw">if</span> (t.tagged) Tagged <span class="tok-kw">else</span> Bare);</span>
<span class="line" id="L724">    }</span>
<span class="line" id="L725">}</span>
<span class="line" id="L726"></span>
<span class="line" id="L727"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - union, attributes (rename)&quot;</span> {</span>
<span class="line" id="L728">    <span class="tok-kw">const</span> Tagged = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L729">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L730">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L731"></span>
<span class="line" id="L732">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L733">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{</span>
<span class="line" id="L734">                .foo = .{ .rename = <span class="tok-str">&quot;FOO&quot;</span> },</span>
<span class="line" id="L735">                .bar = .{ .rename = <span class="tok-str">&quot;BAR&quot;</span> },</span>
<span class="line" id="L736">            };</span>
<span class="line" id="L737">        };</span>
<span class="line" id="L738">    };</span>
<span class="line" id="L739"></span>
<span class="line" id="L740">    <span class="tok-kw">const</span> Bare = <span class="tok-kw">union</span> {</span>
<span class="line" id="L741">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L742">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L743"></span>
<span class="line" id="L744">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L745">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{</span>
<span class="line" id="L746">                .foo = .{ .rename = <span class="tok-str">&quot;FOO&quot;</span> },</span>
<span class="line" id="L747">                .bar = .{ .rename = <span class="tok-str">&quot;BAR&quot;</span> },</span>
<span class="line" id="L748">            };</span>
<span class="line" id="L749">        };</span>
<span class="line" id="L750">    };</span>
<span class="line" id="L751"></span>
<span class="line" id="L752">    <span class="tok-kw">const</span> tests = .{</span>
<span class="line" id="L753">        .{</span>
<span class="line" id="L754">            .name = <span class="tok-str">&quot;tagged, void variant (success)&quot;</span>,</span>
<span class="line" id="L755">            .tokens = &amp;.{</span>
<span class="line" id="L756">                .{ .Union = {} },</span>
<span class="line" id="L757">                .{ .String = <span class="tok-str">&quot;FOO&quot;</span> },</span>
<span class="line" id="L758">                .{ .Void = {} },</span>
<span class="line" id="L759">            },</span>
<span class="line" id="L760">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L761">            .want = Tagged{ .foo = {} },</span>
<span class="line" id="L762">        },</span>
<span class="line" id="L763">        .{</span>
<span class="line" id="L764">            .name = <span class="tok-str">&quot;tagged, void variant (fail)&quot;</span>,</span>
<span class="line" id="L765">            .tokens = &amp;.{</span>
<span class="line" id="L766">                .{ .Union = {} },</span>
<span class="line" id="L767">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L768">                .{ .Void = {} },</span>
<span class="line" id="L769">            },</span>
<span class="line" id="L770">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L771">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L772">        },</span>
<span class="line" id="L773">        .{</span>
<span class="line" id="L774">            .name = <span class="tok-str">&quot;tagged, non-void variant (success)&quot;</span>,</span>
<span class="line" id="L775">            .tokens = &amp;.{</span>
<span class="line" id="L776">                .{ .Union = {} },</span>
<span class="line" id="L777">                .{ .String = <span class="tok-str">&quot;BAR&quot;</span> },</span>
<span class="line" id="L778">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L779">            },</span>
<span class="line" id="L780">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L781">            .want = Tagged{ .bar = <span class="tok-null">true</span> },</span>
<span class="line" id="L782">        },</span>
<span class="line" id="L783">        .{</span>
<span class="line" id="L784">            .name = <span class="tok-str">&quot;tagged, non-void variant (fail)&quot;</span>,</span>
<span class="line" id="L785">            .tokens = &amp;.{</span>
<span class="line" id="L786">                .{ .Union = {} },</span>
<span class="line" id="L787">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L788">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L789">            },</span>
<span class="line" id="L790">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L791">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L792">        },</span>
<span class="line" id="L793">        .{</span>
<span class="line" id="L794">            .name = <span class="tok-str">&quot;untagged, void variant (success)&quot;</span>,</span>
<span class="line" id="L795">            .tokens = &amp;.{</span>
<span class="line" id="L796">                .{ .Union = {} },</span>
<span class="line" id="L797">                .{ .String = <span class="tok-str">&quot;FOO&quot;</span> },</span>
<span class="line" id="L798">                .{ .Void = {} },</span>
<span class="line" id="L799">            },</span>
<span class="line" id="L800">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L801">            .tag = <span class="tok-str">&quot;foo&quot;</span>,</span>
<span class="line" id="L802">            .want = {},</span>
<span class="line" id="L803">        },</span>
<span class="line" id="L804">        .{</span>
<span class="line" id="L805">            .name = <span class="tok-str">&quot;untagged, void variant (fail)&quot;</span>,</span>
<span class="line" id="L806">            .tokens = &amp;.{</span>
<span class="line" id="L807">                .{ .Union = {} },</span>
<span class="line" id="L808">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L809">                .{ .Void = {} },</span>
<span class="line" id="L810">            },</span>
<span class="line" id="L811">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L812">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L813">        },</span>
<span class="line" id="L814">        .{</span>
<span class="line" id="L815">            .name = <span class="tok-str">&quot;untagged, non-void variant (success)&quot;</span>,</span>
<span class="line" id="L816">            .tokens = &amp;.{</span>
<span class="line" id="L817">                .{ .Union = {} },</span>
<span class="line" id="L818">                .{ .String = <span class="tok-str">&quot;BAR&quot;</span> },</span>
<span class="line" id="L819">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L820">            },</span>
<span class="line" id="L821">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L822">            .tag = <span class="tok-str">&quot;bar&quot;</span>,</span>
<span class="line" id="L823">            .want = <span class="tok-null">true</span>,</span>
<span class="line" id="L824">        },</span>
<span class="line" id="L825">        .{</span>
<span class="line" id="L826">            .name = <span class="tok-str">&quot;untagged, non-void variant (fail)&quot;</span>,</span>
<span class="line" id="L827">            .tokens = &amp;.{</span>
<span class="line" id="L828">                .{ .Union = {} },</span>
<span class="line" id="L829">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L830">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L831">            },</span>
<span class="line" id="L832">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L833">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L834">        },</span>
<span class="line" id="L835">    };</span>
<span class="line" id="L836"></span>
<span class="line" id="L837">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (tests) |t| {</span>
<span class="line" id="L838">        <span class="tok-kw">try</span> runTest(t, <span class="tok-kw">if</span> (t.tagged) Tagged <span class="tok-kw">else</span> Bare);</span>
<span class="line" id="L839">    }</span>
<span class="line" id="L840">}</span>
<span class="line" id="L841"></span>
<span class="line" id="L842"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - union, attributes (skip)&quot;</span> {</span>
<span class="line" id="L843">    <span class="tok-kw">const</span> Tagged = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L844">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L845">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L846"></span>
<span class="line" id="L847">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L848">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{</span>
<span class="line" id="L849">                .foo = .{ .skip = <span class="tok-null">true</span> },</span>
<span class="line" id="L850">                .bar = .{ .skip = <span class="tok-null">true</span> },</span>
<span class="line" id="L851">            };</span>
<span class="line" id="L852">        };</span>
<span class="line" id="L853">    };</span>
<span class="line" id="L854"></span>
<span class="line" id="L855">    <span class="tok-kw">const</span> Bare = <span class="tok-kw">union</span> {</span>
<span class="line" id="L856">        foo: <span class="tok-type">void</span>,</span>
<span class="line" id="L857">        bar: <span class="tok-type">bool</span>,</span>
<span class="line" id="L858"></span>
<span class="line" id="L859">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L860">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{</span>
<span class="line" id="L861">                .foo = .{ .skip = <span class="tok-null">true</span> },</span>
<span class="line" id="L862">                .bar = .{ .skip = <span class="tok-null">true</span> },</span>
<span class="line" id="L863">            };</span>
<span class="line" id="L864">        };</span>
<span class="line" id="L865">    };</span>
<span class="line" id="L866"></span>
<span class="line" id="L867">    <span class="tok-kw">const</span> tests = .{</span>
<span class="line" id="L868">        .{</span>
<span class="line" id="L869">            .name = <span class="tok-str">&quot;tagged, void variant (fail)&quot;</span>,</span>
<span class="line" id="L870">            .tokens = &amp;.{</span>
<span class="line" id="L871">                .{ .Union = {} },</span>
<span class="line" id="L872">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L873">                .{ .Void = {} },</span>
<span class="line" id="L874">            },</span>
<span class="line" id="L875">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L876">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L877">        },</span>
<span class="line" id="L878">        .{</span>
<span class="line" id="L879">            .name = <span class="tok-str">&quot;tagged, non-void variant (fail)&quot;</span>,</span>
<span class="line" id="L880">            .tokens = &amp;.{</span>
<span class="line" id="L881">                .{ .Union = {} },</span>
<span class="line" id="L882">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L883">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L884">            },</span>
<span class="line" id="L885">            .tagged = <span class="tok-null">true</span>,</span>
<span class="line" id="L886">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L887">        },</span>
<span class="line" id="L888">        .{</span>
<span class="line" id="L889">            .name = <span class="tok-str">&quot;untagged, void variant (fail)&quot;</span>,</span>
<span class="line" id="L890">            .tokens = &amp;.{</span>
<span class="line" id="L891">                .{ .Union = {} },</span>
<span class="line" id="L892">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L893">                .{ .Void = {} },</span>
<span class="line" id="L894">            },</span>
<span class="line" id="L895">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L896">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L897">        },</span>
<span class="line" id="L898">        .{</span>
<span class="line" id="L899">            .name = <span class="tok-str">&quot;untagged, non-void variant (fail)&quot;</span>,</span>
<span class="line" id="L900">            .tokens = &amp;.{</span>
<span class="line" id="L901">                .{ .Union = {} },</span>
<span class="line" id="L902">                .{ .String = <span class="tok-str">&quot;bar&quot;</span> },</span>
<span class="line" id="L903">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L904">            },</span>
<span class="line" id="L905">            .tagged = <span class="tok-null">false</span>,</span>
<span class="line" id="L906">            .want_err = <span class="tok-kw">error</span>.UnknownVariant,</span>
<span class="line" id="L907">        },</span>
<span class="line" id="L908">    };</span>
<span class="line" id="L909"></span>
<span class="line" id="L910">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (tests) |t| {</span>
<span class="line" id="L911">        <span class="tok-kw">try</span> runTest(t, <span class="tok-kw">if</span> (t.tagged) Tagged <span class="tok-kw">else</span> Bare);</span>
<span class="line" id="L912">    }</span>
<span class="line" id="L913">}</span>
<span class="line" id="L914"></span>
<span class="line" id="L915"><span class="tok-kw">test</span> <span class="tok-str">&quot;deserialize - union, attributes (tag, untagged)&quot;</span> {</span>
<span class="line" id="L916">    <span class="tok-kw">const</span> WantTagged = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L917">        Bool: <span class="tok-type">bool</span>,</span>
<span class="line" id="L918">        F32: <span class="tok-type">f32</span>,</span>
<span class="line" id="L919">        I32: <span class="tok-type">i32</span>,</span>
<span class="line" id="L920">        Optional: ?<span class="tok-type">void</span>,</span>
<span class="line" id="L921">        Map: <span class="tok-kw">struct</span> { A: <span class="tok-type">i32</span>, B: <span class="tok-type">i32</span>, C: <span class="tok-type">i32</span> },</span>
<span class="line" id="L922">        Seq: [<span class="tok-number">3</span>]<span class="tok-type">i32</span>,</span>
<span class="line" id="L923">        String: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L924">        Union: <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) { foo: <span class="tok-type">i32</span> },</span>
<span class="line" id="L925">        <span class="tok-comment">// NOTE: The variant in this union needs to be different than all the</span>
</span>
<span class="line" id="L926">        <span class="tok-comment">// other variants in WantTagged. Otherwise, an earlier variant will be</span>
</span>
<span class="line" id="L927">        <span class="tok-comment">// deserialized into.</span>
</span>
<span class="line" id="L928">        UnionUntagged: <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L929">            Bools: [<span class="tok-number">2</span>]<span class="tok-type">bool</span>,</span>
<span class="line" id="L930">            Ints: [<span class="tok-number">2</span>]<span class="tok-type">i32</span>,</span>
<span class="line" id="L931"></span>
<span class="line" id="L932">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L933">                <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{ .Container = .{ .tag = .untagged } };</span>
<span class="line" id="L934">            };</span>
<span class="line" id="L935">        },</span>
<span class="line" id="L936">        Void,</span>
<span class="line" id="L937"></span>
<span class="line" id="L938">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.db&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L939">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> attributes = .{ .Container = .{ .tag = .untagged } };</span>
<span class="line" id="L940">        };</span>
<span class="line" id="L941">    };</span>
<span class="line" id="L942"></span>
<span class="line" id="L943">    <span class="tok-kw">const</span> tests = .{</span>
<span class="line" id="L944">        .{</span>
<span class="line" id="L945">            .name = <span class="tok-str">&quot;tagged, bool variant&quot;</span>,</span>
<span class="line" id="L946">            .tokens = &amp;.{.{ .Bool = <span class="tok-null">true</span> }},</span>
<span class="line" id="L947">            .want = WantTagged{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L948">        },</span>
<span class="line" id="L949">        .{</span>
<span class="line" id="L950">            .name = <span class="tok-str">&quot;tagged, float variant&quot;</span>,</span>
<span class="line" id="L951">            .tokens = &amp;.{.{ .F32 = <span class="tok-number">3.14</span> }},</span>
<span class="line" id="L952">            .want = WantTagged{ .F32 = <span class="tok-number">3.14</span> },</span>
<span class="line" id="L953">        },</span>
<span class="line" id="L954">        .{</span>
<span class="line" id="L955">            .name = <span class="tok-str">&quot;tagged, int variant&quot;</span>,</span>
<span class="line" id="L956">            .tokens = &amp;.{.{ .I32 = <span class="tok-number">123</span> }},</span>
<span class="line" id="L957">            .want = WantTagged{ .I32 = <span class="tok-number">123</span> },</span>
<span class="line" id="L958">        },</span>
<span class="line" id="L959">        .{</span>
<span class="line" id="L960">            .name = <span class="tok-str">&quot;tagged, map variant&quot;</span>,</span>
<span class="line" id="L961">            .tokens = &amp;.{</span>
<span class="line" id="L962">                .{ .Map = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L963">                .{ .String = <span class="tok-str">&quot;A&quot;</span> },</span>
<span class="line" id="L964">                .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L965">                .{ .String = <span class="tok-str">&quot;B&quot;</span> },</span>
<span class="line" id="L966">                .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L967">                .{ .String = <span class="tok-str">&quot;C&quot;</span> },</span>
<span class="line" id="L968">                .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L969">                .{ .MapEnd = {} },</span>
<span class="line" id="L970">            },</span>
<span class="line" id="L971">            .want = WantTagged{ .Map = .{ .A = <span class="tok-number">1</span>, .B = <span class="tok-number">2</span>, .C = <span class="tok-number">3</span> } },</span>
<span class="line" id="L972">        },</span>
<span class="line" id="L973">        .{</span>
<span class="line" id="L974">            .name = <span class="tok-str">&quot;tagged, optional variant (null)&quot;</span>,</span>
<span class="line" id="L975">            .tokens = &amp;.{.{ .Null = {} }},</span>
<span class="line" id="L976">            .want = WantTagged{ .Optional = <span class="tok-null">null</span> },</span>
<span class="line" id="L977">        },</span>
<span class="line" id="L978">        .{</span>
<span class="line" id="L979">            .name = <span class="tok-str">&quot;tagged, optional variant (some)&quot;</span>,</span>
<span class="line" id="L980">            .tokens = &amp;.{</span>
<span class="line" id="L981">                .{ .Some = {} },</span>
<span class="line" id="L982">                .{ .Void = {} },</span>
<span class="line" id="L983">            },</span>
<span class="line" id="L984">            .want = WantTagged{ .Optional = {} },</span>
<span class="line" id="L985">        },</span>
<span class="line" id="L986">        .{</span>
<span class="line" id="L987">            .name = <span class="tok-str">&quot;tagged, sequence variant&quot;</span>,</span>
<span class="line" id="L988">            .tokens = &amp;.{</span>
<span class="line" id="L989">                .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L990">                .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L991">                .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L992">                .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L993">                .{ .SeqEnd = {} },</span>
<span class="line" id="L994">            },</span>
<span class="line" id="L995">            .want = WantTagged{ .Seq = [_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span> } },</span>
<span class="line" id="L996">        },</span>
<span class="line" id="L997">        .{</span>
<span class="line" id="L998">            .name = <span class="tok-str">&quot;tagged, string variant&quot;</span>,</span>
<span class="line" id="L999">            .tokens = &amp;.{.{ .String = <span class="tok-str">&quot;abcdef&quot;</span> }},</span>
<span class="line" id="L1000">            .want = WantTagged{ .String = <span class="tok-str">&quot;abcdef&quot;</span> },</span>
<span class="line" id="L1001">        },</span>
<span class="line" id="L1002">        .{</span>
<span class="line" id="L1003">            .name = <span class="tok-str">&quot;tagged, union variant&quot;</span>,</span>
<span class="line" id="L1004">            .tokens = &amp;.{</span>
<span class="line" id="L1005">                .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L1006">                .{ .String = <span class="tok-str">&quot;foo&quot;</span> },</span>
<span class="line" id="L1007">                .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1008">                .{ .MapEnd = {} },</span>
<span class="line" id="L1009">            },</span>
<span class="line" id="L1010">            .want = WantTagged{ .Union = .{ .foo = <span class="tok-number">1</span> } },</span>
<span class="line" id="L1011">        },</span>
<span class="line" id="L1012">        .{</span>
<span class="line" id="L1013">            .name = <span class="tok-str">&quot;tagged, union variant (untagged, I)&quot;</span>,</span>
<span class="line" id="L1014">            .tokens = &amp;.{</span>
<span class="line" id="L1015">                .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L1016">                .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L1017">                .{ .Bool = <span class="tok-null">false</span> },</span>
<span class="line" id="L1018">                .{ .SeqEnd = {} },</span>
<span class="line" id="L1019">            },</span>
<span class="line" id="L1020">            .want = WantTagged{ .UnionUntagged = .{ .Bools = [_]<span class="tok-type">bool</span>{ <span class="tok-null">true</span>, <span class="tok-null">false</span> } } },</span>
<span class="line" id="L1021">        },</span>
<span class="line" id="L1022">        .{</span>
<span class="line" id="L1023">            .name = <span class="tok-str">&quot;tagged, union variant (untagged, II)&quot;</span>,</span>
<span class="line" id="L1024">            .tokens = &amp;.{</span>
<span class="line" id="L1025">                .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L1026">                .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L1027">                .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L1028">                .{ .SeqEnd = {} },</span>
<span class="line" id="L1029">            },</span>
<span class="line" id="L1030">            .want = WantTagged{ .UnionUntagged = .{ .Ints = [_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span> } } },</span>
<span class="line" id="L1031">        },</span>
<span class="line" id="L1032">        .{</span>
<span class="line" id="L1033">            .name = <span class="tok-str">&quot;tagged, void variant&quot;</span>,</span>
<span class="line" id="L1034">            .tokens = &amp;.{.{ .Void = {} }},</span>
<span class="line" id="L1035">            .want = WantTagged{ .Void = {} },</span>
<span class="line" id="L1036">        },</span>
<span class="line" id="L1037">    };</span>
<span class="line" id="L1038"></span>
<span class="line" id="L1039">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (tests) |t| {</span>
<span class="line" id="L1040">        <span class="tok-kw">const</span> Want = <span class="tok-builtin">@TypeOf</span>(t.want);</span>
<span class="line" id="L1041">        <span class="tok-kw">const</span> Test = <span class="tok-builtin">@TypeOf</span>(t);</span>
<span class="line" id="L1042"></span>
<span class="line" id="L1043">        <span class="tok-kw">if</span> (<span class="tok-builtin">@hasField</span>(Test, <span class="tok-str">&quot;want_err&quot;</span>)) {</span>
<span class="line" id="L1044">            <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L1045">                t.name,</span>
<span class="line" id="L1046">                t.want_err,</span>
<span class="line" id="L1047">                testing.deserializeErr(std.testing.allocator, <span class="tok-builtin">@This</span>(), Want, t.tokens),</span>
<span class="line" id="L1048">            );</span>
<span class="line" id="L1049">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1050">            <span class="tok-kw">const</span> got = <span class="tok-kw">try</span> testing.deserialize(std.testing.allocator, t.name, <span class="tok-builtin">@This</span>(), Want, t.tokens);</span>
<span class="line" id="L1051"></span>
<span class="line" id="L1052">            <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(t.want)).Union.tag_type) |_| {</span>
<span class="line" id="L1053">                <span class="tok-kw">switch</span> (t.want) {</span>
<span class="line" id="L1054">                    .String =&gt; |want| {</span>
<span class="line" id="L1055">                        <span class="tok-kw">defer</span> std.testing.allocator.free(got.String);</span>
<span class="line" id="L1056">                        <span class="tok-kw">try</span> testing.expectEqualSlices(t.name, <span class="tok-type">u8</span>, want, got.String);</span>
<span class="line" id="L1057">                    },</span>
<span class="line" id="L1058">                    <span class="tok-kw">else</span> =&gt; |want| <span class="tok-kw">try</span> testing.expectEqual(t.name, want, got),</span>
<span class="line" id="L1059">                }</span>
<span class="line" id="L1060">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1061">                <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> std.mem.eql(<span class="tok-type">u8</span>, t.tag, <span class="tok-str">&quot;String&quot;</span>)) {</span>
<span class="line" id="L1062">                    <span class="tok-kw">defer</span> std.testing.allocator.free(got.String);</span>
<span class="line" id="L1063">                    <span class="tok-kw">try</span> testing.expectEqualSlices(t.name, <span class="tok-type">u8</span>, got.want, got.String);</span>
<span class="line" id="L1064">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1065">                    <span class="tok-kw">try</span> testing.expectEqual(t.name, t.want, <span class="tok-builtin">@field</span>(got, t.tag));</span>
<span class="line" id="L1066">                }</span>
<span class="line" id="L1067">            }</span>
<span class="line" id="L1068">        }</span>
<span class="line" id="L1069">    }</span>
<span class="line" id="L1070">}</span>
<span class="line" id="L1071"></span>
<span class="line" id="L1072"><span class="tok-kw">fn</span> <span class="tok-fn">runTest</span>(t: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> Want: <span class="tok-type">type</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1073">    <span class="tok-kw">const</span> Test = <span class="tok-builtin">@TypeOf</span>(t);</span>
<span class="line" id="L1074"></span>
<span class="line" id="L1075">    <span class="tok-kw">if</span> (<span class="tok-builtin">@hasField</span>(Test, <span class="tok-str">&quot;want_err&quot;</span>)) {</span>
<span class="line" id="L1076">        <span class="tok-kw">try</span> testing.expectError(</span>
<span class="line" id="L1077">            t.name,</span>
<span class="line" id="L1078">            t.want_err,</span>
<span class="line" id="L1079">            testing.deserializeErr(std.testing.allocator, <span class="tok-builtin">@This</span>(), Want, t.tokens),</span>
<span class="line" id="L1080">        );</span>
<span class="line" id="L1081">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1082">        <span class="tok-kw">const</span> got = <span class="tok-kw">try</span> testing.deserialize(std.testing.allocator, t.name, <span class="tok-builtin">@This</span>(), Want, t.tokens);</span>
<span class="line" id="L1083"></span>
<span class="line" id="L1084">        <span class="tok-kw">if</span> (t.tagged) {</span>
<span class="line" id="L1085">            <span class="tok-kw">try</span> testing.expectEqual(t.name, t.want, got);</span>
<span class="line" id="L1086">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1087">            <span class="tok-kw">try</span> testing.expectEqual(t.name, t.want, <span class="tok-builtin">@field</span>(got, t.tag));</span>
<span class="line" id="L1088">        }</span>
<span class="line" id="L1089">    }</span>
<span class="line" id="L1090">}</span>
<span class="line" id="L1091"></span>
</code></pre></body>
</html>