<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>ser/interfaces/serializer.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> err = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../error.zig&quot;</span>);</span>
<span class="line" id="L4"><span class="tok-kw">const</span> default_st = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../tuples.zig&quot;</span>).st;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> isString = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../../helpers.zig&quot;</span>).isString;</span>
<span class="line" id="L6"></span>
<span class="line" id="L7"><span class="tok-comment">/// A `Serializer` converts _Getty values_ into formatted data.</span></span>
<span class="line" id="L8"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Serializer</span>(</span>
<span class="line" id="L9">    <span class="tok-comment">/// An implementing type.</span></span>
<span class="line" id="L10">    <span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>,</span>
<span class="line" id="L11">    <span class="tok-comment">/// The successful return type of the interface's `end` method.</span></span>
<span class="line" id="L12">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L13">    <span class="tok-comment">/// The error set to be returned by the interface's methods upon failure.</span></span>
<span class="line" id="L14">    <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>,</span>
<span class="line" id="L15">    <span class="tok-comment">/// An optional, user-defined serialization block or tuple.</span></span>
<span class="line" id="L16">    <span class="tok-kw">comptime</span> user_sbt: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L17">    <span class="tok-comment">/// An optional, serializer-defined serialization block or tuple.</span></span>
<span class="line" id="L18">    <span class="tok-kw">comptime</span> serializer_sbt: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L19">    <span class="tok-comment">/// An optional type that implements `getty.ser.Map`.</span></span>
<span class="line" id="L20">    <span class="tok-kw">comptime</span> Map: ?<span class="tok-type">type</span>,</span>
<span class="line" id="L21">    <span class="tok-comment">/// An optional type that implements `getty.ser.Seq`.</span></span>
<span class="line" id="L22">    <span class="tok-kw">comptime</span> Seq: ?<span class="tok-type">type</span>,</span>
<span class="line" id="L23">    <span class="tok-comment">/// An optional type that implements `getty.ser.Structure`.</span></span>
<span class="line" id="L24">    <span class="tok-kw">comptime</span> Struct: ?<span class="tok-type">type</span>,</span>
<span class="line" id="L25">    <span class="tok-comment">/// A namespace containing methods that `Impl` must define or can override.</span></span>
<span class="line" id="L26">    <span class="tok-kw">comptime</span> methods: <span class="tok-kw">struct</span> {</span>
<span class="line" id="L27">        serializeBool: SerializeBoolFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L28">        serializeEnum: SerializeEnumFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L29">        serializeFloat: SerializeAnyFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L30">        serializeInt: SerializeAnyFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L31">        serializeMap: SerializeMapSeqFn(Impl, Map, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L32">        serializeNull: SerializeNothingFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L33">        serializeSeq: SerializeMapSeqFn(Impl, Seq, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L34">        serializeSome: SerializeAnyFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L35">        serializeString: SerializeAnyFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L36">        serializeStruct: SerializeStructFn(Impl, Struct, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L37">        serializeVoid: SerializeNothingFn(Impl, T, E) = <span class="tok-null">null</span>,</span>
<span class="line" id="L38">    },</span>
<span class="line" id="L39">) <span class="tok-type">type</span> {</span>
<span class="line" id="L40">    <span class="tok-kw">if</span> (E != E || err.Error) {</span>
<span class="line" id="L41">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;error set must include `getty.ser.Error`&quot;</span>);</span>
<span class="line" id="L42">    }</span>
<span class="line" id="L43"></span>
<span class="line" id="L44">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L45">        <span class="tok-comment">/// An interface type.</span></span>
<span class="line" id="L46">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> @&quot;getty.Serializer&quot; = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L47">            impl: Impl,</span>
<span class="line" id="L48"></span>
<span class="line" id="L49">            <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L50"></span>
<span class="line" id="L51">            <span class="tok-comment">/// Successful return type.</span></span>
<span class="line" id="L52">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Ok = T;</span>
<span class="line" id="L53"></span>
<span class="line" id="L54">            <span class="tok-comment">/// Error set used upon failure.</span></span>
<span class="line" id="L55">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Err = E;</span>
<span class="line" id="L56"></span>
<span class="line" id="L57">            <span class="tok-comment">/// User-defined Serialization Tuple.</span></span>
<span class="line" id="L58">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> user_st = blk: {</span>
<span class="line" id="L59">                <span class="tok-comment">// Process null.</span>
</span>
<span class="line" id="L60">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(user_sbt) == <span class="tok-builtin">@TypeOf</span>(<span class="tok-null">null</span>)) {</span>
<span class="line" id="L61">                    <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L62">                }</span>
<span class="line" id="L63"></span>
<span class="line" id="L64">                <span class="tok-comment">// Process SB.</span>
</span>
<span class="line" id="L65">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(user_sbt) == <span class="tok-type">type</span>) {</span>
<span class="line" id="L66">                    <span class="tok-comment">// If an attribute map exists, but no attributes are</span>
</span>
<span class="line" id="L67">                    <span class="tok-comment">// specified, ignore the SB.</span>
</span>
<span class="line" id="L68">                    <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(user_sbt, <span class="tok-str">&quot;attributes&quot;</span>)) {</span>
<span class="line" id="L69">                        <span class="tok-kw">if</span> (std.meta.fields(<span class="tok-builtin">@TypeOf</span>(user_sbt.attributes)).len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L70">                            <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L71">                        }</span>
<span class="line" id="L72">                    }</span>
<span class="line" id="L73"></span>
<span class="line" id="L74">                    <span class="tok-kw">break</span> :blk .{user_sbt};</span>
<span class="line" id="L75">                }</span>
<span class="line" id="L76"></span>
<span class="line" id="L77">                <span class="tok-comment">// Process ST.</span>
</span>
<span class="line" id="L78">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(user_sbt) == <span class="tok-builtin">@TypeOf</span>(default_st)) {</span>
<span class="line" id="L79">                    <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L80">                }</span>
<span class="line" id="L81"></span>
<span class="line" id="L82">                <span class="tok-kw">break</span> :blk user_sbt;</span>
<span class="line" id="L83">            };</span>
<span class="line" id="L84"></span>
<span class="line" id="L85">            <span class="tok-comment">/// Serializer-defined Serialization Tuple.</span></span>
<span class="line" id="L86">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> serializer_st = blk: {</span>
<span class="line" id="L87">                <span class="tok-comment">// Process null.</span>
</span>
<span class="line" id="L88">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(serializer_sbt) == <span class="tok-builtin">@TypeOf</span>(<span class="tok-null">null</span>)) {</span>
<span class="line" id="L89">                    <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L90">                }</span>
<span class="line" id="L91"></span>
<span class="line" id="L92">                <span class="tok-comment">// Process SB.</span>
</span>
<span class="line" id="L93">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(serializer_sbt) == <span class="tok-type">type</span>) {</span>
<span class="line" id="L94">                    <span class="tok-comment">// If an attribute map exists, but no attributes are</span>
</span>
<span class="line" id="L95">                    <span class="tok-comment">// specified, ignore the SB.</span>
</span>
<span class="line" id="L96">                    <span class="tok-kw">if</span> (<span class="tok-builtin">@hasDecl</span>(serializer_sbt, <span class="tok-str">&quot;attributes&quot;</span>)) {</span>
<span class="line" id="L97">                        <span class="tok-kw">if</span> (std.meta.fields(<span class="tok-builtin">@TypeOf</span>(serializer_sbt.attributes)).len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L98">                            <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L99">                        }</span>
<span class="line" id="L100">                    }</span>
<span class="line" id="L101"></span>
<span class="line" id="L102">                    <span class="tok-kw">break</span> :blk .{serializer_sbt};</span>
<span class="line" id="L103">                }</span>
<span class="line" id="L104"></span>
<span class="line" id="L105">                <span class="tok-comment">// Process ST.</span>
</span>
<span class="line" id="L106">                <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(serializer_sbt) == <span class="tok-builtin">@TypeOf</span>(default_st)) {</span>
<span class="line" id="L107">                    <span class="tok-kw">break</span> :blk .{};</span>
<span class="line" id="L108">                }</span>
<span class="line" id="L109"></span>
<span class="line" id="L110">                <span class="tok-kw">break</span> :blk serializer_sbt;</span>
<span class="line" id="L111">            };</span>
<span class="line" id="L112"></span>
<span class="line" id="L113">            <span class="tok-comment">/// Aggregate Serialization Tuple.</span></span>
<span class="line" id="L114">            <span class="tok-comment">///</span></span>
<span class="line" id="L115">            <span class="tok-comment">/// The Aggregate ST combines the user-, serializer-, and Getty's</span></span>
<span class="line" id="L116">            <span class="tok-comment">/// default Serialization Tuples into one.</span></span>
<span class="line" id="L117">            <span class="tok-comment">///</span></span>
<span class="line" id="L118">            <span class="tok-comment">/// The priority of each ST is shown below (from highest to lowest):</span></span>
<span class="line" id="L119">            <span class="tok-comment">///</span></span>
<span class="line" id="L120">            <span class="tok-comment">///   1. User-defined ST.</span></span>
<span class="line" id="L121">            <span class="tok-comment">///   2. Serializer-defined ST.</span></span>
<span class="line" id="L122">            <span class="tok-comment">///   3. Getty's default ST.</span></span>
<span class="line" id="L123">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> st = blk: {</span>
<span class="line" id="L124">                <span class="tok-kw">const</span> U = <span class="tok-builtin">@TypeOf</span>(user_st);</span>
<span class="line" id="L125">                <span class="tok-kw">const</span> S = <span class="tok-builtin">@TypeOf</span>(serializer_st);</span>
<span class="line" id="L126">                <span class="tok-kw">const</span> Empty = <span class="tok-builtin">@TypeOf</span>(.{});</span>
<span class="line" id="L127"></span>
<span class="line" id="L128">                <span class="tok-kw">if</span> (U == Empty <span class="tok-kw">and</span> S == Empty) {</span>
<span class="line" id="L129">                    <span class="tok-comment">// Both tuples are empty or the default ST.</span>
</span>
<span class="line" id="L130">                    <span class="tok-kw">break</span> :blk default_st;</span>
<span class="line" id="L131">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (U != Empty <span class="tok-kw">and</span> S == Empty) {</span>
<span class="line" id="L132">                    <span class="tok-comment">// User tuple is custom but serializer tuple is empty or the default ST.</span>
</span>
<span class="line" id="L133">                    <span class="tok-kw">break</span> :blk user_st ++ default_st;</span>
<span class="line" id="L134">                } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (S != Empty <span class="tok-kw">and</span> U == Empty) {</span>
<span class="line" id="L135">                    <span class="tok-comment">// Serializer tuple is custom but user tuple is empty or the default ST.</span>
</span>
<span class="line" id="L136">                    <span class="tok-kw">break</span> :blk serializer_st ++ default_st;</span>
<span class="line" id="L137">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L138">                    <span class="tok-comment">// Both tuples are custom.</span>
</span>
<span class="line" id="L139">                    <span class="tok-kw">break</span> :blk user_st ++ serializer_st ++ default_st;</span>
<span class="line" id="L140">                }</span>
<span class="line" id="L141">            };</span>
<span class="line" id="L142"></span>
<span class="line" id="L143">            <span class="tok-comment">/// Serializes a Getty Boolean value.</span></span>
<span class="line" id="L144">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeBool</span>(self: Self, value: <span class="tok-type">bool</span>) E!T {</span>
<span class="line" id="L145">                <span class="tok-kw">if</span> (methods.serializeBool) |func| {</span>
<span class="line" id="L146">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, value);</span>
<span class="line" id="L147">                }</span>
<span class="line" id="L148"></span>
<span class="line" id="L149">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeBool is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L150">            }</span>
<span class="line" id="L151"></span>
<span class="line" id="L152">            <span class="tok-comment">// Serializes a Getty Enum value.</span>
</span>
<span class="line" id="L153">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeEnum</span>(self: Self, index: <span class="tok-kw">anytype</span>, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) E!T {</span>
<span class="line" id="L154">                <span class="tok-kw">if</span> (methods.serializeEnum) |func| {</span>
<span class="line" id="L155">                    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(index))) {</span>
<span class="line" id="L156">                        .Int, .ComptimeInt =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, index, name),</span>
<span class="line" id="L157">                        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;expected integer, found: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(index))),</span>
<span class="line" id="L158">                    }</span>
<span class="line" id="L159">                }</span>
<span class="line" id="L160"></span>
<span class="line" id="L161">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeEnum is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L162">            }</span>
<span class="line" id="L163"></span>
<span class="line" id="L164">            <span class="tok-comment">/// Serializes a Getty Float value.</span></span>
<span class="line" id="L165">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeFloat</span>(self: Self, value: <span class="tok-kw">anytype</span>) E!T {</span>
<span class="line" id="L166">                <span class="tok-kw">if</span> (methods.serializeFloat) |func| {</span>
<span class="line" id="L167">                    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(value))) {</span>
<span class="line" id="L168">                        .Float, .ComptimeFloat =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, value),</span>
<span class="line" id="L169">                        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;expected float, found: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(value))),</span>
<span class="line" id="L170">                    }</span>
<span class="line" id="L171">                }</span>
<span class="line" id="L172"></span>
<span class="line" id="L173">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeFloat is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L174">            }</span>
<span class="line" id="L175"></span>
<span class="line" id="L176">            <span class="tok-comment">/// Serializes a Getty Integer value.</span></span>
<span class="line" id="L177">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeInt</span>(self: Self, value: <span class="tok-kw">anytype</span>) E!T {</span>
<span class="line" id="L178">                <span class="tok-kw">if</span> (methods.serializeInt) |func| {</span>
<span class="line" id="L179">                    <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(value))) {</span>
<span class="line" id="L180">                        .Int, .ComptimeInt =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, value),</span>
<span class="line" id="L181">                        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;expected integer, found: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(value))),</span>
<span class="line" id="L182">                    }</span>
<span class="line" id="L183">                }</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeInt is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L186">            }</span>
<span class="line" id="L187"></span>
<span class="line" id="L188">            <span class="tok-comment">/// Begins the serialization process for a Getty Map value.</span></span>
<span class="line" id="L189">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeMap</span>(self: Self, length: ?<span class="tok-type">usize</span>) blk: {</span>
<span class="line" id="L190">                <span class="tok-kw">if</span> (Map) |M| {</span>
<span class="line" id="L191">                    <span class="tok-kw">break</span> :blk E!M;</span>
<span class="line" id="L192">                }</span>
<span class="line" id="L193"></span>
<span class="line" id="L194">                <span class="tok-comment">// If Map is null, then this function will raise a compile</span>
</span>
<span class="line" id="L195">                <span class="tok-comment">// error, so it doesn't really matter what the return type will</span>
</span>
<span class="line" id="L196">                <span class="tok-comment">// be. However, we use E!Impl specifically for its clean error</span>
</span>
<span class="line" id="L197">                <span class="tok-comment">// messages.</span>
</span>
<span class="line" id="L198">                <span class="tok-kw">break</span> :blk E!Impl;</span>
<span class="line" id="L199">            } {</span>
<span class="line" id="L200">                <span class="tok-kw">if</span> (Map == <span class="tok-null">null</span>) {</span>
<span class="line" id="L201">                    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeMap requires getty.ser.Map to be non-null&quot;</span>);</span>
<span class="line" id="L202">                }</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">                <span class="tok-kw">if</span> (methods.serializeMap) |func| {</span>
<span class="line" id="L205">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, length);</span>
<span class="line" id="L206">                }</span>
<span class="line" id="L207"></span>
<span class="line" id="L208">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeMap is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L209">            }</span>
<span class="line" id="L210"></span>
<span class="line" id="L211">            <span class="tok-comment">/// Serializes a Getty Null value.</span></span>
<span class="line" id="L212">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeNull</span>(self: Self) E!T {</span>
<span class="line" id="L213">                <span class="tok-kw">if</span> (methods.serializeNull) |func| {</span>
<span class="line" id="L214">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl);</span>
<span class="line" id="L215">                }</span>
<span class="line" id="L216"></span>
<span class="line" id="L217">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeNull is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L218">            }</span>
<span class="line" id="L219"></span>
<span class="line" id="L220">            <span class="tok-comment">/// Begins the serialization process for a Getty Sequence value.</span></span>
<span class="line" id="L221">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeSeq</span>(self: Self, length: ?<span class="tok-type">usize</span>) blk: {</span>
<span class="line" id="L222">                <span class="tok-kw">if</span> (Seq) |S| {</span>
<span class="line" id="L223">                    <span class="tok-kw">break</span> :blk E!S;</span>
<span class="line" id="L224">                }</span>
<span class="line" id="L225"></span>
<span class="line" id="L226">                <span class="tok-comment">// If Seq is null, then this function will raise a compile</span>
</span>
<span class="line" id="L227">                <span class="tok-comment">// error, so it doesn't really matter what the return type will</span>
</span>
<span class="line" id="L228">                <span class="tok-comment">// be. However, we use E!Impl specifically for its clean error</span>
</span>
<span class="line" id="L229">                <span class="tok-comment">// messages.</span>
</span>
<span class="line" id="L230">                <span class="tok-kw">break</span> :blk E!Impl;</span>
<span class="line" id="L231">            } {</span>
<span class="line" id="L232">                <span class="tok-kw">if</span> (Seq == <span class="tok-null">null</span>) {</span>
<span class="line" id="L233">                    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeSeq requires getty.ser.Seq to be non-null&quot;</span>);</span>
<span class="line" id="L234">                }</span>
<span class="line" id="L235"></span>
<span class="line" id="L236">                <span class="tok-kw">if</span> (methods.serializeSeq) |func| {</span>
<span class="line" id="L237">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, length);</span>
<span class="line" id="L238">                }</span>
<span class="line" id="L239"></span>
<span class="line" id="L240">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeSeq is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L241">            }</span>
<span class="line" id="L242"></span>
<span class="line" id="L243">            <span class="tok-comment">/// Serializes a Getty Optional value.</span></span>
<span class="line" id="L244">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeSome</span>(self: Self, value: <span class="tok-kw">anytype</span>) E!T {</span>
<span class="line" id="L245">                <span class="tok-kw">if</span> (methods.serializeSome) |func| {</span>
<span class="line" id="L246">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, value);</span>
<span class="line" id="L247">                }</span>
<span class="line" id="L248"></span>
<span class="line" id="L249">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeSome is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L250">            }</span>
<span class="line" id="L251"></span>
<span class="line" id="L252">            <span class="tok-comment">/// Serializes a Getty String value.</span></span>
<span class="line" id="L253">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeString</span>(self: Self, value: <span class="tok-kw">anytype</span>) E!T {</span>
<span class="line" id="L254">                <span class="tok-kw">if</span> (methods.serializeString) |func| {</span>
<span class="line" id="L255">                    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> !isString(<span class="tok-builtin">@TypeOf</span>(value))) {</span>
<span class="line" id="L256">                        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;expected string, found: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(<span class="tok-builtin">@TypeOf</span>(value)));</span>
<span class="line" id="L257">                    }</span>
<span class="line" id="L258"></span>
<span class="line" id="L259">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, value);</span>
<span class="line" id="L260">                }</span>
<span class="line" id="L261"></span>
<span class="line" id="L262">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeString is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L263">            }</span>
<span class="line" id="L264"></span>
<span class="line" id="L265">            <span class="tok-comment">/// Begins the serialization process for a Getty Struct value.</span></span>
<span class="line" id="L266">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeStruct</span>(self: Self, <span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, length: <span class="tok-type">usize</span>) blk: {</span>
<span class="line" id="L267">                <span class="tok-kw">if</span> (Struct) |S| {</span>
<span class="line" id="L268">                    <span class="tok-kw">break</span> :blk E!S;</span>
<span class="line" id="L269">                }</span>
<span class="line" id="L270"></span>
<span class="line" id="L271">                <span class="tok-comment">// If Struct is null, then this function will raise a compile</span>
</span>
<span class="line" id="L272">                <span class="tok-comment">// error, so it doesn't really matter what the return type will</span>
</span>
<span class="line" id="L273">                <span class="tok-comment">// be. However, we use E!Impl specifically for its clean error</span>
</span>
<span class="line" id="L274">                <span class="tok-comment">// messages.</span>
</span>
<span class="line" id="L275">                <span class="tok-kw">break</span> :blk E!Impl;</span>
<span class="line" id="L276">            } {</span>
<span class="line" id="L277">                <span class="tok-kw">if</span> (Struct == <span class="tok-null">null</span>) {</span>
<span class="line" id="L278">                    <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeStruct requires getty.ser.Structure to be non-null&quot;</span>);</span>
<span class="line" id="L279">                }</span>
<span class="line" id="L280"></span>
<span class="line" id="L281">                <span class="tok-kw">if</span> (methods.serializeStruct) |func| {</span>
<span class="line" id="L282">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl, name, length);</span>
<span class="line" id="L283">                }</span>
<span class="line" id="L284"></span>
<span class="line" id="L285">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeStruct is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L286">            }</span>
<span class="line" id="L287"></span>
<span class="line" id="L288">            <span class="tok-comment">/// Serializes a Getty Void value.</span></span>
<span class="line" id="L289">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializeVoid</span>(self: Self) E!T {</span>
<span class="line" id="L290">                <span class="tok-kw">if</span> (methods.serializeVoid) |func| {</span>
<span class="line" id="L291">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> func(self.impl);</span>
<span class="line" id="L292">                }</span>
<span class="line" id="L293"></span>
<span class="line" id="L294">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;serializeVoid is not implemented by type: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(Impl));</span>
<span class="line" id="L295">            }</span>
<span class="line" id="L296">        };</span>
<span class="line" id="L297"></span>
<span class="line" id="L298">        <span class="tok-comment">/// Returns an interface value.</span></span>
<span class="line" id="L299">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serializer</span>(impl: Impl) @&quot;getty.Serializer&quot; {</span>
<span class="line" id="L300">            <span class="tok-kw">return</span> .{ .impl = impl };</span>
<span class="line" id="L301">        }</span>
<span class="line" id="L302">    };</span>
<span class="line" id="L303">}</span>
<span class="line" id="L304"></span>
<span class="line" id="L305"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeAnyFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L306">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl, value: <span class="tok-kw">anytype</span>) E!T;</span>
<span class="line" id="L307">}</span>
<span class="line" id="L308"></span>
<span class="line" id="L309"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeBoolFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L310">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl, value: <span class="tok-type">bool</span>) E!T;</span>
<span class="line" id="L311">}</span>
<span class="line" id="L312"></span>
<span class="line" id="L313"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeEnumFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L314">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl, index: <span class="tok-kw">anytype</span>, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) E!T;</span>
<span class="line" id="L315">}</span>
<span class="line" id="L316"></span>
<span class="line" id="L317"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeMapSeqFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> MapSeq: ?<span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L318">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl, length: ?<span class="tok-type">usize</span>) blk: {</span>
<span class="line" id="L319">        <span class="tok-kw">if</span> (MapSeq) |T| {</span>
<span class="line" id="L320">            <span class="tok-kw">break</span> :blk E!T;</span>
<span class="line" id="L321">        }</span>
<span class="line" id="L322"></span>
<span class="line" id="L323">        <span class="tok-comment">// If MapSeq is null, then this function will raise a compile error, so</span>
</span>
<span class="line" id="L324">        <span class="tok-comment">// it doesn't really matter what the return type will be. However, we</span>
</span>
<span class="line" id="L325">        <span class="tok-comment">// use E!Impl specifically for its clean error messages.</span>
</span>
<span class="line" id="L326">        <span class="tok-kw">break</span> :blk E!Impl;</span>
<span class="line" id="L327">    };</span>
<span class="line" id="L328">}</span>
<span class="line" id="L329"></span>
<span class="line" id="L330"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeNothingFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L331">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl) E!T;</span>
<span class="line" id="L332">}</span>
<span class="line" id="L333"></span>
<span class="line" id="L334"><span class="tok-kw">fn</span> <span class="tok-fn">SerializeStructFn</span>(<span class="tok-kw">comptime</span> Impl: <span class="tok-type">type</span>, <span class="tok-kw">comptime</span> Struct: ?<span class="tok-type">type</span>, <span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L335">    <span class="tok-kw">return</span> ?<span class="tok-kw">fn</span> (impl: Impl, <span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, length: <span class="tok-type">usize</span>) blk: {</span>
<span class="line" id="L336">        <span class="tok-kw">if</span> (Struct) |T| {</span>
<span class="line" id="L337">            <span class="tok-kw">break</span> :blk E!T;</span>
<span class="line" id="L338">        }</span>
<span class="line" id="L339"></span>
<span class="line" id="L340">        <span class="tok-comment">// If Struct is null, then this function will raise a compile error, so</span>
</span>
<span class="line" id="L341">        <span class="tok-comment">// it doesn't really matter what the return type will be. However, we</span>
</span>
<span class="line" id="L342">        <span class="tok-comment">// use E!Impl specifically for its clean error messages.</span>
</span>
<span class="line" id="L343">        <span class="tok-kw">break</span> :blk E!Impl;</span>
<span class="line" id="L344">    };</span>
<span class="line" id="L345">}</span>
<span class="line" id="L346"></span>
</code></pre></body>
</html>