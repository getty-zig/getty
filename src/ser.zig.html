<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>ser.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! Serialization framework.</span></span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L4"></span>
<span class="line" id="L5"><span class="tok-comment">/// Serializer interface.</span></span>
<span class="line" id="L6"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Serializer = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/interfaces/serializer.zig&quot;</span>).Serializer;</span>
<span class="line" id="L7"></span>
<span class="line" id="L8"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> default_st = .{</span>
<span class="line" id="L9">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L10">    <span class="tok-comment">// Standard Library</span>
</span>
<span class="line" id="L11">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L12"></span>
<span class="line" id="L13">    ser.blocks.ArrayList,</span>
<span class="line" id="L14">    ser.blocks.BoundedArray,</span>
<span class="line" id="L15">    ser.blocks.BufMap,</span>
<span class="line" id="L16">    ser.blocks.HashMap,</span>
<span class="line" id="L17">    ser.blocks.LinkedList,</span>
<span class="line" id="L18">    ser.blocks.TailQueue,</span>
<span class="line" id="L19"></span>
<span class="line" id="L20">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L21">    <span class="tok-comment">// Primitives</span>
</span>
<span class="line" id="L22">    <span class="tok-comment">////////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L23"></span>
<span class="line" id="L24">    ser.blocks.Array,</span>
<span class="line" id="L25">    ser.blocks.Bool,</span>
<span class="line" id="L26">    ser.blocks.Enum,</span>
<span class="line" id="L27">    ser.blocks.Error,</span>
<span class="line" id="L28">    ser.blocks.Float,</span>
<span class="line" id="L29">    ser.blocks.Int,</span>
<span class="line" id="L30">    ser.blocks.Null,</span>
<span class="line" id="L31">    ser.blocks.Optional,</span>
<span class="line" id="L32">    ser.blocks.Pointer,</span>
<span class="line" id="L33">    ser.blocks.Slice,</span>
<span class="line" id="L34">    ser.blocks.String,</span>
<span class="line" id="L35">    ser.blocks.Struct,</span>
<span class="line" id="L36">    ser.blocks.Tuple,</span>
<span class="line" id="L37">    ser.blocks.Union,</span>
<span class="line" id="L38">    ser.blocks.Vector,</span>
<span class="line" id="L39">    ser.blocks.Void,</span>
<span class="line" id="L40">};</span>
<span class="line" id="L41"></span>
<span class="line" id="L42"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> concepts = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L43">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/concepts/serializer.zig&quot;</span>);</span>
<span class="line" id="L44">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/concepts/map.zig&quot;</span>);</span>
<span class="line" id="L45">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/concepts/seq.zig&quot;</span>);</span>
<span class="line" id="L46">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/concepts/structure.zig&quot;</span>);</span>
<span class="line" id="L47">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/concepts/sbt.zig&quot;</span>);</span>
<span class="line" id="L48">};</span>
<span class="line" id="L49"></span>
<span class="line" id="L50"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> traits = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L51">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/traits/sbt.zig&quot;</span>);</span>
<span class="line" id="L52">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/traits/attributes.zig&quot;</span>);</span>
<span class="line" id="L53">};</span>
<span class="line" id="L54"></span>
<span class="line" id="L55"><span class="tok-comment">/// A namespace for serialization-specific types and functions.</span></span>
<span class="line" id="L56"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ser = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L57">    <span class="tok-comment">/// Serialization interface for Getty Maps.</span></span>
<span class="line" id="L58">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Map = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/interfaces/map.zig&quot;</span>).Map;</span>
<span class="line" id="L59"></span>
<span class="line" id="L60">    <span class="tok-comment">/// Serialization interface for Getty Sequences.</span></span>
<span class="line" id="L61">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Seq = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/interfaces/seq.zig&quot;</span>).Seq;</span>
<span class="line" id="L62"></span>
<span class="line" id="L63">    <span class="tok-comment">/// Serialization interface for Getty Structures.</span></span>
<span class="line" id="L64">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Structure = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/interfaces/structure.zig&quot;</span>).Structure;</span>
<span class="line" id="L65"></span>
<span class="line" id="L66">    <span class="tok-comment">/// Serialization blocks provided by Getty.</span></span>
<span class="line" id="L67">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> blocks = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L68">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L69">        <span class="tok-comment">// Standard Library</span>
</span>
<span class="line" id="L70">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L71"></span>
<span class="line" id="L72">        <span class="tok-comment">/// Serialization block for `std.ArrayList` values.</span></span>
<span class="line" id="L73">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ArrayList = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/array_list.zig&quot;</span>);</span>
<span class="line" id="L74"></span>
<span class="line" id="L75">        <span class="tok-comment">/// Serialization block for `std.BoundedArray` values.</span></span>
<span class="line" id="L76">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> BoundedArray = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/bounded_array.zig&quot;</span>);</span>
<span class="line" id="L77"></span>
<span class="line" id="L78">        <span class="tok-comment">/// Serialization block for `std.BufMap` values.</span></span>
<span class="line" id="L79">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> BufMap = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/buf_map.zig&quot;</span>);</span>
<span class="line" id="L80"></span>
<span class="line" id="L81">        <span class="tok-comment">/// Serialization block for `std.HashMap` values.</span></span>
<span class="line" id="L82">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> HashMap = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/hash_map.zig&quot;</span>);</span>
<span class="line" id="L83"></span>
<span class="line" id="L84">        <span class="tok-comment">/// Serialization block for `std.SinglyLinkedList` values.</span></span>
<span class="line" id="L85">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkedList = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/linked_list.zig&quot;</span>);</span>
<span class="line" id="L86"></span>
<span class="line" id="L87">        <span class="tok-comment">/// Serialization block for `std.TailQueue`.</span></span>
<span class="line" id="L88">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> TailQueue = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/tail_queue.zig&quot;</span>);</span>
<span class="line" id="L89"></span>
<span class="line" id="L90">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L91">        <span class="tok-comment">// Primitives</span>
</span>
<span class="line" id="L92">        <span class="tok-comment">////////////////////////////////////////////////////////////////////////</span>
</span>
<span class="line" id="L93"></span>
<span class="line" id="L94">        <span class="tok-comment">/// Serialization block for array values.</span></span>
<span class="line" id="L95">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Array = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/array.zig&quot;</span>);</span>
<span class="line" id="L96"></span>
<span class="line" id="L97">        <span class="tok-comment">/// Serialization block for `bool` values.</span></span>
<span class="line" id="L98">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Bool = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/bool.zig&quot;</span>);</span>
<span class="line" id="L99"></span>
<span class="line" id="L100">        <span class="tok-comment">/// Serialization block for `enum` values.</span></span>
<span class="line" id="L101">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Enum = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/enum.zig&quot;</span>);</span>
<span class="line" id="L102"></span>
<span class="line" id="L103">        <span class="tok-comment">/// Serialization block for `error` values.</span></span>
<span class="line" id="L104">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Error = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/error.zig&quot;</span>);</span>
<span class="line" id="L105"></span>
<span class="line" id="L106">        <span class="tok-comment">/// Serialization block for floating-point values.</span></span>
<span class="line" id="L107">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Float = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/float.zig&quot;</span>);</span>
<span class="line" id="L108"></span>
<span class="line" id="L109">        <span class="tok-comment">/// Serialization block for integer values.</span></span>
<span class="line" id="L110">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Int = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/int.zig&quot;</span>);</span>
<span class="line" id="L111"></span>
<span class="line" id="L112">        <span class="tok-comment">/// Serialization block for `null` values.</span></span>
<span class="line" id="L113">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Null = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/null.zig&quot;</span>);</span>
<span class="line" id="L114"></span>
<span class="line" id="L115">        <span class="tok-comment">/// Serialization block for optional values.</span></span>
<span class="line" id="L116">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Optional = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/optional.zig&quot;</span>);</span>
<span class="line" id="L117"></span>
<span class="line" id="L118">        <span class="tok-comment">/// Serialization block for pointer values.</span></span>
<span class="line" id="L119">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Pointer = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/pointer.zig&quot;</span>);</span>
<span class="line" id="L120"></span>
<span class="line" id="L121">        <span class="tok-comment">/// Serialization block for slice values.</span></span>
<span class="line" id="L122">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Slice = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/slice.zig&quot;</span>);</span>
<span class="line" id="L123"></span>
<span class="line" id="L124">        <span class="tok-comment">/// Serialization block for string values.</span></span>
<span class="line" id="L125">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> String = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/string.zig&quot;</span>);</span>
<span class="line" id="L126"></span>
<span class="line" id="L127">        <span class="tok-comment">/// Serialization block for `struct` values.</span></span>
<span class="line" id="L128">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Struct = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/struct.zig&quot;</span>);</span>
<span class="line" id="L129"></span>
<span class="line" id="L130">        <span class="tok-comment">/// Serialization block for tuple values.</span></span>
<span class="line" id="L131">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Tuple = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/tuple.zig&quot;</span>);</span>
<span class="line" id="L132"></span>
<span class="line" id="L133">        <span class="tok-comment">/// Serialization block for `union` values.</span></span>
<span class="line" id="L134">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Union = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/union.zig&quot;</span>);</span>
<span class="line" id="L135"></span>
<span class="line" id="L136">        <span class="tok-comment">/// Serialization block for vector values.</span></span>
<span class="line" id="L137">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Vector = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/vector.zig&quot;</span>);</span>
<span class="line" id="L138"></span>
<span class="line" id="L139">        <span class="tok-comment">/// Serialization block for `void` values.</span></span>
<span class="line" id="L140">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Void = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;ser/blocks/void.zig&quot;</span>);</span>
<span class="line" id="L141">    };</span>
<span class="line" id="L142"></span>
<span class="line" id="L143">    <span class="tok-comment">/// Returns the attributes for a type. If none exists, `null` is returned.</span></span>
<span class="line" id="L144">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getAttributes</span>(</span>
<span class="line" id="L145">        <span class="tok-comment">/// The type for which attributes should be returned.</span></span>
<span class="line" id="L146">        <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L147">        <span class="tok-comment">/// A `getty.Serializer` interface type.</span></span>
<span class="line" id="L148">        <span class="tok-kw">comptime</span> S: <span class="tok-type">type</span>,</span>
<span class="line" id="L149">    ) blk: {</span>
<span class="line" id="L150">        <span class="tok-comment">// Process user SBTs.</span>
</span>
<span class="line" id="L151">        <span class="tok-kw">for</span> (S.user_st) |sb| {</span>
<span class="line" id="L152">            <span class="tok-kw">if</span> (sb.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, sb)) {</span>
<span class="line" id="L153">                <span class="tok-kw">break</span> :blk ?<span class="tok-builtin">@TypeOf</span>(sb.attributes);</span>
<span class="line" id="L154">            }</span>
<span class="line" id="L155">        }</span>
<span class="line" id="L156"></span>
<span class="line" id="L157">        <span class="tok-comment">// Process type SBTs.</span>
</span>
<span class="line" id="L158">        <span class="tok-kw">if</span> (traits.has_sbt(T)) {</span>
<span class="line" id="L159">            <span class="tok-kw">const</span> sbt = T.@&quot;getty.sbt&quot;;</span>
<span class="line" id="L160">            <span class="tok-kw">const</span> st = <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(sbt) == <span class="tok-type">type</span>) .{sbt} <span class="tok-kw">else</span> sbt;</span>
<span class="line" id="L161"></span>
<span class="line" id="L162">            <span class="tok-kw">for</span> (st) |sb| {</span>
<span class="line" id="L163">                <span class="tok-kw">if</span> (sb.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, sb)) {</span>
<span class="line" id="L164">                    <span class="tok-kw">break</span> :blk ?<span class="tok-builtin">@TypeOf</span>(sb.attributes);</span>
<span class="line" id="L165">                }</span>
<span class="line" id="L166">            }</span>
<span class="line" id="L167">        }</span>
<span class="line" id="L168"></span>
<span class="line" id="L169">        <span class="tok-kw">break</span> :blk ?<span class="tok-type">void</span>;</span>
<span class="line" id="L170">    } {</span>
<span class="line" id="L171">        <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L172">            <span class="tok-comment">// Process user SBTs.</span>
</span>
<span class="line" id="L173">            <span class="tok-kw">for</span> (S.user_st) |sb| {</span>
<span class="line" id="L174">                <span class="tok-kw">if</span> (sb.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, sb)) {</span>
<span class="line" id="L175">                    <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(?<span class="tok-builtin">@TypeOf</span>(sb.attributes), sb.attributes);</span>
<span class="line" id="L176">                }</span>
<span class="line" id="L177">            }</span>
<span class="line" id="L178"></span>
<span class="line" id="L179">            <span class="tok-comment">// Process type SBTs.</span>
</span>
<span class="line" id="L180">            <span class="tok-kw">if</span> (traits.has_sbt(T)) {</span>
<span class="line" id="L181">                <span class="tok-kw">const</span> sbt = T.@&quot;getty.sbt&quot;;</span>
<span class="line" id="L182">                <span class="tok-kw">const</span> st = <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(sbt) == <span class="tok-type">type</span>) .{sbt} <span class="tok-kw">else</span> sbt;</span>
<span class="line" id="L183"></span>
<span class="line" id="L184">                <span class="tok-kw">for</span> (st) |sb| {</span>
<span class="line" id="L185">                    <span class="tok-kw">if</span> (sb.is(T) <span class="tok-kw">and</span> traits.has_attributes(T, sb)) {</span>
<span class="line" id="L186">                        <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(?<span class="tok-builtin">@TypeOf</span>(sb.attributes), sb.attributes);</span>
<span class="line" id="L187">                    }</span>
<span class="line" id="L188">                }</span>
<span class="line" id="L189">            }</span>
<span class="line" id="L190"></span>
<span class="line" id="L191">            <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L192">        }</span>
<span class="line" id="L193">    }</span>
<span class="line" id="L194">};</span>
<span class="line" id="L195"></span>
<span class="line" id="L196"><span class="tok-comment">/// Serializes a value.</span></span>
<span class="line" id="L197"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">serialize</span>(</span>
<span class="line" id="L198">    <span class="tok-comment">/// A value to serialize.</span></span>
<span class="line" id="L199">    value: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L200">    <span class="tok-comment">/// A `getty.Serializer` interface value.</span></span>
<span class="line" id="L201">    serializer: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L202">) blk: {</span>
<span class="line" id="L203">    <span class="tok-kw">const</span> S = <span class="tok-builtin">@TypeOf</span>(serializer);</span>
<span class="line" id="L204"></span>
<span class="line" id="L205">    concepts.@&quot;getty.Serializer&quot;(S);</span>
<span class="line" id="L206"></span>
<span class="line" id="L207">    <span class="tok-kw">break</span> :blk S.Error!S.Ok;</span>
<span class="line" id="L208">} {</span>
<span class="line" id="L209">    <span class="tok-kw">const</span> block = <span class="tok-kw">comptime</span> blk: {</span>
<span class="line" id="L210">        <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(value);</span>
<span class="line" id="L211"></span>
<span class="line" id="L212">        <span class="tok-comment">// Process user SBTs.</span>
</span>
<span class="line" id="L213">        <span class="tok-kw">for</span> (<span class="tok-builtin">@TypeOf</span>(serializer).user_st) |sb| {</span>
<span class="line" id="L214">            <span class="tok-kw">if</span> (sb.is(T)) {</span>
<span class="line" id="L215">                <span class="tok-kw">break</span> :blk sb;</span>
<span class="line" id="L216">            }</span>
<span class="line" id="L217">        }</span>
<span class="line" id="L218"></span>
<span class="line" id="L219">        <span class="tok-comment">// Process type SBTs.</span>
</span>
<span class="line" id="L220">        <span class="tok-kw">if</span> (traits.has_sbt(T)) {</span>
<span class="line" id="L221">            <span class="tok-kw">const</span> sbt = T.@&quot;getty.sbt&quot;;</span>
<span class="line" id="L222">            <span class="tok-kw">const</span> st = <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(sbt) == <span class="tok-type">type</span>) .{sbt} <span class="tok-kw">else</span> sbt;</span>
<span class="line" id="L223"></span>
<span class="line" id="L224">            <span class="tok-kw">for</span> (st) |sb| {</span>
<span class="line" id="L225">                <span class="tok-kw">if</span> (sb.is(T)) {</span>
<span class="line" id="L226">                    <span class="tok-kw">break</span> :blk sb;</span>
<span class="line" id="L227">                }</span>
<span class="line" id="L228">            }</span>
<span class="line" id="L229">        }</span>
<span class="line" id="L230"></span>
<span class="line" id="L231">        <span class="tok-comment">// Process serializer SBTs.</span>
</span>
<span class="line" id="L232">        <span class="tok-kw">for</span> (<span class="tok-builtin">@TypeOf</span>(serializer).serializer_st) |sb| {</span>
<span class="line" id="L233">            <span class="tok-kw">if</span> (sb.is(T)) {</span>
<span class="line" id="L234">                <span class="tok-kw">break</span> :blk sb;</span>
<span class="line" id="L235">            }</span>
<span class="line" id="L236">        }</span>
<span class="line" id="L237"></span>
<span class="line" id="L238">        <span class="tok-comment">// Process default SBTs.</span>
</span>
<span class="line" id="L239">        <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (default_st) |sb| {</span>
<span class="line" id="L240">            <span class="tok-kw">if</span> (sb.is(T)) {</span>
<span class="line" id="L241">                <span class="tok-kw">break</span> :blk sb;</span>
<span class="line" id="L242">            }</span>
<span class="line" id="L243">        }</span>
<span class="line" id="L244"></span>
<span class="line" id="L245">        <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;type is not supported: &quot;</span> ++ <span class="tok-builtin">@typeName</span>(T));</span>
<span class="line" id="L246">    };</span>
<span class="line" id="L247"></span>
<span class="line" id="L248">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> serializeInternal(value, serializer, block);</span>
<span class="line" id="L249">}</span>
<span class="line" id="L250"></span>
<span class="line" id="L251"><span class="tok-kw">fn</span> <span class="tok-fn">serializeInternal</span>(value: <span class="tok-kw">anytype</span>, serializer: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> sb: <span class="tok-type">type</span>) blk: {</span>
<span class="line" id="L252">    <span class="tok-kw">const</span> S = <span class="tok-builtin">@TypeOf</span>(serializer);</span>
<span class="line" id="L253"></span>
<span class="line" id="L254">    concepts.@&quot;getty.Serializer&quot;(S);</span>
<span class="line" id="L255">    concepts.@&quot;getty.ser.sbt&quot;(sb);</span>
<span class="line" id="L256"></span>
<span class="line" id="L257">    <span class="tok-kw">break</span> :blk S.Error!S.Ok;</span>
<span class="line" id="L258">} {</span>
<span class="line" id="L259">    <span class="tok-kw">const</span> T = <span class="tok-builtin">@TypeOf</span>(value);</span>
<span class="line" id="L260"></span>
<span class="line" id="L261">    <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> traits.has_attributes(T, sb)) {</span>
<span class="line" id="L262">        <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(T)) {</span>
<span class="line" id="L263">            .Struct =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> ser.blocks.Struct.serialize(value, serializer),</span>
<span class="line" id="L264">            .Enum =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> ser.blocks.Enum.serialize(value, serializer),</span>
<span class="line" id="L265">            .Union =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> ser.blocks.Union.serialize(value, serializer),</span>
<span class="line" id="L266">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unexpected type cannot be serialized using attributes&quot;</span>),</span>
<span class="line" id="L267">        }</span>
<span class="line" id="L268">    }</span>
<span class="line" id="L269"></span>
<span class="line" id="L270">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> sb.serialize(value, serializer);</span>
<span class="line" id="L271">}</span>
<span class="line" id="L272"></span>
<span class="line" id="L273"><span class="tok-kw">const</span> Token = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;tests/common.zig&quot;</span>).Token;</span>
<span class="line" id="L274"></span>
<span class="line" id="L275"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L276"></span>
<span class="line" id="L277"><span class="tok-kw">const</span> test_allocator = testing.allocator;</span>
<span class="line" id="L278"><span class="tok-kw">const</span> expect = testing.expect;</span>
<span class="line" id="L279"><span class="tok-kw">const</span> expectEqual = testing.expectEqual;</span>
<span class="line" id="L280"><span class="tok-kw">const</span> expectEqualSlices = testing.expectEqualSlices;</span>
<span class="line" id="L281"></span>
<span class="line" id="L282"><span class="tok-kw">const</span> TestSerializer = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L283">    tokens: []<span class="tok-kw">const</span> Token,</span>
<span class="line" id="L284"></span>
<span class="line" id="L285">    <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L286"></span>
<span class="line" id="L287">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(tokens: []<span class="tok-kw">const</span> Token) Self {</span>
<span class="line" id="L288">        <span class="tok-kw">return</span> .{ .tokens = tokens };</span>
<span class="line" id="L289">    }</span>
<span class="line" id="L290"></span>
<span class="line" id="L291">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">remaining</span>(self: Self) <span class="tok-type">usize</span> {</span>
<span class="line" id="L292">        <span class="tok-kw">return</span> self.tokens.len;</span>
<span class="line" id="L293">    }</span>
<span class="line" id="L294"></span>
<span class="line" id="L295">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">nextTokenOpt</span>(self: *Self) ?Token {</span>
<span class="line" id="L296">        <span class="tok-kw">switch</span> (self.remaining()) {</span>
<span class="line" id="L297">            <span class="tok-number">0</span> =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L298">            <span class="tok-kw">else</span> =&gt; |len| {</span>
<span class="line" id="L299">                <span class="tok-kw">const</span> first = self.tokens[<span class="tok-number">0</span>];</span>
<span class="line" id="L300">                self.tokens = <span class="tok-kw">if</span> (len == <span class="tok-number">1</span>) &amp;[_]Token{} <span class="tok-kw">else</span> self.tokens[<span class="tok-number">1</span>..];</span>
<span class="line" id="L301">                <span class="tok-kw">return</span> first;</span>
<span class="line" id="L302">            },</span>
<span class="line" id="L303">        }</span>
<span class="line" id="L304">    }</span>
<span class="line" id="L305"></span>
<span class="line" id="L306">    <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> Serializer(</span>
<span class="line" id="L307">        *Self,</span>
<span class="line" id="L308">        Ok,</span>
<span class="line" id="L309">        Error,</span>
<span class="line" id="L310">        <span class="tok-null">null</span>,</span>
<span class="line" id="L311">        <span class="tok-null">null</span>,</span>
<span class="line" id="L312">        Map,</span>
<span class="line" id="L313">        Seq,</span>
<span class="line" id="L314">        Structure,</span>
<span class="line" id="L315">        .{</span>
<span class="line" id="L316">            .serializeBool = serializeBool,</span>
<span class="line" id="L317">            .serializeEnum = serializeEnum,</span>
<span class="line" id="L318">            .serializeFloat = serializeFloat,</span>
<span class="line" id="L319">            .serializeInt = serializeInt,</span>
<span class="line" id="L320">            .serializeMap = serializeMap,</span>
<span class="line" id="L321">            .serializeNull = serializeNull,</span>
<span class="line" id="L322">            .serializeSeq = serializeSeq,</span>
<span class="line" id="L323">            .serializeSome = serializeSome,</span>
<span class="line" id="L324">            .serializeString = serializeString,</span>
<span class="line" id="L325">            .serializeStruct = serializeStruct,</span>
<span class="line" id="L326">            .serializeVoid = serializeVoid,</span>
<span class="line" id="L327">        },</span>
<span class="line" id="L328">    );</span>
<span class="line" id="L329"></span>
<span class="line" id="L330">    <span class="tok-kw">const</span> Ok = <span class="tok-type">void</span>;</span>
<span class="line" id="L331">    <span class="tok-kw">const</span> Error = std.mem.Allocator.Error || <span class="tok-kw">error</span>{TestExpectedEqual};</span>
<span class="line" id="L332"></span>
<span class="line" id="L333">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeBool</span>(self: *Self, v: <span class="tok-type">bool</span>) Error!Ok {</span>
<span class="line" id="L334">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Bool = v });</span>
<span class="line" id="L335">    }</span>
<span class="line" id="L336"></span>
<span class="line" id="L337">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeEnum</span>(self: *Self, v: <span class="tok-kw">anytype</span>) Error!Ok {</span>
<span class="line" id="L338">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Enum = {} });</span>
<span class="line" id="L339">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .String = <span class="tok-builtin">@tagName</span>(v) });</span>
<span class="line" id="L340">    }</span>
<span class="line" id="L341"></span>
<span class="line" id="L342">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeFloat</span>(self: *Self, v: <span class="tok-kw">anytype</span>) Error!Ok {</span>
<span class="line" id="L343">        <span class="tok-kw">var</span> expected = <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(v))) {</span>
<span class="line" id="L344">            .ComptimeFloat =&gt; Token{ .ComptimeFloat = {} },</span>
<span class="line" id="L345">            .Float =&gt; |info| <span class="tok-kw">switch</span> (info.bits) {</span>
<span class="line" id="L346">                <span class="tok-number">16</span> =&gt; Token{ .F16 = v },</span>
<span class="line" id="L347">                <span class="tok-number">32</span> =&gt; Token{ .F32 = v },</span>
<span class="line" id="L348">                <span class="tok-number">64</span> =&gt; Token{ .F64 = v },</span>
<span class="line" id="L349">                <span class="tok-number">128</span> =&gt; Token{ .F128 = v },</span>
<span class="line" id="L350">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unexpected float size&quot;</span>),</span>
<span class="line" id="L351">            },</span>
<span class="line" id="L352">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unexpected type&quot;</span>),</span>
<span class="line" id="L353">        };</span>
<span class="line" id="L354"></span>
<span class="line" id="L355">        <span class="tok-kw">try</span> assertNextToken(self, expected);</span>
<span class="line" id="L356">    }</span>
<span class="line" id="L357"></span>
<span class="line" id="L358">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeInt</span>(self: *Self, v: <span class="tok-kw">anytype</span>) Error!Ok {</span>
<span class="line" id="L359">        <span class="tok-kw">var</span> expected = <span class="tok-kw">switch</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(v))) {</span>
<span class="line" id="L360">            .ComptimeInt =&gt; Token{ .ComptimeInt = {} },</span>
<span class="line" id="L361">            .Int =&gt; |info| <span class="tok-kw">switch</span> (info.signedness) {</span>
<span class="line" id="L362">                .signed =&gt; <span class="tok-kw">switch</span> (info.bits) {</span>
<span class="line" id="L363">                    <span class="tok-number">8</span> =&gt; Token{ .I8 = v },</span>
<span class="line" id="L364">                    <span class="tok-number">16</span> =&gt; Token{ .I16 = v },</span>
<span class="line" id="L365">                    <span class="tok-number">32</span> =&gt; Token{ .I32 = v },</span>
<span class="line" id="L366">                    <span class="tok-number">64</span> =&gt; Token{ .I64 = v },</span>
<span class="line" id="L367">                    <span class="tok-number">128</span> =&gt; Token{ .I128 = v },</span>
<span class="line" id="L368">                    <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unexpected integer size&quot;</span>),</span>
<span class="line" id="L369">                },</span>
<span class="line" id="L370">                .unsigned =&gt; <span class="tok-kw">switch</span> (info.bits) {</span>
<span class="line" id="L371">                    <span class="tok-number">8</span> =&gt; Token{ .U8 = v },</span>
<span class="line" id="L372">                    <span class="tok-number">16</span> =&gt; Token{ .U16 = v },</span>
<span class="line" id="L373">                    <span class="tok-number">32</span> =&gt; Token{ .U32 = v },</span>
<span class="line" id="L374">                    <span class="tok-number">64</span> =&gt; Token{ .U64 = v },</span>
<span class="line" id="L375">                    <span class="tok-number">128</span> =&gt; Token{ .U128 = v },</span>
<span class="line" id="L376">                    <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unexpected integer size&quot;</span>),</span>
<span class="line" id="L377">                },</span>
<span class="line" id="L378">            },</span>
<span class="line" id="L379">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unexpected type&quot;</span>),</span>
<span class="line" id="L380">        };</span>
<span class="line" id="L381"></span>
<span class="line" id="L382">        <span class="tok-kw">try</span> assertNextToken(self, expected);</span>
<span class="line" id="L383">    }</span>
<span class="line" id="L384"></span>
<span class="line" id="L385">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeMap</span>(self: *Self, length: ?<span class="tok-type">usize</span>) Error!Map {</span>
<span class="line" id="L386">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Map = .{ .len = length } });</span>
<span class="line" id="L387"></span>
<span class="line" id="L388">        <span class="tok-kw">return</span> Map{ .ser = self };</span>
<span class="line" id="L389">    }</span>
<span class="line" id="L390"></span>
<span class="line" id="L391">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeNull</span>(self: *Self) Error!Ok {</span>
<span class="line" id="L392">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Null = {} });</span>
<span class="line" id="L393">    }</span>
<span class="line" id="L394"></span>
<span class="line" id="L395">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeSeq</span>(self: *Self, length: ?<span class="tok-type">usize</span>) Error!Seq {</span>
<span class="line" id="L396">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Seq = .{ .len = length } });</span>
<span class="line" id="L397">        <span class="tok-kw">return</span> Seq{ .ser = self };</span>
<span class="line" id="L398">    }</span>
<span class="line" id="L399"></span>
<span class="line" id="L400">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeSome</span>(self: *Self, v: <span class="tok-kw">anytype</span>) Error!Ok {</span>
<span class="line" id="L401">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Some = {} });</span>
<span class="line" id="L402">        <span class="tok-kw">try</span> serialize(v, self.serializer());</span>
<span class="line" id="L403">    }</span>
<span class="line" id="L404"></span>
<span class="line" id="L405">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeString</span>(self: *Self, v: <span class="tok-kw">anytype</span>) Error!Ok {</span>
<span class="line" id="L406">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .String = v });</span>
<span class="line" id="L407">    }</span>
<span class="line" id="L408"></span>
<span class="line" id="L409">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeStruct</span>(self: *Self, <span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, length: <span class="tok-type">usize</span>) Error!Structure {</span>
<span class="line" id="L410">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Struct = .{ .name = name, .len = length } });</span>
<span class="line" id="L411">        <span class="tok-kw">return</span> Structure{ .ser = self };</span>
<span class="line" id="L412">    }</span>
<span class="line" id="L413"></span>
<span class="line" id="L414">    <span class="tok-kw">fn</span> <span class="tok-fn">serializeVoid</span>(self: *Self) Error!Ok {</span>
<span class="line" id="L415">        <span class="tok-kw">try</span> assertNextToken(self, Token{ .Void = {} });</span>
<span class="line" id="L416">    }</span>
<span class="line" id="L417"></span>
<span class="line" id="L418">    <span class="tok-kw">const</span> Map = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L419">        ser: *TestSerializer,</span>
<span class="line" id="L420"></span>
<span class="line" id="L421">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> ser.Map(</span>
<span class="line" id="L422">            *Map,</span>
<span class="line" id="L423">            Ok,</span>
<span class="line" id="L424">            Error,</span>
<span class="line" id="L425">            .{</span>
<span class="line" id="L426">                .serializeKey = serializeKey,</span>
<span class="line" id="L427">                .serializeValue = serializeValue,</span>
<span class="line" id="L428">                .end = end,</span>
<span class="line" id="L429">            },</span>
<span class="line" id="L430">        );</span>
<span class="line" id="L431"></span>
<span class="line" id="L432">        <span class="tok-kw">fn</span> <span class="tok-fn">serializeKey</span>(self: *Map, key: <span class="tok-kw">anytype</span>) Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L433">            <span class="tok-kw">try</span> serialize(key, self.ser.serializer());</span>
<span class="line" id="L434">        }</span>
<span class="line" id="L435"></span>
<span class="line" id="L436">        <span class="tok-kw">fn</span> <span class="tok-fn">serializeValue</span>(self: *Map, value: <span class="tok-kw">anytype</span>) Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L437">            <span class="tok-kw">try</span> serialize(value, self.ser.serializer());</span>
<span class="line" id="L438">        }</span>
<span class="line" id="L439"></span>
<span class="line" id="L440">        <span class="tok-kw">fn</span> <span class="tok-fn">end</span>(self: *Map) Error!Ok {</span>
<span class="line" id="L441">            <span class="tok-kw">try</span> assertNextToken(self.ser, Token{ .MapEnd = {} });</span>
<span class="line" id="L442">        }</span>
<span class="line" id="L443">    };</span>
<span class="line" id="L444"></span>
<span class="line" id="L445">    <span class="tok-kw">const</span> Seq = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L446">        ser: *TestSerializer,</span>
<span class="line" id="L447"></span>
<span class="line" id="L448">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> ser.Seq(</span>
<span class="line" id="L449">            *Seq,</span>
<span class="line" id="L450">            Ok,</span>
<span class="line" id="L451">            Error,</span>
<span class="line" id="L452">            .{</span>
<span class="line" id="L453">                .serializeElement = serializeElement,</span>
<span class="line" id="L454">                .end = end,</span>
<span class="line" id="L455">            },</span>
<span class="line" id="L456">        );</span>
<span class="line" id="L457"></span>
<span class="line" id="L458">        <span class="tok-kw">fn</span> <span class="tok-fn">serializeElement</span>(self: *Seq, value: <span class="tok-kw">anytype</span>) Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L459">            <span class="tok-kw">try</span> serialize(value, self.ser.serializer());</span>
<span class="line" id="L460">        }</span>
<span class="line" id="L461"></span>
<span class="line" id="L462">        <span class="tok-kw">fn</span> <span class="tok-fn">end</span>(self: *Seq) Error!Ok {</span>
<span class="line" id="L463">            <span class="tok-kw">try</span> assertNextToken(self.ser, Token{ .SeqEnd = {} });</span>
<span class="line" id="L464">        }</span>
<span class="line" id="L465">    };</span>
<span class="line" id="L466"></span>
<span class="line" id="L467">    <span class="tok-kw">const</span> Structure = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L468">        ser: *TestSerializer,</span>
<span class="line" id="L469"></span>
<span class="line" id="L470">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> ser.Structure(</span>
<span class="line" id="L471">            *Structure,</span>
<span class="line" id="L472">            Ok,</span>
<span class="line" id="L473">            Error,</span>
<span class="line" id="L474">            .{</span>
<span class="line" id="L475">                .serializeField = serializeField,</span>
<span class="line" id="L476">                .end = end,</span>
<span class="line" id="L477">            },</span>
<span class="line" id="L478">        );</span>
<span class="line" id="L479"></span>
<span class="line" id="L480">        <span class="tok-kw">fn</span> <span class="tok-fn">serializeField</span>(self: *Structure, <span class="tok-kw">comptime</span> key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: <span class="tok-kw">anytype</span>) Error!<span class="tok-type">void</span> {</span>
<span class="line" id="L481">            <span class="tok-kw">try</span> assertNextToken(self.ser, Token{ .String = key });</span>
<span class="line" id="L482">            <span class="tok-kw">try</span> serialize(value, self.ser.serializer());</span>
<span class="line" id="L483">        }</span>
<span class="line" id="L484"></span>
<span class="line" id="L485">        <span class="tok-kw">fn</span> <span class="tok-fn">end</span>(self: *Structure) Error!Ok {</span>
<span class="line" id="L486">            <span class="tok-kw">try</span> assertNextToken(self.ser, Token{ .StructEnd = {} });</span>
<span class="line" id="L487">        }</span>
<span class="line" id="L488">    };</span>
<span class="line" id="L489"></span>
<span class="line" id="L490">    <span class="tok-kw">fn</span> <span class="tok-fn">assertNextToken</span>(self: *Self, expected: Token) !<span class="tok-type">void</span> {</span>
<span class="line" id="L491">        <span class="tok-kw">if</span> (self.nextTokenOpt()) |token| {</span>
<span class="line" id="L492">            <span class="tok-kw">const</span> token_tag = std.meta.activeTag(token);</span>
<span class="line" id="L493">            <span class="tok-kw">const</span> expected_tag = std.meta.activeTag(expected);</span>
<span class="line" id="L494"></span>
<span class="line" id="L495">            <span class="tok-kw">if</span> (token_tag == expected_tag) {</span>
<span class="line" id="L496">                <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L497">                    .Bool =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Bool&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Bool&quot;</span>)),</span>
<span class="line" id="L498">                    .ComptimeFloat =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;ComptimeFloat&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;ComptimeFloat&quot;</span>)),</span>
<span class="line" id="L499">                    .ComptimeInt =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;ComptimeInt&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;ComptimeInt&quot;</span>)),</span>
<span class="line" id="L500">                    .Enum =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Enum&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Enum&quot;</span>)),</span>
<span class="line" id="L501">                    .F16 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;F16&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;F16&quot;</span>)),</span>
<span class="line" id="L502">                    .F32 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;F32&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;F32&quot;</span>)),</span>
<span class="line" id="L503">                    .F64 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;F64&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;F64&quot;</span>)),</span>
<span class="line" id="L504">                    .F128 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;F128&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;F128&quot;</span>)),</span>
<span class="line" id="L505">                    .I8 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;I8&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;I8&quot;</span>)),</span>
<span class="line" id="L506">                    .I16 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;I16&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;I16&quot;</span>)),</span>
<span class="line" id="L507">                    .I32 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;I32&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;I32&quot;</span>)),</span>
<span class="line" id="L508">                    .I64 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;I64&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;I64&quot;</span>)),</span>
<span class="line" id="L509">                    .I128 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;I128&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;I128&quot;</span>)),</span>
<span class="line" id="L510">                    .Map =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Map&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Map&quot;</span>)),</span>
<span class="line" id="L511">                    .MapEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;MapEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;MapEnd&quot;</span>)),</span>
<span class="line" id="L512">                    .Null =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Null&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Null&quot;</span>)),</span>
<span class="line" id="L513">                    .Seq =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Seq&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Seq&quot;</span>)),</span>
<span class="line" id="L514">                    .SeqEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;SeqEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;SeqEnd&quot;</span>)),</span>
<span class="line" id="L515">                    .Some =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Some&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Some&quot;</span>)),</span>
<span class="line" id="L516">                    .String =&gt; <span class="tok-kw">try</span> expectEqualSlices(<span class="tok-type">u8</span>, <span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;String&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;String&quot;</span>)),</span>
<span class="line" id="L517">                    .Struct =&gt; {</span>
<span class="line" id="L518">                        <span class="tok-kw">const</span> tok = <span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Struct&quot;</span>);</span>
<span class="line" id="L519">                        <span class="tok-kw">const</span> e = <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Struct&quot;</span>);</span>
<span class="line" id="L520"></span>
<span class="line" id="L521">                        <span class="tok-kw">try</span> expectEqualSlices(<span class="tok-type">u8</span>, tok.name, e.name);</span>
<span class="line" id="L522">                        <span class="tok-kw">try</span> expectEqual(tok.len, e.len);</span>
<span class="line" id="L523">                    },</span>
<span class="line" id="L524">                    .StructEnd =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;StructEnd&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;StructEnd&quot;</span>)),</span>
<span class="line" id="L525">                    .U8 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;U8&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;U8&quot;</span>)),</span>
<span class="line" id="L526">                    .U16 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;U16&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;U16&quot;</span>)),</span>
<span class="line" id="L527">                    .U32 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;U32&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;U32&quot;</span>)),</span>
<span class="line" id="L528">                    .U64 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;U64&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;U64&quot;</span>)),</span>
<span class="line" id="L529">                    .U128 =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;U128&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;U128&quot;</span>)),</span>
<span class="line" id="L530">                    .Union =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;TODO: unions&quot;</span>),</span>
<span class="line" id="L531">                    .Void =&gt; <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@field</span>(token, <span class="tok-str">&quot;Void&quot;</span>), <span class="tok-builtin">@field</span>(expected, <span class="tok-str">&quot;Void&quot;</span>)),</span>
<span class="line" id="L532">                }</span>
<span class="line" id="L533">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L534">                <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;expected Token::{} but serialized as {}&quot;</span>);</span>
<span class="line" id="L535">            }</span>
<span class="line" id="L536">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L537">            <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;expected end of tokens, but {} was serialized&quot;</span>);</span>
<span class="line" id="L538">        }</span>
<span class="line" id="L539">    }</span>
<span class="line" id="L540">};</span>
<span class="line" id="L541"></span>
<span class="line" id="L542"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - array&quot;</span> {</span>
<span class="line" id="L543">    <span class="tok-kw">try</span> t([_]<span class="tok-type">i32</span>{}, &amp;[_]Token{</span>
<span class="line" id="L544">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L545">        .{ .SeqEnd = {} },</span>
<span class="line" id="L546">    });</span>
<span class="line" id="L547">    <span class="tok-kw">try</span> t([_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span> }, &amp;[_]Token{</span>
<span class="line" id="L548">        .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L549">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L550">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L551">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L552">        .{ .SeqEnd = {} },</span>
<span class="line" id="L553">    });</span>
<span class="line" id="L554">}</span>
<span class="line" id="L555"></span>
<span class="line" id="L556"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - array list&quot;</span> {</span>
<span class="line" id="L557">    <span class="tok-comment">// managed</span>
</span>
<span class="line" id="L558">    {</span>
<span class="line" id="L559">        <span class="tok-kw">var</span> list = std.ArrayList(std.ArrayList(<span class="tok-type">u8</span>)).init(test_allocator);</span>
<span class="line" id="L560">        <span class="tok-kw">defer</span> list.deinit();</span>
<span class="line" id="L561"></span>
<span class="line" id="L562">        <span class="tok-kw">var</span> a = std.ArrayList(<span class="tok-type">u8</span>).init(test_allocator);</span>
<span class="line" id="L563">        <span class="tok-kw">defer</span> a.deinit();</span>
<span class="line" id="L564"></span>
<span class="line" id="L565">        <span class="tok-kw">var</span> b = std.ArrayList(<span class="tok-type">u8</span>).init(test_allocator);</span>
<span class="line" id="L566">        <span class="tok-kw">defer</span> b.deinit();</span>
<span class="line" id="L567"></span>
<span class="line" id="L568">        <span class="tok-kw">var</span> c = std.ArrayList(<span class="tok-type">u8</span>).init(test_allocator);</span>
<span class="line" id="L569">        <span class="tok-kw">defer</span> c.deinit();</span>
<span class="line" id="L570"></span>
<span class="line" id="L571">        <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L572">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L573">            .{ .SeqEnd = {} },</span>
<span class="line" id="L574">        });</span>
<span class="line" id="L575"></span>
<span class="line" id="L576">        <span class="tok-kw">try</span> b.append(<span class="tok-number">1</span>);</span>
<span class="line" id="L577">        <span class="tok-kw">try</span> c.append(<span class="tok-number">2</span>);</span>
<span class="line" id="L578">        <span class="tok-kw">try</span> c.append(<span class="tok-number">3</span>);</span>
<span class="line" id="L579">        <span class="tok-kw">try</span> list.appendSlice(&amp;[_]std.ArrayList(<span class="tok-type">u8</span>){ a, b, c });</span>
<span class="line" id="L580"></span>
<span class="line" id="L581">        <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L582">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L583">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L584">            .{ .SeqEnd = {} },</span>
<span class="line" id="L585">            .{ .Seq = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L586">            .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L587">            .{ .SeqEnd = {} },</span>
<span class="line" id="L588">            .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L589">            .{ .U8 = <span class="tok-number">2</span> },</span>
<span class="line" id="L590">            .{ .U8 = <span class="tok-number">3</span> },</span>
<span class="line" id="L591">            .{ .SeqEnd = {} },</span>
<span class="line" id="L592">            .{ .SeqEnd = {} },</span>
<span class="line" id="L593">        });</span>
<span class="line" id="L594">    }</span>
<span class="line" id="L595"></span>
<span class="line" id="L596">    <span class="tok-comment">// unmanaged</span>
</span>
<span class="line" id="L597">    {</span>
<span class="line" id="L598">        <span class="tok-kw">var</span> list = std.ArrayListUnmanaged(std.ArrayListUnmanaged(<span class="tok-type">u8</span>)){};</span>
<span class="line" id="L599">        <span class="tok-kw">defer</span> list.deinit(test_allocator);</span>
<span class="line" id="L600"></span>
<span class="line" id="L601">        <span class="tok-kw">var</span> a = std.ArrayListUnmanaged(<span class="tok-type">u8</span>){};</span>
<span class="line" id="L602">        <span class="tok-kw">defer</span> a.deinit(test_allocator);</span>
<span class="line" id="L603"></span>
<span class="line" id="L604">        <span class="tok-kw">var</span> b = std.ArrayListUnmanaged(<span class="tok-type">u8</span>){};</span>
<span class="line" id="L605">        <span class="tok-kw">defer</span> b.deinit(test_allocator);</span>
<span class="line" id="L606"></span>
<span class="line" id="L607">        <span class="tok-kw">var</span> c = std.ArrayListUnmanaged(<span class="tok-type">u8</span>){};</span>
<span class="line" id="L608">        <span class="tok-kw">defer</span> c.deinit(test_allocator);</span>
<span class="line" id="L609"></span>
<span class="line" id="L610">        <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L611">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L612">            .{ .SeqEnd = {} },</span>
<span class="line" id="L613">        });</span>
<span class="line" id="L614"></span>
<span class="line" id="L615">        <span class="tok-kw">try</span> b.append(test_allocator, <span class="tok-number">1</span>);</span>
<span class="line" id="L616">        <span class="tok-kw">try</span> c.append(test_allocator, <span class="tok-number">2</span>);</span>
<span class="line" id="L617">        <span class="tok-kw">try</span> c.append(test_allocator, <span class="tok-number">3</span>);</span>
<span class="line" id="L618">        <span class="tok-kw">try</span> list.appendSlice(test_allocator, &amp;[_]std.ArrayListUnmanaged(<span class="tok-type">u8</span>){ a, b, c });</span>
<span class="line" id="L619"></span>
<span class="line" id="L620">        <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L621">            .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L622">            .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L623">            .{ .SeqEnd = {} },</span>
<span class="line" id="L624">            .{ .Seq = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L625">            .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L626">            .{ .SeqEnd = {} },</span>
<span class="line" id="L627">            .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L628">            .{ .U8 = <span class="tok-number">2</span> },</span>
<span class="line" id="L629">            .{ .U8 = <span class="tok-number">3</span> },</span>
<span class="line" id="L630">            .{ .SeqEnd = {} },</span>
<span class="line" id="L631">            .{ .SeqEnd = {} },</span>
<span class="line" id="L632">        });</span>
<span class="line" id="L633">    }</span>
<span class="line" id="L634">}</span>
<span class="line" id="L635"></span>
<span class="line" id="L636"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - bool&quot;</span> {</span>
<span class="line" id="L637">    <span class="tok-kw">try</span> t(<span class="tok-null">true</span>, &amp;[_]Token{.{ .Bool = <span class="tok-null">true</span> }});</span>
<span class="line" id="L638">    <span class="tok-kw">try</span> t(<span class="tok-null">false</span>, &amp;[_]Token{.{ .Bool = <span class="tok-null">false</span> }});</span>
<span class="line" id="L639">}</span>
<span class="line" id="L640"></span>
<span class="line" id="L641"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - bounded array&quot;</span> {</span>
<span class="line" id="L642">    <span class="tok-kw">var</span> empty = <span class="tok-kw">try</span> std.BoundedArray(<span class="tok-type">u8</span>, <span class="tok-number">10</span>).fromSlice(&amp;[_]<span class="tok-type">u8</span>{});</span>
<span class="line" id="L643"></span>
<span class="line" id="L644">    <span class="tok-kw">try</span> t(empty, &amp;[_]Token{</span>
<span class="line" id="L645">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L646">        .{ .SeqEnd = {} },</span>
<span class="line" id="L647">    });</span>
<span class="line" id="L648"></span>
<span class="line" id="L649">    <span class="tok-kw">const</span> array = [_]<span class="tok-type">u8</span>{<span class="tok-number">1</span>} ** <span class="tok-number">5</span>;</span>
<span class="line" id="L650">    <span class="tok-kw">var</span> non_empty = <span class="tok-kw">try</span> std.BoundedArray(<span class="tok-type">u8</span>, <span class="tok-number">5</span>).fromSlice(&amp;array);</span>
<span class="line" id="L651"></span>
<span class="line" id="L652">    <span class="tok-kw">try</span> t(non_empty, &amp;[_]Token{</span>
<span class="line" id="L653">        .{ .Seq = .{ .len = <span class="tok-number">5</span> } },</span>
<span class="line" id="L654">        .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L655">        .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L656">        .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L657">        .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L658">        .{ .U8 = <span class="tok-number">1</span> },</span>
<span class="line" id="L659">        .{ .SeqEnd = {} },</span>
<span class="line" id="L660">    });</span>
<span class="line" id="L661">}</span>
<span class="line" id="L662"></span>
<span class="line" id="L663"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - buf map&quot;</span> {</span>
<span class="line" id="L664">    <span class="tok-kw">var</span> map = std.BufMap.init(test_allocator);</span>
<span class="line" id="L665">    <span class="tok-kw">defer</span> map.deinit();</span>
<span class="line" id="L666"></span>
<span class="line" id="L667">    <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L668">        .{ .Map = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L669">        .{ .MapEnd = {} },</span>
<span class="line" id="L670">    });</span>
<span class="line" id="L671"></span>
<span class="line" id="L672">    <span class="tok-kw">try</span> map.put(<span class="tok-str">&quot;1&quot;</span>, <span class="tok-str">&quot;foobar&quot;</span>);</span>
<span class="line" id="L673"></span>
<span class="line" id="L674">    <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L675">        .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L676">        .{ .String = <span class="tok-str">&quot;1&quot;</span> },</span>
<span class="line" id="L677">        .{ .String = <span class="tok-str">&quot;foobar&quot;</span> },</span>
<span class="line" id="L678">        .{ .MapEnd = {} },</span>
<span class="line" id="L679">    });</span>
<span class="line" id="L680">}</span>
<span class="line" id="L681"></span>
<span class="line" id="L682"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - enum&quot;</span> {</span>
<span class="line" id="L683">    <span class="tok-comment">// literal</span>
</span>
<span class="line" id="L684">    <span class="tok-kw">try</span> t(.foo, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;foo&quot;</span> } });</span>
<span class="line" id="L685">    <span class="tok-kw">try</span> t(.bar, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;bar&quot;</span> } });</span>
<span class="line" id="L686"></span>
<span class="line" id="L687">    <span class="tok-comment">// non-literal</span>
</span>
<span class="line" id="L688">    <span class="tok-kw">const</span> T = <span class="tok-kw">enum</span> { foo, bar };</span>
<span class="line" id="L689">    <span class="tok-kw">try</span> t(T.foo, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;foo&quot;</span> } });</span>
<span class="line" id="L690">    <span class="tok-kw">try</span> t(T.bar, &amp;[_]Token{ .{ .Enum = {} }, .{ .String = <span class="tok-str">&quot;bar&quot;</span> } });</span>
<span class="line" id="L691">}</span>
<span class="line" id="L692"></span>
<span class="line" id="L693"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - error&quot;</span> {</span>
<span class="line" id="L694">    <span class="tok-kw">try</span> t(<span class="tok-kw">error</span>.Foobar, &amp;[_]Token{.{ .String = <span class="tok-str">&quot;Foobar&quot;</span> }});</span>
<span class="line" id="L695">}</span>
<span class="line" id="L696"></span>
<span class="line" id="L697"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - float&quot;</span> {</span>
<span class="line" id="L698">    <span class="tok-comment">// comptime_float</span>
</span>
<span class="line" id="L699">    <span class="tok-kw">try</span> t(<span class="tok-number">0.0</span>, &amp;[_]Token{.{ .ComptimeFloat = {} }});</span>
<span class="line" id="L700"></span>
<span class="line" id="L701">    <span class="tok-comment">// float</span>
</span>
<span class="line" id="L702">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L703">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L704">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L705">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">f128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .F128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L706">}</span>
<span class="line" id="L707"></span>
<span class="line" id="L708"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - hash map&quot;</span> {</span>
<span class="line" id="L709">    <span class="tok-comment">// managed</span>
</span>
<span class="line" id="L710">    {</span>
<span class="line" id="L711">        <span class="tok-kw">var</span> map = std.AutoHashMap(<span class="tok-type">i32</span>, <span class="tok-type">i32</span>).init(test_allocator);</span>
<span class="line" id="L712">        <span class="tok-kw">defer</span> map.deinit();</span>
<span class="line" id="L713"></span>
<span class="line" id="L714">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L715">            .{ .Map = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L716">            .{ .MapEnd = {} },</span>
<span class="line" id="L717">        });</span>
<span class="line" id="L718"></span>
<span class="line" id="L719">        <span class="tok-kw">try</span> map.put(<span class="tok-number">1</span>, <span class="tok-number">2</span>);</span>
<span class="line" id="L720"></span>
<span class="line" id="L721">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L722">            .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L723">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L724">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L725">            .{ .MapEnd = {} },</span>
<span class="line" id="L726">        });</span>
<span class="line" id="L727">    }</span>
<span class="line" id="L728"></span>
<span class="line" id="L729">    <span class="tok-comment">// unmanaged</span>
</span>
<span class="line" id="L730">    {</span>
<span class="line" id="L731">        <span class="tok-kw">var</span> map = std.AutoHashMapUnmanaged(<span class="tok-type">i32</span>, <span class="tok-type">i32</span>){};</span>
<span class="line" id="L732">        <span class="tok-kw">defer</span> map.deinit(test_allocator);</span>
<span class="line" id="L733"></span>
<span class="line" id="L734">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L735">            .{ .Map = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L736">            .{ .MapEnd = {} },</span>
<span class="line" id="L737">        });</span>
<span class="line" id="L738"></span>
<span class="line" id="L739">        <span class="tok-kw">try</span> map.put(test_allocator, <span class="tok-number">1</span>, <span class="tok-number">2</span>);</span>
<span class="line" id="L740"></span>
<span class="line" id="L741">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L742">            .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L743">            .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L744">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L745">            .{ .MapEnd = {} },</span>
<span class="line" id="L746">        });</span>
<span class="line" id="L747">    }</span>
<span class="line" id="L748"></span>
<span class="line" id="L749">    <span class="tok-comment">// string</span>
</span>
<span class="line" id="L750">    {</span>
<span class="line" id="L751">        <span class="tok-kw">var</span> map = std.StringHashMap(<span class="tok-type">i32</span>).init(test_allocator);</span>
<span class="line" id="L752">        <span class="tok-kw">defer</span> map.deinit();</span>
<span class="line" id="L753"></span>
<span class="line" id="L754">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L755">            .{ .Map = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L756">            .{ .MapEnd = {} },</span>
<span class="line" id="L757">        });</span>
<span class="line" id="L758"></span>
<span class="line" id="L759">        <span class="tok-kw">try</span> map.put(<span class="tok-str">&quot;1&quot;</span>, <span class="tok-number">2</span>);</span>
<span class="line" id="L760"></span>
<span class="line" id="L761">        <span class="tok-kw">try</span> t(map, &amp;[_]Token{</span>
<span class="line" id="L762">            .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L763">            .{ .String = <span class="tok-str">&quot;1&quot;</span> },</span>
<span class="line" id="L764">            .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L765">            .{ .MapEnd = {} },</span>
<span class="line" id="L766">        });</span>
<span class="line" id="L767">    }</span>
<span class="line" id="L768">}</span>
<span class="line" id="L769"></span>
<span class="line" id="L770"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - integer&quot;</span> {</span>
<span class="line" id="L771">    <span class="tok-comment">// comptime_int</span>
</span>
<span class="line" id="L772">    <span class="tok-kw">try</span> t(<span class="tok-number">0</span>, &amp;[_]Token{.{ .ComptimeInt = {} }});</span>
<span class="line" id="L773"></span>
<span class="line" id="L774">    <span class="tok-comment">// signed</span>
</span>
<span class="line" id="L775">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i8</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I8 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L776">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L777">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L778">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L779">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">i128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .I128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L780"></span>
<span class="line" id="L781">    <span class="tok-comment">// unsigned</span>
</span>
<span class="line" id="L782">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U8 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L783">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U16 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L784">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U32 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L785">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U64 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L786">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(<span class="tok-type">u128</span>, <span class="tok-number">0</span>), &amp;[_]Token{.{ .U128 = <span class="tok-number">0</span> }});</span>
<span class="line" id="L787">}</span>
<span class="line" id="L788"></span>
<span class="line" id="L789"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - linked list&quot;</span> {</span>
<span class="line" id="L790">    <span class="tok-kw">var</span> list = std.SinglyLinkedList(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L791"></span>
<span class="line" id="L792">    <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L793">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L794">        .{ .SeqEnd = {} },</span>
<span class="line" id="L795">    });</span>
<span class="line" id="L796"></span>
<span class="line" id="L797">    <span class="tok-kw">var</span> one = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L798">    <span class="tok-kw">var</span> two = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L799">    <span class="tok-kw">var</span> three = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L800"></span>
<span class="line" id="L801">    list.prepend(&amp;one);</span>
<span class="line" id="L802">    one.insertAfter(&amp;two);</span>
<span class="line" id="L803">    two.insertAfter(&amp;three);</span>
<span class="line" id="L804"></span>
<span class="line" id="L805">    <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L806">        .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L807">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L808">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L809">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L810">        .{ .SeqEnd = {} },</span>
<span class="line" id="L811">    });</span>
<span class="line" id="L812">}</span>
<span class="line" id="L813"></span>
<span class="line" id="L814"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - null&quot;</span> {</span>
<span class="line" id="L815">    <span class="tok-kw">try</span> t(<span class="tok-null">null</span>, &amp;[_]Token{.{ .Null = {} }});</span>
<span class="line" id="L816">}</span>
<span class="line" id="L817"></span>
<span class="line" id="L818"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - optional&quot;</span> {</span>
<span class="line" id="L819">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(?<span class="tok-type">i32</span>, <span class="tok-null">null</span>), &amp;[_]Token{.{ .Null = {} }});</span>
<span class="line" id="L820">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@as</span>(?<span class="tok-type">i32</span>, <span class="tok-number">0</span>), &amp;[_]Token{ .{ .Some = {} }, .{ .I32 = <span class="tok-number">0</span> } });</span>
<span class="line" id="L821">}</span>
<span class="line" id="L822"></span>
<span class="line" id="L823"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - pointer&quot;</span> {</span>
<span class="line" id="L824"></span>
<span class="line" id="L825">    <span class="tok-comment">// one level of indirection</span>
</span>
<span class="line" id="L826">    {</span>
<span class="line" id="L827">        <span class="tok-kw">var</span> ptr = <span class="tok-kw">try</span> test_allocator.create(<span class="tok-type">i32</span>);</span>
<span class="line" id="L828">        <span class="tok-kw">defer</span> test_allocator.destroy(ptr);</span>
<span class="line" id="L829">        ptr.* = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>);</span>
<span class="line" id="L830"></span>
<span class="line" id="L831">        <span class="tok-kw">try</span> t(ptr, &amp;[_]Token{.{ .I32 = <span class="tok-number">1</span> }});</span>
<span class="line" id="L832">    }</span>
<span class="line" id="L833"></span>
<span class="line" id="L834">    <span class="tok-comment">// two levels of indirection</span>
</span>
<span class="line" id="L835">    {</span>
<span class="line" id="L836">        <span class="tok-kw">var</span> tmp = <span class="tok-kw">try</span> test_allocator.create(<span class="tok-type">i32</span>);</span>
<span class="line" id="L837">        <span class="tok-kw">defer</span> test_allocator.destroy(tmp);</span>
<span class="line" id="L838">        tmp.* = <span class="tok-number">2</span>;</span>
<span class="line" id="L839"></span>
<span class="line" id="L840">        <span class="tok-kw">var</span> ptr = <span class="tok-kw">try</span> test_allocator.create(*<span class="tok-type">i32</span>);</span>
<span class="line" id="L841">        <span class="tok-kw">defer</span> test_allocator.destroy(ptr);</span>
<span class="line" id="L842">        ptr.* = tmp;</span>
<span class="line" id="L843"></span>
<span class="line" id="L844">        <span class="tok-kw">try</span> t(ptr, &amp;[_]Token{.{ .I32 = <span class="tok-number">2</span> }});</span>
<span class="line" id="L845">    }</span>
<span class="line" id="L846"></span>
<span class="line" id="L847">    <span class="tok-comment">// pointer to slice</span>
</span>
<span class="line" id="L848">    {</span>
<span class="line" id="L849">        <span class="tok-kw">var</span> ptr = <span class="tok-kw">try</span> test_allocator.create([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>);</span>
<span class="line" id="L850">        <span class="tok-kw">defer</span> test_allocator.destroy(ptr);</span>
<span class="line" id="L851">        ptr.* = <span class="tok-str">&quot;3&quot;</span>;</span>
<span class="line" id="L852"></span>
<span class="line" id="L853">        <span class="tok-kw">try</span> t(ptr, &amp;[_]Token{.{ .String = <span class="tok-str">&quot;3&quot;</span> }});</span>
<span class="line" id="L854">    }</span>
<span class="line" id="L855">}</span>
<span class="line" id="L856"></span>
<span class="line" id="L857"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - slice&quot;</span> {</span>
<span class="line" id="L858">    <span class="tok-kw">try</span> t(&amp;[_]<span class="tok-type">i32</span>{}, &amp;[_]Token{</span>
<span class="line" id="L859">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L860">        .{ .SeqEnd = {} },</span>
<span class="line" id="L861">    });</span>
<span class="line" id="L862">    <span class="tok-kw">try</span> t(&amp;[_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span> }, &amp;[_]Token{</span>
<span class="line" id="L863">        .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L864">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L865">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L866">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L867">        .{ .SeqEnd = {} },</span>
<span class="line" id="L868">    });</span>
<span class="line" id="L869">}</span>
<span class="line" id="L870"></span>
<span class="line" id="L871"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - string&quot;</span> {</span>
<span class="line" id="L872">    <span class="tok-kw">try</span> t(<span class="tok-str">&quot;abc&quot;</span>, &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L873">    <span class="tok-kw">try</span> t(&amp;[_]<span class="tok-type">u8</span>{ <span class="tok-str">'a'</span>, <span class="tok-str">'b'</span>, <span class="tok-str">'c'</span> }, &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L874">    <span class="tok-kw">try</span> t(&amp;[_:<span class="tok-number">0</span>]<span class="tok-type">u8</span>{ <span class="tok-str">'a'</span>, <span class="tok-str">'b'</span>, <span class="tok-str">'c'</span> }, &amp;[_]Token{.{ .String = <span class="tok-str">&quot;abc&quot;</span> }});</span>
<span class="line" id="L875">}</span>
<span class="line" id="L876"></span>
<span class="line" id="L877"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - struct&quot;</span> {</span>
<span class="line" id="L878">    <span class="tok-kw">const</span> Struct = <span class="tok-kw">struct</span> { a: <span class="tok-type">i32</span>, b: <span class="tok-type">i32</span>, c: <span class="tok-type">i32</span> };</span>
<span class="line" id="L879"></span>
<span class="line" id="L880">    <span class="tok-kw">try</span> t(Struct{ .a = <span class="tok-number">1</span>, .b = <span class="tok-number">2</span>, .c = <span class="tok-number">3</span> }, &amp;[_]Token{</span>
<span class="line" id="L881">        .{ .Struct = .{ .name = <span class="tok-builtin">@typeName</span>(Struct), .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L882">        .{ .String = <span class="tok-str">&quot;a&quot;</span> },</span>
<span class="line" id="L883">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L884">        .{ .String = <span class="tok-str">&quot;b&quot;</span> },</span>
<span class="line" id="L885">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L886">        .{ .String = <span class="tok-str">&quot;c&quot;</span> },</span>
<span class="line" id="L887">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L888">        .{ .StructEnd = {} },</span>
<span class="line" id="L889">    });</span>
<span class="line" id="L890">}</span>
<span class="line" id="L891"></span>
<span class="line" id="L892"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - tail queue&quot;</span> {</span>
<span class="line" id="L893">    <span class="tok-kw">var</span> list = std.TailQueue(<span class="tok-type">i32</span>){};</span>
<span class="line" id="L894"></span>
<span class="line" id="L895">    <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L896">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L897">        .{ .SeqEnd = {} },</span>
<span class="line" id="L898">    });</span>
<span class="line" id="L899"></span>
<span class="line" id="L900">    <span class="tok-kw">var</span> one = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">1</span> };</span>
<span class="line" id="L901">    <span class="tok-kw">var</span> two = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">2</span> };</span>
<span class="line" id="L902">    <span class="tok-kw">var</span> three = <span class="tok-builtin">@TypeOf</span>(list).Node{ .data = <span class="tok-number">3</span> };</span>
<span class="line" id="L903"></span>
<span class="line" id="L904">    list.append(&amp;one);</span>
<span class="line" id="L905">    list.append(&amp;two);</span>
<span class="line" id="L906">    list.append(&amp;three);</span>
<span class="line" id="L907"></span>
<span class="line" id="L908">    <span class="tok-kw">try</span> t(list, &amp;[_]Token{</span>
<span class="line" id="L909">        .{ .Seq = .{ .len = <span class="tok-number">3</span> } },</span>
<span class="line" id="L910">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L911">        .{ .I32 = <span class="tok-number">2</span> },</span>
<span class="line" id="L912">        .{ .I32 = <span class="tok-number">3</span> },</span>
<span class="line" id="L913">        .{ .SeqEnd = {} },</span>
<span class="line" id="L914">    });</span>
<span class="line" id="L915">}</span>
<span class="line" id="L916"></span>
<span class="line" id="L917"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - tuple&quot;</span> {</span>
<span class="line" id="L918">    <span class="tok-kw">try</span> t(.{}, &amp;[_]Token{</span>
<span class="line" id="L919">        .{ .Seq = .{ .len = <span class="tok-number">0</span> } },</span>
<span class="line" id="L920">        .{ .SeqEnd = {} },</span>
<span class="line" id="L921">    });</span>
<span class="line" id="L922"></span>
<span class="line" id="L923">    <span class="tok-kw">try</span> t(std.meta.Tuple(&amp;[_]<span class="tok-type">type</span>{ <span class="tok-type">i32</span>, <span class="tok-type">bool</span> }){ <span class="tok-number">1</span>, <span class="tok-null">true</span> }, &amp;[_]Token{</span>
<span class="line" id="L924">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L925">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L926">        .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L927">        .{ .SeqEnd = {} },</span>
<span class="line" id="L928">    });</span>
<span class="line" id="L929"></span>
<span class="line" id="L930">    <span class="tok-kw">try</span> t(.{ <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>), <span class="tok-null">true</span> }, &amp;[_]Token{</span>
<span class="line" id="L931">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L932">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L933">        .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L934">        .{ .SeqEnd = {} },</span>
<span class="line" id="L935">    });</span>
<span class="line" id="L936">}</span>
<span class="line" id="L937"></span>
<span class="line" id="L938"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - union&quot;</span> {</span>
<span class="line" id="L939">    <span class="tok-kw">const</span> Union = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) { Int: <span class="tok-type">i32</span>, Bool: <span class="tok-type">bool</span> };</span>
<span class="line" id="L940"></span>
<span class="line" id="L941">    <span class="tok-kw">try</span> t(Union{ .Int = <span class="tok-number">0</span> }, &amp;[_]Token{</span>
<span class="line" id="L942">        .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L943">        .{ .String = <span class="tok-str">&quot;Int&quot;</span> },</span>
<span class="line" id="L944">        .{ .I32 = <span class="tok-number">0</span> },</span>
<span class="line" id="L945">        .{ .MapEnd = {} },</span>
<span class="line" id="L946">    });</span>
<span class="line" id="L947">    <span class="tok-kw">try</span> t(Union{ .Bool = <span class="tok-null">true</span> }, &amp;[_]Token{</span>
<span class="line" id="L948">        .{ .Map = .{ .len = <span class="tok-number">1</span> } },</span>
<span class="line" id="L949">        .{ .String = <span class="tok-str">&quot;Bool&quot;</span> },</span>
<span class="line" id="L950">        .{ .Bool = <span class="tok-null">true</span> },</span>
<span class="line" id="L951">        .{ .MapEnd = {} },</span>
<span class="line" id="L952">    });</span>
<span class="line" id="L953">}</span>
<span class="line" id="L954"></span>
<span class="line" id="L955"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - vector&quot;</span> {</span>
<span class="line" id="L956">    <span class="tok-kw">try</span> t(<span class="tok-builtin">@splat</span>(<span class="tok-number">2</span>, <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-number">1</span>)), &amp;[_]Token{</span>
<span class="line" id="L957">        .{ .Seq = .{ .len = <span class="tok-number">2</span> } },</span>
<span class="line" id="L958">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L959">        .{ .I32 = <span class="tok-number">1</span> },</span>
<span class="line" id="L960">        .{ .SeqEnd = {} },</span>
<span class="line" id="L961">    });</span>
<span class="line" id="L962">}</span>
<span class="line" id="L963"></span>
<span class="line" id="L964"><span class="tok-kw">test</span> <span class="tok-str">&quot;serialize - void&quot;</span> {</span>
<span class="line" id="L965">    <span class="tok-kw">try</span> t({}, &amp;[_]Token{.{ .Void = {} }});</span>
<span class="line" id="L966">}</span>
<span class="line" id="L967"></span>
<span class="line" id="L968"><span class="tok-kw">fn</span> <span class="tok-fn">t</span>(v: <span class="tok-kw">anytype</span>, tokens: []<span class="tok-kw">const</span> Token) !<span class="tok-type">void</span> {</span>
<span class="line" id="L969">    <span class="tok-kw">var</span> s = TestSerializer.init(tokens);</span>
<span class="line" id="L970"></span>
<span class="line" id="L971">    serialize(v, s.serializer()) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.TestUnexpectedError;</span>
<span class="line" id="L972">    <span class="tok-kw">try</span> expect(s.remaining() == <span class="tok-number">0</span>);</span>
<span class="line" id="L973">}</span>
<span class="line" id="L974"></span>
<span class="line" id="L975"><span class="tok-kw">comptime</span> {</span>
<span class="line" id="L976">    std.testing.refAllDecls(<span class="tok-builtin">@This</span>());</span>
<span class="line" id="L977">}</span>
<span class="line" id="L978"></span>
</code></pre></body>
</html>