<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Build/Step/Compile.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L3"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> fs = std.fs;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> panic = std.debug.panic;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> ArrayList = std.ArrayList;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> StringHashMap = std.StringHashMap;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> Sha256 = std.crypto.hash.sha2.Sha256;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> Allocator = mem.Allocator;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> Step = std.Build.Step;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> CrossTarget = std.zig.CrossTarget;</span>
<span class="line" id="L13"><span class="tok-kw">const</span> NativeTargetInfo = std.zig.system.NativeTargetInfo;</span>
<span class="line" id="L14"><span class="tok-kw">const</span> LazyPath = std.Build.LazyPath;</span>
<span class="line" id="L15"><span class="tok-kw">const</span> PkgConfigPkg = std.Build.PkgConfigPkg;</span>
<span class="line" id="L16"><span class="tok-kw">const</span> PkgConfigError = std.Build.PkgConfigError;</span>
<span class="line" id="L17"><span class="tok-kw">const</span> RunError = std.Build.RunError;</span>
<span class="line" id="L18"><span class="tok-kw">const</span> Module = std.Build.Module;</span>
<span class="line" id="L19"><span class="tok-kw">const</span> VcpkgRoot = std.Build.VcpkgRoot;</span>
<span class="line" id="L20"><span class="tok-kw">const</span> InstallDir = std.Build.InstallDir;</span>
<span class="line" id="L21"><span class="tok-kw">const</span> GeneratedFile = std.Build.GeneratedFile;</span>
<span class="line" id="L22"><span class="tok-kw">const</span> Compile = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L23"></span>
<span class="line" id="L24"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> base_id: Step.Id = .compile;</span>
<span class="line" id="L25"></span>
<span class="line" id="L26">step: Step,</span>
<span class="line" id="L27">name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L28">target: CrossTarget,</span>
<span class="line" id="L29">target_info: NativeTargetInfo,</span>
<span class="line" id="L30">optimize: std.builtin.OptimizeMode,</span>
<span class="line" id="L31">linker_script: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L32">version_script: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L33">out_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L34">linkage: ?Linkage = <span class="tok-null">null</span>,</span>
<span class="line" id="L35">version: ?std.SemanticVersion,</span>
<span class="line" id="L36">kind: Kind,</span>
<span class="line" id="L37">major_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L38">name_only_filename: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L39">strip: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L40">unwind_tables: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L41"><span class="tok-comment">// keep in sync with src/link.zig:CompressDebugSections</span>
</span>
<span class="line" id="L42">compress_debug_sections: <span class="tok-kw">enum</span> { none, zlib, zstd } = .none,</span>
<span class="line" id="L43">lib_paths: ArrayList(LazyPath),</span>
<span class="line" id="L44">rpaths: ArrayList(LazyPath),</span>
<span class="line" id="L45">frameworks: StringHashMap(FrameworkLinkInfo),</span>
<span class="line" id="L46">verbose_link: <span class="tok-type">bool</span>,</span>
<span class="line" id="L47">verbose_cc: <span class="tok-type">bool</span>,</span>
<span class="line" id="L48">bundle_compiler_rt: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L49">single_threaded: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L50">stack_protector: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L51">disable_stack_probing: <span class="tok-type">bool</span>,</span>
<span class="line" id="L52">disable_sanitize_c: <span class="tok-type">bool</span>,</span>
<span class="line" id="L53">sanitize_thread: <span class="tok-type">bool</span>,</span>
<span class="line" id="L54">rdynamic: <span class="tok-type">bool</span>,</span>
<span class="line" id="L55">dwarf_format: ?std.dwarf.Format = <span class="tok-null">null</span>,</span>
<span class="line" id="L56">import_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L57">export_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L58"><span class="tok-comment">/// For WebAssembly targets, this will allow for undefined symbols to</span></span>
<span class="line" id="L59"><span class="tok-comment">/// be imported from the host environment.</span></span>
<span class="line" id="L60">import_symbols: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L61">import_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L62">export_table: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L63">initial_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L64">max_memory: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L65">shared_memory: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L66">global_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L67">c_std: std.Build.CStd,</span>
<span class="line" id="L68"><span class="tok-comment">/// Set via options; intended to be read-only after that.</span></span>
<span class="line" id="L69">zig_lib_dir: ?LazyPath,</span>
<span class="line" id="L70"><span class="tok-comment">/// Set via options; intended to be read-only after that.</span></span>
<span class="line" id="L71">main_mod_path: ?LazyPath,</span>
<span class="line" id="L72">exec_cmd_args: ?[]<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L73">filter: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L74">test_evented_io: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L75">test_runner: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L76">test_server_mode: <span class="tok-type">bool</span>,</span>
<span class="line" id="L77">code_model: std.builtin.CodeModel = .default,</span>
<span class="line" id="L78">wasi_exec_model: ?std.builtin.WasiExecModel = <span class="tok-null">null</span>,</span>
<span class="line" id="L79"><span class="tok-comment">/// Symbols to be exported when compiling to wasm</span></span>
<span class="line" id="L80">export_symbol_names: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = &amp;.{},</span>
<span class="line" id="L81"></span>
<span class="line" id="L82">root_src: ?LazyPath,</span>
<span class="line" id="L83">out_lib_filename: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L84">modules: std.StringArrayHashMap(*Module),</span>
<span class="line" id="L85"></span>
<span class="line" id="L86">link_objects: ArrayList(LinkObject),</span>
<span class="line" id="L87">include_dirs: ArrayList(IncludeDir),</span>
<span class="line" id="L88">c_macros: ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L89">installed_headers: ArrayList(*Step),</span>
<span class="line" id="L90">is_linking_libc: <span class="tok-type">bool</span>,</span>
<span class="line" id="L91">is_linking_libcpp: <span class="tok-type">bool</span>,</span>
<span class="line" id="L92">vcpkg_bin_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L93"></span>
<span class="line" id="L94"><span class="tok-comment">// keep in sync with src/Compilation.zig:RcIncludes</span>
</span>
<span class="line" id="L95"><span class="tok-comment">/// Behavior of automatic detection of include directories when compiling .rc files.</span></span>
<span class="line" id="L96"><span class="tok-comment">///  any: Use MSVC if available, fall back to MinGW.</span></span>
<span class="line" id="L97"><span class="tok-comment">///  msvc: Use MSVC include paths (must be present on the system).</span></span>
<span class="line" id="L98"><span class="tok-comment">///  gnu: Use MinGW include paths (distributed with Zig).</span></span>
<span class="line" id="L99"><span class="tok-comment">///  none: Do not use any autodetected include paths.</span></span>
<span class="line" id="L100">rc_includes: <span class="tok-kw">enum</span> { any, msvc, gnu, none } = .any,</span>
<span class="line" id="L101"></span>
<span class="line" id="L102"><span class="tok-comment">/// (Windows) .manifest file to embed in the compilation</span></span>
<span class="line" id="L103"><span class="tok-comment">/// Set via options; intended to be read-only after that.</span></span>
<span class="line" id="L104">win32_manifest: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L105"></span>
<span class="line" id="L106">installed_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L107"></span>
<span class="line" id="L108"><span class="tok-comment">/// Base address for an executable image.</span></span>
<span class="line" id="L109">image_base: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L110"></span>
<span class="line" id="L111">libc_file: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L112"></span>
<span class="line" id="L113">valgrind_support: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L114">each_lib_rpath: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L115"><span class="tok-comment">/// On ELF targets, this will emit a link section called &quot;.note.gnu.build-id&quot;</span></span>
<span class="line" id="L116"><span class="tok-comment">/// which can be used to coordinate a stripped binary with its debug symbols.</span></span>
<span class="line" id="L117"><span class="tok-comment">/// As an example, the bloaty project refuses to work unless its inputs have</span></span>
<span class="line" id="L118"><span class="tok-comment">/// build ids, in order to prevent accidental mismatches.</span></span>
<span class="line" id="L119"><span class="tok-comment">/// The default is to not include this section because it slows down linking.</span></span>
<span class="line" id="L120">build_id: ?BuildId = <span class="tok-null">null</span>,</span>
<span class="line" id="L121"></span>
<span class="line" id="L122"><span class="tok-comment">/// Create a .eh_frame_hdr section and a PT_GNU_EH_FRAME segment in the ELF</span></span>
<span class="line" id="L123"><span class="tok-comment">/// file.</span></span>
<span class="line" id="L124">link_eh_frame_hdr: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L125">link_emit_relocs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L126"></span>
<span class="line" id="L127"><span class="tok-comment">/// Place every function in its own section so that unused ones may be</span></span>
<span class="line" id="L128"><span class="tok-comment">/// safely garbage-collected during the linking phase.</span></span>
<span class="line" id="L129">link_function_sections: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L130"></span>
<span class="line" id="L131"><span class="tok-comment">/// Place every data in its own section so that unused ones may be</span></span>
<span class="line" id="L132"><span class="tok-comment">/// safely garbage-collected during the linking phase.</span></span>
<span class="line" id="L133">link_data_sections: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L134"></span>
<span class="line" id="L135"><span class="tok-comment">/// Remove functions and data that are unreachable by the entry point or</span></span>
<span class="line" id="L136"><span class="tok-comment">/// exported symbols.</span></span>
<span class="line" id="L137">link_gc_sections: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L138"></span>
<span class="line" id="L139"><span class="tok-comment">/// (Windows) Whether or not to enable ASLR. Maps to the /DYNAMICBASE[:NO] linker argument.</span></span>
<span class="line" id="L140">linker_dynamicbase: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L141"></span>
<span class="line" id="L142">linker_allow_shlib_undefined: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L143"></span>
<span class="line" id="L144"><span class="tok-comment">/// Permit read-only relocations in read-only segments. Disallowed by default.</span></span>
<span class="line" id="L145">link_z_notext: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L146"></span>
<span class="line" id="L147"><span class="tok-comment">/// Force all relocations to be read-only after processing.</span></span>
<span class="line" id="L148">link_z_relro: <span class="tok-type">bool</span> = <span class="tok-null">true</span>,</span>
<span class="line" id="L149"></span>
<span class="line" id="L150"><span class="tok-comment">/// Allow relocations to be lazily processed after load.</span></span>
<span class="line" id="L151">link_z_lazy: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L152"></span>
<span class="line" id="L153"><span class="tok-comment">/// Common page size</span></span>
<span class="line" id="L154">link_z_common_page_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L155"></span>
<span class="line" id="L156"><span class="tok-comment">/// Maximum page size</span></span>
<span class="line" id="L157">link_z_max_page_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L158"></span>
<span class="line" id="L159"><span class="tok-comment">/// (Darwin) Install name for the dylib</span></span>
<span class="line" id="L160">install_name: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L161"></span>
<span class="line" id="L162"><span class="tok-comment">/// (Darwin) Path to entitlements file</span></span>
<span class="line" id="L163">entitlements: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L164"></span>
<span class="line" id="L165"><span class="tok-comment">/// (Darwin) Size of the pagezero segment.</span></span>
<span class="line" id="L166">pagezero_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L167"></span>
<span class="line" id="L168"><span class="tok-comment">/// (Darwin) Set size of the padding between the end of load commands</span></span>
<span class="line" id="L169"><span class="tok-comment">/// and start of `__TEXT,__text` section.</span></span>
<span class="line" id="L170">headerpad_size: ?<span class="tok-type">u32</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L171"></span>
<span class="line" id="L172"><span class="tok-comment">/// (Darwin) Automatically Set size of the padding between the end of load commands</span></span>
<span class="line" id="L173"><span class="tok-comment">/// and start of `__TEXT,__text` section to a value fitting all paths expanded to MAXPATHLEN.</span></span>
<span class="line" id="L174">headerpad_max_install_names: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L175"></span>
<span class="line" id="L176"><span class="tok-comment">/// (Darwin) Remove dylibs that are unreachable by the entry point or exported symbols.</span></span>
<span class="line" id="L177">dead_strip_dylibs: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L178"></span>
<span class="line" id="L179"><span class="tok-comment">/// Position Independent Code</span></span>
<span class="line" id="L180">force_pic: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L181"></span>
<span class="line" id="L182"><span class="tok-comment">/// Position Independent Executable</span></span>
<span class="line" id="L183">pie: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">red_zone: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L186"></span>
<span class="line" id="L187">omit_frame_pointer: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L188">dll_export_fns: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L189"></span>
<span class="line" id="L190">subsystem: ?std.Target.SubSystem = <span class="tok-null">null</span>,</span>
<span class="line" id="L191"></span>
<span class="line" id="L192"><span class="tok-comment">/// How the linker must handle the entry point of the executable.</span></span>
<span class="line" id="L193">entry: Entry = .default,</span>
<span class="line" id="L194"></span>
<span class="line" id="L195"><span class="tok-comment">/// List of symbols forced as undefined in the symbol table</span></span>
<span class="line" id="L196"><span class="tok-comment">/// thus forcing their resolution by the linker.</span></span>
<span class="line" id="L197"><span class="tok-comment">/// Corresponds to `-u &lt;symbol&gt;` for ELF/MachO and `/include:&lt;symbol&gt;` for COFF/PE.</span></span>
<span class="line" id="L198">force_undefined_symbols: std.StringHashMap(<span class="tok-type">void</span>),</span>
<span class="line" id="L199"></span>
<span class="line" id="L200"><span class="tok-comment">/// Overrides the default stack size</span></span>
<span class="line" id="L201">stack_size: ?<span class="tok-type">u64</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L202"></span>
<span class="line" id="L203">want_lto: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L204">use_llvm: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L205">use_lld: ?<span class="tok-type">bool</span>,</span>
<span class="line" id="L206"></span>
<span class="line" id="L207"><span class="tok-comment">/// This is an advanced setting that can change the intent of this Compile step.</span></span>
<span class="line" id="L208"><span class="tok-comment">/// If this value is non-null, it means that this Compile step exists to</span></span>
<span class="line" id="L209"><span class="tok-comment">/// check for compile errors and return *success* if they match, and failure</span></span>
<span class="line" id="L210"><span class="tok-comment">/// otherwise.</span></span>
<span class="line" id="L211">expect_errors: ?ExpectedCompileErrors = <span class="tok-null">null</span>,</span>
<span class="line" id="L212"></span>
<span class="line" id="L213">emit_directory: ?*GeneratedFile,</span>
<span class="line" id="L214"></span>
<span class="line" id="L215">generated_docs: ?*GeneratedFile,</span>
<span class="line" id="L216">generated_asm: ?*GeneratedFile,</span>
<span class="line" id="L217">generated_bin: ?*GeneratedFile,</span>
<span class="line" id="L218">generated_pdb: ?*GeneratedFile,</span>
<span class="line" id="L219">generated_implib: ?*GeneratedFile,</span>
<span class="line" id="L220">generated_llvm_bc: ?*GeneratedFile,</span>
<span class="line" id="L221">generated_llvm_ir: ?*GeneratedFile,</span>
<span class="line" id="L222">generated_h: ?*GeneratedFile,</span>
<span class="line" id="L223"></span>
<span class="line" id="L224"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ExpectedCompileErrors = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L225">    contains: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L226">    exact: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L227">};</span>
<span class="line" id="L228"></span>
<span class="line" id="L229"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CSourceFiles = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L230">    dependency: ?*std.Build.Dependency,</span>
<span class="line" id="L231">    <span class="tok-comment">/// If `dependency` is not null relative to it,</span></span>
<span class="line" id="L232">    <span class="tok-comment">/// else relative to the build root.</span></span>
<span class="line" id="L233">    files: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L234">    flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L235">};</span>
<span class="line" id="L236"></span>
<span class="line" id="L237"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CSourceFile = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L238">    file: LazyPath,</span>
<span class="line" id="L239">    flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L240"></span>
<span class="line" id="L241">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dupe</span>(self: CSourceFile, b: *std.Build) CSourceFile {</span>
<span class="line" id="L242">        <span class="tok-kw">return</span> .{</span>
<span class="line" id="L243">            .file = self.file.dupe(b),</span>
<span class="line" id="L244">            .flags = b.dupeStrings(self.flags),</span>
<span class="line" id="L245">        };</span>
<span class="line" id="L246">    }</span>
<span class="line" id="L247">};</span>
<span class="line" id="L248"></span>
<span class="line" id="L249"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RcSourceFile = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L250">    file: LazyPath,</span>
<span class="line" id="L251">    <span class="tok-comment">/// Any option that rc.exe accepts will work here, with the exception of:</span></span>
<span class="line" id="L252">    <span class="tok-comment">/// - `/fo`: The output filename is set by the build system</span></span>
<span class="line" id="L253">    <span class="tok-comment">/// - `/p`: Only running the preprocessor is not supported in this context</span></span>
<span class="line" id="L254">    <span class="tok-comment">/// - `/:no-preprocess` (non-standard option): Not supported in this context</span></span>
<span class="line" id="L255">    <span class="tok-comment">/// - Any MUI-related option</span></span>
<span class="line" id="L256">    <span class="tok-comment">/// https://learn.microsoft.com/en-us/windows/win32/menurc/using-rc-the-rc-command-line-</span></span>
<span class="line" id="L257">    <span class="tok-comment">///</span></span>
<span class="line" id="L258">    <span class="tok-comment">/// Implicitly defined options:</span></span>
<span class="line" id="L259">    <span class="tok-comment">///  /x (ignore the INCLUDE environment variable)</span></span>
<span class="line" id="L260">    <span class="tok-comment">///  /D_DEBUG or /DNDEBUG depending on the optimization mode</span></span>
<span class="line" id="L261">    flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = &amp;.{},</span>
<span class="line" id="L262"></span>
<span class="line" id="L263">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dupe</span>(self: RcSourceFile, b: *std.Build) RcSourceFile {</span>
<span class="line" id="L264">        <span class="tok-kw">return</span> .{</span>
<span class="line" id="L265">            .file = self.file.dupe(b),</span>
<span class="line" id="L266">            .flags = b.dupeStrings(self.flags),</span>
<span class="line" id="L267">        };</span>
<span class="line" id="L268">    }</span>
<span class="line" id="L269">};</span>
<span class="line" id="L270"></span>
<span class="line" id="L271"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkObject = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L272">    static_path: LazyPath,</span>
<span class="line" id="L273">    other_step: *Compile,</span>
<span class="line" id="L274">    system_lib: SystemLib,</span>
<span class="line" id="L275">    assembly_file: LazyPath,</span>
<span class="line" id="L276">    c_source_file: *CSourceFile,</span>
<span class="line" id="L277">    c_source_files: *CSourceFiles,</span>
<span class="line" id="L278">    win32_resource_file: *RcSourceFile,</span>
<span class="line" id="L279">};</span>
<span class="line" id="L280"></span>
<span class="line" id="L281"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SystemLib = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L282">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L283">    needed: <span class="tok-type">bool</span>,</span>
<span class="line" id="L284">    weak: <span class="tok-type">bool</span>,</span>
<span class="line" id="L285">    use_pkg_config: UsePkgConfig,</span>
<span class="line" id="L286">    preferred_link_mode: std.builtin.LinkMode,</span>
<span class="line" id="L287">    search_strategy: SystemLib.SearchStrategy,</span>
<span class="line" id="L288"></span>
<span class="line" id="L289">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> UsePkgConfig = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L290">        <span class="tok-comment">/// Don't use pkg-config, just pass -lfoo where foo is name.</span></span>
<span class="line" id="L291">        no,</span>
<span class="line" id="L292">        <span class="tok-comment">/// Try to get information on how to link the library from pkg-config.</span></span>
<span class="line" id="L293">        <span class="tok-comment">/// If that fails, fall back to passing -lfoo where foo is name.</span></span>
<span class="line" id="L294">        yes,</span>
<span class="line" id="L295">        <span class="tok-comment">/// Try to get information on how to link the library from pkg-config.</span></span>
<span class="line" id="L296">        <span class="tok-comment">/// If that fails, error out.</span></span>
<span class="line" id="L297">        force,</span>
<span class="line" id="L298">    };</span>
<span class="line" id="L299"></span>
<span class="line" id="L300">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> SearchStrategy = <span class="tok-kw">enum</span> { paths_first, mode_first, no_fallback };</span>
<span class="line" id="L301">};</span>
<span class="line" id="L302"></span>
<span class="line" id="L303"><span class="tok-kw">const</span> FrameworkLinkInfo = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L304">    needed: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L305">    weak: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L306">};</span>
<span class="line" id="L307"></span>
<span class="line" id="L308"><span class="tok-kw">const</span> Entry = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L309">    <span class="tok-comment">/// Let the compiler decide whether to make an entry point and what to name</span></span>
<span class="line" id="L310">    <span class="tok-comment">/// it.</span></span>
<span class="line" id="L311">    default,</span>
<span class="line" id="L312">    <span class="tok-comment">/// The executable will have no entry point.</span></span>
<span class="line" id="L313">    disabled,</span>
<span class="line" id="L314">    <span class="tok-comment">/// The executable will have an entry point with the default symbol name.</span></span>
<span class="line" id="L315">    enabled,</span>
<span class="line" id="L316">    <span class="tok-comment">/// The executable will have an entry point with the specified symbol name.</span></span>
<span class="line" id="L317">    symbol_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L318">};</span>
<span class="line" id="L319"></span>
<span class="line" id="L320"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IncludeDir = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L321">    path: LazyPath,</span>
<span class="line" id="L322">    path_system: LazyPath,</span>
<span class="line" id="L323">    path_after: LazyPath,</span>
<span class="line" id="L324">    framework_path: LazyPath,</span>
<span class="line" id="L325">    framework_path_system: LazyPath,</span>
<span class="line" id="L326">    other_step: *Compile,</span>
<span class="line" id="L327">    config_header_step: *Step.ConfigHeader,</span>
<span class="line" id="L328">};</span>
<span class="line" id="L329"></span>
<span class="line" id="L330"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Options = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L331">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L332">    root_source_file: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L333">    target: CrossTarget,</span>
<span class="line" id="L334">    optimize: std.builtin.OptimizeMode,</span>
<span class="line" id="L335">    kind: Kind,</span>
<span class="line" id="L336">    linkage: ?Linkage = <span class="tok-null">null</span>,</span>
<span class="line" id="L337">    version: ?std.SemanticVersion = <span class="tok-null">null</span>,</span>
<span class="line" id="L338">    max_rss: <span class="tok-type">usize</span> = <span class="tok-number">0</span>,</span>
<span class="line" id="L339">    filter: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L340">    test_runner: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L341">    link_libc: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L342">    single_threaded: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L343">    use_llvm: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L344">    use_lld: ?<span class="tok-type">bool</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L345">    zig_lib_dir: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L346">    main_mod_path: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L347">    <span class="tok-comment">/// Embed a `.manifest` file in the compilation if the object format supports it.</span></span>
<span class="line" id="L348">    <span class="tok-comment">/// https://learn.microsoft.com/en-us/windows/win32/sbscs/manifest-files-reference</span></span>
<span class="line" id="L349">    <span class="tok-comment">/// Manifest files must have the extension `.manifest`.</span></span>
<span class="line" id="L350">    <span class="tok-comment">/// Can be set regardless of target. The `.manifest` file will be ignored</span></span>
<span class="line" id="L351">    <span class="tok-comment">/// if the target object format does not support embedded manifests.</span></span>
<span class="line" id="L352">    win32_manifest: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L353"></span>
<span class="line" id="L354">    <span class="tok-comment">/// deprecated; use `main_mod_path`.</span></span>
<span class="line" id="L355">    main_pkg_path: ?LazyPath = <span class="tok-null">null</span>,</span>
<span class="line" id="L356">};</span>
<span class="line" id="L357"></span>
<span class="line" id="L358"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BuildId = <span class="tok-kw">union</span>(<span class="tok-kw">enum</span>) {</span>
<span class="line" id="L359">    none,</span>
<span class="line" id="L360">    fast,</span>
<span class="line" id="L361">    uuid,</span>
<span class="line" id="L362">    sha1,</span>
<span class="line" id="L363">    md5,</span>
<span class="line" id="L364">    hexstring: HexString,</span>
<span class="line" id="L365"></span>
<span class="line" id="L366">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">eql</span>(a: BuildId, b: BuildId) <span class="tok-type">bool</span> {</span>
<span class="line" id="L367">        <span class="tok-kw">const</span> a_tag = std.meta.activeTag(a);</span>
<span class="line" id="L368">        <span class="tok-kw">const</span> b_tag = std.meta.activeTag(b);</span>
<span class="line" id="L369">        <span class="tok-kw">if</span> (a_tag != b_tag) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L370">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (a) {</span>
<span class="line" id="L371">            .none, .fast, .uuid, .sha1, .md5 =&gt; <span class="tok-null">true</span>,</span>
<span class="line" id="L372">            .hexstring =&gt; |a_hexstring| mem.eql(<span class="tok-type">u8</span>, a_hexstring.toSlice(), b.hexstring.toSlice()),</span>
<span class="line" id="L373">        };</span>
<span class="line" id="L374">    }</span>
<span class="line" id="L375"></span>
<span class="line" id="L376">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> HexString = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L377">        bytes: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L378">        len: <span class="tok-type">u8</span>,</span>
<span class="line" id="L379"></span>
<span class="line" id="L380">        <span class="tok-comment">/// Result is byte values, *not* hex-encoded.</span></span>
<span class="line" id="L381">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toSlice</span>(hs: *<span class="tok-kw">const</span> HexString) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L382">            <span class="tok-kw">return</span> hs.bytes[<span class="tok-number">0</span>..hs.len];</span>
<span class="line" id="L383">        }</span>
<span class="line" id="L384">    };</span>
<span class="line" id="L385"></span>
<span class="line" id="L386">    <span class="tok-comment">/// Input is byte values, *not* hex-encoded.</span></span>
<span class="line" id="L387">    <span class="tok-comment">/// Asserts `bytes` fits inside `HexString`</span></span>
<span class="line" id="L388">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">initHexString</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) BuildId {</span>
<span class="line" id="L389">        <span class="tok-kw">var</span> result: BuildId = .{ .hexstring = .{</span>
<span class="line" id="L390">            .bytes = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L391">            .len = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(bytes.len)),</span>
<span class="line" id="L392">        } };</span>
<span class="line" id="L393">        <span class="tok-builtin">@memcpy</span>(result.hexstring.bytes[<span class="tok-number">0</span>..bytes.len], bytes);</span>
<span class="line" id="L394">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L395">    }</span>
<span class="line" id="L396"></span>
<span class="line" id="L397">    <span class="tok-comment">/// Converts UTF-8 text to a `BuildId`.</span></span>
<span class="line" id="L398">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parse</span>(text: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !BuildId {</span>
<span class="line" id="L399">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;none&quot;</span>)) {</span>
<span class="line" id="L400">            <span class="tok-kw">return</span> .none;</span>
<span class="line" id="L401">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;fast&quot;</span>)) {</span>
<span class="line" id="L402">            <span class="tok-kw">return</span> .fast;</span>
<span class="line" id="L403">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;uuid&quot;</span>)) {</span>
<span class="line" id="L404">            <span class="tok-kw">return</span> .uuid;</span>
<span class="line" id="L405">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;sha1&quot;</span>) <span class="tok-kw">or</span> mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;tree&quot;</span>)) {</span>
<span class="line" id="L406">            <span class="tok-kw">return</span> .sha1;</span>
<span class="line" id="L407">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;md5&quot;</span>)) {</span>
<span class="line" id="L408">            <span class="tok-kw">return</span> .md5;</span>
<span class="line" id="L409">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, text, <span class="tok-str">&quot;0x&quot;</span>)) {</span>
<span class="line" id="L410">            <span class="tok-kw">var</span> result: BuildId = .{ .hexstring = <span class="tok-null">undefined</span> };</span>
<span class="line" id="L411">            <span class="tok-kw">const</span> slice = <span class="tok-kw">try</span> std.fmt.hexToBytes(&amp;result.hexstring.bytes, text[<span class="tok-number">2</span>..]);</span>
<span class="line" id="L412">            result.hexstring.len = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(slice.len));</span>
<span class="line" id="L413">            <span class="tok-kw">return</span> result;</span>
<span class="line" id="L414">        }</span>
<span class="line" id="L415">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidBuildIdStyle;</span>
<span class="line" id="L416">    }</span>
<span class="line" id="L417"></span>
<span class="line" id="L418">    <span class="tok-kw">test</span> parse {</span>
<span class="line" id="L419">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.md5, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;md5&quot;</span>));</span>
<span class="line" id="L420">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.none, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;none&quot;</span>));</span>
<span class="line" id="L421">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.fast, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;fast&quot;</span>));</span>
<span class="line" id="L422">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.uuid, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;uuid&quot;</span>));</span>
<span class="line" id="L423">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.sha1, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;sha1&quot;</span>));</span>
<span class="line" id="L424">        <span class="tok-kw">try</span> std.testing.expectEqual(BuildId.sha1, <span class="tok-kw">try</span> parse(<span class="tok-str">&quot;tree&quot;</span>));</span>
<span class="line" id="L425"></span>
<span class="line" id="L426">        <span class="tok-kw">try</span> std.testing.expect(BuildId.initHexString(<span class="tok-str">&quot;&quot;</span>).eql(<span class="tok-kw">try</span> parse(<span class="tok-str">&quot;0x&quot;</span>)));</span>
<span class="line" id="L427">        <span class="tok-kw">try</span> std.testing.expect(BuildId.initHexString(<span class="tok-str">&quot;\x12\x34\x56&quot;</span>).eql(<span class="tok-kw">try</span> parse(<span class="tok-str">&quot;0x123456&quot;</span>)));</span>
<span class="line" id="L428">        <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.InvalidLength, parse(<span class="tok-str">&quot;0x12-34&quot;</span>));</span>
<span class="line" id="L429">        <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.InvalidCharacter, parse(<span class="tok-str">&quot;0xfoobbb&quot;</span>));</span>
<span class="line" id="L430">        <span class="tok-kw">try</span> std.testing.expectError(<span class="tok-kw">error</span>.InvalidBuildIdStyle, parse(<span class="tok-str">&quot;yaddaxxx&quot;</span>));</span>
<span class="line" id="L431">    }</span>
<span class="line" id="L432">};</span>
<span class="line" id="L433"></span>
<span class="line" id="L434"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kind = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L435">    exe,</span>
<span class="line" id="L436">    lib,</span>
<span class="line" id="L437">    obj,</span>
<span class="line" id="L438">    @&quot;test&quot;,</span>
<span class="line" id="L439">};</span>
<span class="line" id="L440"></span>
<span class="line" id="L441"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Linkage = <span class="tok-kw">enum</span> { dynamic, static };</span>
<span class="line" id="L442"></span>
<span class="line" id="L443"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">create</span>(owner: *std.Build, options: Options) *Compile {</span>
<span class="line" id="L444">    <span class="tok-kw">const</span> name = owner.dupe(options.name);</span>
<span class="line" id="L445">    <span class="tok-kw">const</span> root_src: ?LazyPath = <span class="tok-kw">if</span> (options.root_source_file) |rsrc| rsrc.dupe(owner) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L446">    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;/&quot;</span>) != <span class="tok-null">null</span> <span class="tok-kw">or</span> mem.indexOf(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;\\&quot;</span>) != <span class="tok-null">null</span>) {</span>
<span class="line" id="L447">        panic(<span class="tok-str">&quot;invalid name: '{s}'. It looks like a file path, but it is supposed to be the library or application name.&quot;</span>, .{name});</span>
<span class="line" id="L448">    }</span>
<span class="line" id="L449"></span>
<span class="line" id="L450">    <span class="tok-comment">// Avoid the common case of the step name looking like &quot;zig test test&quot;.</span>
</span>
<span class="line" id="L451">    <span class="tok-kw">const</span> name_adjusted = <span class="tok-kw">if</span> (options.kind == .@&quot;test&quot; <span class="tok-kw">and</span> mem.eql(<span class="tok-type">u8</span>, name, <span class="tok-str">&quot;test&quot;</span>))</span>
<span class="line" id="L452">        <span class="tok-str">&quot;&quot;</span></span>
<span class="line" id="L453">    <span class="tok-kw">else</span></span>
<span class="line" id="L454">        owner.fmt(<span class="tok-str">&quot;{s} &quot;</span>, .{name});</span>
<span class="line" id="L455"></span>
<span class="line" id="L456">    <span class="tok-kw">const</span> step_name = owner.fmt(<span class="tok-str">&quot;{s} {s}{s} {s}&quot;</span>, .{</span>
<span class="line" id="L457">        <span class="tok-kw">switch</span> (options.kind) {</span>
<span class="line" id="L458">            .exe =&gt; <span class="tok-str">&quot;zig build-exe&quot;</span>,</span>
<span class="line" id="L459">            .lib =&gt; <span class="tok-str">&quot;zig build-lib&quot;</span>,</span>
<span class="line" id="L460">            .obj =&gt; <span class="tok-str">&quot;zig build-obj&quot;</span>,</span>
<span class="line" id="L461">            .@&quot;test&quot; =&gt; <span class="tok-str">&quot;zig test&quot;</span>,</span>
<span class="line" id="L462">        },</span>
<span class="line" id="L463">        name_adjusted,</span>
<span class="line" id="L464">        <span class="tok-builtin">@tagName</span>(options.optimize),</span>
<span class="line" id="L465">        options.target.zigTriple(owner.allocator) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>),</span>
<span class="line" id="L466">    });</span>
<span class="line" id="L467"></span>
<span class="line" id="L468">    <span class="tok-kw">const</span> target_info = NativeTargetInfo.detect(options.target) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;unhandled error&quot;</span>);</span>
<span class="line" id="L469"></span>
<span class="line" id="L470">    <span class="tok-kw">const</span> out_filename = std.zig.binNameAlloc(owner.allocator, .{</span>
<span class="line" id="L471">        .root_name = name,</span>
<span class="line" id="L472">        .target = target_info.target,</span>
<span class="line" id="L473">        .output_mode = <span class="tok-kw">switch</span> (options.kind) {</span>
<span class="line" id="L474">            .lib =&gt; .Lib,</span>
<span class="line" id="L475">            .obj =&gt; .Obj,</span>
<span class="line" id="L476">            .exe, .@&quot;test&quot; =&gt; .Exe,</span>
<span class="line" id="L477">        },</span>
<span class="line" id="L478">        .link_mode = <span class="tok-kw">if</span> (options.linkage) |some| <span class="tok-builtin">@as</span>(std.builtin.LinkMode, <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L479">            .dynamic =&gt; .Dynamic,</span>
<span class="line" id="L480">            .static =&gt; .Static,</span>
<span class="line" id="L481">        }) <span class="tok-kw">else</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L482">        .version = options.version,</span>
<span class="line" id="L483">    }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L484"></span>
<span class="line" id="L485">    <span class="tok-kw">const</span> self = owner.allocator.create(Compile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L486">    self.* = .{</span>
<span class="line" id="L487">        .strip = <span class="tok-null">null</span>,</span>
<span class="line" id="L488">        .unwind_tables = <span class="tok-null">null</span>,</span>
<span class="line" id="L489">        .verbose_link = <span class="tok-null">false</span>,</span>
<span class="line" id="L490">        .verbose_cc = <span class="tok-null">false</span>,</span>
<span class="line" id="L491">        .optimize = options.optimize,</span>
<span class="line" id="L492">        .target = options.target,</span>
<span class="line" id="L493">        .linkage = options.linkage,</span>
<span class="line" id="L494">        .kind = options.kind,</span>
<span class="line" id="L495">        .root_src = root_src,</span>
<span class="line" id="L496">        .name = name,</span>
<span class="line" id="L497">        .frameworks = StringHashMap(FrameworkLinkInfo).init(owner.allocator),</span>
<span class="line" id="L498">        .step = Step.init(.{</span>
<span class="line" id="L499">            .id = base_id,</span>
<span class="line" id="L500">            .name = step_name,</span>
<span class="line" id="L501">            .owner = owner,</span>
<span class="line" id="L502">            .makeFn = make,</span>
<span class="line" id="L503">            .max_rss = options.max_rss,</span>
<span class="line" id="L504">        }),</span>
<span class="line" id="L505">        .version = options.version,</span>
<span class="line" id="L506">        .out_filename = out_filename,</span>
<span class="line" id="L507">        .out_lib_filename = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L508">        .major_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L509">        .name_only_filename = <span class="tok-null">null</span>,</span>
<span class="line" id="L510">        .modules = std.StringArrayHashMap(*Module).init(owner.allocator),</span>
<span class="line" id="L511">        .include_dirs = ArrayList(IncludeDir).init(owner.allocator),</span>
<span class="line" id="L512">        .link_objects = ArrayList(LinkObject).init(owner.allocator),</span>
<span class="line" id="L513">        .c_macros = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(owner.allocator),</span>
<span class="line" id="L514">        .lib_paths = ArrayList(LazyPath).init(owner.allocator),</span>
<span class="line" id="L515">        .rpaths = ArrayList(LazyPath).init(owner.allocator),</span>
<span class="line" id="L516">        .installed_headers = ArrayList(*Step).init(owner.allocator),</span>
<span class="line" id="L517">        .c_std = std.Build.CStd.C99,</span>
<span class="line" id="L518">        .zig_lib_dir = <span class="tok-null">null</span>,</span>
<span class="line" id="L519">        .main_mod_path = <span class="tok-null">null</span>,</span>
<span class="line" id="L520">        .exec_cmd_args = <span class="tok-null">null</span>,</span>
<span class="line" id="L521">        .filter = options.filter,</span>
<span class="line" id="L522">        .test_runner = options.test_runner,</span>
<span class="line" id="L523">        .test_server_mode = options.test_runner == <span class="tok-null">null</span>,</span>
<span class="line" id="L524">        .disable_stack_probing = <span class="tok-null">false</span>,</span>
<span class="line" id="L525">        .disable_sanitize_c = <span class="tok-null">false</span>,</span>
<span class="line" id="L526">        .sanitize_thread = <span class="tok-null">false</span>,</span>
<span class="line" id="L527">        .rdynamic = <span class="tok-null">false</span>,</span>
<span class="line" id="L528">        .installed_path = <span class="tok-null">null</span>,</span>
<span class="line" id="L529">        .force_undefined_symbols = StringHashMap(<span class="tok-type">void</span>).init(owner.allocator),</span>
<span class="line" id="L530"></span>
<span class="line" id="L531">        .emit_directory = <span class="tok-null">null</span>,</span>
<span class="line" id="L532">        .generated_docs = <span class="tok-null">null</span>,</span>
<span class="line" id="L533">        .generated_asm = <span class="tok-null">null</span>,</span>
<span class="line" id="L534">        .generated_bin = <span class="tok-null">null</span>,</span>
<span class="line" id="L535">        .generated_pdb = <span class="tok-null">null</span>,</span>
<span class="line" id="L536">        .generated_implib = <span class="tok-null">null</span>,</span>
<span class="line" id="L537">        .generated_llvm_bc = <span class="tok-null">null</span>,</span>
<span class="line" id="L538">        .generated_llvm_ir = <span class="tok-null">null</span>,</span>
<span class="line" id="L539">        .generated_h = <span class="tok-null">null</span>,</span>
<span class="line" id="L540"></span>
<span class="line" id="L541">        .target_info = target_info,</span>
<span class="line" id="L542"></span>
<span class="line" id="L543">        .is_linking_libc = options.link_libc <span class="tok-kw">orelse</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L544">        .is_linking_libcpp = <span class="tok-null">false</span>,</span>
<span class="line" id="L545">        .single_threaded = options.single_threaded,</span>
<span class="line" id="L546">        .use_llvm = options.use_llvm,</span>
<span class="line" id="L547">        .use_lld = options.use_lld,</span>
<span class="line" id="L548">    };</span>
<span class="line" id="L549"></span>
<span class="line" id="L550">    <span class="tok-kw">if</span> (options.zig_lib_dir) |lp| {</span>
<span class="line" id="L551">        self.zig_lib_dir = lp.dupe(self.step.owner);</span>
<span class="line" id="L552">        lp.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L553">    }</span>
<span class="line" id="L554"></span>
<span class="line" id="L555">    <span class="tok-kw">if</span> (options.main_mod_path <span class="tok-kw">orelse</span> options.main_pkg_path) |lp| {</span>
<span class="line" id="L556">        self.main_mod_path = lp.dupe(self.step.owner);</span>
<span class="line" id="L557">        lp.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L558">    }</span>
<span class="line" id="L559"></span>
<span class="line" id="L560">    <span class="tok-comment">// Only the PE/COFF format has a Resource Table which is where the manifest</span>
</span>
<span class="line" id="L561">    <span class="tok-comment">// gets embedded, so for any other target the manifest file is just ignored.</span>
</span>
<span class="line" id="L562">    <span class="tok-kw">if</span> (self.target.getObjectFormat() == .coff) {</span>
<span class="line" id="L563">        <span class="tok-kw">if</span> (options.win32_manifest) |lp| {</span>
<span class="line" id="L564">            self.win32_manifest = lp.dupe(self.step.owner);</span>
<span class="line" id="L565">            lp.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L566">        }</span>
<span class="line" id="L567">    }</span>
<span class="line" id="L568"></span>
<span class="line" id="L569">    <span class="tok-kw">if</span> (self.kind == .lib) {</span>
<span class="line" id="L570">        <span class="tok-kw">if</span> (self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .static) {</span>
<span class="line" id="L571">            self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L572">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L573">            <span class="tok-kw">if</span> (target_info.target.isDarwin()) {</span>
<span class="line" id="L574">                self.major_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.{d}.dylib&quot;</span>, .{</span>
<span class="line" id="L575">                    self.name,</span>
<span class="line" id="L576">                    version.major,</span>
<span class="line" id="L577">                });</span>
<span class="line" id="L578">                self.name_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.dylib&quot;</span>, .{self.name});</span>
<span class="line" id="L579">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L580">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target_info.target.os.tag == .windows) {</span>
<span class="line" id="L581">                self.out_lib_filename = owner.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L582">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L583">                self.major_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.so.{d}&quot;</span>, .{ self.name, version.major });</span>
<span class="line" id="L584">                self.name_only_filename = owner.fmt(<span class="tok-str">&quot;lib{s}.so&quot;</span>, .{self.name});</span>
<span class="line" id="L585">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L586">            }</span>
<span class="line" id="L587">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L588">            <span class="tok-kw">if</span> (target_info.target.isDarwin()) {</span>
<span class="line" id="L589">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L590">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (target_info.target.os.tag == .windows) {</span>
<span class="line" id="L591">                self.out_lib_filename = owner.fmt(<span class="tok-str">&quot;{s}.lib&quot;</span>, .{self.name});</span>
<span class="line" id="L592">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L593">                self.out_lib_filename = self.out_filename;</span>
<span class="line" id="L594">            }</span>
<span class="line" id="L595">        }</span>
<span class="line" id="L596">    }</span>
<span class="line" id="L597"></span>
<span class="line" id="L598">    <span class="tok-kw">if</span> (root_src) |rs| rs.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L599"></span>
<span class="line" id="L600">    <span class="tok-kw">return</span> self;</span>
<span class="line" id="L601">}</span>
<span class="line" id="L602"></span>
<span class="line" id="L603"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeader</span>(cs: *Compile, src_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, dest_rel_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L604">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L605">    <span class="tok-kw">const</span> install_file = b.addInstallHeaderFile(src_path, dest_rel_path);</span>
<span class="line" id="L606">    b.getInstallStep().dependOn(&amp;install_file.step);</span>
<span class="line" id="L607">    cs.installed_headers.append(&amp;install_file.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L608">}</span>
<span class="line" id="L609"></span>
<span class="line" id="L610"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> InstallConfigHeaderOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L611">    install_dir: InstallDir = .header,</span>
<span class="line" id="L612">    dest_rel_path: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">null</span>,</span>
<span class="line" id="L613">};</span>
<span class="line" id="L614"></span>
<span class="line" id="L615"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installConfigHeader</span>(</span>
<span class="line" id="L616">    cs: *Compile,</span>
<span class="line" id="L617">    config_header: *Step.ConfigHeader,</span>
<span class="line" id="L618">    options: InstallConfigHeaderOptions,</span>
<span class="line" id="L619">) <span class="tok-type">void</span> {</span>
<span class="line" id="L620">    <span class="tok-kw">const</span> dest_rel_path = options.dest_rel_path <span class="tok-kw">orelse</span> config_header.include_path;</span>
<span class="line" id="L621">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L622">    <span class="tok-kw">const</span> install_file = b.addInstallFileWithDir(</span>
<span class="line" id="L623">        .{ .generated = &amp;config_header.output_file },</span>
<span class="line" id="L624">        options.install_dir,</span>
<span class="line" id="L625">        dest_rel_path,</span>
<span class="line" id="L626">    );</span>
<span class="line" id="L627">    install_file.step.dependOn(&amp;config_header.step);</span>
<span class="line" id="L628">    b.getInstallStep().dependOn(&amp;install_file.step);</span>
<span class="line" id="L629">    cs.installed_headers.append(&amp;install_file.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L630">}</span>
<span class="line" id="L631"></span>
<span class="line" id="L632"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeadersDirectory</span>(</span>
<span class="line" id="L633">    a: *Compile,</span>
<span class="line" id="L634">    src_dir_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L635">    dest_rel_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L636">) <span class="tok-type">void</span> {</span>
<span class="line" id="L637">    <span class="tok-kw">return</span> installHeadersDirectoryOptions(a, .{</span>
<span class="line" id="L638">        .source_dir = .{ .path = src_dir_path },</span>
<span class="line" id="L639">        .install_dir = .header,</span>
<span class="line" id="L640">        .install_subdir = dest_rel_path,</span>
<span class="line" id="L641">    });</span>
<span class="line" id="L642">}</span>
<span class="line" id="L643"></span>
<span class="line" id="L644"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installHeadersDirectoryOptions</span>(</span>
<span class="line" id="L645">    cs: *Compile,</span>
<span class="line" id="L646">    options: std.Build.Step.InstallDir.Options,</span>
<span class="line" id="L647">) <span class="tok-type">void</span> {</span>
<span class="line" id="L648">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L649">    <span class="tok-kw">const</span> install_dir = b.addInstallDirectory(options);</span>
<span class="line" id="L650">    b.getInstallStep().dependOn(&amp;install_dir.step);</span>
<span class="line" id="L651">    cs.installed_headers.append(&amp;install_dir.step) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L652">}</span>
<span class="line" id="L653"></span>
<span class="line" id="L654"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">installLibraryHeaders</span>(cs: *Compile, l: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L655">    assert(l.kind == .lib);</span>
<span class="line" id="L656">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L657">    <span class="tok-kw">const</span> install_step = b.getInstallStep();</span>
<span class="line" id="L658">    <span class="tok-comment">// Copy each element from installed_headers, modifying the builder</span>
</span>
<span class="line" id="L659">    <span class="tok-comment">// to be the new parent's builder.</span>
</span>
<span class="line" id="L660">    <span class="tok-kw">for</span> (l.installed_headers.items) |step| {</span>
<span class="line" id="L661">        <span class="tok-kw">const</span> step_copy = <span class="tok-kw">switch</span> (step.id) {</span>
<span class="line" id="L662">            <span class="tok-kw">inline</span> .install_file, .install_dir =&gt; |id| blk: {</span>
<span class="line" id="L663">                <span class="tok-kw">const</span> T = id.Type();</span>
<span class="line" id="L664">                <span class="tok-kw">const</span> ptr = b.allocator.create(T) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L665">                ptr.* = step.cast(T).?.*;</span>
<span class="line" id="L666">                ptr.dest_builder = b;</span>
<span class="line" id="L667">                <span class="tok-kw">break</span> :blk &amp;ptr.step;</span>
<span class="line" id="L668">            },</span>
<span class="line" id="L669">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L670">        };</span>
<span class="line" id="L671">        cs.installed_headers.append(step_copy) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L672">        install_step.dependOn(step_copy);</span>
<span class="line" id="L673">    }</span>
<span class="line" id="L674">    cs.installed_headers.appendSlice(l.installed_headers.items) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L675">}</span>
<span class="line" id="L676"></span>
<span class="line" id="L677"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjCopy</span>(cs: *Compile, options: Step.ObjCopy.Options) *Step.ObjCopy {</span>
<span class="line" id="L678">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L679">    <span class="tok-kw">var</span> copy = options;</span>
<span class="line" id="L680">    <span class="tok-kw">if</span> (copy.basename == <span class="tok-null">null</span>) {</span>
<span class="line" id="L681">        <span class="tok-kw">if</span> (options.format) |f| {</span>
<span class="line" id="L682">            copy.basename = b.fmt(<span class="tok-str">&quot;{s}.{s}&quot;</span>, .{ cs.name, <span class="tok-builtin">@tagName</span>(f) });</span>
<span class="line" id="L683">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L684">            copy.basename = cs.name;</span>
<span class="line" id="L685">        }</span>
<span class="line" id="L686">    }</span>
<span class="line" id="L687">    <span class="tok-kw">return</span> b.addObjCopy(cs.getEmittedBin(), copy);</span>
<span class="line" id="L688">}</span>
<span class="line" id="L689"></span>
<span class="line" id="L690"><span class="tok-comment">/// This function would run in the context of the package that created the executable,</span></span>
<span class="line" id="L691"><span class="tok-comment">/// which is undesirable when running an executable provided by a dependency package.</span></span>
<span class="line" id="L692"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> run = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use std.Build.addRunArtifact&quot;</span>);</span>
<span class="line" id="L693"></span>
<span class="line" id="L694"><span class="tok-comment">/// This function would install in the context of the package that created the artifact,</span></span>
<span class="line" id="L695"><span class="tok-comment">/// which is undesirable when installing an artifact provided by a dependency package.</span></span>
<span class="line" id="L696"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> install = <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;deprecated; use std.Build.installArtifact&quot;</span>);</span>
<span class="line" id="L697"></span>
<span class="line" id="L698"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">checkObject</span>(self: *Compile) *Step.CheckObject {</span>
<span class="line" id="L699">    <span class="tok-kw">return</span> Step.CheckObject.create(self.step.owner, self.getEmittedBin(), self.target_info.target.ofmt);</span>
<span class="line" id="L700">}</span>
<span class="line" id="L701"></span>
<span class="line" id="L702"><span class="tok-comment">/// deprecated: use `setLinkerScript`</span></span>
<span class="line" id="L703"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> setLinkerScriptPath = setLinkerScript;</span>
<span class="line" id="L704"></span>
<span class="line" id="L705"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLinkerScript</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L706">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L707">    self.linker_script = source.dupe(b);</span>
<span class="line" id="L708">    source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L709">}</span>
<span class="line" id="L710"></span>
<span class="line" id="L711"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">forceUndefinedSymbol</span>(self: *Compile, symbol_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L712">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L713">    self.force_undefined_symbols.put(b.dupe(symbol_name), {}) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L714">}</span>
<span class="line" id="L715"></span>
<span class="line" id="L716"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFramework</span>(self: *Compile, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L717">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L718">    self.frameworks.put(b.dupe(framework_name), .{}) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L719">}</span>
<span class="line" id="L720"></span>
<span class="line" id="L721"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkNeeded</span>(self: *Compile, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L722">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L723">    self.frameworks.put(b.dupe(framework_name), .{</span>
<span class="line" id="L724">        .needed = <span class="tok-null">true</span>,</span>
<span class="line" id="L725">    }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L726">}</span>
<span class="line" id="L727"></span>
<span class="line" id="L728"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkFrameworkWeak</span>(self: *Compile, framework_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L729">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L730">    self.frameworks.put(b.dupe(framework_name), .{</span>
<span class="line" id="L731">        .weak = <span class="tok-null">true</span>,</span>
<span class="line" id="L732">    }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L733">}</span>
<span class="line" id="L734"></span>
<span class="line" id="L735"><span class="tok-comment">/// Returns whether the library, executable, or object depends on a particular system library.</span></span>
<span class="line" id="L736"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">dependsOnSystemLibrary</span>(self: Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L737">    <span class="tok-kw">if</span> (isLibCLibrary(name)) {</span>
<span class="line" id="L738">        <span class="tok-kw">return</span> self.is_linking_libc;</span>
<span class="line" id="L739">    }</span>
<span class="line" id="L740">    <span class="tok-kw">if</span> (isLibCppLibrary(name)) {</span>
<span class="line" id="L741">        <span class="tok-kw">return</span> self.is_linking_libcpp;</span>
<span class="line" id="L742">    }</span>
<span class="line" id="L743">    <span class="tok-kw">for</span> (self.link_objects.items) |link_object| {</span>
<span class="line" id="L744">        <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L745">            .system_lib =&gt; |lib| <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, lib.name, name)) <span class="tok-kw">return</span> <span class="tok-null">true</span>,</span>
<span class="line" id="L746">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L747">        }</span>
<span class="line" id="L748">    }</span>
<span class="line" id="L749">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L750">}</span>
<span class="line" id="L751"></span>
<span class="line" id="L752"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibrary</span>(self: *Compile, lib: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L753">    assert(lib.kind == .lib);</span>
<span class="line" id="L754">    self.linkLibraryOrObject(lib);</span>
<span class="line" id="L755">}</span>
<span class="line" id="L756"></span>
<span class="line" id="L757"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isDynamicLibrary</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L758">    <span class="tok-kw">return</span> self.kind == .lib <span class="tok-kw">and</span> self.linkage == Linkage.dynamic;</span>
<span class="line" id="L759">}</span>
<span class="line" id="L760"></span>
<span class="line" id="L761"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isStaticLibrary</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L762">    <span class="tok-kw">return</span> self.kind == .lib <span class="tok-kw">and</span> self.linkage != Linkage.dynamic;</span>
<span class="line" id="L763">}</span>
<span class="line" id="L764"></span>
<span class="line" id="L765"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">producesPdbFile</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L766">    <span class="tok-comment">// TODO: Is this right? Isn't PDB for *any* PE/COFF file?</span>
</span>
<span class="line" id="L767">    <span class="tok-comment">// TODO: just share this logic with the compiler, silly!</span>
</span>
<span class="line" id="L768">    <span class="tok-kw">if</span> (!self.target.isWindows() <span class="tok-kw">and</span> !self.target.isUefi()) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L769">    <span class="tok-kw">if</span> (self.target.getObjectFormat() == .c) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L770">    <span class="tok-kw">if</span> (self.strip == <span class="tok-null">true</span> <span class="tok-kw">or</span> (self.strip == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.optimize == .ReleaseSmall)) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L771">    <span class="tok-kw">return</span> self.isDynamicLibrary() <span class="tok-kw">or</span> self.kind == .exe <span class="tok-kw">or</span> self.kind == .@&quot;test&quot;;</span>
<span class="line" id="L772">}</span>
<span class="line" id="L773"></span>
<span class="line" id="L774"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">producesImplib</span>(self: *Compile) <span class="tok-type">bool</span> {</span>
<span class="line" id="L775">    <span class="tok-kw">return</span> self.isDynamicLibrary() <span class="tok-kw">and</span> self.target.isWindows();</span>
<span class="line" id="L776">}</span>
<span class="line" id="L777"></span>
<span class="line" id="L778"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibC</span>(self: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L779">    self.is_linking_libc = <span class="tok-null">true</span>;</span>
<span class="line" id="L780">}</span>
<span class="line" id="L781"></span>
<span class="line" id="L782"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkLibCpp</span>(self: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L783">    self.is_linking_libcpp = <span class="tok-null">true</span>;</span>
<span class="line" id="L784">}</span>
<span class="line" id="L785"></span>
<span class="line" id="L786"><span class="tok-comment">/// If the value is omitted, it is set to 1.</span></span>
<span class="line" id="L787"><span class="tok-comment">/// `name` and `value` need not live longer than the function call.</span></span>
<span class="line" id="L788"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">defineCMacro</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L789">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L790">    <span class="tok-kw">const</span> macro = std.Build.constructCMacro(b.allocator, name, value);</span>
<span class="line" id="L791">    self.c_macros.append(macro) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L792">}</span>
<span class="line" id="L793"></span>
<span class="line" id="L794"><span class="tok-comment">/// name_and_value looks like [name]=[value]. If the value is omitted, it is set to 1.</span></span>
<span class="line" id="L795"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">defineCMacroRaw</span>(self: *Compile, name_and_value: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L796">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L797">    self.c_macros.append(b.dupe(name_and_value)) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L798">}</span>
<span class="line" id="L799"></span>
<span class="line" id="L800"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L801"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryName</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L802">    <span class="tok-kw">return</span> linkSystemLibrary2(self, name, .{ .use_pkg_config = .no });</span>
<span class="line" id="L803">}</span>
<span class="line" id="L804"></span>
<span class="line" id="L805"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L806"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeededName</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L807">    <span class="tok-kw">return</span> linkSystemLibrary2(self, name, .{ .needed = <span class="tok-null">true</span>, .use_pkg_config = .no });</span>
<span class="line" id="L808">}</span>
<span class="line" id="L809"></span>
<span class="line" id="L810"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L811"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryWeakName</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L812">    <span class="tok-kw">return</span> linkSystemLibrary2(self, name, .{ .weak = <span class="tok-null">true</span>, .use_pkg_config = .no });</span>
<span class="line" id="L813">}</span>
<span class="line" id="L814"></span>
<span class="line" id="L815"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L816"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryPkgConfigOnly</span>(self: *Compile, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L817">    <span class="tok-kw">return</span> linkSystemLibrary2(self, lib_name, .{ .use_pkg_config = .force });</span>
<span class="line" id="L818">}</span>
<span class="line" id="L819"></span>
<span class="line" id="L820"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L821"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeededPkgConfigOnly</span>(self: *Compile, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L822">    <span class="tok-kw">return</span> linkSystemLibrary2(self, lib_name, .{ .needed = <span class="tok-null">true</span>, .use_pkg_config = .force });</span>
<span class="line" id="L823">}</span>
<span class="line" id="L824"></span>
<span class="line" id="L825"><span class="tok-comment">/// Run pkg-config for the given library name and parse the output, returning the arguments</span></span>
<span class="line" id="L826"><span class="tok-comment">/// that should be passed to zig to link the given library.</span></span>
<span class="line" id="L827"><span class="tok-kw">fn</span> <span class="tok-fn">runPkgConfig</span>(self: *Compile, lib_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) ![]<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L828">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L829">    <span class="tok-kw">const</span> pkg_name = match: {</span>
<span class="line" id="L830">        <span class="tok-comment">// First we have to map the library name to pkg config name. Unfortunately,</span>
</span>
<span class="line" id="L831">        <span class="tok-comment">// there are several examples where this is not straightforward:</span>
</span>
<span class="line" id="L832">        <span class="tok-comment">// -lSDL2 -&gt; pkg-config sdl2</span>
</span>
<span class="line" id="L833">        <span class="tok-comment">// -lgdk-3 -&gt; pkg-config gdk-3.0</span>
</span>
<span class="line" id="L834">        <span class="tok-comment">// -latk-1.0 -&gt; pkg-config atk</span>
</span>
<span class="line" id="L835">        <span class="tok-kw">const</span> pkgs = <span class="tok-kw">try</span> getPkgConfigList(b);</span>
<span class="line" id="L836"></span>
<span class="line" id="L837">        <span class="tok-comment">// Exact match means instant winner.</span>
</span>
<span class="line" id="L838">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L839">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name, lib_name)) {</span>
<span class="line" id="L840">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L841">            }</span>
<span class="line" id="L842">        }</span>
<span class="line" id="L843"></span>
<span class="line" id="L844">        <span class="tok-comment">// Next we'll try ignoring case.</span>
</span>
<span class="line" id="L845">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L846">            <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, lib_name)) {</span>
<span class="line" id="L847">                <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L848">            }</span>
<span class="line" id="L849">        }</span>
<span class="line" id="L850"></span>
<span class="line" id="L851">        <span class="tok-comment">// Now try appending &quot;.0&quot;.</span>
</span>
<span class="line" id="L852">        <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L853">            <span class="tok-kw">if</span> (std.ascii.indexOfIgnoreCase(pkg.name, lib_name)) |pos| {</span>
<span class="line" id="L854">                <span class="tok-kw">if</span> (pos != <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L855">                <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, pkg.name[lib_name.len..], <span class="tok-str">&quot;.0&quot;</span>)) {</span>
<span class="line" id="L856">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L857">                }</span>
<span class="line" id="L858">            }</span>
<span class="line" id="L859">        }</span>
<span class="line" id="L860"></span>
<span class="line" id="L861">        <span class="tok-comment">// Trimming &quot;-1.0&quot;.</span>
</span>
<span class="line" id="L862">        <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, lib_name, <span class="tok-str">&quot;-1.0&quot;</span>)) {</span>
<span class="line" id="L863">            <span class="tok-kw">const</span> trimmed_lib_name = lib_name[<span class="tok-number">0</span> .. lib_name.len - <span class="tok-str">&quot;-1.0&quot;</span>.len];</span>
<span class="line" id="L864">            <span class="tok-kw">for</span> (pkgs) |pkg| {</span>
<span class="line" id="L865">                <span class="tok-kw">if</span> (std.ascii.eqlIgnoreCase(pkg.name, trimmed_lib_name)) {</span>
<span class="line" id="L866">                    <span class="tok-kw">break</span> :match pkg.name;</span>
<span class="line" id="L867">                }</span>
<span class="line" id="L868">            }</span>
<span class="line" id="L869">        }</span>
<span class="line" id="L870"></span>
<span class="line" id="L871">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PackageNotFound;</span>
<span class="line" id="L872">    };</span>
<span class="line" id="L873"></span>
<span class="line" id="L874">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L875">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">if</span> (b.runAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{</span>
<span class="line" id="L876">        <span class="tok-str">&quot;pkg-config&quot;</span>,</span>
<span class="line" id="L877">        pkg_name,</span>
<span class="line" id="L878">        <span class="tok-str">&quot;--cflags&quot;</span>,</span>
<span class="line" id="L879">        <span class="tok-str">&quot;--libs&quot;</span>,</span>
<span class="line" id="L880">    }, &amp;code, .Ignore)) |stdout| stdout <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L881">        <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L882">        <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L883">        <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L884">        <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L885">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L886">    };</span>
<span class="line" id="L887"></span>
<span class="line" id="L888">    <span class="tok-kw">var</span> zig_args = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(b.allocator);</span>
<span class="line" id="L889">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L890"></span>
<span class="line" id="L891">    <span class="tok-kw">var</span> it = mem.tokenizeAny(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot; \r\n\t&quot;</span>);</span>
<span class="line" id="L892">    <span class="tok-kw">while</span> (it.next()) |tok| {</span>
<span class="line" id="L893">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L894">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L895">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-I&quot;</span>, dir });</span>
<span class="line" id="L896">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-I&quot;</span>)) {</span>
<span class="line" id="L897">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L898">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L899">            <span class="tok-kw">const</span> dir = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L900">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-L&quot;</span>, dir });</span>
<span class="line" id="L901">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-L&quot;</span>)) {</span>
<span class="line" id="L902">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L903">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L904">            <span class="tok-kw">const</span> lib = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L905">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-l&quot;</span>, lib });</span>
<span class="line" id="L906">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-l&quot;</span>)) {</span>
<span class="line" id="L907">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L908">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L909">            <span class="tok-kw">const</span> macro = it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput;</span>
<span class="line" id="L910">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-D&quot;</span>, macro });</span>
<span class="line" id="L911">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, tok, <span class="tok-str">&quot;-D&quot;</span>)) {</span>
<span class="line" id="L912">            <span class="tok-kw">try</span> zig_args.append(tok);</span>
<span class="line" id="L913">        } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (b.debug_pkg_config) {</span>
<span class="line" id="L914">            <span class="tok-kw">return</span> self.step.fail(<span class="tok-str">&quot;unknown pkg-config flag '{s}'&quot;</span>, .{tok});</span>
<span class="line" id="L915">        }</span>
<span class="line" id="L916">    }</span>
<span class="line" id="L917"></span>
<span class="line" id="L918">    <span class="tok-kw">return</span> zig_args.toOwnedSlice();</span>
<span class="line" id="L919">}</span>
<span class="line" id="L920"></span>
<span class="line" id="L921"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibrary</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L922">    self.linkSystemLibrary2(name, .{});</span>
<span class="line" id="L923">}</span>
<span class="line" id="L924"></span>
<span class="line" id="L925"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L926"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryNeeded</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L927">    <span class="tok-kw">return</span> linkSystemLibrary2(self, name, .{ .needed = <span class="tok-null">true</span> });</span>
<span class="line" id="L928">}</span>
<span class="line" id="L929"></span>
<span class="line" id="L930"><span class="tok-comment">/// deprecated: use linkSystemLibrary2</span></span>
<span class="line" id="L931"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibraryWeak</span>(self: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L932">    <span class="tok-kw">return</span> linkSystemLibrary2(self, name, .{ .weak = <span class="tok-null">true</span> });</span>
<span class="line" id="L933">}</span>
<span class="line" id="L934"></span>
<span class="line" id="L935"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkSystemLibraryOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L936">    needed: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L937">    weak: <span class="tok-type">bool</span> = <span class="tok-null">false</span>,</span>
<span class="line" id="L938">    use_pkg_config: SystemLib.UsePkgConfig = .yes,</span>
<span class="line" id="L939">    preferred_link_mode: std.builtin.LinkMode = .Dynamic,</span>
<span class="line" id="L940">    search_strategy: SystemLib.SearchStrategy = .paths_first,</span>
<span class="line" id="L941">};</span>
<span class="line" id="L942"></span>
<span class="line" id="L943"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">linkSystemLibrary2</span>(</span>
<span class="line" id="L944">    self: *Compile,</span>
<span class="line" id="L945">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L946">    options: LinkSystemLibraryOptions,</span>
<span class="line" id="L947">) <span class="tok-type">void</span> {</span>
<span class="line" id="L948">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L949">    <span class="tok-kw">if</span> (isLibCLibrary(name)) {</span>
<span class="line" id="L950">        self.linkLibC();</span>
<span class="line" id="L951">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L952">    }</span>
<span class="line" id="L953">    <span class="tok-kw">if</span> (isLibCppLibrary(name)) {</span>
<span class="line" id="L954">        self.linkLibCpp();</span>
<span class="line" id="L955">        <span class="tok-kw">return</span>;</span>
<span class="line" id="L956">    }</span>
<span class="line" id="L957"></span>
<span class="line" id="L958">    self.link_objects.append(.{</span>
<span class="line" id="L959">        .system_lib = .{</span>
<span class="line" id="L960">            .name = b.dupe(name),</span>
<span class="line" id="L961">            .needed = options.needed,</span>
<span class="line" id="L962">            .weak = options.weak,</span>
<span class="line" id="L963">            .use_pkg_config = options.use_pkg_config,</span>
<span class="line" id="L964">            .preferred_link_mode = options.preferred_link_mode,</span>
<span class="line" id="L965">            .search_strategy = options.search_strategy,</span>
<span class="line" id="L966">        },</span>
<span class="line" id="L967">    }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L968">}</span>
<span class="line" id="L969"></span>
<span class="line" id="L970"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AddCSourceFilesOptions = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L971">    <span class="tok-comment">/// When provided, `files` are relative to `dependency` rather than the package that owns the `Compile` step.</span></span>
<span class="line" id="L972">    dependency: ?*std.Build.Dependency = <span class="tok-null">null</span>,</span>
<span class="line" id="L973">    files: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L974">    flags: []<span class="tok-kw">const</span> []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = &amp;.{},</span>
<span class="line" id="L975">};</span>
<span class="line" id="L976"></span>
<span class="line" id="L977"><span class="tok-comment">/// Handy when you have many C/C++ source files and want them all to have the same flags.</span></span>
<span class="line" id="L978"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFiles</span>(self: *Compile, options: AddCSourceFilesOptions) <span class="tok-type">void</span> {</span>
<span class="line" id="L979">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L980">    <span class="tok-kw">const</span> c_source_files = b.allocator.create(CSourceFiles) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L981"></span>
<span class="line" id="L982">    <span class="tok-kw">const</span> files_copy = b.dupeStrings(options.files);</span>
<span class="line" id="L983">    <span class="tok-kw">const</span> flags_copy = b.dupeStrings(options.flags);</span>
<span class="line" id="L984"></span>
<span class="line" id="L985">    c_source_files.* = .{</span>
<span class="line" id="L986">        .dependency = options.dependency,</span>
<span class="line" id="L987">        .files = files_copy,</span>
<span class="line" id="L988">        .flags = flags_copy,</span>
<span class="line" id="L989">    };</span>
<span class="line" id="L990">    self.link_objects.append(.{ .c_source_files = c_source_files }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L991">}</span>
<span class="line" id="L992"></span>
<span class="line" id="L993"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addCSourceFile</span>(self: *Compile, source: CSourceFile) <span class="tok-type">void</span> {</span>
<span class="line" id="L994">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L995">    <span class="tok-kw">const</span> c_source_file = b.allocator.create(CSourceFile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L996">    c_source_file.* = source.dupe(b);</span>
<span class="line" id="L997">    self.link_objects.append(.{ .c_source_file = c_source_file }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L998">    source.file.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L999">}</span>
<span class="line" id="L1000"></span>
<span class="line" id="L1001"><span class="tok-comment">/// Resource files must have the extension `.rc`.</span></span>
<span class="line" id="L1002"><span class="tok-comment">/// Can be called regardless of target. The .rc file will be ignored</span></span>
<span class="line" id="L1003"><span class="tok-comment">/// if the target object format does not support embedded resources.</span></span>
<span class="line" id="L1004"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addWin32ResourceFile</span>(self: *Compile, source: RcSourceFile) <span class="tok-type">void</span> {</span>
<span class="line" id="L1005">    <span class="tok-comment">// Only the PE/COFF format has a Resource Table, so for any other target</span>
</span>
<span class="line" id="L1006">    <span class="tok-comment">// the resource file is just ignored.</span>
</span>
<span class="line" id="L1007">    <span class="tok-kw">if</span> (self.target.getObjectFormat() != .coff) <span class="tok-kw">return</span>;</span>
<span class="line" id="L1008"></span>
<span class="line" id="L1009">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1010">    <span class="tok-kw">const</span> rc_source_file = b.allocator.create(RcSourceFile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1011">    rc_source_file.* = source.dupe(b);</span>
<span class="line" id="L1012">    self.link_objects.append(.{ .win32_resource_file = rc_source_file }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1013">    source.file.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1014">}</span>
<span class="line" id="L1015"></span>
<span class="line" id="L1016"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseLink</span>(self: *Compile, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1017">    self.verbose_link = value;</span>
<span class="line" id="L1018">}</span>
<span class="line" id="L1019"></span>
<span class="line" id="L1020"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setVerboseCC</span>(self: *Compile, value: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1021">    self.verbose_cc = value;</span>
<span class="line" id="L1022">}</span>
<span class="line" id="L1023"></span>
<span class="line" id="L1024"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setLibCFile</span>(self: *Compile, libc_file: ?LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1025">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1026">    self.libc_file = <span class="tok-kw">if</span> (libc_file) |f| f.dupe(b) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L1027">}</span>
<span class="line" id="L1028"></span>
<span class="line" id="L1029"><span class="tok-kw">fn</span> <span class="tok-fn">getEmittedFileGeneric</span>(self: *Compile, output_file: *?*GeneratedFile) LazyPath {</span>
<span class="line" id="L1030">    <span class="tok-kw">if</span> (output_file.*) |g| {</span>
<span class="line" id="L1031">        <span class="tok-kw">return</span> .{ .generated = g };</span>
<span class="line" id="L1032">    }</span>
<span class="line" id="L1033">    <span class="tok-kw">const</span> arena = self.step.owner.allocator;</span>
<span class="line" id="L1034">    <span class="tok-kw">const</span> generated_file = arena.create(GeneratedFile) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1035">    generated_file.* = .{ .step = &amp;self.step };</span>
<span class="line" id="L1036">    output_file.* = generated_file;</span>
<span class="line" id="L1037">    <span class="tok-kw">return</span> .{ .generated = generated_file };</span>
<span class="line" id="L1038">}</span>
<span class="line" id="L1039"></span>
<span class="line" id="L1040"><span class="tok-comment">/// deprecated: use `getEmittedBinDirectory`</span></span>
<span class="line" id="L1041"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> getOutputDirectorySource = getEmittedBinDirectory;</span>
<span class="line" id="L1042"></span>
<span class="line" id="L1043"><span class="tok-comment">/// Returns the path to the directory that contains the emitted binary file.</span></span>
<span class="line" id="L1044"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedBinDirectory</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1045">    _ = self.getEmittedBin();</span>
<span class="line" id="L1046">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.emit_directory);</span>
<span class="line" id="L1047">}</span>
<span class="line" id="L1048"></span>
<span class="line" id="L1049"><span class="tok-comment">/// deprecated: use `getEmittedBin`</span></span>
<span class="line" id="L1050"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> getOutputSource = getEmittedBin;</span>
<span class="line" id="L1051"></span>
<span class="line" id="L1052"><span class="tok-comment">/// Returns the path to the generated executable, library or object file.</span></span>
<span class="line" id="L1053"><span class="tok-comment">/// To run an executable built with zig build, use `run`, or create an install step and invoke it.</span></span>
<span class="line" id="L1054"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedBin</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1055">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_bin);</span>
<span class="line" id="L1056">}</span>
<span class="line" id="L1057"></span>
<span class="line" id="L1058"><span class="tok-comment">/// deprecated: use `getEmittedImplib`</span></span>
<span class="line" id="L1059"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> getOutputLibSource = getEmittedImplib;</span>
<span class="line" id="L1060"></span>
<span class="line" id="L1061"><span class="tok-comment">/// Returns the path to the generated import library.</span></span>
<span class="line" id="L1062"><span class="tok-comment">/// This function can only be called for libraries.</span></span>
<span class="line" id="L1063"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedImplib</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1064">    assert(self.kind == .lib);</span>
<span class="line" id="L1065">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_implib);</span>
<span class="line" id="L1066">}</span>
<span class="line" id="L1067"></span>
<span class="line" id="L1068"><span class="tok-comment">/// deprecated: use `getEmittedH`</span></span>
<span class="line" id="L1069"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> getOutputHSource = getEmittedH;</span>
<span class="line" id="L1070"></span>
<span class="line" id="L1071"><span class="tok-comment">/// Returns the path to the generated header file.</span></span>
<span class="line" id="L1072"><span class="tok-comment">/// This function can only be called for libraries or objects.</span></span>
<span class="line" id="L1073"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedH</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1074">    assert(self.kind != .exe <span class="tok-kw">and</span> self.kind != .@&quot;test&quot;);</span>
<span class="line" id="L1075">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_h);</span>
<span class="line" id="L1076">}</span>
<span class="line" id="L1077"></span>
<span class="line" id="L1078"><span class="tok-comment">/// deprecated: use `getEmittedPdb`.</span></span>
<span class="line" id="L1079"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> getOutputPdbSource = getEmittedPdb;</span>
<span class="line" id="L1080"></span>
<span class="line" id="L1081"><span class="tok-comment">/// Returns the generated PDB file.</span></span>
<span class="line" id="L1082"><span class="tok-comment">/// If the compilation does not produce a PDB file, this causes a FileNotFound error</span></span>
<span class="line" id="L1083"><span class="tok-comment">/// at build time.</span></span>
<span class="line" id="L1084"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedPdb</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1085">    _ = self.getEmittedBin();</span>
<span class="line" id="L1086">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_pdb);</span>
<span class="line" id="L1087">}</span>
<span class="line" id="L1088"></span>
<span class="line" id="L1089"><span class="tok-comment">/// Returns the path to the generated documentation directory.</span></span>
<span class="line" id="L1090"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedDocs</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1091">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_docs);</span>
<span class="line" id="L1092">}</span>
<span class="line" id="L1093"></span>
<span class="line" id="L1094"><span class="tok-comment">/// Returns the path to the generated assembly code.</span></span>
<span class="line" id="L1095"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedAsm</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1096">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_asm);</span>
<span class="line" id="L1097">}</span>
<span class="line" id="L1098"></span>
<span class="line" id="L1099"><span class="tok-comment">/// Returns the path to the generated LLVM IR.</span></span>
<span class="line" id="L1100"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedLlvmIr</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1101">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_llvm_ir);</span>
<span class="line" id="L1102">}</span>
<span class="line" id="L1103"></span>
<span class="line" id="L1104"><span class="tok-comment">/// Returns the path to the generated LLVM BC.</span></span>
<span class="line" id="L1105"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">getEmittedLlvmBc</span>(self: *Compile) LazyPath {</span>
<span class="line" id="L1106">    <span class="tok-kw">return</span> self.getEmittedFileGeneric(&amp;self.generated_llvm_bc);</span>
<span class="line" id="L1107">}</span>
<span class="line" id="L1108"></span>
<span class="line" id="L1109"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAssemblyFile</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1110">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1111">    <span class="tok-kw">const</span> source_duped = source.dupe(b);</span>
<span class="line" id="L1112">    self.link_objects.append(.{ .assembly_file = source_duped }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1113">    source_duped.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1114">}</span>
<span class="line" id="L1115"></span>
<span class="line" id="L1116"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObjectFile</span>(self: *Compile, source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1117">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1118">    self.link_objects.append(.{ .static_path = source.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1119">    source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1120">}</span>
<span class="line" id="L1121"></span>
<span class="line" id="L1122"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addObject</span>(self: *Compile, obj: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L1123">    assert(obj.kind == .obj);</span>
<span class="line" id="L1124">    self.linkLibraryOrObject(obj);</span>
<span class="line" id="L1125">}</span>
<span class="line" id="L1126"></span>
<span class="line" id="L1127"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAfterIncludePath</span>(self: *Compile, path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1128">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1129">    self.include_dirs.append(IncludeDir{ .path_after = path.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1130">    path.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1131">}</span>
<span class="line" id="L1132"></span>
<span class="line" id="L1133"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemIncludePath</span>(self: *Compile, path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1134">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1135">    self.include_dirs.append(IncludeDir{ .path_system = path.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1136">    path.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1137">}</span>
<span class="line" id="L1138"></span>
<span class="line" id="L1139"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addIncludePath</span>(self: *Compile, path: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1140">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1141">    self.include_dirs.append(IncludeDir{ .path = path.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1142">    path.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1143">}</span>
<span class="line" id="L1144"></span>
<span class="line" id="L1145"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addConfigHeader</span>(self: *Compile, config_header: *Step.ConfigHeader) <span class="tok-type">void</span> {</span>
<span class="line" id="L1146">    self.step.dependOn(&amp;config_header.step);</span>
<span class="line" id="L1147">    self.include_dirs.append(.{ .config_header_step = config_header }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1148">}</span>
<span class="line" id="L1149"></span>
<span class="line" id="L1150"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addLibraryPath</span>(self: *Compile, directory_source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1151">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1152">    self.lib_paths.append(directory_source.dupe(b)) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1153">    directory_source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1154">}</span>
<span class="line" id="L1155"></span>
<span class="line" id="L1156"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addRPath</span>(self: *Compile, directory_source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1157">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1158">    self.rpaths.append(directory_source.dupe(b)) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1159">    directory_source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1160">}</span>
<span class="line" id="L1161"></span>
<span class="line" id="L1162"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addSystemFrameworkPath</span>(self: *Compile, directory_source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1163">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1164">    self.include_dirs.append(IncludeDir{ .framework_path_system = directory_source.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1165">    directory_source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1166">}</span>
<span class="line" id="L1167"></span>
<span class="line" id="L1168"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addFrameworkPath</span>(self: *Compile, directory_source: LazyPath) <span class="tok-type">void</span> {</span>
<span class="line" id="L1169">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1170">    self.include_dirs.append(IncludeDir{ .framework_path = directory_source.dupe(b) }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1171">    directory_source.addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1172">}</span>
<span class="line" id="L1173"></span>
<span class="line" id="L1174"><span class="tok-comment">/// Adds a module to be used with `@import` and exposing it in the current</span></span>
<span class="line" id="L1175"><span class="tok-comment">/// package's module table using `name`.</span></span>
<span class="line" id="L1176"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addModule</span>(cs: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, module: *Module) <span class="tok-type">void</span> {</span>
<span class="line" id="L1177">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L1178">    cs.modules.put(b.dupe(name), module) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1179"></span>
<span class="line" id="L1180">    <span class="tok-kw">var</span> done = std.AutoHashMap(*Module, <span class="tok-type">void</span>).init(b.allocator);</span>
<span class="line" id="L1181">    <span class="tok-kw">defer</span> done.deinit();</span>
<span class="line" id="L1182">    cs.addRecursiveBuildDeps(module, &amp;done) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1183">}</span>
<span class="line" id="L1184"></span>
<span class="line" id="L1185"><span class="tok-comment">/// Adds a module to be used with `@import` without exposing it in the current</span></span>
<span class="line" id="L1186"><span class="tok-comment">/// package's module table.</span></span>
<span class="line" id="L1187"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addAnonymousModule</span>(cs: *Compile, name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, options: std.Build.CreateModuleOptions) <span class="tok-type">void</span> {</span>
<span class="line" id="L1188">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L1189">    <span class="tok-kw">const</span> module = b.createModule(options);</span>
<span class="line" id="L1190">    <span class="tok-kw">return</span> addModule(cs, name, module);</span>
<span class="line" id="L1191">}</span>
<span class="line" id="L1192"></span>
<span class="line" id="L1193"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addOptions</span>(cs: *Compile, module_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, options: *Step.Options) <span class="tok-type">void</span> {</span>
<span class="line" id="L1194">    addModule(cs, module_name, options.createModule());</span>
<span class="line" id="L1195">}</span>
<span class="line" id="L1196"></span>
<span class="line" id="L1197"><span class="tok-kw">fn</span> <span class="tok-fn">addRecursiveBuildDeps</span>(cs: *Compile, module: *Module, done: *std.AutoHashMap(*Module, <span class="tok-type">void</span>)) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1198">    <span class="tok-kw">if</span> (done.contains(module)) <span class="tok-kw">return</span>;</span>
<span class="line" id="L1199">    <span class="tok-kw">try</span> done.put(module, {});</span>
<span class="line" id="L1200">    module.source_file.addStepDependencies(&amp;cs.step);</span>
<span class="line" id="L1201">    <span class="tok-kw">for</span> (module.dependencies.values()) |dep| {</span>
<span class="line" id="L1202">        <span class="tok-kw">try</span> cs.addRecursiveBuildDeps(dep, done);</span>
<span class="line" id="L1203">    }</span>
<span class="line" id="L1204">}</span>
<span class="line" id="L1205"></span>
<span class="line" id="L1206"><span class="tok-comment">/// If Vcpkg was found on the system, it will be added to include and lib</span></span>
<span class="line" id="L1207"><span class="tok-comment">/// paths for the specified target.</span></span>
<span class="line" id="L1208"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addVcpkgPaths</span>(self: *Compile, linkage: Compile.Linkage) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1209">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1210">    <span class="tok-comment">// Ideally in the Unattempted case we would call the function recursively</span>
</span>
<span class="line" id="L1211">    <span class="tok-comment">// after findVcpkgRoot and have only one switch statement, but the compiler</span>
</span>
<span class="line" id="L1212">    <span class="tok-comment">// cannot resolve the error set.</span>
</span>
<span class="line" id="L1213">    <span class="tok-kw">switch</span> (b.vcpkg_root) {</span>
<span class="line" id="L1214">        .unattempted =&gt; {</span>
<span class="line" id="L1215">            b.vcpkg_root = <span class="tok-kw">if</span> (<span class="tok-kw">try</span> findVcpkgRoot(b.allocator)) |root|</span>
<span class="line" id="L1216">                VcpkgRoot{ .found = root }</span>
<span class="line" id="L1217">            <span class="tok-kw">else</span></span>
<span class="line" id="L1218">                .not_found;</span>
<span class="line" id="L1219">        },</span>
<span class="line" id="L1220">        .not_found =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.VcpkgNotFound,</span>
<span class="line" id="L1221">        .found =&gt; {},</span>
<span class="line" id="L1222">    }</span>
<span class="line" id="L1223"></span>
<span class="line" id="L1224">    <span class="tok-kw">switch</span> (b.vcpkg_root) {</span>
<span class="line" id="L1225">        .unattempted =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1226">        .not_found =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.VcpkgNotFound,</span>
<span class="line" id="L1227">        .found =&gt; |root| {</span>
<span class="line" id="L1228">            <span class="tok-kw">const</span> allocator = b.allocator;</span>
<span class="line" id="L1229">            <span class="tok-kw">const</span> triplet = <span class="tok-kw">try</span> self.target.vcpkgTriplet(allocator, <span class="tok-kw">if</span> (linkage == .static) .Static <span class="tok-kw">else</span> .Dynamic);</span>
<span class="line" id="L1230">            <span class="tok-kw">defer</span> b.allocator.free(triplet);</span>
<span class="line" id="L1231"></span>
<span class="line" id="L1232">            <span class="tok-kw">const</span> include_path = b.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;include&quot;</span> });</span>
<span class="line" id="L1233">            <span class="tok-kw">errdefer</span> allocator.free(include_path);</span>
<span class="line" id="L1234">            <span class="tok-kw">try</span> self.include_dirs.append(IncludeDir{ .path = .{ .path = include_path } });</span>
<span class="line" id="L1235"></span>
<span class="line" id="L1236">            <span class="tok-kw">const</span> lib_path = b.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;lib&quot;</span> });</span>
<span class="line" id="L1237">            <span class="tok-kw">try</span> self.lib_paths.append(.{ .path = lib_path });</span>
<span class="line" id="L1238"></span>
<span class="line" id="L1239">            self.vcpkg_bin_path = b.pathJoin(&amp;.{ root, <span class="tok-str">&quot;installed&quot;</span>, triplet, <span class="tok-str">&quot;bin&quot;</span> });</span>
<span class="line" id="L1240">        },</span>
<span class="line" id="L1241">    }</span>
<span class="line" id="L1242">}</span>
<span class="line" id="L1243"></span>
<span class="line" id="L1244"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setExecCmd</span>(self: *Compile, args: []<span class="tok-kw">const</span> ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1245">    <span class="tok-kw">const</span> b = self.step.owner;</span>
<span class="line" id="L1246">    assert(self.kind == .@&quot;test&quot;);</span>
<span class="line" id="L1247">    <span class="tok-kw">const</span> duped_args = b.allocator.alloc(?[]<span class="tok-type">u8</span>, args.len) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1248">    <span class="tok-kw">for</span> (args, <span class="tok-number">0</span>..) |arg, i| {</span>
<span class="line" id="L1249">        duped_args[i] = <span class="tok-kw">if</span> (arg) |a| b.dupe(a) <span class="tok-kw">else</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L1250">    }</span>
<span class="line" id="L1251">    self.exec_cmd_args = duped_args;</span>
<span class="line" id="L1252">}</span>
<span class="line" id="L1253"></span>
<span class="line" id="L1254"><span class="tok-kw">fn</span> <span class="tok-fn">linkLibraryOrObject</span>(self: *Compile, other: *Compile) <span class="tok-type">void</span> {</span>
<span class="line" id="L1255">    other.getEmittedBin().addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1256">    <span class="tok-kw">if</span> (other.target.isWindows() <span class="tok-kw">and</span> other.isDynamicLibrary()) {</span>
<span class="line" id="L1257">        other.getEmittedImplib().addStepDependencies(&amp;self.step);</span>
<span class="line" id="L1258">    }</span>
<span class="line" id="L1259"></span>
<span class="line" id="L1260">    self.link_objects.append(.{ .other_step = other }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1261">    self.include_dirs.append(.{ .other_step = other }) <span class="tok-kw">catch</span> <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;OOM&quot;</span>);</span>
<span class="line" id="L1262"></span>
<span class="line" id="L1263">    <span class="tok-kw">for</span> (other.installed_headers.items) |install_step| {</span>
<span class="line" id="L1264">        self.step.dependOn(install_step);</span>
<span class="line" id="L1265">    }</span>
<span class="line" id="L1266">}</span>
<span class="line" id="L1267"></span>
<span class="line" id="L1268"><span class="tok-kw">fn</span> <span class="tok-fn">appendModuleArgs</span>(</span>
<span class="line" id="L1269">    cs: *Compile,</span>
<span class="line" id="L1270">    zig_args: *ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L1271">) <span class="tok-kw">error</span>{OutOfMemory}!<span class="tok-type">void</span> {</span>
<span class="line" id="L1272">    <span class="tok-kw">const</span> b = cs.step.owner;</span>
<span class="line" id="L1273">    <span class="tok-comment">// First, traverse the whole dependency graph and give every module a unique name, ideally one</span>
</span>
<span class="line" id="L1274">    <span class="tok-comment">// named after what it's called somewhere in the graph. It will help here to have both a mapping</span>
</span>
<span class="line" id="L1275">    <span class="tok-comment">// from module to name and a set of all the currently-used names.</span>
</span>
<span class="line" id="L1276">    <span class="tok-kw">var</span> mod_names = std.AutoHashMap(*Module, []<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(b.allocator);</span>
<span class="line" id="L1277">    <span class="tok-kw">var</span> names = std.StringHashMap(<span class="tok-type">void</span>).init(b.allocator);</span>
<span class="line" id="L1278"></span>
<span class="line" id="L1279">    <span class="tok-kw">var</span> to_name = std.ArrayList(<span class="tok-kw">struct</span> {</span>
<span class="line" id="L1280">        name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1281">        mod: *Module,</span>
<span class="line" id="L1282">    }).init(b.allocator);</span>
<span class="line" id="L1283">    {</span>
<span class="line" id="L1284">        <span class="tok-kw">var</span> it = cs.modules.iterator();</span>
<span class="line" id="L1285">        <span class="tok-kw">while</span> (it.next()) |kv| {</span>
<span class="line" id="L1286">            <span class="tok-comment">// While we're traversing the root dependencies, let's make sure that no module names</span>
</span>
<span class="line" id="L1287">            <span class="tok-comment">// have colons in them, since the CLI forbids it. We handle this for transitive</span>
</span>
<span class="line" id="L1288">            <span class="tok-comment">// dependencies further down.</span>
</span>
<span class="line" id="L1289">            <span class="tok-kw">if</span> (std.mem.indexOfScalar(<span class="tok-type">u8</span>, kv.key_ptr.*, <span class="tok-str">':'</span>) != <span class="tok-null">null</span>) {</span>
<span class="line" id="L1290">                <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Module names cannot contain colons&quot;</span>);</span>
<span class="line" id="L1291">            }</span>
<span class="line" id="L1292">            <span class="tok-kw">try</span> to_name.append(.{</span>
<span class="line" id="L1293">                .name = kv.key_ptr.*,</span>
<span class="line" id="L1294">                .mod = kv.value_ptr.*,</span>
<span class="line" id="L1295">            });</span>
<span class="line" id="L1296">        }</span>
<span class="line" id="L1297">    }</span>
<span class="line" id="L1298"></span>
<span class="line" id="L1299">    <span class="tok-kw">while</span> (to_name.popOrNull()) |dep| {</span>
<span class="line" id="L1300">        <span class="tok-kw">if</span> (mod_names.contains(dep.mod)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1301"></span>
<span class="line" id="L1302">        <span class="tok-comment">// We'll use this buffer to store the name we decide on</span>
</span>
<span class="line" id="L1303">        <span class="tok-kw">var</span> buf = <span class="tok-kw">try</span> b.allocator.alloc(<span class="tok-type">u8</span>, dep.name.len + <span class="tok-number">32</span>);</span>
<span class="line" id="L1304">        <span class="tok-comment">// First, try just the exposed dependency name</span>
</span>
<span class="line" id="L1305">        <span class="tok-builtin">@memcpy</span>(buf[<span class="tok-number">0</span>..dep.name.len], dep.name);</span>
<span class="line" id="L1306">        <span class="tok-kw">var</span> name = buf[<span class="tok-number">0</span>..dep.name.len];</span>
<span class="line" id="L1307">        <span class="tok-kw">var</span> n: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1308">        <span class="tok-kw">while</span> (names.contains(name)) {</span>
<span class="line" id="L1309">            <span class="tok-comment">// If that failed, append an incrementing number to the end</span>
</span>
<span class="line" id="L1310">            name = std.fmt.bufPrint(buf, <span class="tok-str">&quot;{s}{}&quot;</span>, .{ dep.name, n }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1311">            n += <span class="tok-number">1</span>;</span>
<span class="line" id="L1312">        }</span>
<span class="line" id="L1313"></span>
<span class="line" id="L1314">        <span class="tok-kw">try</span> mod_names.put(dep.mod, name);</span>
<span class="line" id="L1315">        <span class="tok-kw">try</span> names.put(name, {});</span>
<span class="line" id="L1316"></span>
<span class="line" id="L1317">        <span class="tok-kw">var</span> it = dep.mod.dependencies.iterator();</span>
<span class="line" id="L1318">        <span class="tok-kw">while</span> (it.next()) |kv| {</span>
<span class="line" id="L1319">            <span class="tok-comment">// Same colon-in-name check as above, but for transitive dependencies.</span>
</span>
<span class="line" id="L1320">            <span class="tok-kw">if</span> (std.mem.indexOfScalar(<span class="tok-type">u8</span>, kv.key_ptr.*, <span class="tok-str">':'</span>) != <span class="tok-null">null</span>) {</span>
<span class="line" id="L1321">                <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Module names cannot contain colons&quot;</span>);</span>
<span class="line" id="L1322">            }</span>
<span class="line" id="L1323">            <span class="tok-kw">try</span> to_name.append(.{</span>
<span class="line" id="L1324">                .name = kv.key_ptr.*,</span>
<span class="line" id="L1325">                .mod = kv.value_ptr.*,</span>
<span class="line" id="L1326">            });</span>
<span class="line" id="L1327">        }</span>
<span class="line" id="L1328">    }</span>
<span class="line" id="L1329"></span>
<span class="line" id="L1330">    <span class="tok-comment">// Since the module names given to the CLI are based off of the exposed names, we already know</span>
</span>
<span class="line" id="L1331">    <span class="tok-comment">// that none of the CLI names have colons in them, so there's no need to check that explicitly.</span>
</span>
<span class="line" id="L1332"></span>
<span class="line" id="L1333">    <span class="tok-comment">// Every module in the graph is now named; output their definitions</span>
</span>
<span class="line" id="L1334">    {</span>
<span class="line" id="L1335">        <span class="tok-kw">var</span> it = mod_names.iterator();</span>
<span class="line" id="L1336">        <span class="tok-kw">while</span> (it.next()) |kv| {</span>
<span class="line" id="L1337">            <span class="tok-kw">const</span> mod = kv.key_ptr.*;</span>
<span class="line" id="L1338">            <span class="tok-kw">const</span> name = kv.value_ptr.*;</span>
<span class="line" id="L1339"></span>
<span class="line" id="L1340">            <span class="tok-kw">const</span> deps_str = <span class="tok-kw">try</span> constructDepString(b.allocator, mod_names, mod.dependencies);</span>
<span class="line" id="L1341">            <span class="tok-kw">const</span> src = mod.source_file.getPath(mod.builder);</span>
<span class="line" id="L1342">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--mod&quot;</span>);</span>
<span class="line" id="L1343">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;{s}:{s}:{s}&quot;</span>, .{ name, deps_str, src }));</span>
<span class="line" id="L1344">        }</span>
<span class="line" id="L1345">    }</span>
<span class="line" id="L1346"></span>
<span class="line" id="L1347">    <span class="tok-comment">// Lastly, output the root dependencies</span>
</span>
<span class="line" id="L1348">    <span class="tok-kw">const</span> deps_str = <span class="tok-kw">try</span> constructDepString(b.allocator, mod_names, cs.modules);</span>
<span class="line" id="L1349">    <span class="tok-kw">if</span> (deps_str.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1350">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--deps&quot;</span>);</span>
<span class="line" id="L1351">        <span class="tok-kw">try</span> zig_args.append(deps_str);</span>
<span class="line" id="L1352">    }</span>
<span class="line" id="L1353">}</span>
<span class="line" id="L1354"></span>
<span class="line" id="L1355"><span class="tok-kw">fn</span> <span class="tok-fn">constructDepString</span>(</span>
<span class="line" id="L1356">    allocator: std.mem.Allocator,</span>
<span class="line" id="L1357">    mod_names: std.AutoHashMap(*Module, []<span class="tok-kw">const</span> <span class="tok-type">u8</span>),</span>
<span class="line" id="L1358">    deps: std.StringArrayHashMap(*Module),</span>
<span class="line" id="L1359">) ![]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L1360">    <span class="tok-kw">var</span> deps_str = std.ArrayList(<span class="tok-type">u8</span>).init(allocator);</span>
<span class="line" id="L1361">    <span class="tok-kw">var</span> it = deps.iterator();</span>
<span class="line" id="L1362">    <span class="tok-kw">while</span> (it.next()) |kv| {</span>
<span class="line" id="L1363">        <span class="tok-kw">const</span> expose = kv.key_ptr.*;</span>
<span class="line" id="L1364">        <span class="tok-kw">const</span> name = mod_names.get(kv.value_ptr.*).?;</span>
<span class="line" id="L1365">        <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, expose, name)) {</span>
<span class="line" id="L1366">            <span class="tok-kw">try</span> deps_str.writer().print(<span class="tok-str">&quot;{s},&quot;</span>, .{name});</span>
<span class="line" id="L1367">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1368">            <span class="tok-kw">try</span> deps_str.writer().print(<span class="tok-str">&quot;{s}={s},&quot;</span>, .{ expose, name });</span>
<span class="line" id="L1369">        }</span>
<span class="line" id="L1370">    }</span>
<span class="line" id="L1371">    <span class="tok-kw">if</span> (deps_str.items.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1372">        <span class="tok-kw">return</span> deps_str.items[<span class="tok-number">0</span> .. deps_str.items.len - <span class="tok-number">1</span>]; <span class="tok-comment">// omit trailing comma</span>
</span>
<span class="line" id="L1373">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1374">        <span class="tok-kw">return</span> <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L1375">    }</span>
<span class="line" id="L1376">}</span>
<span class="line" id="L1377"></span>
<span class="line" id="L1378"><span class="tok-kw">fn</span> <span class="tok-fn">getGeneratedFilePath</span>(self: *Compile, <span class="tok-kw">comptime</span> tag_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, asking_step: ?*Step) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L1379">    <span class="tok-kw">const</span> maybe_path: ?*GeneratedFile = <span class="tok-builtin">@field</span>(self, tag_name);</span>
<span class="line" id="L1380"></span>
<span class="line" id="L1381">    <span class="tok-kw">const</span> generated_file = maybe_path <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L1382">        std.debug.getStderrMutex().lock();</span>
<span class="line" id="L1383">        <span class="tok-kw">const</span> stderr = std.io.getStdErr();</span>
<span class="line" id="L1384"></span>
<span class="line" id="L1385">        std.Build.dumpBadGetPathHelp(&amp;self.step, stderr, self.step.owner, asking_step) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L1386"></span>
<span class="line" id="L1387">        <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;missing emit option for &quot;</span> ++ tag_name);</span>
<span class="line" id="L1388">    };</span>
<span class="line" id="L1389"></span>
<span class="line" id="L1390">    <span class="tok-kw">const</span> path = generated_file.path <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L1391">        std.debug.getStderrMutex().lock();</span>
<span class="line" id="L1392">        <span class="tok-kw">const</span> stderr = std.io.getStdErr();</span>
<span class="line" id="L1393"></span>
<span class="line" id="L1394">        std.Build.dumpBadGetPathHelp(&amp;self.step, stderr, self.step.owner, asking_step) <span class="tok-kw">catch</span> {};</span>
<span class="line" id="L1395"></span>
<span class="line" id="L1396">        <span class="tok-builtin">@panic</span>(tag_name ++ <span class="tok-str">&quot; is null. Is there a missing step dependency?&quot;</span>);</span>
<span class="line" id="L1397">    };</span>
<span class="line" id="L1398"></span>
<span class="line" id="L1399">    <span class="tok-kw">return</span> path;</span>
<span class="line" id="L1400">}</span>
<span class="line" id="L1401"></span>
<span class="line" id="L1402"><span class="tok-kw">fn</span> <span class="tok-fn">make</span>(step: *Step, prog_node: *std.Progress.Node) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1403">    <span class="tok-kw">const</span> b = step.owner;</span>
<span class="line" id="L1404">    <span class="tok-kw">const</span> self = <span class="tok-builtin">@fieldParentPtr</span>(Compile, <span class="tok-str">&quot;step&quot;</span>, step);</span>
<span class="line" id="L1405"></span>
<span class="line" id="L1406">    <span class="tok-kw">if</span> (self.root_src == <span class="tok-null">null</span> <span class="tok-kw">and</span> self.link_objects.items.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1407">        <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;the linker needs one or more objects to link&quot;</span>, .{});</span>
<span class="line" id="L1408">    }</span>
<span class="line" id="L1409"></span>
<span class="line" id="L1410">    <span class="tok-kw">var</span> zig_args = ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).init(b.allocator);</span>
<span class="line" id="L1411">    <span class="tok-kw">defer</span> zig_args.deinit();</span>
<span class="line" id="L1412"></span>
<span class="line" id="L1413">    <span class="tok-kw">try</span> zig_args.append(b.zig_exe);</span>
<span class="line" id="L1414"></span>
<span class="line" id="L1415">    <span class="tok-kw">const</span> cmd = <span class="tok-kw">switch</span> (self.kind) {</span>
<span class="line" id="L1416">        .lib =&gt; <span class="tok-str">&quot;build-lib&quot;</span>,</span>
<span class="line" id="L1417">        .exe =&gt; <span class="tok-str">&quot;build-exe&quot;</span>,</span>
<span class="line" id="L1418">        .obj =&gt; <span class="tok-str">&quot;build-obj&quot;</span>,</span>
<span class="line" id="L1419">        .@&quot;test&quot; =&gt; <span class="tok-str">&quot;test&quot;</span>,</span>
<span class="line" id="L1420">    };</span>
<span class="line" id="L1421">    <span class="tok-kw">try</span> zig_args.append(cmd);</span>
<span class="line" id="L1422"></span>
<span class="line" id="L1423">    <span class="tok-kw">if</span> (b.reference_trace) |some| {</span>
<span class="line" id="L1424">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;-freference-trace={d}&quot;</span>, .{some}));</span>
<span class="line" id="L1425">    }</span>
<span class="line" id="L1426"></span>
<span class="line" id="L1427">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;llvm&quot;</span>, self.use_llvm);</span>
<span class="line" id="L1428">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;lld&quot;</span>, self.use_lld);</span>
<span class="line" id="L1429"></span>
<span class="line" id="L1430">    <span class="tok-kw">if</span> (self.target.ofmt) |ofmt| {</span>
<span class="line" id="L1431">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;-ofmt={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(ofmt)}));</span>
<span class="line" id="L1432">    }</span>
<span class="line" id="L1433"></span>
<span class="line" id="L1434">    <span class="tok-kw">switch</span> (self.entry) {</span>
<span class="line" id="L1435">        .default =&gt; {},</span>
<span class="line" id="L1436">        .disabled =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-entry&quot;</span>),</span>
<span class="line" id="L1437">        .enabled =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fentry&quot;</span>),</span>
<span class="line" id="L1438">        .symbol_name =&gt; |entry_name| {</span>
<span class="line" id="L1439">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;-fentry={s}&quot;</span>, .{entry_name}));</span>
<span class="line" id="L1440">        },</span>
<span class="line" id="L1441">    }</span>
<span class="line" id="L1442"></span>
<span class="line" id="L1443">    {</span>
<span class="line" id="L1444">        <span class="tok-kw">var</span> it = self.force_undefined_symbols.keyIterator();</span>
<span class="line" id="L1445">        <span class="tok-kw">while</span> (it.next()) |symbol_name| {</span>
<span class="line" id="L1446">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--force_undefined&quot;</span>);</span>
<span class="line" id="L1447">            <span class="tok-kw">try</span> zig_args.append(symbol_name.*);</span>
<span class="line" id="L1448">        }</span>
<span class="line" id="L1449">    }</span>
<span class="line" id="L1450"></span>
<span class="line" id="L1451">    <span class="tok-kw">if</span> (self.stack_size) |stack_size| {</span>
<span class="line" id="L1452">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--stack&quot;</span>);</span>
<span class="line" id="L1453">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;{}&quot;</span>, .{stack_size}));</span>
<span class="line" id="L1454">    }</span>
<span class="line" id="L1455"></span>
<span class="line" id="L1456">    <span class="tok-kw">if</span> (self.root_src) |root_src| <span class="tok-kw">try</span> zig_args.append(root_src.getPath(b));</span>
<span class="line" id="L1457"></span>
<span class="line" id="L1458">    <span class="tok-comment">// We will add link objects from transitive dependencies, but we want to keep</span>
</span>
<span class="line" id="L1459">    <span class="tok-comment">// all link objects in the same order provided.</span>
</span>
<span class="line" id="L1460">    <span class="tok-comment">// This array is used to keep self.link_objects immutable.</span>
</span>
<span class="line" id="L1461">    <span class="tok-kw">var</span> transitive_deps: TransitiveDeps = .{</span>
<span class="line" id="L1462">        .link_objects = ArrayList(LinkObject).init(b.allocator),</span>
<span class="line" id="L1463">        .seen_system_libs = StringHashMap(<span class="tok-type">void</span>).init(b.allocator),</span>
<span class="line" id="L1464">        .seen_steps = std.AutoHashMap(*<span class="tok-kw">const</span> Step, <span class="tok-type">void</span>).init(b.allocator),</span>
<span class="line" id="L1465">        .is_linking_libcpp = self.is_linking_libcpp,</span>
<span class="line" id="L1466">        .is_linking_libc = self.is_linking_libc,</span>
<span class="line" id="L1467">        .frameworks = &amp;self.frameworks,</span>
<span class="line" id="L1468">    };</span>
<span class="line" id="L1469"></span>
<span class="line" id="L1470">    <span class="tok-kw">try</span> transitive_deps.seen_steps.put(&amp;self.step, {});</span>
<span class="line" id="L1471">    <span class="tok-kw">try</span> transitive_deps.add(self.link_objects.items);</span>
<span class="line" id="L1472"></span>
<span class="line" id="L1473">    <span class="tok-kw">var</span> prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1474">    <span class="tok-kw">var</span> prev_has_rcflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1475">    <span class="tok-kw">var</span> prev_search_strategy: SystemLib.SearchStrategy = .paths_first;</span>
<span class="line" id="L1476">    <span class="tok-kw">var</span> prev_preferred_link_mode: std.builtin.LinkMode = .Dynamic;</span>
<span class="line" id="L1477"></span>
<span class="line" id="L1478">    <span class="tok-kw">for</span> (transitive_deps.link_objects.items) |link_object| {</span>
<span class="line" id="L1479">        <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L1480">            .static_path =&gt; |static_path| <span class="tok-kw">try</span> zig_args.append(static_path.getPath(b)),</span>
<span class="line" id="L1481"></span>
<span class="line" id="L1482">            .other_step =&gt; |other| <span class="tok-kw">switch</span> (other.kind) {</span>
<span class="line" id="L1483">                .exe =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Cannot link with an executable build artifact&quot;</span>),</span>
<span class="line" id="L1484">                .@&quot;test&quot; =&gt; <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Cannot link with a test&quot;</span>),</span>
<span class="line" id="L1485">                .obj =&gt; {</span>
<span class="line" id="L1486">                    <span class="tok-kw">try</span> zig_args.append(other.getEmittedBin().getPath(b));</span>
<span class="line" id="L1487">                },</span>
<span class="line" id="L1488">                .lib =&gt; l: {</span>
<span class="line" id="L1489">                    <span class="tok-kw">if</span> (self.isStaticLibrary() <span class="tok-kw">and</span> other.isStaticLibrary()) {</span>
<span class="line" id="L1490">                        <span class="tok-comment">// Avoid putting a static library inside a static library.</span>
</span>
<span class="line" id="L1491">                        <span class="tok-kw">break</span> :l;</span>
<span class="line" id="L1492">                    }</span>
<span class="line" id="L1493"></span>
<span class="line" id="L1494">                    <span class="tok-comment">// For DLLs, we gotta link against the implib. For</span>
</span>
<span class="line" id="L1495">                    <span class="tok-comment">// everything else, we directly link against the library file.</span>
</span>
<span class="line" id="L1496">                    <span class="tok-kw">const</span> full_path_lib = <span class="tok-kw">if</span> (other.producesImplib())</span>
<span class="line" id="L1497">                        other.getGeneratedFilePath(<span class="tok-str">&quot;generated_implib&quot;</span>, &amp;self.step)</span>
<span class="line" id="L1498">                    <span class="tok-kw">else</span></span>
<span class="line" id="L1499">                        other.getGeneratedFilePath(<span class="tok-str">&quot;generated_bin&quot;</span>, &amp;self.step);</span>
<span class="line" id="L1500">                    <span class="tok-kw">try</span> zig_args.append(full_path_lib);</span>
<span class="line" id="L1501"></span>
<span class="line" id="L1502">                    <span class="tok-kw">if</span> (other.linkage == Linkage.dynamic <span class="tok-kw">and</span> !self.target.isWindows()) {</span>
<span class="line" id="L1503">                        <span class="tok-kw">if</span> (fs.path.dirname(full_path_lib)) |dirname| {</span>
<span class="line" id="L1504">                            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rpath&quot;</span>);</span>
<span class="line" id="L1505">                            <span class="tok-kw">try</span> zig_args.append(dirname);</span>
<span class="line" id="L1506">                        }</span>
<span class="line" id="L1507">                    }</span>
<span class="line" id="L1508">                },</span>
<span class="line" id="L1509">            },</span>
<span class="line" id="L1510"></span>
<span class="line" id="L1511">            .system_lib =&gt; |system_lib| {</span>
<span class="line" id="L1512">                <span class="tok-kw">if</span> ((system_lib.search_strategy != prev_search_strategy <span class="tok-kw">or</span></span>
<span class="line" id="L1513">                    system_lib.preferred_link_mode != prev_preferred_link_mode) <span class="tok-kw">and</span></span>
<span class="line" id="L1514">                    self.linkage != .static)</span>
<span class="line" id="L1515">                {</span>
<span class="line" id="L1516">                    <span class="tok-kw">switch</span> (system_lib.search_strategy) {</span>
<span class="line" id="L1517">                        .no_fallback =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1518">                            .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_dylibs_only&quot;</span>),</span>
<span class="line" id="L1519">                            .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_static_only&quot;</span>),</span>
<span class="line" id="L1520">                        },</span>
<span class="line" id="L1521">                        .paths_first =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1522">                            .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_paths_first&quot;</span>),</span>
<span class="line" id="L1523">                            .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_paths_first_static&quot;</span>),</span>
<span class="line" id="L1524">                        },</span>
<span class="line" id="L1525">                        .mode_first =&gt; <span class="tok-kw">switch</span> (system_lib.preferred_link_mode) {</span>
<span class="line" id="L1526">                            .Dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_dylibs_first&quot;</span>),</span>
<span class="line" id="L1527">                            .Static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-search_static_first&quot;</span>),</span>
<span class="line" id="L1528">                        },</span>
<span class="line" id="L1529">                    }</span>
<span class="line" id="L1530">                    prev_search_strategy = system_lib.search_strategy;</span>
<span class="line" id="L1531">                    prev_preferred_link_mode = system_lib.preferred_link_mode;</span>
<span class="line" id="L1532">                }</span>
<span class="line" id="L1533"></span>
<span class="line" id="L1534">                <span class="tok-kw">const</span> prefix: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> = prefix: {</span>
<span class="line" id="L1535">                    <span class="tok-kw">if</span> (system_lib.needed) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-needed-l&quot;</span>;</span>
<span class="line" id="L1536">                    <span class="tok-kw">if</span> (system_lib.weak) <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-weak-l&quot;</span>;</span>
<span class="line" id="L1537">                    <span class="tok-kw">break</span> :prefix <span class="tok-str">&quot;-l&quot;</span>;</span>
<span class="line" id="L1538">                };</span>
<span class="line" id="L1539">                <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1540">                    .no =&gt; <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{ prefix, system_lib.name })),</span>
<span class="line" id="L1541">                    .yes, .force =&gt; {</span>
<span class="line" id="L1542">                        <span class="tok-kw">if</span> (self.runPkgConfig(system_lib.name)) |args| {</span>
<span class="line" id="L1543">                            <span class="tok-kw">try</span> zig_args.appendSlice(args);</span>
<span class="line" id="L1544">                        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L1545">                            <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L1546">                            <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L1547">                            <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L1548">                            <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L1549">                            <span class="tok-kw">error</span>.PackageNotFound,</span>
<span class="line" id="L1550">                            =&gt; <span class="tok-kw">switch</span> (system_lib.use_pkg_config) {</span>
<span class="line" id="L1551">                                .yes =&gt; {</span>
<span class="line" id="L1552">                                    <span class="tok-comment">// pkg-config failed, so fall back to linking the library</span>
</span>
<span class="line" id="L1553">                                    <span class="tok-comment">// by name directly.</span>
</span>
<span class="line" id="L1554">                                    <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1555">                                        prefix,</span>
<span class="line" id="L1556">                                        system_lib.name,</span>
<span class="line" id="L1557">                                    }));</span>
<span class="line" id="L1558">                                },</span>
<span class="line" id="L1559">                                .force =&gt; {</span>
<span class="line" id="L1560">                                    panic(<span class="tok-str">&quot;pkg-config failed for library {s}&quot;</span>, .{system_lib.name});</span>
<span class="line" id="L1561">                                },</span>
<span class="line" id="L1562">                                .no =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1563">                            },</span>
<span class="line" id="L1564"></span>
<span class="line" id="L1565">                            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L1566">                        }</span>
<span class="line" id="L1567">                    },</span>
<span class="line" id="L1568">                }</span>
<span class="line" id="L1569">            },</span>
<span class="line" id="L1570"></span>
<span class="line" id="L1571">            .assembly_file =&gt; |asm_file| {</span>
<span class="line" id="L1572">                <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1573">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1574">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1575">                    prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1576">                }</span>
<span class="line" id="L1577">                <span class="tok-kw">try</span> zig_args.append(asm_file.getPath(b));</span>
<span class="line" id="L1578">            },</span>
<span class="line" id="L1579"></span>
<span class="line" id="L1580">            .c_source_file =&gt; |c_source_file| {</span>
<span class="line" id="L1581">                <span class="tok-kw">if</span> (c_source_file.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1582">                    <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1583">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1584">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1585">                        prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1586">                    }</span>
<span class="line" id="L1587">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1588">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1589">                    <span class="tok-kw">for</span> (c_source_file.flags) |arg| {</span>
<span class="line" id="L1590">                        <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1591">                    }</span>
<span class="line" id="L1592">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1593">                    prev_has_cflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1594">                }</span>
<span class="line" id="L1595">                <span class="tok-kw">try</span> zig_args.append(c_source_file.file.getPath(b));</span>
<span class="line" id="L1596">            },</span>
<span class="line" id="L1597"></span>
<span class="line" id="L1598">            .c_source_files =&gt; |c_source_files| {</span>
<span class="line" id="L1599">                <span class="tok-kw">if</span> (c_source_files.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1600">                    <span class="tok-kw">if</span> (prev_has_cflags) {</span>
<span class="line" id="L1601">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1602">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1603">                        prev_has_cflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1604">                    }</span>
<span class="line" id="L1605">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1606">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-cflags&quot;</span>);</span>
<span class="line" id="L1607">                    <span class="tok-kw">for</span> (c_source_files.flags) |flag| {</span>
<span class="line" id="L1608">                        <span class="tok-kw">try</span> zig_args.append(flag);</span>
<span class="line" id="L1609">                    }</span>
<span class="line" id="L1610">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1611">                    prev_has_cflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1612">                }</span>
<span class="line" id="L1613">                <span class="tok-kw">if</span> (c_source_files.dependency) |dep| {</span>
<span class="line" id="L1614">                    <span class="tok-kw">for</span> (c_source_files.files) |file| {</span>
<span class="line" id="L1615">                        <span class="tok-kw">try</span> zig_args.append(dep.builder.pathFromRoot(file));</span>
<span class="line" id="L1616">                    }</span>
<span class="line" id="L1617">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1618">                    <span class="tok-kw">for</span> (c_source_files.files) |file| {</span>
<span class="line" id="L1619">                        <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(file));</span>
<span class="line" id="L1620">                    }</span>
<span class="line" id="L1621">                }</span>
<span class="line" id="L1622">            },</span>
<span class="line" id="L1623"></span>
<span class="line" id="L1624">            .win32_resource_file =&gt; |rc_source_file| {</span>
<span class="line" id="L1625">                <span class="tok-kw">if</span> (rc_source_file.flags.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L1626">                    <span class="tok-kw">if</span> (prev_has_rcflags) {</span>
<span class="line" id="L1627">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcflags&quot;</span>);</span>
<span class="line" id="L1628">                        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1629">                        prev_has_rcflags = <span class="tok-null">false</span>;</span>
<span class="line" id="L1630">                    }</span>
<span class="line" id="L1631">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1632">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcflags&quot;</span>);</span>
<span class="line" id="L1633">                    <span class="tok-kw">for</span> (rc_source_file.flags) |arg| {</span>
<span class="line" id="L1634">                        <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1635">                    }</span>
<span class="line" id="L1636">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--&quot;</span>);</span>
<span class="line" id="L1637">                    prev_has_rcflags = <span class="tok-null">true</span>;</span>
<span class="line" id="L1638">                }</span>
<span class="line" id="L1639">                <span class="tok-kw">try</span> zig_args.append(rc_source_file.file.getPath(b));</span>
<span class="line" id="L1640">            },</span>
<span class="line" id="L1641">        }</span>
<span class="line" id="L1642">    }</span>
<span class="line" id="L1643"></span>
<span class="line" id="L1644">    <span class="tok-kw">if</span> (self.win32_manifest) |manifest_file| {</span>
<span class="line" id="L1645">        <span class="tok-kw">try</span> zig_args.append(manifest_file.getPath(b));</span>
<span class="line" id="L1646">    }</span>
<span class="line" id="L1647"></span>
<span class="line" id="L1648">    <span class="tok-kw">if</span> (transitive_deps.is_linking_libcpp) {</span>
<span class="line" id="L1649">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-lc++&quot;</span>);</span>
<span class="line" id="L1650">    }</span>
<span class="line" id="L1651"></span>
<span class="line" id="L1652">    <span class="tok-kw">if</span> (transitive_deps.is_linking_libc) {</span>
<span class="line" id="L1653">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-lc&quot;</span>);</span>
<span class="line" id="L1654">    }</span>
<span class="line" id="L1655"></span>
<span class="line" id="L1656">    <span class="tok-kw">if</span> (self.image_base) |image_base| {</span>
<span class="line" id="L1657">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--image-base&quot;</span>);</span>
<span class="line" id="L1658">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;0x{x}&quot;</span>, .{image_base}));</span>
<span class="line" id="L1659">    }</span>
<span class="line" id="L1660"></span>
<span class="line" id="L1661">    <span class="tok-kw">if</span> (self.filter) |filter| {</span>
<span class="line" id="L1662">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-filter&quot;</span>);</span>
<span class="line" id="L1663">        <span class="tok-kw">try</span> zig_args.append(filter);</span>
<span class="line" id="L1664">    }</span>
<span class="line" id="L1665"></span>
<span class="line" id="L1666">    <span class="tok-kw">if</span> (self.test_evented_io) {</span>
<span class="line" id="L1667">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-evented-io&quot;</span>);</span>
<span class="line" id="L1668">    }</span>
<span class="line" id="L1669"></span>
<span class="line" id="L1670">    <span class="tok-kw">if</span> (self.test_runner) |test_runner| {</span>
<span class="line" id="L1671">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-runner&quot;</span>);</span>
<span class="line" id="L1672">        <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(test_runner));</span>
<span class="line" id="L1673">    }</span>
<span class="line" id="L1674"></span>
<span class="line" id="L1675">    <span class="tok-kw">for</span> (b.debug_log_scopes) |log_scope| {</span>
<span class="line" id="L1676">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-log&quot;</span>);</span>
<span class="line" id="L1677">        <span class="tok-kw">try</span> zig_args.append(log_scope);</span>
<span class="line" id="L1678">    }</span>
<span class="line" id="L1679"></span>
<span class="line" id="L1680">    <span class="tok-kw">if</span> (b.debug_compile_errors) {</span>
<span class="line" id="L1681">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--debug-compile-errors&quot;</span>);</span>
<span class="line" id="L1682">    }</span>
<span class="line" id="L1683"></span>
<span class="line" id="L1684">    <span class="tok-kw">if</span> (b.verbose_cimport) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-cimport&quot;</span>);</span>
<span class="line" id="L1685">    <span class="tok-kw">if</span> (b.verbose_air) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-air&quot;</span>);</span>
<span class="line" id="L1686">    <span class="tok-kw">if</span> (b.verbose_llvm_ir) |path| <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--verbose-llvm-ir={s}&quot;</span>, .{path}));</span>
<span class="line" id="L1687">    <span class="tok-kw">if</span> (b.verbose_llvm_bc) |path| <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--verbose-llvm-bc={s}&quot;</span>, .{path}));</span>
<span class="line" id="L1688">    <span class="tok-kw">if</span> (b.verbose_link <span class="tok-kw">or</span> self.verbose_link) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-link&quot;</span>);</span>
<span class="line" id="L1689">    <span class="tok-kw">if</span> (b.verbose_cc <span class="tok-kw">or</span> self.verbose_cc) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-cc&quot;</span>);</span>
<span class="line" id="L1690">    <span class="tok-kw">if</span> (b.verbose_llvm_cpu_features) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--verbose-llvm-cpu-features&quot;</span>);</span>
<span class="line" id="L1691"></span>
<span class="line" id="L1692">    <span class="tok-kw">if</span> (self.generated_asm != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-asm&quot;</span>);</span>
<span class="line" id="L1693">    <span class="tok-kw">if</span> (self.generated_bin == <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-emit-bin&quot;</span>);</span>
<span class="line" id="L1694">    <span class="tok-kw">if</span> (self.generated_docs != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-docs&quot;</span>);</span>
<span class="line" id="L1695">    <span class="tok-kw">if</span> (self.generated_implib != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-implib&quot;</span>);</span>
<span class="line" id="L1696">    <span class="tok-kw">if</span> (self.generated_llvm_bc != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-llvm-bc&quot;</span>);</span>
<span class="line" id="L1697">    <span class="tok-kw">if</span> (self.generated_llvm_ir != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-llvm-ir&quot;</span>);</span>
<span class="line" id="L1698">    <span class="tok-kw">if</span> (self.generated_h != <span class="tok-null">null</span>) <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-femit-h&quot;</span>);</span>
<span class="line" id="L1699"></span>
<span class="line" id="L1700">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;strip&quot;</span>, self.strip);</span>
<span class="line" id="L1701">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;unwind-tables&quot;</span>, self.unwind_tables);</span>
<span class="line" id="L1702"></span>
<span class="line" id="L1703">    <span class="tok-kw">if</span> (self.dwarf_format) |dwarf_format| {</span>
<span class="line" id="L1704">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (dwarf_format) {</span>
<span class="line" id="L1705">            .@&quot;32&quot; =&gt; <span class="tok-str">&quot;-gdwarf32&quot;</span>,</span>
<span class="line" id="L1706">            .@&quot;64&quot; =&gt; <span class="tok-str">&quot;-gdwarf64&quot;</span>,</span>
<span class="line" id="L1707">        });</span>
<span class="line" id="L1708">    }</span>
<span class="line" id="L1709"></span>
<span class="line" id="L1710">    <span class="tok-kw">switch</span> (self.compress_debug_sections) {</span>
<span class="line" id="L1711">        .none =&gt; {},</span>
<span class="line" id="L1712">        .zlib =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--compress-debug-sections=zlib&quot;</span>),</span>
<span class="line" id="L1713">        .zstd =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--compress-debug-sections=zstd&quot;</span>),</span>
<span class="line" id="L1714">    }</span>
<span class="line" id="L1715"></span>
<span class="line" id="L1716">    <span class="tok-kw">if</span> (self.link_eh_frame_hdr) {</span>
<span class="line" id="L1717">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--eh-frame-hdr&quot;</span>);</span>
<span class="line" id="L1718">    }</span>
<span class="line" id="L1719">    <span class="tok-kw">if</span> (self.link_emit_relocs) {</span>
<span class="line" id="L1720">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--emit-relocs&quot;</span>);</span>
<span class="line" id="L1721">    }</span>
<span class="line" id="L1722">    <span class="tok-kw">if</span> (self.link_function_sections) {</span>
<span class="line" id="L1723">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-ffunction-sections&quot;</span>);</span>
<span class="line" id="L1724">    }</span>
<span class="line" id="L1725">    <span class="tok-kw">if</span> (self.link_data_sections) {</span>
<span class="line" id="L1726">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fdata-sections&quot;</span>);</span>
<span class="line" id="L1727">    }</span>
<span class="line" id="L1728">    <span class="tok-kw">if</span> (self.link_gc_sections) |x| {</span>
<span class="line" id="L1729">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;--gc-sections&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;--no-gc-sections&quot;</span>);</span>
<span class="line" id="L1730">    }</span>
<span class="line" id="L1731">    <span class="tok-kw">if</span> (!self.linker_dynamicbase) {</span>
<span class="line" id="L1732">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--no-dynamicbase&quot;</span>);</span>
<span class="line" id="L1733">    }</span>
<span class="line" id="L1734">    <span class="tok-kw">if</span> (self.linker_allow_shlib_undefined) |x| {</span>
<span class="line" id="L1735">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">if</span> (x) <span class="tok-str">&quot;-fallow-shlib-undefined&quot;</span> <span class="tok-kw">else</span> <span class="tok-str">&quot;-fno-allow-shlib-undefined&quot;</span>);</span>
<span class="line" id="L1736">    }</span>
<span class="line" id="L1737">    <span class="tok-kw">if</span> (self.link_z_notext) {</span>
<span class="line" id="L1738">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1739">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;notext&quot;</span>);</span>
<span class="line" id="L1740">    }</span>
<span class="line" id="L1741">    <span class="tok-kw">if</span> (!self.link_z_relro) {</span>
<span class="line" id="L1742">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1743">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;norelro&quot;</span>);</span>
<span class="line" id="L1744">    }</span>
<span class="line" id="L1745">    <span class="tok-kw">if</span> (self.link_z_lazy) {</span>
<span class="line" id="L1746">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1747">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;lazy&quot;</span>);</span>
<span class="line" id="L1748">    }</span>
<span class="line" id="L1749">    <span class="tok-kw">if</span> (self.link_z_common_page_size) |size| {</span>
<span class="line" id="L1750">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1751">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;common-page-size={d}&quot;</span>, .{size}));</span>
<span class="line" id="L1752">    }</span>
<span class="line" id="L1753">    <span class="tok-kw">if</span> (self.link_z_max_page_size) |size| {</span>
<span class="line" id="L1754">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-z&quot;</span>);</span>
<span class="line" id="L1755">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;max-page-size={d}&quot;</span>, .{size}));</span>
<span class="line" id="L1756">    }</span>
<span class="line" id="L1757"></span>
<span class="line" id="L1758">    <span class="tok-kw">if</span> (self.libc_file) |libc_file| {</span>
<span class="line" id="L1759">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1760">        <span class="tok-kw">try</span> zig_args.append(libc_file.getPath(b));</span>
<span class="line" id="L1761">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (b.libc_file) |libc_file| {</span>
<span class="line" id="L1762">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--libc&quot;</span>);</span>
<span class="line" id="L1763">        <span class="tok-kw">try</span> zig_args.append(libc_file);</span>
<span class="line" id="L1764">    }</span>
<span class="line" id="L1765"></span>
<span class="line" id="L1766">    <span class="tok-kw">switch</span> (self.optimize) {</span>
<span class="line" id="L1767">        .Debug =&gt; {}, <span class="tok-comment">// Skip since it's the default.</span>
</span>
<span class="line" id="L1768">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;-O{s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(self.optimize)})),</span>
<span class="line" id="L1769">    }</span>
<span class="line" id="L1770"></span>
<span class="line" id="L1771">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--cache-dir&quot;</span>);</span>
<span class="line" id="L1772">    <span class="tok-kw">try</span> zig_args.append(b.cache_root.path <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>);</span>
<span class="line" id="L1773"></span>
<span class="line" id="L1774">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--global-cache-dir&quot;</span>);</span>
<span class="line" id="L1775">    <span class="tok-kw">try</span> zig_args.append(b.global_cache_root.path <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>);</span>
<span class="line" id="L1776"></span>
<span class="line" id="L1777">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--name&quot;</span>);</span>
<span class="line" id="L1778">    <span class="tok-kw">try</span> zig_args.append(self.name);</span>
<span class="line" id="L1779"></span>
<span class="line" id="L1780">    <span class="tok-kw">if</span> (self.linkage) |some| <span class="tok-kw">switch</span> (some) {</span>
<span class="line" id="L1781">        .dynamic =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dynamic&quot;</span>),</span>
<span class="line" id="L1782">        .static =&gt; <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-static&quot;</span>),</span>
<span class="line" id="L1783">    };</span>
<span class="line" id="L1784">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic) {</span>
<span class="line" id="L1785">        <span class="tok-kw">if</span> (self.version) |version| {</span>
<span class="line" id="L1786">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--version&quot;</span>);</span>
<span class="line" id="L1787">            <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;{}&quot;</span>, .{version}));</span>
<span class="line" id="L1788">        }</span>
<span class="line" id="L1789"></span>
<span class="line" id="L1790">        <span class="tok-kw">if</span> (self.target.isDarwin()) {</span>
<span class="line" id="L1791">            <span class="tok-kw">const</span> install_name = self.install_name <span class="tok-kw">orelse</span> b.fmt(<span class="tok-str">&quot;@rpath/{s}{s}{s}&quot;</span>, .{</span>
<span class="line" id="L1792">                self.target.libPrefix(),</span>
<span class="line" id="L1793">                self.name,</span>
<span class="line" id="L1794">                self.target.dynamicLibSuffix(),</span>
<span class="line" id="L1795">            });</span>
<span class="line" id="L1796">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-install_name&quot;</span>);</span>
<span class="line" id="L1797">            <span class="tok-kw">try</span> zig_args.append(install_name);</span>
<span class="line" id="L1798">        }</span>
<span class="line" id="L1799">    }</span>
<span class="line" id="L1800"></span>
<span class="line" id="L1801">    <span class="tok-kw">if</span> (self.entitlements) |entitlements| {</span>
<span class="line" id="L1802">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--entitlements&quot;</span>, entitlements });</span>
<span class="line" id="L1803">    }</span>
<span class="line" id="L1804">    <span class="tok-kw">if</span> (self.pagezero_size) |pagezero_size| {</span>
<span class="line" id="L1805">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;{x}&quot;</span>, .{pagezero_size});</span>
<span class="line" id="L1806">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-pagezero_size&quot;</span>, size });</span>
<span class="line" id="L1807">    }</span>
<span class="line" id="L1808">    <span class="tok-kw">if</span> (self.headerpad_size) |headerpad_size| {</span>
<span class="line" id="L1809">        <span class="tok-kw">const</span> size = <span class="tok-kw">try</span> std.fmt.allocPrint(b.allocator, <span class="tok-str">&quot;{x}&quot;</span>, .{headerpad_size});</span>
<span class="line" id="L1810">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;-headerpad&quot;</span>, size });</span>
<span class="line" id="L1811">    }</span>
<span class="line" id="L1812">    <span class="tok-kw">if</span> (self.headerpad_max_install_names) {</span>
<span class="line" id="L1813">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-headerpad_max_install_names&quot;</span>);</span>
<span class="line" id="L1814">    }</span>
<span class="line" id="L1815">    <span class="tok-kw">if</span> (self.dead_strip_dylibs) {</span>
<span class="line" id="L1816">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-dead_strip_dylibs&quot;</span>);</span>
<span class="line" id="L1817">    }</span>
<span class="line" id="L1818"></span>
<span class="line" id="L1819">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;compiler-rt&quot;</span>, self.bundle_compiler_rt);</span>
<span class="line" id="L1820">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;single-threaded&quot;</span>, self.single_threaded);</span>
<span class="line" id="L1821">    <span class="tok-kw">if</span> (self.disable_stack_probing) {</span>
<span class="line" id="L1822">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-stack-check&quot;</span>);</span>
<span class="line" id="L1823">    }</span>
<span class="line" id="L1824">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;stack-protector&quot;</span>, self.stack_protector);</span>
<span class="line" id="L1825">    <span class="tok-kw">if</span> (self.red_zone) |red_zone| {</span>
<span class="line" id="L1826">        <span class="tok-kw">if</span> (red_zone) {</span>
<span class="line" id="L1827">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mred-zone&quot;</span>);</span>
<span class="line" id="L1828">        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1829">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mno-red-zone&quot;</span>);</span>
<span class="line" id="L1830">        }</span>
<span class="line" id="L1831">    }</span>
<span class="line" id="L1832">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;omit-frame-pointer&quot;</span>, self.omit_frame_pointer);</span>
<span class="line" id="L1833">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;dll-export-fns&quot;</span>, self.dll_export_fns);</span>
<span class="line" id="L1834"></span>
<span class="line" id="L1835">    <span class="tok-kw">if</span> (self.disable_sanitize_c) {</span>
<span class="line" id="L1836">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fno-sanitize-c&quot;</span>);</span>
<span class="line" id="L1837">    }</span>
<span class="line" id="L1838">    <span class="tok-kw">if</span> (self.sanitize_thread) {</span>
<span class="line" id="L1839">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-fsanitize-thread&quot;</span>);</span>
<span class="line" id="L1840">    }</span>
<span class="line" id="L1841">    <span class="tok-kw">if</span> (self.rdynamic) {</span>
<span class="line" id="L1842">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rdynamic&quot;</span>);</span>
<span class="line" id="L1843">    }</span>
<span class="line" id="L1844">    <span class="tok-kw">if</span> (self.import_memory) {</span>
<span class="line" id="L1845">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-memory&quot;</span>);</span>
<span class="line" id="L1846">    }</span>
<span class="line" id="L1847">    <span class="tok-kw">if</span> (self.export_memory) {</span>
<span class="line" id="L1848">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--export-memory&quot;</span>);</span>
<span class="line" id="L1849">    }</span>
<span class="line" id="L1850">    <span class="tok-kw">if</span> (self.import_symbols) {</span>
<span class="line" id="L1851">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-symbols&quot;</span>);</span>
<span class="line" id="L1852">    }</span>
<span class="line" id="L1853">    <span class="tok-kw">if</span> (self.import_table) {</span>
<span class="line" id="L1854">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--import-table&quot;</span>);</span>
<span class="line" id="L1855">    }</span>
<span class="line" id="L1856">    <span class="tok-kw">if</span> (self.export_table) {</span>
<span class="line" id="L1857">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--export-table&quot;</span>);</span>
<span class="line" id="L1858">    }</span>
<span class="line" id="L1859">    <span class="tok-kw">if</span> (self.initial_memory) |initial_memory| {</span>
<span class="line" id="L1860">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--initial-memory={d}&quot;</span>, .{initial_memory}));</span>
<span class="line" id="L1861">    }</span>
<span class="line" id="L1862">    <span class="tok-kw">if</span> (self.max_memory) |max_memory| {</span>
<span class="line" id="L1863">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--max-memory={d}&quot;</span>, .{max_memory}));</span>
<span class="line" id="L1864">    }</span>
<span class="line" id="L1865">    <span class="tok-kw">if</span> (self.shared_memory) {</span>
<span class="line" id="L1866">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--shared-memory&quot;</span>);</span>
<span class="line" id="L1867">    }</span>
<span class="line" id="L1868">    <span class="tok-kw">if</span> (self.global_base) |global_base| {</span>
<span class="line" id="L1869">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--global-base={d}&quot;</span>, .{global_base}));</span>
<span class="line" id="L1870">    }</span>
<span class="line" id="L1871"></span>
<span class="line" id="L1872">    <span class="tok-kw">if</span> (self.code_model != .default) {</span>
<span class="line" id="L1873">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-mcmodel&quot;</span>);</span>
<span class="line" id="L1874">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-builtin">@tagName</span>(self.code_model));</span>
<span class="line" id="L1875">    }</span>
<span class="line" id="L1876">    <span class="tok-kw">if</span> (self.wasi_exec_model) |model| {</span>
<span class="line" id="L1877">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;-mexec-model={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(model)}));</span>
<span class="line" id="L1878">    }</span>
<span class="line" id="L1879">    <span class="tok-kw">for</span> (self.export_symbol_names) |symbol_name| {</span>
<span class="line" id="L1880">        <span class="tok-kw">try</span> zig_args.append(b.fmt(<span class="tok-str">&quot;--export={s}&quot;</span>, .{symbol_name}));</span>
<span class="line" id="L1881">    }</span>
<span class="line" id="L1882"></span>
<span class="line" id="L1883">    <span class="tok-kw">if</span> (!self.target.isNative()) {</span>
<span class="line" id="L1884">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L1885">            <span class="tok-str">&quot;-target&quot;</span>, <span class="tok-kw">try</span> self.target.zigTriple(b.allocator),</span>
<span class="line" id="L1886">            <span class="tok-str">&quot;-mcpu&quot;</span>,   <span class="tok-kw">try</span> std.Build.serializeCpu(b.allocator, self.target.getCpu()),</span>
<span class="line" id="L1887">        });</span>
<span class="line" id="L1888"></span>
<span class="line" id="L1889">        <span class="tok-kw">if</span> (self.target.dynamic_linker.get()) |dynamic_linker| {</span>
<span class="line" id="L1890">            <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--dynamic-linker&quot;</span>);</span>
<span class="line" id="L1891">            <span class="tok-kw">try</span> zig_args.append(dynamic_linker);</span>
<span class="line" id="L1892">        }</span>
<span class="line" id="L1893">    }</span>
<span class="line" id="L1894"></span>
<span class="line" id="L1895">    <span class="tok-kw">if</span> (self.linker_script) |linker_script| {</span>
<span class="line" id="L1896">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--script&quot;</span>);</span>
<span class="line" id="L1897">        <span class="tok-kw">try</span> zig_args.append(linker_script.getPath(b));</span>
<span class="line" id="L1898">    }</span>
<span class="line" id="L1899"></span>
<span class="line" id="L1900">    <span class="tok-kw">if</span> (self.version_script) |version_script| {</span>
<span class="line" id="L1901">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--version-script&quot;</span>);</span>
<span class="line" id="L1902">        <span class="tok-kw">try</span> zig_args.append(b.pathFromRoot(version_script));</span>
<span class="line" id="L1903">    }</span>
<span class="line" id="L1904"></span>
<span class="line" id="L1905">    <span class="tok-kw">if</span> (self.kind == .@&quot;test&quot;) {</span>
<span class="line" id="L1906">        <span class="tok-kw">if</span> (self.exec_cmd_args) |exec_cmd_args| {</span>
<span class="line" id="L1907">            <span class="tok-kw">for</span> (exec_cmd_args) |cmd_arg| {</span>
<span class="line" id="L1908">                <span class="tok-kw">if</span> (cmd_arg) |arg| {</span>
<span class="line" id="L1909">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd&quot;</span>);</span>
<span class="line" id="L1910">                    <span class="tok-kw">try</span> zig_args.append(arg);</span>
<span class="line" id="L1911">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1912">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--test-cmd-bin&quot;</span>);</span>
<span class="line" id="L1913">                }</span>
<span class="line" id="L1914">            }</span>
<span class="line" id="L1915">        }</span>
<span class="line" id="L1916">    }</span>
<span class="line" id="L1917"></span>
<span class="line" id="L1918">    <span class="tok-kw">try</span> self.appendModuleArgs(&amp;zig_args);</span>
<span class="line" id="L1919"></span>
<span class="line" id="L1920">    <span class="tok-kw">for</span> (self.include_dirs.items) |include_dir| {</span>
<span class="line" id="L1921">        <span class="tok-kw">switch</span> (include_dir) {</span>
<span class="line" id="L1922">            .path =&gt; |include_path| {</span>
<span class="line" id="L1923">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-I&quot;</span>);</span>
<span class="line" id="L1924">                <span class="tok-kw">try</span> zig_args.append(include_path.getPath(b));</span>
<span class="line" id="L1925">            },</span>
<span class="line" id="L1926">            .path_system =&gt; |include_path| {</span>
<span class="line" id="L1927">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-isystem&quot;</span>);</span>
<span class="line" id="L1928">                <span class="tok-kw">try</span> zig_args.append(include_path.getPath(b));</span>
<span class="line" id="L1929">            },</span>
<span class="line" id="L1930">            .path_after =&gt; |include_path| {</span>
<span class="line" id="L1931">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-idirafter&quot;</span>);</span>
<span class="line" id="L1932">                <span class="tok-kw">try</span> zig_args.append(include_path.getPath(b));</span>
<span class="line" id="L1933">            },</span>
<span class="line" id="L1934">            .framework_path =&gt; |include_path| {</span>
<span class="line" id="L1935">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-F&quot;</span>);</span>
<span class="line" id="L1936">                <span class="tok-kw">try</span> zig_args.append(include_path.getPath2(b, step));</span>
<span class="line" id="L1937">            },</span>
<span class="line" id="L1938">            .framework_path_system =&gt; |include_path| {</span>
<span class="line" id="L1939">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-iframework&quot;</span>);</span>
<span class="line" id="L1940">                <span class="tok-kw">try</span> zig_args.append(include_path.getPath2(b, step));</span>
<span class="line" id="L1941">            },</span>
<span class="line" id="L1942">            .other_step =&gt; |other| {</span>
<span class="line" id="L1943">                <span class="tok-kw">if</span> (other.generated_h) |header| {</span>
<span class="line" id="L1944">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-isystem&quot;</span>);</span>
<span class="line" id="L1945">                    <span class="tok-kw">try</span> zig_args.append(fs.path.dirname(header.path.?).?);</span>
<span class="line" id="L1946">                }</span>
<span class="line" id="L1947">                <span class="tok-kw">if</span> (other.installed_headers.items.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1948">                    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-I&quot;</span>);</span>
<span class="line" id="L1949">                    <span class="tok-kw">try</span> zig_args.append(b.pathJoin(&amp;.{</span>
<span class="line" id="L1950">                        other.step.owner.install_prefix, <span class="tok-str">&quot;include&quot;</span>,</span>
<span class="line" id="L1951">                    }));</span>
<span class="line" id="L1952">                }</span>
<span class="line" id="L1953">            },</span>
<span class="line" id="L1954">            .config_header_step =&gt; |config_header| {</span>
<span class="line" id="L1955">                <span class="tok-kw">const</span> full_file_path = config_header.output_file.path.?;</span>
<span class="line" id="L1956">                <span class="tok-kw">const</span> header_dir_path = full_file_path[<span class="tok-number">0</span> .. full_file_path.len - config_header.include_path.len];</span>
<span class="line" id="L1957">                <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{ <span class="tok-str">&quot;-I&quot;</span>, header_dir_path });</span>
<span class="line" id="L1958">            },</span>
<span class="line" id="L1959">        }</span>
<span class="line" id="L1960">    }</span>
<span class="line" id="L1961"></span>
<span class="line" id="L1962">    <span class="tok-kw">for</span> (self.c_macros.items) |c_macro| {</span>
<span class="line" id="L1963">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-D&quot;</span>);</span>
<span class="line" id="L1964">        <span class="tok-kw">try</span> zig_args.append(c_macro);</span>
<span class="line" id="L1965">    }</span>
<span class="line" id="L1966"></span>
<span class="line" id="L1967">    <span class="tok-kw">try</span> zig_args.ensureUnusedCapacity(<span class="tok-number">2</span> * self.lib_paths.items.len);</span>
<span class="line" id="L1968">    <span class="tok-kw">for</span> (self.lib_paths.items) |lib_path| {</span>
<span class="line" id="L1969">        zig_args.appendAssumeCapacity(<span class="tok-str">&quot;-L&quot;</span>);</span>
<span class="line" id="L1970">        zig_args.appendAssumeCapacity(lib_path.getPath2(b, step));</span>
<span class="line" id="L1971">    }</span>
<span class="line" id="L1972"></span>
<span class="line" id="L1973">    <span class="tok-kw">try</span> zig_args.ensureUnusedCapacity(<span class="tok-number">2</span> * self.rpaths.items.len);</span>
<span class="line" id="L1974">    <span class="tok-kw">for</span> (self.rpaths.items) |rpath| {</span>
<span class="line" id="L1975">        zig_args.appendAssumeCapacity(<span class="tok-str">&quot;-rpath&quot;</span>);</span>
<span class="line" id="L1976"></span>
<span class="line" id="L1977">        <span class="tok-kw">if</span> (self.target_info.target.isDarwin()) <span class="tok-kw">switch</span> (rpath) {</span>
<span class="line" id="L1978">            .path, .cwd_relative =&gt; |path| {</span>
<span class="line" id="L1979">                <span class="tok-comment">// On Darwin, we should not try to expand special runtime paths such as</span>
</span>
<span class="line" id="L1980">                <span class="tok-comment">// * @executable_path</span>
</span>
<span class="line" id="L1981">                <span class="tok-comment">// * @loader_path</span>
</span>
<span class="line" id="L1982">                <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, path, <span class="tok-str">&quot;@executable_path&quot;</span>) <span class="tok-kw">or</span></span>
<span class="line" id="L1983">                    mem.startsWith(<span class="tok-type">u8</span>, path, <span class="tok-str">&quot;@loader_path&quot;</span>))</span>
<span class="line" id="L1984">                {</span>
<span class="line" id="L1985">                    zig_args.appendAssumeCapacity(path);</span>
<span class="line" id="L1986">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L1987">                }</span>
<span class="line" id="L1988">            },</span>
<span class="line" id="L1989">            .generated, .dependency =&gt; {},</span>
<span class="line" id="L1990">        };</span>
<span class="line" id="L1991"></span>
<span class="line" id="L1992">        zig_args.appendAssumeCapacity(rpath.getPath2(b, step));</span>
<span class="line" id="L1993">    }</span>
<span class="line" id="L1994"></span>
<span class="line" id="L1995">    {</span>
<span class="line" id="L1996">        <span class="tok-kw">var</span> it = self.frameworks.iterator();</span>
<span class="line" id="L1997">        <span class="tok-kw">while</span> (it.next()) |entry| {</span>
<span class="line" id="L1998">            <span class="tok-kw">const</span> name = entry.key_ptr.*;</span>
<span class="line" id="L1999">            <span class="tok-kw">const</span> info = entry.value_ptr.*;</span>
<span class="line" id="L2000">            <span class="tok-kw">if</span> (info.needed) {</span>
<span class="line" id="L2001">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-needed_framework&quot;</span>);</span>
<span class="line" id="L2002">            } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (info.weak) {</span>
<span class="line" id="L2003">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-weak_framework&quot;</span>);</span>
<span class="line" id="L2004">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2005">                <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-framework&quot;</span>);</span>
<span class="line" id="L2006">            }</span>
<span class="line" id="L2007">            <span class="tok-kw">try</span> zig_args.append(name);</span>
<span class="line" id="L2008">        }</span>
<span class="line" id="L2009">    }</span>
<span class="line" id="L2010"></span>
<span class="line" id="L2011">    <span class="tok-kw">if</span> (b.sysroot) |sysroot| {</span>
<span class="line" id="L2012">        <span class="tok-kw">try</span> zig_args.appendSlice(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;--sysroot&quot;</span>, sysroot });</span>
<span class="line" id="L2013">    }</span>
<span class="line" id="L2014"></span>
<span class="line" id="L2015">    <span class="tok-kw">for</span> (b.search_prefixes.items) |search_prefix| {</span>
<span class="line" id="L2016">        <span class="tok-kw">var</span> prefix_dir = fs.cwd().openDir(search_prefix, .{}) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L2017">            <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to open prefix directory '{s}': {s}&quot;</span>, .{</span>
<span class="line" id="L2018">                search_prefix, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L2019">            });</span>
<span class="line" id="L2020">        };</span>
<span class="line" id="L2021">        <span class="tok-kw">defer</span> prefix_dir.close();</span>
<span class="line" id="L2022"></span>
<span class="line" id="L2023">        <span class="tok-comment">// Avoid passing -L and -I flags for nonexistent directories.</span>
</span>
<span class="line" id="L2024">        <span class="tok-comment">// This prevents a warning, that should probably be upgraded to an error in Zig's</span>
</span>
<span class="line" id="L2025">        <span class="tok-comment">// CLI parsing code, when the linker sees an -L directory that does not exist.</span>
</span>
<span class="line" id="L2026"></span>
<span class="line" id="L2027">        <span class="tok-kw">if</span> (prefix_dir.accessZ(<span class="tok-str">&quot;lib&quot;</span>, .{})) |_| {</span>
<span class="line" id="L2028">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L2029">                <span class="tok-str">&quot;-L&quot;</span>, <span class="tok-kw">try</span> fs.path.join(b.allocator, &amp;.{ search_prefix, <span class="tok-str">&quot;lib&quot;</span> }),</span>
<span class="line" id="L2030">            });</span>
<span class="line" id="L2031">        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2032">            <span class="tok-kw">error</span>.FileNotFound =&gt; {},</span>
<span class="line" id="L2033">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to access '{s}/lib' directory: {s}&quot;</span>, .{</span>
<span class="line" id="L2034">                search_prefix, <span class="tok-builtin">@errorName</span>(e),</span>
<span class="line" id="L2035">            }),</span>
<span class="line" id="L2036">        }</span>
<span class="line" id="L2037"></span>
<span class="line" id="L2038">        <span class="tok-kw">if</span> (prefix_dir.accessZ(<span class="tok-str">&quot;include&quot;</span>, .{})) |_| {</span>
<span class="line" id="L2039">            <span class="tok-kw">try</span> zig_args.appendSlice(&amp;.{</span>
<span class="line" id="L2040">                <span class="tok-str">&quot;-I&quot;</span>, <span class="tok-kw">try</span> fs.path.join(b.allocator, &amp;.{ search_prefix, <span class="tok-str">&quot;include&quot;</span> }),</span>
<span class="line" id="L2041">            });</span>
<span class="line" id="L2042">        } <span class="tok-kw">else</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2043">            <span class="tok-kw">error</span>.FileNotFound =&gt; {},</span>
<span class="line" id="L2044">            <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to access '{s}/include' directory: {s}&quot;</span>, .{</span>
<span class="line" id="L2045">                search_prefix, <span class="tok-builtin">@errorName</span>(e),</span>
<span class="line" id="L2046">            }),</span>
<span class="line" id="L2047">        }</span>
<span class="line" id="L2048">    }</span>
<span class="line" id="L2049"></span>
<span class="line" id="L2050">    <span class="tok-kw">if</span> (self.rc_includes != .any) {</span>
<span class="line" id="L2051">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;-rcincludes&quot;</span>);</span>
<span class="line" id="L2052">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-builtin">@tagName</span>(self.rc_includes));</span>
<span class="line" id="L2053">    }</span>
<span class="line" id="L2054"></span>
<span class="line" id="L2055">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;valgrind&quot;</span>, self.valgrind_support);</span>
<span class="line" id="L2056">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;each-lib-rpath&quot;</span>, self.each_lib_rpath);</span>
<span class="line" id="L2057"></span>
<span class="line" id="L2058">    <span class="tok-kw">if</span> (self.build_id) |build_id| {</span>
<span class="line" id="L2059">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (build_id) {</span>
<span class="line" id="L2060">            .hexstring =&gt; |hs| b.fmt(<span class="tok-str">&quot;--build-id=0x{s}&quot;</span>, .{</span>
<span class="line" id="L2061">                std.fmt.fmtSliceHexLower(hs.toSlice()),</span>
<span class="line" id="L2062">            }),</span>
<span class="line" id="L2063">            .none, .fast, .uuid, .sha1, .md5 =&gt; b.fmt(<span class="tok-str">&quot;--build-id={s}&quot;</span>, .{<span class="tok-builtin">@tagName</span>(build_id)}),</span>
<span class="line" id="L2064">        });</span>
<span class="line" id="L2065">    }</span>
<span class="line" id="L2066"></span>
<span class="line" id="L2067">    <span class="tok-kw">if</span> (self.zig_lib_dir) |dir| {</span>
<span class="line" id="L2068">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--zig-lib-dir&quot;</span>);</span>
<span class="line" id="L2069">        <span class="tok-kw">try</span> zig_args.append(dir.getPath(b));</span>
<span class="line" id="L2070">    }</span>
<span class="line" id="L2071"></span>
<span class="line" id="L2072">    <span class="tok-kw">if</span> (self.main_mod_path) |dir| {</span>
<span class="line" id="L2073">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--main-mod-path&quot;</span>);</span>
<span class="line" id="L2074">        <span class="tok-kw">try</span> zig_args.append(dir.getPath(b));</span>
<span class="line" id="L2075">    }</span>
<span class="line" id="L2076"></span>
<span class="line" id="L2077">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;PIC&quot;</span>, self.force_pic);</span>
<span class="line" id="L2078">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;PIE&quot;</span>, self.pie);</span>
<span class="line" id="L2079">    <span class="tok-kw">try</span> addFlag(&amp;zig_args, <span class="tok-str">&quot;lto&quot;</span>, self.want_lto);</span>
<span class="line" id="L2080"></span>
<span class="line" id="L2081">    <span class="tok-kw">if</span> (self.subsystem) |subsystem| {</span>
<span class="line" id="L2082">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--subsystem&quot;</span>);</span>
<span class="line" id="L2083">        <span class="tok-kw">try</span> zig_args.append(<span class="tok-kw">switch</span> (subsystem) {</span>
<span class="line" id="L2084">            .Console =&gt; <span class="tok-str">&quot;console&quot;</span>,</span>
<span class="line" id="L2085">            .Windows =&gt; <span class="tok-str">&quot;windows&quot;</span>,</span>
<span class="line" id="L2086">            .Posix =&gt; <span class="tok-str">&quot;posix&quot;</span>,</span>
<span class="line" id="L2087">            .Native =&gt; <span class="tok-str">&quot;native&quot;</span>,</span>
<span class="line" id="L2088">            .EfiApplication =&gt; <span class="tok-str">&quot;efi_application&quot;</span>,</span>
<span class="line" id="L2089">            .EfiBootServiceDriver =&gt; <span class="tok-str">&quot;efi_boot_service_driver&quot;</span>,</span>
<span class="line" id="L2090">            .EfiRom =&gt; <span class="tok-str">&quot;efi_rom&quot;</span>,</span>
<span class="line" id="L2091">            .EfiRuntimeDriver =&gt; <span class="tok-str">&quot;efi_runtime_driver&quot;</span>,</span>
<span class="line" id="L2092">        });</span>
<span class="line" id="L2093">    }</span>
<span class="line" id="L2094"></span>
<span class="line" id="L2095">    <span class="tok-kw">try</span> zig_args.append(<span class="tok-str">&quot;--listen=-&quot;</span>);</span>
<span class="line" id="L2096"></span>
<span class="line" id="L2097">    <span class="tok-comment">// Windows has an argument length limit of 32,766 characters, macOS 262,144 and Linux</span>
</span>
<span class="line" id="L2098">    <span class="tok-comment">// 2,097,152. If our args exceed 30 KiB, we instead write them to a &quot;response file&quot; and</span>
</span>
<span class="line" id="L2099">    <span class="tok-comment">// pass that to zig, e.g. via 'zig build-lib @args.rsp'</span>
</span>
<span class="line" id="L2100">    <span class="tok-comment">// See @file syntax here: https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html</span>
</span>
<span class="line" id="L2101">    <span class="tok-kw">var</span> args_length: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L2102">    <span class="tok-kw">for</span> (zig_args.items) |arg| {</span>
<span class="line" id="L2103">        args_length += arg.len + <span class="tok-number">1</span>; <span class="tok-comment">// +1 to account for null terminator</span>
</span>
<span class="line" id="L2104">    }</span>
<span class="line" id="L2105">    <span class="tok-kw">if</span> (args_length &gt;= <span class="tok-number">30</span> * <span class="tok-number">1024</span>) {</span>
<span class="line" id="L2106">        <span class="tok-kw">try</span> b.cache_root.handle.makePath(<span class="tok-str">&quot;args&quot;</span>);</span>
<span class="line" id="L2107"></span>
<span class="line" id="L2108">        <span class="tok-kw">const</span> args_to_escape = zig_args.items[<span class="tok-number">2</span>..];</span>
<span class="line" id="L2109">        <span class="tok-kw">var</span> escaped_args = <span class="tok-kw">try</span> ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>).initCapacity(b.allocator, args_to_escape.len);</span>
<span class="line" id="L2110">        arg_blk: <span class="tok-kw">for</span> (args_to_escape) |arg| {</span>
<span class="line" id="L2111">            <span class="tok-kw">for</span> (arg, <span class="tok-number">0</span>..) |c, arg_idx| {</span>
<span class="line" id="L2112">                <span class="tok-kw">if</span> (c == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> c == <span class="tok-str">'&quot;'</span>) {</span>
<span class="line" id="L2113">                    <span class="tok-comment">// Slow path for arguments that need to be escaped. We'll need to allocate and copy</span>
</span>
<span class="line" id="L2114">                    <span class="tok-kw">var</span> escaped = <span class="tok-kw">try</span> ArrayList(<span class="tok-type">u8</span>).initCapacity(b.allocator, arg.len + <span class="tok-number">1</span>);</span>
<span class="line" id="L2115">                    <span class="tok-kw">const</span> writer = escaped.writer();</span>
<span class="line" id="L2116">                    <span class="tok-kw">try</span> writer.writeAll(arg[<span class="tok-number">0</span>..arg_idx]);</span>
<span class="line" id="L2117">                    <span class="tok-kw">for</span> (arg[arg_idx..]) |to_escape| {</span>
<span class="line" id="L2118">                        <span class="tok-kw">if</span> (to_escape == <span class="tok-str">'\\'</span> <span class="tok-kw">or</span> to_escape == <span class="tok-str">'&quot;'</span>) <span class="tok-kw">try</span> writer.writeByte(<span class="tok-str">'\\'</span>);</span>
<span class="line" id="L2119">                        <span class="tok-kw">try</span> writer.writeByte(to_escape);</span>
<span class="line" id="L2120">                    }</span>
<span class="line" id="L2121">                    escaped_args.appendAssumeCapacity(escaped.items);</span>
<span class="line" id="L2122">                    <span class="tok-kw">continue</span> :arg_blk;</span>
<span class="line" id="L2123">                }</span>
<span class="line" id="L2124">            }</span>
<span class="line" id="L2125">            escaped_args.appendAssumeCapacity(arg); <span class="tok-comment">// no escaping needed so just use original argument</span>
</span>
<span class="line" id="L2126">        }</span>
<span class="line" id="L2127"></span>
<span class="line" id="L2128">        <span class="tok-comment">// Write the args to zig-cache/args/&lt;SHA256 hash of args&gt; to avoid conflicts with</span>
</span>
<span class="line" id="L2129">        <span class="tok-comment">// other zig build commands running in parallel.</span>
</span>
<span class="line" id="L2130">        <span class="tok-kw">const</span> partially_quoted = <span class="tok-kw">try</span> std.mem.join(b.allocator, <span class="tok-str">&quot;\&quot; \&quot;&quot;</span>, escaped_args.items);</span>
<span class="line" id="L2131">        <span class="tok-kw">const</span> args = <span class="tok-kw">try</span> std.mem.concat(b.allocator, <span class="tok-type">u8</span>, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;\&quot;&quot;</span>, partially_quoted, <span class="tok-str">&quot;\&quot;&quot;</span> });</span>
<span class="line" id="L2132"></span>
<span class="line" id="L2133">        <span class="tok-kw">var</span> args_hash: [Sha256.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2134">        Sha256.hash(args, &amp;args_hash, .{});</span>
<span class="line" id="L2135">        <span class="tok-kw">var</span> args_hex_hash: [Sha256.digest_length * <span class="tok-number">2</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2136">        _ = <span class="tok-kw">try</span> std.fmt.bufPrint(</span>
<span class="line" id="L2137">            &amp;args_hex_hash,</span>
<span class="line" id="L2138">            <span class="tok-str">&quot;{s}&quot;</span>,</span>
<span class="line" id="L2139">            .{std.fmt.fmtSliceHexLower(&amp;args_hash)},</span>
<span class="line" id="L2140">        );</span>
<span class="line" id="L2141"></span>
<span class="line" id="L2142">        <span class="tok-kw">const</span> args_file = <span class="tok-str">&quot;args&quot;</span> ++ fs.path.sep_str ++ args_hex_hash;</span>
<span class="line" id="L2143">        <span class="tok-kw">try</span> b.cache_root.handle.writeFile(args_file, args);</span>
<span class="line" id="L2144"></span>
<span class="line" id="L2145">        <span class="tok-kw">const</span> resolved_args_file = <span class="tok-kw">try</span> mem.concat(b.allocator, <span class="tok-type">u8</span>, &amp;.{</span>
<span class="line" id="L2146">            <span class="tok-str">&quot;@&quot;</span>,</span>
<span class="line" id="L2147">            <span class="tok-kw">try</span> b.cache_root.join(b.allocator, &amp;.{args_file}),</span>
<span class="line" id="L2148">        });</span>
<span class="line" id="L2149"></span>
<span class="line" id="L2150">        zig_args.shrinkRetainingCapacity(<span class="tok-number">2</span>);</span>
<span class="line" id="L2151">        <span class="tok-kw">try</span> zig_args.append(resolved_args_file);</span>
<span class="line" id="L2152">    }</span>
<span class="line" id="L2153"></span>
<span class="line" id="L2154">    <span class="tok-kw">const</span> maybe_output_bin_path = step.evalZigProcess(zig_args.items, prog_node) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2155">        <span class="tok-kw">error</span>.NeedCompileErrorCheck =&gt; {</span>
<span class="line" id="L2156">            assert(self.expect_errors != <span class="tok-null">null</span>);</span>
<span class="line" id="L2157">            <span class="tok-kw">try</span> checkCompileErrors(self);</span>
<span class="line" id="L2158">            <span class="tok-kw">return</span>;</span>
<span class="line" id="L2159">        },</span>
<span class="line" id="L2160">        <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L2161">    };</span>
<span class="line" id="L2162"></span>
<span class="line" id="L2163">    <span class="tok-comment">// Update generated files</span>
</span>
<span class="line" id="L2164">    <span class="tok-kw">if</span> (maybe_output_bin_path) |output_bin_path| {</span>
<span class="line" id="L2165">        <span class="tok-kw">const</span> output_dir = fs.path.dirname(output_bin_path).?;</span>
<span class="line" id="L2166"></span>
<span class="line" id="L2167">        <span class="tok-kw">if</span> (self.emit_directory) |lp| {</span>
<span class="line" id="L2168">            lp.path = output_dir;</span>
<span class="line" id="L2169">        }</span>
<span class="line" id="L2170"></span>
<span class="line" id="L2171">        <span class="tok-comment">// -femit-bin[=path]         (default) Output machine code</span>
</span>
<span class="line" id="L2172">        <span class="tok-kw">if</span> (self.generated_bin) |bin| {</span>
<span class="line" id="L2173">            bin.path = b.pathJoin(&amp;.{ output_dir, self.out_filename });</span>
<span class="line" id="L2174">        }</span>
<span class="line" id="L2175"></span>
<span class="line" id="L2176">        <span class="tok-kw">const</span> sep = std.fs.path.sep;</span>
<span class="line" id="L2177"></span>
<span class="line" id="L2178">        <span class="tok-comment">// output PDB if someone requested it</span>
</span>
<span class="line" id="L2179">        <span class="tok-kw">if</span> (self.generated_pdb) |pdb| {</span>
<span class="line" id="L2180">            pdb.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.pdb&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2181">        }</span>
<span class="line" id="L2182"></span>
<span class="line" id="L2183">        <span class="tok-comment">// -femit-implib[=path]      (default) Produce an import .lib when building a Windows DLL</span>
</span>
<span class="line" id="L2184">        <span class="tok-kw">if</span> (self.generated_implib) |implib| {</span>
<span class="line" id="L2185">            implib.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.lib&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2186">        }</span>
<span class="line" id="L2187"></span>
<span class="line" id="L2188">        <span class="tok-comment">// -femit-h[=path]           Generate a C header file (.h)</span>
</span>
<span class="line" id="L2189">        <span class="tok-kw">if</span> (self.generated_h) |lp| {</span>
<span class="line" id="L2190">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.h&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2191">        }</span>
<span class="line" id="L2192"></span>
<span class="line" id="L2193">        <span class="tok-comment">// -femit-docs[=path]        Create a docs/ dir with html documentation</span>
</span>
<span class="line" id="L2194">        <span class="tok-kw">if</span> (self.generated_docs) |generated_docs| {</span>
<span class="line" id="L2195">            generated_docs.path = b.pathJoin(&amp;.{ output_dir, <span class="tok-str">&quot;docs&quot;</span> });</span>
<span class="line" id="L2196">        }</span>
<span class="line" id="L2197"></span>
<span class="line" id="L2198">        <span class="tok-comment">// -femit-asm[=path]         Output .s (assembly code)</span>
</span>
<span class="line" id="L2199">        <span class="tok-kw">if</span> (self.generated_asm) |lp| {</span>
<span class="line" id="L2200">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.s&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2201">        }</span>
<span class="line" id="L2202"></span>
<span class="line" id="L2203">        <span class="tok-comment">// -femit-llvm-ir[=path]     Produce a .ll file with optimized LLVM IR (requires LLVM extensions)</span>
</span>
<span class="line" id="L2204">        <span class="tok-kw">if</span> (self.generated_llvm_ir) |lp| {</span>
<span class="line" id="L2205">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.ll&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2206">        }</span>
<span class="line" id="L2207"></span>
<span class="line" id="L2208">        <span class="tok-comment">// -femit-llvm-bc[=path]     Produce an optimized LLVM module as a .bc file (requires LLVM extensions)</span>
</span>
<span class="line" id="L2209">        <span class="tok-kw">if</span> (self.generated_llvm_bc) |lp| {</span>
<span class="line" id="L2210">            lp.path = b.fmt(<span class="tok-str">&quot;{s}{c}{s}.bc&quot;</span>, .{ output_dir, sep, self.name });</span>
<span class="line" id="L2211">        }</span>
<span class="line" id="L2212">    }</span>
<span class="line" id="L2213"></span>
<span class="line" id="L2214">    <span class="tok-kw">if</span> (self.kind == .lib <span class="tok-kw">and</span> self.linkage != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.linkage.? == .dynamic <span class="tok-kw">and</span></span>
<span class="line" id="L2215">        self.version != <span class="tok-null">null</span> <span class="tok-kw">and</span> self.target.wantSharedLibSymLinks())</span>
<span class="line" id="L2216">    {</span>
<span class="line" id="L2217">        <span class="tok-kw">try</span> doAtomicSymLinks(</span>
<span class="line" id="L2218">            step,</span>
<span class="line" id="L2219">            self.getEmittedBin().getPath(b),</span>
<span class="line" id="L2220">            self.major_only_filename.?,</span>
<span class="line" id="L2221">            self.name_only_filename.?,</span>
<span class="line" id="L2222">        );</span>
<span class="line" id="L2223">    }</span>
<span class="line" id="L2224">}</span>
<span class="line" id="L2225"></span>
<span class="line" id="L2226"><span class="tok-kw">fn</span> <span class="tok-fn">isLibCLibrary</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L2227">    <span class="tok-kw">const</span> libc_libraries = [_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;c&quot;</span>, <span class="tok-str">&quot;m&quot;</span>, <span class="tok-str">&quot;dl&quot;</span>, <span class="tok-str">&quot;rt&quot;</span>, <span class="tok-str">&quot;pthread&quot;</span> };</span>
<span class="line" id="L2228">    <span class="tok-kw">for</span> (libc_libraries) |libc_lib_name| {</span>
<span class="line" id="L2229">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, name, libc_lib_name))</span>
<span class="line" id="L2230">            <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2231">    }</span>
<span class="line" id="L2232">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2233">}</span>
<span class="line" id="L2234"></span>
<span class="line" id="L2235"><span class="tok-kw">fn</span> <span class="tok-fn">isLibCppLibrary</span>(name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L2236">    <span class="tok-kw">const</span> libcpp_libraries = [_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;c++&quot;</span>, <span class="tok-str">&quot;stdc++&quot;</span> };</span>
<span class="line" id="L2237">    <span class="tok-kw">for</span> (libcpp_libraries) |libcpp_lib_name| {</span>
<span class="line" id="L2238">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, name, libcpp_lib_name))</span>
<span class="line" id="L2239">            <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2240">    }</span>
<span class="line" id="L2241">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2242">}</span>
<span class="line" id="L2243"></span>
<span class="line" id="L2244"><span class="tok-comment">/// Returned slice must be freed by the caller.</span></span>
<span class="line" id="L2245"><span class="tok-kw">fn</span> <span class="tok-fn">findVcpkgRoot</span>(allocator: Allocator) !?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L2246">    <span class="tok-kw">const</span> appdata_path = <span class="tok-kw">try</span> fs.getAppDataDir(allocator, <span class="tok-str">&quot;vcpkg&quot;</span>);</span>
<span class="line" id="L2247">    <span class="tok-kw">defer</span> allocator.free(appdata_path);</span>
<span class="line" id="L2248"></span>
<span class="line" id="L2249">    <span class="tok-kw">const</span> path_file = <span class="tok-kw">try</span> fs.path.join(allocator, &amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ appdata_path, <span class="tok-str">&quot;vcpkg.path.txt&quot;</span> });</span>
<span class="line" id="L2250">    <span class="tok-kw">defer</span> allocator.free(path_file);</span>
<span class="line" id="L2251"></span>
<span class="line" id="L2252">    <span class="tok-kw">const</span> file = fs.cwd().openFile(path_file, .{}) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L2253">    <span class="tok-kw">defer</span> file.close();</span>
<span class="line" id="L2254"></span>
<span class="line" id="L2255">    <span class="tok-kw">const</span> size = <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-kw">try</span> file.getEndPos()));</span>
<span class="line" id="L2256">    <span class="tok-kw">const</span> vcpkg_path = <span class="tok-kw">try</span> allocator.alloc(<span class="tok-type">u8</span>, size);</span>
<span class="line" id="L2257">    <span class="tok-kw">const</span> size_read = <span class="tok-kw">try</span> file.read(vcpkg_path);</span>
<span class="line" id="L2258">    std.debug.assert(size == size_read);</span>
<span class="line" id="L2259"></span>
<span class="line" id="L2260">    <span class="tok-kw">return</span> vcpkg_path;</span>
<span class="line" id="L2261">}</span>
<span class="line" id="L2262"></span>
<span class="line" id="L2263"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">doAtomicSymLinks</span>(</span>
<span class="line" id="L2264">    step: *Step,</span>
<span class="line" id="L2265">    output_path: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2266">    filename_major_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2267">    filename_name_only: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2268">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2269">    <span class="tok-kw">const</span> arena = step.owner.allocator;</span>
<span class="line" id="L2270">    <span class="tok-kw">const</span> out_dir = fs.path.dirname(output_path) <span class="tok-kw">orelse</span> <span class="tok-str">&quot;.&quot;</span>;</span>
<span class="line" id="L2271">    <span class="tok-kw">const</span> out_basename = fs.path.basename(output_path);</span>
<span class="line" id="L2272">    <span class="tok-comment">// sym link for libfoo.so.1 to libfoo.so.1.2.3</span>
</span>
<span class="line" id="L2273">    <span class="tok-kw">const</span> major_only_path = <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ out_dir, filename_major_only });</span>
<span class="line" id="L2274">    fs.atomicSymLink(arena, out_basename, major_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L2275">        <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;unable to symlink {s} -&gt; {s}: {s}&quot;</span>, .{</span>
<span class="line" id="L2276">            major_only_path, out_basename, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L2277">        });</span>
<span class="line" id="L2278">    };</span>
<span class="line" id="L2279">    <span class="tok-comment">// sym link for libfoo.so to libfoo.so.1</span>
</span>
<span class="line" id="L2280">    <span class="tok-kw">const</span> name_only_path = <span class="tok-kw">try</span> fs.path.join(arena, &amp;.{ out_dir, filename_name_only });</span>
<span class="line" id="L2281">    fs.atomicSymLink(arena, filename_major_only, name_only_path) <span class="tok-kw">catch</span> |err| {</span>
<span class="line" id="L2282">        <span class="tok-kw">return</span> step.fail(<span class="tok-str">&quot;Unable to symlink {s} -&gt; {s}: {s}&quot;</span>, .{</span>
<span class="line" id="L2283">            name_only_path, filename_major_only, <span class="tok-builtin">@errorName</span>(err),</span>
<span class="line" id="L2284">        });</span>
<span class="line" id="L2285">    };</span>
<span class="line" id="L2286">}</span>
<span class="line" id="L2287"></span>
<span class="line" id="L2288"><span class="tok-kw">fn</span> <span class="tok-fn">execPkgConfigList</span>(self: *std.Build, out_code: *<span class="tok-type">u8</span>) (PkgConfigError || RunError)![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L2289">    <span class="tok-kw">const</span> stdout = <span class="tok-kw">try</span> self.runAllowFail(&amp;[_][]<span class="tok-kw">const</span> <span class="tok-type">u8</span>{ <span class="tok-str">&quot;pkg-config&quot;</span>, <span class="tok-str">&quot;--list-all&quot;</span> }, out_code, .Ignore);</span>
<span class="line" id="L2290">    <span class="tok-kw">var</span> list = ArrayList(PkgConfigPkg).init(self.allocator);</span>
<span class="line" id="L2291">    <span class="tok-kw">errdefer</span> list.deinit();</span>
<span class="line" id="L2292">    <span class="tok-kw">var</span> line_it = mem.tokenizeAny(<span class="tok-type">u8</span>, stdout, <span class="tok-str">&quot;\r\n&quot;</span>);</span>
<span class="line" id="L2293">    <span class="tok-kw">while</span> (line_it.next()) |line| {</span>
<span class="line" id="L2294">        <span class="tok-kw">if</span> (mem.trim(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>).len == <span class="tok-number">0</span>) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2295">        <span class="tok-kw">var</span> tok_it = mem.tokenizeAny(<span class="tok-type">u8</span>, line, <span class="tok-str">&quot; \t&quot;</span>);</span>
<span class="line" id="L2296">        <span class="tok-kw">try</span> list.append(PkgConfigPkg{</span>
<span class="line" id="L2297">            .name = tok_it.next() <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L2298">            .desc = tok_it.rest(),</span>
<span class="line" id="L2299">        });</span>
<span class="line" id="L2300">    }</span>
<span class="line" id="L2301">    <span class="tok-kw">return</span> list.toOwnedSlice();</span>
<span class="line" id="L2302">}</span>
<span class="line" id="L2303"></span>
<span class="line" id="L2304"><span class="tok-kw">fn</span> <span class="tok-fn">getPkgConfigList</span>(self: *std.Build) ![]<span class="tok-kw">const</span> PkgConfigPkg {</span>
<span class="line" id="L2305">    <span class="tok-kw">if</span> (self.pkg_config_pkg_list) |res| {</span>
<span class="line" id="L2306">        <span class="tok-kw">return</span> res;</span>
<span class="line" id="L2307">    }</span>
<span class="line" id="L2308">    <span class="tok-kw">var</span> code: <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L2309">    <span class="tok-kw">if</span> (execPkgConfigList(self, &amp;code)) |list| {</span>
<span class="line" id="L2310">        self.pkg_config_pkg_list = list;</span>
<span class="line" id="L2311">        <span class="tok-kw">return</span> list;</span>
<span class="line" id="L2312">    } <span class="tok-kw">else</span> |err| {</span>
<span class="line" id="L2313">        <span class="tok-kw">const</span> result = <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L2314">            <span class="tok-kw">error</span>.ProcessTerminated =&gt; <span class="tok-kw">error</span>.PkgConfigCrashed,</span>
<span class="line" id="L2315">            <span class="tok-kw">error</span>.ExecNotSupported =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L2316">            <span class="tok-kw">error</span>.ExitCodeFailure =&gt; <span class="tok-kw">error</span>.PkgConfigFailed,</span>
<span class="line" id="L2317">            <span class="tok-kw">error</span>.FileNotFound =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L2318">            <span class="tok-kw">error</span>.InvalidName =&gt; <span class="tok-kw">error</span>.PkgConfigNotInstalled,</span>
<span class="line" id="L2319">            <span class="tok-kw">error</span>.PkgConfigInvalidOutput =&gt; <span class="tok-kw">error</span>.PkgConfigInvalidOutput,</span>
<span class="line" id="L2320">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L2321">        };</span>
<span class="line" id="L2322">        self.pkg_config_pkg_list = result;</span>
<span class="line" id="L2323">        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L2324">    }</span>
<span class="line" id="L2325">}</span>
<span class="line" id="L2326"></span>
<span class="line" id="L2327"><span class="tok-kw">fn</span> <span class="tok-fn">addFlag</span>(args: *ArrayList([]<span class="tok-kw">const</span> <span class="tok-type">u8</span>), <span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, opt: ?<span class="tok-type">bool</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2328">    <span class="tok-kw">const</span> cond = opt <span class="tok-kw">orelse</span> <span class="tok-kw">return</span>;</span>
<span class="line" id="L2329">    <span class="tok-kw">try</span> args.ensureUnusedCapacity(<span class="tok-number">1</span>);</span>
<span class="line" id="L2330">    <span class="tok-kw">if</span> (cond) {</span>
<span class="line" id="L2331">        args.appendAssumeCapacity(<span class="tok-str">&quot;-f&quot;</span> ++ name);</span>
<span class="line" id="L2332">    } <span class="tok-kw">else</span> {</span>
<span class="line" id="L2333">        args.appendAssumeCapacity(<span class="tok-str">&quot;-fno-&quot;</span> ++ name);</span>
<span class="line" id="L2334">    }</span>
<span class="line" id="L2335">}</span>
<span class="line" id="L2336"></span>
<span class="line" id="L2337"><span class="tok-kw">const</span> TransitiveDeps = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L2338">    link_objects: ArrayList(LinkObject),</span>
<span class="line" id="L2339">    seen_system_libs: StringHashMap(<span class="tok-type">void</span>),</span>
<span class="line" id="L2340">    seen_steps: std.AutoHashMap(*<span class="tok-kw">const</span> Step, <span class="tok-type">void</span>),</span>
<span class="line" id="L2341">    is_linking_libcpp: <span class="tok-type">bool</span>,</span>
<span class="line" id="L2342">    is_linking_libc: <span class="tok-type">bool</span>,</span>
<span class="line" id="L2343">    frameworks: *StringHashMap(FrameworkLinkInfo),</span>
<span class="line" id="L2344"></span>
<span class="line" id="L2345">    <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(td: *TransitiveDeps, link_objects: []<span class="tok-kw">const</span> LinkObject) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2346">        <span class="tok-kw">try</span> td.link_objects.ensureUnusedCapacity(link_objects.len);</span>
<span class="line" id="L2347"></span>
<span class="line" id="L2348">        <span class="tok-kw">for</span> (link_objects) |link_object| {</span>
<span class="line" id="L2349">            <span class="tok-kw">try</span> td.link_objects.append(link_object);</span>
<span class="line" id="L2350">            <span class="tok-kw">switch</span> (link_object) {</span>
<span class="line" id="L2351">                .other_step =&gt; |other| <span class="tok-kw">try</span> addInner(td, other, other.isDynamicLibrary()),</span>
<span class="line" id="L2352">                <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L2353">            }</span>
<span class="line" id="L2354">        }</span>
<span class="line" id="L2355">    }</span>
<span class="line" id="L2356"></span>
<span class="line" id="L2357">    <span class="tok-kw">fn</span> <span class="tok-fn">addInner</span>(td: *TransitiveDeps, other: *Compile, dyn: <span class="tok-type">bool</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2358">        <span class="tok-comment">// Inherit dependency on libc and libc++</span>
</span>
<span class="line" id="L2359">        td.is_linking_libcpp = td.is_linking_libcpp <span class="tok-kw">or</span> other.is_linking_libcpp;</span>
<span class="line" id="L2360">        td.is_linking_libc = td.is_linking_libc <span class="tok-kw">or</span> other.is_linking_libc;</span>
<span class="line" id="L2361"></span>
<span class="line" id="L2362">        <span class="tok-comment">// Inherit dependencies on darwin frameworks</span>
</span>
<span class="line" id="L2363">        <span class="tok-kw">if</span> (!dyn) {</span>
<span class="line" id="L2364">            <span class="tok-kw">var</span> it = other.frameworks.iterator();</span>
<span class="line" id="L2365">            <span class="tok-kw">while</span> (it.next()) |framework| {</span>
<span class="line" id="L2366">                <span class="tok-kw">try</span> td.frameworks.put(framework.key_ptr.*, framework.value_ptr.*);</span>
<span class="line" id="L2367">            }</span>
<span class="line" id="L2368">        }</span>
<span class="line" id="L2369"></span>
<span class="line" id="L2370">        <span class="tok-comment">// Inherit dependencies on system libraries and static libraries.</span>
</span>
<span class="line" id="L2371">        <span class="tok-kw">for</span> (other.link_objects.items) |other_link_object| {</span>
<span class="line" id="L2372">            <span class="tok-kw">switch</span> (other_link_object) {</span>
<span class="line" id="L2373">                .system_lib =&gt; |system_lib| {</span>
<span class="line" id="L2374">                    <span class="tok-kw">if</span> ((<span class="tok-kw">try</span> td.seen_system_libs.fetchPut(system_lib.name, {})) != <span class="tok-null">null</span>)</span>
<span class="line" id="L2375">                        <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2376"></span>
<span class="line" id="L2377">                    <span class="tok-kw">if</span> (dyn)</span>
<span class="line" id="L2378">                        <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2379"></span>
<span class="line" id="L2380">                    <span class="tok-kw">try</span> td.link_objects.append(other_link_object);</span>
<span class="line" id="L2381">                },</span>
<span class="line" id="L2382">                .other_step =&gt; |inner_other| {</span>
<span class="line" id="L2383">                    <span class="tok-kw">if</span> ((<span class="tok-kw">try</span> td.seen_steps.fetchPut(&amp;inner_other.step, {})) != <span class="tok-null">null</span>)</span>
<span class="line" id="L2384">                        <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2385"></span>
<span class="line" id="L2386">                    <span class="tok-kw">const</span> included_in_lib = (other.kind == .lib <span class="tok-kw">and</span> inner_other.kind == .obj);</span>
<span class="line" id="L2387">                    <span class="tok-kw">if</span> (!dyn <span class="tok-kw">and</span> !included_in_lib)</span>
<span class="line" id="L2388">                        <span class="tok-kw">try</span> td.link_objects.append(other_link_object);</span>
<span class="line" id="L2389"></span>
<span class="line" id="L2390">                    <span class="tok-kw">try</span> addInner(td, inner_other, dyn <span class="tok-kw">or</span> inner_other.isDynamicLibrary());</span>
<span class="line" id="L2391">                },</span>
<span class="line" id="L2392">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L2393">            }</span>
<span class="line" id="L2394">        }</span>
<span class="line" id="L2395">    }</span>
<span class="line" id="L2396">};</span>
<span class="line" id="L2397"></span>
<span class="line" id="L2398"><span class="tok-kw">fn</span> <span class="tok-fn">checkCompileErrors</span>(self: *Compile) !<span class="tok-type">void</span> {</span>
<span class="line" id="L2399">    <span class="tok-comment">// Clear this field so that it does not get printed by the build runner.</span>
</span>
<span class="line" id="L2400">    <span class="tok-kw">const</span> actual_eb = self.step.result_error_bundle;</span>
<span class="line" id="L2401">    self.step.result_error_bundle = std.zig.ErrorBundle.empty;</span>
<span class="line" id="L2402"></span>
<span class="line" id="L2403">    <span class="tok-kw">const</span> arena = self.step.owner.allocator;</span>
<span class="line" id="L2404"></span>
<span class="line" id="L2405">    <span class="tok-kw">var</span> actual_stderr_list = std.ArrayList(<span class="tok-type">u8</span>).init(arena);</span>
<span class="line" id="L2406">    <span class="tok-kw">try</span> actual_eb.renderToWriter(.{</span>
<span class="line" id="L2407">        .ttyconf = .no_color,</span>
<span class="line" id="L2408">        .include_reference_trace = <span class="tok-null">false</span>,</span>
<span class="line" id="L2409">        .include_source_line = <span class="tok-null">false</span>,</span>
<span class="line" id="L2410">    }, actual_stderr_list.writer());</span>
<span class="line" id="L2411">    <span class="tok-kw">const</span> actual_stderr = <span class="tok-kw">try</span> actual_stderr_list.toOwnedSlice();</span>
<span class="line" id="L2412"></span>
<span class="line" id="L2413">    <span class="tok-comment">// Render the expected lines into a string that we can compare verbatim.</span>
</span>
<span class="line" id="L2414">    <span class="tok-kw">var</span> expected_generated = std.ArrayList(<span class="tok-type">u8</span>).init(arena);</span>
<span class="line" id="L2415">    <span class="tok-kw">const</span> expect_errors = self.expect_errors.?;</span>
<span class="line" id="L2416"></span>
<span class="line" id="L2417">    <span class="tok-kw">var</span> actual_line_it = mem.splitScalar(<span class="tok-type">u8</span>, actual_stderr, <span class="tok-str">'\n'</span>);</span>
<span class="line" id="L2418"></span>
<span class="line" id="L2419">    <span class="tok-comment">// TODO merge this with the testing.expectEqualStrings logic, and also CheckFile</span>
</span>
<span class="line" id="L2420">    <span class="tok-kw">switch</span> (expect_errors) {</span>
<span class="line" id="L2421">        .contains =&gt; |expect_line| {</span>
<span class="line" id="L2422">            <span class="tok-kw">while</span> (actual_line_it.next()) |actual_line| {</span>
<span class="line" id="L2423">                <span class="tok-kw">if</span> (!matchCompileError(actual_line, expect_line)) <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2424">                <span class="tok-kw">return</span>;</span>
<span class="line" id="L2425">            }</span>
<span class="line" id="L2426"></span>
<span class="line" id="L2427">            <span class="tok-kw">return</span> self.step.fail(</span>
<span class="line" id="L2428">                <span class="tok-str">\\</span></span>

<span class="line" id="L2429">                <span class="tok-str">\\========= should contain: ===============</span></span>

<span class="line" id="L2430">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L2431">                <span class="tok-str">\\========= but not found: ================</span></span>

<span class="line" id="L2432">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L2433">                <span class="tok-str">\\=========================================</span></span>

<span class="line" id="L2434">            , .{ expect_line, actual_stderr });</span>
<span class="line" id="L2435">        },</span>
<span class="line" id="L2436">        .exact =&gt; |expect_lines| {</span>
<span class="line" id="L2437">            <span class="tok-kw">for</span> (expect_lines) |expect_line| {</span>
<span class="line" id="L2438">                <span class="tok-kw">const</span> actual_line = actual_line_it.next() <span class="tok-kw">orelse</span> {</span>
<span class="line" id="L2439">                    <span class="tok-kw">try</span> expected_generated.appendSlice(expect_line);</span>
<span class="line" id="L2440">                    <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L2441">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2442">                };</span>
<span class="line" id="L2443">                <span class="tok-kw">if</span> (matchCompileError(actual_line, expect_line)) {</span>
<span class="line" id="L2444">                    <span class="tok-kw">try</span> expected_generated.appendSlice(actual_line);</span>
<span class="line" id="L2445">                    <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L2446">                    <span class="tok-kw">continue</span>;</span>
<span class="line" id="L2447">                }</span>
<span class="line" id="L2448">                <span class="tok-kw">try</span> expected_generated.appendSlice(expect_line);</span>
<span class="line" id="L2449">                <span class="tok-kw">try</span> expected_generated.append(<span class="tok-str">'\n'</span>);</span>
<span class="line" id="L2450">            }</span>
<span class="line" id="L2451"></span>
<span class="line" id="L2452">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, expected_generated.items, actual_stderr)) <span class="tok-kw">return</span>;</span>
<span class="line" id="L2453"></span>
<span class="line" id="L2454">            <span class="tok-kw">return</span> self.step.fail(</span>
<span class="line" id="L2455">                <span class="tok-str">\\</span></span>

<span class="line" id="L2456">                <span class="tok-str">\\========= expected: =====================</span></span>

<span class="line" id="L2457">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L2458">                <span class="tok-str">\\========= but found: ====================</span></span>

<span class="line" id="L2459">                <span class="tok-str">\\{s}</span></span>

<span class="line" id="L2460">                <span class="tok-str">\\=========================================</span></span>

<span class="line" id="L2461">            , .{ expected_generated.items, actual_stderr });</span>
<span class="line" id="L2462">        },</span>
<span class="line" id="L2463">    }</span>
<span class="line" id="L2464">}</span>
<span class="line" id="L2465"></span>
<span class="line" id="L2466"><span class="tok-kw">fn</span> <span class="tok-fn">matchCompileError</span>(actual: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, expected: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L2467">    <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, actual, expected)) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2468">    <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, expected, <span class="tok-str">&quot;:?:?: &quot;</span>)) {</span>
<span class="line" id="L2469">        <span class="tok-kw">if</span> (mem.endsWith(<span class="tok-type">u8</span>, actual, expected[<span class="tok-str">&quot;:?:?: &quot;</span>.len..])) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2470">    }</span>
<span class="line" id="L2471">    <span class="tok-comment">// We scan for /?/ in expected line and if there is a match, we match everything</span>
</span>
<span class="line" id="L2472">    <span class="tok-comment">// up to and after /?/.</span>
</span>
<span class="line" id="L2473">    <span class="tok-kw">const</span> expected_trim = mem.trim(<span class="tok-type">u8</span>, expected, <span class="tok-str">&quot; &quot;</span>);</span>
<span class="line" id="L2474">    <span class="tok-kw">if</span> (mem.indexOf(<span class="tok-type">u8</span>, expected_trim, <span class="tok-str">&quot;/?/&quot;</span>)) |index| {</span>
<span class="line" id="L2475">        <span class="tok-kw">const</span> actual_trim = mem.trim(<span class="tok-type">u8</span>, actual, <span class="tok-str">&quot; &quot;</span>);</span>
<span class="line" id="L2476">        <span class="tok-kw">const</span> lhs = expected_trim[<span class="tok-number">0</span>..index];</span>
<span class="line" id="L2477">        <span class="tok-kw">const</span> rhs = expected_trim[index + <span class="tok-str">&quot;/?/&quot;</span>.len ..];</span>
<span class="line" id="L2478">        <span class="tok-kw">if</span> (mem.startsWith(<span class="tok-type">u8</span>, actual_trim, lhs) <span class="tok-kw">and</span> mem.endsWith(<span class="tok-type">u8</span>, actual_trim, rhs)) <span class="tok-kw">return</span> <span class="tok-null">true</span>;</span>
<span class="line" id="L2479">    }</span>
<span class="line" id="L2480">    <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L2481">}</span>
<span class="line" id="L2482"></span>
</code></pre></body>
</html>