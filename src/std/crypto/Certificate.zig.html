<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>crypto/Certificate.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1">buffer: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L2">index: <span class="tok-type">u32</span>,</span>
<span class="line" id="L3"></span>
<span class="line" id="L4"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Bundle = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;Certificate/Bundle.zig&quot;</span>);</span>
<span class="line" id="L5"></span>
<span class="line" id="L6"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Version = <span class="tok-kw">enum</span> { v1, v2, v3 };</span>
<span class="line" id="L7"></span>
<span class="line" id="L8"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Algorithm = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L9">    sha1WithRSAEncryption,</span>
<span class="line" id="L10">    sha224WithRSAEncryption,</span>
<span class="line" id="L11">    sha256WithRSAEncryption,</span>
<span class="line" id="L12">    sha384WithRSAEncryption,</span>
<span class="line" id="L13">    sha512WithRSAEncryption,</span>
<span class="line" id="L14">    ecdsa_with_SHA224,</span>
<span class="line" id="L15">    ecdsa_with_SHA256,</span>
<span class="line" id="L16">    ecdsa_with_SHA384,</span>
<span class="line" id="L17">    ecdsa_with_SHA512,</span>
<span class="line" id="L18">    md2WithRSAEncryption,</span>
<span class="line" id="L19">    md5WithRSAEncryption,</span>
<span class="line" id="L20"></span>
<span class="line" id="L21">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> map = std.ComptimeStringMap(Algorithm, .{</span>
<span class="line" id="L22">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x05</span> }, .sha1WithRSAEncryption },</span>
<span class="line" id="L23">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0B</span> }, .sha256WithRSAEncryption },</span>
<span class="line" id="L24">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0C</span> }, .sha384WithRSAEncryption },</span>
<span class="line" id="L25">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0D</span> }, .sha512WithRSAEncryption },</span>
<span class="line" id="L26">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0E</span> }, .sha224WithRSAEncryption },</span>
<span class="line" id="L27">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x01</span> }, .ecdsa_with_SHA224 },</span>
<span class="line" id="L28">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x02</span> }, .ecdsa_with_SHA256 },</span>
<span class="line" id="L29">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x03</span> }, .ecdsa_with_SHA384 },</span>
<span class="line" id="L30">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span> }, .ecdsa_with_SHA512 },</span>
<span class="line" id="L31">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span> }, .md2WithRSAEncryption },</span>
<span class="line" id="L32">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x04</span> }, .md5WithRSAEncryption },</span>
<span class="line" id="L33">    });</span>
<span class="line" id="L34"></span>
<span class="line" id="L35">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Hash</span>(<span class="tok-kw">comptime</span> algorithm: Algorithm) <span class="tok-type">type</span> {</span>
<span class="line" id="L36">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (algorithm) {</span>
<span class="line" id="L37">            .sha1WithRSAEncryption =&gt; crypto.hash.Sha1,</span>
<span class="line" id="L38">            .ecdsa_with_SHA224, .sha224WithRSAEncryption =&gt; crypto.hash.sha2.Sha224,</span>
<span class="line" id="L39">            .ecdsa_with_SHA256, .sha256WithRSAEncryption =&gt; crypto.hash.sha2.Sha256,</span>
<span class="line" id="L40">            .ecdsa_with_SHA384, .sha384WithRSAEncryption =&gt; crypto.hash.sha2.Sha384,</span>
<span class="line" id="L41">            .ecdsa_with_SHA512, .sha512WithRSAEncryption =&gt; crypto.hash.sha2.Sha512,</span>
<span class="line" id="L42">            .md2WithRSAEncryption =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unimplemented&quot;</span>),</span>
<span class="line" id="L43">            .md5WithRSAEncryption =&gt; crypto.hash.Md5,</span>
<span class="line" id="L44">        };</span>
<span class="line" id="L45">    }</span>
<span class="line" id="L46">};</span>
<span class="line" id="L47"></span>
<span class="line" id="L48"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AlgorithmCategory = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L49">    rsaEncryption,</span>
<span class="line" id="L50">    X9_62_id_ecPublicKey,</span>
<span class="line" id="L51"></span>
<span class="line" id="L52">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> map = std.ComptimeStringMap(AlgorithmCategory, .{</span>
<span class="line" id="L53">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span> }, .rsaEncryption },</span>
<span class="line" id="L54">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x01</span> }, .X9_62_id_ecPublicKey },</span>
<span class="line" id="L55">    });</span>
<span class="line" id="L56">};</span>
<span class="line" id="L57"></span>
<span class="line" id="L58"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Attribute = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L59">    commonName,</span>
<span class="line" id="L60">    serialNumber,</span>
<span class="line" id="L61">    countryName,</span>
<span class="line" id="L62">    localityName,</span>
<span class="line" id="L63">    stateOrProvinceName,</span>
<span class="line" id="L64">    streetAddress,</span>
<span class="line" id="L65">    organizationName,</span>
<span class="line" id="L66">    organizationalUnitName,</span>
<span class="line" id="L67">    postalCode,</span>
<span class="line" id="L68">    organizationIdentifier,</span>
<span class="line" id="L69">    pkcs9_emailAddress,</span>
<span class="line" id="L70">    domainComponent,</span>
<span class="line" id="L71"></span>
<span class="line" id="L72">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> map = std.ComptimeStringMap(Attribute, .{</span>
<span class="line" id="L73">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span> }, .commonName },</span>
<span class="line" id="L74">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span> }, .serialNumber },</span>
<span class="line" id="L75">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x06</span> }, .countryName },</span>
<span class="line" id="L76">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x07</span> }, .localityName },</span>
<span class="line" id="L77">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x08</span> }, .stateOrProvinceName },</span>
<span class="line" id="L78">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x09</span> }, .streetAddress },</span>
<span class="line" id="L79">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x0A</span> }, .organizationName },</span>
<span class="line" id="L80">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x0B</span> }, .organizationalUnitName },</span>
<span class="line" id="L81">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x11</span> }, .postalCode },</span>
<span class="line" id="L82">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x61</span> }, .organizationIdentifier },</span>
<span class="line" id="L83">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF7</span>, <span class="tok-number">0x0D</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x01</span> }, .pkcs9_emailAddress },</span>
<span class="line" id="L84">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x09</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x26</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0xF2</span>, <span class="tok-number">0x2C</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x19</span> }, .domainComponent },</span>
<span class="line" id="L85">    });</span>
<span class="line" id="L86">};</span>
<span class="line" id="L87"></span>
<span class="line" id="L88"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NamedCurve = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L89">    secp384r1,</span>
<span class="line" id="L90">    secp521r1,</span>
<span class="line" id="L91">    X9_62_prime256v1,</span>
<span class="line" id="L92"></span>
<span class="line" id="L93">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> map = std.ComptimeStringMap(NamedCurve, .{</span>
<span class="line" id="L94">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2B</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x22</span> }, .secp384r1 },</span>
<span class="line" id="L95">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2B</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x23</span> }, .secp521r1 },</span>
<span class="line" id="L96">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0xCE</span>, <span class="tok-number">0x3D</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x07</span> }, .X9_62_prime256v1 },</span>
<span class="line" id="L97">    });</span>
<span class="line" id="L98"></span>
<span class="line" id="L99">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Curve</span>(<span class="tok-kw">comptime</span> curve: NamedCurve) <span class="tok-type">type</span> {</span>
<span class="line" id="L100">        <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (curve) {</span>
<span class="line" id="L101">            .X9_62_prime256v1 =&gt; crypto.ecc.P256,</span>
<span class="line" id="L102">            .secp384r1 =&gt; crypto.ecc.P384,</span>
<span class="line" id="L103">            .secp521r1 =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unimplemented&quot;</span>),</span>
<span class="line" id="L104">        };</span>
<span class="line" id="L105">    }</span>
<span class="line" id="L106">};</span>
<span class="line" id="L107"></span>
<span class="line" id="L108"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ExtensionId = <span class="tok-kw">enum</span> {</span>
<span class="line" id="L109">    subject_key_identifier,</span>
<span class="line" id="L110">    key_usage,</span>
<span class="line" id="L111">    private_key_usage_period,</span>
<span class="line" id="L112">    subject_alt_name,</span>
<span class="line" id="L113">    issuer_alt_name,</span>
<span class="line" id="L114">    basic_constraints,</span>
<span class="line" id="L115">    crl_number,</span>
<span class="line" id="L116">    certificate_policies,</span>
<span class="line" id="L117">    authority_key_identifier,</span>
<span class="line" id="L118">    msCertsrvCAVersion,</span>
<span class="line" id="L119">    commonName,</span>
<span class="line" id="L120">    ext_key_usage,</span>
<span class="line" id="L121">    crl_distribution_points,</span>
<span class="line" id="L122">    info_access,</span>
<span class="line" id="L123">    entrustVersInfo,</span>
<span class="line" id="L124">    enroll_certtype,</span>
<span class="line" id="L125">    pe_logotype,</span>
<span class="line" id="L126">    netscape_cert_type,</span>
<span class="line" id="L127">    netscape_comment,</span>
<span class="line" id="L128"></span>
<span class="line" id="L129">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> map = std.ComptimeStringMap(ExtensionId, .{</span>
<span class="line" id="L130">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x03</span> }, .commonName },</span>
<span class="line" id="L131">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x01</span> }, .authority_key_identifier },</span>
<span class="line" id="L132">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x07</span> }, .subject_alt_name },</span>
<span class="line" id="L133">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x0E</span> }, .subject_key_identifier },</span>
<span class="line" id="L134">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x0F</span> }, .key_usage },</span>
<span class="line" id="L135">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x0A</span> }, .basic_constraints },</span>
<span class="line" id="L136">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x10</span> }, .private_key_usage_period },</span>
<span class="line" id="L137">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x11</span> }, .subject_alt_name },</span>
<span class="line" id="L138">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x12</span> }, .issuer_alt_name },</span>
<span class="line" id="L139">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x13</span> }, .basic_constraints },</span>
<span class="line" id="L140">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x14</span> }, .crl_number },</span>
<span class="line" id="L141">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x1F</span> }, .crl_distribution_points },</span>
<span class="line" id="L142">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x20</span> }, .certificate_policies },</span>
<span class="line" id="L143">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x23</span> }, .authority_key_identifier },</span>
<span class="line" id="L144">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x55</span>, <span class="tok-number">0x1D</span>, <span class="tok-number">0x25</span> }, .ext_key_usage },</span>
<span class="line" id="L145">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2B</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x01</span> }, .msCertsrvCAVersion },</span>
<span class="line" id="L146">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2B</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span> }, .info_access },</span>
<span class="line" id="L147">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2A</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xF6</span>, <span class="tok-number">0x7D</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x00</span> }, .entrustVersInfo },</span>
<span class="line" id="L148">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2b</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x14</span>, <span class="tok-number">0x02</span> }, .enroll_certtype },</span>
<span class="line" id="L149">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x2b</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0c</span> }, .pe_logotype },</span>
<span class="line" id="L150">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x01</span> }, .netscape_cert_type },</span>
<span class="line" id="L151">        .{ &amp;[_]<span class="tok-type">u8</span>{ <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x0d</span> }, .netscape_comment },</span>
<span class="line" id="L152">    });</span>
<span class="line" id="L153">};</span>
<span class="line" id="L154"></span>
<span class="line" id="L155"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GeneralNameTag = <span class="tok-kw">enum</span>(<span class="tok-type">u5</span>) {</span>
<span class="line" id="L156">    otherName = <span class="tok-number">0</span>,</span>
<span class="line" id="L157">    rfc822Name = <span class="tok-number">1</span>,</span>
<span class="line" id="L158">    dNSName = <span class="tok-number">2</span>,</span>
<span class="line" id="L159">    x400Address = <span class="tok-number">3</span>,</span>
<span class="line" id="L160">    directoryName = <span class="tok-number">4</span>,</span>
<span class="line" id="L161">    ediPartyName = <span class="tok-number">5</span>,</span>
<span class="line" id="L162">    uniformResourceIdentifier = <span class="tok-number">6</span>,</span>
<span class="line" id="L163">    iPAddress = <span class="tok-number">7</span>,</span>
<span class="line" id="L164">    registeredID = <span class="tok-number">8</span>,</span>
<span class="line" id="L165">    _,</span>
<span class="line" id="L166">};</span>
<span class="line" id="L167"></span>
<span class="line" id="L168"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Parsed = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L169">    certificate: Certificate,</span>
<span class="line" id="L170">    issuer_slice: Slice,</span>
<span class="line" id="L171">    subject_slice: Slice,</span>
<span class="line" id="L172">    common_name_slice: Slice,</span>
<span class="line" id="L173">    signature_slice: Slice,</span>
<span class="line" id="L174">    signature_algorithm: Algorithm,</span>
<span class="line" id="L175">    pub_key_algo: PubKeyAlgo,</span>
<span class="line" id="L176">    pub_key_slice: Slice,</span>
<span class="line" id="L177">    message_slice: Slice,</span>
<span class="line" id="L178">    subject_alt_name_slice: Slice,</span>
<span class="line" id="L179">    validity: Validity,</span>
<span class="line" id="L180">    version: Version,</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> PubKeyAlgo = <span class="tok-kw">union</span>(AlgorithmCategory) {</span>
<span class="line" id="L183">        rsaEncryption: <span class="tok-type">void</span>,</span>
<span class="line" id="L184">        X9_62_id_ecPublicKey: NamedCurve,</span>
<span class="line" id="L185">    };</span>
<span class="line" id="L186"></span>
<span class="line" id="L187">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Validity = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L188">        not_before: <span class="tok-type">u64</span>,</span>
<span class="line" id="L189">        not_after: <span class="tok-type">u64</span>,</span>
<span class="line" id="L190">    };</span>
<span class="line" id="L191"></span>
<span class="line" id="L192">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Slice = der.Element.Slice;</span>
<span class="line" id="L193"></span>
<span class="line" id="L194">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">slice</span>(p: Parsed, s: Slice) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L195">        <span class="tok-kw">return</span> p.certificate.buffer[s.start..s.end];</span>
<span class="line" id="L196">    }</span>
<span class="line" id="L197"></span>
<span class="line" id="L198">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">issuer</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L199">        <span class="tok-kw">return</span> p.slice(p.issuer_slice);</span>
<span class="line" id="L200">    }</span>
<span class="line" id="L201"></span>
<span class="line" id="L202">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">subject</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L203">        <span class="tok-kw">return</span> p.slice(p.subject_slice);</span>
<span class="line" id="L204">    }</span>
<span class="line" id="L205"></span>
<span class="line" id="L206">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">commonName</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L207">        <span class="tok-kw">return</span> p.slice(p.common_name_slice);</span>
<span class="line" id="L208">    }</span>
<span class="line" id="L209"></span>
<span class="line" id="L210">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">signature</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L211">        <span class="tok-kw">return</span> p.slice(p.signature_slice);</span>
<span class="line" id="L212">    }</span>
<span class="line" id="L213"></span>
<span class="line" id="L214">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pubKey</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L215">        <span class="tok-kw">return</span> p.slice(p.pub_key_slice);</span>
<span class="line" id="L216">    }</span>
<span class="line" id="L217"></span>
<span class="line" id="L218">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">pubKeySigAlgo</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L219">        <span class="tok-kw">return</span> p.slice(p.pub_key_signature_algorithm_slice);</span>
<span class="line" id="L220">    }</span>
<span class="line" id="L221"></span>
<span class="line" id="L222">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">message</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L223">        <span class="tok-kw">return</span> p.slice(p.message_slice);</span>
<span class="line" id="L224">    }</span>
<span class="line" id="L225"></span>
<span class="line" id="L226">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">subjectAltName</span>(p: Parsed) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L227">        <span class="tok-kw">return</span> p.slice(p.subject_alt_name_slice);</span>
<span class="line" id="L228">    }</span>
<span class="line" id="L229"></span>
<span class="line" id="L230">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> VerifyError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L231">        CertificateIssuerMismatch,</span>
<span class="line" id="L232">        CertificateNotYetValid,</span>
<span class="line" id="L233">        CertificateExpired,</span>
<span class="line" id="L234">        CertificateSignatureAlgorithmUnsupported,</span>
<span class="line" id="L235">        CertificateSignatureAlgorithmMismatch,</span>
<span class="line" id="L236">        CertificateFieldHasInvalidLength,</span>
<span class="line" id="L237">        CertificateFieldHasWrongDataType,</span>
<span class="line" id="L238">        CertificatePublicKeyInvalid,</span>
<span class="line" id="L239">        CertificateSignatureInvalidLength,</span>
<span class="line" id="L240">        CertificateSignatureInvalid,</span>
<span class="line" id="L241">        CertificateSignatureUnsupportedBitCount,</span>
<span class="line" id="L242">        CertificateSignatureNamedCurveUnsupported,</span>
<span class="line" id="L243">    };</span>
<span class="line" id="L244"></span>
<span class="line" id="L245">    <span class="tok-comment">/// This function verifies:</span></span>
<span class="line" id="L246">    <span class="tok-comment">///  * That the subject's issuer is indeed the provided issuer.</span></span>
<span class="line" id="L247">    <span class="tok-comment">///  * The time validity of the subject.</span></span>
<span class="line" id="L248">    <span class="tok-comment">///  * The signature.</span></span>
<span class="line" id="L249">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">verify</span>(parsed_subject: Parsed, parsed_issuer: Parsed, now_sec: <span class="tok-type">i64</span>) VerifyError!<span class="tok-type">void</span> {</span>
<span class="line" id="L250">        <span class="tok-comment">// Check that the subject's issuer name matches the issuer's</span>
</span>
<span class="line" id="L251">        <span class="tok-comment">// subject name.</span>
</span>
<span class="line" id="L252">        <span class="tok-kw">if</span> (!mem.eql(<span class="tok-type">u8</span>, parsed_subject.issuer(), parsed_issuer.subject())) {</span>
<span class="line" id="L253">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateIssuerMismatch;</span>
<span class="line" id="L254">        }</span>
<span class="line" id="L255"></span>
<span class="line" id="L256">        <span class="tok-kw">if</span> (now_sec &lt; parsed_subject.validity.not_before)</span>
<span class="line" id="L257">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateNotYetValid;</span>
<span class="line" id="L258">        <span class="tok-kw">if</span> (now_sec &gt; parsed_subject.validity.not_after)</span>
<span class="line" id="L259">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateExpired;</span>
<span class="line" id="L260"></span>
<span class="line" id="L261">        <span class="tok-kw">switch</span> (parsed_subject.signature_algorithm) {</span>
<span class="line" id="L262">            <span class="tok-kw">inline</span> .sha1WithRSAEncryption,</span>
<span class="line" id="L263">            .sha224WithRSAEncryption,</span>
<span class="line" id="L264">            .sha256WithRSAEncryption,</span>
<span class="line" id="L265">            .sha384WithRSAEncryption,</span>
<span class="line" id="L266">            .sha512WithRSAEncryption,</span>
<span class="line" id="L267">            =&gt; |algorithm| <span class="tok-kw">return</span> verifyRsa(</span>
<span class="line" id="L268">                algorithm.Hash(),</span>
<span class="line" id="L269">                parsed_subject.message(),</span>
<span class="line" id="L270">                parsed_subject.signature(),</span>
<span class="line" id="L271">                parsed_issuer.pub_key_algo,</span>
<span class="line" id="L272">                parsed_issuer.pubKey(),</span>
<span class="line" id="L273">            ),</span>
<span class="line" id="L274"></span>
<span class="line" id="L275">            <span class="tok-kw">inline</span> .ecdsa_with_SHA224,</span>
<span class="line" id="L276">            .ecdsa_with_SHA256,</span>
<span class="line" id="L277">            .ecdsa_with_SHA384,</span>
<span class="line" id="L278">            .ecdsa_with_SHA512,</span>
<span class="line" id="L279">            =&gt; |algorithm| <span class="tok-kw">return</span> verify_ecdsa(</span>
<span class="line" id="L280">                algorithm.Hash(),</span>
<span class="line" id="L281">                parsed_subject.message(),</span>
<span class="line" id="L282">                parsed_subject.signature(),</span>
<span class="line" id="L283">                parsed_issuer.pub_key_algo,</span>
<span class="line" id="L284">                parsed_issuer.pubKey(),</span>
<span class="line" id="L285">            ),</span>
<span class="line" id="L286"></span>
<span class="line" id="L287">            .md2WithRSAEncryption, .md5WithRSAEncryption =&gt; {</span>
<span class="line" id="L288">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureAlgorithmUnsupported;</span>
<span class="line" id="L289">            },</span>
<span class="line" id="L290">        }</span>
<span class="line" id="L291">    }</span>
<span class="line" id="L292"></span>
<span class="line" id="L293">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> VerifyHostNameError = <span class="tok-kw">error</span>{</span>
<span class="line" id="L294">        CertificateHostMismatch,</span>
<span class="line" id="L295">        CertificateFieldHasInvalidLength,</span>
<span class="line" id="L296">    };</span>
<span class="line" id="L297"></span>
<span class="line" id="L298">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">verifyHostName</span>(parsed_subject: Parsed, host_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) VerifyHostNameError!<span class="tok-type">void</span> {</span>
<span class="line" id="L299">        <span class="tok-comment">// If the Subject Alternative Names extension is present, this is</span>
</span>
<span class="line" id="L300">        <span class="tok-comment">// what to check. Otherwise, only the common name is checked.</span>
</span>
<span class="line" id="L301">        <span class="tok-kw">const</span> subject_alt_name = parsed_subject.subjectAltName();</span>
<span class="line" id="L302">        <span class="tok-kw">if</span> (subject_alt_name.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L303">            <span class="tok-kw">if</span> (checkHostName(host_name, parsed_subject.commonName())) {</span>
<span class="line" id="L304">                <span class="tok-kw">return</span>;</span>
<span class="line" id="L305">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L306">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateHostMismatch;</span>
<span class="line" id="L307">            }</span>
<span class="line" id="L308">        }</span>
<span class="line" id="L309"></span>
<span class="line" id="L310">        <span class="tok-kw">const</span> general_names = <span class="tok-kw">try</span> der.Element.parse(subject_alt_name, <span class="tok-number">0</span>);</span>
<span class="line" id="L311">        <span class="tok-kw">var</span> name_i = general_names.slice.start;</span>
<span class="line" id="L312">        <span class="tok-kw">while</span> (name_i &lt; general_names.slice.end) {</span>
<span class="line" id="L313">            <span class="tok-kw">const</span> general_name = <span class="tok-kw">try</span> der.Element.parse(subject_alt_name, name_i);</span>
<span class="line" id="L314">            name_i = general_name.slice.end;</span>
<span class="line" id="L315">            <span class="tok-kw">switch</span> (<span class="tok-builtin">@as</span>(GeneralNameTag, <span class="tok-builtin">@enumFromInt</span>(<span class="tok-builtin">@intFromEnum</span>(general_name.identifier.tag)))) {</span>
<span class="line" id="L316">                .dNSName =&gt; {</span>
<span class="line" id="L317">                    <span class="tok-kw">const</span> dns_name = subject_alt_name[general_name.slice.start..general_name.slice.end];</span>
<span class="line" id="L318">                    <span class="tok-kw">if</span> (checkHostName(host_name, dns_name)) <span class="tok-kw">return</span>;</span>
<span class="line" id="L319">                },</span>
<span class="line" id="L320">                <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L321">            }</span>
<span class="line" id="L322">        }</span>
<span class="line" id="L323"></span>
<span class="line" id="L324">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateHostMismatch;</span>
<span class="line" id="L325">    }</span>
<span class="line" id="L326"></span>
<span class="line" id="L327">    <span class="tok-comment">// Check hostname according to RFC2818 specification:</span>
</span>
<span class="line" id="L328">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L329">    <span class="tok-comment">// If more than one identity of a given type is present in</span>
</span>
<span class="line" id="L330">    <span class="tok-comment">// the certificate (e.g., more than one DNSName name, a match in any one</span>
</span>
<span class="line" id="L331">    <span class="tok-comment">// of the set is considered acceptable.) Names may contain the wildcard</span>
</span>
<span class="line" id="L332">    <span class="tok-comment">// character * which is considered to match any single domain name</span>
</span>
<span class="line" id="L333">    <span class="tok-comment">// component or component fragment. E.g., *.a.com matches foo.a.com but</span>
</span>
<span class="line" id="L334">    <span class="tok-comment">// not bar.foo.a.com. f*.com matches foo.com but not bar.com.</span>
</span>
<span class="line" id="L335">    <span class="tok-kw">fn</span> <span class="tok-fn">checkHostName</span>(host_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, dns_name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L336">        <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, dns_name, host_name)) {</span>
<span class="line" id="L337">            <span class="tok-kw">return</span> <span class="tok-null">true</span>; <span class="tok-comment">// exact match</span>
</span>
<span class="line" id="L338">        }</span>
<span class="line" id="L339"></span>
<span class="line" id="L340">        <span class="tok-kw">var</span> it_host = std.mem.splitScalar(<span class="tok-type">u8</span>, host_name, <span class="tok-str">'.'</span>);</span>
<span class="line" id="L341">        <span class="tok-kw">var</span> it_dns = std.mem.splitScalar(<span class="tok-type">u8</span>, dns_name, <span class="tok-str">'.'</span>);</span>
<span class="line" id="L342"></span>
<span class="line" id="L343">        <span class="tok-kw">const</span> len_match = <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L344">            <span class="tok-kw">const</span> host = it_host.next();</span>
<span class="line" id="L345">            <span class="tok-kw">const</span> dns = it_dns.next();</span>
<span class="line" id="L346"></span>
<span class="line" id="L347">            <span class="tok-kw">if</span> (host == <span class="tok-null">null</span> <span class="tok-kw">or</span> dns == <span class="tok-null">null</span>) {</span>
<span class="line" id="L348">                <span class="tok-kw">break</span> host == <span class="tok-null">null</span> <span class="tok-kw">and</span> dns == <span class="tok-null">null</span>;</span>
<span class="line" id="L349">            }</span>
<span class="line" id="L350"></span>
<span class="line" id="L351">            <span class="tok-comment">// If not a wildcard and they dont</span>
</span>
<span class="line" id="L352">            <span class="tok-comment">// match then there is no match.</span>
</span>
<span class="line" id="L353">            <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, dns.?, <span class="tok-str">&quot;*&quot;</span>) == <span class="tok-null">false</span> <span class="tok-kw">and</span> mem.eql(<span class="tok-type">u8</span>, dns.?, host.?) == <span class="tok-null">false</span>) {</span>
<span class="line" id="L354">                <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L355">            }</span>
<span class="line" id="L356">        };</span>
<span class="line" id="L357"></span>
<span class="line" id="L358">        <span class="tok-comment">// If the components are not the same</span>
</span>
<span class="line" id="L359">        <span class="tok-comment">// length then there is no match.</span>
</span>
<span class="line" id="L360">        <span class="tok-kw">return</span> len_match;</span>
<span class="line" id="L361">    }</span>
<span class="line" id="L362">};</span>
<span class="line" id="L363"></span>
<span class="line" id="L364"><span class="tok-kw">test</span> <span class="tok-str">&quot;Parsed.checkHostName&quot;</span> {</span>
<span class="line" id="L365">    <span class="tok-kw">const</span> expectEqual = std.testing.expectEqual;</span>
<span class="line" id="L366"></span>
<span class="line" id="L367">    <span class="tok-kw">try</span> expectEqual(<span class="tok-null">true</span>, Parsed.checkHostName(<span class="tok-str">&quot;ziglang.org&quot;</span>, <span class="tok-str">&quot;ziglang.org&quot;</span>));</span>
<span class="line" id="L368">    <span class="tok-kw">try</span> expectEqual(<span class="tok-null">true</span>, Parsed.checkHostName(<span class="tok-str">&quot;bar.ziglang.org&quot;</span>, <span class="tok-str">&quot;*.ziglang.org&quot;</span>));</span>
<span class="line" id="L369">    <span class="tok-kw">try</span> expectEqual(<span class="tok-null">false</span>, Parsed.checkHostName(<span class="tok-str">&quot;foo.bar.ziglang.org&quot;</span>, <span class="tok-str">&quot;*.ziglang.org&quot;</span>));</span>
<span class="line" id="L370">    <span class="tok-kw">try</span> expectEqual(<span class="tok-null">false</span>, Parsed.checkHostName(<span class="tok-str">&quot;ziglang.org&quot;</span>, <span class="tok-str">&quot;zig*.org&quot;</span>));</span>
<span class="line" id="L371">    <span class="tok-kw">try</span> expectEqual(<span class="tok-null">false</span>, Parsed.checkHostName(<span class="tok-str">&quot;lang.org&quot;</span>, <span class="tok-str">&quot;zig*.org&quot;</span>));</span>
<span class="line" id="L372">}</span>
<span class="line" id="L373"></span>
<span class="line" id="L374"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseError = der.Element.ParseElementError || ParseVersionError || ParseTimeError || ParseEnumError || ParseBitStringError;</span>
<span class="line" id="L375"></span>
<span class="line" id="L376"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parse</span>(cert: Certificate) ParseError!Parsed {</span>
<span class="line" id="L377">    <span class="tok-kw">const</span> cert_bytes = cert.buffer;</span>
<span class="line" id="L378">    <span class="tok-kw">const</span> certificate = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, cert.index);</span>
<span class="line" id="L379">    <span class="tok-kw">const</span> tbs_certificate = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, certificate.slice.start);</span>
<span class="line" id="L380">    <span class="tok-kw">const</span> version_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, tbs_certificate.slice.start);</span>
<span class="line" id="L381">    <span class="tok-kw">const</span> version = <span class="tok-kw">try</span> parseVersion(cert_bytes, version_elem);</span>
<span class="line" id="L382">    <span class="tok-kw">const</span> serial_number = <span class="tok-kw">if</span> (<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@bitCast</span>(version_elem.identifier)) == <span class="tok-number">0xa0</span>)</span>
<span class="line" id="L383">        <span class="tok-kw">try</span> der.Element.parse(cert_bytes, version_elem.slice.end)</span>
<span class="line" id="L384">    <span class="tok-kw">else</span></span>
<span class="line" id="L385">        version_elem;</span>
<span class="line" id="L386">    <span class="tok-comment">// RFC 5280, section 4.1.2.3:</span>
</span>
<span class="line" id="L387">    <span class="tok-comment">// &quot;This field MUST contain the same algorithm identifier as</span>
</span>
<span class="line" id="L388">    <span class="tok-comment">// the signatureAlgorithm field in the sequence Certificate.&quot;</span>
</span>
<span class="line" id="L389">    <span class="tok-kw">const</span> tbs_signature = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, serial_number.slice.end);</span>
<span class="line" id="L390">    <span class="tok-kw">const</span> issuer = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, tbs_signature.slice.end);</span>
<span class="line" id="L391">    <span class="tok-kw">const</span> validity = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, issuer.slice.end);</span>
<span class="line" id="L392">    <span class="tok-kw">const</span> not_before = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, validity.slice.start);</span>
<span class="line" id="L393">    <span class="tok-kw">const</span> not_before_utc = <span class="tok-kw">try</span> parseTime(cert, not_before);</span>
<span class="line" id="L394">    <span class="tok-kw">const</span> not_after = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, not_before.slice.end);</span>
<span class="line" id="L395">    <span class="tok-kw">const</span> not_after_utc = <span class="tok-kw">try</span> parseTime(cert, not_after);</span>
<span class="line" id="L396">    <span class="tok-kw">const</span> subject = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, validity.slice.end);</span>
<span class="line" id="L397"></span>
<span class="line" id="L398">    <span class="tok-kw">const</span> pub_key_info = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, subject.slice.end);</span>
<span class="line" id="L399">    <span class="tok-kw">const</span> pub_key_signature_algorithm = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, pub_key_info.slice.start);</span>
<span class="line" id="L400">    <span class="tok-kw">const</span> pub_key_algo_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, pub_key_signature_algorithm.slice.start);</span>
<span class="line" id="L401">    <span class="tok-kw">const</span> pub_key_algo_tag = <span class="tok-kw">try</span> parseAlgorithmCategory(cert_bytes, pub_key_algo_elem);</span>
<span class="line" id="L402">    <span class="tok-kw">var</span> pub_key_algo: Parsed.PubKeyAlgo = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L403">    <span class="tok-kw">switch</span> (pub_key_algo_tag) {</span>
<span class="line" id="L404">        .rsaEncryption =&gt; {</span>
<span class="line" id="L405">            pub_key_algo = .{ .rsaEncryption = {} };</span>
<span class="line" id="L406">        },</span>
<span class="line" id="L407">        .X9_62_id_ecPublicKey =&gt; {</span>
<span class="line" id="L408">            <span class="tok-comment">// RFC 5480 Section 2.1.1.1 Named Curve</span>
</span>
<span class="line" id="L409">            <span class="tok-comment">// ECParameters ::= CHOICE {</span>
</span>
<span class="line" id="L410">            <span class="tok-comment">//   namedCurve         OBJECT IDENTIFIER</span>
</span>
<span class="line" id="L411">            <span class="tok-comment">//   -- implicitCurve   NULL</span>
</span>
<span class="line" id="L412">            <span class="tok-comment">//   -- specifiedCurve  SpecifiedECDomain</span>
</span>
<span class="line" id="L413">            <span class="tok-comment">// }</span>
</span>
<span class="line" id="L414">            <span class="tok-kw">const</span> params_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, pub_key_algo_elem.slice.end);</span>
<span class="line" id="L415">            <span class="tok-kw">const</span> named_curve = <span class="tok-kw">try</span> parseNamedCurve(cert_bytes, params_elem);</span>
<span class="line" id="L416">            pub_key_algo = .{ .X9_62_id_ecPublicKey = named_curve };</span>
<span class="line" id="L417">        },</span>
<span class="line" id="L418">    }</span>
<span class="line" id="L419">    <span class="tok-kw">const</span> pub_key_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, pub_key_signature_algorithm.slice.end);</span>
<span class="line" id="L420">    <span class="tok-kw">const</span> pub_key = <span class="tok-kw">try</span> parseBitString(cert, pub_key_elem);</span>
<span class="line" id="L421"></span>
<span class="line" id="L422">    <span class="tok-kw">var</span> common_name = der.Element.Slice.empty;</span>
<span class="line" id="L423">    <span class="tok-kw">var</span> name_i = subject.slice.start;</span>
<span class="line" id="L424">    <span class="tok-kw">while</span> (name_i &lt; subject.slice.end) {</span>
<span class="line" id="L425">        <span class="tok-kw">const</span> rdn = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, name_i);</span>
<span class="line" id="L426">        <span class="tok-kw">var</span> rdn_i = rdn.slice.start;</span>
<span class="line" id="L427">        <span class="tok-kw">while</span> (rdn_i &lt; rdn.slice.end) {</span>
<span class="line" id="L428">            <span class="tok-kw">const</span> atav = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, rdn_i);</span>
<span class="line" id="L429">            <span class="tok-kw">var</span> atav_i = atav.slice.start;</span>
<span class="line" id="L430">            <span class="tok-kw">while</span> (atav_i &lt; atav.slice.end) {</span>
<span class="line" id="L431">                <span class="tok-kw">const</span> ty_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, atav_i);</span>
<span class="line" id="L432">                <span class="tok-kw">const</span> val = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, ty_elem.slice.end);</span>
<span class="line" id="L433">                atav_i = val.slice.end;</span>
<span class="line" id="L434">                <span class="tok-kw">const</span> ty = parseAttribute(cert_bytes, ty_elem) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L435">                    <span class="tok-kw">error</span>.CertificateHasUnrecognizedObjectId =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L436">                    <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L437">                };</span>
<span class="line" id="L438">                <span class="tok-kw">switch</span> (ty) {</span>
<span class="line" id="L439">                    .commonName =&gt; common_name = val.slice,</span>
<span class="line" id="L440">                    <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L441">                }</span>
<span class="line" id="L442">            }</span>
<span class="line" id="L443">            rdn_i = atav.slice.end;</span>
<span class="line" id="L444">        }</span>
<span class="line" id="L445">        name_i = rdn.slice.end;</span>
<span class="line" id="L446">    }</span>
<span class="line" id="L447"></span>
<span class="line" id="L448">    <span class="tok-kw">const</span> sig_algo = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, tbs_certificate.slice.end);</span>
<span class="line" id="L449">    <span class="tok-kw">const</span> algo_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, sig_algo.slice.start);</span>
<span class="line" id="L450">    <span class="tok-kw">const</span> signature_algorithm = <span class="tok-kw">try</span> parseAlgorithm(cert_bytes, algo_elem);</span>
<span class="line" id="L451">    <span class="tok-kw">const</span> sig_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, sig_algo.slice.end);</span>
<span class="line" id="L452">    <span class="tok-kw">const</span> signature = <span class="tok-kw">try</span> parseBitString(cert, sig_elem);</span>
<span class="line" id="L453"></span>
<span class="line" id="L454">    <span class="tok-comment">// Extensions</span>
</span>
<span class="line" id="L455">    <span class="tok-kw">var</span> subject_alt_name_slice = der.Element.Slice.empty;</span>
<span class="line" id="L456">    ext: {</span>
<span class="line" id="L457">        <span class="tok-kw">if</span> (version == .v1)</span>
<span class="line" id="L458">            <span class="tok-kw">break</span> :ext;</span>
<span class="line" id="L459"></span>
<span class="line" id="L460">        <span class="tok-kw">if</span> (pub_key_info.slice.end &gt;= tbs_certificate.slice.end)</span>
<span class="line" id="L461">            <span class="tok-kw">break</span> :ext;</span>
<span class="line" id="L462"></span>
<span class="line" id="L463">        <span class="tok-kw">const</span> outer_extensions = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, pub_key_info.slice.end);</span>
<span class="line" id="L464">        <span class="tok-kw">if</span> (outer_extensions.identifier.tag != .bitstring)</span>
<span class="line" id="L465">            <span class="tok-kw">break</span> :ext;</span>
<span class="line" id="L466"></span>
<span class="line" id="L467">        <span class="tok-kw">const</span> extensions = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, outer_extensions.slice.start);</span>
<span class="line" id="L468"></span>
<span class="line" id="L469">        <span class="tok-kw">var</span> ext_i = extensions.slice.start;</span>
<span class="line" id="L470">        <span class="tok-kw">while</span> (ext_i &lt; extensions.slice.end) {</span>
<span class="line" id="L471">            <span class="tok-kw">const</span> extension = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, ext_i);</span>
<span class="line" id="L472">            ext_i = extension.slice.end;</span>
<span class="line" id="L473">            <span class="tok-kw">const</span> oid_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, extension.slice.start);</span>
<span class="line" id="L474">            <span class="tok-kw">const</span> ext_id = parseExtensionId(cert_bytes, oid_elem) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L475">                <span class="tok-kw">error</span>.CertificateHasUnrecognizedObjectId =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L476">                <span class="tok-kw">else</span> =&gt; |e| <span class="tok-kw">return</span> e,</span>
<span class="line" id="L477">            };</span>
<span class="line" id="L478">            <span class="tok-kw">const</span> critical_elem = <span class="tok-kw">try</span> der.Element.parse(cert_bytes, oid_elem.slice.end);</span>
<span class="line" id="L479">            <span class="tok-kw">const</span> ext_bytes_elem = <span class="tok-kw">if</span> (critical_elem.identifier.tag != .boolean)</span>
<span class="line" id="L480">                critical_elem</span>
<span class="line" id="L481">            <span class="tok-kw">else</span></span>
<span class="line" id="L482">                <span class="tok-kw">try</span> der.Element.parse(cert_bytes, critical_elem.slice.end);</span>
<span class="line" id="L483">            <span class="tok-kw">switch</span> (ext_id) {</span>
<span class="line" id="L484">                .subject_alt_name =&gt; subject_alt_name_slice = ext_bytes_elem.slice,</span>
<span class="line" id="L485">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">continue</span>,</span>
<span class="line" id="L486">            }</span>
<span class="line" id="L487">        }</span>
<span class="line" id="L488">    }</span>
<span class="line" id="L489"></span>
<span class="line" id="L490">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L491">        .certificate = cert,</span>
<span class="line" id="L492">        .common_name_slice = common_name,</span>
<span class="line" id="L493">        .issuer_slice = issuer.slice,</span>
<span class="line" id="L494">        .subject_slice = subject.slice,</span>
<span class="line" id="L495">        .signature_slice = signature,</span>
<span class="line" id="L496">        .signature_algorithm = signature_algorithm,</span>
<span class="line" id="L497">        .message_slice = .{ .start = certificate.slice.start, .end = tbs_certificate.slice.end },</span>
<span class="line" id="L498">        .pub_key_algo = pub_key_algo,</span>
<span class="line" id="L499">        .pub_key_slice = pub_key,</span>
<span class="line" id="L500">        .validity = .{</span>
<span class="line" id="L501">            .not_before = not_before_utc,</span>
<span class="line" id="L502">            .not_after = not_after_utc,</span>
<span class="line" id="L503">        },</span>
<span class="line" id="L504">        .subject_alt_name_slice = subject_alt_name_slice,</span>
<span class="line" id="L505">        .version = version,</span>
<span class="line" id="L506">    };</span>
<span class="line" id="L507">}</span>
<span class="line" id="L508"></span>
<span class="line" id="L509"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">verify</span>(subject: Certificate, issuer: Certificate, now_sec: <span class="tok-type">i64</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L510">    <span class="tok-kw">const</span> parsed_subject = <span class="tok-kw">try</span> subject.parse();</span>
<span class="line" id="L511">    <span class="tok-kw">const</span> parsed_issuer = <span class="tok-kw">try</span> issuer.parse();</span>
<span class="line" id="L512">    <span class="tok-kw">return</span> parsed_subject.verify(parsed_issuer, now_sec);</span>
<span class="line" id="L513">}</span>
<span class="line" id="L514"></span>
<span class="line" id="L515"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">contents</span>(cert: Certificate, elem: der.Element) []<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L516">    <span class="tok-kw">return</span> cert.buffer[elem.slice.start..elem.slice.end];</span>
<span class="line" id="L517">}</span>
<span class="line" id="L518"></span>
<span class="line" id="L519"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseBitStringError = <span class="tok-kw">error</span>{ CertificateFieldHasWrongDataType, CertificateHasInvalidBitString };</span>
<span class="line" id="L520"></span>
<span class="line" id="L521"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseBitString</span>(cert: Certificate, elem: der.Element) !der.Element.Slice {</span>
<span class="line" id="L522">    <span class="tok-kw">if</span> (elem.identifier.tag != .bitstring) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType;</span>
<span class="line" id="L523">    <span class="tok-kw">if</span> (cert.buffer[elem.slice.start] != <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateHasInvalidBitString;</span>
<span class="line" id="L524">    <span class="tok-kw">return</span> .{ .start = elem.slice.start + <span class="tok-number">1</span>, .end = elem.slice.end };</span>
<span class="line" id="L525">}</span>
<span class="line" id="L526"></span>
<span class="line" id="L527"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseTimeError = <span class="tok-kw">error</span>{ CertificateTimeInvalid, CertificateFieldHasWrongDataType };</span>
<span class="line" id="L528"></span>
<span class="line" id="L529"><span class="tok-comment">/// Returns number of seconds since epoch.</span></span>
<span class="line" id="L530"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseTime</span>(cert: Certificate, elem: der.Element) ParseTimeError!<span class="tok-type">u64</span> {</span>
<span class="line" id="L531">    <span class="tok-kw">const</span> bytes = cert.contents(elem);</span>
<span class="line" id="L532">    <span class="tok-kw">switch</span> (elem.identifier.tag) {</span>
<span class="line" id="L533">        .utc_time =&gt; {</span>
<span class="line" id="L534">            <span class="tok-comment">// Example: &quot;YYMMDD000000Z&quot;</span>
</span>
<span class="line" id="L535">            <span class="tok-kw">if</span> (bytes.len != <span class="tok-number">13</span>)</span>
<span class="line" id="L536">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L537">            <span class="tok-kw">if</span> (bytes[<span class="tok-number">12</span>] != <span class="tok-str">'Z'</span>)</span>
<span class="line" id="L538">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L539"></span>
<span class="line" id="L540">            <span class="tok-kw">return</span> Date.toSeconds(.{</span>
<span class="line" id="L541">                .year = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">2000</span>) + <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">0</span>..<span class="tok-number">2</span>], <span class="tok-number">0</span>, <span class="tok-number">99</span>),</span>
<span class="line" id="L542">                .month = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">2</span>..<span class="tok-number">4</span>], <span class="tok-number">1</span>, <span class="tok-number">12</span>),</span>
<span class="line" id="L543">                .day = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">4</span>..<span class="tok-number">6</span>], <span class="tok-number">1</span>, <span class="tok-number">31</span>),</span>
<span class="line" id="L544">                .hour = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">6</span>..<span class="tok-number">8</span>], <span class="tok-number">0</span>, <span class="tok-number">23</span>),</span>
<span class="line" id="L545">                .minute = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">8</span>..<span class="tok-number">10</span>], <span class="tok-number">0</span>, <span class="tok-number">59</span>),</span>
<span class="line" id="L546">                .second = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">10</span>..<span class="tok-number">12</span>], <span class="tok-number">0</span>, <span class="tok-number">59</span>),</span>
<span class="line" id="L547">            });</span>
<span class="line" id="L548">        },</span>
<span class="line" id="L549">        .generalized_time =&gt; {</span>
<span class="line" id="L550">            <span class="tok-comment">// Examples:</span>
</span>
<span class="line" id="L551">            <span class="tok-comment">// &quot;19920521000000Z&quot;</span>
</span>
<span class="line" id="L552">            <span class="tok-comment">// &quot;19920622123421Z&quot;</span>
</span>
<span class="line" id="L553">            <span class="tok-comment">// &quot;19920722132100.3Z&quot;</span>
</span>
<span class="line" id="L554">            <span class="tok-kw">if</span> (bytes.len &lt; <span class="tok-number">15</span>)</span>
<span class="line" id="L555">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L556">            <span class="tok-kw">return</span> Date.toSeconds(.{</span>
<span class="line" id="L557">                .year = <span class="tok-kw">try</span> parseYear4(bytes[<span class="tok-number">0</span>..<span class="tok-number">4</span>]),</span>
<span class="line" id="L558">                .month = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">4</span>..<span class="tok-number">6</span>], <span class="tok-number">1</span>, <span class="tok-number">12</span>),</span>
<span class="line" id="L559">                .day = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">6</span>..<span class="tok-number">8</span>], <span class="tok-number">1</span>, <span class="tok-number">31</span>),</span>
<span class="line" id="L560">                .hour = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">8</span>..<span class="tok-number">10</span>], <span class="tok-number">0</span>, <span class="tok-number">23</span>),</span>
<span class="line" id="L561">                .minute = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">10</span>..<span class="tok-number">12</span>], <span class="tok-number">0</span>, <span class="tok-number">59</span>),</span>
<span class="line" id="L562">                .second = <span class="tok-kw">try</span> parseTimeDigits(bytes[<span class="tok-number">12</span>..<span class="tok-number">14</span>], <span class="tok-number">0</span>, <span class="tok-number">59</span>),</span>
<span class="line" id="L563">            });</span>
<span class="line" id="L564">        },</span>
<span class="line" id="L565">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType,</span>
<span class="line" id="L566">    }</span>
<span class="line" id="L567">}</span>
<span class="line" id="L568"></span>
<span class="line" id="L569"><span class="tok-kw">const</span> Date = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L570">    <span class="tok-comment">/// example: 1999</span></span>
<span class="line" id="L571">    year: <span class="tok-type">u16</span>,</span>
<span class="line" id="L572">    <span class="tok-comment">/// range: 1 to 12</span></span>
<span class="line" id="L573">    month: <span class="tok-type">u8</span>,</span>
<span class="line" id="L574">    <span class="tok-comment">/// range: 1 to 31</span></span>
<span class="line" id="L575">    day: <span class="tok-type">u8</span>,</span>
<span class="line" id="L576">    <span class="tok-comment">/// range: 0 to 59</span></span>
<span class="line" id="L577">    hour: <span class="tok-type">u8</span>,</span>
<span class="line" id="L578">    <span class="tok-comment">/// range: 0 to 59</span></span>
<span class="line" id="L579">    minute: <span class="tok-type">u8</span>,</span>
<span class="line" id="L580">    <span class="tok-comment">/// range: 0 to 59</span></span>
<span class="line" id="L581">    second: <span class="tok-type">u8</span>,</span>
<span class="line" id="L582"></span>
<span class="line" id="L583">    <span class="tok-comment">/// Convert to number of seconds since epoch.</span></span>
<span class="line" id="L584">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toSeconds</span>(date: Date) <span class="tok-type">u64</span> {</span>
<span class="line" id="L585">        <span class="tok-kw">var</span> sec: <span class="tok-type">u64</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L586"></span>
<span class="line" id="L587">        {</span>
<span class="line" id="L588">            <span class="tok-kw">var</span> year: <span class="tok-type">u16</span> = <span class="tok-number">1970</span>;</span>
<span class="line" id="L589">            <span class="tok-kw">while</span> (year &lt; date.year) : (year += <span class="tok-number">1</span>) {</span>
<span class="line" id="L590">                <span class="tok-kw">const</span> days: <span class="tok-type">u64</span> = std.time.epoch.getDaysInYear(year);</span>
<span class="line" id="L591">                sec += days * std.time.epoch.secs_per_day;</span>
<span class="line" id="L592">            }</span>
<span class="line" id="L593">        }</span>
<span class="line" id="L594"></span>
<span class="line" id="L595">        {</span>
<span class="line" id="L596">            <span class="tok-kw">const</span> is_leap = std.time.epoch.isLeapYear(date.year);</span>
<span class="line" id="L597">            <span class="tok-kw">var</span> month: <span class="tok-type">u4</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L598">            <span class="tok-kw">while</span> (month &lt; date.month) : (month += <span class="tok-number">1</span>) {</span>
<span class="line" id="L599">                <span class="tok-kw">const</span> days: <span class="tok-type">u64</span> = std.time.epoch.getDaysInMonth(</span>
<span class="line" id="L600">                    <span class="tok-builtin">@as</span>(std.time.epoch.YearLeapKind, <span class="tok-builtin">@enumFromInt</span>(<span class="tok-builtin">@intFromBool</span>(is_leap))),</span>
<span class="line" id="L601">                    <span class="tok-builtin">@as</span>(std.time.epoch.Month, <span class="tok-builtin">@enumFromInt</span>(month)),</span>
<span class="line" id="L602">                );</span>
<span class="line" id="L603">                sec += days * std.time.epoch.secs_per_day;</span>
<span class="line" id="L604">            }</span>
<span class="line" id="L605">        }</span>
<span class="line" id="L606"></span>
<span class="line" id="L607">        sec += (date.day - <span class="tok-number">1</span>) * <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, std.time.epoch.secs_per_day);</span>
<span class="line" id="L608">        sec += date.hour * <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-number">60</span> * <span class="tok-number">60</span>);</span>
<span class="line" id="L609">        sec += date.minute * <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-number">60</span>);</span>
<span class="line" id="L610">        sec += date.second;</span>
<span class="line" id="L611"></span>
<span class="line" id="L612">        <span class="tok-kw">return</span> sec;</span>
<span class="line" id="L613">    }</span>
<span class="line" id="L614">};</span>
<span class="line" id="L615"></span>
<span class="line" id="L616"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseTimeDigits</span>(text: *<span class="tok-kw">const</span> [<span class="tok-number">2</span>]<span class="tok-type">u8</span>, min: <span class="tok-type">u8</span>, max: <span class="tok-type">u8</span>) !<span class="tok-type">u8</span> {</span>
<span class="line" id="L617">    <span class="tok-kw">const</span> nn: <span class="tok-builtin">@Vector</span>(<span class="tok-number">2</span>, <span class="tok-type">u16</span>) = .{ text[<span class="tok-number">0</span>], text[<span class="tok-number">1</span>] };</span>
<span class="line" id="L618">    <span class="tok-kw">const</span> zero: <span class="tok-builtin">@Vector</span>(<span class="tok-number">2</span>, <span class="tok-type">u16</span>) = .{ <span class="tok-str">'0'</span>, <span class="tok-str">'0'</span> };</span>
<span class="line" id="L619">    <span class="tok-kw">const</span> mm: <span class="tok-builtin">@Vector</span>(<span class="tok-number">2</span>, <span class="tok-type">u16</span>) = .{ <span class="tok-number">10</span>, <span class="tok-number">1</span> };</span>
<span class="line" id="L620">    <span class="tok-kw">const</span> result = <span class="tok-builtin">@reduce</span>(.Add, (nn -% zero) *% mm);</span>
<span class="line" id="L621">    <span class="tok-kw">if</span> (result &lt; min) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L622">    <span class="tok-kw">if</span> (result &gt; max) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L623">    <span class="tok-kw">return</span> <span class="tok-builtin">@truncate</span>(result);</span>
<span class="line" id="L624">}</span>
<span class="line" id="L625"></span>
<span class="line" id="L626"><span class="tok-kw">test</span> parseTimeDigits {</span>
<span class="line" id="L627">    <span class="tok-kw">const</span> expectEqual = std.testing.expectEqual;</span>
<span class="line" id="L628">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">0</span>), <span class="tok-kw">try</span> parseTimeDigits(<span class="tok-str">&quot;00&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">99</span>));</span>
<span class="line" id="L629">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">99</span>), <span class="tok-kw">try</span> parseTimeDigits(<span class="tok-str">&quot;99&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">99</span>));</span>
<span class="line" id="L630">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">42</span>), <span class="tok-kw">try</span> parseTimeDigits(<span class="tok-str">&quot;42&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">99</span>));</span>
<span class="line" id="L631"></span>
<span class="line" id="L632">    <span class="tok-kw">const</span> expectError = std.testing.expectError;</span>
<span class="line" id="L633">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseTimeDigits(<span class="tok-str">&quot;13&quot;</span>, <span class="tok-number">1</span>, <span class="tok-number">12</span>));</span>
<span class="line" id="L634">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseTimeDigits(<span class="tok-str">&quot;00&quot;</span>, <span class="tok-number">1</span>, <span class="tok-number">12</span>));</span>
<span class="line" id="L635">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseTimeDigits(<span class="tok-str">&quot;Di&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">99</span>));</span>
<span class="line" id="L636">}</span>
<span class="line" id="L637"></span>
<span class="line" id="L638"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseYear4</span>(text: *<span class="tok-kw">const</span> [<span class="tok-number">4</span>]<span class="tok-type">u8</span>) !<span class="tok-type">u16</span> {</span>
<span class="line" id="L639">    <span class="tok-kw">const</span> nnnn: <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">u32</span>) = .{ text[<span class="tok-number">0</span>], text[<span class="tok-number">1</span>], text[<span class="tok-number">2</span>], text[<span class="tok-number">3</span>] };</span>
<span class="line" id="L640">    <span class="tok-kw">const</span> zero: <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">u32</span>) = .{ <span class="tok-str">'0'</span>, <span class="tok-str">'0'</span>, <span class="tok-str">'0'</span>, <span class="tok-str">'0'</span> };</span>
<span class="line" id="L641">    <span class="tok-kw">const</span> mmmm: <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span>, <span class="tok-type">u32</span>) = .{ <span class="tok-number">1000</span>, <span class="tok-number">100</span>, <span class="tok-number">10</span>, <span class="tok-number">1</span> };</span>
<span class="line" id="L642">    <span class="tok-kw">const</span> result = <span class="tok-builtin">@reduce</span>(.Add, (nnnn -% zero) *% mmmm);</span>
<span class="line" id="L643">    <span class="tok-kw">if</span> (result &gt; <span class="tok-number">9999</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateTimeInvalid;</span>
<span class="line" id="L644">    <span class="tok-kw">return</span> <span class="tok-builtin">@truncate</span>(result);</span>
<span class="line" id="L645">}</span>
<span class="line" id="L646"></span>
<span class="line" id="L647"><span class="tok-kw">test</span> parseYear4 {</span>
<span class="line" id="L648">    <span class="tok-kw">const</span> expectEqual = std.testing.expectEqual;</span>
<span class="line" id="L649">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">0</span>), <span class="tok-kw">try</span> parseYear4(<span class="tok-str">&quot;0000&quot;</span>));</span>
<span class="line" id="L650">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">9999</span>), <span class="tok-kw">try</span> parseYear4(<span class="tok-str">&quot;9999&quot;</span>));</span>
<span class="line" id="L651">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-number">1988</span>), <span class="tok-kw">try</span> parseYear4(<span class="tok-str">&quot;1988&quot;</span>));</span>
<span class="line" id="L652"></span>
<span class="line" id="L653">    <span class="tok-kw">const</span> expectError = std.testing.expectError;</span>
<span class="line" id="L654">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseYear4(<span class="tok-str">&quot;999b&quot;</span>));</span>
<span class="line" id="L655">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseYear4(<span class="tok-str">&quot;crap&quot;</span>));</span>
<span class="line" id="L656">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.CertificateTimeInvalid, parseYear4(<span class="tok-str">&quot;r:bQ&quot;</span>));</span>
<span class="line" id="L657">}</span>
<span class="line" id="L658"></span>
<span class="line" id="L659"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseAlgorithm</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!Algorithm {</span>
<span class="line" id="L660">    <span class="tok-kw">return</span> parseEnum(Algorithm, bytes, element);</span>
<span class="line" id="L661">}</span>
<span class="line" id="L662"></span>
<span class="line" id="L663"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseAlgorithmCategory</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!AlgorithmCategory {</span>
<span class="line" id="L664">    <span class="tok-kw">return</span> parseEnum(AlgorithmCategory, bytes, element);</span>
<span class="line" id="L665">}</span>
<span class="line" id="L666"></span>
<span class="line" id="L667"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseAttribute</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!Attribute {</span>
<span class="line" id="L668">    <span class="tok-kw">return</span> parseEnum(Attribute, bytes, element);</span>
<span class="line" id="L669">}</span>
<span class="line" id="L670"></span>
<span class="line" id="L671"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseNamedCurve</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!NamedCurve {</span>
<span class="line" id="L672">    <span class="tok-kw">return</span> parseEnum(NamedCurve, bytes, element);</span>
<span class="line" id="L673">}</span>
<span class="line" id="L674"></span>
<span class="line" id="L675"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseExtensionId</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!ExtensionId {</span>
<span class="line" id="L676">    <span class="tok-kw">return</span> parseEnum(ExtensionId, bytes, element);</span>
<span class="line" id="L677">}</span>
<span class="line" id="L678"></span>
<span class="line" id="L679"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseEnumError = <span class="tok-kw">error</span>{ CertificateFieldHasWrongDataType, CertificateHasUnrecognizedObjectId };</span>
<span class="line" id="L680"></span>
<span class="line" id="L681"><span class="tok-kw">fn</span> <span class="tok-fn">parseEnum</span>(<span class="tok-kw">comptime</span> E: <span class="tok-type">type</span>, bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, element: der.Element) ParseEnumError!E {</span>
<span class="line" id="L682">    <span class="tok-kw">if</span> (element.identifier.tag != .object_identifier)</span>
<span class="line" id="L683">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType;</span>
<span class="line" id="L684">    <span class="tok-kw">const</span> oid_bytes = bytes[element.slice.start..element.slice.end];</span>
<span class="line" id="L685">    <span class="tok-kw">return</span> E.map.get(oid_bytes) <span class="tok-kw">orelse</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateHasUnrecognizedObjectId;</span>
<span class="line" id="L686">}</span>
<span class="line" id="L687"></span>
<span class="line" id="L688"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseVersionError = <span class="tok-kw">error</span>{ UnsupportedCertificateVersion, CertificateFieldHasInvalidLength };</span>
<span class="line" id="L689"></span>
<span class="line" id="L690"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseVersion</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, version_elem: der.Element) ParseVersionError!Version {</span>
<span class="line" id="L691">    <span class="tok-kw">if</span> (<span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@bitCast</span>(version_elem.identifier)) != <span class="tok-number">0xa0</span>)</span>
<span class="line" id="L692">        <span class="tok-kw">return</span> .v1;</span>
<span class="line" id="L693"></span>
<span class="line" id="L694">    <span class="tok-kw">if</span> (version_elem.slice.end - version_elem.slice.start != <span class="tok-number">3</span>)</span>
<span class="line" id="L695">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasInvalidLength;</span>
<span class="line" id="L696"></span>
<span class="line" id="L697">    <span class="tok-kw">const</span> encoded_version = bytes[version_elem.slice.start..version_elem.slice.end];</span>
<span class="line" id="L698"></span>
<span class="line" id="L699">    <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, encoded_version, <span class="tok-str">&quot;\x02\x01\x02&quot;</span>)) {</span>
<span class="line" id="L700">        <span class="tok-kw">return</span> .v3;</span>
<span class="line" id="L701">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, encoded_version, <span class="tok-str">&quot;\x02\x01\x01&quot;</span>)) {</span>
<span class="line" id="L702">        <span class="tok-kw">return</span> .v2;</span>
<span class="line" id="L703">    } <span class="tok-kw">else</span> <span class="tok-kw">if</span> (mem.eql(<span class="tok-type">u8</span>, encoded_version, <span class="tok-str">&quot;\x02\x01\x00&quot;</span>)) {</span>
<span class="line" id="L704">        <span class="tok-kw">return</span> .v1;</span>
<span class="line" id="L705">    }</span>
<span class="line" id="L706"></span>
<span class="line" id="L707">    <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnsupportedCertificateVersion;</span>
<span class="line" id="L708">}</span>
<span class="line" id="L709"></span>
<span class="line" id="L710"><span class="tok-kw">fn</span> <span class="tok-fn">verifyRsa</span>(</span>
<span class="line" id="L711">    <span class="tok-kw">comptime</span> Hash: <span class="tok-type">type</span>,</span>
<span class="line" id="L712">    message: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L713">    sig: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L714">    pub_key_algo: Parsed.PubKeyAlgo,</span>
<span class="line" id="L715">    pub_key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L716">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L717">    <span class="tok-kw">if</span> (pub_key_algo != .rsaEncryption) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureAlgorithmMismatch;</span>
<span class="line" id="L718">    <span class="tok-kw">const</span> pk_components = <span class="tok-kw">try</span> rsa.PublicKey.parseDer(pub_key);</span>
<span class="line" id="L719">    <span class="tok-kw">const</span> exponent = pk_components.exponent;</span>
<span class="line" id="L720">    <span class="tok-kw">const</span> modulus = pk_components.modulus;</span>
<span class="line" id="L721">    <span class="tok-kw">if</span> (exponent.len &gt; modulus.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L722">    <span class="tok-kw">if</span> (sig.len != modulus.len) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalidLength;</span>
<span class="line" id="L723"></span>
<span class="line" id="L724">    <span class="tok-kw">const</span> hash_der = <span class="tok-kw">switch</span> (Hash) {</span>
<span class="line" id="L725">        crypto.hash.Sha1 =&gt; [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L726">            <span class="tok-number">0x30</span>, <span class="tok-number">0x21</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x2b</span>, <span class="tok-number">0x0e</span>,</span>
<span class="line" id="L727">            <span class="tok-number">0x03</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x14</span>,</span>
<span class="line" id="L728">        },</span>
<span class="line" id="L729">        crypto.hash.sha2.Sha224 =&gt; [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L730">            <span class="tok-number">0x30</span>, <span class="tok-number">0x2d</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>,</span>
<span class="line" id="L731">            <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>,</span>
<span class="line" id="L732">            <span class="tok-number">0x00</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x1c</span>,</span>
<span class="line" id="L733">        },</span>
<span class="line" id="L734">        crypto.hash.sha2.Sha256 =&gt; [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L735">            <span class="tok-number">0x30</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>,</span>
<span class="line" id="L736">            <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x05</span>,</span>
<span class="line" id="L737">            <span class="tok-number">0x00</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x20</span>,</span>
<span class="line" id="L738">        },</span>
<span class="line" id="L739">        crypto.hash.sha2.Sha384 =&gt; [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L740">            <span class="tok-number">0x30</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>,</span>
<span class="line" id="L741">            <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x05</span>,</span>
<span class="line" id="L742">            <span class="tok-number">0x00</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x30</span>,</span>
<span class="line" id="L743">        },</span>
<span class="line" id="L744">        crypto.hash.sha2.Sha512 =&gt; [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L745">            <span class="tok-number">0x30</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x30</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0x86</span>,</span>
<span class="line" id="L746">            <span class="tok-number">0x48</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x05</span>,</span>
<span class="line" id="L747">            <span class="tok-number">0x00</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x40</span>,</span>
<span class="line" id="L748">        },</span>
<span class="line" id="L749">        <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;unreachable&quot;</span>),</span>
<span class="line" id="L750">    };</span>
<span class="line" id="L751"></span>
<span class="line" id="L752">    <span class="tok-kw">var</span> msg_hashed: [Hash.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L753">    Hash.hash(message, &amp;msg_hashed, .{});</span>
<span class="line" id="L754"></span>
<span class="line" id="L755">    <span class="tok-kw">switch</span> (modulus.len) {</span>
<span class="line" id="L756">        <span class="tok-kw">inline</span> <span class="tok-number">128</span>, <span class="tok-number">256</span>, <span class="tok-number">512</span> =&gt; |modulus_len| {</span>
<span class="line" id="L757">            <span class="tok-kw">const</span> ps_len = modulus_len - (hash_der.len + msg_hashed.len) - <span class="tok-number">3</span>;</span>
<span class="line" id="L758">            <span class="tok-kw">const</span> em: [modulus_len]<span class="tok-type">u8</span> =</span>
<span class="line" id="L759">                [<span class="tok-number">2</span>]<span class="tok-type">u8</span>{ <span class="tok-number">0</span>, <span class="tok-number">1</span> } ++</span>
<span class="line" id="L760">                ([<span class="tok-number">1</span>]<span class="tok-type">u8</span>{<span class="tok-number">0xff</span>} ** ps_len) ++</span>
<span class="line" id="L761">                [<span class="tok-number">1</span>]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ++</span>
<span class="line" id="L762">                hash_der ++</span>
<span class="line" id="L763">                msg_hashed;</span>
<span class="line" id="L764"></span>
<span class="line" id="L765">            <span class="tok-kw">const</span> public_key = rsa.PublicKey.fromBytes(exponent, modulus) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid;</span>
<span class="line" id="L766">            <span class="tok-kw">const</span> em_dec = rsa.encrypt(modulus_len, sig[<span class="tok-number">0</span>..modulus_len].*, public_key) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L767">                <span class="tok-kw">error</span>.MessageTooLong =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L768">            };</span>
<span class="line" id="L769"></span>
<span class="line" id="L770">            <span class="tok-kw">if</span> (!mem.eql(<span class="tok-type">u8</span>, &amp;em, &amp;em_dec)) {</span>
<span class="line" id="L771">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid;</span>
<span class="line" id="L772">            }</span>
<span class="line" id="L773">        },</span>
<span class="line" id="L774">        <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L775">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureUnsupportedBitCount;</span>
<span class="line" id="L776">        },</span>
<span class="line" id="L777">    }</span>
<span class="line" id="L778">}</span>
<span class="line" id="L779"></span>
<span class="line" id="L780"><span class="tok-kw">fn</span> <span class="tok-fn">verify_ecdsa</span>(</span>
<span class="line" id="L781">    <span class="tok-kw">comptime</span> Hash: <span class="tok-type">type</span>,</span>
<span class="line" id="L782">    message: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L783">    encoded_sig: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L784">    pub_key_algo: Parsed.PubKeyAlgo,</span>
<span class="line" id="L785">    sec1_pub_key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L786">) !<span class="tok-type">void</span> {</span>
<span class="line" id="L787">    <span class="tok-kw">const</span> sig_named_curve = <span class="tok-kw">switch</span> (pub_key_algo) {</span>
<span class="line" id="L788">        .X9_62_id_ecPublicKey =&gt; |named_curve| named_curve,</span>
<span class="line" id="L789">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureAlgorithmMismatch,</span>
<span class="line" id="L790">    };</span>
<span class="line" id="L791"></span>
<span class="line" id="L792">    <span class="tok-kw">switch</span> (sig_named_curve) {</span>
<span class="line" id="L793">        .secp521r1 =&gt; {</span>
<span class="line" id="L794">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureNamedCurveUnsupported;</span>
<span class="line" id="L795">        },</span>
<span class="line" id="L796">        <span class="tok-kw">inline</span> .X9_62_prime256v1,</span>
<span class="line" id="L797">        .secp384r1,</span>
<span class="line" id="L798">        =&gt; |curve| {</span>
<span class="line" id="L799">            <span class="tok-kw">const</span> Ecdsa = crypto.sign.ecdsa.Ecdsa(curve.Curve(), Hash);</span>
<span class="line" id="L800">            <span class="tok-kw">const</span> sig = Ecdsa.Signature.fromDer(encoded_sig) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L801">                <span class="tok-kw">error</span>.InvalidEncoding =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L802">            };</span>
<span class="line" id="L803">            <span class="tok-kw">const</span> pub_key = Ecdsa.PublicKey.fromSec1(sec1_pub_key) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L804">                <span class="tok-kw">error</span>.InvalidEncoding =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L805">                <span class="tok-kw">error</span>.NonCanonical =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L806">                <span class="tok-kw">error</span>.NotSquare =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L807">            };</span>
<span class="line" id="L808">            sig.verify(message, pub_key) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L809">                <span class="tok-kw">error</span>.IdentityElement =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L810">                <span class="tok-kw">error</span>.NonCanonical =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L811">                <span class="tok-kw">error</span>.SignatureVerificationFailed =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateSignatureInvalid,</span>
<span class="line" id="L812">            };</span>
<span class="line" id="L813">        },</span>
<span class="line" id="L814">    }</span>
<span class="line" id="L815">}</span>
<span class="line" id="L816"></span>
<span class="line" id="L817"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../std.zig&quot;</span>);</span>
<span class="line" id="L818"><span class="tok-kw">const</span> crypto = std.crypto;</span>
<span class="line" id="L819"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L820"><span class="tok-kw">const</span> Certificate = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L821"></span>
<span class="line" id="L822"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> der = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L823">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Class = <span class="tok-kw">enum</span>(<span class="tok-type">u2</span>) {</span>
<span class="line" id="L824">        universal,</span>
<span class="line" id="L825">        application,</span>
<span class="line" id="L826">        context_specific,</span>
<span class="line" id="L827">        private,</span>
<span class="line" id="L828">    };</span>
<span class="line" id="L829"></span>
<span class="line" id="L830">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> PC = <span class="tok-kw">enum</span>(<span class="tok-type">u1</span>) {</span>
<span class="line" id="L831">        primitive,</span>
<span class="line" id="L832">        constructed,</span>
<span class="line" id="L833">    };</span>
<span class="line" id="L834"></span>
<span class="line" id="L835">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Identifier = <span class="tok-kw">packed</span> <span class="tok-kw">struct</span>(<span class="tok-type">u8</span>) {</span>
<span class="line" id="L836">        tag: Tag,</span>
<span class="line" id="L837">        pc: PC,</span>
<span class="line" id="L838">        class: Class,</span>
<span class="line" id="L839">    };</span>
<span class="line" id="L840"></span>
<span class="line" id="L841">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Tag = <span class="tok-kw">enum</span>(<span class="tok-type">u5</span>) {</span>
<span class="line" id="L842">        boolean = <span class="tok-number">1</span>,</span>
<span class="line" id="L843">        integer = <span class="tok-number">2</span>,</span>
<span class="line" id="L844">        bitstring = <span class="tok-number">3</span>,</span>
<span class="line" id="L845">        octetstring = <span class="tok-number">4</span>,</span>
<span class="line" id="L846">        <span class="tok-null">null</span> = <span class="tok-number">5</span>,</span>
<span class="line" id="L847">        object_identifier = <span class="tok-number">6</span>,</span>
<span class="line" id="L848">        sequence = <span class="tok-number">16</span>,</span>
<span class="line" id="L849">        sequence_of = <span class="tok-number">17</span>,</span>
<span class="line" id="L850">        utc_time = <span class="tok-number">23</span>,</span>
<span class="line" id="L851">        generalized_time = <span class="tok-number">24</span>,</span>
<span class="line" id="L852">        _,</span>
<span class="line" id="L853">    };</span>
<span class="line" id="L854"></span>
<span class="line" id="L855">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Element = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L856">        identifier: Identifier,</span>
<span class="line" id="L857">        slice: Slice,</span>
<span class="line" id="L858"></span>
<span class="line" id="L859">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Slice = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L860">            start: <span class="tok-type">u32</span>,</span>
<span class="line" id="L861">            end: <span class="tok-type">u32</span>,</span>
<span class="line" id="L862"></span>
<span class="line" id="L863">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> empty: Slice = .{ .start = <span class="tok-number">0</span>, .end = <span class="tok-number">0</span> };</span>
<span class="line" id="L864">        };</span>
<span class="line" id="L865"></span>
<span class="line" id="L866">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ParseElementError = <span class="tok-kw">error</span>{CertificateFieldHasInvalidLength};</span>
<span class="line" id="L867"></span>
<span class="line" id="L868">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parse</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, index: <span class="tok-type">u32</span>) ParseElementError!Element {</span>
<span class="line" id="L869">            <span class="tok-kw">var</span> i = index;</span>
<span class="line" id="L870">            <span class="tok-kw">const</span> identifier = <span class="tok-builtin">@as</span>(Identifier, <span class="tok-builtin">@bitCast</span>(bytes[i]));</span>
<span class="line" id="L871">            i += <span class="tok-number">1</span>;</span>
<span class="line" id="L872">            <span class="tok-kw">const</span> size_byte = bytes[i];</span>
<span class="line" id="L873">            i += <span class="tok-number">1</span>;</span>
<span class="line" id="L874">            <span class="tok-kw">if</span> ((size_byte &gt;&gt; <span class="tok-number">7</span>) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L875">                <span class="tok-kw">return</span> .{</span>
<span class="line" id="L876">                    .identifier = identifier,</span>
<span class="line" id="L877">                    .slice = .{</span>
<span class="line" id="L878">                        .start = i,</span>
<span class="line" id="L879">                        .end = i + size_byte,</span>
<span class="line" id="L880">                    },</span>
<span class="line" id="L881">                };</span>
<span class="line" id="L882">            }</span>
<span class="line" id="L883"></span>
<span class="line" id="L884">            <span class="tok-kw">const</span> len_size = <span class="tok-builtin">@as</span>(<span class="tok-type">u7</span>, <span class="tok-builtin">@truncate</span>(size_byte));</span>
<span class="line" id="L885">            <span class="tok-kw">if</span> (len_size &gt; <span class="tok-builtin">@sizeOf</span>(<span class="tok-type">u32</span>)) {</span>
<span class="line" id="L886">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasInvalidLength;</span>
<span class="line" id="L887">            }</span>
<span class="line" id="L888"></span>
<span class="line" id="L889">            <span class="tok-kw">const</span> end_i = i + len_size;</span>
<span class="line" id="L890">            <span class="tok-kw">var</span> long_form_size: <span class="tok-type">u32</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L891">            <span class="tok-kw">while</span> (i &lt; end_i) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L892">                long_form_size = (long_form_size &lt;&lt; <span class="tok-number">8</span>) | bytes[i];</span>
<span class="line" id="L893">            }</span>
<span class="line" id="L894"></span>
<span class="line" id="L895">            <span class="tok-kw">return</span> .{</span>
<span class="line" id="L896">                .identifier = identifier,</span>
<span class="line" id="L897">                .slice = .{</span>
<span class="line" id="L898">                    .start = i,</span>
<span class="line" id="L899">                    .end = i + long_form_size,</span>
<span class="line" id="L900">                },</span>
<span class="line" id="L901">            };</span>
<span class="line" id="L902">        }</span>
<span class="line" id="L903">    };</span>
<span class="line" id="L904">};</span>
<span class="line" id="L905"></span>
<span class="line" id="L906"><span class="tok-kw">test</span> {</span>
<span class="line" id="L907">    _ = Bundle;</span>
<span class="line" id="L908">}</span>
<span class="line" id="L909"></span>
<span class="line" id="L910"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> rsa = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L911">    <span class="tok-kw">const</span> max_modulus_bits = <span class="tok-number">4096</span>;</span>
<span class="line" id="L912">    <span class="tok-kw">const</span> Uint = std.crypto.ff.Uint(max_modulus_bits);</span>
<span class="line" id="L913">    <span class="tok-kw">const</span> Modulus = std.crypto.ff.Modulus(max_modulus_bits);</span>
<span class="line" id="L914">    <span class="tok-kw">const</span> Fe = Modulus.Fe;</span>
<span class="line" id="L915"></span>
<span class="line" id="L916">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSSSignature = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L917">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(<span class="tok-kw">comptime</span> modulus_len: <span class="tok-type">usize</span>, msg: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) [modulus_len]<span class="tok-type">u8</span> {</span>
<span class="line" id="L918">            <span class="tok-kw">var</span> result = [<span class="tok-number">1</span>]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** modulus_len;</span>
<span class="line" id="L919">            std.mem.copyForwards(<span class="tok-type">u8</span>, &amp;result, msg);</span>
<span class="line" id="L920">            <span class="tok-kw">return</span> result;</span>
<span class="line" id="L921">        }</span>
<span class="line" id="L922"></span>
<span class="line" id="L923">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">verify</span>(<span class="tok-kw">comptime</span> modulus_len: <span class="tok-type">usize</span>, sig: [modulus_len]<span class="tok-type">u8</span>, msg: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, public_key: PublicKey, <span class="tok-kw">comptime</span> Hash: <span class="tok-type">type</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L924">            <span class="tok-kw">const</span> mod_bits = public_key.n.bits();</span>
<span class="line" id="L925">            <span class="tok-kw">const</span> em_dec = <span class="tok-kw">try</span> encrypt(modulus_len, sig, public_key);</span>
<span class="line" id="L926"></span>
<span class="line" id="L927">            EMSA_PSS_VERIFY(msg, &amp;em_dec, mod_bits - <span class="tok-number">1</span>, Hash.digest_length, Hash) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L928">        }</span>
<span class="line" id="L929"></span>
<span class="line" id="L930">        <span class="tok-kw">fn</span> <span class="tok-fn">EMSA_PSS_VERIFY</span>(msg: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, em: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, emBit: <span class="tok-type">usize</span>, sLen: <span class="tok-type">usize</span>, <span class="tok-kw">comptime</span> Hash: <span class="tok-type">type</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L931">            <span class="tok-comment">// 1.   If the length of M is greater than the input limitation for</span>
</span>
<span class="line" id="L932">            <span class="tok-comment">//      the hash function (2^61 - 1 octets for SHA-1), output</span>
</span>
<span class="line" id="L933">            <span class="tok-comment">//      &quot;inconsistent&quot; and stop.</span>
</span>
<span class="line" id="L934">            <span class="tok-comment">// All the cryptographic hash functions in the standard library have a limit of &gt;= 2^61 - 1.</span>
</span>
<span class="line" id="L935">            <span class="tok-comment">// Even then, this check is only there for paranoia. In the context of TLS certifcates, emBit cannot exceed 4096.</span>
</span>
<span class="line" id="L936">            <span class="tok-kw">if</span> (emBit &gt;= <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">61</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L937"></span>
<span class="line" id="L938">            <span class="tok-comment">// emLen = \ceil(emBits/8)</span>
</span>
<span class="line" id="L939">            <span class="tok-kw">const</span> emLen = ((emBit - <span class="tok-number">1</span>) / <span class="tok-number">8</span>) + <span class="tok-number">1</span>;</span>
<span class="line" id="L940">            std.debug.assert(emLen == em.len);</span>
<span class="line" id="L941"></span>
<span class="line" id="L942">            <span class="tok-comment">// 2.   Let mHash = Hash(M), an octet string of length hLen.</span>
</span>
<span class="line" id="L943">            <span class="tok-kw">var</span> mHash: [Hash.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L944">            Hash.hash(msg, &amp;mHash, .{});</span>
<span class="line" id="L945"></span>
<span class="line" id="L946">            <span class="tok-comment">// 3.   If emLen &lt; hLen + sLen + 2, output &quot;inconsistent&quot; and stop.</span>
</span>
<span class="line" id="L947">            <span class="tok-kw">if</span> (emLen &lt; Hash.digest_length + sLen + <span class="tok-number">2</span>) {</span>
<span class="line" id="L948">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L949">            }</span>
<span class="line" id="L950"></span>
<span class="line" id="L951">            <span class="tok-comment">// 4.   If the rightmost octet of EM does not have hexadecimal value</span>
</span>
<span class="line" id="L952">            <span class="tok-comment">//      0xbc, output &quot;inconsistent&quot; and stop.</span>
</span>
<span class="line" id="L953">            <span class="tok-kw">if</span> (em[em.len - <span class="tok-number">1</span>] != <span class="tok-number">0xbc</span>) {</span>
<span class="line" id="L954">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L955">            }</span>
<span class="line" id="L956"></span>
<span class="line" id="L957">            <span class="tok-comment">// 5.   Let maskedDB be the leftmost emLen - hLen - 1 octets of EM,</span>
</span>
<span class="line" id="L958">            <span class="tok-comment">//      and let H be the next hLen octets.</span>
</span>
<span class="line" id="L959">            <span class="tok-kw">const</span> maskedDB = em[<span class="tok-number">0</span>..(emLen - Hash.digest_length - <span class="tok-number">1</span>)];</span>
<span class="line" id="L960">            <span class="tok-kw">const</span> h = em[(emLen - Hash.digest_length - <span class="tok-number">1</span>)..(emLen - <span class="tok-number">1</span>)][<span class="tok-number">0</span>..Hash.digest_length];</span>
<span class="line" id="L961"></span>
<span class="line" id="L962">            <span class="tok-comment">// 6.   If the leftmost 8emLen - emBits bits of the leftmost octet in</span>
</span>
<span class="line" id="L963">            <span class="tok-comment">//      maskedDB are not all equal to zero, output &quot;inconsistent&quot; and</span>
</span>
<span class="line" id="L964">            <span class="tok-comment">//      stop.</span>
</span>
<span class="line" id="L965">            <span class="tok-kw">const</span> zero_bits = emLen * <span class="tok-number">8</span> - emBit;</span>
<span class="line" id="L966">            <span class="tok-kw">var</span> mask: <span class="tok-type">u8</span> = maskedDB[<span class="tok-number">0</span>];</span>
<span class="line" id="L967">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L968">            <span class="tok-kw">while</span> (i &lt; <span class="tok-number">8</span> - zero_bits) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L969">                mask = mask &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L970">            }</span>
<span class="line" id="L971">            <span class="tok-kw">if</span> (mask != <span class="tok-number">0</span>) {</span>
<span class="line" id="L972">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L973">            }</span>
<span class="line" id="L974"></span>
<span class="line" id="L975">            <span class="tok-comment">// 7.   Let dbMask = MGF(H, emLen - hLen - 1).</span>
</span>
<span class="line" id="L976">            <span class="tok-kw">const</span> mgf_len = emLen - Hash.digest_length - <span class="tok-number">1</span>;</span>
<span class="line" id="L977">            <span class="tok-kw">var</span> mgf_out_buf: [<span class="tok-number">512</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L978">            <span class="tok-kw">if</span> (mgf_len &gt; mgf_out_buf.len) { <span class="tok-comment">// Modulus &gt; 4096 bits</span>
</span>
<span class="line" id="L979">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L980">            }</span>
<span class="line" id="L981">            <span class="tok-kw">var</span> mgf_out = mgf_out_buf[<span class="tok-number">0</span> .. ((mgf_len - <span class="tok-number">1</span>) / Hash.digest_length + <span class="tok-number">1</span>) * Hash.digest_length];</span>
<span class="line" id="L982">            <span class="tok-kw">var</span> dbMask = <span class="tok-kw">try</span> MGF1(Hash, mgf_out, h, mgf_len);</span>
<span class="line" id="L983"></span>
<span class="line" id="L984">            <span class="tok-comment">// 8.   Let DB = maskedDB \xor dbMask.</span>
</span>
<span class="line" id="L985">            i = <span class="tok-number">0</span>;</span>
<span class="line" id="L986">            <span class="tok-kw">while</span> (i &lt; dbMask.len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L987">                dbMask[i] = maskedDB[i] ^ dbMask[i];</span>
<span class="line" id="L988">            }</span>
<span class="line" id="L989"></span>
<span class="line" id="L990">            <span class="tok-comment">// 9.   Set the leftmost 8emLen - emBits bits of the leftmost octet</span>
</span>
<span class="line" id="L991">            <span class="tok-comment">//      in DB to zero.</span>
</span>
<span class="line" id="L992">            i = <span class="tok-number">0</span>;</span>
<span class="line" id="L993">            mask = <span class="tok-number">0</span>;</span>
<span class="line" id="L994">            <span class="tok-kw">while</span> (i &lt; <span class="tok-number">8</span> - zero_bits) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L995">                mask = mask &lt;&lt; <span class="tok-number">1</span>;</span>
<span class="line" id="L996">                mask += <span class="tok-number">1</span>;</span>
<span class="line" id="L997">            }</span>
<span class="line" id="L998">            dbMask[<span class="tok-number">0</span>] = dbMask[<span class="tok-number">0</span>] &amp; mask;</span>
<span class="line" id="L999"></span>
<span class="line" id="L1000">            <span class="tok-comment">// 10.  If the emLen - hLen - sLen - 2 leftmost octets of DB are not</span>
</span>
<span class="line" id="L1001">            <span class="tok-comment">//      zero or if the octet at position emLen - hLen - sLen - 1 (the</span>
</span>
<span class="line" id="L1002">            <span class="tok-comment">//      leftmost position is &quot;position 1&quot;) does not have hexadecimal</span>
</span>
<span class="line" id="L1003">            <span class="tok-comment">//      value 0x01, output &quot;inconsistent&quot; and stop.</span>
</span>
<span class="line" id="L1004">            <span class="tok-kw">if</span> (dbMask[mgf_len - sLen - <span class="tok-number">2</span>] != <span class="tok-number">0x00</span>) {</span>
<span class="line" id="L1005">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L1006">            }</span>
<span class="line" id="L1007"></span>
<span class="line" id="L1008">            <span class="tok-kw">if</span> (dbMask[mgf_len - sLen - <span class="tok-number">1</span>] != <span class="tok-number">0x01</span>) {</span>
<span class="line" id="L1009">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L1010">            }</span>
<span class="line" id="L1011"></span>
<span class="line" id="L1012">            <span class="tok-comment">// 11.  Let salt be the last sLen octets of DB.</span>
</span>
<span class="line" id="L1013">            <span class="tok-kw">const</span> salt = dbMask[(mgf_len - sLen)..];</span>
<span class="line" id="L1014"></span>
<span class="line" id="L1015">            <span class="tok-comment">// 12.  Let</span>
</span>
<span class="line" id="L1016">            <span class="tok-comment">//         M' = (0x)00 00 00 00 00 00 00 00 || mHash || salt ;</span>
</span>
<span class="line" id="L1017">            <span class="tok-comment">//      M' is an octet string of length 8 + hLen + sLen with eight</span>
</span>
<span class="line" id="L1018">            <span class="tok-comment">//      initial zero octets.</span>
</span>
<span class="line" id="L1019">            <span class="tok-kw">if</span> (sLen &gt; Hash.digest_length) { <span class="tok-comment">// A seed larger than the hash length would be useless</span>
</span>
<span class="line" id="L1020">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L1021">            }</span>
<span class="line" id="L1022">            <span class="tok-kw">var</span> m_p_buf: [<span class="tok-number">8</span> + Hash.digest_length + Hash.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1023">            <span class="tok-kw">var</span> m_p = m_p_buf[<span class="tok-number">0</span> .. <span class="tok-number">8</span> + Hash.digest_length + sLen];</span>
<span class="line" id="L1024">            std.mem.copyForwards(<span class="tok-type">u8</span>, m_p, &amp;([_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">8</span>));</span>
<span class="line" id="L1025">            std.mem.copyForwards(<span class="tok-type">u8</span>, m_p[<span class="tok-number">8</span>..], &amp;mHash);</span>
<span class="line" id="L1026">            std.mem.copyForwards(<span class="tok-type">u8</span>, m_p[(<span class="tok-number">8</span> + Hash.digest_length)..], salt);</span>
<span class="line" id="L1027"></span>
<span class="line" id="L1028">            <span class="tok-comment">// 13.  Let H' = Hash(M'), an octet string of length hLen.</span>
</span>
<span class="line" id="L1029">            <span class="tok-kw">var</span> h_p: [Hash.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1030">            Hash.hash(m_p, &amp;h_p, .{});</span>
<span class="line" id="L1031"></span>
<span class="line" id="L1032">            <span class="tok-comment">// 14.  If H = H', output &quot;consistent&quot;.  Otherwise, output</span>
</span>
<span class="line" id="L1033">            <span class="tok-comment">//      &quot;inconsistent&quot;.</span>
</span>
<span class="line" id="L1034">            <span class="tok-kw">if</span> (!std.mem.eql(<span class="tok-type">u8</span>, h, &amp;h_p)) {</span>
<span class="line" id="L1035">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidSignature;</span>
<span class="line" id="L1036">            }</span>
<span class="line" id="L1037">        }</span>
<span class="line" id="L1038"></span>
<span class="line" id="L1039">        <span class="tok-kw">fn</span> <span class="tok-fn">MGF1</span>(<span class="tok-kw">comptime</span> Hash: <span class="tok-type">type</span>, out: []<span class="tok-type">u8</span>, seed: *<span class="tok-kw">const</span> [Hash.digest_length]<span class="tok-type">u8</span>, len: <span class="tok-type">usize</span>) ![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1040">            <span class="tok-kw">var</span> counter: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1041">            <span class="tok-kw">var</span> idx: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1042">            <span class="tok-kw">var</span> c: [<span class="tok-number">4</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1043">            <span class="tok-kw">var</span> hash: [Hash.digest_length + c.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1044">            <span class="tok-builtin">@memcpy</span>(hash[<span class="tok-number">0</span>..Hash.digest_length], seed);</span>
<span class="line" id="L1045">            <span class="tok-kw">var</span> hashed: [Hash.digest_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1046"></span>
<span class="line" id="L1047">            <span class="tok-kw">while</span> (idx &lt; len) {</span>
<span class="line" id="L1048">                c[<span class="tok-number">0</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>((counter &gt;&gt; <span class="tok-number">24</span>) &amp; <span class="tok-number">0xFF</span>));</span>
<span class="line" id="L1049">                c[<span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>((counter &gt;&gt; <span class="tok-number">16</span>) &amp; <span class="tok-number">0xFF</span>));</span>
<span class="line" id="L1050">                c[<span class="tok-number">2</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>((counter &gt;&gt; <span class="tok-number">8</span>) &amp; <span class="tok-number">0xFF</span>));</span>
<span class="line" id="L1051">                c[<span class="tok-number">3</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(counter &amp; <span class="tok-number">0xFF</span>));</span>
<span class="line" id="L1052"></span>
<span class="line" id="L1053">                std.mem.copyForwards(<span class="tok-type">u8</span>, hash[seed.len..], &amp;c);</span>
<span class="line" id="L1054">                Hash.hash(&amp;hash, &amp;hashed, .{});</span>
<span class="line" id="L1055"></span>
<span class="line" id="L1056">                std.mem.copyForwards(<span class="tok-type">u8</span>, out[idx..], &amp;hashed);</span>
<span class="line" id="L1057">                idx += hashed.len;</span>
<span class="line" id="L1058"></span>
<span class="line" id="L1059">                counter += <span class="tok-number">1</span>;</span>
<span class="line" id="L1060">            }</span>
<span class="line" id="L1061"></span>
<span class="line" id="L1062">            <span class="tok-kw">return</span> out[<span class="tok-number">0</span>..len];</span>
<span class="line" id="L1063">        }</span>
<span class="line" id="L1064">    };</span>
<span class="line" id="L1065"></span>
<span class="line" id="L1066">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> PublicKey = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1067">        n: Modulus,</span>
<span class="line" id="L1068">        e: Fe,</span>
<span class="line" id="L1069"></span>
<span class="line" id="L1070">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(pub_bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, modulus_bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !PublicKey {</span>
<span class="line" id="L1071">            <span class="tok-comment">// Reject modulus below 512 bits.</span>
</span>
<span class="line" id="L1072">            <span class="tok-comment">// 512-bit RSA was factored in 1999, so this limit barely means anything,</span>
</span>
<span class="line" id="L1073">            <span class="tok-comment">// but establish some limit now to ratchet in what we can.</span>
</span>
<span class="line" id="L1074">            <span class="tok-kw">const</span> _n = Modulus.fromBytes(modulus_bytes, .Big) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1075">            <span class="tok-kw">if</span> (_n.bits() &lt; <span class="tok-number">512</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1076"></span>
<span class="line" id="L1077">            <span class="tok-comment">// Exponent must be odd and greater than 2.</span>
</span>
<span class="line" id="L1078">            <span class="tok-comment">// Also, it must be less than 2^32 to mitigate DoS attacks.</span>
</span>
<span class="line" id="L1079">            <span class="tok-comment">// Windows CryptoAPI doesn't support values larger than 32 bits [1], so it is</span>
</span>
<span class="line" id="L1080">            <span class="tok-comment">// unlikely that exponents larger than 32 bits are being used for anything</span>
</span>
<span class="line" id="L1081">            <span class="tok-comment">// Windows commonly does.</span>
</span>
<span class="line" id="L1082">            <span class="tok-comment">// [1] https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/ns-wincrypt-rsapubkey</span>
</span>
<span class="line" id="L1083">            <span class="tok-kw">if</span> (pub_bytes.len &gt; <span class="tok-number">4</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1084">            <span class="tok-kw">const</span> _e = Fe.fromBytes(_n, pub_bytes, .Big) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1085">            <span class="tok-kw">if</span> (!_e.isOdd()) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1086">            <span class="tok-kw">const</span> e_v = _e.toPrimitive(<span class="tok-type">u32</span>) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1087">            <span class="tok-kw">if</span> (e_v &lt; <span class="tok-number">2</span>) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificatePublicKeyInvalid;</span>
<span class="line" id="L1088"></span>
<span class="line" id="L1089">            <span class="tok-kw">return</span> .{</span>
<span class="line" id="L1090">                .n = _n,</span>
<span class="line" id="L1091">                .e = _e,</span>
<span class="line" id="L1092">            };</span>
<span class="line" id="L1093">        }</span>
<span class="line" id="L1094"></span>
<span class="line" id="L1095">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseDer</span>(pub_key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-kw">struct</span> { modulus: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, exponent: []<span class="tok-kw">const</span> <span class="tok-type">u8</span> } {</span>
<span class="line" id="L1096">            <span class="tok-kw">const</span> pub_key_seq = <span class="tok-kw">try</span> der.Element.parse(pub_key, <span class="tok-number">0</span>);</span>
<span class="line" id="L1097">            <span class="tok-kw">if</span> (pub_key_seq.identifier.tag != .sequence) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType;</span>
<span class="line" id="L1098">            <span class="tok-kw">const</span> modulus_elem = <span class="tok-kw">try</span> der.Element.parse(pub_key, pub_key_seq.slice.start);</span>
<span class="line" id="L1099">            <span class="tok-kw">if</span> (modulus_elem.identifier.tag != .integer) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType;</span>
<span class="line" id="L1100">            <span class="tok-kw">const</span> exponent_elem = <span class="tok-kw">try</span> der.Element.parse(pub_key, modulus_elem.slice.end);</span>
<span class="line" id="L1101">            <span class="tok-kw">if</span> (exponent_elem.identifier.tag != .integer) <span class="tok-kw">return</span> <span class="tok-kw">error</span>.CertificateFieldHasWrongDataType;</span>
<span class="line" id="L1102">            <span class="tok-comment">// Skip over meaningless zeroes in the modulus.</span>
</span>
<span class="line" id="L1103">            <span class="tok-kw">const</span> modulus_raw = pub_key[modulus_elem.slice.start..modulus_elem.slice.end];</span>
<span class="line" id="L1104">            <span class="tok-kw">const</span> modulus_offset = <span class="tok-kw">for</span> (modulus_raw, <span class="tok-number">0</span>..) |byte, i| {</span>
<span class="line" id="L1105">                <span class="tok-kw">if</span> (byte != <span class="tok-number">0</span>) <span class="tok-kw">break</span> i;</span>
<span class="line" id="L1106">            } <span class="tok-kw">else</span> modulus_raw.len;</span>
<span class="line" id="L1107">            <span class="tok-kw">return</span> .{</span>
<span class="line" id="L1108">                .modulus = modulus_raw[modulus_offset..],</span>
<span class="line" id="L1109">                .exponent = pub_key[exponent_elem.slice.start..exponent_elem.slice.end],</span>
<span class="line" id="L1110">            };</span>
<span class="line" id="L1111">        }</span>
<span class="line" id="L1112">    };</span>
<span class="line" id="L1113"></span>
<span class="line" id="L1114">    <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(<span class="tok-kw">comptime</span> modulus_len: <span class="tok-type">usize</span>, msg: [modulus_len]<span class="tok-type">u8</span>, public_key: PublicKey) ![modulus_len]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1115">        <span class="tok-kw">const</span> m = Fe.fromBytes(public_key.n, &amp;msg, .Big) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MessageTooLong;</span>
<span class="line" id="L1116">        <span class="tok-kw">const</span> e = public_key.n.powPublic(m, public_key.e) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1117">        <span class="tok-kw">var</span> res: [modulus_len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1118">        e.toBytes(&amp;res, .Big) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L1119">        <span class="tok-kw">return</span> res;</span>
<span class="line" id="L1120">    }</span>
<span class="line" id="L1121">};</span>
<span class="line" id="L1122"></span>
</code></pre></body>
</html>