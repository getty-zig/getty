<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>crypto/chacha20.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">// Based on public domain Supercop by Daniel J. Bernstein</span>
</span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../std.zig&quot;</span>);</span>
<span class="line" id="L4"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L5"><span class="tok-kw">const</span> crypto = std.crypto;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L7"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L8"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> maxInt = math.maxInt;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> Poly1305 = crypto.onetimeauth.Poly1305;</span>
<span class="line" id="L12"><span class="tok-kw">const</span> AuthenticationError = crypto.errors.AuthenticationError;</span>
<span class="line" id="L13"></span>
<span class="line" id="L14"><span class="tok-comment">/// IETF-variant of the ChaCha20 stream cipher, as designed for TLS.</span></span>
<span class="line" id="L15"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha20IETF = ChaChaIETF(<span class="tok-number">20</span>);</span>
<span class="line" id="L16"></span>
<span class="line" id="L17"><span class="tok-comment">/// IETF-variant of the ChaCha20 stream cipher, reduced to 12 rounds.</span></span>
<span class="line" id="L18"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L19"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L20"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha12IETF = ChaChaIETF(<span class="tok-number">12</span>);</span>
<span class="line" id="L21"></span>
<span class="line" id="L22"><span class="tok-comment">/// IETF-variant of the ChaCha20 stream cipher, reduced to 8 rounds.</span></span>
<span class="line" id="L23"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L24"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L25"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha8IETF = ChaChaIETF(<span class="tok-number">8</span>);</span>
<span class="line" id="L26"></span>
<span class="line" id="L27"><span class="tok-comment">/// Original ChaCha20 stream cipher.</span></span>
<span class="line" id="L28"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha20With64BitNonce = ChaChaWith64BitNonce(<span class="tok-number">20</span>);</span>
<span class="line" id="L29"></span>
<span class="line" id="L30"><span class="tok-comment">/// Original ChaCha20 stream cipher, reduced to 12 rounds.</span></span>
<span class="line" id="L31"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L32"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L33"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha12With64BitNonce = ChaChaWith64BitNonce(<span class="tok-number">12</span>);</span>
<span class="line" id="L34"></span>
<span class="line" id="L35"><span class="tok-comment">/// Original ChaCha20 stream cipher, reduced to 8 rounds.</span></span>
<span class="line" id="L36"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L37"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha8With64BitNonce = ChaChaWith64BitNonce(<span class="tok-number">8</span>);</span>
<span class="line" id="L39"></span>
<span class="line" id="L40"><span class="tok-comment">/// XChaCha20 (nonce-extended version of the IETF ChaCha20 variant) stream cipher</span></span>
<span class="line" id="L41"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha20IETF = XChaChaIETF(<span class="tok-number">20</span>);</span>
<span class="line" id="L42"></span>
<span class="line" id="L43"><span class="tok-comment">/// XChaCha20 (nonce-extended version of the IETF ChaCha20 variant) stream cipher, reduced to 12 rounds</span></span>
<span class="line" id="L44"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L45"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L46"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha12IETF = XChaChaIETF(<span class="tok-number">12</span>);</span>
<span class="line" id="L47"></span>
<span class="line" id="L48"><span class="tok-comment">/// XChaCha20 (nonce-extended version of the IETF ChaCha20 variant) stream cipher, reduced to 8 rounds</span></span>
<span class="line" id="L49"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L50"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L51"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha8IETF = XChaChaIETF(<span class="tok-number">8</span>);</span>
<span class="line" id="L52"></span>
<span class="line" id="L53"><span class="tok-comment">/// ChaCha20-Poly1305 authenticated cipher, as designed for TLS</span></span>
<span class="line" id="L54"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha20Poly1305 = ChaChaPoly1305(<span class="tok-number">20</span>);</span>
<span class="line" id="L55"></span>
<span class="line" id="L56"><span class="tok-comment">/// ChaCha20-Poly1305 authenticated cipher, reduced to 12 rounds</span></span>
<span class="line" id="L57"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L58"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L59"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha12Poly1305 = ChaChaPoly1305(<span class="tok-number">12</span>);</span>
<span class="line" id="L60"></span>
<span class="line" id="L61"><span class="tok-comment">/// ChaCha20-Poly1305 authenticated cipher, reduced to 8 rounds</span></span>
<span class="line" id="L62"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L63"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L64"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ChaCha8Poly1305 = ChaChaPoly1305(<span class="tok-number">8</span>);</span>
<span class="line" id="L65"></span>
<span class="line" id="L66"><span class="tok-comment">/// XChaCha20-Poly1305 authenticated cipher</span></span>
<span class="line" id="L67"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha20Poly1305 = XChaChaPoly1305(<span class="tok-number">20</span>);</span>
<span class="line" id="L68"></span>
<span class="line" id="L69"><span class="tok-comment">/// XChaCha20-Poly1305 authenticated cipher</span></span>
<span class="line" id="L70"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L71"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L72"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha12Poly1305 = XChaChaPoly1305(<span class="tok-number">12</span>);</span>
<span class="line" id="L73"></span>
<span class="line" id="L74"><span class="tok-comment">/// XChaCha20-Poly1305 authenticated cipher</span></span>
<span class="line" id="L75"><span class="tok-comment">/// Reduced-rounds versions are faster than the full-round version, but have a lower security margin.</span></span>
<span class="line" id="L76"><span class="tok-comment">/// However, ChaCha is still believed to have a comfortable security even with only 8 rounds.</span></span>
<span class="line" id="L77"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XChaCha8Poly1305 = XChaChaPoly1305(<span class="tok-number">8</span>);</span>
<span class="line" id="L78"></span>
<span class="line" id="L79"><span class="tok-comment">// Vectorized implementation of the core function</span>
</span>
<span class="line" id="L80"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaVecImpl</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>, <span class="tok-kw">comptime</span> degree: <span class="tok-type">comptime_int</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L81">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L82">        <span class="tok-kw">const</span> Lane = <span class="tok-builtin">@Vector</span>(<span class="tok-number">4</span> * degree, <span class="tok-type">u32</span>);</span>
<span class="line" id="L83">        <span class="tok-kw">const</span> BlockVec = [<span class="tok-number">4</span>]Lane;</span>
<span class="line" id="L84"></span>
<span class="line" id="L85">        <span class="tok-kw">fn</span> <span class="tok-fn">initContext</span>(key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, d: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>) BlockVec {</span>
<span class="line" id="L86">            <span class="tok-kw">const</span> c = <span class="tok-str">&quot;expand 32-byte k&quot;</span>;</span>
<span class="line" id="L87">            <span class="tok-kw">switch</span> (degree) {</span>
<span class="line" id="L88">                <span class="tok-number">1</span> =&gt; {</span>
<span class="line" id="L89">                    <span class="tok-kw">const</span> constant_le = Lane{</span>
<span class="line" id="L90">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L91">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L92">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L93">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L94">                    };</span>
<span class="line" id="L95">                    <span class="tok-kw">return</span> BlockVec{</span>
<span class="line" id="L96">                        constant_le,</span>
<span class="line" id="L97">                        Lane{ key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>] },</span>
<span class="line" id="L98">                        Lane{ key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>] },</span>
<span class="line" id="L99">                        Lane{ d[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>] },</span>
<span class="line" id="L100">                    };</span>
<span class="line" id="L101">                },</span>
<span class="line" id="L102">                <span class="tok-number">2</span> =&gt; {</span>
<span class="line" id="L103">                    <span class="tok-kw">const</span> constant_le = Lane{</span>
<span class="line" id="L104">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L105">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L106">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L107">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L108">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L109">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L110">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L111">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L112">                    };</span>
<span class="line" id="L113">                    <span class="tok-kw">const</span> n1 = <span class="tok-builtin">@addWithOverflow</span>(d[<span class="tok-number">0</span>], <span class="tok-number">1</span>);</span>
<span class="line" id="L114">                    <span class="tok-kw">return</span> BlockVec{</span>
<span class="line" id="L115">                        constant_le,</span>
<span class="line" id="L116">                        Lane{ key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>], key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>] },</span>
<span class="line" id="L117">                        Lane{ key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>], key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>] },</span>
<span class="line" id="L118">                        Lane{ d[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>], n1[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>] +% n1[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>] },</span>
<span class="line" id="L119">                    };</span>
<span class="line" id="L120">                },</span>
<span class="line" id="L121">                <span class="tok-number">4</span> =&gt; {</span>
<span class="line" id="L122">                    <span class="tok-kw">const</span> n1 = <span class="tok-builtin">@addWithOverflow</span>(d[<span class="tok-number">0</span>], <span class="tok-number">1</span>);</span>
<span class="line" id="L123">                    <span class="tok-kw">const</span> n2 = <span class="tok-builtin">@addWithOverflow</span>(d[<span class="tok-number">0</span>], <span class="tok-number">2</span>);</span>
<span class="line" id="L124">                    <span class="tok-kw">const</span> n3 = <span class="tok-builtin">@addWithOverflow</span>(d[<span class="tok-number">0</span>], <span class="tok-number">3</span>);</span>
<span class="line" id="L125">                    <span class="tok-kw">const</span> constant_le = Lane{</span>
<span class="line" id="L126">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L127">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L128">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L129">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L130">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L131">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L132">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L133">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L134">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L135">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L136">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L137">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L138">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L139">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L140">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L141">                        mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L142">                    };</span>
<span class="line" id="L143">                    <span class="tok-kw">return</span> BlockVec{</span>
<span class="line" id="L144">                        constant_le,</span>
<span class="line" id="L145">                        Lane{ key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>], key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>], key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>], key[<span class="tok-number">0</span>], key[<span class="tok-number">1</span>], key[<span class="tok-number">2</span>], key[<span class="tok-number">3</span>] },</span>
<span class="line" id="L146">                        Lane{ key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>], key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>], key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>], key[<span class="tok-number">4</span>], key[<span class="tok-number">5</span>], key[<span class="tok-number">6</span>], key[<span class="tok-number">7</span>] },</span>
<span class="line" id="L147">                        Lane{ d[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>], n1[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>] +% n1[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>], n2[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>] +% n2[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>], n3[<span class="tok-number">0</span>], d[<span class="tok-number">1</span>] +% n3[<span class="tok-number">1</span>], d[<span class="tok-number">2</span>], d[<span class="tok-number">3</span>] },</span>
<span class="line" id="L148">                    };</span>
<span class="line" id="L149">                },</span>
<span class="line" id="L150">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;invalid degree&quot;</span>),</span>
<span class="line" id="L151">            }</span>
<span class="line" id="L152">        }</span>
<span class="line" id="L153"></span>
<span class="line" id="L154">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Core</span>(x: *BlockVec, input: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L155">            x.* = input;</span>
<span class="line" id="L156"></span>
<span class="line" id="L157">            <span class="tok-kw">const</span> m0 = <span class="tok-kw">switch</span> (degree) {</span>
<span class="line" id="L158">                <span class="tok-number">1</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span> },</span>
<span class="line" id="L159">                <span class="tok-number">2</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">7</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span> },</span>
<span class="line" id="L160">                <span class="tok-number">4</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>, <span class="tok-number">2</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">7</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">6</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">11</span>, <span class="tok-number">8</span>, <span class="tok-number">9</span>, <span class="tok-number">10</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">15</span>, <span class="tok-number">12</span>, <span class="tok-number">13</span>, <span class="tok-number">14</span> },</span>
<span class="line" id="L161">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;invalid degree&quot;</span>),</span>
<span class="line" id="L162">            };</span>
<span class="line" id="L163">            <span class="tok-kw">const</span> m1 = <span class="tok-kw">switch</span> (degree) {</span>
<span class="line" id="L164">                <span class="tok-number">1</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span> },</span>
<span class="line" id="L165">                <span class="tok-number">2</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">6</span>, <span class="tok-number">7</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span> },</span>
<span class="line" id="L166">                <span class="tok-number">4</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">6</span>, <span class="tok-number">7</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">10</span>, <span class="tok-number">11</span>, <span class="tok-number">8</span>, <span class="tok-number">9</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">14</span>, <span class="tok-number">15</span>, <span class="tok-number">12</span>, <span class="tok-number">13</span> },</span>
<span class="line" id="L167">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;invalid degree&quot;</span>),</span>
<span class="line" id="L168">            };</span>
<span class="line" id="L169">            <span class="tok-kw">const</span> m2 = <span class="tok-kw">switch</span> (degree) {</span>
<span class="line" id="L170">                <span class="tok-number">1</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span> },</span>
<span class="line" id="L171">                <span class="tok-number">2</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, <span class="tok-number">4</span> },</span>
<span class="line" id="L172">                <span class="tok-number">4</span> =&gt; [_]<span class="tok-type">i32</span>{ <span class="tok-number">1</span>, <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">0</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">5</span>, <span class="tok-number">6</span>, <span class="tok-number">7</span>, <span class="tok-number">4</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">9</span>, <span class="tok-number">10</span>, <span class="tok-number">11</span>, <span class="tok-number">8</span> } ++ [_]<span class="tok-type">i32</span>{ <span class="tok-number">13</span>, <span class="tok-number">14</span>, <span class="tok-number">15</span>, <span class="tok-number">12</span> },</span>
<span class="line" id="L173">                <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;invalid degree&quot;</span>),</span>
<span class="line" id="L174">            };</span>
<span class="line" id="L175"></span>
<span class="line" id="L176">            <span class="tok-kw">var</span> r: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L177">            <span class="tok-kw">while</span> (r &lt; rounds_nb) : (r += <span class="tok-number">2</span>) {</span>
<span class="line" id="L178">                x[<span class="tok-number">0</span>] +%= x[<span class="tok-number">1</span>];</span>
<span class="line" id="L179">                x[<span class="tok-number">3</span>] ^= x[<span class="tok-number">0</span>];</span>
<span class="line" id="L180">                x[<span class="tok-number">3</span>] = math.rotl(Lane, x[<span class="tok-number">3</span>], <span class="tok-number">16</span>);</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">                x[<span class="tok-number">2</span>] +%= x[<span class="tok-number">3</span>];</span>
<span class="line" id="L183">                x[<span class="tok-number">1</span>] ^= x[<span class="tok-number">2</span>];</span>
<span class="line" id="L184">                x[<span class="tok-number">1</span>] = math.rotl(Lane, x[<span class="tok-number">1</span>], <span class="tok-number">12</span>);</span>
<span class="line" id="L185"></span>
<span class="line" id="L186">                x[<span class="tok-number">0</span>] +%= x[<span class="tok-number">1</span>];</span>
<span class="line" id="L187">                x[<span class="tok-number">3</span>] ^= x[<span class="tok-number">0</span>];</span>
<span class="line" id="L188">                x[<span class="tok-number">0</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">0</span>], <span class="tok-null">undefined</span>, m0);</span>
<span class="line" id="L189">                x[<span class="tok-number">3</span>] = math.rotl(Lane, x[<span class="tok-number">3</span>], <span class="tok-number">8</span>);</span>
<span class="line" id="L190"></span>
<span class="line" id="L191">                x[<span class="tok-number">2</span>] +%= x[<span class="tok-number">3</span>];</span>
<span class="line" id="L192">                x[<span class="tok-number">3</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">3</span>], <span class="tok-null">undefined</span>, m1);</span>
<span class="line" id="L193">                x[<span class="tok-number">1</span>] ^= x[<span class="tok-number">2</span>];</span>
<span class="line" id="L194">                x[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">2</span>], <span class="tok-null">undefined</span>, m2);</span>
<span class="line" id="L195">                x[<span class="tok-number">1</span>] = math.rotl(Lane, x[<span class="tok-number">1</span>], <span class="tok-number">7</span>);</span>
<span class="line" id="L196"></span>
<span class="line" id="L197">                x[<span class="tok-number">0</span>] +%= x[<span class="tok-number">1</span>];</span>
<span class="line" id="L198">                x[<span class="tok-number">3</span>] ^= x[<span class="tok-number">0</span>];</span>
<span class="line" id="L199">                x[<span class="tok-number">3</span>] = math.rotl(Lane, x[<span class="tok-number">3</span>], <span class="tok-number">16</span>);</span>
<span class="line" id="L200"></span>
<span class="line" id="L201">                x[<span class="tok-number">2</span>] +%= x[<span class="tok-number">3</span>];</span>
<span class="line" id="L202">                x[<span class="tok-number">1</span>] ^= x[<span class="tok-number">2</span>];</span>
<span class="line" id="L203">                x[<span class="tok-number">1</span>] = math.rotl(Lane, x[<span class="tok-number">1</span>], <span class="tok-number">12</span>);</span>
<span class="line" id="L204"></span>
<span class="line" id="L205">                x[<span class="tok-number">0</span>] +%= x[<span class="tok-number">1</span>];</span>
<span class="line" id="L206">                x[<span class="tok-number">3</span>] ^= x[<span class="tok-number">0</span>];</span>
<span class="line" id="L207">                x[<span class="tok-number">0</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">0</span>], <span class="tok-null">undefined</span>, m2);</span>
<span class="line" id="L208">                x[<span class="tok-number">3</span>] = math.rotl(Lane, x[<span class="tok-number">3</span>], <span class="tok-number">8</span>);</span>
<span class="line" id="L209"></span>
<span class="line" id="L210">                x[<span class="tok-number">2</span>] +%= x[<span class="tok-number">3</span>];</span>
<span class="line" id="L211">                x[<span class="tok-number">3</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">3</span>], <span class="tok-null">undefined</span>, m1);</span>
<span class="line" id="L212">                x[<span class="tok-number">1</span>] ^= x[<span class="tok-number">2</span>];</span>
<span class="line" id="L213">                x[<span class="tok-number">2</span>] = <span class="tok-builtin">@shuffle</span>(<span class="tok-type">u32</span>, x[<span class="tok-number">2</span>], <span class="tok-null">undefined</span>, m0);</span>
<span class="line" id="L214">                x[<span class="tok-number">1</span>] = math.rotl(Lane, x[<span class="tok-number">1</span>], <span class="tok-number">7</span>);</span>
<span class="line" id="L215">            }</span>
<span class="line" id="L216">        }</span>
<span class="line" id="L217"></span>
<span class="line" id="L218">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">hashToBytes</span>(<span class="tok-kw">comptime</span> dm: <span class="tok-type">usize</span>, out: *[<span class="tok-number">64</span> * dm]<span class="tok-type">u8</span>, x: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L219">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..dm) |d| {</span>
<span class="line" id="L220">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">4</span>) |i| {</span>
<span class="line" id="L221">                    mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">64</span> * d + <span class="tok-number">16</span> * i + <span class="tok-number">0</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i][<span class="tok-number">0</span> + <span class="tok-number">4</span> * d], .little);</span>
<span class="line" id="L222">                    mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">64</span> * d + <span class="tok-number">16</span> * i + <span class="tok-number">4</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i][<span class="tok-number">1</span> + <span class="tok-number">4</span> * d], .little);</span>
<span class="line" id="L223">                    mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">64</span> * d + <span class="tok-number">16</span> * i + <span class="tok-number">8</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i][<span class="tok-number">2</span> + <span class="tok-number">4</span> * d], .little);</span>
<span class="line" id="L224">                    mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">64</span> * d + <span class="tok-number">16</span> * i + <span class="tok-number">12</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i][<span class="tok-number">3</span> + <span class="tok-number">4</span> * d], .little);</span>
<span class="line" id="L225">                }</span>
<span class="line" id="L226">            }</span>
<span class="line" id="L227">        }</span>
<span class="line" id="L228"></span>
<span class="line" id="L229">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">contextFeedback</span>(x: *BlockVec, ctx: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L230">            x[<span class="tok-number">0</span>] +%= ctx[<span class="tok-number">0</span>];</span>
<span class="line" id="L231">            x[<span class="tok-number">1</span>] +%= ctx[<span class="tok-number">1</span>];</span>
<span class="line" id="L232">            x[<span class="tok-number">2</span>] +%= ctx[<span class="tok-number">2</span>];</span>
<span class="line" id="L233">            x[<span class="tok-number">3</span>] +%= ctx[<span class="tok-number">3</span>];</span>
<span class="line" id="L234">        }</span>
<span class="line" id="L235"></span>
<span class="line" id="L236">        <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Xor</span>(out: []<span class="tok-type">u8</span>, in: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, nonce_and_counter: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>, <span class="tok-kw">comptime</span> count64: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L237">            <span class="tok-kw">var</span> ctx = initContext(key, nonce_and_counter);</span>
<span class="line" id="L238">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L239">            <span class="tok-kw">var</span> buf: [<span class="tok-number">64</span> * degree]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L240">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L241">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> ([_]<span class="tok-type">comptime_int</span>{ <span class="tok-number">4</span>, <span class="tok-number">2</span>, <span class="tok-number">1</span> }) |d| {</span>
<span class="line" id="L242">                <span class="tok-kw">while</span> (degree &gt;= d <span class="tok-kw">and</span> i + <span class="tok-number">64</span> * d &lt;= in.len) : (i += <span class="tok-number">64</span> * d) {</span>
<span class="line" id="L243">                    chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L244">                    contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L245">                    hashToBytes(d, buf[<span class="tok-number">0</span> .. <span class="tok-number">64</span> * d], x);</span>
<span class="line" id="L246"></span>
<span class="line" id="L247">                    <span class="tok-kw">var</span> xout = out[i..];</span>
<span class="line" id="L248">                    <span class="tok-kw">const</span> xin = in[i..];</span>
<span class="line" id="L249">                    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">64</span> * d) |j| {</span>
<span class="line" id="L250">                        xout[j] = xin[j];</span>
<span class="line" id="L251">                    }</span>
<span class="line" id="L252">                    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">64</span> * d) |j| {</span>
<span class="line" id="L253">                        xout[j] ^= buf[j];</span>
<span class="line" id="L254">                    }</span>
<span class="line" id="L255">                    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..d) |d_| {</span>
<span class="line" id="L256">                        <span class="tok-kw">if</span> (count64) {</span>
<span class="line" id="L257">                            <span class="tok-kw">const</span> next = <span class="tok-builtin">@addWithOverflow</span>(ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_], d);</span>
<span class="line" id="L258">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_] = next[<span class="tok-number">0</span>];</span>
<span class="line" id="L259">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_ + <span class="tok-number">1</span>] +%= next[<span class="tok-number">1</span>];</span>
<span class="line" id="L260">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L261">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_] +%= d;</span>
<span class="line" id="L262">                        }</span>
<span class="line" id="L263">                    }</span>
<span class="line" id="L264">                }</span>
<span class="line" id="L265">            }</span>
<span class="line" id="L266">            <span class="tok-kw">if</span> (i &lt; in.len) {</span>
<span class="line" id="L267">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L268">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L269">                hashToBytes(<span class="tok-number">1</span>, buf[<span class="tok-number">0</span>..<span class="tok-number">64</span>], x);</span>
<span class="line" id="L270"></span>
<span class="line" id="L271">                <span class="tok-kw">var</span> xout = out[i..];</span>
<span class="line" id="L272">                <span class="tok-kw">const</span> xin = in[i..];</span>
<span class="line" id="L273">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..in.len % <span class="tok-number">64</span>) |j| {</span>
<span class="line" id="L274">                    xout[j] = xin[j] ^ buf[j];</span>
<span class="line" id="L275">                }</span>
<span class="line" id="L276">            }</span>
<span class="line" id="L277">        }</span>
<span class="line" id="L278"></span>
<span class="line" id="L279">        <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Stream</span>(out: []<span class="tok-type">u8</span>, key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, nonce_and_counter: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>, <span class="tok-kw">comptime</span> count64: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L280">            <span class="tok-kw">var</span> ctx = initContext(key, nonce_and_counter);</span>
<span class="line" id="L281">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L282">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L283">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> ([_]<span class="tok-type">comptime_int</span>{ <span class="tok-number">4</span>, <span class="tok-number">2</span>, <span class="tok-number">1</span> }) |d| {</span>
<span class="line" id="L284">                <span class="tok-kw">while</span> (degree &gt;= d <span class="tok-kw">and</span> i + <span class="tok-number">64</span> * d &lt;= out.len) : (i += <span class="tok-number">64</span> * d) {</span>
<span class="line" id="L285">                    chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L286">                    contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L287">                    hashToBytes(d, out[i..][<span class="tok-number">0</span> .. <span class="tok-number">64</span> * d], x);</span>
<span class="line" id="L288">                    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..d) |d_| {</span>
<span class="line" id="L289">                        <span class="tok-kw">if</span> (count64) {</span>
<span class="line" id="L290">                            <span class="tok-kw">const</span> next = <span class="tok-builtin">@addWithOverflow</span>(ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_], d);</span>
<span class="line" id="L291">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_] = next[<span class="tok-number">0</span>];</span>
<span class="line" id="L292">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_ + <span class="tok-number">1</span>] +%= next[<span class="tok-number">1</span>];</span>
<span class="line" id="L293">                        } <span class="tok-kw">else</span> {</span>
<span class="line" id="L294">                            ctx[<span class="tok-number">3</span>][<span class="tok-number">4</span> * d_] +%= d;</span>
<span class="line" id="L295">                        }</span>
<span class="line" id="L296">                    }</span>
<span class="line" id="L297">                }</span>
<span class="line" id="L298">            }</span>
<span class="line" id="L299">            <span class="tok-kw">if</span> (i &lt; out.len) {</span>
<span class="line" id="L300">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L301">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L302"></span>
<span class="line" id="L303">                <span class="tok-kw">var</span> buf: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L304">                hashToBytes(<span class="tok-number">1</span>, buf[<span class="tok-number">0</span>..], x);</span>
<span class="line" id="L305">                <span class="tok-builtin">@memcpy</span>(out[i..], buf[<span class="tok-number">0</span> .. out.len - i]);</span>
<span class="line" id="L306">            }</span>
<span class="line" id="L307">        }</span>
<span class="line" id="L308"></span>
<span class="line" id="L309">        <span class="tok-kw">fn</span> <span class="tok-fn">hchacha20</span>(input: [<span class="tok-number">16</span>]<span class="tok-type">u8</span>, key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) [<span class="tok-number">32</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L310">            <span class="tok-kw">var</span> c: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L311">            <span class="tok-kw">for</span> (c, <span class="tok-number">0</span>..) |_, i| {</span>
<span class="line" id="L312">                c[i] = mem.readInt(<span class="tok-type">u32</span>, input[<span class="tok-number">4</span> * i ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L313">            }</span>
<span class="line" id="L314">            <span class="tok-kw">const</span> ctx = initContext(keyToWords(key), c);</span>
<span class="line" id="L315">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L316">            chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L317">            <span class="tok-kw">var</span> out: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L318">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[<span class="tok-number">0</span>][<span class="tok-number">0</span>], .little);</span>
<span class="line" id="L319">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">4</span>..<span class="tok-number">8</span>], x[<span class="tok-number">0</span>][<span class="tok-number">1</span>], .little);</span>
<span class="line" id="L320">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">8</span>..<span class="tok-number">12</span>], x[<span class="tok-number">0</span>][<span class="tok-number">2</span>], .little);</span>
<span class="line" id="L321">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">12</span>..<span class="tok-number">16</span>], x[<span class="tok-number">0</span>][<span class="tok-number">3</span>], .little);</span>
<span class="line" id="L322">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span>..<span class="tok-number">20</span>], x[<span class="tok-number">3</span>][<span class="tok-number">0</span>], .little);</span>
<span class="line" id="L323">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">20</span>..<span class="tok-number">24</span>], x[<span class="tok-number">3</span>][<span class="tok-number">1</span>], .little);</span>
<span class="line" id="L324">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">24</span>..<span class="tok-number">28</span>], x[<span class="tok-number">3</span>][<span class="tok-number">2</span>], .little);</span>
<span class="line" id="L325">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">28</span>..<span class="tok-number">32</span>], x[<span class="tok-number">3</span>][<span class="tok-number">3</span>], .little);</span>
<span class="line" id="L326">            <span class="tok-kw">return</span> out;</span>
<span class="line" id="L327">        }</span>
<span class="line" id="L328">    };</span>
<span class="line" id="L329">}</span>
<span class="line" id="L330"></span>
<span class="line" id="L331"><span class="tok-comment">// Non-vectorized implementation of the core function</span>
</span>
<span class="line" id="L332"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaNonVecImpl</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L333">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L334">        <span class="tok-kw">const</span> BlockVec = [<span class="tok-number">16</span>]<span class="tok-type">u32</span>;</span>
<span class="line" id="L335"></span>
<span class="line" id="L336">        <span class="tok-kw">fn</span> <span class="tok-fn">initContext</span>(key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, d: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>) BlockVec {</span>
<span class="line" id="L337">            <span class="tok-kw">const</span> c = <span class="tok-str">&quot;expand 32-byte k&quot;</span>;</span>
<span class="line" id="L338">            <span class="tok-kw">const</span> constant_le = <span class="tok-kw">comptime</span> [<span class="tok-number">4</span>]<span class="tok-type">u32</span>{</span>
<span class="line" id="L339">                mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little),</span>
<span class="line" id="L340">                mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little),</span>
<span class="line" id="L341">                mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little),</span>
<span class="line" id="L342">                mem.readInt(<span class="tok-type">u32</span>, c[<span class="tok-number">12</span>..<span class="tok-number">16</span>], .little),</span>
<span class="line" id="L343">            };</span>
<span class="line" id="L344">            <span class="tok-kw">return</span> BlockVec{</span>
<span class="line" id="L345">                constant_le[<span class="tok-number">0</span>], constant_le[<span class="tok-number">1</span>], constant_le[<span class="tok-number">2</span>], constant_le[<span class="tok-number">3</span>],</span>
<span class="line" id="L346">                key[<span class="tok-number">0</span>],         key[<span class="tok-number">1</span>],         key[<span class="tok-number">2</span>],         key[<span class="tok-number">3</span>],</span>
<span class="line" id="L347">                key[<span class="tok-number">4</span>],         key[<span class="tok-number">5</span>],         key[<span class="tok-number">6</span>],         key[<span class="tok-number">7</span>],</span>
<span class="line" id="L348">                d[<span class="tok-number">0</span>],           d[<span class="tok-number">1</span>],           d[<span class="tok-number">2</span>],           d[<span class="tok-number">3</span>],</span>
<span class="line" id="L349">            };</span>
<span class="line" id="L350">        }</span>
<span class="line" id="L351"></span>
<span class="line" id="L352">        <span class="tok-kw">const</span> QuarterRound = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L353">            a: <span class="tok-type">usize</span>,</span>
<span class="line" id="L354">            b: <span class="tok-type">usize</span>,</span>
<span class="line" id="L355">            c: <span class="tok-type">usize</span>,</span>
<span class="line" id="L356">            d: <span class="tok-type">usize</span>,</span>
<span class="line" id="L357">        };</span>
<span class="line" id="L358"></span>
<span class="line" id="L359">        <span class="tok-kw">fn</span> <span class="tok-fn">Rp</span>(a: <span class="tok-type">usize</span>, b: <span class="tok-type">usize</span>, c: <span class="tok-type">usize</span>, d: <span class="tok-type">usize</span>) QuarterRound {</span>
<span class="line" id="L360">            <span class="tok-kw">return</span> QuarterRound{</span>
<span class="line" id="L361">                .a = a,</span>
<span class="line" id="L362">                .b = b,</span>
<span class="line" id="L363">                .c = c,</span>
<span class="line" id="L364">                .d = d,</span>
<span class="line" id="L365">            };</span>
<span class="line" id="L366">        }</span>
<span class="line" id="L367"></span>
<span class="line" id="L368">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Core</span>(x: *BlockVec, input: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L369">            x.* = input;</span>
<span class="line" id="L370"></span>
<span class="line" id="L371">            <span class="tok-kw">const</span> rounds = <span class="tok-kw">comptime</span> [_]QuarterRound{</span>
<span class="line" id="L372">                Rp(<span class="tok-number">0</span>, <span class="tok-number">4</span>, <span class="tok-number">8</span>, <span class="tok-number">12</span>),</span>
<span class="line" id="L373">                Rp(<span class="tok-number">1</span>, <span class="tok-number">5</span>, <span class="tok-number">9</span>, <span class="tok-number">13</span>),</span>
<span class="line" id="L374">                Rp(<span class="tok-number">2</span>, <span class="tok-number">6</span>, <span class="tok-number">10</span>, <span class="tok-number">14</span>),</span>
<span class="line" id="L375">                Rp(<span class="tok-number">3</span>, <span class="tok-number">7</span>, <span class="tok-number">11</span>, <span class="tok-number">15</span>),</span>
<span class="line" id="L376">                Rp(<span class="tok-number">0</span>, <span class="tok-number">5</span>, <span class="tok-number">10</span>, <span class="tok-number">15</span>),</span>
<span class="line" id="L377">                Rp(<span class="tok-number">1</span>, <span class="tok-number">6</span>, <span class="tok-number">11</span>, <span class="tok-number">12</span>),</span>
<span class="line" id="L378">                Rp(<span class="tok-number">2</span>, <span class="tok-number">7</span>, <span class="tok-number">8</span>, <span class="tok-number">13</span>),</span>
<span class="line" id="L379">                Rp(<span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">9</span>, <span class="tok-number">14</span>),</span>
<span class="line" id="L380">            };</span>
<span class="line" id="L381"></span>
<span class="line" id="L382">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L383">            <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (j &lt; rounds_nb) : (j += <span class="tok-number">2</span>) {</span>
<span class="line" id="L384">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (rounds) |r| {</span>
<span class="line" id="L385">                    x[r.a] +%= x[r.b];</span>
<span class="line" id="L386">                    x[r.d] = math.rotl(<span class="tok-type">u32</span>, x[r.d] ^ x[r.a], <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">16</span>));</span>
<span class="line" id="L387">                    x[r.c] +%= x[r.d];</span>
<span class="line" id="L388">                    x[r.b] = math.rotl(<span class="tok-type">u32</span>, x[r.b] ^ x[r.c], <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">12</span>));</span>
<span class="line" id="L389">                    x[r.a] +%= x[r.b];</span>
<span class="line" id="L390">                    x[r.d] = math.rotl(<span class="tok-type">u32</span>, x[r.d] ^ x[r.a], <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">8</span>));</span>
<span class="line" id="L391">                    x[r.c] +%= x[r.d];</span>
<span class="line" id="L392">                    x[r.b] = math.rotl(<span class="tok-type">u32</span>, x[r.b] ^ x[r.c], <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-number">7</span>));</span>
<span class="line" id="L393">                }</span>
<span class="line" id="L394">            }</span>
<span class="line" id="L395">        }</span>
<span class="line" id="L396"></span>
<span class="line" id="L397">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">hashToBytes</span>(out: *[<span class="tok-number">64</span>]<span class="tok-type">u8</span>, x: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L398">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">4</span>) |i| {</span>
<span class="line" id="L399">                mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span> * i + <span class="tok-number">0</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i * <span class="tok-number">4</span> + <span class="tok-number">0</span>], .little);</span>
<span class="line" id="L400">                mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span> * i + <span class="tok-number">4</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i * <span class="tok-number">4</span> + <span class="tok-number">1</span>], .little);</span>
<span class="line" id="L401">                mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span> * i + <span class="tok-number">8</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i * <span class="tok-number">4</span> + <span class="tok-number">2</span>], .little);</span>
<span class="line" id="L402">                mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span> * i + <span class="tok-number">12</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[i * <span class="tok-number">4</span> + <span class="tok-number">3</span>], .little);</span>
<span class="line" id="L403">            }</span>
<span class="line" id="L404">        }</span>
<span class="line" id="L405"></span>
<span class="line" id="L406">        <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">contextFeedback</span>(x: *BlockVec, ctx: BlockVec) <span class="tok-type">void</span> {</span>
<span class="line" id="L407">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">16</span>) |i| {</span>
<span class="line" id="L408">                x[i] +%= ctx[i];</span>
<span class="line" id="L409">            }</span>
<span class="line" id="L410">        }</span>
<span class="line" id="L411"></span>
<span class="line" id="L412">        <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Xor</span>(out: []<span class="tok-type">u8</span>, in: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, nonce_and_counter: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>, <span class="tok-kw">comptime</span> count64: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L413">            <span class="tok-kw">var</span> ctx = initContext(key, nonce_and_counter);</span>
<span class="line" id="L414">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L415">            <span class="tok-kw">var</span> buf: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L416">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L417">            <span class="tok-kw">while</span> (i + <span class="tok-number">64</span> &lt;= in.len) : (i += <span class="tok-number">64</span>) {</span>
<span class="line" id="L418">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L419">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L420">                hashToBytes(buf[<span class="tok-number">0</span>..], x);</span>
<span class="line" id="L421"></span>
<span class="line" id="L422">                <span class="tok-kw">var</span> xout = out[i..];</span>
<span class="line" id="L423">                <span class="tok-kw">const</span> xin = in[i..];</span>
<span class="line" id="L424">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">64</span>) |j| {</span>
<span class="line" id="L425">                    xout[j] = xin[j];</span>
<span class="line" id="L426">                }</span>
<span class="line" id="L427">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">64</span>) |j| {</span>
<span class="line" id="L428">                    xout[j] ^= buf[j];</span>
<span class="line" id="L429">                }</span>
<span class="line" id="L430">                <span class="tok-kw">if</span> (count64) {</span>
<span class="line" id="L431">                    <span class="tok-kw">const</span> next = <span class="tok-builtin">@addWithOverflow</span>(ctx[<span class="tok-number">12</span>], <span class="tok-number">1</span>);</span>
<span class="line" id="L432">                    ctx[<span class="tok-number">12</span>] = next[<span class="tok-number">0</span>];</span>
<span class="line" id="L433">                    ctx[<span class="tok-number">13</span>] +%= next[<span class="tok-number">1</span>];</span>
<span class="line" id="L434">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L435">                    ctx[<span class="tok-number">12</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L436">                }</span>
<span class="line" id="L437">            }</span>
<span class="line" id="L438">            <span class="tok-kw">if</span> (i &lt; in.len) {</span>
<span class="line" id="L439">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L440">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L441">                hashToBytes(buf[<span class="tok-number">0</span>..], x);</span>
<span class="line" id="L442"></span>
<span class="line" id="L443">                <span class="tok-kw">var</span> xout = out[i..];</span>
<span class="line" id="L444">                <span class="tok-kw">const</span> xin = in[i..];</span>
<span class="line" id="L445">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..in.len % <span class="tok-number">64</span>) |j| {</span>
<span class="line" id="L446">                    xout[j] = xin[j] ^ buf[j];</span>
<span class="line" id="L447">                }</span>
<span class="line" id="L448">            }</span>
<span class="line" id="L449">        }</span>
<span class="line" id="L450"></span>
<span class="line" id="L451">        <span class="tok-kw">fn</span> <span class="tok-fn">chacha20Stream</span>(out: []<span class="tok-type">u8</span>, key: [<span class="tok-number">8</span>]<span class="tok-type">u32</span>, nonce_and_counter: [<span class="tok-number">4</span>]<span class="tok-type">u32</span>, <span class="tok-kw">comptime</span> count64: <span class="tok-type">bool</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L452">            <span class="tok-kw">var</span> ctx = initContext(key, nonce_and_counter);</span>
<span class="line" id="L453">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L454">            <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L455">            <span class="tok-kw">while</span> (i + <span class="tok-number">64</span> &lt;= out.len) : (i += <span class="tok-number">64</span>) {</span>
<span class="line" id="L456">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L457">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L458">                hashToBytes(out[i..][<span class="tok-number">0</span>..<span class="tok-number">64</span>], x);</span>
<span class="line" id="L459">                <span class="tok-kw">if</span> (count64) {</span>
<span class="line" id="L460">                    <span class="tok-kw">const</span> next = <span class="tok-builtin">@addWithOverflow</span>(ctx[<span class="tok-number">12</span>], <span class="tok-number">1</span>);</span>
<span class="line" id="L461">                    ctx[<span class="tok-number">12</span>] = next[<span class="tok-number">0</span>];</span>
<span class="line" id="L462">                    ctx[<span class="tok-number">13</span>] +%= next[<span class="tok-number">1</span>];</span>
<span class="line" id="L463">                } <span class="tok-kw">else</span> {</span>
<span class="line" id="L464">                    ctx[<span class="tok-number">12</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L465">                }</span>
<span class="line" id="L466">            }</span>
<span class="line" id="L467">            <span class="tok-kw">if</span> (i &lt; out.len) {</span>
<span class="line" id="L468">                chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L469">                contextFeedback(&amp;x, ctx);</span>
<span class="line" id="L470"></span>
<span class="line" id="L471">                <span class="tok-kw">var</span> buf: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L472">                hashToBytes(buf[<span class="tok-number">0</span>..], x);</span>
<span class="line" id="L473">                <span class="tok-builtin">@memcpy</span>(out[i..], buf[<span class="tok-number">0</span> .. out.len - i]);</span>
<span class="line" id="L474">            }</span>
<span class="line" id="L475">        }</span>
<span class="line" id="L476"></span>
<span class="line" id="L477">        <span class="tok-kw">fn</span> <span class="tok-fn">hchacha20</span>(input: [<span class="tok-number">16</span>]<span class="tok-type">u8</span>, key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) [<span class="tok-number">32</span>]<span class="tok-type">u8</span> {</span>
<span class="line" id="L478">            <span class="tok-kw">var</span> c: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L479">            <span class="tok-kw">for</span> (c, <span class="tok-number">0</span>..) |_, i| {</span>
<span class="line" id="L480">                c[i] = mem.readInt(<span class="tok-type">u32</span>, input[<span class="tok-number">4</span> * i ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L481">            }</span>
<span class="line" id="L482">            <span class="tok-kw">const</span> ctx = initContext(keyToWords(key), c);</span>
<span class="line" id="L483">            <span class="tok-kw">var</span> x: BlockVec = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L484">            chacha20Core(x[<span class="tok-number">0</span>..], ctx);</span>
<span class="line" id="L485">            <span class="tok-kw">var</span> out: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L486">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">0</span>..<span class="tok-number">4</span>], x[<span class="tok-number">0</span>], .little);</span>
<span class="line" id="L487">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">4</span>..<span class="tok-number">8</span>], x[<span class="tok-number">1</span>], .little);</span>
<span class="line" id="L488">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">8</span>..<span class="tok-number">12</span>], x[<span class="tok-number">2</span>], .little);</span>
<span class="line" id="L489">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">12</span>..<span class="tok-number">16</span>], x[<span class="tok-number">3</span>], .little);</span>
<span class="line" id="L490">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">16</span>..<span class="tok-number">20</span>], x[<span class="tok-number">12</span>], .little);</span>
<span class="line" id="L491">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">20</span>..<span class="tok-number">24</span>], x[<span class="tok-number">13</span>], .little);</span>
<span class="line" id="L492">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">24</span>..<span class="tok-number">28</span>], x[<span class="tok-number">14</span>], .little);</span>
<span class="line" id="L493">            mem.writeInt(<span class="tok-type">u32</span>, out[<span class="tok-number">28</span>..<span class="tok-number">32</span>], x[<span class="tok-number">15</span>], .little);</span>
<span class="line" id="L494">            <span class="tok-kw">return</span> out;</span>
<span class="line" id="L495">        }</span>
<span class="line" id="L496">    };</span>
<span class="line" id="L497">}</span>
<span class="line" id="L498"></span>
<span class="line" id="L499"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaImpl</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L500">    <span class="tok-kw">switch</span> (builtin.cpu.arch) {</span>
<span class="line" id="L501">        .x86_64 =&gt; {</span>
<span class="line" id="L502">            <span class="tok-kw">if</span> (builtin.zig_backend == .stage2_x86_64) <span class="tok-kw">return</span> ChaChaNonVecImpl(rounds_nb);</span>
<span class="line" id="L503"></span>
<span class="line" id="L504">            <span class="tok-kw">const</span> has_avx2 = std.Target.x86.featureSetHas(builtin.cpu.features, .avx2);</span>
<span class="line" id="L505">            <span class="tok-kw">const</span> has_avx512f = std.Target.x86.featureSetHas(builtin.cpu.features, .avx512f);</span>
<span class="line" id="L506">            <span class="tok-kw">if</span> (has_avx512f) <span class="tok-kw">return</span> ChaChaVecImpl(rounds_nb, <span class="tok-number">4</span>);</span>
<span class="line" id="L507">            <span class="tok-kw">if</span> (has_avx2) <span class="tok-kw">return</span> ChaChaVecImpl(rounds_nb, <span class="tok-number">2</span>);</span>
<span class="line" id="L508">            <span class="tok-kw">return</span> ChaChaVecImpl(rounds_nb, <span class="tok-number">1</span>);</span>
<span class="line" id="L509">        },</span>
<span class="line" id="L510">        .aarch64 =&gt; {</span>
<span class="line" id="L511">            <span class="tok-kw">const</span> has_neon = std.Target.aarch64.featureSetHas(builtin.cpu.features, .neon);</span>
<span class="line" id="L512">            <span class="tok-kw">if</span> (has_neon) <span class="tok-kw">return</span> ChaChaVecImpl(rounds_nb, <span class="tok-number">4</span>);</span>
<span class="line" id="L513">            <span class="tok-kw">return</span> ChaChaNonVecImpl(rounds_nb);</span>
<span class="line" id="L514">        },</span>
<span class="line" id="L515">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> ChaChaNonVecImpl(rounds_nb),</span>
<span class="line" id="L516">    }</span>
<span class="line" id="L517">}</span>
<span class="line" id="L518"></span>
<span class="line" id="L519"><span class="tok-kw">fn</span> <span class="tok-fn">keyToWords</span>(key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) [<span class="tok-number">8</span>]<span class="tok-type">u32</span> {</span>
<span class="line" id="L520">    <span class="tok-kw">var</span> k: [<span class="tok-number">8</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L521">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">8</span>) |i| {</span>
<span class="line" id="L522">        k[i] = mem.readInt(<span class="tok-type">u32</span>, key[i * <span class="tok-number">4</span> ..][<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L523">    }</span>
<span class="line" id="L524">    <span class="tok-kw">return</span> k;</span>
<span class="line" id="L525">}</span>
<span class="line" id="L526"></span>
<span class="line" id="L527"><span class="tok-kw">fn</span> <span class="tok-fn">extend</span>(key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, nonce: [<span class="tok-number">24</span>]<span class="tok-type">u8</span>, <span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-kw">struct</span> { key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, nonce: [<span class="tok-number">12</span>]<span class="tok-type">u8</span> } {</span>
<span class="line" id="L528">    <span class="tok-kw">var</span> subnonce: [<span class="tok-number">12</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L529">    <span class="tok-builtin">@memset</span>(subnonce[<span class="tok-number">0</span>..<span class="tok-number">4</span>], <span class="tok-number">0</span>);</span>
<span class="line" id="L530">    subnonce[<span class="tok-number">4</span>..].* = nonce[<span class="tok-number">16</span>..<span class="tok-number">24</span>].*;</span>
<span class="line" id="L531">    <span class="tok-kw">return</span> .{</span>
<span class="line" id="L532">        .key = ChaChaImpl(rounds_nb).hchacha20(nonce[<span class="tok-number">0</span>..<span class="tok-number">16</span>].*, key),</span>
<span class="line" id="L533">        .nonce = subnonce,</span>
<span class="line" id="L534">    };</span>
<span class="line" id="L535">}</span>
<span class="line" id="L536"></span>
<span class="line" id="L537"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaIETF</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L538">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L539">        <span class="tok-comment">/// Nonce length in bytes.</span></span>
<span class="line" id="L540">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">12</span>;</span>
<span class="line" id="L541">        <span class="tok-comment">/// Key length in bytes.</span></span>
<span class="line" id="L542">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L543">        <span class="tok-comment">/// Block length in bytes.</span></span>
<span class="line" id="L544">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = <span class="tok-number">64</span>;</span>
<span class="line" id="L545"></span>
<span class="line" id="L546">        <span class="tok-comment">/// Add the output of the ChaCha20 stream cipher to `in` and stores the result into `out`.</span></span>
<span class="line" id="L547">        <span class="tok-comment">/// WARNING: This function doesn't provide authenticated encryption.</span></span>
<span class="line" id="L548">        <span class="tok-comment">/// Using the AEAD or one of the `box` versions is usually preferred.</span></span>
<span class="line" id="L549">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">xor</span>(out: []<span class="tok-type">u8</span>, in: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, counter: <span class="tok-type">u32</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L550">            assert(in.len == out.len);</span>
<span class="line" id="L551">            assert(in.len &lt;= <span class="tok-number">64</span> * (<span class="tok-builtin">@as</span>(<span class="tok-type">u39</span>, <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">32</span>) - counter));</span>
<span class="line" id="L552"></span>
<span class="line" id="L553">            <span class="tok-kw">var</span> d: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L554">            d[<span class="tok-number">0</span>] = counter;</span>
<span class="line" id="L555">            d[<span class="tok-number">1</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L556">            d[<span class="tok-number">2</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little);</span>
<span class="line" id="L557">            d[<span class="tok-number">3</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little);</span>
<span class="line" id="L558">            ChaChaImpl(rounds_nb).chacha20Xor(out, in, keyToWords(key), d, <span class="tok-null">false</span>);</span>
<span class="line" id="L559">        }</span>
<span class="line" id="L560"></span>
<span class="line" id="L561">        <span class="tok-comment">/// Write the output of the ChaCha20 stream cipher into `out`.</span></span>
<span class="line" id="L562">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">stream</span>(out: []<span class="tok-type">u8</span>, counter: <span class="tok-type">u32</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L563">            assert(out.len &lt;= <span class="tok-number">64</span> * (<span class="tok-builtin">@as</span>(<span class="tok-type">u39</span>, <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">32</span>) - counter));</span>
<span class="line" id="L564"></span>
<span class="line" id="L565">            <span class="tok-kw">var</span> d: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L566">            d[<span class="tok-number">0</span>] = counter;</span>
<span class="line" id="L567">            d[<span class="tok-number">1</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L568">            d[<span class="tok-number">2</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little);</span>
<span class="line" id="L569">            d[<span class="tok-number">3</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">8</span>..<span class="tok-number">12</span>], .little);</span>
<span class="line" id="L570">            ChaChaImpl(rounds_nb).chacha20Stream(out, keyToWords(key), d, <span class="tok-null">false</span>);</span>
<span class="line" id="L571">        }</span>
<span class="line" id="L572">    };</span>
<span class="line" id="L573">}</span>
<span class="line" id="L574"></span>
<span class="line" id="L575"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaWith64BitNonce</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L576">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L577">        <span class="tok-comment">/// Nonce length in bytes.</span></span>
<span class="line" id="L578">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">8</span>;</span>
<span class="line" id="L579">        <span class="tok-comment">/// Key length in bytes.</span></span>
<span class="line" id="L580">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L581">        <span class="tok-comment">/// Block length in bytes.</span></span>
<span class="line" id="L582">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = <span class="tok-number">64</span>;</span>
<span class="line" id="L583"></span>
<span class="line" id="L584">        <span class="tok-comment">/// Add the output of the ChaCha20 stream cipher to `in` and stores the result into `out`.</span></span>
<span class="line" id="L585">        <span class="tok-comment">/// WARNING: This function doesn't provide authenticated encryption.</span></span>
<span class="line" id="L586">        <span class="tok-comment">/// Using the AEAD or one of the `box` versions is usually preferred.</span></span>
<span class="line" id="L587">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">xor</span>(out: []<span class="tok-type">u8</span>, in: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, counter: <span class="tok-type">u64</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L588">            assert(in.len == out.len);</span>
<span class="line" id="L589">            assert(in.len &lt;= <span class="tok-number">64</span> * (<span class="tok-builtin">@as</span>(<span class="tok-type">u71</span>, <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">64</span>) - counter));</span>
<span class="line" id="L590"></span>
<span class="line" id="L591">            <span class="tok-kw">const</span> k = keyToWords(key);</span>
<span class="line" id="L592">            <span class="tok-kw">var</span> c: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L593">            c[<span class="tok-number">0</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(counter));</span>
<span class="line" id="L594">            c[<span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(counter &gt;&gt; <span class="tok-number">32</span>));</span>
<span class="line" id="L595">            c[<span class="tok-number">2</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L596">            c[<span class="tok-number">3</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little);</span>
<span class="line" id="L597">            ChaChaImpl(rounds_nb).chacha20Xor(out, in, k, c, <span class="tok-null">true</span>);</span>
<span class="line" id="L598">        }</span>
<span class="line" id="L599"></span>
<span class="line" id="L600">        <span class="tok-comment">/// Write the output of the ChaCha20 stream cipher into `out`.</span></span>
<span class="line" id="L601">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">stream</span>(out: []<span class="tok-type">u8</span>, counter: <span class="tok-type">u32</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L602">            assert(out.len &lt;= <span class="tok-number">64</span> * (<span class="tok-builtin">@as</span>(<span class="tok-type">u71</span>, <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">64</span>) - counter));</span>
<span class="line" id="L603"></span>
<span class="line" id="L604">            <span class="tok-kw">const</span> k = keyToWords(key);</span>
<span class="line" id="L605">            <span class="tok-kw">var</span> c: [<span class="tok-number">4</span>]<span class="tok-type">u32</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L606">            c[<span class="tok-number">0</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(counter));</span>
<span class="line" id="L607">            c[<span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(counter &gt;&gt; <span class="tok-number">32</span>));</span>
<span class="line" id="L608">            c[<span class="tok-number">2</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">0</span>..<span class="tok-number">4</span>], .little);</span>
<span class="line" id="L609">            c[<span class="tok-number">3</span>] = mem.readInt(<span class="tok-type">u32</span>, nonce[<span class="tok-number">4</span>..<span class="tok-number">8</span>], .little);</span>
<span class="line" id="L610">            ChaChaImpl(rounds_nb).chacha20Stream(out, k, c, <span class="tok-null">true</span>);</span>
<span class="line" id="L611">        }</span>
<span class="line" id="L612">    };</span>
<span class="line" id="L613">}</span>
<span class="line" id="L614"></span>
<span class="line" id="L615"><span class="tok-kw">fn</span> <span class="tok-fn">XChaChaIETF</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L616">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L617">        <span class="tok-comment">/// Nonce length in bytes.</span></span>
<span class="line" id="L618">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">24</span>;</span>
<span class="line" id="L619">        <span class="tok-comment">/// Key length in bytes.</span></span>
<span class="line" id="L620">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L621">        <span class="tok-comment">/// Block length in bytes.</span></span>
<span class="line" id="L622">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> block_length = <span class="tok-number">64</span>;</span>
<span class="line" id="L623"></span>
<span class="line" id="L624">        <span class="tok-comment">/// Add the output of the XChaCha20 stream cipher to `in` and stores the result into `out`.</span></span>
<span class="line" id="L625">        <span class="tok-comment">/// WARNING: This function doesn't provide authenticated encryption.</span></span>
<span class="line" id="L626">        <span class="tok-comment">/// Using the AEAD or one of the `box` versions is usually preferred.</span></span>
<span class="line" id="L627">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">xor</span>(out: []<span class="tok-type">u8</span>, in: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, counter: <span class="tok-type">u32</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L628">            <span class="tok-kw">const</span> extended = extend(key, nonce, rounds_nb);</span>
<span class="line" id="L629">            ChaChaIETF(rounds_nb).xor(out, in, counter, extended.key, extended.nonce);</span>
<span class="line" id="L630">        }</span>
<span class="line" id="L631"></span>
<span class="line" id="L632">        <span class="tok-comment">/// Write the output of the XChaCha20 stream cipher into `out`.</span></span>
<span class="line" id="L633">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">stream</span>(out: []<span class="tok-type">u8</span>, counter: <span class="tok-type">u32</span>, key: [key_length]<span class="tok-type">u8</span>, nonce: [nonce_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L634">            <span class="tok-kw">const</span> extended = extend(key, nonce, rounds_nb);</span>
<span class="line" id="L635">            ChaChaIETF(rounds_nb).xor(out, counter, extended.key, extended.nonce);</span>
<span class="line" id="L636">        }</span>
<span class="line" id="L637">    };</span>
<span class="line" id="L638">}</span>
<span class="line" id="L639"></span>
<span class="line" id="L640"><span class="tok-kw">fn</span> <span class="tok-fn">ChaChaPoly1305</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L641">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L642">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> tag_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L643">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">12</span>;</span>
<span class="line" id="L644">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L645"></span>
<span class="line" id="L646">        <span class="tok-comment">/// c: ciphertext: output buffer should be of size m.len</span></span>
<span class="line" id="L647">        <span class="tok-comment">/// tag: authentication tag: output MAC</span></span>
<span class="line" id="L648">        <span class="tok-comment">/// m: message</span></span>
<span class="line" id="L649">        <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L650">        <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L651">        <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L652">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(c: []<span class="tok-type">u8</span>, tag: *[tag_length]<span class="tok-type">u8</span>, m: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, k: [key_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L653">            assert(c.len == m.len);</span>
<span class="line" id="L654">            assert(m.len &lt;= <span class="tok-number">64</span> * (<span class="tok-builtin">@as</span>(<span class="tok-type">u39</span>, <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">32</span>) - <span class="tok-number">1</span>));</span>
<span class="line" id="L655"></span>
<span class="line" id="L656">            <span class="tok-kw">var</span> polyKey = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L657">            ChaChaIETF(rounds_nb).xor(polyKey[<span class="tok-number">0</span>..], polyKey[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, k, npub);</span>
<span class="line" id="L658"></span>
<span class="line" id="L659">            ChaChaIETF(rounds_nb).xor(c[<span class="tok-number">0</span>..m.len], m, <span class="tok-number">1</span>, k, npub);</span>
<span class="line" id="L660"></span>
<span class="line" id="L661">            <span class="tok-kw">var</span> mac = Poly1305.init(polyKey[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L662">            mac.update(ad);</span>
<span class="line" id="L663">            <span class="tok-kw">if</span> (ad.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L664">                <span class="tok-kw">const</span> zeros = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L665">                <span class="tok-kw">const</span> padding = <span class="tok-number">16</span> - (ad.len % <span class="tok-number">16</span>);</span>
<span class="line" id="L666">                mac.update(zeros[<span class="tok-number">0</span>..padding]);</span>
<span class="line" id="L667">            }</span>
<span class="line" id="L668">            mac.update(c[<span class="tok-number">0</span>..m.len]);</span>
<span class="line" id="L669">            <span class="tok-kw">if</span> (m.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L670">                <span class="tok-kw">const</span> zeros = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L671">                <span class="tok-kw">const</span> padding = <span class="tok-number">16</span> - (m.len % <span class="tok-number">16</span>);</span>
<span class="line" id="L672">                mac.update(zeros[<span class="tok-number">0</span>..padding]);</span>
<span class="line" id="L673">            }</span>
<span class="line" id="L674">            <span class="tok-kw">var</span> lens: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L675">            mem.writeInt(<span class="tok-type">u64</span>, lens[<span class="tok-number">0</span>..<span class="tok-number">8</span>], ad.len, .little);</span>
<span class="line" id="L676">            mem.writeInt(<span class="tok-type">u64</span>, lens[<span class="tok-number">8</span>..<span class="tok-number">16</span>], m.len, .little);</span>
<span class="line" id="L677">            mac.update(lens[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L678">            mac.final(tag);</span>
<span class="line" id="L679">        }</span>
<span class="line" id="L680"></span>
<span class="line" id="L681">        <span class="tok-comment">/// `m`: Message</span></span>
<span class="line" id="L682">        <span class="tok-comment">/// `c`: Ciphertext</span></span>
<span class="line" id="L683">        <span class="tok-comment">/// `tag`: Authentication tag</span></span>
<span class="line" id="L684">        <span class="tok-comment">/// `ad`: Associated data</span></span>
<span class="line" id="L685">        <span class="tok-comment">/// `npub`: Public nonce</span></span>
<span class="line" id="L686">        <span class="tok-comment">/// `k`: Private key</span></span>
<span class="line" id="L687">        <span class="tok-comment">/// Asserts `c.len == m.len`.</span></span>
<span class="line" id="L688">        <span class="tok-comment">///</span></span>
<span class="line" id="L689">        <span class="tok-comment">/// Contents of `m` are undefined if an error is returned.</span></span>
<span class="line" id="L690">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decrypt</span>(m: []<span class="tok-type">u8</span>, c: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, tag: [tag_length]<span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, k: [key_length]<span class="tok-type">u8</span>) AuthenticationError!<span class="tok-type">void</span> {</span>
<span class="line" id="L691">            assert(c.len == m.len);</span>
<span class="line" id="L692"></span>
<span class="line" id="L693">            <span class="tok-kw">var</span> polyKey = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L694">            ChaChaIETF(rounds_nb).xor(polyKey[<span class="tok-number">0</span>..], polyKey[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, k, npub);</span>
<span class="line" id="L695"></span>
<span class="line" id="L696">            <span class="tok-kw">var</span> mac = Poly1305.init(polyKey[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L697"></span>
<span class="line" id="L698">            mac.update(ad);</span>
<span class="line" id="L699">            <span class="tok-kw">if</span> (ad.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L700">                <span class="tok-kw">const</span> zeros = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L701">                <span class="tok-kw">const</span> padding = <span class="tok-number">16</span> - (ad.len % <span class="tok-number">16</span>);</span>
<span class="line" id="L702">                mac.update(zeros[<span class="tok-number">0</span>..padding]);</span>
<span class="line" id="L703">            }</span>
<span class="line" id="L704">            mac.update(c);</span>
<span class="line" id="L705">            <span class="tok-kw">if</span> (c.len % <span class="tok-number">16</span> != <span class="tok-number">0</span>) {</span>
<span class="line" id="L706">                <span class="tok-kw">const</span> zeros = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** <span class="tok-number">16</span>;</span>
<span class="line" id="L707">                <span class="tok-kw">const</span> padding = <span class="tok-number">16</span> - (c.len % <span class="tok-number">16</span>);</span>
<span class="line" id="L708">                mac.update(zeros[<span class="tok-number">0</span>..padding]);</span>
<span class="line" id="L709">            }</span>
<span class="line" id="L710">            <span class="tok-kw">var</span> lens: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L711">            mem.writeInt(<span class="tok-type">u64</span>, lens[<span class="tok-number">0</span>..<span class="tok-number">8</span>], ad.len, .little);</span>
<span class="line" id="L712">            mem.writeInt(<span class="tok-type">u64</span>, lens[<span class="tok-number">8</span>..<span class="tok-number">16</span>], c.len, .little);</span>
<span class="line" id="L713">            mac.update(lens[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L714">            <span class="tok-kw">var</span> computed_tag: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L715">            mac.final(computed_tag[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L716"></span>
<span class="line" id="L717">            <span class="tok-kw">const</span> verify = crypto.utils.timingSafeEql([tag_length]<span class="tok-type">u8</span>, computed_tag, tag);</span>
<span class="line" id="L718">            <span class="tok-kw">if</span> (!verify) {</span>
<span class="line" id="L719">                crypto.utils.secureZero(<span class="tok-type">u8</span>, &amp;computed_tag);</span>
<span class="line" id="L720">                <span class="tok-builtin">@memset</span>(m, <span class="tok-null">undefined</span>);</span>
<span class="line" id="L721">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AuthenticationFailed;</span>
<span class="line" id="L722">            }</span>
<span class="line" id="L723">            ChaChaIETF(rounds_nb).xor(m[<span class="tok-number">0</span>..c.len], c, <span class="tok-number">1</span>, k, npub);</span>
<span class="line" id="L724">        }</span>
<span class="line" id="L725">    };</span>
<span class="line" id="L726">}</span>
<span class="line" id="L727"></span>
<span class="line" id="L728"><span class="tok-kw">fn</span> <span class="tok-fn">XChaChaPoly1305</span>(<span class="tok-kw">comptime</span> rounds_nb: <span class="tok-type">usize</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L729">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L730">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> tag_length = <span class="tok-number">16</span>;</span>
<span class="line" id="L731">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> nonce_length = <span class="tok-number">24</span>;</span>
<span class="line" id="L732">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> key_length = <span class="tok-number">32</span>;</span>
<span class="line" id="L733"></span>
<span class="line" id="L734">        <span class="tok-comment">/// c: ciphertext: output buffer should be of size m.len</span></span>
<span class="line" id="L735">        <span class="tok-comment">/// tag: authentication tag: output MAC</span></span>
<span class="line" id="L736">        <span class="tok-comment">/// m: message</span></span>
<span class="line" id="L737">        <span class="tok-comment">/// ad: Associated Data</span></span>
<span class="line" id="L738">        <span class="tok-comment">/// npub: public nonce</span></span>
<span class="line" id="L739">        <span class="tok-comment">/// k: private key</span></span>
<span class="line" id="L740">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(c: []<span class="tok-type">u8</span>, tag: *[tag_length]<span class="tok-type">u8</span>, m: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, k: [key_length]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L741">            <span class="tok-kw">const</span> extended = extend(k, npub, rounds_nb);</span>
<span class="line" id="L742">            <span class="tok-kw">return</span> ChaChaPoly1305(rounds_nb).encrypt(c, tag, m, ad, extended.nonce, extended.key);</span>
<span class="line" id="L743">        }</span>
<span class="line" id="L744"></span>
<span class="line" id="L745">        <span class="tok-comment">/// `m`: Message</span></span>
<span class="line" id="L746">        <span class="tok-comment">/// `c`: Ciphertext</span></span>
<span class="line" id="L747">        <span class="tok-comment">/// `tag`: Authentication tag</span></span>
<span class="line" id="L748">        <span class="tok-comment">/// `ad`: Associated data</span></span>
<span class="line" id="L749">        <span class="tok-comment">/// `npub`: Public nonce</span></span>
<span class="line" id="L750">        <span class="tok-comment">/// `k`: Private key</span></span>
<span class="line" id="L751">        <span class="tok-comment">/// Asserts `c.len == m.len`.</span></span>
<span class="line" id="L752">        <span class="tok-comment">///</span></span>
<span class="line" id="L753">        <span class="tok-comment">/// Contents of `m` are undefined if an error is returned.</span></span>
<span class="line" id="L754">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decrypt</span>(m: []<span class="tok-type">u8</span>, c: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, tag: [tag_length]<span class="tok-type">u8</span>, ad: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, npub: [nonce_length]<span class="tok-type">u8</span>, k: [key_length]<span class="tok-type">u8</span>) AuthenticationError!<span class="tok-type">void</span> {</span>
<span class="line" id="L755">            <span class="tok-kw">const</span> extended = extend(k, npub, rounds_nb);</span>
<span class="line" id="L756">            <span class="tok-kw">return</span> ChaChaPoly1305(rounds_nb).decrypt(m, c, tag, ad, extended.nonce, extended.key);</span>
<span class="line" id="L757">        }</span>
<span class="line" id="L758">    };</span>
<span class="line" id="L759">}</span>
<span class="line" id="L760"></span>
<span class="line" id="L761"><span class="tok-kw">test</span> <span class="tok-str">&quot;chacha20 AEAD API&quot;</span> {</span>
<span class="line" id="L762">    <span class="tok-kw">const</span> aeads = [_]<span class="tok-type">type</span>{ ChaCha20Poly1305, XChaCha20Poly1305 };</span>
<span class="line" id="L763">    <span class="tok-kw">const</span> m = <span class="tok-str">&quot;Ladies and Gentlemen of the class of '99: If I could offer you only one tip for the future, sunscreen would be it.&quot;</span>;</span>
<span class="line" id="L764">    <span class="tok-kw">const</span> ad = <span class="tok-str">&quot;Additional data&quot;</span>;</span>
<span class="line" id="L765"></span>
<span class="line" id="L766">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (aeads) |aead| {</span>
<span class="line" id="L767">        <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{<span class="tok-number">69</span>} ** aead.key_length;</span>
<span class="line" id="L768">        <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{<span class="tok-number">42</span>} ** aead.nonce_length;</span>
<span class="line" id="L769">        <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L770">        <span class="tok-kw">var</span> tag: [aead.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L771">        <span class="tok-kw">var</span> out: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L772"></span>
<span class="line" id="L773">        aead.encrypt(c[<span class="tok-number">0</span>..], tag[<span class="tok-number">0</span>..], m, ad, nonce, key);</span>
<span class="line" id="L774">        <span class="tok-kw">try</span> aead.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..], tag, ad[<span class="tok-number">0</span>..], nonce, key);</span>
<span class="line" id="L775">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, out[<span class="tok-number">0</span>..], m);</span>
<span class="line" id="L776">        c[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L777">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, aead.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..], tag, ad[<span class="tok-number">0</span>..], nonce, key));</span>
<span class="line" id="L778">    }</span>
<span class="line" id="L779">}</span>
<span class="line" id="L780"></span>
<span class="line" id="L781"><span class="tok-comment">// https://tools.ietf.org/html/rfc7539#section-2.4.2</span>
</span>
<span class="line" id="L782"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector sunscreen&quot;</span> {</span>
<span class="line" id="L783">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L784">        <span class="tok-number">0x6e</span>, <span class="tok-number">0x2e</span>, <span class="tok-number">0x35</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x25</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0xf9</span>, <span class="tok-number">0x80</span>,</span>
<span class="line" id="L785">        <span class="tok-number">0x41</span>, <span class="tok-number">0xba</span>, <span class="tok-number">0x07</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0xdd</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x81</span>,</span>
<span class="line" id="L786">        <span class="tok-number">0xe9</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0xec</span>, <span class="tok-number">0x1d</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0xc2</span>,</span>
<span class="line" id="L787">        <span class="tok-number">0x0a</span>, <span class="tok-number">0x27</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0xcc</span>, <span class="tok-number">0xfd</span>, <span class="tok-number">0x9f</span>, <span class="tok-number">0xae</span>, <span class="tok-number">0x0b</span>,</span>
<span class="line" id="L788">        <span class="tok-number">0xf9</span>, <span class="tok-number">0x1b</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0xc5</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x33</span>, <span class="tok-number">0xab</span>,</span>
<span class="line" id="L789">        <span class="tok-number">0x8f</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0xab</span>, <span class="tok-number">0xcd</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0xb3</span>, <span class="tok-number">0x57</span>,</span>
<span class="line" id="L790">        <span class="tok-number">0x16</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0xd6</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0xe6</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0xab</span>,</span>
<span class="line" id="L791">        <span class="tok-number">0x8f</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x35</span>, <span class="tok-number">0x9f</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0xd8</span>,</span>
<span class="line" id="L792">        <span class="tok-number">0x07</span>, <span class="tok-number">0xca</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0xbf</span>, <span class="tok-number">0x50</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x6a</span>, <span class="tok-number">0x61</span>,</span>
<span class="line" id="L793">        <span class="tok-number">0x56</span>, <span class="tok-number">0xa3</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0x22</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0x5e</span>,</span>
<span class="line" id="L794">        <span class="tok-number">0x52</span>, <span class="tok-number">0xbc</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x4d</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0xcc</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0x06</span>,</span>
<span class="line" id="L795">        <span class="tok-number">0x81</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0xe9</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0xb7</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x36</span>,</span>
<span class="line" id="L796">        <span class="tok-number">0x5a</span>, <span class="tok-number">0xf9</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0xbf</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0xa3</span>, <span class="tok-number">0x5b</span>, <span class="tok-number">0xe6</span>,</span>
<span class="line" id="L797">        <span class="tok-number">0xb4</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0xed</span>, <span class="tok-number">0xf2</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0x5e</span>, <span class="tok-number">0x42</span>,</span>
<span class="line" id="L798">        <span class="tok-number">0x87</span>, <span class="tok-number">0x4d</span>,</span>
<span class="line" id="L799">    };</span>
<span class="line" id="L800">    <span class="tok-kw">const</span> m = <span class="tok-str">&quot;Ladies and Gentlemen of the class of '99: If I could offer you only one tip for the future, sunscreen would be it.&quot;</span>;</span>
<span class="line" id="L801">    <span class="tok-kw">var</span> result: [<span class="tok-number">114</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L802">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L803">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">3</span>,  <span class="tok-number">4</span>,  <span class="tok-number">5</span>,  <span class="tok-number">6</span>,  <span class="tok-number">7</span>,</span>
<span class="line" id="L804">        <span class="tok-number">8</span>,  <span class="tok-number">9</span>,  <span class="tok-number">10</span>, <span class="tok-number">11</span>, <span class="tok-number">12</span>, <span class="tok-number">13</span>, <span class="tok-number">14</span>, <span class="tok-number">15</span>,</span>
<span class="line" id="L805">        <span class="tok-number">16</span>, <span class="tok-number">17</span>, <span class="tok-number">18</span>, <span class="tok-number">19</span>, <span class="tok-number">20</span>, <span class="tok-number">21</span>, <span class="tok-number">22</span>, <span class="tok-number">23</span>,</span>
<span class="line" id="L806">        <span class="tok-number">24</span>, <span class="tok-number">25</span>, <span class="tok-number">26</span>, <span class="tok-number">27</span>, <span class="tok-number">28</span>, <span class="tok-number">29</span>, <span class="tok-number">30</span>, <span class="tok-number">31</span>,</span>
<span class="line" id="L807">    };</span>
<span class="line" id="L808">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L809">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L810">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0x4a</span>,</span>
<span class="line" id="L811">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L812">    };</span>
<span class="line" id="L813"></span>
<span class="line" id="L814">    ChaCha20IETF.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">1</span>, key, nonce);</span>
<span class="line" id="L815">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L816"></span>
<span class="line" id="L817">    <span class="tok-kw">var</span> m2: [<span class="tok-number">114</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L818">    ChaCha20IETF.xor(m2[<span class="tok-number">0</span>..], result[<span class="tok-number">0</span>..], <span class="tok-number">1</span>, key, nonce);</span>
<span class="line" id="L819">    <span class="tok-kw">try</span> testing.expect(mem.order(<span class="tok-type">u8</span>, m, &amp;m2) == .eq);</span>
<span class="line" id="L820">}</span>
<span class="line" id="L821"></span>
<span class="line" id="L822"><span class="tok-comment">// https://tools.ietf.org/html/draft-agl-tls-chacha20poly1305-04#section-7</span>
</span>
<span class="line" id="L823"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector 1&quot;</span> {</span>
<span class="line" id="L824">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L825">        <span class="tok-number">0x76</span>, <span class="tok-number">0xb8</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0xa0</span>, <span class="tok-number">0xf1</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0x90</span>,</span>
<span class="line" id="L826">        <span class="tok-number">0x40</span>, <span class="tok-number">0x5d</span>, <span class="tok-number">0x6a</span>, <span class="tok-number">0xe5</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xbd</span>, <span class="tok-number">0x28</span>,</span>
<span class="line" id="L827">        <span class="tok-number">0xbd</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0xb8</span>, <span class="tok-number">0xa0</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0xed</span>, <span class="tok-number">0x1a</span>,</span>
<span class="line" id="L828">        <span class="tok-number">0xa8</span>, <span class="tok-number">0x36</span>, <span class="tok-number">0xef</span>, <span class="tok-number">0xcc</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0xc7</span>,</span>
<span class="line" id="L829">        <span class="tok-number">0xda</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0x7c</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x57</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x8d</span>,</span>
<span class="line" id="L830">        <span class="tok-number">0x77</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0x3f</span>, <span class="tok-number">0xb8</span>, <span class="tok-number">0xd8</span>, <span class="tok-number">0x4a</span>, <span class="tok-number">0x37</span>,</span>
<span class="line" id="L831">        <span class="tok-number">0x6a</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0xb8</span>, <span class="tok-number">0xf4</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0xa1</span>, <span class="tok-number">0x1c</span>,</span>
<span class="line" id="L832">        <span class="tok-number">0xc3</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0xb2</span>, <span class="tok-number">0xee</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x86</span>,</span>
<span class="line" id="L833">    };</span>
<span class="line" id="L834">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L835">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L836">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L837">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L838">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L839">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L840">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L841">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L842">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L843">    };</span>
<span class="line" id="L844">    <span class="tok-kw">var</span> result: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L845">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L846">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L847">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L848">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L849">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L850">    };</span>
<span class="line" id="L851">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> };</span>
<span class="line" id="L852"></span>
<span class="line" id="L853">    ChaCha20With64BitNonce.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L854">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L855">}</span>
<span class="line" id="L856"></span>
<span class="line" id="L857"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector 2&quot;</span> {</span>
<span class="line" id="L858">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L859">        <span class="tok-number">0x45</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0xf0</span>, <span class="tok-number">0x5a</span>, <span class="tok-number">0x9f</span>, <span class="tok-number">0x1f</span>, <span class="tok-number">0xb2</span>, <span class="tok-number">0x96</span>,</span>
<span class="line" id="L860">        <span class="tok-number">0xd7</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x7b</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x3c</span>, <span class="tok-number">0x96</span>,</span>
<span class="line" id="L861">        <span class="tok-number">0xeb</span>, <span class="tok-number">0x4f</span>, <span class="tok-number">0xe1</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x60</span>,</span>
<span class="line" id="L862">        <span class="tok-number">0x4f</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0xed</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x2d</span>, <span class="tok-number">0x41</span>,</span>
<span class="line" id="L863">        <span class="tok-number">0xbb</span>, <span class="tok-number">0xe2</span>, <span class="tok-number">0xa0</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0xea</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0xd2</span>,</span>
<span class="line" id="L864">        <span class="tok-number">0xa5</span>, <span class="tok-number">0xd1</span>, <span class="tok-number">0xe7</span>, <span class="tok-number">0xe2</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0x2c</span>,</span>
<span class="line" id="L865">        <span class="tok-number">0x53</span>, <span class="tok-number">0xd7</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0xb1</span>, <span class="tok-number">0xc4</span>, <span class="tok-number">0x3f</span>, <span class="tok-number">0xea</span>, <span class="tok-number">0x81</span>,</span>
<span class="line" id="L866">        <span class="tok-number">0x7e</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0xae</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x63</span>,</span>
<span class="line" id="L867">    };</span>
<span class="line" id="L868">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L869">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L870">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L871">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L872">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L873">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L874">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L875">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L876">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L877">    };</span>
<span class="line" id="L878">    <span class="tok-kw">var</span> result: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L879">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L880">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L881">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L882">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L883">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span>,</span>
<span class="line" id="L884">    };</span>
<span class="line" id="L885">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> };</span>
<span class="line" id="L886"></span>
<span class="line" id="L887">    ChaCha20With64BitNonce.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L888">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L889">}</span>
<span class="line" id="L890"></span>
<span class="line" id="L891"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector 3&quot;</span> {</span>
<span class="line" id="L892">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L893">        <span class="tok-number">0xde</span>, <span class="tok-number">0x9c</span>, <span class="tok-number">0xba</span>, <span class="tok-number">0x7b</span>, <span class="tok-number">0xf3</span>, <span class="tok-number">0xd6</span>, <span class="tok-number">0x9e</span>, <span class="tok-number">0xf5</span>,</span>
<span class="line" id="L894">        <span class="tok-number">0xe7</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xdc</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0x3f</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x3a</span>,</span>
<span class="line" id="L895">        <span class="tok-number">0x0b</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0xbf</span>, <span class="tok-number">0xf7</span>, <span class="tok-number">0x13</span>,</span>
<span class="line" id="L896">        <span class="tok-number">0x4f</span>, <span class="tok-number">0xcb</span>, <span class="tok-number">0x7d</span>, <span class="tok-number">0xf1</span>, <span class="tok-number">0x37</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x10</span>, <span class="tok-number">0x31</span>,</span>
<span class="line" id="L897">        <span class="tok-number">0xe8</span>, <span class="tok-number">0x5a</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0xa7</span>, <span class="tok-number">0x08</span>, <span class="tok-number">0x45</span>,</span>
<span class="line" id="L898">        <span class="tok-number">0x27</span>, <span class="tok-number">0x21</span>, <span class="tok-number">0x4f</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0xef</span>, <span class="tok-number">0xc7</span>, <span class="tok-number">0xfa</span>, <span class="tok-number">0x5b</span>,</span>
<span class="line" id="L899">        <span class="tok-number">0x52</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x2e</span>, <span class="tok-number">0xb7</span>, <span class="tok-number">0xa0</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x3e</span>,</span>
<span class="line" id="L900">        <span class="tok-number">0x44</span>, <span class="tok-number">0x5f</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0xe3</span>,</span>
<span class="line" id="L901">    };</span>
<span class="line" id="L902">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L903">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L904">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L905">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L906">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L907">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L908">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L909">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L910">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L911">    };</span>
<span class="line" id="L912">    <span class="tok-kw">var</span> result: [<span class="tok-number">60</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L913">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L914">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L915">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L916">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L917">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L918">    };</span>
<span class="line" id="L919">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span> };</span>
<span class="line" id="L920"></span>
<span class="line" id="L921">    ChaCha20With64BitNonce.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L922">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L923">}</span>
<span class="line" id="L924"></span>
<span class="line" id="L925"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector 4&quot;</span> {</span>
<span class="line" id="L926">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L927">        <span class="tok-number">0xef</span>, <span class="tok-number">0x3f</span>, <span class="tok-number">0xdf</span>, <span class="tok-number">0xd6</span>, <span class="tok-number">0xc6</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0xfb</span>,</span>
<span class="line" id="L928">        <span class="tok-number">0xf5</span>, <span class="tok-number">0xcf</span>, <span class="tok-number">0x35</span>, <span class="tok-number">0xbd</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0xd3</span>, <span class="tok-number">0x3b</span>, <span class="tok-number">0x80</span>,</span>
<span class="line" id="L929">        <span class="tok-number">0x09</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x34</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x1e</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0xac</span>,</span>
<span class="line" id="L930">        <span class="tok-number">0x33</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0xd1</span>, <span class="tok-number">0x38</span>, <span class="tok-number">0xe5</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x32</span>,</span>
<span class="line" id="L931">        <span class="tok-number">0x11</span>, <span class="tok-number">0x1e</span>, <span class="tok-number">0x4c</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0x23</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0xe5</span>, <span class="tok-number">0x3c</span>,</span>
<span class="line" id="L932">        <span class="tok-number">0xa8</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x26</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0x4a</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x54</span>,</span>
<span class="line" id="L933">        <span class="tok-number">0x5d</span>, <span class="tok-number">0xdc</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x7d</span>,</span>
<span class="line" id="L934">        <span class="tok-number">0x6b</span>, <span class="tok-number">0xbd</span>, <span class="tok-number">0xb0</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x1b</span>, <span class="tok-number">0x2f</span>, <span class="tok-number">0x58</span>, <span class="tok-number">0x6b</span>,</span>
<span class="line" id="L935">    };</span>
<span class="line" id="L936">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L937">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L938">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L939">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L940">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L941">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L942">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L943">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L944">        <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x00</span>,</span>
<span class="line" id="L945">    };</span>
<span class="line" id="L946">    <span class="tok-kw">var</span> result: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L947">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L948">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L949">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L950">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L951">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L952">    };</span>
<span class="line" id="L953">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">1</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> };</span>
<span class="line" id="L954"></span>
<span class="line" id="L955">    ChaCha20With64BitNonce.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L956">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L957">}</span>
<span class="line" id="L958"></span>
<span class="line" id="L959"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.chacha20 test vector 5&quot;</span> {</span>
<span class="line" id="L960">    <span class="tok-kw">const</span> expected_result = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L961">        <span class="tok-number">0xf7</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0xa1</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0xf1</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0xe6</span>, <span class="tok-number">0x69</span>,</span>
<span class="line" id="L962">        <span class="tok-number">0x82</span>, <span class="tok-number">0x10</span>, <span class="tok-number">0x5f</span>, <span class="tok-number">0xfb</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0xb7</span>, <span class="tok-number">0x75</span>,</span>
<span class="line" id="L963">        <span class="tok-number">0x7f</span>, <span class="tok-number">0x57</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0xa3</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0xfc</span>, <span class="tok-number">0x93</span>,</span>
<span class="line" id="L964">        <span class="tok-number">0xec</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0xac</span>, <span class="tok-number">0x56</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0x5a</span>, <span class="tok-number">0xc3</span>, <span class="tok-number">0xc1</span>,</span>
<span class="line" id="L965">        <span class="tok-number">0x34</span>, <span class="tok-number">0xa4</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0x7b</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x3b</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x41</span>,</span>
<span class="line" id="L966">        <span class="tok-number">0x30</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0xc9</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x69</span>,</span>
<span class="line" id="L967">        <span class="tok-number">0x05</span>, <span class="tok-number">0xd3</span>, <span class="tok-number">0xbe</span>, <span class="tok-number">0x59</span>, <span class="tok-number">0xea</span>, <span class="tok-number">0x1c</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0xf1</span>,</span>
<span class="line" id="L968">        <span class="tok-number">0x59</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x5c</span>, <span class="tok-number">0x2b</span>, <span class="tok-number">0xe8</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0x1a</span>,</span>
<span class="line" id="L969"></span>
<span class="line" id="L970">        <span class="tok-number">0x38</span>, <span class="tok-number">0x00</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x26</span>, <span class="tok-number">0xbc</span>, <span class="tok-number">0x35</span>, <span class="tok-number">0x94</span>,</span>
<span class="line" id="L971">        <span class="tok-number">0x1e</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x7c</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0x66</span>,</span>
<span class="line" id="L972">        <span class="tok-number">0x89</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x26</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xd9</span>, <span class="tok-number">0x58</span>,</span>
<span class="line" id="L973">        <span class="tok-number">0x89</span>, <span class="tok-number">0xfb</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0xe8</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x29</span>, <span class="tok-number">0xc9</span>, <span class="tok-number">0xbd</span>,</span>
<span class="line" id="L974">        <span class="tok-number">0x9a</span>, <span class="tok-number">0x5a</span>, <span class="tok-number">0xcb</span>, <span class="tok-number">0x1c</span>, <span class="tok-number">0xc1</span>, <span class="tok-number">0x18</span>, <span class="tok-number">0xbe</span>, <span class="tok-number">0x56</span>,</span>
<span class="line" id="L975">        <span class="tok-number">0x3e</span>, <span class="tok-number">0xb9</span>, <span class="tok-number">0xb3</span>, <span class="tok-number">0xa4</span>, <span class="tok-number">0xa4</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0xf8</span>, <span class="tok-number">0x2e</span>,</span>
<span class="line" id="L976">        <span class="tok-number">0x09</span>, <span class="tok-number">0xa7</span>, <span class="tok-number">0xe7</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x2b</span>, <span class="tok-number">0x56</span>, <span class="tok-number">0x2e</span>,</span>
<span class="line" id="L977">        <span class="tok-number">0xf7</span>, <span class="tok-number">0x13</span>, <span class="tok-number">0x0e</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0xdf</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0xc7</span>,</span>
<span class="line" id="L978"></span>
<span class="line" id="L979">        <span class="tok-number">0x9d</span>, <span class="tok-number">0xb9</span>, <span class="tok-number">0xd4</span>, <span class="tok-number">0xf7</span>, <span class="tok-number">0xc7</span>, <span class="tok-number">0xa8</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0x15</span>,</span>
<span class="line" id="L980">        <span class="tok-number">0x1b</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x50</span>, <span class="tok-number">0x32</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0x3f</span>, <span class="tok-number">0xc3</span>,</span>
<span class="line" id="L981">        <span class="tok-number">0x85</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0x5f</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0xe3</span>, <span class="tok-number">0xdd</span>, <span class="tok-number">0x5a</span>,</span>
<span class="line" id="L982">        <span class="tok-number">0x97</span>, <span class="tok-number">0xa5</span>, <span class="tok-number">0xf5</span>, <span class="tok-number">0x76</span>, <span class="tok-number">0xfe</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x25</span>,</span>
<span class="line" id="L983">        <span class="tok-number">0xd3</span>, <span class="tok-number">0xce</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x2c</span>, <span class="tok-number">0x56</span>, <span class="tok-number">0x6a</span>, <span class="tok-number">0xb2</span>, <span class="tok-number">0xc5</span>,</span>
<span class="line" id="L984">        <span class="tok-number">0x07</span>, <span class="tok-number">0xb1</span>, <span class="tok-number">0x38</span>, <span class="tok-number">0xdb</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x3e</span>, <span class="tok-number">0x3d</span>, <span class="tok-number">0x69</span>,</span>
<span class="line" id="L985">        <span class="tok-number">0x59</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0xc9</span>, <span class="tok-number">0xc4</span>,</span>
<span class="line" id="L986">        <span class="tok-number">0xa6</span>, <span class="tok-number">0xea</span>, <span class="tok-number">0xfd</span>, <span class="tok-number">0xc7</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0xc0</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0xd7</span>,</span>
<span class="line" id="L987"></span>
<span class="line" id="L988">        <span class="tok-number">0x0e</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0xf7</span>, <span class="tok-number">0x6d</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x79</span>,</span>
<span class="line" id="L989">        <span class="tok-number">0xe5</span>, <span class="tok-number">0xc5</span>, <span class="tok-number">0x36</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x33</span>, <span class="tok-number">0x17</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x6a</span>,</span>
<span class="line" id="L990">        <span class="tok-number">0x1c</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x4c</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0xa3</span>, <span class="tok-number">0x71</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0x6a</span>,</span>
<span class="line" id="L991">        <span class="tok-number">0x94</span>, <span class="tok-number">0xdf</span>, <span class="tok-number">0x76</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0xfe</span>, <span class="tok-number">0x4e</span>, <span class="tok-number">0xaa</span>, <span class="tok-number">0xf2</span>,</span>
<span class="line" id="L992">        <span class="tok-number">0xcc</span>, <span class="tok-number">0xb2</span>, <span class="tok-number">0x7d</span>, <span class="tok-number">0x5a</span>, <span class="tok-number">0xaa</span>, <span class="tok-number">0xe0</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0x7a</span>,</span>
<span class="line" id="L993">        <span class="tok-number">0xd0</span>, <span class="tok-number">0xf9</span>, <span class="tok-number">0xd4</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0x3b</span>, <span class="tok-number">0x54</span>, <span class="tok-number">0x09</span>,</span>
<span class="line" id="L994">        <span class="tok-number">0x87</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0xd4</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0x4d</span>, <span class="tok-number">0x38</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x7a</span>,</span>
<span class="line" id="L995">        <span class="tok-number">0x6d</span>, <span class="tok-number">0xeb</span>, <span class="tok-number">0x3a</span>, <span class="tok-number">0xb7</span>, <span class="tok-number">0x8f</span>, <span class="tok-number">0xab</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0xc9</span>,</span>
<span class="line" id="L996">    };</span>
<span class="line" id="L997">    <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L998">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L999">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1000">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1001">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1002">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1003">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1004">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1005">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1006"></span>
<span class="line" id="L1007">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1008">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1009">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1010">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1011">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1012">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1013">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1014">        <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1015">    };</span>
<span class="line" id="L1016">    <span class="tok-kw">var</span> result: [<span class="tok-number">256</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1017">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1018">        <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span>,</span>
<span class="line" id="L1019">        <span class="tok-number">0x08</span>, <span class="tok-number">0x09</span>, <span class="tok-number">0x0a</span>, <span class="tok-number">0x0b</span>, <span class="tok-number">0x0c</span>, <span class="tok-number">0x0d</span>, <span class="tok-number">0x0e</span>, <span class="tok-number">0x0f</span>,</span>
<span class="line" id="L1020">        <span class="tok-number">0x10</span>, <span class="tok-number">0x11</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x13</span>, <span class="tok-number">0x14</span>, <span class="tok-number">0x15</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x17</span>,</span>
<span class="line" id="L1021">        <span class="tok-number">0x18</span>, <span class="tok-number">0x19</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x1b</span>, <span class="tok-number">0x1c</span>, <span class="tok-number">0x1d</span>, <span class="tok-number">0x1e</span>, <span class="tok-number">0x1f</span>,</span>
<span class="line" id="L1022">    };</span>
<span class="line" id="L1023">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1024">        <span class="tok-number">0x00</span>, <span class="tok-number">0x01</span>, <span class="tok-number">0x02</span>, <span class="tok-number">0x03</span>, <span class="tok-number">0x04</span>, <span class="tok-number">0x05</span>, <span class="tok-number">0x06</span>, <span class="tok-number">0x07</span>,</span>
<span class="line" id="L1025">    };</span>
<span class="line" id="L1026"></span>
<span class="line" id="L1027">    ChaCha20With64BitNonce.xor(result[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L1028">    <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, &amp;expected_result, &amp;result);</span>
<span class="line" id="L1029">}</span>
<span class="line" id="L1030"></span>
<span class="line" id="L1031"><span class="tok-kw">test</span> <span class="tok-str">&quot;seal&quot;</span> {</span>
<span class="line" id="L1032">    {</span>
<span class="line" id="L1033">        <span class="tok-kw">const</span> m = <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L1034">        <span class="tok-kw">const</span> ad = <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L1035">        <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1036">            <span class="tok-number">0x80</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0x84</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x8f</span>,</span>
<span class="line" id="L1037">            <span class="tok-number">0x90</span>, <span class="tok-number">0x91</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x9b</span>, <span class="tok-number">0x9c</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0x9e</span>, <span class="tok-number">0x9f</span>,</span>
<span class="line" id="L1038">        };</span>
<span class="line" id="L1039">        <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x7</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x47</span> };</span>
<span class="line" id="L1040">        <span class="tok-kw">const</span> exp_out = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0xa0</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0x4d</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0xf3</span>, <span class="tok-number">0xfe</span>, <span class="tok-number">0xb4</span>, <span class="tok-number">0xf6</span>, <span class="tok-number">0x4e</span>, <span class="tok-number">0x7f</span>, <span class="tok-number">0x4b</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0xbf</span>, <span class="tok-number">0x4</span> };</span>
<span class="line" id="L1041"></span>
<span class="line" id="L1042">        <span class="tok-kw">var</span> out: [exp_out.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1043">        ChaCha20Poly1305.encrypt(out[<span class="tok-number">0</span>..m.len], out[m.len..], m, ad, nonce, key);</span>
<span class="line" id="L1044">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, exp_out[<span class="tok-number">0</span>..], out[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L1045">    }</span>
<span class="line" id="L1046">    {</span>
<span class="line" id="L1047">        <span class="tok-kw">const</span> m = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1048">            <span class="tok-number">0x4c</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x6c</span>,</span>
<span class="line" id="L1049">            <span class="tok-number">0x65</span>, <span class="tok-number">0x6d</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x73</span>,</span>
<span class="line" id="L1050">            <span class="tok-number">0x73</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x27</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x3a</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x63</span>,</span>
<span class="line" id="L1051">            <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>,</span>
<span class="line" id="L1052">            <span class="tok-number">0x6e</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x70</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x20</span>,</span>
<span class="line" id="L1053">            <span class="tok-number">0x74</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x2c</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x73</span>,</span>
<span class="line" id="L1054">            <span class="tok-number">0x63</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x69</span>,</span>
<span class="line" id="L1055">            <span class="tok-number">0x74</span>, <span class="tok-number">0x2e</span>,</span>
<span class="line" id="L1056">        };</span>
<span class="line" id="L1057">        <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x50</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0xc0</span>, <span class="tok-number">0xc1</span>, <span class="tok-number">0xc2</span>, <span class="tok-number">0xc3</span>, <span class="tok-number">0xc4</span>, <span class="tok-number">0xc5</span>, <span class="tok-number">0xc6</span>, <span class="tok-number">0xc7</span> };</span>
<span class="line" id="L1058">        <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1059">            <span class="tok-number">0x80</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0x84</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x8f</span>,</span>
<span class="line" id="L1060">            <span class="tok-number">0x90</span>, <span class="tok-number">0x91</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x9b</span>, <span class="tok-number">0x9c</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0x9e</span>, <span class="tok-number">0x9f</span>,</span>
<span class="line" id="L1061">        };</span>
<span class="line" id="L1062">        <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x7</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x47</span> };</span>
<span class="line" id="L1063">        <span class="tok-kw">const</span> exp_out = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1064">            <span class="tok-number">0xd3</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x34</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0xdb</span>, <span class="tok-number">0x7b</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0xbc</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0xef</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0xc2</span>,</span>
<span class="line" id="L1065">            <span class="tok-number">0xa4</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0xed</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x29</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x8</span>,  <span class="tok-number">0xfe</span>, <span class="tok-number">0xa9</span>, <span class="tok-number">0xe2</span>, <span class="tok-number">0xb5</span>, <span class="tok-number">0xa7</span>, <span class="tok-number">0x36</span>, <span class="tok-number">0xee</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0xd6</span>,</span>
<span class="line" id="L1066">            <span class="tok-number">0x3d</span>, <span class="tok-number">0xbe</span>, <span class="tok-number">0xa4</span>, <span class="tok-number">0x5e</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0xa9</span>, <span class="tok-number">0x67</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0xfa</span>, <span class="tok-number">0xfb</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0xda</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x8b</span>,</span>
<span class="line" id="L1067">            <span class="tok-number">0x1a</span>, <span class="tok-number">0x71</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0xa</span>,  <span class="tok-number">0x9e</span>, <span class="tok-number">0x6</span>,  <span class="tok-number">0xb</span>,  <span class="tok-number">0x29</span>, <span class="tok-number">0x5</span>,  <span class="tok-number">0xd6</span>, <span class="tok-number">0xa5</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0xcd</span>, <span class="tok-number">0x3b</span>, <span class="tok-number">0x36</span>,</span>
<span class="line" id="L1068">            <span class="tok-number">0x92</span>, <span class="tok-number">0xdd</span>, <span class="tok-number">0xbd</span>, <span class="tok-number">0x7f</span>, <span class="tok-number">0x2d</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x3</span>,  <span class="tok-number">0xae</span>, <span class="tok-number">0xe3</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0x9</span>,  <span class="tok-number">0x1b</span>, <span class="tok-number">0x58</span>,</span>
<span class="line" id="L1069">            <span class="tok-number">0xfa</span>, <span class="tok-number">0xb3</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0xe4</span>, <span class="tok-number">0xfa</span>, <span class="tok-number">0xd6</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x55</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x80</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0xd7</span>, <span class="tok-number">0xbc</span>,</span>
<span class="line" id="L1070">            <span class="tok-number">0x3f</span>, <span class="tok-number">0xf4</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0xf0</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x4b</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0xe5</span>, <span class="tok-number">0x76</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xce</span>, <span class="tok-number">0xc6</span>, <span class="tok-number">0x4b</span>,</span>
<span class="line" id="L1071">            <span class="tok-number">0x61</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0xe1</span>, <span class="tok-number">0xb</span>,  <span class="tok-number">0x59</span>, <span class="tok-number">0x4f</span>, <span class="tok-number">0x9</span>,  <span class="tok-number">0xe2</span>, <span class="tok-number">0x6a</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0x90</span>, <span class="tok-number">0x2e</span>, <span class="tok-number">0xcb</span>, <span class="tok-number">0xd0</span>, <span class="tok-number">0x60</span>,</span>
<span class="line" id="L1072">            <span class="tok-number">0x6</span>,  <span class="tok-number">0x91</span>,</span>
<span class="line" id="L1073">        };</span>
<span class="line" id="L1074"></span>
<span class="line" id="L1075">        <span class="tok-kw">var</span> out: [exp_out.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1076">        ChaCha20Poly1305.encrypt(out[<span class="tok-number">0</span>..m.len], out[m.len..], m[<span class="tok-number">0</span>..], ad[<span class="tok-number">0</span>..], nonce, key);</span>
<span class="line" id="L1077">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, exp_out[<span class="tok-number">0</span>..], out[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L1078">    }</span>
<span class="line" id="L1079">}</span>
<span class="line" id="L1080"></span>
<span class="line" id="L1081"><span class="tok-kw">test</span> <span class="tok-str">&quot;open&quot;</span> {</span>
<span class="line" id="L1082">    {</span>
<span class="line" id="L1083">        <span class="tok-kw">const</span> c = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0xa0</span>, <span class="tok-number">0x78</span>, <span class="tok-number">0x4d</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0xf3</span>, <span class="tok-number">0xfe</span>, <span class="tok-number">0xb4</span>, <span class="tok-number">0xf6</span>, <span class="tok-number">0x4e</span>, <span class="tok-number">0x7f</span>, <span class="tok-number">0x4b</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0xbf</span>, <span class="tok-number">0x4</span> };</span>
<span class="line" id="L1084">        <span class="tok-kw">const</span> ad = <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L1085">        <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1086">            <span class="tok-number">0x80</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0x84</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x8f</span>,</span>
<span class="line" id="L1087">            <span class="tok-number">0x90</span>, <span class="tok-number">0x91</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x9b</span>, <span class="tok-number">0x9c</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0x9e</span>, <span class="tok-number">0x9f</span>,</span>
<span class="line" id="L1088">        };</span>
<span class="line" id="L1089">        <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x7</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x47</span> };</span>
<span class="line" id="L1090">        <span class="tok-kw">const</span> exp_out = <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L1091"></span>
<span class="line" id="L1092">        <span class="tok-kw">var</span> out: [exp_out.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1093">        <span class="tok-kw">try</span> ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..exp_out.len], c[exp_out.len..].*, ad[<span class="tok-number">0</span>..], nonce, key);</span>
<span class="line" id="L1094">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, exp_out[<span class="tok-number">0</span>..], out[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L1095">    }</span>
<span class="line" id="L1096">    {</span>
<span class="line" id="L1097">        <span class="tok-kw">const</span> c = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1098">            <span class="tok-number">0xd3</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x34</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x60</span>, <span class="tok-number">0xdb</span>, <span class="tok-number">0x7b</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xaf</span>, <span class="tok-number">0xbc</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0xef</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0xc2</span>,</span>
<span class="line" id="L1099">            <span class="tok-number">0xa4</span>, <span class="tok-number">0xad</span>, <span class="tok-number">0xed</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x29</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x8</span>,  <span class="tok-number">0xfe</span>, <span class="tok-number">0xa9</span>, <span class="tok-number">0xe2</span>, <span class="tok-number">0xb5</span>, <span class="tok-number">0xa7</span>, <span class="tok-number">0x36</span>, <span class="tok-number">0xee</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0xd6</span>,</span>
<span class="line" id="L1100">            <span class="tok-number">0x3d</span>, <span class="tok-number">0xbe</span>, <span class="tok-number">0xa4</span>, <span class="tok-number">0x5e</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0xa9</span>, <span class="tok-number">0x67</span>, <span class="tok-number">0x12</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0xfa</span>, <span class="tok-number">0xfb</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0xda</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x8b</span>,</span>
<span class="line" id="L1101">            <span class="tok-number">0x1a</span>, <span class="tok-number">0x71</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0xa</span>,  <span class="tok-number">0x9e</span>, <span class="tok-number">0x6</span>,  <span class="tok-number">0xb</span>,  <span class="tok-number">0x29</span>, <span class="tok-number">0x5</span>,  <span class="tok-number">0xd6</span>, <span class="tok-number">0xa5</span>, <span class="tok-number">0xb6</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0xcd</span>, <span class="tok-number">0x3b</span>, <span class="tok-number">0x36</span>,</span>
<span class="line" id="L1102">            <span class="tok-number">0x92</span>, <span class="tok-number">0xdd</span>, <span class="tok-number">0xbd</span>, <span class="tok-number">0x7f</span>, <span class="tok-number">0x2d</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x3</span>,  <span class="tok-number">0xae</span>, <span class="tok-number">0xe3</span>, <span class="tok-number">0x28</span>, <span class="tok-number">0x9</span>,  <span class="tok-number">0x1b</span>, <span class="tok-number">0x58</span>,</span>
<span class="line" id="L1103">            <span class="tok-number">0xfa</span>, <span class="tok-number">0xb3</span>, <span class="tok-number">0x24</span>, <span class="tok-number">0xe4</span>, <span class="tok-number">0xfa</span>, <span class="tok-number">0xd6</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x55</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x80</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x48</span>, <span class="tok-number">0x31</span>, <span class="tok-number">0xd7</span>, <span class="tok-number">0xbc</span>,</span>
<span class="line" id="L1104">            <span class="tok-number">0x3f</span>, <span class="tok-number">0xf4</span>, <span class="tok-number">0xde</span>, <span class="tok-number">0xf0</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x4b</span>, <span class="tok-number">0x7a</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0xe5</span>, <span class="tok-number">0x76</span>, <span class="tok-number">0xd2</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0xce</span>, <span class="tok-number">0xc6</span>, <span class="tok-number">0x4b</span>,</span>
<span class="line" id="L1105">            <span class="tok-number">0x61</span>, <span class="tok-number">0x16</span>, <span class="tok-number">0x1a</span>, <span class="tok-number">0xe1</span>, <span class="tok-number">0xb</span>,  <span class="tok-number">0x59</span>, <span class="tok-number">0x4f</span>, <span class="tok-number">0x9</span>,  <span class="tok-number">0xe2</span>, <span class="tok-number">0x6a</span>, <span class="tok-number">0x7e</span>, <span class="tok-number">0x90</span>, <span class="tok-number">0x2e</span>, <span class="tok-number">0xcb</span>, <span class="tok-number">0xd0</span>, <span class="tok-number">0x60</span>,</span>
<span class="line" id="L1106">            <span class="tok-number">0x6</span>,  <span class="tok-number">0x91</span>,</span>
<span class="line" id="L1107">        };</span>
<span class="line" id="L1108">        <span class="tok-kw">const</span> ad = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x50</span>, <span class="tok-number">0x51</span>, <span class="tok-number">0x52</span>, <span class="tok-number">0x53</span>, <span class="tok-number">0xc0</span>, <span class="tok-number">0xc1</span>, <span class="tok-number">0xc2</span>, <span class="tok-number">0xc3</span>, <span class="tok-number">0xc4</span>, <span class="tok-number">0xc5</span>, <span class="tok-number">0xc6</span>, <span class="tok-number">0xc7</span> };</span>
<span class="line" id="L1109">        <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1110">            <span class="tok-number">0x80</span>, <span class="tok-number">0x81</span>, <span class="tok-number">0x82</span>, <span class="tok-number">0x83</span>, <span class="tok-number">0x84</span>, <span class="tok-number">0x85</span>, <span class="tok-number">0x86</span>, <span class="tok-number">0x87</span>, <span class="tok-number">0x88</span>, <span class="tok-number">0x89</span>, <span class="tok-number">0x8a</span>, <span class="tok-number">0x8b</span>, <span class="tok-number">0x8c</span>, <span class="tok-number">0x8d</span>, <span class="tok-number">0x8e</span>, <span class="tok-number">0x8f</span>,</span>
<span class="line" id="L1111">            <span class="tok-number">0x90</span>, <span class="tok-number">0x91</span>, <span class="tok-number">0x92</span>, <span class="tok-number">0x93</span>, <span class="tok-number">0x94</span>, <span class="tok-number">0x95</span>, <span class="tok-number">0x96</span>, <span class="tok-number">0x97</span>, <span class="tok-number">0x98</span>, <span class="tok-number">0x99</span>, <span class="tok-number">0x9a</span>, <span class="tok-number">0x9b</span>, <span class="tok-number">0x9c</span>, <span class="tok-number">0x9d</span>, <span class="tok-number">0x9e</span>, <span class="tok-number">0x9f</span>,</span>
<span class="line" id="L1112">        };</span>
<span class="line" id="L1113">        <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{ <span class="tok-number">0x7</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x0</span>, <span class="tok-number">0x40</span>, <span class="tok-number">0x41</span>, <span class="tok-number">0x42</span>, <span class="tok-number">0x43</span>, <span class="tok-number">0x44</span>, <span class="tok-number">0x45</span>, <span class="tok-number">0x46</span>, <span class="tok-number">0x47</span> };</span>
<span class="line" id="L1114">        <span class="tok-kw">const</span> exp_out = [_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L1115">            <span class="tok-number">0x4c</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x47</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x6c</span>,</span>
<span class="line" id="L1116">            <span class="tok-number">0x65</span>, <span class="tok-number">0x6d</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x63</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x61</span>, <span class="tok-number">0x73</span>,</span>
<span class="line" id="L1117">            <span class="tok-number">0x73</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x27</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x39</span>, <span class="tok-number">0x3a</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x49</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x63</span>,</span>
<span class="line" id="L1118">            <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>,</span>
<span class="line" id="L1119">            <span class="tok-number">0x6e</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x79</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x69</span>, <span class="tok-number">0x70</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x20</span>,</span>
<span class="line" id="L1120">            <span class="tok-number">0x74</span>, <span class="tok-number">0x68</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x66</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x74</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x2c</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x73</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x73</span>,</span>
<span class="line" id="L1121">            <span class="tok-number">0x63</span>, <span class="tok-number">0x72</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x6e</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x77</span>, <span class="tok-number">0x6f</span>, <span class="tok-number">0x75</span>, <span class="tok-number">0x6c</span>, <span class="tok-number">0x64</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x62</span>, <span class="tok-number">0x65</span>, <span class="tok-number">0x20</span>, <span class="tok-number">0x69</span>,</span>
<span class="line" id="L1122">            <span class="tok-number">0x74</span>, <span class="tok-number">0x2e</span>,</span>
<span class="line" id="L1123">        };</span>
<span class="line" id="L1124"></span>
<span class="line" id="L1125">        <span class="tok-kw">var</span> out: [exp_out.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1126">        <span class="tok-kw">try</span> ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..exp_out.len], c[exp_out.len..].*, ad[<span class="tok-number">0</span>..], nonce, key);</span>
<span class="line" id="L1127">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, exp_out[<span class="tok-number">0</span>..], out[<span class="tok-number">0</span>..]);</span>
<span class="line" id="L1128"></span>
<span class="line" id="L1129">        <span class="tok-comment">// corrupting the ciphertext, data, key, or nonce should cause a failure</span>
</span>
<span class="line" id="L1130">        <span class="tok-kw">var</span> bad_c = c;</span>
<span class="line" id="L1131">        bad_c[<span class="tok-number">0</span>] ^= <span class="tok-number">1</span>;</span>
<span class="line" id="L1132">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], bad_c[<span class="tok-number">0</span>..out.len], bad_c[out.len..].*, ad[<span class="tok-number">0</span>..], nonce, key));</span>
<span class="line" id="L1133">        <span class="tok-kw">var</span> bad_ad = ad;</span>
<span class="line" id="L1134">        bad_ad[<span class="tok-number">0</span>] ^= <span class="tok-number">1</span>;</span>
<span class="line" id="L1135">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..out.len], c[out.len..].*, bad_ad[<span class="tok-number">0</span>..], nonce, key));</span>
<span class="line" id="L1136">        <span class="tok-kw">var</span> bad_key = key;</span>
<span class="line" id="L1137">        bad_key[<span class="tok-number">0</span>] ^= <span class="tok-number">1</span>;</span>
<span class="line" id="L1138">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..out.len], c[out.len..].*, ad[<span class="tok-number">0</span>..], nonce, bad_key));</span>
<span class="line" id="L1139">        <span class="tok-kw">var</span> bad_nonce = nonce;</span>
<span class="line" id="L1140">        bad_nonce[<span class="tok-number">0</span>] ^= <span class="tok-number">1</span>;</span>
<span class="line" id="L1141">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, ChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..out.len], c[out.len..].*, ad[<span class="tok-number">0</span>..], bad_nonce, key));</span>
<span class="line" id="L1142">    }</span>
<span class="line" id="L1143">}</span>
<span class="line" id="L1144"></span>
<span class="line" id="L1145"><span class="tok-kw">test</span> <span class="tok-str">&quot;crypto.xchacha20&quot;</span> {</span>
<span class="line" id="L1146">    <span class="tok-kw">const</span> key = [_]<span class="tok-type">u8</span>{<span class="tok-number">69</span>} ** <span class="tok-number">32</span>;</span>
<span class="line" id="L1147">    <span class="tok-kw">const</span> nonce = [_]<span class="tok-type">u8</span>{<span class="tok-number">42</span>} ** <span class="tok-number">24</span>;</span>
<span class="line" id="L1148">    <span class="tok-kw">const</span> m = <span class="tok-str">&quot;Ladies and Gentlemen of the class of '99: If I could offer you only one tip for the future, sunscreen would be it.&quot;</span>;</span>
<span class="line" id="L1149">    {</span>
<span class="line" id="L1150">        <span class="tok-kw">var</span> c: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1151">        XChaCha20IETF.xor(c[<span class="tok-number">0</span>..], m[<span class="tok-number">0</span>..], <span class="tok-number">0</span>, key, nonce);</span>
<span class="line" id="L1152">        <span class="tok-kw">var</span> buf: [<span class="tok-number">2</span> * c.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1153">        <span class="tok-kw">try</span> testing.expectEqualStrings(<span class="tok-kw">try</span> std.fmt.bufPrint(&amp;buf, <span class="tok-str">&quot;{s}&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;c)}), <span class="tok-str">&quot;E0A1BCF939654AFDBDC1746EC49832647C19D891F0D1A81FC0C1703B4514BDEA584B512F6908C2C5E9DD18D5CBC1805DE5803FE3B9CA5F193FB8359E91FAB0C3BB40309A292EB1CF49685C65C4A3ADF4F11DB0CD2B6B67FBC174BC2E860E8F769FD3565BBFAD1C845E05A0FED9BE167C240D&quot;</span>);</span>
<span class="line" id="L1154">    }</span>
<span class="line" id="L1155">    {</span>
<span class="line" id="L1156">        <span class="tok-kw">const</span> ad = <span class="tok-str">&quot;Additional data&quot;</span>;</span>
<span class="line" id="L1157">        <span class="tok-kw">var</span> c: [m.len + XChaCha20Poly1305.tag_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1158">        XChaCha20Poly1305.encrypt(c[<span class="tok-number">0</span>..m.len], c[m.len..], m, ad, nonce, key);</span>
<span class="line" id="L1159">        <span class="tok-kw">var</span> out: [m.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1160">        <span class="tok-kw">try</span> XChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..m.len], c[m.len..].*, ad, nonce, key);</span>
<span class="line" id="L1161">        <span class="tok-kw">var</span> buf: [<span class="tok-number">2</span> * c.len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1162">        <span class="tok-kw">try</span> testing.expectEqualStrings(<span class="tok-kw">try</span> std.fmt.bufPrint(&amp;buf, <span class="tok-str">&quot;{s}&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;c)}), <span class="tok-str">&quot;994D2DD32333F48E53650C02C7A2ABB8E018B0836D7175AEC779F52E961780768F815C58F1AA52D211498DB89B9216763F569C9433A6BBFCEFB4D4A49387A4C5207FBB3B5A92B5941294DF30588C6740D39DC16FA1F0E634F7246CF7CDCB978E44347D89381B7A74EB7084F754B90BDE9AAF5A94B8F2A85EFD0B50692AE2D425E234&quot;</span>);</span>
<span class="line" id="L1163">        <span class="tok-kw">try</span> testing.expectEqualSlices(<span class="tok-type">u8</span>, out[<span class="tok-number">0</span>..], m);</span>
<span class="line" id="L1164">        c[<span class="tok-number">0</span>] +%= <span class="tok-number">1</span>;</span>
<span class="line" id="L1165">        <span class="tok-kw">try</span> testing.expectError(<span class="tok-kw">error</span>.AuthenticationFailed, XChaCha20Poly1305.decrypt(out[<span class="tok-number">0</span>..], c[<span class="tok-number">0</span>..m.len], c[m.len..].*, ad, nonce, key));</span>
<span class="line" id="L1166">    }</span>
<span class="line" id="L1167">}</span>
<span class="line" id="L1168"></span>
</code></pre></body>
</html>