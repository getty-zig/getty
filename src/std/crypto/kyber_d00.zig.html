<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>crypto/kyber_d00.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! Implementation of the IND-CCA2 post-quantum secure key encapsulation</span></span>
<span class="line" id="L2"><span class="tok-comment">//! mechanism (KEM) CRYSTALS-Kyber, as submitted to the third round of the NIST</span></span>
<span class="line" id="L3"><span class="tok-comment">//! Post-Quantum Cryptography (v3.02/&quot;draft00&quot;), and selected for standardisation.</span></span>
<span class="line" id="L4"><span class="tok-comment">//!</span></span>
<span class="line" id="L5"><span class="tok-comment">//! Kyber will likely change before final standardisation.</span></span>
<span class="line" id="L6"><span class="tok-comment">//!</span></span>
<span class="line" id="L7"><span class="tok-comment">//! The namespace suffix (currently `_d00`) refers to the version currently</span></span>
<span class="line" id="L8"><span class="tok-comment">//! implemented, in accordance with the draft. It may not be updated if new</span></span>
<span class="line" id="L9"><span class="tok-comment">//! versions of the draft only include editorial changes.</span></span>
<span class="line" id="L10"><span class="tok-comment">//!</span></span>
<span class="line" id="L11"><span class="tok-comment">//! The suffix will eventually be removed once Kyber is finalized.</span></span>
<span class="line" id="L12"><span class="tok-comment">//!</span></span>
<span class="line" id="L13"><span class="tok-comment">//! Quoting from the CFRG I-D:</span></span>
<span class="line" id="L14"><span class="tok-comment">//!</span></span>
<span class="line" id="L15"><span class="tok-comment">//! Kyber is not a Diffie-Hellman (DH) style non-interactive key</span></span>
<span class="line" id="L16"><span class="tok-comment">//! agreement, but instead, Kyber is a Key Encapsulation Method (KEM).</span></span>
<span class="line" id="L17"><span class="tok-comment">//! In essence, a KEM is a Public-Key Encryption (PKE) scheme where the</span></span>
<span class="line" id="L18"><span class="tok-comment">//! plaintext cannot be specified, but is generated as a random key as</span></span>
<span class="line" id="L19"><span class="tok-comment">//! part of the encryption. A KEM can be transformed into an unrestricted</span></span>
<span class="line" id="L20"><span class="tok-comment">//! PKE using HPKE (RFC9180). On its own, a KEM can be used as a key</span></span>
<span class="line" id="L21"><span class="tok-comment">//! agreement method in TLS.</span></span>
<span class="line" id="L22"><span class="tok-comment">//!</span></span>
<span class="line" id="L23"><span class="tok-comment">//! Kyber is an IND-CCA2 secure KEM. It is constructed by applying a</span></span>
<span class="line" id="L24"><span class="tok-comment">//! Fujisaki--Okamato style transformation on InnerPKE, which is the</span></span>
<span class="line" id="L25"><span class="tok-comment">//! underlying IND-CPA secure Public Key Encryption scheme. We cannot</span></span>
<span class="line" id="L26"><span class="tok-comment">//! use InnerPKE directly, as its ciphertexts are malleable.</span></span>
<span class="line" id="L27"><span class="tok-comment">//!</span></span>
<span class="line" id="L28"><span class="tok-comment">//! ```</span></span>
<span class="line" id="L29"><span class="tok-comment">//!                     F.O. transform</span></span>
<span class="line" id="L30"><span class="tok-comment">//!     InnerPKE   ----------------------&gt;   Kyber</span></span>
<span class="line" id="L31"><span class="tok-comment">//!     IND-CPA                              IND-CCA2</span></span>
<span class="line" id="L32"><span class="tok-comment">//! ```</span></span>
<span class="line" id="L33"><span class="tok-comment">//!</span></span>
<span class="line" id="L34"><span class="tok-comment">//! Kyber is a lattice-based scheme.  More precisely, its security is</span></span>
<span class="line" id="L35"><span class="tok-comment">//! based on the learning-with-errors-and-rounding problem in module</span></span>
<span class="line" id="L36"><span class="tok-comment">//! lattices (MLWER).  The underlying polynomial ring R (defined in</span></span>
<span class="line" id="L37"><span class="tok-comment">//! Section 5) is chosen such that multiplication is very fast using the</span></span>
<span class="line" id="L38"><span class="tok-comment">//! number theoretic transform (NTT, see Section 5.1.3).</span></span>
<span class="line" id="L39"><span class="tok-comment">//!</span></span>
<span class="line" id="L40"><span class="tok-comment">//! An InnerPKE private key is a vector _s_ over R of length k which is</span></span>
<span class="line" id="L41"><span class="tok-comment">//! _small_ in a particular way.  Here k is a security parameter akin to</span></span>
<span class="line" id="L42"><span class="tok-comment">//! the size of a prime modulus.  For Kyber512, which targets AES-128's</span></span>
<span class="line" id="L43"><span class="tok-comment">//! security level, the value of k is 2.</span></span>
<span class="line" id="L44"><span class="tok-comment">//!</span></span>
<span class="line" id="L45"><span class="tok-comment">//! The public key consists of two values:</span></span>
<span class="line" id="L46"><span class="tok-comment">//!</span></span>
<span class="line" id="L47"><span class="tok-comment">//! * _A_ a uniformly sampled k by k matrix over R _and_</span></span>
<span class="line" id="L48"><span class="tok-comment">//!</span></span>
<span class="line" id="L49"><span class="tok-comment">//! * _t = A s + e_, where e is a suitably small masking vector.</span></span>
<span class="line" id="L50"><span class="tok-comment">//!</span></span>
<span class="line" id="L51"><span class="tok-comment">//! Distinguishing between such A s + e and a uniformly sampled t is the</span></span>
<span class="line" id="L52"><span class="tok-comment">//! module learning-with-errors (MLWE) problem.  If that is hard, then it</span></span>
<span class="line" id="L53"><span class="tok-comment">//! is also hard to recover the private key from the public key as that</span></span>
<span class="line" id="L54"><span class="tok-comment">//! would allow you to distinguish between those two.</span></span>
<span class="line" id="L55"><span class="tok-comment">//!</span></span>
<span class="line" id="L56"><span class="tok-comment">//! To save space in the public key, A is recomputed deterministically</span></span>
<span class="line" id="L57"><span class="tok-comment">//! from a seed _rho_.</span></span>
<span class="line" id="L58"><span class="tok-comment">//!</span></span>
<span class="line" id="L59"><span class="tok-comment">//! A ciphertext for a message m under this public key is a pair (c_1,</span></span>
<span class="line" id="L60"><span class="tok-comment">//! c_2) computed roughly as follows:</span></span>
<span class="line" id="L61"><span class="tok-comment">//!</span></span>
<span class="line" id="L62"><span class="tok-comment">//! c_1 = Compress(A^T r + e_1, d_u)</span></span>
<span class="line" id="L63"><span class="tok-comment">//! c_2 = Compress(t^T r + e_2 + Decompress(m, 1), d_v)</span></span>
<span class="line" id="L64"><span class="tok-comment">//!</span></span>
<span class="line" id="L65"><span class="tok-comment">//! where</span></span>
<span class="line" id="L66"><span class="tok-comment">//!</span></span>
<span class="line" id="L67"><span class="tok-comment">//! * e_1, e_2 and r are small blinds;</span></span>
<span class="line" id="L68"><span class="tok-comment">//!</span></span>
<span class="line" id="L69"><span class="tok-comment">//! * Compress(-, d) removes some information, leaving d bits per</span></span>
<span class="line" id="L70"><span class="tok-comment">//!   coefficient and Decompress is such that Compress after Decompress</span></span>
<span class="line" id="L71"><span class="tok-comment">//!   does nothing and</span></span>
<span class="line" id="L72"><span class="tok-comment">//!</span></span>
<span class="line" id="L73"><span class="tok-comment">//! * d_u, d_v are scheme parameters.</span></span>
<span class="line" id="L74"><span class="tok-comment">//!</span></span>
<span class="line" id="L75"><span class="tok-comment">//! Distinguishing such a ciphertext and uniformly sampled (c_1, c_2) is</span></span>
<span class="line" id="L76"><span class="tok-comment">//! an example of the full MLWER problem, see section 4.4 of [KyberV302].</span></span>
<span class="line" id="L77"><span class="tok-comment">//!</span></span>
<span class="line" id="L78"><span class="tok-comment">//! To decrypt the ciphertext, one computes</span></span>
<span class="line" id="L79"><span class="tok-comment">//!</span></span>
<span class="line" id="L80"><span class="tok-comment">//! m = Compress(Decompress(c_2, d_v) - s^T Decompress(c_1, d_u), 1).</span></span>
<span class="line" id="L81"><span class="tok-comment">//!</span></span>
<span class="line" id="L82"><span class="tok-comment">//! It it not straight-forward to see that this formula is correct.  In</span></span>
<span class="line" id="L83"><span class="tok-comment">//! fact, there is negligible but non-zero probability that a ciphertext</span></span>
<span class="line" id="L84"><span class="tok-comment">//! does not decrypt correctly given by the DFP column in Table 4.  This</span></span>
<span class="line" id="L85"><span class="tok-comment">//! failure probability can be computed by a careful automated analysis</span></span>
<span class="line" id="L86"><span class="tok-comment">//! of the probabilities involved, see kyber_failure.py of [SecEst].</span></span>
<span class="line" id="L87"><span class="tok-comment">//!</span></span>
<span class="line" id="L88"><span class="tok-comment">//! [KyberV302](https://pq-crystals.org/kyber/data/kyber-specification-round3-20210804.pdf)</span></span>
<span class="line" id="L89"><span class="tok-comment">//! [I-D](https://github.com/bwesterb/draft-schwabe-cfrg-kyber)</span></span>
<span class="line" id="L90"><span class="tok-comment">//! [SecEst](https://github.com/pq-crystals/security-estimates)</span></span>
<span class="line" id="L91"></span>
<span class="line" id="L92"><span class="tok-comment">// TODO</span>
</span>
<span class="line" id="L93"><span class="tok-comment">//</span>
</span>
<span class="line" id="L94"><span class="tok-comment">// - The bottleneck in Kyber are the various hash/xof calls:</span>
</span>
<span class="line" id="L95"><span class="tok-comment">//    - Optimize Zig's keccak implementation.</span>
</span>
<span class="line" id="L96"><span class="tok-comment">//    - Use SIMD to compute keccak in parallel.</span>
</span>
<span class="line" id="L97"><span class="tok-comment">// - Can we track bounds of coefficients using comptime types without</span>
</span>
<span class="line" id="L98"><span class="tok-comment">//   duplicating code?</span>
</span>
<span class="line" id="L99"><span class="tok-comment">// - Would be neater to have tests closer to the thing under test.</span>
</span>
<span class="line" id="L100"><span class="tok-comment">// - When generating a keypair, we have a copy of the inner public key with</span>
</span>
<span class="line" id="L101"><span class="tok-comment">//   its large matrix A in both the public key and the private key. In Go we</span>
</span>
<span class="line" id="L102"><span class="tok-comment">//   can just have a pointer in the private key to the public key, but</span>
</span>
<span class="line" id="L103"><span class="tok-comment">//   how do we do this elegantly in Zig?</span>
</span>
<span class="line" id="L104"></span>
<span class="line" id="L105"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L106"><span class="tok-kw">const</span> builtin = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;builtin&quot;</span>);</span>
<span class="line" id="L107"></span>
<span class="line" id="L108"><span class="tok-kw">const</span> testing = std.testing;</span>
<span class="line" id="L109"><span class="tok-kw">const</span> assert = std.debug.assert;</span>
<span class="line" id="L110"><span class="tok-kw">const</span> crypto = std.crypto;</span>
<span class="line" id="L111"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L112"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L113"><span class="tok-kw">const</span> RndGen = std.rand.DefaultPrng;</span>
<span class="line" id="L114"><span class="tok-kw">const</span> sha3 = crypto.hash.sha3;</span>
<span class="line" id="L115"></span>
<span class="line" id="L116"><span class="tok-comment">// Q is the parameter q ≡ 3329 = 2¹¹ + 2¹⁰ + 2⁸ + 1.</span>
</span>
<span class="line" id="L117"><span class="tok-kw">const</span> Q: <span class="tok-type">i16</span> = <span class="tok-number">3329</span>;</span>
<span class="line" id="L118"></span>
<span class="line" id="L119"><span class="tok-comment">// Montgomery R</span>
</span>
<span class="line" id="L120"><span class="tok-kw">const</span> R: <span class="tok-type">i32</span> = <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">16</span>;</span>
<span class="line" id="L121"></span>
<span class="line" id="L122"><span class="tok-comment">// Parameter n, degree of polynomials.</span>
</span>
<span class="line" id="L123"><span class="tok-kw">const</span> N: <span class="tok-type">usize</span> = <span class="tok-number">256</span>;</span>
<span class="line" id="L124"></span>
<span class="line" id="L125"><span class="tok-comment">// Size of &quot;small&quot; vectors used in encryption blinds.</span>
</span>
<span class="line" id="L126"><span class="tok-kw">const</span> eta2: <span class="tok-type">u8</span> = <span class="tok-number">2</span>;</span>
<span class="line" id="L127"></span>
<span class="line" id="L128"><span class="tok-kw">const</span> Params = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L129">    name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L130"></span>
<span class="line" id="L131">    <span class="tok-comment">// Width and height of the matrix A.</span>
</span>
<span class="line" id="L132">    k: <span class="tok-type">u8</span>,</span>
<span class="line" id="L133"></span>
<span class="line" id="L134">    <span class="tok-comment">// Size of &quot;small&quot; vectors used in private key and encryption blinds.</span>
</span>
<span class="line" id="L135">    eta1: <span class="tok-type">u8</span>,</span>
<span class="line" id="L136"></span>
<span class="line" id="L137">    <span class="tok-comment">// How many bits to retain of u, the private-key independent part</span>
</span>
<span class="line" id="L138">    <span class="tok-comment">// of the ciphertext.</span>
</span>
<span class="line" id="L139">    du: <span class="tok-type">u8</span>,</span>
<span class="line" id="L140"></span>
<span class="line" id="L141">    <span class="tok-comment">// How many bits to retain of v, the private-key dependent part</span>
</span>
<span class="line" id="L142">    <span class="tok-comment">// of the ciphertext.</span>
</span>
<span class="line" id="L143">    dv: <span class="tok-type">u8</span>,</span>
<span class="line" id="L144">};</span>
<span class="line" id="L145"></span>
<span class="line" id="L146"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kyber512 = Kyber(.{</span>
<span class="line" id="L147">    .name = <span class="tok-str">&quot;Kyber512&quot;</span>,</span>
<span class="line" id="L148">    .k = <span class="tok-number">2</span>,</span>
<span class="line" id="L149">    .eta1 = <span class="tok-number">3</span>,</span>
<span class="line" id="L150">    .du = <span class="tok-number">10</span>,</span>
<span class="line" id="L151">    .dv = <span class="tok-number">4</span>,</span>
<span class="line" id="L152">});</span>
<span class="line" id="L153"></span>
<span class="line" id="L154"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kyber768 = Kyber(.{</span>
<span class="line" id="L155">    .name = <span class="tok-str">&quot;Kyber768&quot;</span>,</span>
<span class="line" id="L156">    .k = <span class="tok-number">3</span>,</span>
<span class="line" id="L157">    .eta1 = <span class="tok-number">2</span>,</span>
<span class="line" id="L158">    .du = <span class="tok-number">10</span>,</span>
<span class="line" id="L159">    .dv = <span class="tok-number">4</span>,</span>
<span class="line" id="L160">});</span>
<span class="line" id="L161"></span>
<span class="line" id="L162"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Kyber1024 = Kyber(.{</span>
<span class="line" id="L163">    .name = <span class="tok-str">&quot;Kyber1024&quot;</span>,</span>
<span class="line" id="L164">    .k = <span class="tok-number">4</span>,</span>
<span class="line" id="L165">    .eta1 = <span class="tok-number">2</span>,</span>
<span class="line" id="L166">    .du = <span class="tok-number">11</span>,</span>
<span class="line" id="L167">    .dv = <span class="tok-number">5</span>,</span>
<span class="line" id="L168">});</span>
<span class="line" id="L169"></span>
<span class="line" id="L170"><span class="tok-kw">const</span> modes = [_]<span class="tok-type">type</span>{ Kyber512, Kyber768, Kyber1024 };</span>
<span class="line" id="L171"><span class="tok-kw">const</span> h_length: <span class="tok-type">usize</span> = <span class="tok-number">32</span>;</span>
<span class="line" id="L172"><span class="tok-kw">const</span> inner_seed_length: <span class="tok-type">usize</span> = <span class="tok-number">32</span>;</span>
<span class="line" id="L173"><span class="tok-kw">const</span> common_encaps_seed_length: <span class="tok-type">usize</span> = <span class="tok-number">32</span>;</span>
<span class="line" id="L174"><span class="tok-kw">const</span> common_shared_key_size: <span class="tok-type">usize</span> = <span class="tok-number">32</span>;</span>
<span class="line" id="L175"></span>
<span class="line" id="L176"><span class="tok-kw">fn</span> <span class="tok-fn">Kyber</span>(<span class="tok-kw">comptime</span> p: Params) <span class="tok-type">type</span> {</span>
<span class="line" id="L177">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L178">        <span class="tok-comment">// Size of a ciphertext, in bytes.</span>
</span>
<span class="line" id="L179">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ciphertext_length = Poly.compressedSize(p.du) * p.k + Poly.compressedSize(p.dv);</span>
<span class="line" id="L180"></span>
<span class="line" id="L181">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L182">        <span class="tok-kw">const</span> V = Vec(p.k);</span>
<span class="line" id="L183">        <span class="tok-kw">const</span> M = Mat(p.k);</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">        <span class="tok-comment">/// Length (in bytes) of a shared secret.</span></span>
<span class="line" id="L186">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> shared_length = common_shared_key_size;</span>
<span class="line" id="L187">        <span class="tok-comment">/// Length (in bytes) of a seed for deterministic encapsulation.</span></span>
<span class="line" id="L188">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> encaps_seed_length = common_encaps_seed_length;</span>
<span class="line" id="L189">        <span class="tok-comment">/// Length (in bytes) of a seed for key generation.</span></span>
<span class="line" id="L190">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> seed_length: <span class="tok-type">usize</span> = inner_seed_length + shared_length;</span>
<span class="line" id="L191">        <span class="tok-comment">/// Algorithm name.</span></span>
<span class="line" id="L192">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> name = p.name;</span>
<span class="line" id="L193"></span>
<span class="line" id="L194">        <span class="tok-comment">/// A shared secret, and an encapsulated (encrypted) representation of it.</span></span>
<span class="line" id="L195">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> EncapsulatedSecret = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L196">            shared_secret: [shared_length]<span class="tok-type">u8</span>,</span>
<span class="line" id="L197">            ciphertext: [ciphertext_length]<span class="tok-type">u8</span>,</span>
<span class="line" id="L198">        };</span>
<span class="line" id="L199"></span>
<span class="line" id="L200">        <span class="tok-comment">/// A Kyber public key.</span></span>
<span class="line" id="L201">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> PublicKey = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L202">            pk: InnerPk,</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">            <span class="tok-comment">// Cached</span>
</span>
<span class="line" id="L205">            hpk: [h_length]<span class="tok-type">u8</span>, <span class="tok-comment">// H(pk)</span>
</span>
<span class="line" id="L206"></span>
<span class="line" id="L207">            <span class="tok-comment">/// Size of a serialized representation of the key, in bytes.</span></span>
<span class="line" id="L208">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bytes_length = InnerPk.bytes_length;</span>
<span class="line" id="L209"></span>
<span class="line" id="L210">            <span class="tok-comment">/// Generates a shared secret, and encapsulates it for the public key.</span></span>
<span class="line" id="L211">            <span class="tok-comment">/// If `seed` is `null`, a random seed is used. This is recommended.</span></span>
<span class="line" id="L212">            <span class="tok-comment">/// If `seed` is set, encapsulation is deterministic.</span></span>
<span class="line" id="L213">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">encaps</span>(pk: PublicKey, seed_: ?[encaps_seed_length]<span class="tok-type">u8</span>) EncapsulatedSecret {</span>
<span class="line" id="L214">                <span class="tok-kw">const</span> seed = seed_ <span class="tok-kw">orelse</span> seed: {</span>
<span class="line" id="L215">                    <span class="tok-kw">var</span> random_seed: [encaps_seed_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L216">                    crypto.random.bytes(&amp;random_seed);</span>
<span class="line" id="L217">                    <span class="tok-kw">break</span> :seed random_seed;</span>
<span class="line" id="L218">                };</span>
<span class="line" id="L219"></span>
<span class="line" id="L220">                <span class="tok-kw">var</span> m: [inner_plaintext_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L221"></span>
<span class="line" id="L222">                <span class="tok-comment">// m = H(seed)</span>
</span>
<span class="line" id="L223">                <span class="tok-kw">var</span> h = sha3.Sha3_256.init(.{});</span>
<span class="line" id="L224">                h.update(&amp;seed);</span>
<span class="line" id="L225">                h.final(&amp;m);</span>
<span class="line" id="L226"></span>
<span class="line" id="L227">                <span class="tok-comment">// (K', r) = G(m ‖ H(pk))</span>
</span>
<span class="line" id="L228">                <span class="tok-kw">var</span> kr: [inner_plaintext_length + h_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L229">                <span class="tok-kw">var</span> g = sha3.Sha3_512.init(.{});</span>
<span class="line" id="L230">                g.update(&amp;m);</span>
<span class="line" id="L231">                g.update(&amp;pk.hpk);</span>
<span class="line" id="L232">                g.final(&amp;kr);</span>
<span class="line" id="L233"></span>
<span class="line" id="L234">                <span class="tok-comment">// c = innerEncrypy(pk, m, r)</span>
</span>
<span class="line" id="L235">                <span class="tok-kw">const</span> ct = pk.pk.encrypt(&amp;m, kr[<span class="tok-number">32</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L236"></span>
<span class="line" id="L237">                <span class="tok-comment">// Compute H(c) and put in second slot of kr, which will be (K', H(c)).</span>
</span>
<span class="line" id="L238">                h = sha3.Sha3_256.init(.{});</span>
<span class="line" id="L239">                h.update(&amp;ct);</span>
<span class="line" id="L240">                h.final(kr[<span class="tok-number">32</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L241"></span>
<span class="line" id="L242">                <span class="tok-comment">// K = KDF(K' ‖ H(c))</span>
</span>
<span class="line" id="L243">                <span class="tok-kw">var</span> kdf = sha3.Shake256.init(.{});</span>
<span class="line" id="L244">                kdf.update(&amp;kr);</span>
<span class="line" id="L245">                <span class="tok-kw">var</span> ss: [shared_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L246">                kdf.squeeze(&amp;ss);</span>
<span class="line" id="L247"></span>
<span class="line" id="L248">                <span class="tok-kw">return</span> EncapsulatedSecret{</span>
<span class="line" id="L249">                    .shared_secret = ss,</span>
<span class="line" id="L250">                    .ciphertext = ct,</span>
<span class="line" id="L251">                };</span>
<span class="line" id="L252">            }</span>
<span class="line" id="L253"></span>
<span class="line" id="L254">            <span class="tok-comment">/// Serializes the key into a byte array.</span></span>
<span class="line" id="L255">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(pk: PublicKey) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L256">                <span class="tok-kw">return</span> pk.pk.toBytes();</span>
<span class="line" id="L257">            }</span>
<span class="line" id="L258"></span>
<span class="line" id="L259">            <span class="tok-comment">/// Deserializes the key from a byte array.</span></span>
<span class="line" id="L260">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) !PublicKey {</span>
<span class="line" id="L261">                <span class="tok-kw">var</span> ret: PublicKey = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L262">                ret.pk = InnerPk.fromBytes(buf[<span class="tok-number">0</span>..InnerPk.bytes_length]);</span>
<span class="line" id="L263"></span>
<span class="line" id="L264">                <span class="tok-kw">var</span> h = sha3.Sha3_256.init(.{});</span>
<span class="line" id="L265">                h.update(buf);</span>
<span class="line" id="L266">                h.final(&amp;ret.hpk);</span>
<span class="line" id="L267">                <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L268">            }</span>
<span class="line" id="L269">        };</span>
<span class="line" id="L270"></span>
<span class="line" id="L271">        <span class="tok-comment">/// A Kyber secret key.</span></span>
<span class="line" id="L272">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> SecretKey = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L273">            sk: InnerSk,</span>
<span class="line" id="L274">            pk: InnerPk,</span>
<span class="line" id="L275">            hpk: [h_length]<span class="tok-type">u8</span>, <span class="tok-comment">// H(pk)</span>
</span>
<span class="line" id="L276">            z: [shared_length]<span class="tok-type">u8</span>,</span>
<span class="line" id="L277"></span>
<span class="line" id="L278">            <span class="tok-comment">/// Size of a serialized representation of the key, in bytes.</span></span>
<span class="line" id="L279">            <span class="tok-kw">pub</span> <span class="tok-kw">const</span> bytes_length: <span class="tok-type">usize</span> =</span>
<span class="line" id="L280">                InnerSk.bytes_length + InnerPk.bytes_length + h_length + shared_length;</span>
<span class="line" id="L281"></span>
<span class="line" id="L282">            <span class="tok-comment">/// Decapsulates the shared secret within ct using the private key.</span></span>
<span class="line" id="L283">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">decaps</span>(sk: SecretKey, ct: *<span class="tok-kw">const</span> [ciphertext_length]<span class="tok-type">u8</span>) ![shared_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L284">                <span class="tok-comment">// m' = innerDec(ct)</span>
</span>
<span class="line" id="L285">                <span class="tok-kw">const</span> m2 = sk.sk.decrypt(ct);</span>
<span class="line" id="L286"></span>
<span class="line" id="L287">                <span class="tok-comment">// (K'', r') = G(m' ‖ H(pk))</span>
</span>
<span class="line" id="L288">                <span class="tok-kw">var</span> kr2: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L289">                <span class="tok-kw">var</span> g = sha3.Sha3_512.init(.{});</span>
<span class="line" id="L290">                g.update(&amp;m2);</span>
<span class="line" id="L291">                g.update(&amp;sk.hpk);</span>
<span class="line" id="L292">                g.final(&amp;kr2);</span>
<span class="line" id="L293"></span>
<span class="line" id="L294">                <span class="tok-comment">// ct' = innerEnc(pk, m', r')</span>
</span>
<span class="line" id="L295">                <span class="tok-kw">const</span> ct2 = sk.pk.encrypt(&amp;m2, kr2[<span class="tok-number">32</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L296"></span>
<span class="line" id="L297">                <span class="tok-comment">// Compute H(ct) and put in the second slot of kr2 which will be (K'', H(ct)).</span>
</span>
<span class="line" id="L298">                <span class="tok-kw">var</span> h = sha3.Sha3_256.init(.{});</span>
<span class="line" id="L299">                h.update(ct);</span>
<span class="line" id="L300">                h.final(kr2[<span class="tok-number">32</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L301"></span>
<span class="line" id="L302">                <span class="tok-comment">// Replace K'' by z in the first slot of kr2 if ct ≠ ct'.</span>
</span>
<span class="line" id="L303">                cmov(<span class="tok-number">32</span>, kr2[<span class="tok-number">0</span>..<span class="tok-number">32</span>], sk.z, ctneq(ciphertext_length, ct.*, ct2));</span>
<span class="line" id="L304"></span>
<span class="line" id="L305">                <span class="tok-comment">// K = KDF(K''/z, H(c))</span>
</span>
<span class="line" id="L306">                <span class="tok-kw">var</span> kdf = sha3.Shake256.init(.{});</span>
<span class="line" id="L307">                <span class="tok-kw">var</span> ss: [shared_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L308">                kdf.update(&amp;kr2);</span>
<span class="line" id="L309">                kdf.squeeze(&amp;ss);</span>
<span class="line" id="L310">                <span class="tok-kw">return</span> ss;</span>
<span class="line" id="L311">            }</span>
<span class="line" id="L312"></span>
<span class="line" id="L313">            <span class="tok-comment">/// Serializes the key into a byte array.</span></span>
<span class="line" id="L314">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(sk: SecretKey) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L315">                <span class="tok-kw">return</span> sk.sk.toBytes() ++ sk.pk.toBytes() ++ sk.hpk ++ sk.z;</span>
<span class="line" id="L316">            }</span>
<span class="line" id="L317"></span>
<span class="line" id="L318">            <span class="tok-comment">/// Deserializes the key from a byte array.</span></span>
<span class="line" id="L319">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) !SecretKey {</span>
<span class="line" id="L320">                <span class="tok-kw">var</span> ret: SecretKey = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L321">                <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> s: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L322">                ret.sk = InnerSk.fromBytes(buf[s .. s + InnerSk.bytes_length]);</span>
<span class="line" id="L323">                s += InnerSk.bytes_length;</span>
<span class="line" id="L324">                ret.pk = InnerPk.fromBytes(buf[s .. s + InnerPk.bytes_length]);</span>
<span class="line" id="L325">                s += InnerPk.bytes_length;</span>
<span class="line" id="L326">                ret.hpk = buf[s..][<span class="tok-number">0</span>..h_length].*;</span>
<span class="line" id="L327">                s += h_length;</span>
<span class="line" id="L328">                ret.z = buf[s..][<span class="tok-number">0</span>..shared_length].*;</span>
<span class="line" id="L329">                <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L330">            }</span>
<span class="line" id="L331">        };</span>
<span class="line" id="L332"></span>
<span class="line" id="L333">        <span class="tok-comment">/// A Kyber key pair.</span></span>
<span class="line" id="L334">        <span class="tok-kw">pub</span> <span class="tok-kw">const</span> KeyPair = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L335">            secret_key: SecretKey,</span>
<span class="line" id="L336">            public_key: PublicKey,</span>
<span class="line" id="L337"></span>
<span class="line" id="L338">            <span class="tok-comment">/// Create a new key pair.</span></span>
<span class="line" id="L339">            <span class="tok-comment">/// If seed is null, a random seed will be generated.</span></span>
<span class="line" id="L340">            <span class="tok-comment">/// If a seed is provided, the key pair will be determinsitic.</span></span>
<span class="line" id="L341">            <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">create</span>(seed_: ?[seed_length]<span class="tok-type">u8</span>) !KeyPair {</span>
<span class="line" id="L342">                <span class="tok-kw">const</span> seed = seed_ <span class="tok-kw">orelse</span> sk: {</span>
<span class="line" id="L343">                    <span class="tok-kw">var</span> random_seed: [seed_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L344">                    crypto.random.bytes(&amp;random_seed);</span>
<span class="line" id="L345">                    <span class="tok-kw">break</span> :sk random_seed;</span>
<span class="line" id="L346">                };</span>
<span class="line" id="L347">                <span class="tok-kw">var</span> ret: KeyPair = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L348">                ret.secret_key.z = seed[inner_seed_length..seed_length].*;</span>
<span class="line" id="L349"></span>
<span class="line" id="L350">                <span class="tok-comment">// Generate inner key</span>
</span>
<span class="line" id="L351">                innerKeyFromSeed(</span>
<span class="line" id="L352">                    seed[<span class="tok-number">0</span>..inner_seed_length].*,</span>
<span class="line" id="L353">                    &amp;ret.public_key.pk,</span>
<span class="line" id="L354">                    &amp;ret.secret_key.sk,</span>
<span class="line" id="L355">                );</span>
<span class="line" id="L356">                ret.secret_key.pk = ret.public_key.pk;</span>
<span class="line" id="L357"></span>
<span class="line" id="L358">                <span class="tok-comment">// Copy over z from seed.</span>
</span>
<span class="line" id="L359">                ret.secret_key.z = seed[inner_seed_length..seed_length].*;</span>
<span class="line" id="L360"></span>
<span class="line" id="L361">                <span class="tok-comment">// Compute H(pk)</span>
</span>
<span class="line" id="L362">                <span class="tok-kw">var</span> h = sha3.Sha3_256.init(.{});</span>
<span class="line" id="L363">                h.update(&amp;ret.public_key.pk.toBytes());</span>
<span class="line" id="L364">                h.final(&amp;ret.secret_key.hpk);</span>
<span class="line" id="L365">                ret.public_key.hpk = ret.secret_key.hpk;</span>
<span class="line" id="L366"></span>
<span class="line" id="L367">                <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L368">            }</span>
<span class="line" id="L369">        };</span>
<span class="line" id="L370"></span>
<span class="line" id="L371">        <span class="tok-comment">// Size of plaintexts of the in</span>
</span>
<span class="line" id="L372">        <span class="tok-kw">const</span> inner_plaintext_length: <span class="tok-type">usize</span> = Poly.compressedSize(<span class="tok-number">1</span>);</span>
<span class="line" id="L373"></span>
<span class="line" id="L374">        <span class="tok-kw">const</span> InnerPk = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L375">            rho: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, <span class="tok-comment">// ρ, the seed for the matrix A</span>
</span>
<span class="line" id="L376">            th: V, <span class="tok-comment">// NTT(t), normalized</span>
</span>
<span class="line" id="L377"></span>
<span class="line" id="L378">            <span class="tok-comment">// Cached values</span>
</span>
<span class="line" id="L379">            aT: M,</span>
<span class="line" id="L380"></span>
<span class="line" id="L381">            <span class="tok-kw">const</span> bytes_length = V.bytes_length + <span class="tok-number">32</span>;</span>
<span class="line" id="L382"></span>
<span class="line" id="L383">            <span class="tok-kw">fn</span> <span class="tok-fn">encrypt</span>(</span>
<span class="line" id="L384">                pk: InnerPk,</span>
<span class="line" id="L385">                pt: *<span class="tok-kw">const</span> [inner_plaintext_length]<span class="tok-type">u8</span>,</span>
<span class="line" id="L386">                seed: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L387">            ) [ciphertext_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L388">                <span class="tok-comment">// Sample r, e₁ and e₂ appropriately</span>
</span>
<span class="line" id="L389">                <span class="tok-kw">const</span> rh = V.noise(p.eta1, <span class="tok-number">0</span>, seed).ntt().barrettReduce();</span>
<span class="line" id="L390">                <span class="tok-kw">const</span> e1 = V.noise(eta2, p.k, seed);</span>
<span class="line" id="L391">                <span class="tok-kw">const</span> e2 = Poly.noise(eta2, <span class="tok-number">2</span> * p.k, seed);</span>
<span class="line" id="L392"></span>
<span class="line" id="L393">                <span class="tok-comment">// Next we compute u = Aᵀ r + e₁.  First Aᵀ.</span>
</span>
<span class="line" id="L394">                <span class="tok-kw">var</span> u: V = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L395">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..p.k) |i| {</span>
<span class="line" id="L396">                    <span class="tok-comment">// Note that coefficients of r are bounded by q and those of Aᵀ</span>
</span>
<span class="line" id="L397">                    <span class="tok-comment">// are bounded by 4.5q and so their product is bounded by 2¹⁵q</span>
</span>
<span class="line" id="L398">                    <span class="tok-comment">// as required for multiplication.</span>
</span>
<span class="line" id="L399">                    u.ps[i] = pk.aT.vs[i].dotHat(rh);</span>
<span class="line" id="L400">                }</span>
<span class="line" id="L401"></span>
<span class="line" id="L402">                <span class="tok-comment">// Aᵀ and r were not in Montgomery form, so the Montgomery</span>
</span>
<span class="line" id="L403">                <span class="tok-comment">// multiplications in the inner product added a factor R⁻¹ which</span>
</span>
<span class="line" id="L404">                <span class="tok-comment">// the InvNTT cancels out.</span>
</span>
<span class="line" id="L405">                u = u.barrettReduce().invNTT().add(e1).normalize();</span>
<span class="line" id="L406"></span>
<span class="line" id="L407">                <span class="tok-comment">// Next, compute v = &lt;t, r&gt; + e₂ + Decompress_q(m, 1)</span>
</span>
<span class="line" id="L408">                <span class="tok-kw">const</span> v = pk.th.dotHat(rh).barrettReduce().invNTT()</span>
<span class="line" id="L409">                    .add(Poly.decompress(<span class="tok-number">1</span>, pt)).add(e2).normalize();</span>
<span class="line" id="L410"></span>
<span class="line" id="L411">                <span class="tok-kw">return</span> u.compress(p.du) ++ v.compress(p.dv);</span>
<span class="line" id="L412">            }</span>
<span class="line" id="L413"></span>
<span class="line" id="L414">            <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(pk: InnerPk) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L415">                <span class="tok-kw">return</span> pk.th.toBytes() ++ pk.rho;</span>
<span class="line" id="L416">            }</span>
<span class="line" id="L417"></span>
<span class="line" id="L418">            <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) InnerPk {</span>
<span class="line" id="L419">                <span class="tok-kw">var</span> ret: InnerPk = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L420">                ret.th = V.fromBytes(buf[<span class="tok-number">0</span>..V.bytes_length]).normalize();</span>
<span class="line" id="L421">                ret.rho = buf[V.bytes_length..bytes_length].*;</span>
<span class="line" id="L422">                ret.aT = M.uniform(ret.rho, <span class="tok-null">true</span>);</span>
<span class="line" id="L423">                <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L424">            }</span>
<span class="line" id="L425">        };</span>
<span class="line" id="L426"></span>
<span class="line" id="L427">        <span class="tok-comment">// Private key of the inner PKE</span>
</span>
<span class="line" id="L428">        <span class="tok-kw">const</span> InnerSk = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L429">            sh: V, <span class="tok-comment">// NTT(s), normalized</span>
</span>
<span class="line" id="L430">            <span class="tok-kw">const</span> bytes_length = V.bytes_length;</span>
<span class="line" id="L431"></span>
<span class="line" id="L432">            <span class="tok-kw">fn</span> <span class="tok-fn">decrypt</span>(sk: InnerSk, ct: *<span class="tok-kw">const</span> [ciphertext_length]<span class="tok-type">u8</span>) [inner_plaintext_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L433">                <span class="tok-kw">const</span> u = V.decompress(p.du, ct[<span class="tok-number">0</span>..<span class="tok-kw">comptime</span> V.compressedSize(p.du)]);</span>
<span class="line" id="L434">                <span class="tok-kw">const</span> v = Poly.decompress(</span>
<span class="line" id="L435">                    p.dv,</span>
<span class="line" id="L436">                    ct[<span class="tok-kw">comptime</span> V.compressedSize(p.du)..ciphertext_length],</span>
<span class="line" id="L437">                );</span>
<span class="line" id="L438"></span>
<span class="line" id="L439">                <span class="tok-comment">// Compute m = v - &lt;s, u&gt;</span>
</span>
<span class="line" id="L440">                <span class="tok-kw">return</span> v.sub(sk.sh.dotHat(u.ntt()).barrettReduce().invNTT())</span>
<span class="line" id="L441">                    .normalize().compress(<span class="tok-number">1</span>);</span>
<span class="line" id="L442">            }</span>
<span class="line" id="L443"></span>
<span class="line" id="L444">            <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(sk: InnerSk) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L445">                <span class="tok-kw">return</span> sk.sh.toBytes();</span>
<span class="line" id="L446">            }</span>
<span class="line" id="L447"></span>
<span class="line" id="L448">            <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) InnerSk {</span>
<span class="line" id="L449">                <span class="tok-kw">var</span> ret: InnerSk = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L450">                ret.sh = V.fromBytes(buf).normalize();</span>
<span class="line" id="L451">                <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L452">            }</span>
<span class="line" id="L453">        };</span>
<span class="line" id="L454"></span>
<span class="line" id="L455">        <span class="tok-comment">// Derives inner PKE keypair from given seed.</span>
</span>
<span class="line" id="L456">        <span class="tok-kw">fn</span> <span class="tok-fn">innerKeyFromSeed</span>(seed: [inner_seed_length]<span class="tok-type">u8</span>, pk: *InnerPk, sk: *InnerSk) <span class="tok-type">void</span> {</span>
<span class="line" id="L457">            <span class="tok-kw">var</span> expanded_seed: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L458"></span>
<span class="line" id="L459">            <span class="tok-kw">var</span> h = sha3.Sha3_512.init(.{});</span>
<span class="line" id="L460">            h.update(&amp;seed);</span>
<span class="line" id="L461">            h.final(&amp;expanded_seed);</span>
<span class="line" id="L462">            pk.rho = expanded_seed[<span class="tok-number">0</span>..<span class="tok-number">32</span>].*;</span>
<span class="line" id="L463">            <span class="tok-kw">const</span> sigma = expanded_seed[<span class="tok-number">32</span>..<span class="tok-number">64</span>];</span>
<span class="line" id="L464">            pk.aT = M.uniform(pk.rho, <span class="tok-null">false</span>); <span class="tok-comment">// Expand ρ to A; we'll transpose later on</span>
</span>
<span class="line" id="L465"></span>
<span class="line" id="L466">            <span class="tok-comment">// Sample secret vector s.</span>
</span>
<span class="line" id="L467">            sk.sh = V.noise(p.eta1, <span class="tok-number">0</span>, sigma).ntt().normalize();</span>
<span class="line" id="L468"></span>
<span class="line" id="L469">            <span class="tok-kw">const</span> eh = Vec(p.k).noise(p.eta1, p.k, sigma).ntt(); <span class="tok-comment">// sample blind e.</span>
</span>
<span class="line" id="L470">            <span class="tok-kw">var</span> th: V = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L471"></span>
<span class="line" id="L472">            <span class="tok-comment">// Next, we compute t = A s + e.</span>
</span>
<span class="line" id="L473">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..p.k) |i| {</span>
<span class="line" id="L474">                <span class="tok-comment">// Note that coefficients of s are bounded by q and those of A</span>
</span>
<span class="line" id="L475">                <span class="tok-comment">// are bounded by 4.5q and so their product is bounded by 2¹⁵q</span>
</span>
<span class="line" id="L476">                <span class="tok-comment">// as required for multiplication.</span>
</span>
<span class="line" id="L477">                <span class="tok-comment">// A and s were not in Montgomery form, so the Montgomery</span>
</span>
<span class="line" id="L478">                <span class="tok-comment">// multiplications in the inner product added a factor R⁻¹ which</span>
</span>
<span class="line" id="L479">                <span class="tok-comment">// we'll cancel out with toMont().  This will also ensure the</span>
</span>
<span class="line" id="L480">                <span class="tok-comment">// coefficients of th are bounded in absolute value by q.</span>
</span>
<span class="line" id="L481">                th.ps[i] = pk.aT.vs[i].dotHat(sk.sh).toMont();</span>
<span class="line" id="L482">            }</span>
<span class="line" id="L483"></span>
<span class="line" id="L484">            pk.th = th.add(eh).normalize(); <span class="tok-comment">// bounded by 8q</span>
</span>
<span class="line" id="L485">            pk.aT = pk.aT.transpose();</span>
<span class="line" id="L486">        }</span>
<span class="line" id="L487">    };</span>
<span class="line" id="L488">}</span>
<span class="line" id="L489"></span>
<span class="line" id="L490"><span class="tok-comment">// R mod q</span>
</span>
<span class="line" id="L491"><span class="tok-kw">const</span> r_mod_q: <span class="tok-type">i32</span> = <span class="tok-builtin">@rem</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, R), Q);</span>
<span class="line" id="L492"></span>
<span class="line" id="L493"><span class="tok-comment">// R² mod q</span>
</span>
<span class="line" id="L494"><span class="tok-kw">const</span> r2_mod_q: <span class="tok-type">i32</span> = <span class="tok-builtin">@rem</span>(r_mod_q * r_mod_q, Q);</span>
<span class="line" id="L495"></span>
<span class="line" id="L496"><span class="tok-comment">// ζ is the degree 256 primitive root of unity used for the NTT.</span>
</span>
<span class="line" id="L497"><span class="tok-kw">const</span> zeta: <span class="tok-type">i16</span> = <span class="tok-number">17</span>;</span>
<span class="line" id="L498"></span>
<span class="line" id="L499"><span class="tok-comment">// (128)⁻¹ R². Used in inverse NTT.</span>
</span>
<span class="line" id="L500"><span class="tok-kw">const</span> r2_over_128: <span class="tok-type">i32</span> = <span class="tok-builtin">@mod</span>(invertMod(<span class="tok-number">128</span>, Q) * r2_mod_q, Q);</span>
<span class="line" id="L501"></span>
<span class="line" id="L502"><span class="tok-comment">// zetas lists precomputed powers of the primitive root of unity in</span>
</span>
<span class="line" id="L503"><span class="tok-comment">// Montgomery representation used for the NTT:</span>
</span>
<span class="line" id="L504"><span class="tok-comment">//</span>
</span>
<span class="line" id="L505"><span class="tok-comment">//  zetas[i] = ζᵇʳᵛ⁽ⁱ⁾ R mod q</span>
</span>
<span class="line" id="L506"><span class="tok-comment">//</span>
</span>
<span class="line" id="L507"><span class="tok-comment">// where ζ = 17, brv(i) is the bitreversal of a 7-bit number and R=2¹⁶ mod q.</span>
</span>
<span class="line" id="L508"><span class="tok-kw">const</span> zetas = computeZetas();</span>
<span class="line" id="L509"></span>
<span class="line" id="L510"><span class="tok-comment">// invNTTReductions keeps track of which coefficients to apply Barrett</span>
</span>
<span class="line" id="L511"><span class="tok-comment">// reduction to in Poly.invNTT().</span>
</span>
<span class="line" id="L512"><span class="tok-comment">//</span>
</span>
<span class="line" id="L513"><span class="tok-comment">// Generated lazily: once a butterfly is computed which is about to</span>
</span>
<span class="line" id="L514"><span class="tok-comment">// overflow the i16, the largest coefficient is reduced.  If that is</span>
</span>
<span class="line" id="L515"><span class="tok-comment">// not enough, the other coefficient is reduced as well.</span>
</span>
<span class="line" id="L516"><span class="tok-comment">//</span>
</span>
<span class="line" id="L517"><span class="tok-comment">// This is actually optimal, as proven in https://eprint.iacr.org/2020/1377.pdf</span>
</span>
<span class="line" id="L518"><span class="tok-comment">// TODO generate comptime?</span>
</span>
<span class="line" id="L519"><span class="tok-kw">const</span> inv_ntt_reductions = [_]<span class="tok-type">i16</span>{</span>
<span class="line" id="L520">    -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 1</span>
</span>
<span class="line" id="L521">    -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 2</span>
</span>
<span class="line" id="L522">    <span class="tok-number">16</span>,</span>
<span class="line" id="L523">    <span class="tok-number">17</span>,</span>
<span class="line" id="L524">    <span class="tok-number">48</span>,</span>
<span class="line" id="L525">    <span class="tok-number">49</span>,</span>
<span class="line" id="L526">    <span class="tok-number">80</span>,</span>
<span class="line" id="L527">    <span class="tok-number">81</span>,</span>
<span class="line" id="L528">    <span class="tok-number">112</span>,</span>
<span class="line" id="L529">    <span class="tok-number">113</span>,</span>
<span class="line" id="L530">    <span class="tok-number">144</span>,</span>
<span class="line" id="L531">    <span class="tok-number">145</span>,</span>
<span class="line" id="L532">    <span class="tok-number">176</span>,</span>
<span class="line" id="L533">    <span class="tok-number">177</span>,</span>
<span class="line" id="L534">    <span class="tok-number">208</span>,</span>
<span class="line" id="L535">    <span class="tok-number">209</span>,</span>
<span class="line" id="L536">    <span class="tok-number">240</span>, <span class="tok-number">241</span>, -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 3</span>
</span>
<span class="line" id="L537">    <span class="tok-number">0</span>,   <span class="tok-number">1</span>,   <span class="tok-number">32</span>,</span>
<span class="line" id="L538">    <span class="tok-number">33</span>,  <span class="tok-number">34</span>,  <span class="tok-number">35</span>,</span>
<span class="line" id="L539">    <span class="tok-number">64</span>,  <span class="tok-number">65</span>,  <span class="tok-number">96</span>,</span>
<span class="line" id="L540">    <span class="tok-number">97</span>,  <span class="tok-number">98</span>,  <span class="tok-number">99</span>,</span>
<span class="line" id="L541">    <span class="tok-number">128</span>, <span class="tok-number">129</span>,</span>
<span class="line" id="L542">    <span class="tok-number">160</span>, <span class="tok-number">161</span>, <span class="tok-number">162</span>, <span class="tok-number">163</span>, <span class="tok-number">192</span>, <span class="tok-number">193</span>, <span class="tok-number">224</span>, <span class="tok-number">225</span>, <span class="tok-number">226</span>, <span class="tok-number">227</span>, -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 4</span>
</span>
<span class="line" id="L543">    <span class="tok-number">2</span>,   <span class="tok-number">3</span>,   <span class="tok-number">66</span>,  <span class="tok-number">67</span>,  <span class="tok-number">68</span>,  <span class="tok-number">69</span>,  <span class="tok-number">70</span>,  <span class="tok-number">71</span>,  <span class="tok-number">130</span>, <span class="tok-number">131</span>, <span class="tok-number">194</span>,</span>
<span class="line" id="L544">    <span class="tok-number">195</span>, <span class="tok-number">196</span>, <span class="tok-number">197</span>,</span>
<span class="line" id="L545">    <span class="tok-number">198</span>, <span class="tok-number">199</span>, -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 5</span>
</span>
<span class="line" id="L546">    <span class="tok-number">4</span>,   <span class="tok-number">5</span>,   <span class="tok-number">6</span>,</span>
<span class="line" id="L547">    <span class="tok-number">7</span>,   <span class="tok-number">132</span>, <span class="tok-number">133</span>,</span>
<span class="line" id="L548">    <span class="tok-number">134</span>, <span class="tok-number">135</span>, <span class="tok-number">136</span>,</span>
<span class="line" id="L549">    <span class="tok-number">137</span>, <span class="tok-number">138</span>, <span class="tok-number">139</span>,</span>
<span class="line" id="L550">    <span class="tok-number">140</span>, <span class="tok-number">141</span>,</span>
<span class="line" id="L551">    <span class="tok-number">142</span>, <span class="tok-number">143</span>, -<span class="tok-number">1</span>, <span class="tok-comment">// after layer 6</span>
</span>
<span class="line" id="L552">    -<span class="tok-number">1</span>, <span class="tok-comment">//  after layer 7</span>
</span>
<span class="line" id="L553">};</span>
<span class="line" id="L554"></span>
<span class="line" id="L555"><span class="tok-kw">test</span> <span class="tok-str">&quot;invNTTReductions bounds&quot;</span> {</span>
<span class="line" id="L556">    <span class="tok-comment">// Checks whether the reductions proposed by invNTTReductions</span>
</span>
<span class="line" id="L557">    <span class="tok-comment">// don't overflow during invNTT().</span>
</span>
<span class="line" id="L558">    <span class="tok-kw">var</span> xs = [_]<span class="tok-type">i32</span>{<span class="tok-number">1</span>} ** <span class="tok-number">256</span>; <span class="tok-comment">// start at |x| ≤ q</span>
</span>
<span class="line" id="L559"></span>
<span class="line" id="L560">    <span class="tok-kw">var</span> r: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L561">    <span class="tok-kw">var</span> layer: math.Log2Int(<span class="tok-type">usize</span>) = <span class="tok-number">1</span>;</span>
<span class="line" id="L562">    <span class="tok-kw">while</span> (layer &lt; <span class="tok-number">8</span>) : (layer += <span class="tok-number">1</span>) {</span>
<span class="line" id="L563">        <span class="tok-kw">const</span> w = <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">1</span>) &lt;&lt; layer;</span>
<span class="line" id="L564">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L565"></span>
<span class="line" id="L566">        <span class="tok-kw">while</span> (i + w &lt; <span class="tok-number">256</span>) {</span>
<span class="line" id="L567">            xs[i] = xs[i] + xs[i + w];</span>
<span class="line" id="L568">            <span class="tok-kw">try</span> testing.expect(xs[i] &lt;= <span class="tok-number">9</span>); <span class="tok-comment">// we can't exceed 9q</span>
</span>
<span class="line" id="L569">            xs[i + w] = <span class="tok-number">1</span>;</span>
<span class="line" id="L570">            i += <span class="tok-number">1</span>;</span>
<span class="line" id="L571">            <span class="tok-kw">if</span> (<span class="tok-builtin">@mod</span>(i, w) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L572">                i += w;</span>
<span class="line" id="L573">            }</span>
<span class="line" id="L574">        }</span>
<span class="line" id="L575"></span>
<span class="line" id="L576">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L577">            <span class="tok-kw">const</span> j = inv_ntt_reductions[r];</span>
<span class="line" id="L578">            r += <span class="tok-number">1</span>;</span>
<span class="line" id="L579">            <span class="tok-kw">if</span> (j &lt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L580">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L581">            }</span>
<span class="line" id="L582">            xs[<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(j))] = <span class="tok-number">1</span>;</span>
<span class="line" id="L583">        }</span>
<span class="line" id="L584">    }</span>
<span class="line" id="L585">}</span>
<span class="line" id="L586"></span>
<span class="line" id="L587"><span class="tok-comment">// Extended euclidean algorithm.</span>
</span>
<span class="line" id="L588"><span class="tok-comment">//</span>
</span>
<span class="line" id="L589"><span class="tok-comment">// For a, b finds x, y such that  x a + y b = gcd(a, b). Used to compute</span>
</span>
<span class="line" id="L590"><span class="tok-comment">// modular inverse.</span>
</span>
<span class="line" id="L591"><span class="tok-kw">fn</span> <span class="tok-fn">eea</span>(a: <span class="tok-kw">anytype</span>, b: <span class="tok-builtin">@TypeOf</span>(a)) EeaResult(<span class="tok-builtin">@TypeOf</span>(a)) {</span>
<span class="line" id="L592">    <span class="tok-kw">if</span> (a == <span class="tok-number">0</span>) {</span>
<span class="line" id="L593">        <span class="tok-kw">return</span> .{ .gcd = b, .x = <span class="tok-number">0</span>, .y = <span class="tok-number">1</span> };</span>
<span class="line" id="L594">    }</span>
<span class="line" id="L595">    <span class="tok-kw">const</span> r = eea(<span class="tok-builtin">@rem</span>(b, a), a);</span>
<span class="line" id="L596">    <span class="tok-kw">return</span> .{ .gcd = r.gcd, .x = r.y - <span class="tok-builtin">@divTrunc</span>(b, a) * r.x, .y = r.x };</span>
<span class="line" id="L597">}</span>
<span class="line" id="L598"></span>
<span class="line" id="L599"><span class="tok-kw">fn</span> <span class="tok-fn">EeaResult</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L600">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> { gcd: T, x: T, y: T };</span>
<span class="line" id="L601">}</span>
<span class="line" id="L602"></span>
<span class="line" id="L603"><span class="tok-comment">// Returns least common multiple of a and b.</span>
</span>
<span class="line" id="L604"><span class="tok-kw">fn</span> <span class="tok-fn">lcm</span>(a: <span class="tok-kw">anytype</span>, b: <span class="tok-builtin">@TypeOf</span>(a)) <span class="tok-builtin">@TypeOf</span>(a) {</span>
<span class="line" id="L605">    <span class="tok-kw">const</span> r = eea(a, b);</span>
<span class="line" id="L606">    <span class="tok-kw">return</span> a * b / r.gcd;</span>
<span class="line" id="L607">}</span>
<span class="line" id="L608"></span>
<span class="line" id="L609"><span class="tok-comment">// Invert modulo p.</span>
</span>
<span class="line" id="L610"><span class="tok-kw">fn</span> <span class="tok-fn">invertMod</span>(a: <span class="tok-kw">anytype</span>, p: <span class="tok-builtin">@TypeOf</span>(a)) <span class="tok-builtin">@TypeOf</span>(a) {</span>
<span class="line" id="L611">    <span class="tok-kw">const</span> r = eea(a, p);</span>
<span class="line" id="L612">    assert(r.gcd == <span class="tok-number">1</span>);</span>
<span class="line" id="L613">    <span class="tok-kw">return</span> r.x;</span>
<span class="line" id="L614">}</span>
<span class="line" id="L615"></span>
<span class="line" id="L616"><span class="tok-comment">// Reduce mod q for testing.</span>
</span>
<span class="line" id="L617"><span class="tok-kw">fn</span> <span class="tok-fn">modQ32</span>(x: <span class="tok-type">i32</span>) <span class="tok-type">i16</span> {</span>
<span class="line" id="L618">    <span class="tok-kw">var</span> y = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-builtin">@rem</span>(x, <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, Q))));</span>
<span class="line" id="L619">    <span class="tok-kw">if</span> (y &lt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L620">        y += Q;</span>
<span class="line" id="L621">    }</span>
<span class="line" id="L622">    <span class="tok-kw">return</span> y;</span>
<span class="line" id="L623">}</span>
<span class="line" id="L624"></span>
<span class="line" id="L625"><span class="tok-comment">// Given -2¹⁵ q ≤ x &lt; 2¹⁵ q, returns -q &lt; y &lt; q with x 2⁻¹⁶ = y (mod q).</span>
</span>
<span class="line" id="L626"><span class="tok-kw">fn</span> <span class="tok-fn">montReduce</span>(x: <span class="tok-type">i32</span>) <span class="tok-type">i16</span> {</span>
<span class="line" id="L627">    <span class="tok-kw">const</span> qInv = <span class="tok-kw">comptime</span> invertMod(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, Q), R);</span>
<span class="line" id="L628">    <span class="tok-comment">// This is Montgomery reduction with R=2¹⁶.</span>
</span>
<span class="line" id="L629">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L630">    <span class="tok-comment">// Note gcd(2¹⁶, q) = 1 as q is prime.  Write q' := 62209 = q⁻¹ mod R.</span>
</span>
<span class="line" id="L631">    <span class="tok-comment">// First we compute</span>
</span>
<span class="line" id="L632">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L633">    <span class="tok-comment">//	m := ((x mod R) q') mod R</span>
</span>
<span class="line" id="L634">    <span class="tok-comment">//         = x q' mod R</span>
</span>
<span class="line" id="L635">    <span class="tok-comment">//	   = int16(x q')</span>
</span>
<span class="line" id="L636">    <span class="tok-comment">//	   = int16(int32(x) * int32(q'))</span>
</span>
<span class="line" id="L637">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L638">    <span class="tok-comment">// Note that x q' might be as big as 2³² and could overflow the int32</span>
</span>
<span class="line" id="L639">    <span class="tok-comment">// multiplication in the last line.  However for any int32s a and b,</span>
</span>
<span class="line" id="L640">    <span class="tok-comment">// we have int32(int64(a)*int64(b)) = int32(a*b) and so the result is ok.</span>
</span>
<span class="line" id="L641">    <span class="tok-kw">const</span> m: <span class="tok-type">i16</span> = <span class="tok-builtin">@truncate</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@truncate</span>(x *% qInv)));</span>
<span class="line" id="L642"></span>
<span class="line" id="L643">    <span class="tok-comment">// Note that x - m q is divisible by R; indeed modulo R we have</span>
</span>
<span class="line" id="L644">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L645">    <span class="tok-comment">//  x - m q ≡ x - x q' q ≡ x - x q⁻¹ q ≡ x - x = 0.</span>
</span>
<span class="line" id="L646">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L647">    <span class="tok-comment">// We return y := (x - m q) / R.  Note that y is indeed correct as</span>
</span>
<span class="line" id="L648">    <span class="tok-comment">// modulo q we have</span>
</span>
<span class="line" id="L649">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L650">    <span class="tok-comment">//  y ≡ x R⁻¹ - m q R⁻¹ = x R⁻¹</span>
</span>
<span class="line" id="L651">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L652">    <span class="tok-comment">// and as both 2¹⁵ q ≤ m q, x &lt; 2¹⁵ q, we have</span>
</span>
<span class="line" id="L653">    <span class="tok-comment">// 2¹⁶ q ≤ x - m q &lt; 2¹⁶ and so q ≤ (x - m q) / R &lt; q as desired.</span>
</span>
<span class="line" id="L654">    <span class="tok-kw">const</span> yR = x - <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, m) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, Q);</span>
<span class="line" id="L655">    <span class="tok-kw">return</span> <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@truncate</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@bitCast</span>(yR)) &gt;&gt; <span class="tok-number">16</span>)));</span>
<span class="line" id="L656">}</span>
<span class="line" id="L657"></span>
<span class="line" id="L658"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test montReduce&quot;</span> {</span>
<span class="line" id="L659">    <span class="tok-kw">var</span> rnd = RndGen.init(<span class="tok-number">0</span>);</span>
<span class="line" id="L660">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">1000</span>) |_| {</span>
<span class="line" id="L661">        <span class="tok-kw">const</span> bound = <span class="tok-kw">comptime</span> <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, Q) * (<span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>);</span>
<span class="line" id="L662">        <span class="tok-kw">const</span> x = rnd.random().intRangeLessThan(<span class="tok-type">i32</span>, -bound, bound);</span>
<span class="line" id="L663">        <span class="tok-kw">const</span> y = montReduce(x);</span>
<span class="line" id="L664">        <span class="tok-kw">try</span> testing.expect(-Q &lt; y <span class="tok-kw">and</span> y &lt; Q);</span>
<span class="line" id="L665">        <span class="tok-kw">try</span> testing.expectEqual(modQ32(x), modQ32(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, y) * R));</span>
<span class="line" id="L666">    }</span>
<span class="line" id="L667">}</span>
<span class="line" id="L668"></span>
<span class="line" id="L669"><span class="tok-comment">// Given any x, return x R mod q where R=2¹⁶.</span>
</span>
<span class="line" id="L670"><span class="tok-kw">fn</span> <span class="tok-fn">feToMont</span>(x: <span class="tok-type">i16</span>) <span class="tok-type">i16</span> {</span>
<span class="line" id="L671">    <span class="tok-comment">// Note |1353 x| ≤ 1353 2¹⁵ ≤ 13318 q ≤ 2¹⁵ q and so we're within</span>
</span>
<span class="line" id="L672">    <span class="tok-comment">// the bounds of montReduce.</span>
</span>
<span class="line" id="L673">    <span class="tok-kw">return</span> montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, x) * r2_mod_q);</span>
<span class="line" id="L674">}</span>
<span class="line" id="L675"></span>
<span class="line" id="L676"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test feToMont&quot;</span> {</span>
<span class="line" id="L677">    <span class="tok-kw">var</span> x: <span class="tok-type">i32</span> = -(<span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>);</span>
<span class="line" id="L678">    <span class="tok-kw">while</span> (x &lt; <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>) : (x += <span class="tok-number">1</span>) {</span>
<span class="line" id="L679">        <span class="tok-kw">const</span> y = feToMont(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x)));</span>
<span class="line" id="L680">        <span class="tok-kw">try</span> testing.expectEqual(modQ32(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, y)), modQ32(x * r_mod_q));</span>
<span class="line" id="L681">    }</span>
<span class="line" id="L682">}</span>
<span class="line" id="L683"></span>
<span class="line" id="L684"><span class="tok-comment">// Given any x, compute 0 ≤ y ≤ q with x = y (mod q).</span>
</span>
<span class="line" id="L685"><span class="tok-comment">//</span>
</span>
<span class="line" id="L686"><span class="tok-comment">// Beware: we might have feBarrettReduce(x) = q ≠ 0 for some x.  In fact,</span>
</span>
<span class="line" id="L687"><span class="tok-comment">// this happens if and only if x = -nq for some positive integer n.</span>
</span>
<span class="line" id="L688"><span class="tok-kw">fn</span> <span class="tok-fn">feBarrettReduce</span>(x: <span class="tok-type">i16</span>) <span class="tok-type">i16</span> {</span>
<span class="line" id="L689">    <span class="tok-comment">// This is standard Barrett reduction.</span>
</span>
<span class="line" id="L690">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L691">    <span class="tok-comment">// For any x we have x mod q = x - ⌊x/q⌋ q.  We will use 20159/2²⁶ as</span>
</span>
<span class="line" id="L692">    <span class="tok-comment">// an approximation of 1/q. Note that  0 ≤ 20159/2²⁶ - 1/q ≤ 0.135/2²⁶</span>
</span>
<span class="line" id="L693">    <span class="tok-comment">// and so | x 20156/2²⁶ - x/q | ≤ 2⁻¹⁰ for |x| ≤ 2¹⁶.  For all x</span>
</span>
<span class="line" id="L694">    <span class="tok-comment">// not a multiple of q, the number x/q is further than 1/q from any integer</span>
</span>
<span class="line" id="L695">    <span class="tok-comment">// and so ⌊x 20156/2²⁶⌋ = ⌊x/q⌋.  If x is a multiple of q and x is positive,</span>
</span>
<span class="line" id="L696">    <span class="tok-comment">// then x 20156/2²⁶ is larger than x/q so ⌊x 20156/2²⁶⌋ = ⌊x/q⌋ as well.</span>
</span>
<span class="line" id="L697">    <span class="tok-comment">// Finally, if x is negative multiple of q, then ⌊x 20156/2²⁶⌋ = ⌊x/q⌋-1.</span>
</span>
<span class="line" id="L698">    <span class="tok-comment">// Thus</span>
</span>
<span class="line" id="L699">    <span class="tok-comment">//                        [ q        if x=-nq for pos. integer n</span>
</span>
<span class="line" id="L700">    <span class="tok-comment">//  x - ⌊x 20156/2²⁶⌋ q = [</span>
</span>
<span class="line" id="L701">    <span class="tok-comment">//                        [ x mod q  otherwise</span>
</span>
<span class="line" id="L702">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L703">    <span class="tok-comment">// To actually compute this, note that</span>
</span>
<span class="line" id="L704">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L705">    <span class="tok-comment">//  ⌊x 20156/2²⁶⌋ = (20159 x) &gt;&gt; 26.</span>
</span>
<span class="line" id="L706">    <span class="tok-kw">return</span> x -% <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>((<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, x) * <span class="tok-number">20159</span>) &gt;&gt; <span class="tok-number">26</span>)) *% Q;</span>
<span class="line" id="L707">}</span>
<span class="line" id="L708"></span>
<span class="line" id="L709"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test Barrett reduction&quot;</span> {</span>
<span class="line" id="L710">    <span class="tok-kw">var</span> x: <span class="tok-type">i32</span> = -(<span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>);</span>
<span class="line" id="L711">    <span class="tok-kw">while</span> (x &lt; <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>) : (x += <span class="tok-number">1</span>) {</span>
<span class="line" id="L712">        <span class="tok-kw">var</span> y1 = feBarrettReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x)));</span>
<span class="line" id="L713">        <span class="tok-kw">const</span> y2 = <span class="tok-builtin">@mod</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x)), Q);</span>
<span class="line" id="L714">        <span class="tok-kw">if</span> (x &lt; <span class="tok-number">0</span> <span class="tok-kw">and</span> <span class="tok-builtin">@rem</span>(-x, Q) == <span class="tok-number">0</span>) {</span>
<span class="line" id="L715">            y1 -= Q;</span>
<span class="line" id="L716">        }</span>
<span class="line" id="L717">        <span class="tok-kw">try</span> testing.expectEqual(y1, y2);</span>
<span class="line" id="L718">    }</span>
<span class="line" id="L719">}</span>
<span class="line" id="L720"></span>
<span class="line" id="L721"><span class="tok-comment">// Returns x if x &lt; q and x - q otherwise.  Assumes x ≥ -29439.</span>
</span>
<span class="line" id="L722"><span class="tok-kw">fn</span> <span class="tok-fn">csubq</span>(x: <span class="tok-type">i16</span>) <span class="tok-type">i16</span> {</span>
<span class="line" id="L723">    <span class="tok-kw">var</span> r = x;</span>
<span class="line" id="L724">    r -= Q;</span>
<span class="line" id="L725">    r += (r &gt;&gt; <span class="tok-number">15</span>) &amp; Q;</span>
<span class="line" id="L726">    <span class="tok-kw">return</span> r;</span>
<span class="line" id="L727">}</span>
<span class="line" id="L728"></span>
<span class="line" id="L729"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test csubq&quot;</span> {</span>
<span class="line" id="L730">    <span class="tok-kw">var</span> x: <span class="tok-type">i32</span> = -<span class="tok-number">29439</span>;</span>
<span class="line" id="L731">    <span class="tok-kw">while</span> (x &lt; <span class="tok-number">1</span> &lt;&lt; <span class="tok-number">15</span>) : (x += <span class="tok-number">1</span>) {</span>
<span class="line" id="L732">        <span class="tok-kw">const</span> y1 = csubq(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x)));</span>
<span class="line" id="L733">        <span class="tok-kw">var</span> y2 = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x));</span>
<span class="line" id="L734">        <span class="tok-kw">if</span> (<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(x)) &gt;= Q) {</span>
<span class="line" id="L735">            y2 -= Q;</span>
<span class="line" id="L736">        }</span>
<span class="line" id="L737">        <span class="tok-kw">try</span> testing.expectEqual(y1, y2);</span>
<span class="line" id="L738">    }</span>
<span class="line" id="L739">}</span>
<span class="line" id="L740"></span>
<span class="line" id="L741"><span class="tok-comment">// Compute a^s mod p.</span>
</span>
<span class="line" id="L742"><span class="tok-kw">fn</span> <span class="tok-fn">mpow</span>(a: <span class="tok-kw">anytype</span>, s: <span class="tok-builtin">@TypeOf</span>(a), p: <span class="tok-builtin">@TypeOf</span>(a)) <span class="tok-builtin">@TypeOf</span>(a) {</span>
<span class="line" id="L743">    <span class="tok-kw">var</span> ret: <span class="tok-builtin">@TypeOf</span>(a) = <span class="tok-number">1</span>;</span>
<span class="line" id="L744">    <span class="tok-kw">var</span> s2 = s;</span>
<span class="line" id="L745">    <span class="tok-kw">var</span> a2 = a;</span>
<span class="line" id="L746"></span>
<span class="line" id="L747">    <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L748">        <span class="tok-kw">if</span> (s2 &amp; <span class="tok-number">1</span> == <span class="tok-number">1</span>) {</span>
<span class="line" id="L749">            ret = <span class="tok-builtin">@mod</span>(ret * a2, p);</span>
<span class="line" id="L750">        }</span>
<span class="line" id="L751">        s2 &gt;&gt;= <span class="tok-number">1</span>;</span>
<span class="line" id="L752">        <span class="tok-kw">if</span> (s2 == <span class="tok-number">0</span>) {</span>
<span class="line" id="L753">            <span class="tok-kw">break</span>;</span>
<span class="line" id="L754">        }</span>
<span class="line" id="L755">        a2 = <span class="tok-builtin">@mod</span>(a2 * a2, p);</span>
<span class="line" id="L756">    }</span>
<span class="line" id="L757">    <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L758">}</span>
<span class="line" id="L759"></span>
<span class="line" id="L760"><span class="tok-comment">// Computes zetas table used by ntt and invNTT.</span>
</span>
<span class="line" id="L761"><span class="tok-kw">fn</span> <span class="tok-fn">computeZetas</span>() [<span class="tok-number">128</span>]<span class="tok-type">i16</span> {</span>
<span class="line" id="L762">    <span class="tok-builtin">@setEvalBranchQuota</span>(<span class="tok-number">10000</span>);</span>
<span class="line" id="L763">    <span class="tok-kw">var</span> ret: [<span class="tok-number">128</span>]<span class="tok-type">i16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L764">    <span class="tok-kw">for</span> (&amp;ret, <span class="tok-number">0</span>..) |*r, i| {</span>
<span class="line" id="L765">        <span class="tok-kw">const</span> t = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(mpow(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, zeta), <span class="tok-builtin">@bitReverse</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u7</span>, <span class="tok-builtin">@intCast</span>(i))), Q)));</span>
<span class="line" id="L766">        r.* = csubq(feBarrettReduce(feToMont(t)));</span>
<span class="line" id="L767">    }</span>
<span class="line" id="L768">    <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L769">}</span>
<span class="line" id="L770"></span>
<span class="line" id="L771"><span class="tok-comment">// An element of our base ring R which are polynomials over ℤ_q</span>
</span>
<span class="line" id="L772"><span class="tok-comment">// modulo the equation Xᴺ = -1, where q=3329 and N=256.</span>
</span>
<span class="line" id="L773"><span class="tok-comment">//</span>
</span>
<span class="line" id="L774"><span class="tok-comment">// This type is also used to store NTT-transformed polynomials,</span>
</span>
<span class="line" id="L775"><span class="tok-comment">// see Poly.NTT().</span>
</span>
<span class="line" id="L776"><span class="tok-comment">//</span>
</span>
<span class="line" id="L777"><span class="tok-comment">// Coefficients aren't always reduced.  See Normalize().</span>
</span>
<span class="line" id="L778"><span class="tok-kw">const</span> Poly = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L779">    cs: [N]<span class="tok-type">i16</span>,</span>
<span class="line" id="L780"></span>
<span class="line" id="L781">    <span class="tok-kw">const</span> bytes_length = N / <span class="tok-number">2</span> * <span class="tok-number">3</span>;</span>
<span class="line" id="L782">    <span class="tok-kw">const</span> zero: Poly = .{ .cs = .{<span class="tok-number">0</span>} ** N };</span>
<span class="line" id="L783"></span>
<span class="line" id="L784">    <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(a: Poly, b: Poly) Poly {</span>
<span class="line" id="L785">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L786">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L787">            ret.cs[i] = a.cs[i] + b.cs[i];</span>
<span class="line" id="L788">        }</span>
<span class="line" id="L789">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L790">    }</span>
<span class="line" id="L791"></span>
<span class="line" id="L792">    <span class="tok-kw">fn</span> <span class="tok-fn">sub</span>(a: Poly, b: Poly) Poly {</span>
<span class="line" id="L793">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L794">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L795">            ret.cs[i] = a.cs[i] - b.cs[i];</span>
<span class="line" id="L796">        }</span>
<span class="line" id="L797">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L798">    }</span>
<span class="line" id="L799"></span>
<span class="line" id="L800">    <span class="tok-comment">// For testing, generates a random polynomial with for each</span>
</span>
<span class="line" id="L801">    <span class="tok-comment">// coefficient |x| ≤ q.</span>
</span>
<span class="line" id="L802">    <span class="tok-kw">fn</span> <span class="tok-fn">randAbsLeqQ</span>(rnd: <span class="tok-kw">anytype</span>) Poly {</span>
<span class="line" id="L803">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L804">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L805">            ret.cs[i] = rnd.random().intRangeAtMost(<span class="tok-type">i16</span>, -Q, Q);</span>
<span class="line" id="L806">        }</span>
<span class="line" id="L807">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L808">    }</span>
<span class="line" id="L809"></span>
<span class="line" id="L810">    <span class="tok-comment">// For testing, generates a random normalized polynomial.</span>
</span>
<span class="line" id="L811">    <span class="tok-kw">fn</span> <span class="tok-fn">randNormalized</span>(rnd: <span class="tok-kw">anytype</span>) Poly {</span>
<span class="line" id="L812">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L813">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L814">            ret.cs[i] = rnd.random().intRangeLessThan(<span class="tok-type">i16</span>, <span class="tok-number">0</span>, Q);</span>
<span class="line" id="L815">        }</span>
<span class="line" id="L816">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L817">    }</span>
<span class="line" id="L818"></span>
<span class="line" id="L819">    <span class="tok-comment">// Executes a forward &quot;NTT&quot; on p.</span>
</span>
<span class="line" id="L820">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L821">    <span class="tok-comment">// Assumes the coefficients are in absolute value ≤q.  The resulting</span>
</span>
<span class="line" id="L822">    <span class="tok-comment">// coefficients are in absolute value ≤7q.  If the input is in Montgomery</span>
</span>
<span class="line" id="L823">    <span class="tok-comment">// form, then the result is in Montgomery form and so (by linearity of the NTT)</span>
</span>
<span class="line" id="L824">    <span class="tok-comment">// if the input is in regular form, then the result is also in regular form.</span>
</span>
<span class="line" id="L825">    <span class="tok-kw">fn</span> <span class="tok-fn">ntt</span>(a: Poly) Poly {</span>
<span class="line" id="L826">        <span class="tok-comment">// Note that ℤ_q does not have a primitive 512ᵗʰ root of unity (as 512</span>
</span>
<span class="line" id="L827">        <span class="tok-comment">// does not divide into q-1) and so we cannot do a regular NTT.  ℤ_q</span>
</span>
<span class="line" id="L828">        <span class="tok-comment">// does have a primitive 256ᵗʰ root of unity, the smallest of which</span>
</span>
<span class="line" id="L829">        <span class="tok-comment">// is ζ := 17.</span>
</span>
<span class="line" id="L830">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L831">        <span class="tok-comment">// Recall that our base ring R := ℤ_q[x] / (x²⁵⁶ + 1).  The polynomial</span>
</span>
<span class="line" id="L832">        <span class="tok-comment">// x²⁵⁶+1 will not split completely (as its roots would be 512ᵗʰ roots</span>
</span>
<span class="line" id="L833">        <span class="tok-comment">// of unity.)  However, it does split almost (using ζ¹²⁸ = -1):</span>
</span>
<span class="line" id="L834">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L835">        <span class="tok-comment">// x²⁵⁶ + 1 = (x²)¹²⁸ - ζ¹²⁸</span>
</span>
<span class="line" id="L836">        <span class="tok-comment">//          = ((x²)⁶⁴ - ζ⁶⁴)((x²)⁶⁴ + ζ⁶⁴)</span>
</span>
<span class="line" id="L837">        <span class="tok-comment">//          = ((x²)³² - ζ³²)((x²)³² + ζ³²)((x²)³² - ζ⁹⁶)((x²)³² + ζ⁹⁶)</span>
</span>
<span class="line" id="L838">        <span class="tok-comment">//          ⋮</span>
</span>
<span class="line" id="L839">        <span class="tok-comment">//          = (x² - ζ)(x² + ζ)(x² - ζ⁶⁵)(x² + ζ⁶⁵) … (x² + ζ¹²⁷)</span>
</span>
<span class="line" id="L840">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L841">        <span class="tok-comment">// Note that the powers of ζ that appear (from the second line down) are</span>
</span>
<span class="line" id="L842">        <span class="tok-comment">// in binary</span>
</span>
<span class="line" id="L843">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L844">        <span class="tok-comment">// 0100000 1100000</span>
</span>
<span class="line" id="L845">        <span class="tok-comment">// 0010000 1010000 0110000 1110000</span>
</span>
<span class="line" id="L846">        <span class="tok-comment">// 0001000 1001000 0101000 1101000 0011000 1011000 0111000 1111000</span>
</span>
<span class="line" id="L847">        <span class="tok-comment">//         …</span>
</span>
<span class="line" id="L848">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L849">        <span class="tok-comment">// That is: brv(2), brv(3), brv(4), …, where brv(x) denotes the 7-bit</span>
</span>
<span class="line" id="L850">        <span class="tok-comment">// bitreversal of x.  These powers of ζ are given by the Zetas array.</span>
</span>
<span class="line" id="L851">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L852">        <span class="tok-comment">// The polynomials x² ± ζⁱ are irreducible and coprime, hence by</span>
</span>
<span class="line" id="L853">        <span class="tok-comment">// the Chinese Remainder Theorem we know</span>
</span>
<span class="line" id="L854">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L855">        <span class="tok-comment">//  ℤ_q[x]/(x²⁵⁶+1) → ℤ_q[x]/(x²-ζ) x … x  ℤ_q[x]/(x²+ζ¹²⁷)</span>
</span>
<span class="line" id="L856">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L857">        <span class="tok-comment">// given by a ↦ ( a mod x²-ζ, …, a mod x²+ζ¹²⁷ )</span>
</span>
<span class="line" id="L858">        <span class="tok-comment">// is an isomorphism, which is the &quot;NTT&quot;.  It can be efficiently computed by</span>
</span>
<span class="line" id="L859">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L860">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L861">        <span class="tok-comment">//  a ↦ ( a mod (x²)⁶⁴ - ζ⁶⁴, a mod (x²)⁶⁴ + ζ⁶⁴ )</span>
</span>
<span class="line" id="L862">        <span class="tok-comment">//    ↦ ( a mod (x²)³² - ζ³², a mod (x²)³² + ζ³²,</span>
</span>
<span class="line" id="L863">        <span class="tok-comment">//        a mod (x²)⁹⁶ - ζ⁹⁶, a mod (x²)⁹⁶ + ζ⁹⁶ )</span>
</span>
<span class="line" id="L864">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L865">        <span class="tok-comment">//      et cetera</span>
</span>
<span class="line" id="L866">        <span class="tok-comment">// If N was 8 then this can be pictured in the following diagram:</span>
</span>
<span class="line" id="L867">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L868">        <span class="tok-comment">//  https://cnx.org/resources/17ee4dfe517a6adda05377b25a00bf6e6c93c334/File0026.png</span>
</span>
<span class="line" id="L869">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L870">        <span class="tok-comment">// Each cross is a Cooley-Tukey butterfly: it's the map</span>
</span>
<span class="line" id="L871">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L872">        <span class="tok-comment">//  (a, b) ↦ (a + ζb, a - ζb)</span>
</span>
<span class="line" id="L873">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L874">        <span class="tok-comment">// for the appropriate power ζ for that column and row group.</span>
</span>
<span class="line" id="L875">        <span class="tok-kw">var</span> p = a;</span>
<span class="line" id="L876">        <span class="tok-kw">var</span> k: <span class="tok-type">usize</span> = <span class="tok-number">0</span>; <span class="tok-comment">// index into zetas</span>
</span>
<span class="line" id="L877"></span>
<span class="line" id="L878">        <span class="tok-kw">var</span> l = N &gt;&gt; <span class="tok-number">1</span>;</span>
<span class="line" id="L879">        <span class="tok-kw">while</span> (l &gt; <span class="tok-number">1</span>) : (l &gt;&gt;= <span class="tok-number">1</span>) {</span>
<span class="line" id="L880">            <span class="tok-comment">// On the nᵗʰ iteration of the l-loop, the absolute value of the</span>
</span>
<span class="line" id="L881">            <span class="tok-comment">// coefficients are bounded by nq.</span>
</span>
<span class="line" id="L882"></span>
<span class="line" id="L883">            <span class="tok-comment">// offset effectively loops over the row groups in this column; it is</span>
</span>
<span class="line" id="L884">            <span class="tok-comment">// the first row in the row group.</span>
</span>
<span class="line" id="L885">            <span class="tok-kw">var</span> offset: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L886">            <span class="tok-kw">while</span> (offset &lt; N - l) : (offset += <span class="tok-number">2</span> * l) {</span>
<span class="line" id="L887">                k += <span class="tok-number">1</span>;</span>
<span class="line" id="L888">                <span class="tok-kw">const</span> z = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, zetas[k]);</span>
<span class="line" id="L889"></span>
<span class="line" id="L890">                <span class="tok-comment">// j loops over each butterfly in the row group.</span>
</span>
<span class="line" id="L891">                <span class="tok-kw">for</span> (offset..offset + l) |j| {</span>
<span class="line" id="L892">                    <span class="tok-kw">const</span> t = montReduce(z * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, p.cs[j + l]));</span>
<span class="line" id="L893">                    p.cs[j + l] = p.cs[j] - t;</span>
<span class="line" id="L894">                    p.cs[j] += t;</span>
<span class="line" id="L895">                }</span>
<span class="line" id="L896">            }</span>
<span class="line" id="L897">        }</span>
<span class="line" id="L898"></span>
<span class="line" id="L899">        <span class="tok-kw">return</span> p;</span>
<span class="line" id="L900">    }</span>
<span class="line" id="L901"></span>
<span class="line" id="L902">    <span class="tok-comment">// Executes an inverse &quot;NTT&quot; on p and multiply by the Montgomery factor R.</span>
</span>
<span class="line" id="L903">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L904">    <span class="tok-comment">// Assumes the coefficients are in absolute value ≤q.  The resulting</span>
</span>
<span class="line" id="L905">    <span class="tok-comment">// coefficients are in absolute value ≤q.  If the input is in Montgomery</span>
</span>
<span class="line" id="L906">    <span class="tok-comment">// form, then the result is in Montgomery form and so (by linearity)</span>
</span>
<span class="line" id="L907">    <span class="tok-comment">// if the input is in regular form, then the result is also in regular form.</span>
</span>
<span class="line" id="L908">    <span class="tok-kw">fn</span> <span class="tok-fn">invNTT</span>(a: Poly) Poly {</span>
<span class="line" id="L909">        <span class="tok-kw">var</span> k: <span class="tok-type">usize</span> = <span class="tok-number">127</span>; <span class="tok-comment">// index into zetas</span>
</span>
<span class="line" id="L910">        <span class="tok-kw">var</span> r: <span class="tok-type">usize</span> = <span class="tok-number">0</span>; <span class="tok-comment">// index into invNTTReductions</span>
</span>
<span class="line" id="L911">        <span class="tok-kw">var</span> p = a;</span>
<span class="line" id="L912"></span>
<span class="line" id="L913">        <span class="tok-comment">// We basically do the oppposite of NTT, but postpone dividing by 2 in the</span>
</span>
<span class="line" id="L914">        <span class="tok-comment">// inverse of the Cooley-Tukey butterfly and accumulate that into a big</span>
</span>
<span class="line" id="L915">        <span class="tok-comment">// division by 2⁷ at the end.  See the comments in the ntt() function.</span>
</span>
<span class="line" id="L916"></span>
<span class="line" id="L917">        <span class="tok-kw">var</span> l: <span class="tok-type">usize</span> = <span class="tok-number">2</span>;</span>
<span class="line" id="L918">        <span class="tok-kw">while</span> (l &lt; N) : (l &lt;&lt;= <span class="tok-number">1</span>) {</span>
<span class="line" id="L919">            <span class="tok-kw">var</span> offset: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L920">            <span class="tok-kw">while</span> (offset &lt; N - l) : (offset += <span class="tok-number">2</span> * l) {</span>
<span class="line" id="L921">                <span class="tok-comment">// As we're inverting, we need powers of ζ⁻¹ (instead of ζ).</span>
</span>
<span class="line" id="L922">                <span class="tok-comment">// To be precise, we need ζᵇʳᵛ⁽ᵏ⁾⁻¹²⁸. However, as ζ⁻¹²⁸ = -1,</span>
</span>
<span class="line" id="L923">                <span class="tok-comment">// we can use the existing zetas table instead of</span>
</span>
<span class="line" id="L924">                <span class="tok-comment">// keeping a separate invZetas table as in Dilithium.</span>
</span>
<span class="line" id="L925"></span>
<span class="line" id="L926">                <span class="tok-kw">const</span> minZeta = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, zetas[k]);</span>
<span class="line" id="L927">                k -= <span class="tok-number">1</span>;</span>
<span class="line" id="L928"></span>
<span class="line" id="L929">                <span class="tok-kw">for</span> (offset..offset + l) |j| {</span>
<span class="line" id="L930">                    <span class="tok-comment">// Gentleman-Sande butterfly: (a, b) ↦ (a + b, ζ(a-b))</span>
</span>
<span class="line" id="L931">                    <span class="tok-kw">const</span> t = p.cs[j + l] - p.cs[j];</span>
<span class="line" id="L932">                    p.cs[j] += p.cs[j + l];</span>
<span class="line" id="L933">                    p.cs[j + l] = montReduce(minZeta * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, t));</span>
<span class="line" id="L934"></span>
<span class="line" id="L935">                    <span class="tok-comment">// Note that if we had |a| &lt; αq and |b| &lt; βq before the</span>
</span>
<span class="line" id="L936">                    <span class="tok-comment">// butterfly, then now we have |a| &lt; (α+β)q and |b| &lt; q.</span>
</span>
<span class="line" id="L937">                }</span>
<span class="line" id="L938">            }</span>
<span class="line" id="L939"></span>
<span class="line" id="L940">            <span class="tok-comment">// We let the invNTTReductions instruct us which coefficients to</span>
</span>
<span class="line" id="L941">            <span class="tok-comment">// Barrett reduce.</span>
</span>
<span class="line" id="L942">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L943">                <span class="tok-kw">const</span> i = inv_ntt_reductions[r];</span>
<span class="line" id="L944">                r += <span class="tok-number">1</span>;</span>
<span class="line" id="L945">                <span class="tok-kw">if</span> (i &lt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L946">                    <span class="tok-kw">break</span>;</span>
<span class="line" id="L947">                }</span>
<span class="line" id="L948">                p.cs[<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(i))] = feBarrettReduce(p.cs[<span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-builtin">@intCast</span>(i))]);</span>
<span class="line" id="L949">            }</span>
<span class="line" id="L950">        }</span>
<span class="line" id="L951"></span>
<span class="line" id="L952">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |j| {</span>
<span class="line" id="L953">            <span class="tok-comment">// Note 1441 = (128)⁻¹ R².  The coefficients are bounded by 9q, so</span>
</span>
<span class="line" id="L954">            <span class="tok-comment">// as 1441 * 9 ≈ 2¹⁴ &lt; 2¹⁵, we're within the required bounds</span>
</span>
<span class="line" id="L955">            <span class="tok-comment">// for montReduce().</span>
</span>
<span class="line" id="L956">            p.cs[j] = montReduce(r2_over_128 * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, p.cs[j]));</span>
<span class="line" id="L957">        }</span>
<span class="line" id="L958"></span>
<span class="line" id="L959">        <span class="tok-kw">return</span> p;</span>
<span class="line" id="L960">    }</span>
<span class="line" id="L961"></span>
<span class="line" id="L962">    <span class="tok-comment">// Normalizes coefficients.</span>
</span>
<span class="line" id="L963">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L964">    <span class="tok-comment">// Ensures each coefficient is in {0, …, q-1}.</span>
</span>
<span class="line" id="L965">    <span class="tok-kw">fn</span> <span class="tok-fn">normalize</span>(a: Poly) Poly {</span>
<span class="line" id="L966">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L967">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L968">            ret.cs[i] = csubq(feBarrettReduce(a.cs[i]));</span>
<span class="line" id="L969">        }</span>
<span class="line" id="L970">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L971">    }</span>
<span class="line" id="L972"></span>
<span class="line" id="L973">    <span class="tok-comment">// Put p in Montgomery form.</span>
</span>
<span class="line" id="L974">    <span class="tok-kw">fn</span> <span class="tok-fn">toMont</span>(a: Poly) Poly {</span>
<span class="line" id="L975">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L976">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L977">            ret.cs[i] = feToMont(a.cs[i]);</span>
<span class="line" id="L978">        }</span>
<span class="line" id="L979">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L980">    }</span>
<span class="line" id="L981"></span>
<span class="line" id="L982">    <span class="tok-comment">// Barret reduce coefficients.</span>
</span>
<span class="line" id="L983">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L984">    <span class="tok-comment">// Beware, this does not fully normalize coefficients.</span>
</span>
<span class="line" id="L985">    <span class="tok-kw">fn</span> <span class="tok-fn">barrettReduce</span>(a: Poly) Poly {</span>
<span class="line" id="L986">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L987">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L988">            ret.cs[i] = feBarrettReduce(a.cs[i]);</span>
<span class="line" id="L989">        }</span>
<span class="line" id="L990">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L991">    }</span>
<span class="line" id="L992"></span>
<span class="line" id="L993">    <span class="tok-kw">fn</span> <span class="tok-fn">compressedSize</span>(<span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>) <span class="tok-type">usize</span> {</span>
<span class="line" id="L994">        <span class="tok-kw">return</span> <span class="tok-builtin">@divTrunc</span>(N * d, <span class="tok-number">8</span>);</span>
<span class="line" id="L995">    }</span>
<span class="line" id="L996"></span>
<span class="line" id="L997">    <span class="tok-comment">// Returns packed Compress_q(p, d).</span>
</span>
<span class="line" id="L998">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L999">    <span class="tok-comment">// Assumes p is normalized.</span>
</span>
<span class="line" id="L1000">    <span class="tok-kw">fn</span> <span class="tok-fn">compress</span>(p: Poly, <span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>) [compressedSize(d)]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1001">        <span class="tok-builtin">@setEvalBranchQuota</span>(<span class="tok-number">10000</span>);</span>
<span class="line" id="L1002">        <span class="tok-kw">const</span> q_over_2: <span class="tok-type">u32</span> = <span class="tok-kw">comptime</span> <span class="tok-builtin">@divTrunc</span>(Q, <span class="tok-number">2</span>); <span class="tok-comment">// (q-1)/2</span>
</span>
<span class="line" id="L1003">        <span class="tok-kw">const</span> two_d_min_1: <span class="tok-type">u32</span> = <span class="tok-kw">comptime</span> (<span class="tok-number">1</span> &lt;&lt; d) - <span class="tok-number">1</span>; <span class="tok-comment">// 2ᵈ-1</span>
</span>
<span class="line" id="L1004">        <span class="tok-kw">var</span> in_off: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1005">        <span class="tok-kw">var</span> out_off: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1006"></span>
<span class="line" id="L1007">        <span class="tok-kw">const</span> batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> lcm(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, d), <span class="tok-number">8</span>);</span>
<span class="line" id="L1008">        <span class="tok-kw">const</span> in_batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> batch_size / d;</span>
<span class="line" id="L1009">        <span class="tok-kw">const</span> out_batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> batch_size / <span class="tok-number">8</span>;</span>
<span class="line" id="L1010"></span>
<span class="line" id="L1011">        <span class="tok-kw">const</span> out_length: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> <span class="tok-builtin">@divTrunc</span>(N * d, <span class="tok-number">8</span>);</span>
<span class="line" id="L1012">        <span class="tok-kw">comptime</span> assert(out_length * <span class="tok-number">8</span> == d * N);</span>
<span class="line" id="L1013">        <span class="tok-kw">var</span> out = [_]<span class="tok-type">u8</span>{<span class="tok-number">0</span>} ** out_length;</span>
<span class="line" id="L1014"></span>
<span class="line" id="L1015">        <span class="tok-kw">while</span> (in_off &lt; N) {</span>
<span class="line" id="L1016">            <span class="tok-comment">// First we compress into in.</span>
</span>
<span class="line" id="L1017">            <span class="tok-kw">var</span> in: [in_batch_size]<span class="tok-type">u16</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1018">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..in_batch_size) |i| {</span>
<span class="line" id="L1019">                <span class="tok-comment">// Compress_q(x, d) = ⌈(2ᵈ/q)x⌋ mod⁺ 2ᵈ</span>
</span>
<span class="line" id="L1020">                <span class="tok-comment">//                  = ⌊(2ᵈ/q)x+½⌋ mod⁺ 2ᵈ</span>
</span>
<span class="line" id="L1021">                <span class="tok-comment">//                  = ⌊((x &lt;&lt; d) + q/2) / q⌋ mod⁺ 2ᵈ</span>
</span>
<span class="line" id="L1022">                <span class="tok-comment">//                  = DIV((x &lt;&lt; d) + q/2, q) &amp; ((1&lt;&lt;d) - 1)</span>
</span>
<span class="line" id="L1023">                <span class="tok-kw">const</span> t = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(p.cs[in_off + i])) &lt;&lt; d;</span>
<span class="line" id="L1024">                in[i] = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-builtin">@divFloor</span>(t + q_over_2, Q) &amp; two_d_min_1));</span>
<span class="line" id="L1025">            }</span>
<span class="line" id="L1026"></span>
<span class="line" id="L1027">            <span class="tok-comment">// Now we pack the d-bit integers from `in' into out as bytes.</span>
</span>
<span class="line" id="L1028">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> in_shift: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1029">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1030">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1031">            <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; in_batch_size) : (j += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1032">                <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> todo: <span class="tok-type">usize</span> = <span class="tok-number">8</span>;</span>
<span class="line" id="L1033">                <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (todo &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1034">                    <span class="tok-kw">const</span> out_shift = <span class="tok-kw">comptime</span> <span class="tok-number">8</span> - todo;</span>
<span class="line" id="L1035">                    out[out_off + j] |= <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@truncate</span>((in[i] &gt;&gt; in_shift) &lt;&lt; out_shift));</span>
<span class="line" id="L1036"></span>
<span class="line" id="L1037">                    <span class="tok-kw">const</span> done = <span class="tok-kw">comptime</span> <span class="tok-builtin">@min</span>(<span class="tok-builtin">@min</span>(d, todo), d - in_shift);</span>
<span class="line" id="L1038">                    todo -= done;</span>
<span class="line" id="L1039">                    in_shift += done;</span>
<span class="line" id="L1040"></span>
<span class="line" id="L1041">                    <span class="tok-kw">if</span> (in_shift == d) {</span>
<span class="line" id="L1042">                        in_shift = <span class="tok-number">0</span>;</span>
<span class="line" id="L1043">                        i += <span class="tok-number">1</span>;</span>
<span class="line" id="L1044">                    }</span>
<span class="line" id="L1045">                }</span>
<span class="line" id="L1046">            }</span>
<span class="line" id="L1047"></span>
<span class="line" id="L1048">            in_off += in_batch_size;</span>
<span class="line" id="L1049">            out_off += out_batch_size;</span>
<span class="line" id="L1050">        }</span>
<span class="line" id="L1051"></span>
<span class="line" id="L1052">        <span class="tok-kw">return</span> out;</span>
<span class="line" id="L1053">    }</span>
<span class="line" id="L1054"></span>
<span class="line" id="L1055">    <span class="tok-comment">// Set p to Decompress_q(m, d).</span>
</span>
<span class="line" id="L1056">    <span class="tok-kw">fn</span> <span class="tok-fn">decompress</span>(<span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>, in: *<span class="tok-kw">const</span> [compressedSize(d)]<span class="tok-type">u8</span>) Poly {</span>
<span class="line" id="L1057">        <span class="tok-builtin">@setEvalBranchQuota</span>(<span class="tok-number">10000</span>);</span>
<span class="line" id="L1058">        <span class="tok-kw">const</span> inLen = <span class="tok-kw">comptime</span> <span class="tok-builtin">@divTrunc</span>(N * d, <span class="tok-number">8</span>);</span>
<span class="line" id="L1059">        <span class="tok-kw">comptime</span> assert(inLen * <span class="tok-number">8</span> == d * N);</span>
<span class="line" id="L1060">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1061">        <span class="tok-kw">var</span> in_off: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1062">        <span class="tok-kw">var</span> out_off: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1063"></span>
<span class="line" id="L1064">        <span class="tok-kw">const</span> batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> lcm(<span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, d), <span class="tok-number">8</span>);</span>
<span class="line" id="L1065">        <span class="tok-kw">const</span> in_batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> batch_size / <span class="tok-number">8</span>;</span>
<span class="line" id="L1066">        <span class="tok-kw">const</span> out_batch_size: <span class="tok-type">usize</span> = <span class="tok-kw">comptime</span> batch_size / d;</span>
<span class="line" id="L1067"></span>
<span class="line" id="L1068">        <span class="tok-kw">while</span> (out_off &lt; N) {</span>
<span class="line" id="L1069">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> in_shift: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1070">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1071">            <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1072">            <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (i &lt; out_batch_size) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1073">                <span class="tok-comment">// First, unpack next coefficient.</span>
</span>
<span class="line" id="L1074">                <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> todo = d;</span>
<span class="line" id="L1075">                <span class="tok-kw">var</span> out: <span class="tok-type">u16</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1076"></span>
<span class="line" id="L1077">                <span class="tok-kw">inline</span> <span class="tok-kw">while</span> (todo &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1078">                    <span class="tok-kw">const</span> out_shift = <span class="tok-kw">comptime</span> d - todo;</span>
<span class="line" id="L1079">                    <span class="tok-kw">const</span> m = <span class="tok-kw">comptime</span> (<span class="tok-number">1</span> &lt;&lt; d) - <span class="tok-number">1</span>;</span>
<span class="line" id="L1080">                    out |= (<span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, in[in_off + j] &gt;&gt; in_shift) &lt;&lt; out_shift) &amp; m;</span>
<span class="line" id="L1081"></span>
<span class="line" id="L1082">                    <span class="tok-kw">const</span> done = <span class="tok-kw">comptime</span> <span class="tok-builtin">@min</span>(<span class="tok-builtin">@min</span>(<span class="tok-number">8</span>, todo), <span class="tok-number">8</span> - in_shift);</span>
<span class="line" id="L1083">                    todo -= done;</span>
<span class="line" id="L1084">                    in_shift += done;</span>
<span class="line" id="L1085"></span>
<span class="line" id="L1086">                    <span class="tok-kw">if</span> (in_shift == <span class="tok-number">8</span>) {</span>
<span class="line" id="L1087">                        in_shift = <span class="tok-number">0</span>;</span>
<span class="line" id="L1088">                        j += <span class="tok-number">1</span>;</span>
<span class="line" id="L1089">                    }</span>
<span class="line" id="L1090">                }</span>
<span class="line" id="L1091"></span>
<span class="line" id="L1092">                <span class="tok-comment">// Decompress_q(x, d) = ⌈(q/2ᵈ)x⌋</span>
</span>
<span class="line" id="L1093">                <span class="tok-comment">//                    = ⌊(q/2ᵈ)x+½⌋</span>
</span>
<span class="line" id="L1094">                <span class="tok-comment">//                    = ⌊(qx + 2ᵈ⁻¹)/2ᵈ⌋</span>
</span>
<span class="line" id="L1095">                <span class="tok-comment">//                    = (qx + (1&lt;&lt;(d-1))) &gt;&gt; d</span>
</span>
<span class="line" id="L1096">                <span class="tok-kw">const</span> qx = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, out) * <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, Q);</span>
<span class="line" id="L1097">                ret.cs[out_off + i] = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>((qx + (<span class="tok-number">1</span> &lt;&lt; (d - <span class="tok-number">1</span>))) &gt;&gt; d));</span>
<span class="line" id="L1098">            }</span>
<span class="line" id="L1099"></span>
<span class="line" id="L1100">            in_off += in_batch_size;</span>
<span class="line" id="L1101">            out_off += out_batch_size;</span>
<span class="line" id="L1102">        }</span>
<span class="line" id="L1103"></span>
<span class="line" id="L1104">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1105">    }</span>
<span class="line" id="L1106"></span>
<span class="line" id="L1107">    <span class="tok-comment">// Returns the &quot;pointwise&quot; multiplication a o b.</span>
</span>
<span class="line" id="L1108">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L1109">    <span class="tok-comment">// That is: invNTT(a o b) = invNTT(a) * invNTT(b).  Assumes a and b are in</span>
</span>
<span class="line" id="L1110">    <span class="tok-comment">// Montgomery form.  Products between coefficients of a and b must be strictly</span>
</span>
<span class="line" id="L1111">    <span class="tok-comment">// bounded in absolute value by 2¹⁵q.  a o b will be in Montgomery form and</span>
</span>
<span class="line" id="L1112">    <span class="tok-comment">// bounded in absolute value by 2q.</span>
</span>
<span class="line" id="L1113">    <span class="tok-kw">fn</span> <span class="tok-fn">mulHat</span>(a: Poly, b: Poly) Poly {</span>
<span class="line" id="L1114">        <span class="tok-comment">// Recall from the discussion in ntt(), that a transformed polynomial is</span>
</span>
<span class="line" id="L1115">        <span class="tok-comment">// an element of ℤ_q[x]/(x²-ζ) x … x  ℤ_q[x]/(x²+ζ¹²⁷);</span>
</span>
<span class="line" id="L1116">        <span class="tok-comment">// that is: 128 degree-one polynomials instead of simply 256 elements</span>
</span>
<span class="line" id="L1117">        <span class="tok-comment">// from ℤ_q as in the regular NTT.  So instead of pointwise multiplication,</span>
</span>
<span class="line" id="L1118">        <span class="tok-comment">// we multiply the 128 pairs of degree-one polynomials modulo the</span>
</span>
<span class="line" id="L1119">        <span class="tok-comment">// right equation:</span>
</span>
<span class="line" id="L1120">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L1121">        <span class="tok-comment">//  (a₁ + a₂x)(b₁ + b₂x) = a₁b₁ + a₂b₂ζ' + (a₁b₂ + a₂b₁)x,</span>
</span>
<span class="line" id="L1122">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L1123">        <span class="tok-comment">// where ζ' is the appropriate power of ζ.</span>
</span>
<span class="line" id="L1124"></span>
<span class="line" id="L1125">        <span class="tok-kw">var</span> p: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1126">        <span class="tok-kw">var</span> k: <span class="tok-type">usize</span> = <span class="tok-number">64</span>;</span>
<span class="line" id="L1127">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1128">        <span class="tok-kw">while</span> (i &lt; N) : (i += <span class="tok-number">4</span>) {</span>
<span class="line" id="L1129">            <span class="tok-kw">const</span> z = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, zetas[k]);</span>
<span class="line" id="L1130">            k += <span class="tok-number">1</span>;</span>
<span class="line" id="L1131"></span>
<span class="line" id="L1132">            <span class="tok-kw">const</span> a1b1 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">1</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">1</span>]));</span>
<span class="line" id="L1133">            <span class="tok-kw">const</span> a0b0 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i]));</span>
<span class="line" id="L1134">            <span class="tok-kw">const</span> a1b0 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">1</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i]));</span>
<span class="line" id="L1135">            <span class="tok-kw">const</span> a0b1 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">1</span>]));</span>
<span class="line" id="L1136"></span>
<span class="line" id="L1137">            p.cs[i] = montReduce(a1b1 * z) + a0b0;</span>
<span class="line" id="L1138">            p.cs[i + <span class="tok-number">1</span>] = a0b1 + a1b0;</span>
<span class="line" id="L1139"></span>
<span class="line" id="L1140">            <span class="tok-kw">const</span> a3b3 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">3</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">3</span>]));</span>
<span class="line" id="L1141">            <span class="tok-kw">const</span> a2b2 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">2</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">2</span>]));</span>
<span class="line" id="L1142">            <span class="tok-kw">const</span> a3b2 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">3</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">2</span>]));</span>
<span class="line" id="L1143">            <span class="tok-kw">const</span> a2b3 = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i + <span class="tok-number">2</span>]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[i + <span class="tok-number">3</span>]));</span>
<span class="line" id="L1144"></span>
<span class="line" id="L1145">            p.cs[i + <span class="tok-number">2</span>] = a2b2 - montReduce(a3b3 * z);</span>
<span class="line" id="L1146">            p.cs[i + <span class="tok-number">3</span>] = a2b3 + a3b2;</span>
<span class="line" id="L1147">        }</span>
<span class="line" id="L1148"></span>
<span class="line" id="L1149">        <span class="tok-kw">return</span> p;</span>
<span class="line" id="L1150">    }</span>
<span class="line" id="L1151"></span>
<span class="line" id="L1152">    <span class="tok-comment">// Sample p from a centered binomial distribution with n=2η and p=½ - viz:</span>
</span>
<span class="line" id="L1153">    <span class="tok-comment">// coefficients are in {-η, …, η} with probabilities</span>
</span>
<span class="line" id="L1154">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L1155">    <span class="tok-comment">//  {ncr(0, 2η)/2^2η, ncr(1, 2η)/2^2η, …, ncr(2η,2η)/2^2η}</span>
</span>
<span class="line" id="L1156">    <span class="tok-kw">fn</span> <span class="tok-fn">noise</span>(<span class="tok-kw">comptime</span> eta: <span class="tok-type">u8</span>, nonce: <span class="tok-type">u8</span>, seed: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) Poly {</span>
<span class="line" id="L1157">        <span class="tok-kw">var</span> h = sha3.Shake256.init(.{});</span>
<span class="line" id="L1158">        <span class="tok-kw">const</span> suffix: [<span class="tok-number">1</span>]<span class="tok-type">u8</span> = .{nonce};</span>
<span class="line" id="L1159">        h.update(seed);</span>
<span class="line" id="L1160">        h.update(&amp;suffix);</span>
<span class="line" id="L1161"></span>
<span class="line" id="L1162">        <span class="tok-comment">// The distribution at hand is exactly the same as that</span>
</span>
<span class="line" id="L1163">        <span class="tok-comment">// of (a₁ + a₂ + … + a_η) - (b₁ + … + b_η) where a_i,b_i~U(1).</span>
</span>
<span class="line" id="L1164">        <span class="tok-comment">// Thus we need 2η bits per coefficient.</span>
</span>
<span class="line" id="L1165">        <span class="tok-kw">const</span> buf_len = <span class="tok-kw">comptime</span> <span class="tok-number">2</span> * eta * N / <span class="tok-number">8</span>;</span>
<span class="line" id="L1166">        <span class="tok-kw">var</span> buf: [buf_len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1167">        h.squeeze(&amp;buf);</span>
<span class="line" id="L1168"></span>
<span class="line" id="L1169">        <span class="tok-comment">// buf is interpreted as a₁…a_ηb₁…b_ηa₁…a_ηb₁…b_η…. We process</span>
</span>
<span class="line" id="L1170">        <span class="tok-comment">// multiple coefficients in one batch.</span>
</span>
<span class="line" id="L1171"></span>
<span class="line" id="L1172">        <span class="tok-kw">const</span> T = <span class="tok-kw">switch</span> (builtin.target.cpu.arch) {</span>
<span class="line" id="L1173">            .x86_64, .x86 =&gt; <span class="tok-type">u32</span>, <span class="tok-comment">// Generates better code on Intel CPUs</span>
</span>
<span class="line" id="L1174">            <span class="tok-kw">else</span> =&gt; <span class="tok-type">u64</span>, <span class="tok-comment">// u128 might be faster on some other CPUs.</span>
</span>
<span class="line" id="L1175">        };</span>
<span class="line" id="L1176"></span>
<span class="line" id="L1177">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> batch_count: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1178">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> batch_bytes: <span class="tok-type">usize</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1179">        <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> mask: T = <span class="tok-number">0</span>;</span>
<span class="line" id="L1180">        <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L1181">            batch_count = <span class="tok-builtin">@bitSizeOf</span>(T) / <span class="tok-builtin">@as</span>(<span class="tok-type">usize</span>, <span class="tok-number">2</span> * eta);</span>
<span class="line" id="L1182">            <span class="tok-kw">while</span> (<span class="tok-builtin">@rem</span>(N, batch_count) != <span class="tok-number">0</span> <span class="tok-kw">and</span> batch_count &gt; <span class="tok-number">0</span>) : (batch_count -= <span class="tok-number">1</span>) {}</span>
<span class="line" id="L1183">            assert(batch_count &gt; <span class="tok-number">0</span>);</span>
<span class="line" id="L1184">            assert(<span class="tok-builtin">@rem</span>(<span class="tok-number">2</span> * eta * batch_count, <span class="tok-number">8</span>) == <span class="tok-number">0</span>);</span>
<span class="line" id="L1185">            batch_bytes = <span class="tok-number">2</span> * eta * batch_count / <span class="tok-number">8</span>;</span>
<span class="line" id="L1186"></span>
<span class="line" id="L1187">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">2</span> * eta * batch_count) |_| {</span>
<span class="line" id="L1188">                mask &lt;&lt;= eta;</span>
<span class="line" id="L1189">                mask |= <span class="tok-number">1</span>;</span>
<span class="line" id="L1190">            }</span>
<span class="line" id="L1191">        }</span>
<span class="line" id="L1192"></span>
<span class="line" id="L1193">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1194">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-kw">comptime</span> N / batch_count) |i| {</span>
<span class="line" id="L1195">            <span class="tok-comment">// Read coefficients into t. In the case of η=3,</span>
</span>
<span class="line" id="L1196">            <span class="tok-comment">// we have t = a₁ + 2a₂ + 4a₃ + 8b₁ + 16b₂ + …</span>
</span>
<span class="line" id="L1197">            <span class="tok-kw">var</span> t: T = <span class="tok-number">0</span>;</span>
<span class="line" id="L1198">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..batch_bytes) |j| {</span>
<span class="line" id="L1199">                t |= <span class="tok-builtin">@as</span>(T, buf[batch_bytes * i + j]) &lt;&lt; (<span class="tok-number">8</span> * j);</span>
<span class="line" id="L1200">            }</span>
<span class="line" id="L1201"></span>
<span class="line" id="L1202">            <span class="tok-comment">// Accumelate `a's and `b's together by masking them out, shifting</span>
</span>
<span class="line" id="L1203">            <span class="tok-comment">// and adding. For η=3, we have  d = a₁ + a₂ + a₃ + 8(b₁ + b₂ + b₃) + …</span>
</span>
<span class="line" id="L1204">            <span class="tok-kw">var</span> d: T = <span class="tok-number">0</span>;</span>
<span class="line" id="L1205">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..eta) |j| {</span>
<span class="line" id="L1206">                d += (t &gt;&gt; j) &amp; mask;</span>
<span class="line" id="L1207">            }</span>
<span class="line" id="L1208"></span>
<span class="line" id="L1209">            <span class="tok-comment">// Extract each a and b separately and set coefficient in polynomial.</span>
</span>
<span class="line" id="L1210">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..batch_count) |j| {</span>
<span class="line" id="L1211">                <span class="tok-kw">const</span> mask2 = <span class="tok-kw">comptime</span> (<span class="tok-number">1</span> &lt;&lt; eta) - <span class="tok-number">1</span>;</span>
<span class="line" id="L1212">                <span class="tok-kw">const</span> a = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>((d &gt;&gt; (<span class="tok-kw">comptime</span> (<span class="tok-number">2</span> * j * eta))) &amp; mask2));</span>
<span class="line" id="L1213">                <span class="tok-kw">const</span> b = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>((d &gt;&gt; (<span class="tok-kw">comptime</span> ((<span class="tok-number">2</span> * j + <span class="tok-number">1</span>) * eta))) &amp; mask2));</span>
<span class="line" id="L1214">                ret.cs[batch_count * i + j] = a - b;</span>
<span class="line" id="L1215">            }</span>
<span class="line" id="L1216">        }</span>
<span class="line" id="L1217"></span>
<span class="line" id="L1218">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1219">    }</span>
<span class="line" id="L1220"></span>
<span class="line" id="L1221">    <span class="tok-comment">// Sample p uniformly from the given seed and x and y coordinates.</span>
</span>
<span class="line" id="L1222">    <span class="tok-kw">fn</span> <span class="tok-fn">uniform</span>(seed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, x: <span class="tok-type">u8</span>, y: <span class="tok-type">u8</span>) Poly {</span>
<span class="line" id="L1223">        <span class="tok-kw">var</span> h = sha3.Shake128.init(.{});</span>
<span class="line" id="L1224">        <span class="tok-kw">const</span> suffix: [<span class="tok-number">2</span>]<span class="tok-type">u8</span> = .{ x, y };</span>
<span class="line" id="L1225">        h.update(&amp;seed);</span>
<span class="line" id="L1226">        h.update(&amp;suffix);</span>
<span class="line" id="L1227"></span>
<span class="line" id="L1228">        <span class="tok-kw">const</span> buf_len = sha3.Shake128.block_length; <span class="tok-comment">// rate SHAKE-128</span>
</span>
<span class="line" id="L1229">        <span class="tok-kw">var</span> buf: [buf_len]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1230"></span>
<span class="line" id="L1231">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1232">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>; <span class="tok-comment">// index into ret.cs</span>
</span>
<span class="line" id="L1233">        outer: <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L1234">            h.squeeze(&amp;buf);</span>
<span class="line" id="L1235"></span>
<span class="line" id="L1236">            <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-number">0</span>; <span class="tok-comment">// index into buf</span>
</span>
<span class="line" id="L1237">            <span class="tok-kw">while</span> (j &lt; buf_len) : (j += <span class="tok-number">3</span>) {</span>
<span class="line" id="L1238">                <span class="tok-kw">const</span> b0 = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, buf[j]);</span>
<span class="line" id="L1239">                <span class="tok-kw">const</span> b1 = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, buf[j + <span class="tok-number">1</span>]);</span>
<span class="line" id="L1240">                <span class="tok-kw">const</span> b2 = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, buf[j + <span class="tok-number">2</span>]);</span>
<span class="line" id="L1241"></span>
<span class="line" id="L1242">                <span class="tok-kw">const</span> ts: [<span class="tok-number">2</span>]<span class="tok-type">u16</span> = .{</span>
<span class="line" id="L1243">                    b0 | ((b1 &amp; <span class="tok-number">0xf</span>) &lt;&lt; <span class="tok-number">8</span>),</span>
<span class="line" id="L1244">                    (b1 &gt;&gt; <span class="tok-number">4</span>) | (b2 &lt;&lt; <span class="tok-number">4</span>),</span>
<span class="line" id="L1245">                };</span>
<span class="line" id="L1246"></span>
<span class="line" id="L1247">                <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (ts) |t| {</span>
<span class="line" id="L1248">                    <span class="tok-kw">if</span> (t &lt; Q) {</span>
<span class="line" id="L1249">                        ret.cs[i] = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, <span class="tok-builtin">@intCast</span>(t));</span>
<span class="line" id="L1250">                        i += <span class="tok-number">1</span>;</span>
<span class="line" id="L1251"></span>
<span class="line" id="L1252">                        <span class="tok-kw">if</span> (i == N) {</span>
<span class="line" id="L1253">                            <span class="tok-kw">break</span> :outer;</span>
<span class="line" id="L1254">                        }</span>
<span class="line" id="L1255">                    }</span>
<span class="line" id="L1256">                }</span>
<span class="line" id="L1257">            }</span>
<span class="line" id="L1258">        }</span>
<span class="line" id="L1259"></span>
<span class="line" id="L1260">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1261">    }</span>
<span class="line" id="L1262"></span>
<span class="line" id="L1263">    <span class="tok-comment">// Packs p.</span>
</span>
<span class="line" id="L1264">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L1265">    <span class="tok-comment">// Assumes p is normalized (and not just Barrett reduced).</span>
</span>
<span class="line" id="L1266">    <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(p: Poly) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1267">        <span class="tok-kw">var</span> ret: [bytes_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1268">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-kw">comptime</span> N / <span class="tok-number">2</span>) |i| {</span>
<span class="line" id="L1269">            <span class="tok-kw">const</span> t0 = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(p.cs[<span class="tok-number">2</span> * i]));</span>
<span class="line" id="L1270">            <span class="tok-kw">const</span> t1 = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(p.cs[<span class="tok-number">2</span> * i + <span class="tok-number">1</span>]));</span>
<span class="line" id="L1271">            ret[<span class="tok-number">3</span> * i] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@truncate</span>(t0));</span>
<span class="line" id="L1272">            ret[<span class="tok-number">3</span> * i + <span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@truncate</span>((t0 &gt;&gt; <span class="tok-number">8</span>) | (t1 &lt;&lt; <span class="tok-number">4</span>)));</span>
<span class="line" id="L1273">            ret[<span class="tok-number">3</span> * i + <span class="tok-number">2</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@truncate</span>(t1 &gt;&gt; <span class="tok-number">4</span>));</span>
<span class="line" id="L1274">        }</span>
<span class="line" id="L1275">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1276">    }</span>
<span class="line" id="L1277"></span>
<span class="line" id="L1278">    <span class="tok-comment">// Unpacks a Poly from buf.</span>
</span>
<span class="line" id="L1279">    <span class="tok-comment">//</span>
</span>
<span class="line" id="L1280">    <span class="tok-comment">// p will not be normalized; instead 0 ≤ p[i] &lt; 4096.</span>
</span>
<span class="line" id="L1281">    <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) Poly {</span>
<span class="line" id="L1282">        <span class="tok-kw">var</span> ret: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1283">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-kw">comptime</span> N / <span class="tok-number">2</span>) |i| {</span>
<span class="line" id="L1284">            <span class="tok-kw">const</span> b0 = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, buf[<span class="tok-number">3</span> * i]);</span>
<span class="line" id="L1285">            <span class="tok-kw">const</span> b1 = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, buf[<span class="tok-number">3</span> * i + <span class="tok-number">1</span>]);</span>
<span class="line" id="L1286">            <span class="tok-kw">const</span> b2 = <span class="tok-builtin">@as</span>(<span class="tok-type">i16</span>, buf[<span class="tok-number">3</span> * i + <span class="tok-number">2</span>]);</span>
<span class="line" id="L1287">            ret.cs[<span class="tok-number">2</span> * i] = b0 | ((b1 &amp; <span class="tok-number">0xf</span>) &lt;&lt; <span class="tok-number">8</span>);</span>
<span class="line" id="L1288">            ret.cs[<span class="tok-number">2</span> * i + <span class="tok-number">1</span>] = (b1 &gt;&gt; <span class="tok-number">4</span>) | b2 &lt;&lt; <span class="tok-number">4</span>;</span>
<span class="line" id="L1289">        }</span>
<span class="line" id="L1290">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1291">    }</span>
<span class="line" id="L1292">};</span>
<span class="line" id="L1293"></span>
<span class="line" id="L1294"><span class="tok-comment">// A vector of K polynomials.</span>
</span>
<span class="line" id="L1295"><span class="tok-kw">fn</span> <span class="tok-fn">Vec</span>(<span class="tok-kw">comptime</span> K: <span class="tok-type">u8</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L1296">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1297">        ps: [K]Poly,</span>
<span class="line" id="L1298"></span>
<span class="line" id="L1299">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L1300">        <span class="tok-kw">const</span> bytes_length = K * Poly.bytes_length;</span>
<span class="line" id="L1301"></span>
<span class="line" id="L1302">        <span class="tok-kw">fn</span> <span class="tok-fn">compressedSize</span>(<span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>) <span class="tok-type">usize</span> {</span>
<span class="line" id="L1303">            <span class="tok-kw">return</span> Poly.compressedSize(d) * K;</span>
<span class="line" id="L1304">        }</span>
<span class="line" id="L1305"></span>
<span class="line" id="L1306">        <span class="tok-kw">fn</span> <span class="tok-fn">ntt</span>(a: Self) Self {</span>
<span class="line" id="L1307">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1308">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1309">                ret.ps[i] = a.ps[i].ntt();</span>
<span class="line" id="L1310">            }</span>
<span class="line" id="L1311">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1312">        }</span>
<span class="line" id="L1313"></span>
<span class="line" id="L1314">        <span class="tok-kw">fn</span> <span class="tok-fn">invNTT</span>(a: Self) Self {</span>
<span class="line" id="L1315">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1316">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1317">                ret.ps[i] = a.ps[i].invNTT();</span>
<span class="line" id="L1318">            }</span>
<span class="line" id="L1319">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1320">        }</span>
<span class="line" id="L1321"></span>
<span class="line" id="L1322">        <span class="tok-kw">fn</span> <span class="tok-fn">normalize</span>(a: Self) Self {</span>
<span class="line" id="L1323">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1324">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1325">                ret.ps[i] = a.ps[i].normalize();</span>
<span class="line" id="L1326">            }</span>
<span class="line" id="L1327">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1328">        }</span>
<span class="line" id="L1329"></span>
<span class="line" id="L1330">        <span class="tok-kw">fn</span> <span class="tok-fn">barrettReduce</span>(a: Self) Self {</span>
<span class="line" id="L1331">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1332">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1333">                ret.ps[i] = a.ps[i].barrettReduce();</span>
<span class="line" id="L1334">            }</span>
<span class="line" id="L1335">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1336">        }</span>
<span class="line" id="L1337"></span>
<span class="line" id="L1338">        <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(a: Self, b: Self) Self {</span>
<span class="line" id="L1339">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1340">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1341">                ret.ps[i] = a.ps[i].add(b.ps[i]);</span>
<span class="line" id="L1342">            }</span>
<span class="line" id="L1343">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1344">        }</span>
<span class="line" id="L1345"></span>
<span class="line" id="L1346">        <span class="tok-kw">fn</span> <span class="tok-fn">sub</span>(a: Self, b: Self) Self {</span>
<span class="line" id="L1347">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1348">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1349">                ret.ps[i] = a.ps[i].sub(b.ps[i]);</span>
<span class="line" id="L1350">            }</span>
<span class="line" id="L1351">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1352">        }</span>
<span class="line" id="L1353"></span>
<span class="line" id="L1354">        <span class="tok-comment">// Samples v[i] from centered binomial distribution with the given η,</span>
</span>
<span class="line" id="L1355">        <span class="tok-comment">// seed and nonce+i.</span>
</span>
<span class="line" id="L1356">        <span class="tok-kw">fn</span> <span class="tok-fn">noise</span>(<span class="tok-kw">comptime</span> eta: <span class="tok-type">u8</span>, nonce: <span class="tok-type">u8</span>, seed: *<span class="tok-kw">const</span> [<span class="tok-number">32</span>]<span class="tok-type">u8</span>) Self {</span>
<span class="line" id="L1357">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1358">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1359">                ret.ps[i] = Poly.noise(eta, nonce + <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i)), seed);</span>
<span class="line" id="L1360">            }</span>
<span class="line" id="L1361">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1362">        }</span>
<span class="line" id="L1363"></span>
<span class="line" id="L1364">        <span class="tok-comment">// Sets p to the inner product of a and b using &quot;pointwise&quot; multiplication.</span>
</span>
<span class="line" id="L1365">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L1366">        <span class="tok-comment">// See MulHat() and NTT() for a description of the multiplication.</span>
</span>
<span class="line" id="L1367">        <span class="tok-comment">// Assumes a and b are in Montgomery form.  p will be in Montgomery form,</span>
</span>
<span class="line" id="L1368">        <span class="tok-comment">// and its coefficients will be bounded in absolute value by 2kq.</span>
</span>
<span class="line" id="L1369">        <span class="tok-comment">// If a and b are not in Montgomery form, then the action is the same</span>
</span>
<span class="line" id="L1370">        <span class="tok-comment">// as &quot;pointwise&quot; multiplication followed by multiplying by R⁻¹, the inverse</span>
</span>
<span class="line" id="L1371">        <span class="tok-comment">// of the Montgomery factor.</span>
</span>
<span class="line" id="L1372">        <span class="tok-kw">fn</span> <span class="tok-fn">dotHat</span>(a: Self, b: Self) Poly {</span>
<span class="line" id="L1373">            <span class="tok-kw">var</span> ret: Poly = Poly.zero;</span>
<span class="line" id="L1374">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1375">                ret = ret.add(a.ps[i].mulHat(b.ps[i]));</span>
<span class="line" id="L1376">            }</span>
<span class="line" id="L1377">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1378">        }</span>
<span class="line" id="L1379"></span>
<span class="line" id="L1380">        <span class="tok-kw">fn</span> <span class="tok-fn">compress</span>(v: Self, <span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>) [compressedSize(d)]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1381">            <span class="tok-kw">const</span> cs = <span class="tok-kw">comptime</span> Poly.compressedSize(d);</span>
<span class="line" id="L1382">            <span class="tok-kw">var</span> ret: [compressedSize(d)]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1383">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1384">                ret[i * cs .. (i + <span class="tok-number">1</span>) * cs].* = v.ps[i].compress(d);</span>
<span class="line" id="L1385">            }</span>
<span class="line" id="L1386">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1387">        }</span>
<span class="line" id="L1388"></span>
<span class="line" id="L1389">        <span class="tok-kw">fn</span> <span class="tok-fn">decompress</span>(<span class="tok-kw">comptime</span> d: <span class="tok-type">u8</span>, buf: *<span class="tok-kw">const</span> [compressedSize(d)]<span class="tok-type">u8</span>) Self {</span>
<span class="line" id="L1390">            <span class="tok-kw">const</span> cs = <span class="tok-kw">comptime</span> Poly.compressedSize(d);</span>
<span class="line" id="L1391">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1392">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1393">                ret.ps[i] = Poly.decompress(d, buf[i * cs .. (i + <span class="tok-number">1</span>) * cs]);</span>
<span class="line" id="L1394">            }</span>
<span class="line" id="L1395">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1396">        }</span>
<span class="line" id="L1397"></span>
<span class="line" id="L1398">        <span class="tok-comment">/// Serializes the key into a byte array.</span></span>
<span class="line" id="L1399">        <span class="tok-kw">fn</span> <span class="tok-fn">toBytes</span>(v: Self) [bytes_length]<span class="tok-type">u8</span> {</span>
<span class="line" id="L1400">            <span class="tok-kw">var</span> ret: [bytes_length]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1401">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1402">                ret[i * Poly.bytes_length .. (i + <span class="tok-number">1</span>) * Poly.bytes_length].* = v.ps[i].toBytes();</span>
<span class="line" id="L1403">            }</span>
<span class="line" id="L1404">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1405">        }</span>
<span class="line" id="L1406"></span>
<span class="line" id="L1407">        <span class="tok-comment">/// Deserializes the key from a byte array.</span></span>
<span class="line" id="L1408">        <span class="tok-kw">fn</span> <span class="tok-fn">fromBytes</span>(buf: *<span class="tok-kw">const</span> [bytes_length]<span class="tok-type">u8</span>) Self {</span>
<span class="line" id="L1409">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1410">            <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1411">                ret.ps[i] = Poly.fromBytes(</span>
<span class="line" id="L1412">                    buf[i * Poly.bytes_length .. (i + <span class="tok-number">1</span>) * Poly.bytes_length],</span>
<span class="line" id="L1413">                );</span>
<span class="line" id="L1414">            }</span>
<span class="line" id="L1415">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1416">        }</span>
<span class="line" id="L1417">    };</span>
<span class="line" id="L1418">}</span>
<span class="line" id="L1419"></span>
<span class="line" id="L1420"><span class="tok-comment">// A matrix of K vectors</span>
</span>
<span class="line" id="L1421"><span class="tok-kw">fn</span> <span class="tok-fn">Mat</span>(<span class="tok-kw">comptime</span> K: <span class="tok-type">u8</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L1422">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1423">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L1424">        vs: [K]Vec(K),</span>
<span class="line" id="L1425"></span>
<span class="line" id="L1426">        <span class="tok-kw">fn</span> <span class="tok-fn">uniform</span>(seed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>, <span class="tok-kw">comptime</span> transposed: <span class="tok-type">bool</span>) Self {</span>
<span class="line" id="L1427">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1428">            <span class="tok-kw">var</span> i: <span class="tok-type">u8</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1429">            <span class="tok-kw">while</span> (i &lt; K) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1430">                <span class="tok-kw">var</span> j: <span class="tok-type">u8</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1431">                <span class="tok-kw">while</span> (j &lt; K) : (j += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1432">                    ret.vs[i].ps[j] = Poly.uniform(</span>
<span class="line" id="L1433">                        seed,</span>
<span class="line" id="L1434">                        <span class="tok-kw">if</span> (transposed) i <span class="tok-kw">else</span> j,</span>
<span class="line" id="L1435">                        <span class="tok-kw">if</span> (transposed) j <span class="tok-kw">else</span> i,</span>
<span class="line" id="L1436">                    );</span>
<span class="line" id="L1437">                }</span>
<span class="line" id="L1438">            }</span>
<span class="line" id="L1439">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1440">        }</span>
<span class="line" id="L1441"></span>
<span class="line" id="L1442">        <span class="tok-comment">// Returns transpose of A</span>
</span>
<span class="line" id="L1443">        <span class="tok-kw">fn</span> <span class="tok-fn">transpose</span>(m: Self) Self {</span>
<span class="line" id="L1444">            <span class="tok-kw">var</span> ret: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1445">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |i| {</span>
<span class="line" id="L1446">                <span class="tok-kw">for</span> (<span class="tok-number">0</span>..K) |j| {</span>
<span class="line" id="L1447">                    ret.vs[i].ps[j] = m.vs[j].ps[i];</span>
<span class="line" id="L1448">                }</span>
<span class="line" id="L1449">            }</span>
<span class="line" id="L1450">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1451">        }</span>
<span class="line" id="L1452">    };</span>
<span class="line" id="L1453">}</span>
<span class="line" id="L1454"></span>
<span class="line" id="L1455"><span class="tok-comment">// Returns `true` if a ≠ b.</span>
</span>
<span class="line" id="L1456"><span class="tok-kw">fn</span> <span class="tok-fn">ctneq</span>(<span class="tok-kw">comptime</span> len: <span class="tok-type">usize</span>, a: [len]<span class="tok-type">u8</span>, b: [len]<span class="tok-type">u8</span>) <span class="tok-type">u1</span> {</span>
<span class="line" id="L1457">    <span class="tok-kw">return</span> <span class="tok-number">1</span> - <span class="tok-builtin">@intFromBool</span>(crypto.utils.timingSafeEql([len]<span class="tok-type">u8</span>, a, b));</span>
<span class="line" id="L1458">}</span>
<span class="line" id="L1459"></span>
<span class="line" id="L1460"><span class="tok-comment">// Copy src into dst given b = 1.</span>
</span>
<span class="line" id="L1461"><span class="tok-kw">fn</span> <span class="tok-fn">cmov</span>(<span class="tok-kw">comptime</span> len: <span class="tok-type">usize</span>, dst: *[len]<span class="tok-type">u8</span>, src: [len]<span class="tok-type">u8</span>, b: <span class="tok-type">u1</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1462">    <span class="tok-kw">const</span> mask = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-number">0</span>) -% b;</span>
<span class="line" id="L1463">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..len) |i| {</span>
<span class="line" id="L1464">        dst[i] ^= mask &amp; (dst[i] ^ src[i]);</span>
<span class="line" id="L1465">    }</span>
<span class="line" id="L1466">}</span>
<span class="line" id="L1467"></span>
<span class="line" id="L1468"><span class="tok-kw">test</span> <span class="tok-str">&quot;MulHat&quot;</span> {</span>
<span class="line" id="L1469">    <span class="tok-kw">var</span> rnd = RndGen.init(<span class="tok-number">0</span>);</span>
<span class="line" id="L1470"></span>
<span class="line" id="L1471">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">100</span>) |_| {</span>
<span class="line" id="L1472">        <span class="tok-kw">const</span> a = Poly.randAbsLeqQ(&amp;rnd);</span>
<span class="line" id="L1473">        <span class="tok-kw">const</span> b = Poly.randAbsLeqQ(&amp;rnd);</span>
<span class="line" id="L1474"></span>
<span class="line" id="L1475">        <span class="tok-kw">const</span> p2 = a.ntt().mulHat(b.ntt()).barrettReduce().invNTT().normalize();</span>
<span class="line" id="L1476">        <span class="tok-kw">var</span> p: Poly = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1477"></span>
<span class="line" id="L1478">        <span class="tok-builtin">@memset</span>(&amp;p.cs, <span class="tok-number">0</span>);</span>
<span class="line" id="L1479"></span>
<span class="line" id="L1480">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L1481">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |j| {</span>
<span class="line" id="L1482">                <span class="tok-kw">var</span> v = montReduce(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, a.cs[i]) * <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, b.cs[j]));</span>
<span class="line" id="L1483">                <span class="tok-kw">var</span> k = i + j;</span>
<span class="line" id="L1484">                <span class="tok-kw">if</span> (k &gt;= N) {</span>
<span class="line" id="L1485">                    <span class="tok-comment">// Recall Xᴺ = -1.</span>
</span>
<span class="line" id="L1486">                    k -= N;</span>
<span class="line" id="L1487">                    v = -v;</span>
<span class="line" id="L1488">                }</span>
<span class="line" id="L1489">                p.cs[k] = feBarrettReduce(v + p.cs[k]);</span>
<span class="line" id="L1490">            }</span>
<span class="line" id="L1491">        }</span>
<span class="line" id="L1492"></span>
<span class="line" id="L1493">        p = p.toMont().normalize();</span>
<span class="line" id="L1494"></span>
<span class="line" id="L1495">        <span class="tok-kw">try</span> testing.expectEqual(p, p2);</span>
<span class="line" id="L1496">    }</span>
<span class="line" id="L1497">}</span>
<span class="line" id="L1498"></span>
<span class="line" id="L1499"><span class="tok-kw">test</span> <span class="tok-str">&quot;NTT&quot;</span> {</span>
<span class="line" id="L1500">    <span class="tok-kw">var</span> rnd = RndGen.init(<span class="tok-number">0</span>);</span>
<span class="line" id="L1501"></span>
<span class="line" id="L1502">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">1000</span>) |_| {</span>
<span class="line" id="L1503">        <span class="tok-kw">var</span> p = Poly.randAbsLeqQ(&amp;rnd);</span>
<span class="line" id="L1504">        <span class="tok-kw">const</span> q = p.toMont().normalize();</span>
<span class="line" id="L1505">        p = p.ntt();</span>
<span class="line" id="L1506"></span>
<span class="line" id="L1507">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L1508">            <span class="tok-kw">try</span> testing.expect(p.cs[i] &lt;= <span class="tok-number">7</span> * Q <span class="tok-kw">and</span> -<span class="tok-number">7</span> * Q &lt;= p.cs[i]);</span>
<span class="line" id="L1509">        }</span>
<span class="line" id="L1510"></span>
<span class="line" id="L1511">        p = p.normalize().invNTT();</span>
<span class="line" id="L1512">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..N) |i| {</span>
<span class="line" id="L1513">            <span class="tok-kw">try</span> testing.expect(p.cs[i] &lt;= Q <span class="tok-kw">and</span> -Q &lt;= p.cs[i]);</span>
<span class="line" id="L1514">        }</span>
<span class="line" id="L1515"></span>
<span class="line" id="L1516">        p = p.normalize();</span>
<span class="line" id="L1517"></span>
<span class="line" id="L1518">        <span class="tok-kw">try</span> testing.expectEqual(p, q);</span>
<span class="line" id="L1519">    }</span>
<span class="line" id="L1520">}</span>
<span class="line" id="L1521"></span>
<span class="line" id="L1522"><span class="tok-kw">test</span> <span class="tok-str">&quot;Compression&quot;</span> {</span>
<span class="line" id="L1523">    <span class="tok-kw">var</span> rnd = RndGen.init(<span class="tok-number">0</span>);</span>
<span class="line" id="L1524">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (.{ <span class="tok-number">1</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span>, <span class="tok-number">10</span>, <span class="tok-number">11</span> }) |d| {</span>
<span class="line" id="L1525">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">1000</span>) |_| {</span>
<span class="line" id="L1526">            <span class="tok-kw">const</span> p = Poly.randNormalized(&amp;rnd);</span>
<span class="line" id="L1527">            <span class="tok-kw">const</span> pp = p.compress(d);</span>
<span class="line" id="L1528">            <span class="tok-kw">const</span> pq = Poly.decompress(d, &amp;pp).compress(d);</span>
<span class="line" id="L1529">            <span class="tok-kw">try</span> testing.expectEqual(pp, pq);</span>
<span class="line" id="L1530">        }</span>
<span class="line" id="L1531">    }</span>
<span class="line" id="L1532">}</span>
<span class="line" id="L1533"></span>
<span class="line" id="L1534"><span class="tok-kw">test</span> <span class="tok-str">&quot;noise&quot;</span> {</span>
<span class="line" id="L1535">    <span class="tok-kw">var</span> seed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1536">    <span class="tok-kw">for</span> (&amp;seed, <span class="tok-number">0</span>..) |*s, i| {</span>
<span class="line" id="L1537">        s.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1538">    }</span>
<span class="line" id="L1539">    <span class="tok-kw">try</span> testing.expectEqual(Poly.noise(<span class="tok-number">3</span>, <span class="tok-number">37</span>, &amp;seed).cs, .{</span>
<span class="line" id="L1540">        <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">3</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>,</span>
<span class="line" id="L1541">        <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">3</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">3</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1542">        <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  -<span class="tok-number">1</span>,</span>
<span class="line" id="L1543">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">3</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1544">        <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1545">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>,</span>
<span class="line" id="L1546">        -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1547">        <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">3</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1548">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>,</span>
<span class="line" id="L1549">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">3</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>,</span>
<span class="line" id="L1550">        <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">3</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1551">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, <span class="tok-number">2</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1552">        -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1553">        <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,</span>
<span class="line" id="L1554">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1555">        <span class="tok-number">1</span>,</span>
<span class="line" id="L1556">    });</span>
<span class="line" id="L1557">    <span class="tok-kw">try</span> testing.expectEqual(Poly.noise(<span class="tok-number">2</span>, <span class="tok-number">37</span>, &amp;seed).cs, .{</span>
<span class="line" id="L1558">        <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>,</span>
<span class="line" id="L1559">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,</span>
<span class="line" id="L1560">        <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>,</span>
<span class="line" id="L1561">        <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1562">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1563">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  -<span class="tok-number">1</span>,</span>
<span class="line" id="L1564">        -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1565">        <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1566">        <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1567">        <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1568">        <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">2</span>,</span>
<span class="line" id="L1569">        -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">2</span>, -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,</span>
<span class="line" id="L1570">        <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1571">        -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">2</span>, <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1572">        <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1573">        -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  -<span class="tok-number">2</span>, -<span class="tok-number">2</span>, <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1574">        -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  -<span class="tok-number">1</span>, <span class="tok-number">1</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,</span>
<span class="line" id="L1575">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, -<span class="tok-number">1</span>, <span class="tok-number">2</span>,  <span class="tok-number">0</span>,  <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>,</span>
<span class="line" id="L1576">        <span class="tok-number">0</span>,  <span class="tok-number">1</span>,  -<span class="tok-number">1</span>, <span class="tok-number">0</span>,</span>
<span class="line" id="L1577">    });</span>
<span class="line" id="L1578">}</span>
<span class="line" id="L1579"></span>
<span class="line" id="L1580"><span class="tok-kw">test</span> <span class="tok-str">&quot;uniform sampling&quot;</span> {</span>
<span class="line" id="L1581">    <span class="tok-kw">var</span> seed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1582">    <span class="tok-kw">for</span> (&amp;seed, <span class="tok-number">0</span>..) |*s, i| {</span>
<span class="line" id="L1583">        s.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1584">    }</span>
<span class="line" id="L1585">    <span class="tok-kw">try</span> testing.expectEqual(Poly.uniform(seed, <span class="tok-number">1</span>, <span class="tok-number">0</span>).cs, .{</span>
<span class="line" id="L1586">        <span class="tok-number">797</span>,  <span class="tok-number">993</span>,  <span class="tok-number">161</span>,  <span class="tok-number">6</span>,    <span class="tok-number">2608</span>, <span class="tok-number">2385</span>, <span class="tok-number">2096</span>, <span class="tok-number">2661</span>, <span class="tok-number">1676</span>, <span class="tok-number">247</span>,  <span class="tok-number">2440</span>,</span>
<span class="line" id="L1587">        <span class="tok-number">342</span>,  <span class="tok-number">634</span>,  <span class="tok-number">194</span>,  <span class="tok-number">1570</span>, <span class="tok-number">2848</span>, <span class="tok-number">986</span>,  <span class="tok-number">684</span>,  <span class="tok-number">3148</span>, <span class="tok-number">3208</span>, <span class="tok-number">2018</span>, <span class="tok-number">351</span>,</span>
<span class="line" id="L1588">        <span class="tok-number">2288</span>, <span class="tok-number">612</span>,  <span class="tok-number">1394</span>, <span class="tok-number">170</span>,  <span class="tok-number">1521</span>, <span class="tok-number">3119</span>, <span class="tok-number">58</span>,   <span class="tok-number">596</span>,  <span class="tok-number">2093</span>, <span class="tok-number">1549</span>, <span class="tok-number">409</span>,</span>
<span class="line" id="L1589">        <span class="tok-number">2156</span>, <span class="tok-number">1934</span>, <span class="tok-number">1730</span>, <span class="tok-number">1324</span>, <span class="tok-number">388</span>,  <span class="tok-number">446</span>,  <span class="tok-number">418</span>,  <span class="tok-number">1719</span>, <span class="tok-number">2202</span>, <span class="tok-number">1812</span>, <span class="tok-number">98</span>,</span>
<span class="line" id="L1590">        <span class="tok-number">1019</span>, <span class="tok-number">2369</span>, <span class="tok-number">214</span>,  <span class="tok-number">2699</span>, <span class="tok-number">28</span>,   <span class="tok-number">1523</span>, <span class="tok-number">2824</span>, <span class="tok-number">273</span>,  <span class="tok-number">402</span>,  <span class="tok-number">2899</span>, <span class="tok-number">246</span>,</span>
<span class="line" id="L1591">        <span class="tok-number">210</span>,  <span class="tok-number">1288</span>, <span class="tok-number">863</span>,  <span class="tok-number">2708</span>, <span class="tok-number">177</span>,  <span class="tok-number">3076</span>, <span class="tok-number">349</span>,  <span class="tok-number">44</span>,   <span class="tok-number">949</span>,  <span class="tok-number">854</span>,  <span class="tok-number">1371</span>,</span>
<span class="line" id="L1592">        <span class="tok-number">957</span>,  <span class="tok-number">292</span>,  <span class="tok-number">2502</span>, <span class="tok-number">1617</span>, <span class="tok-number">1501</span>, <span class="tok-number">254</span>,  <span class="tok-number">7</span>,    <span class="tok-number">1761</span>, <span class="tok-number">2581</span>, <span class="tok-number">2206</span>, <span class="tok-number">2655</span>,</span>
<span class="line" id="L1593">        <span class="tok-number">1211</span>, <span class="tok-number">629</span>,  <span class="tok-number">1274</span>, <span class="tok-number">2358</span>, <span class="tok-number">816</span>,  <span class="tok-number">2766</span>, <span class="tok-number">2115</span>, <span class="tok-number">2985</span>, <span class="tok-number">1006</span>, <span class="tok-number">2433</span>, <span class="tok-number">856</span>,</span>
<span class="line" id="L1594">        <span class="tok-number">2596</span>, <span class="tok-number">3192</span>, <span class="tok-number">1</span>,    <span class="tok-number">1378</span>, <span class="tok-number">2345</span>, <span class="tok-number">707</span>,  <span class="tok-number">1891</span>, <span class="tok-number">1669</span>, <span class="tok-number">536</span>,  <span class="tok-number">1221</span>, <span class="tok-number">710</span>,</span>
<span class="line" id="L1595">        <span class="tok-number">2511</span>, <span class="tok-number">120</span>,  <span class="tok-number">1176</span>, <span class="tok-number">322</span>,  <span class="tok-number">1897</span>, <span class="tok-number">2309</span>, <span class="tok-number">595</span>,  <span class="tok-number">2950</span>, <span class="tok-number">1171</span>, <span class="tok-number">801</span>,  <span class="tok-number">1848</span>,</span>
<span class="line" id="L1596">        <span class="tok-number">695</span>,  <span class="tok-number">2912</span>, <span class="tok-number">1396</span>, <span class="tok-number">1931</span>, <span class="tok-number">1775</span>, <span class="tok-number">2904</span>, <span class="tok-number">893</span>,  <span class="tok-number">2507</span>, <span class="tok-number">1810</span>, <span class="tok-number">2873</span>, <span class="tok-number">253</span>,</span>
<span class="line" id="L1597">        <span class="tok-number">1529</span>, <span class="tok-number">1047</span>, <span class="tok-number">2615</span>, <span class="tok-number">1687</span>, <span class="tok-number">831</span>,  <span class="tok-number">1414</span>, <span class="tok-number">965</span>,  <span class="tok-number">3169</span>, <span class="tok-number">1887</span>, <span class="tok-number">753</span>,  <span class="tok-number">3246</span>,</span>
<span class="line" id="L1598">        <span class="tok-number">1937</span>, <span class="tok-number">115</span>,  <span class="tok-number">2953</span>, <span class="tok-number">586</span>,  <span class="tok-number">545</span>,  <span class="tok-number">1621</span>, <span class="tok-number">1667</span>, <span class="tok-number">3187</span>, <span class="tok-number">1654</span>, <span class="tok-number">1988</span>, <span class="tok-number">1857</span>,</span>
<span class="line" id="L1599">        <span class="tok-number">512</span>,  <span class="tok-number">1239</span>, <span class="tok-number">1219</span>, <span class="tok-number">898</span>,  <span class="tok-number">3106</span>, <span class="tok-number">391</span>,  <span class="tok-number">1331</span>, <span class="tok-number">2228</span>, <span class="tok-number">3169</span>, <span class="tok-number">586</span>,  <span class="tok-number">2412</span>,</span>
<span class="line" id="L1600">        <span class="tok-number">845</span>,  <span class="tok-number">768</span>,  <span class="tok-number">156</span>,  <span class="tok-number">662</span>,  <span class="tok-number">478</span>,  <span class="tok-number">1693</span>, <span class="tok-number">2632</span>, <span class="tok-number">573</span>,  <span class="tok-number">2434</span>, <span class="tok-number">1671</span>, <span class="tok-number">173</span>,</span>
<span class="line" id="L1601">        <span class="tok-number">969</span>,  <span class="tok-number">364</span>,  <span class="tok-number">1663</span>, <span class="tok-number">2701</span>, <span class="tok-number">2169</span>, <span class="tok-number">813</span>,  <span class="tok-number">1000</span>, <span class="tok-number">1471</span>, <span class="tok-number">720</span>,  <span class="tok-number">2431</span>, <span class="tok-number">2530</span>,</span>
<span class="line" id="L1602">        <span class="tok-number">3161</span>, <span class="tok-number">733</span>,  <span class="tok-number">1691</span>, <span class="tok-number">527</span>,  <span class="tok-number">2634</span>, <span class="tok-number">335</span>,  <span class="tok-number">26</span>,   <span class="tok-number">2377</span>, <span class="tok-number">1707</span>, <span class="tok-number">767</span>,  <span class="tok-number">3020</span>,</span>
<span class="line" id="L1603">        <span class="tok-number">950</span>,  <span class="tok-number">502</span>,  <span class="tok-number">426</span>,  <span class="tok-number">1138</span>, <span class="tok-number">3208</span>, <span class="tok-number">2607</span>, <span class="tok-number">2389</span>, <span class="tok-number">44</span>,   <span class="tok-number">1358</span>, <span class="tok-number">1392</span>, <span class="tok-number">2334</span>,</span>
<span class="line" id="L1604">        <span class="tok-number">875</span>,  <span class="tok-number">2097</span>, <span class="tok-number">173</span>,  <span class="tok-number">1697</span>, <span class="tok-number">2578</span>, <span class="tok-number">942</span>,  <span class="tok-number">1817</span>, <span class="tok-number">974</span>,  <span class="tok-number">1165</span>, <span class="tok-number">2853</span>, <span class="tok-number">1958</span>,</span>
<span class="line" id="L1605">        <span class="tok-number">2973</span>, <span class="tok-number">3282</span>, <span class="tok-number">271</span>,  <span class="tok-number">1236</span>, <span class="tok-number">1677</span>, <span class="tok-number">2230</span>, <span class="tok-number">673</span>,  <span class="tok-number">1554</span>, <span class="tok-number">96</span>,   <span class="tok-number">242</span>,  <span class="tok-number">1729</span>,</span>
<span class="line" id="L1606">        <span class="tok-number">2518</span>, <span class="tok-number">1884</span>, <span class="tok-number">2272</span>, <span class="tok-number">71</span>,   <span class="tok-number">1382</span>, <span class="tok-number">924</span>,  <span class="tok-number">1807</span>, <span class="tok-number">1610</span>, <span class="tok-number">456</span>,  <span class="tok-number">1148</span>, <span class="tok-number">2479</span>,</span>
<span class="line" id="L1607">        <span class="tok-number">2152</span>, <span class="tok-number">238</span>,  <span class="tok-number">2208</span>, <span class="tok-number">2329</span>, <span class="tok-number">713</span>,  <span class="tok-number">1175</span>, <span class="tok-number">1196</span>, <span class="tok-number">757</span>,  <span class="tok-number">1078</span>, <span class="tok-number">3190</span>, <span class="tok-number">3169</span>,</span>
<span class="line" id="L1608">        <span class="tok-number">708</span>,  <span class="tok-number">3117</span>, <span class="tok-number">154</span>,  <span class="tok-number">1751</span>, <span class="tok-number">3225</span>, <span class="tok-number">1364</span>, <span class="tok-number">154</span>,  <span class="tok-number">23</span>,   <span class="tok-number">2842</span>, <span class="tok-number">1105</span>, <span class="tok-number">1419</span>,</span>
<span class="line" id="L1609">        <span class="tok-number">79</span>,   <span class="tok-number">5</span>,    <span class="tok-number">2013</span>,</span>
<span class="line" id="L1610">    });</span>
<span class="line" id="L1611">}</span>
<span class="line" id="L1612"></span>
<span class="line" id="L1613"><span class="tok-kw">test</span> <span class="tok-str">&quot;Polynomial packing&quot;</span> {</span>
<span class="line" id="L1614">    <span class="tok-kw">var</span> rnd = RndGen.init(<span class="tok-number">0</span>);</span>
<span class="line" id="L1615"></span>
<span class="line" id="L1616">    <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">1000</span>) |_| {</span>
<span class="line" id="L1617">        <span class="tok-kw">const</span> p = Poly.randNormalized(&amp;rnd);</span>
<span class="line" id="L1618">        <span class="tok-kw">try</span> testing.expectEqual(Poly.fromBytes(&amp;p.toBytes()), p);</span>
<span class="line" id="L1619">    }</span>
<span class="line" id="L1620">}</span>
<span class="line" id="L1621"></span>
<span class="line" id="L1622"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test inner PKE&quot;</span> {</span>
<span class="line" id="L1623">    <span class="tok-kw">var</span> seed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1624">    <span class="tok-kw">var</span> pt: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1625">    <span class="tok-kw">for</span> (&amp;seed, &amp;pt, <span class="tok-number">0</span>..) |*s, *p, i| {</span>
<span class="line" id="L1626">        s.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1627">        p.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i + <span class="tok-number">32</span>));</span>
<span class="line" id="L1628">    }</span>
<span class="line" id="L1629">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (modes) |mode| {</span>
<span class="line" id="L1630">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">100</span>) |i| {</span>
<span class="line" id="L1631">            <span class="tok-kw">var</span> pk: mode.InnerPk = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1632">            <span class="tok-kw">var</span> sk: mode.InnerSk = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1633">            seed[<span class="tok-number">0</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1634">            mode.innerKeyFromSeed(seed, &amp;pk, &amp;sk);</span>
<span class="line" id="L1635">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">10</span>) |j| {</span>
<span class="line" id="L1636">                seed[<span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(j));</span>
<span class="line" id="L1637">                <span class="tok-kw">try</span> testing.expectEqual(sk.decrypt(&amp;pk.encrypt(&amp;pt, &amp;seed)), pt);</span>
<span class="line" id="L1638">            }</span>
<span class="line" id="L1639">        }</span>
<span class="line" id="L1640">    }</span>
<span class="line" id="L1641">}</span>
<span class="line" id="L1642"></span>
<span class="line" id="L1643"><span class="tok-kw">test</span> <span class="tok-str">&quot;Test happy flow&quot;</span> {</span>
<span class="line" id="L1644">    <span class="tok-kw">var</span> seed: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1645">    <span class="tok-kw">for</span> (&amp;seed, <span class="tok-number">0</span>..) |*s, i| {</span>
<span class="line" id="L1646">        s.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1647">    }</span>
<span class="line" id="L1648">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (modes) |mode| {</span>
<span class="line" id="L1649">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">100</span>) |i| {</span>
<span class="line" id="L1650">            seed[<span class="tok-number">0</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1651">            <span class="tok-kw">const</span> kp = <span class="tok-kw">try</span> mode.KeyPair.create(seed);</span>
<span class="line" id="L1652">            <span class="tok-kw">const</span> sk = <span class="tok-kw">try</span> mode.SecretKey.fromBytes(&amp;kp.secret_key.toBytes());</span>
<span class="line" id="L1653">            <span class="tok-kw">try</span> testing.expectEqual(sk, kp.secret_key);</span>
<span class="line" id="L1654">            <span class="tok-kw">const</span> pk = <span class="tok-kw">try</span> mode.PublicKey.fromBytes(&amp;kp.public_key.toBytes());</span>
<span class="line" id="L1655">            <span class="tok-kw">try</span> testing.expectEqual(pk, kp.public_key);</span>
<span class="line" id="L1656">            <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">10</span>) |j| {</span>
<span class="line" id="L1657">                seed[<span class="tok-number">1</span>] = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(j));</span>
<span class="line" id="L1658">                <span class="tok-kw">const</span> e = pk.encaps(seed[<span class="tok-number">0</span>..<span class="tok-number">32</span>].*);</span>
<span class="line" id="L1659">                <span class="tok-kw">try</span> testing.expectEqual(e.shared_secret, <span class="tok-kw">try</span> sk.decaps(&amp;e.ciphertext));</span>
<span class="line" id="L1660">            }</span>
<span class="line" id="L1661">        }</span>
<span class="line" id="L1662">    }</span>
<span class="line" id="L1663">}</span>
<span class="line" id="L1664"></span>
<span class="line" id="L1665"><span class="tok-comment">// Code to test NIST Known Answer Tests (KAT), see PQCgenKAT.c.</span>
</span>
<span class="line" id="L1666"></span>
<span class="line" id="L1667"><span class="tok-kw">const</span> sha2 = crypto.hash.sha2;</span>
<span class="line" id="L1668"></span>
<span class="line" id="L1669"><span class="tok-kw">test</span> <span class="tok-str">&quot;NIST KAT test&quot;</span> {</span>
<span class="line" id="L1670">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (.{</span>
<span class="line" id="L1671">        .{ Kyber512, <span class="tok-str">&quot;e9c2bd37133fcb40772f81559f14b1f58dccd1c816701be9ba6214d43baf4547&quot;</span> },</span>
<span class="line" id="L1672">        .{ Kyber1024, <span class="tok-str">&quot;89248f2f33f7f4f7051729111f3049c409a933ec904aedadf035f30fa5646cd5&quot;</span> },</span>
<span class="line" id="L1673">        .{ Kyber768, <span class="tok-str">&quot;a1e122cad3c24bc51622e4c242d8b8acbcd3f618fee4220400605ca8f9ea02c2&quot;</span> },</span>
<span class="line" id="L1674">    }) |modeHash| {</span>
<span class="line" id="L1675">        <span class="tok-kw">const</span> mode = modeHash[<span class="tok-number">0</span>];</span>
<span class="line" id="L1676">        <span class="tok-kw">var</span> seed: [<span class="tok-number">48</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1677">        <span class="tok-kw">for</span> (&amp;seed, <span class="tok-number">0</span>..) |*s, i| {</span>
<span class="line" id="L1678">            s.* = <span class="tok-builtin">@as</span>(<span class="tok-type">u8</span>, <span class="tok-builtin">@intCast</span>(i));</span>
<span class="line" id="L1679">        }</span>
<span class="line" id="L1680">        <span class="tok-kw">var</span> f = sha2.Sha256.init(.{});</span>
<span class="line" id="L1681">        <span class="tok-kw">const</span> fw = f.writer();</span>
<span class="line" id="L1682">        <span class="tok-kw">var</span> g = NistDRBG.init(seed);</span>
<span class="line" id="L1683">        <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;# {s}\n\n&quot;</span>, .{mode.name});</span>
<span class="line" id="L1684">        <span class="tok-kw">for</span> (<span class="tok-number">0</span>..<span class="tok-number">100</span>) |i| {</span>
<span class="line" id="L1685">            g.fill(&amp;seed);</span>
<span class="line" id="L1686">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;count = {}\n&quot;</span>, .{i});</span>
<span class="line" id="L1687">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;seed = {s}\n&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;seed)});</span>
<span class="line" id="L1688">            <span class="tok-kw">var</span> g2 = NistDRBG.init(seed);</span>
<span class="line" id="L1689"></span>
<span class="line" id="L1690">            <span class="tok-comment">// This is not equivalent to g2.fill(kseed[:]). As the reference</span>
</span>
<span class="line" id="L1691">            <span class="tok-comment">// implementation calls randombytes twice generating the keypair,</span>
</span>
<span class="line" id="L1692">            <span class="tok-comment">// we have to do that as well.</span>
</span>
<span class="line" id="L1693">            <span class="tok-kw">var</span> kseed: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1694">            <span class="tok-kw">var</span> eseed: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1695">            g2.fill(kseed[<span class="tok-number">0</span>..<span class="tok-number">32</span>]);</span>
<span class="line" id="L1696">            g2.fill(kseed[<span class="tok-number">32</span>..<span class="tok-number">64</span>]);</span>
<span class="line" id="L1697">            g2.fill(&amp;eseed);</span>
<span class="line" id="L1698">            <span class="tok-kw">const</span> kp = <span class="tok-kw">try</span> mode.KeyPair.create(kseed);</span>
<span class="line" id="L1699">            <span class="tok-kw">const</span> e = kp.public_key.encaps(eseed);</span>
<span class="line" id="L1700">            <span class="tok-kw">const</span> ss2 = <span class="tok-kw">try</span> kp.secret_key.decaps(&amp;e.ciphertext);</span>
<span class="line" id="L1701">            <span class="tok-kw">try</span> testing.expectEqual(ss2, e.shared_secret);</span>
<span class="line" id="L1702">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;pk = {s}\n&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;kp.public_key.toBytes())});</span>
<span class="line" id="L1703">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;sk = {s}\n&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;kp.secret_key.toBytes())});</span>
<span class="line" id="L1704">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;ct = {s}\n&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;e.ciphertext)});</span>
<span class="line" id="L1705">            <span class="tok-kw">try</span> std.fmt.format(fw, <span class="tok-str">&quot;ss = {s}\n\n&quot;</span>, .{std.fmt.fmtSliceHexUpper(&amp;e.shared_secret)});</span>
<span class="line" id="L1706">        }</span>
<span class="line" id="L1707"></span>
<span class="line" id="L1708">        <span class="tok-kw">var</span> out: [<span class="tok-number">32</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1709">        f.final(&amp;out);</span>
<span class="line" id="L1710">        <span class="tok-kw">var</span> outHex: [<span class="tok-number">64</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1711">        _ = <span class="tok-kw">try</span> std.fmt.bufPrint(&amp;outHex, <span class="tok-str">&quot;{s}&quot;</span>, .{std.fmt.fmtSliceHexLower(&amp;out)});</span>
<span class="line" id="L1712">        <span class="tok-kw">try</span> testing.expectEqual(outHex, modeHash[<span class="tok-number">1</span>].*);</span>
<span class="line" id="L1713">    }</span>
<span class="line" id="L1714">}</span>
<span class="line" id="L1715"></span>
<span class="line" id="L1716"><span class="tok-kw">const</span> NistDRBG = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1717">    key: [<span class="tok-number">32</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L1718">    v: [<span class="tok-number">16</span>]<span class="tok-type">u8</span>,</span>
<span class="line" id="L1719"></span>
<span class="line" id="L1720">    <span class="tok-kw">fn</span> <span class="tok-fn">incV</span>(g: *NistDRBG) <span class="tok-type">void</span> {</span>
<span class="line" id="L1721">        <span class="tok-kw">var</span> j: <span class="tok-type">usize</span> = <span class="tok-number">15</span>;</span>
<span class="line" id="L1722">        <span class="tok-kw">while</span> (j &gt;= <span class="tok-number">0</span>) : (j -= <span class="tok-number">1</span>) {</span>
<span class="line" id="L1723">            <span class="tok-kw">if</span> (g.v[j] == <span class="tok-number">255</span>) {</span>
<span class="line" id="L1724">                g.v[j] = <span class="tok-number">0</span>;</span>
<span class="line" id="L1725">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L1726">                g.v[j] += <span class="tok-number">1</span>;</span>
<span class="line" id="L1727">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L1728">            }</span>
<span class="line" id="L1729">        }</span>
<span class="line" id="L1730">    }</span>
<span class="line" id="L1731"></span>
<span class="line" id="L1732">    <span class="tok-comment">// AES256_CTR_DRBG_Update(pd, &amp;g.key, &amp;g.v).</span>
</span>
<span class="line" id="L1733">    <span class="tok-kw">fn</span> <span class="tok-fn">update</span>(g: *NistDRBG, pd: ?[<span class="tok-number">48</span>]<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1734">        <span class="tok-kw">var</span> buf: [<span class="tok-number">48</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1735">        <span class="tok-kw">const</span> ctx = crypto.core.aes.Aes256.initEnc(g.key);</span>
<span class="line" id="L1736">        <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L1737">        <span class="tok-kw">while</span> (i &lt; <span class="tok-number">3</span>) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L1738">            g.incV();</span>
<span class="line" id="L1739">            <span class="tok-kw">var</span> block: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1740">            ctx.encrypt(&amp;block, &amp;g.v);</span>
<span class="line" id="L1741">            buf[i * <span class="tok-number">16</span> ..][<span class="tok-number">0</span>..<span class="tok-number">16</span>].* = block;</span>
<span class="line" id="L1742">        }</span>
<span class="line" id="L1743">        <span class="tok-kw">if</span> (pd) |p| {</span>
<span class="line" id="L1744">            <span class="tok-kw">for</span> (&amp;buf, p) |*b, x| {</span>
<span class="line" id="L1745">                b.* ^= x;</span>
<span class="line" id="L1746">            }</span>
<span class="line" id="L1747">        }</span>
<span class="line" id="L1748">        g.key = buf[<span class="tok-number">0</span>..<span class="tok-number">32</span>].*;</span>
<span class="line" id="L1749">        g.v = buf[<span class="tok-number">32</span>..<span class="tok-number">48</span>].*;</span>
<span class="line" id="L1750">    }</span>
<span class="line" id="L1751"></span>
<span class="line" id="L1752">    <span class="tok-comment">// randombytes.</span>
</span>
<span class="line" id="L1753">    <span class="tok-kw">fn</span> <span class="tok-fn">fill</span>(g: *NistDRBG, out: []<span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L1754">        <span class="tok-kw">var</span> block: [<span class="tok-number">16</span>]<span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L1755">        <span class="tok-kw">var</span> dst = out;</span>
<span class="line" id="L1756"></span>
<span class="line" id="L1757">        <span class="tok-kw">const</span> ctx = crypto.core.aes.Aes256.initEnc(g.key);</span>
<span class="line" id="L1758">        <span class="tok-kw">while</span> (dst.len &gt; <span class="tok-number">0</span>) {</span>
<span class="line" id="L1759">            g.incV();</span>
<span class="line" id="L1760">            ctx.encrypt(&amp;block, &amp;g.v);</span>
<span class="line" id="L1761">            <span class="tok-kw">if</span> (dst.len &lt; <span class="tok-number">16</span>) {</span>
<span class="line" id="L1762">                <span class="tok-builtin">@memcpy</span>(dst, block[<span class="tok-number">0</span>..dst.len]);</span>
<span class="line" id="L1763">                <span class="tok-kw">break</span>;</span>
<span class="line" id="L1764">            }</span>
<span class="line" id="L1765">            dst[<span class="tok-number">0</span>..block.len].* = block;</span>
<span class="line" id="L1766">            dst = dst[<span class="tok-number">16</span>..dst.len];</span>
<span class="line" id="L1767">        }</span>
<span class="line" id="L1768">        g.update(<span class="tok-null">null</span>);</span>
<span class="line" id="L1769">    }</span>
<span class="line" id="L1770"></span>
<span class="line" id="L1771">    <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(seed: [<span class="tok-number">48</span>]<span class="tok-type">u8</span>) NistDRBG {</span>
<span class="line" id="L1772">        <span class="tok-kw">var</span> ret: NistDRBG = .{ .key = .{<span class="tok-number">0</span>} ** <span class="tok-number">32</span>, .v = .{<span class="tok-number">0</span>} ** <span class="tok-number">16</span> };</span>
<span class="line" id="L1773">        ret.update(seed);</span>
<span class="line" id="L1774">        <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L1775">    }</span>
<span class="line" id="L1776">};</span>
<span class="line" id="L1777"></span>
</code></pre></body>
</html>