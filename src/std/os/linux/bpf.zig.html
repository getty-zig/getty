<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>os/linux/bpf.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;../../std.zig&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> errno = getErrno;</span>
<span class="line" id="L3"><span class="tok-kw">const</span> unexpectedErrno = std.os.unexpectedErrno;</span>
<span class="line" id="L4"><span class="tok-kw">const</span> expectEqual = std.testing.expectEqual;</span>
<span class="line" id="L5"><span class="tok-kw">const</span> expectError = std.testing.expectError;</span>
<span class="line" id="L6"><span class="tok-kw">const</span> expect = std.testing.expect;</span>
<span class="line" id="L7"></span>
<span class="line" id="L8"><span class="tok-kw">const</span> linux = std.os.linux;</span>
<span class="line" id="L9"><span class="tok-kw">const</span> fd_t = linux.fd_t;</span>
<span class="line" id="L10"><span class="tok-kw">const</span> pid_t = linux.pid_t;</span>
<span class="line" id="L11"><span class="tok-kw">const</span> getErrno = linux.getErrno;</span>
<span class="line" id="L12"></span>
<span class="line" id="L13"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> btf = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;bpf/btf.zig&quot;</span>);</span>
<span class="line" id="L14"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> kern = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;bpf/kern.zig&quot;</span>);</span>
<span class="line" id="L15"></span>
<span class="line" id="L16"><span class="tok-comment">// instruction classes</span>
</span>
<span class="line" id="L17"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LD = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L18"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LDX = <span class="tok-number">0x01</span>;</span>
<span class="line" id="L19"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ST = <span class="tok-number">0x02</span>;</span>
<span class="line" id="L20"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> STX = <span class="tok-number">0x03</span>;</span>
<span class="line" id="L21"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ALU = <span class="tok-number">0x04</span>;</span>
<span class="line" id="L22"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JMP = <span class="tok-number">0x05</span>;</span>
<span class="line" id="L23"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RET = <span class="tok-number">0x06</span>;</span>
<span class="line" id="L24"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MISC = <span class="tok-number">0x07</span>;</span>
<span class="line" id="L25"></span>
<span class="line" id="L26"><span class="tok-comment">/// 32-bit</span></span>
<span class="line" id="L27"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> W = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L28"><span class="tok-comment">/// 16-bit</span></span>
<span class="line" id="L29"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> H = <span class="tok-number">0x08</span>;</span>
<span class="line" id="L30"><span class="tok-comment">/// 8-bit</span></span>
<span class="line" id="L31"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> B = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L32"><span class="tok-comment">/// 64-bit</span></span>
<span class="line" id="L33"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DW = <span class="tok-number">0x18</span>;</span>
<span class="line" id="L34"></span>
<span class="line" id="L35"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IMM = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L36"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ABS = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L37"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IND = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L38"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MEM = <span class="tok-number">0x60</span>;</span>
<span class="line" id="L39"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LEN = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L40"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MSH = <span class="tok-number">0xa0</span>;</span>
<span class="line" id="L41"></span>
<span class="line" id="L42"><span class="tok-comment">// alu fields</span>
</span>
<span class="line" id="L43"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ADD = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L44"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> SUB = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L45"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MUL = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L46"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> DIV = <span class="tok-number">0x30</span>;</span>
<span class="line" id="L47"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> OR = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L48"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AND = <span class="tok-number">0x50</span>;</span>
<span class="line" id="L49"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LSH = <span class="tok-number">0x60</span>;</span>
<span class="line" id="L50"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RSH = <span class="tok-number">0x70</span>;</span>
<span class="line" id="L51"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NEG = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L52"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOD = <span class="tok-number">0x90</span>;</span>
<span class="line" id="L53"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XOR = <span class="tok-number">0xa0</span>;</span>
<span class="line" id="L54"></span>
<span class="line" id="L55"><span class="tok-comment">// jmp fields</span>
</span>
<span class="line" id="L56"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JA = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L57"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JEQ = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L58"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JGT = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L59"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JGE = <span class="tok-number">0x30</span>;</span>
<span class="line" id="L60"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JSET = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L61"></span>
<span class="line" id="L62"><span class="tok-comment">//#define BPF_SRC(code)   ((code) &amp; 0x08)</span>
</span>
<span class="line" id="L63"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> K = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L64"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> X = <span class="tok-number">0x08</span>;</span>
<span class="line" id="L65"></span>
<span class="line" id="L66"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAXINSNS = <span class="tok-number">4096</span>;</span>
<span class="line" id="L67"></span>
<span class="line" id="L68"><span class="tok-comment">// instruction classes</span>
</span>
<span class="line" id="L69"><span class="tok-comment">/// jmp mode in word width</span></span>
<span class="line" id="L70"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JMP32 = <span class="tok-number">0x06</span>;</span>
<span class="line" id="L71"></span>
<span class="line" id="L72"><span class="tok-comment">/// alu mode in double word width</span></span>
<span class="line" id="L73"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ALU64 = <span class="tok-number">0x07</span>;</span>
<span class="line" id="L74"></span>
<span class="line" id="L75"><span class="tok-comment">// ld/ldx fields</span>
</span>
<span class="line" id="L76"><span class="tok-comment">/// exclusive add</span></span>
<span class="line" id="L77"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> XADD = <span class="tok-number">0xc0</span>;</span>
<span class="line" id="L78"></span>
<span class="line" id="L79"><span class="tok-comment">// alu/jmp fields</span>
</span>
<span class="line" id="L80"><span class="tok-comment">/// mov reg to reg</span></span>
<span class="line" id="L81"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MOV = <span class="tok-number">0xb0</span>;</span>
<span class="line" id="L82"></span>
<span class="line" id="L83"><span class="tok-comment">/// sign extending arithmetic shift right */</span></span>
<span class="line" id="L84"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ARSH = <span class="tok-number">0xc0</span>;</span>
<span class="line" id="L85"></span>
<span class="line" id="L86"><span class="tok-comment">// change endianness of a register</span>
</span>
<span class="line" id="L87"><span class="tok-comment">/// flags for endianness conversion:</span></span>
<span class="line" id="L88"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> END = <span class="tok-number">0xd0</span>;</span>
<span class="line" id="L89"></span>
<span class="line" id="L90"><span class="tok-comment">/// convert to little-endian */</span></span>
<span class="line" id="L91"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TO_LE = <span class="tok-number">0x00</span>;</span>
<span class="line" id="L92"></span>
<span class="line" id="L93"><span class="tok-comment">/// convert to big-endian</span></span>
<span class="line" id="L94"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TO_BE = <span class="tok-number">0x08</span>;</span>
<span class="line" id="L95"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FROM_LE = TO_LE;</span>
<span class="line" id="L96"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FROM_BE = TO_BE;</span>
<span class="line" id="L97"></span>
<span class="line" id="L98"><span class="tok-comment">// jmp encodings</span>
</span>
<span class="line" id="L99"><span class="tok-comment">/// jump != *</span></span>
<span class="line" id="L100"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JNE = <span class="tok-number">0x50</span>;</span>
<span class="line" id="L101"></span>
<span class="line" id="L102"><span class="tok-comment">/// LT is unsigned, '&lt;'</span></span>
<span class="line" id="L103"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JLT = <span class="tok-number">0xa0</span>;</span>
<span class="line" id="L104"></span>
<span class="line" id="L105"><span class="tok-comment">/// LE is unsigned, '&lt;=' *</span></span>
<span class="line" id="L106"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JLE = <span class="tok-number">0xb0</span>;</span>
<span class="line" id="L107"></span>
<span class="line" id="L108"><span class="tok-comment">/// SGT is signed '&gt;', GT in x86</span></span>
<span class="line" id="L109"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JSGT = <span class="tok-number">0x60</span>;</span>
<span class="line" id="L110"></span>
<span class="line" id="L111"><span class="tok-comment">/// SGE is signed '&gt;=', GE in x86</span></span>
<span class="line" id="L112"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JSGE = <span class="tok-number">0x70</span>;</span>
<span class="line" id="L113"></span>
<span class="line" id="L114"><span class="tok-comment">/// SLT is signed, '&lt;'</span></span>
<span class="line" id="L115"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JSLT = <span class="tok-number">0xc0</span>;</span>
<span class="line" id="L116"></span>
<span class="line" id="L117"><span class="tok-comment">/// SLE is signed, '&lt;='</span></span>
<span class="line" id="L118"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> JSLE = <span class="tok-number">0xd0</span>;</span>
<span class="line" id="L119"></span>
<span class="line" id="L120"><span class="tok-comment">/// function call</span></span>
<span class="line" id="L121"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> CALL = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L122"></span>
<span class="line" id="L123"><span class="tok-comment">/// function return</span></span>
<span class="line" id="L124"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXIT = <span class="tok-number">0x90</span>;</span>
<span class="line" id="L125"></span>
<span class="line" id="L126"><span class="tok-comment">/// Flag for prog_attach command. If a sub-cgroup installs some bpf program, the</span></span>
<span class="line" id="L127"><span class="tok-comment">/// program in this cgroup yields to sub-cgroup program.</span></span>
<span class="line" id="L128"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_ALLOW_OVERRIDE = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L129"></span>
<span class="line" id="L130"><span class="tok-comment">/// Flag for prog_attach command. If a sub-cgroup installs some bpf program,</span></span>
<span class="line" id="L131"><span class="tok-comment">/// that cgroup program gets run in addition to the program in this cgroup.</span></span>
<span class="line" id="L132"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_ALLOW_MULTI = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L133"></span>
<span class="line" id="L134"><span class="tok-comment">/// Flag for prog_attach command.</span></span>
<span class="line" id="L135"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_REPLACE = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L136"></span>
<span class="line" id="L137"><span class="tok-comment">/// If BPF_F_STRICT_ALIGNMENT is used in BPF_PROG_LOAD command, the verifier</span></span>
<span class="line" id="L138"><span class="tok-comment">/// will perform strict alignment checking as if the kernel has been built with</span></span>
<span class="line" id="L139"><span class="tok-comment">/// CONFIG_EFFICIENT_UNALIGNED_ACCESS not set, and NET_IP_ALIGN defined to 2.</span></span>
<span class="line" id="L140"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_STRICT_ALIGNMENT = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L141"></span>
<span class="line" id="L142"><span class="tok-comment">/// If BPF_F_ANY_ALIGNMENT is used in BPF_PROF_LOAD command, the verifier will</span></span>
<span class="line" id="L143"><span class="tok-comment">/// allow any alignment whatsoever.  On platforms with strict alignment</span></span>
<span class="line" id="L144"><span class="tok-comment">/// requirements for loads ands stores (such as sparc and mips) the verifier</span></span>
<span class="line" id="L145"><span class="tok-comment">/// validates that all loads and stores provably follow this requirement.  This</span></span>
<span class="line" id="L146"><span class="tok-comment">/// flag turns that checking and enforcement off.</span></span>
<span class="line" id="L147"><span class="tok-comment">///</span></span>
<span class="line" id="L148"><span class="tok-comment">/// It is mostly used for testing when we want to validate the context and</span></span>
<span class="line" id="L149"><span class="tok-comment">/// memory access aspects of the verifier, but because of an unaligned access</span></span>
<span class="line" id="L150"><span class="tok-comment">/// the alignment check would trigger before the one we are interested in.</span></span>
<span class="line" id="L151"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_ANY_ALIGNMENT = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L152"></span>
<span class="line" id="L153"><span class="tok-comment">/// BPF_F_TEST_RND_HI32 is used in BPF_PROG_LOAD command for testing purpose.</span></span>
<span class="line" id="L154"><span class="tok-comment">/// Verifier does sub-register def/use analysis and identifies instructions</span></span>
<span class="line" id="L155"><span class="tok-comment">/// whose def only matters for low 32-bit, high 32-bit is never referenced later</span></span>
<span class="line" id="L156"><span class="tok-comment">/// through implicit zero extension. Therefore verifier notifies JIT back-ends</span></span>
<span class="line" id="L157"><span class="tok-comment">/// that it is safe to ignore clearing high 32-bit for these instructions. This</span></span>
<span class="line" id="L158"><span class="tok-comment">/// saves some back-ends a lot of code-gen. However such optimization is not</span></span>
<span class="line" id="L159"><span class="tok-comment">/// necessary on some arches, for example x86_64, arm64 etc, whose JIT back-ends</span></span>
<span class="line" id="L160"><span class="tok-comment">/// hence hasn't used verifier's analysis result. But, we really want to have a</span></span>
<span class="line" id="L161"><span class="tok-comment">/// way to be able to verify the correctness of the described optimization on</span></span>
<span class="line" id="L162"><span class="tok-comment">/// x86_64 on which testsuites are frequently exercised.</span></span>
<span class="line" id="L163"><span class="tok-comment">///</span></span>
<span class="line" id="L164"><span class="tok-comment">/// So, this flag is introduced. Once it is set, verifier will randomize high</span></span>
<span class="line" id="L165"><span class="tok-comment">/// 32-bit for those instructions who has been identified as safe to ignore</span></span>
<span class="line" id="L166"><span class="tok-comment">/// them.  Then, if verifier is not doing correct analysis, such randomization</span></span>
<span class="line" id="L167"><span class="tok-comment">/// will regress tests to expose bugs.</span></span>
<span class="line" id="L168"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_TEST_RND_HI32 = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L169"></span>
<span class="line" id="L170"><span class="tok-comment">/// If BPF_F_SLEEPABLE is used in BPF_PROG_LOAD command, the verifier will</span></span>
<span class="line" id="L171"><span class="tok-comment">/// restrict map and helper usage for such programs. Sleepable BPF programs can</span></span>
<span class="line" id="L172"><span class="tok-comment">/// only be attached to hooks where kernel execution context allows sleeping.</span></span>
<span class="line" id="L173"><span class="tok-comment">/// Such programs are allowed to use helpers that may sleep like</span></span>
<span class="line" id="L174"><span class="tok-comment">/// bpf_copy_from_user().</span></span>
<span class="line" id="L175"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_SLEEPABLE = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L176"></span>
<span class="line" id="L177"><span class="tok-comment">/// When BPF ldimm64's insn[0].src_reg != 0 then this can have two extensions:</span></span>
<span class="line" id="L178"><span class="tok-comment">/// insn[0].src_reg:  BPF_PSEUDO_MAP_FD   BPF_PSEUDO_MAP_VALUE</span></span>
<span class="line" id="L179"><span class="tok-comment">/// insn[0].imm:      map fd              map fd</span></span>
<span class="line" id="L180"><span class="tok-comment">/// insn[1].imm:      0                   offset into value</span></span>
<span class="line" id="L181"><span class="tok-comment">/// insn[0].off:      0                   0</span></span>
<span class="line" id="L182"><span class="tok-comment">/// insn[1].off:      0                   0</span></span>
<span class="line" id="L183"><span class="tok-comment">/// ldimm64 rewrite:  address of map      address of map[0]+offset</span></span>
<span class="line" id="L184"><span class="tok-comment">/// verifier type:    CONST_PTR_TO_MAP    PTR_TO_MAP_VALUE</span></span>
<span class="line" id="L185"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSEUDO_MAP_FD = <span class="tok-number">1</span>;</span>
<span class="line" id="L186"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSEUDO_MAP_VALUE = <span class="tok-number">2</span>;</span>
<span class="line" id="L187"></span>
<span class="line" id="L188"><span class="tok-comment">/// when bpf_call-&gt;src_reg == BPF_PSEUDO_CALL, bpf_call-&gt;imm == pc-relative</span></span>
<span class="line" id="L189"><span class="tok-comment">/// offset to another bpf function</span></span>
<span class="line" id="L190"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PSEUDO_CALL = <span class="tok-number">1</span>;</span>
<span class="line" id="L191"></span>
<span class="line" id="L192"><span class="tok-comment">/// flag for BPF_MAP_UPDATE_ELEM command. create new element or update existing</span></span>
<span class="line" id="L193"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ANY = <span class="tok-number">0</span>;</span>
<span class="line" id="L194"></span>
<span class="line" id="L195"><span class="tok-comment">/// flag for BPF_MAP_UPDATE_ELEM command. create new element if it didn't exist</span></span>
<span class="line" id="L196"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> NOEXIST = <span class="tok-number">1</span>;</span>
<span class="line" id="L197"></span>
<span class="line" id="L198"><span class="tok-comment">/// flag for BPF_MAP_UPDATE_ELEM command. update existing element</span></span>
<span class="line" id="L199"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EXIST = <span class="tok-number">2</span>;</span>
<span class="line" id="L200"></span>
<span class="line" id="L201"><span class="tok-comment">/// flag for BPF_MAP_UPDATE_ELEM command. spin_lock-ed map_lookup/map_update</span></span>
<span class="line" id="L202"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> F_LOCK = <span class="tok-number">4</span>;</span>
<span class="line" id="L203"></span>
<span class="line" id="L204"><span class="tok-comment">/// flag for BPF_MAP_CREATE command */</span></span>
<span class="line" id="L205"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_NO_PREALLOC = <span class="tok-number">0x1</span>;</span>
<span class="line" id="L206"></span>
<span class="line" id="L207"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Instead of having one common LRU list in</span></span>
<span class="line" id="L208"><span class="tok-comment">/// the BPF_MAP_TYPE_LRU_[PERCPU_]HASH map, use a percpu LRU list which can</span></span>
<span class="line" id="L209"><span class="tok-comment">/// scale and perform better.  Note, the LRU nodes (including free nodes) cannot</span></span>
<span class="line" id="L210"><span class="tok-comment">/// be moved across different LRU lists.</span></span>
<span class="line" id="L211"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_NO_COMMON_LRU = <span class="tok-number">0x2</span>;</span>
<span class="line" id="L212"></span>
<span class="line" id="L213"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Specify numa node during map creation</span></span>
<span class="line" id="L214"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_NUMA_NODE = <span class="tok-number">0x4</span>;</span>
<span class="line" id="L215"></span>
<span class="line" id="L216"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Flags for BPF object read access from</span></span>
<span class="line" id="L217"><span class="tok-comment">/// syscall side</span></span>
<span class="line" id="L218"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_RDONLY = <span class="tok-number">0x8</span>;</span>
<span class="line" id="L219"></span>
<span class="line" id="L220"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Flags for BPF object write access from</span></span>
<span class="line" id="L221"><span class="tok-comment">/// syscall side</span></span>
<span class="line" id="L222"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_WRONLY = <span class="tok-number">0x10</span>;</span>
<span class="line" id="L223"></span>
<span class="line" id="L224"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Flag for stack_map, store build_id+offset</span></span>
<span class="line" id="L225"><span class="tok-comment">/// instead of pointer</span></span>
<span class="line" id="L226"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_STACK_BUILD_ID = <span class="tok-number">0x20</span>;</span>
<span class="line" id="L227"></span>
<span class="line" id="L228"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Zero-initialize hash function seed. This</span></span>
<span class="line" id="L229"><span class="tok-comment">/// should only be used for testing.</span></span>
<span class="line" id="L230"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_ZERO_SEED = <span class="tok-number">0x40</span>;</span>
<span class="line" id="L231"></span>
<span class="line" id="L232"><span class="tok-comment">/// flag for BPF_MAP_CREATE command Flags for accessing BPF object from program</span></span>
<span class="line" id="L233"><span class="tok-comment">/// side.</span></span>
<span class="line" id="L234"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_RDONLY_PROG = <span class="tok-number">0x80</span>;</span>
<span class="line" id="L235"></span>
<span class="line" id="L236"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Flags for accessing BPF object from program</span></span>
<span class="line" id="L237"><span class="tok-comment">/// side.</span></span>
<span class="line" id="L238"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_WRONLY_PROG = <span class="tok-number">0x100</span>;</span>
<span class="line" id="L239"></span>
<span class="line" id="L240"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Clone map from listener for newly accepted</span></span>
<span class="line" id="L241"><span class="tok-comment">/// socket</span></span>
<span class="line" id="L242"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_CLONE = <span class="tok-number">0x200</span>;</span>
<span class="line" id="L243"></span>
<span class="line" id="L244"><span class="tok-comment">/// flag for BPF_MAP_CREATE command. Enable memory-mapping BPF map</span></span>
<span class="line" id="L245"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BPF_F_MMAPABLE = <span class="tok-number">0x400</span>;</span>
<span class="line" id="L246"></span>
<span class="line" id="L247"><span class="tok-comment">/// These values correspond to &quot;syscalls&quot; within the BPF program's environment,</span></span>
<span class="line" id="L248"><span class="tok-comment">/// each one is documented in std.os.linux.BPF.kern</span></span>
<span class="line" id="L249"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Helper = <span class="tok-kw">enum</span>(<span class="tok-type">i32</span>) {</span>
<span class="line" id="L250">    unspec,</span>
<span class="line" id="L251">    map_lookup_elem,</span>
<span class="line" id="L252">    map_update_elem,</span>
<span class="line" id="L253">    map_delete_elem,</span>
<span class="line" id="L254">    probe_read,</span>
<span class="line" id="L255">    ktime_get_ns,</span>
<span class="line" id="L256">    trace_printk,</span>
<span class="line" id="L257">    get_prandom_u32,</span>
<span class="line" id="L258">    get_smp_processor_id,</span>
<span class="line" id="L259">    skb_store_bytes,</span>
<span class="line" id="L260">    l3_csum_replace,</span>
<span class="line" id="L261">    l4_csum_replace,</span>
<span class="line" id="L262">    tail_call,</span>
<span class="line" id="L263">    clone_redirect,</span>
<span class="line" id="L264">    get_current_pid_tgid,</span>
<span class="line" id="L265">    get_current_uid_gid,</span>
<span class="line" id="L266">    get_current_comm,</span>
<span class="line" id="L267">    get_cgroup_classid,</span>
<span class="line" id="L268">    skb_vlan_push,</span>
<span class="line" id="L269">    skb_vlan_pop,</span>
<span class="line" id="L270">    skb_get_tunnel_key,</span>
<span class="line" id="L271">    skb_set_tunnel_key,</span>
<span class="line" id="L272">    perf_event_read,</span>
<span class="line" id="L273">    redirect,</span>
<span class="line" id="L274">    get_route_realm,</span>
<span class="line" id="L275">    perf_event_output,</span>
<span class="line" id="L276">    skb_load_bytes,</span>
<span class="line" id="L277">    get_stackid,</span>
<span class="line" id="L278">    csum_diff,</span>
<span class="line" id="L279">    skb_get_tunnel_opt,</span>
<span class="line" id="L280">    skb_set_tunnel_opt,</span>
<span class="line" id="L281">    skb_change_proto,</span>
<span class="line" id="L282">    skb_change_type,</span>
<span class="line" id="L283">    skb_under_cgroup,</span>
<span class="line" id="L284">    get_hash_recalc,</span>
<span class="line" id="L285">    get_current_task,</span>
<span class="line" id="L286">    probe_write_user,</span>
<span class="line" id="L287">    current_task_under_cgroup,</span>
<span class="line" id="L288">    skb_change_tail,</span>
<span class="line" id="L289">    skb_pull_data,</span>
<span class="line" id="L290">    csum_update,</span>
<span class="line" id="L291">    set_hash_invalid,</span>
<span class="line" id="L292">    get_numa_node_id,</span>
<span class="line" id="L293">    skb_change_head,</span>
<span class="line" id="L294">    xdp_adjust_head,</span>
<span class="line" id="L295">    probe_read_str,</span>
<span class="line" id="L296">    get_socket_cookie,</span>
<span class="line" id="L297">    get_socket_uid,</span>
<span class="line" id="L298">    set_hash,</span>
<span class="line" id="L299">    setsockopt,</span>
<span class="line" id="L300">    skb_adjust_room,</span>
<span class="line" id="L301">    redirect_map,</span>
<span class="line" id="L302">    sk_redirect_map,</span>
<span class="line" id="L303">    sock_map_update,</span>
<span class="line" id="L304">    xdp_adjust_meta,</span>
<span class="line" id="L305">    perf_event_read_value,</span>
<span class="line" id="L306">    perf_prog_read_value,</span>
<span class="line" id="L307">    getsockopt,</span>
<span class="line" id="L308">    override_return,</span>
<span class="line" id="L309">    sock_ops_cb_flags_set,</span>
<span class="line" id="L310">    msg_redirect_map,</span>
<span class="line" id="L311">    msg_apply_bytes,</span>
<span class="line" id="L312">    msg_cork_bytes,</span>
<span class="line" id="L313">    msg_pull_data,</span>
<span class="line" id="L314">    bind,</span>
<span class="line" id="L315">    xdp_adjust_tail,</span>
<span class="line" id="L316">    skb_get_xfrm_state,</span>
<span class="line" id="L317">    get_stack,</span>
<span class="line" id="L318">    skb_load_bytes_relative,</span>
<span class="line" id="L319">    fib_lookup,</span>
<span class="line" id="L320">    sock_hash_update,</span>
<span class="line" id="L321">    msg_redirect_hash,</span>
<span class="line" id="L322">    sk_redirect_hash,</span>
<span class="line" id="L323">    lwt_push_encap,</span>
<span class="line" id="L324">    lwt_seg6_store_bytes,</span>
<span class="line" id="L325">    lwt_seg6_adjust_srh,</span>
<span class="line" id="L326">    lwt_seg6_action,</span>
<span class="line" id="L327">    rc_repeat,</span>
<span class="line" id="L328">    rc_keydown,</span>
<span class="line" id="L329">    skb_cgroup_id,</span>
<span class="line" id="L330">    get_current_cgroup_id,</span>
<span class="line" id="L331">    get_local_storage,</span>
<span class="line" id="L332">    sk_select_reuseport,</span>
<span class="line" id="L333">    skb_ancestor_cgroup_id,</span>
<span class="line" id="L334">    sk_lookup_tcp,</span>
<span class="line" id="L335">    sk_lookup_udp,</span>
<span class="line" id="L336">    sk_release,</span>
<span class="line" id="L337">    map_push_elem,</span>
<span class="line" id="L338">    map_pop_elem,</span>
<span class="line" id="L339">    map_peek_elem,</span>
<span class="line" id="L340">    msg_push_data,</span>
<span class="line" id="L341">    msg_pop_data,</span>
<span class="line" id="L342">    rc_pointer_rel,</span>
<span class="line" id="L343">    spin_lock,</span>
<span class="line" id="L344">    spin_unlock,</span>
<span class="line" id="L345">    sk_fullsock,</span>
<span class="line" id="L346">    tcp_sock,</span>
<span class="line" id="L347">    skb_ecn_set_ce,</span>
<span class="line" id="L348">    get_listener_sock,</span>
<span class="line" id="L349">    skc_lookup_tcp,</span>
<span class="line" id="L350">    tcp_check_syncookie,</span>
<span class="line" id="L351">    sysctl_get_name,</span>
<span class="line" id="L352">    sysctl_get_current_value,</span>
<span class="line" id="L353">    sysctl_get_new_value,</span>
<span class="line" id="L354">    sysctl_set_new_value,</span>
<span class="line" id="L355">    strtol,</span>
<span class="line" id="L356">    strtoul,</span>
<span class="line" id="L357">    sk_storage_get,</span>
<span class="line" id="L358">    sk_storage_delete,</span>
<span class="line" id="L359">    send_signal,</span>
<span class="line" id="L360">    tcp_gen_syncookie,</span>
<span class="line" id="L361">    skb_output,</span>
<span class="line" id="L362">    probe_read_user,</span>
<span class="line" id="L363">    probe_read_kernel,</span>
<span class="line" id="L364">    probe_read_user_str,</span>
<span class="line" id="L365">    probe_read_kernel_str,</span>
<span class="line" id="L366">    tcp_send_ack,</span>
<span class="line" id="L367">    send_signal_thread,</span>
<span class="line" id="L368">    jiffies64,</span>
<span class="line" id="L369">    read_branch_records,</span>
<span class="line" id="L370">    get_ns_current_pid_tgid,</span>
<span class="line" id="L371">    xdp_output,</span>
<span class="line" id="L372">    get_netns_cookie,</span>
<span class="line" id="L373">    get_current_ancestor_cgroup_id,</span>
<span class="line" id="L374">    sk_assign,</span>
<span class="line" id="L375">    ktime_get_boot_ns,</span>
<span class="line" id="L376">    seq_printf,</span>
<span class="line" id="L377">    seq_write,</span>
<span class="line" id="L378">    sk_cgroup_id,</span>
<span class="line" id="L379">    sk_ancestor_cgroup_id,</span>
<span class="line" id="L380">    ringbuf_output,</span>
<span class="line" id="L381">    ringbuf_reserve,</span>
<span class="line" id="L382">    ringbuf_submit,</span>
<span class="line" id="L383">    ringbuf_discard,</span>
<span class="line" id="L384">    ringbuf_query,</span>
<span class="line" id="L385">    csum_level,</span>
<span class="line" id="L386">    skc_to_tcp6_sock,</span>
<span class="line" id="L387">    skc_to_tcp_sock,</span>
<span class="line" id="L388">    skc_to_tcp_timewait_sock,</span>
<span class="line" id="L389">    skc_to_tcp_request_sock,</span>
<span class="line" id="L390">    skc_to_udp6_sock,</span>
<span class="line" id="L391">    get_task_stack,</span>
<span class="line" id="L392">    _,</span>
<span class="line" id="L393">};</span>
<span class="line" id="L394"></span>
<span class="line" id="L395"><span class="tok-comment">// TODO: determine that this is the expected bit layout for both little and big</span>
</span>
<span class="line" id="L396"><span class="tok-comment">// endian systems</span>
</span>
<span class="line" id="L397"><span class="tok-comment">/// a single BPF instruction</span></span>
<span class="line" id="L398"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Insn = <span class="tok-kw">packed</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L399">    code: <span class="tok-type">u8</span>,</span>
<span class="line" id="L400">    dst: <span class="tok-type">u4</span>,</span>
<span class="line" id="L401">    src: <span class="tok-type">u4</span>,</span>
<span class="line" id="L402">    off: <span class="tok-type">i16</span>,</span>
<span class="line" id="L403">    imm: <span class="tok-type">i32</span>,</span>
<span class="line" id="L404"></span>
<span class="line" id="L405">    <span class="tok-comment">/// r0 - r9 are general purpose 64-bit registers, r10 points to the stack</span></span>
<span class="line" id="L406">    <span class="tok-comment">/// frame</span></span>
<span class="line" id="L407">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Reg = <span class="tok-kw">enum</span>(<span class="tok-type">u4</span>) { r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10 };</span>
<span class="line" id="L408">    <span class="tok-kw">const</span> Source = <span class="tok-kw">enum</span>(<span class="tok-type">u1</span>) { reg, imm };</span>
<span class="line" id="L409"></span>
<span class="line" id="L410">    <span class="tok-kw">const</span> Mode = <span class="tok-kw">enum</span>(<span class="tok-type">u8</span>) {</span>
<span class="line" id="L411">        imm = IMM,</span>
<span class="line" id="L412">        abs = ABS,</span>
<span class="line" id="L413">        ind = IND,</span>
<span class="line" id="L414">        mem = MEM,</span>
<span class="line" id="L415">        len = LEN,</span>
<span class="line" id="L416">        msh = MSH,</span>
<span class="line" id="L417">    };</span>
<span class="line" id="L418"></span>
<span class="line" id="L419">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> AluOp = <span class="tok-kw">enum</span>(<span class="tok-type">u8</span>) {</span>
<span class="line" id="L420">        add = ADD,</span>
<span class="line" id="L421">        sub = SUB,</span>
<span class="line" id="L422">        mul = MUL,</span>
<span class="line" id="L423">        div = DIV,</span>
<span class="line" id="L424">        alu_or = OR,</span>
<span class="line" id="L425">        alu_and = AND,</span>
<span class="line" id="L426">        lsh = LSH,</span>
<span class="line" id="L427">        rsh = RSH,</span>
<span class="line" id="L428">        neg = NEG,</span>
<span class="line" id="L429">        mod = MOD,</span>
<span class="line" id="L430">        xor = XOR,</span>
<span class="line" id="L431">        mov = MOV,</span>
<span class="line" id="L432">        arsh = ARSH,</span>
<span class="line" id="L433">    };</span>
<span class="line" id="L434"></span>
<span class="line" id="L435">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> Size = <span class="tok-kw">enum</span>(<span class="tok-type">u8</span>) {</span>
<span class="line" id="L436">        byte = B,</span>
<span class="line" id="L437">        half_word = H,</span>
<span class="line" id="L438">        word = W,</span>
<span class="line" id="L439">        double_word = DW,</span>
<span class="line" id="L440">    };</span>
<span class="line" id="L441"></span>
<span class="line" id="L442">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> JmpOp = <span class="tok-kw">enum</span>(<span class="tok-type">u8</span>) {</span>
<span class="line" id="L443">        ja = JA,</span>
<span class="line" id="L444">        jeq = JEQ,</span>
<span class="line" id="L445">        jgt = JGT,</span>
<span class="line" id="L446">        jge = JGE,</span>
<span class="line" id="L447">        jset = JSET,</span>
<span class="line" id="L448">        jlt = JLT,</span>
<span class="line" id="L449">        jle = JLE,</span>
<span class="line" id="L450">        jne = JNE,</span>
<span class="line" id="L451">        jsgt = JSGT,</span>
<span class="line" id="L452">        jsge = JSGE,</span>
<span class="line" id="L453">        jslt = JSLT,</span>
<span class="line" id="L454">        jsle = JSLE,</span>
<span class="line" id="L455">    };</span>
<span class="line" id="L456"></span>
<span class="line" id="L457">    <span class="tok-kw">const</span> ImmOrReg = <span class="tok-kw">union</span>(Source) {</span>
<span class="line" id="L458">        imm: <span class="tok-type">i32</span>,</span>
<span class="line" id="L459">        reg: Reg,</span>
<span class="line" id="L460">    };</span>
<span class="line" id="L461"></span>
<span class="line" id="L462">    <span class="tok-kw">fn</span> <span class="tok-fn">imm_reg</span>(code: <span class="tok-type">u8</span>, dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L463">        <span class="tok-kw">const</span> imm_or_reg = <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(src) == Reg <span class="tok-kw">or</span> <span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(src)) == .EnumLiteral)</span>
<span class="line" id="L464">            ImmOrReg{ .reg = <span class="tok-builtin">@as</span>(Reg, src) }</span>
<span class="line" id="L465">        <span class="tok-kw">else</span></span>
<span class="line" id="L466">            ImmOrReg{ .imm = src };</span>
<span class="line" id="L467"></span>
<span class="line" id="L468">        <span class="tok-kw">const</span> src_type: <span class="tok-type">u8</span> = <span class="tok-kw">switch</span> (imm_or_reg) {</span>
<span class="line" id="L469">            .imm =&gt; K,</span>
<span class="line" id="L470">            .reg =&gt; X,</span>
<span class="line" id="L471">        };</span>
<span class="line" id="L472"></span>
<span class="line" id="L473">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L474">            .code = code | src_type,</span>
<span class="line" id="L475">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L476">            .src = <span class="tok-kw">switch</span> (imm_or_reg) {</span>
<span class="line" id="L477">                .imm =&gt; <span class="tok-number">0</span>,</span>
<span class="line" id="L478">                .reg =&gt; |r| <span class="tok-builtin">@intFromEnum</span>(r),</span>
<span class="line" id="L479">            },</span>
<span class="line" id="L480">            .off = off,</span>
<span class="line" id="L481">            .imm = <span class="tok-kw">switch</span> (imm_or_reg) {</span>
<span class="line" id="L482">                .imm =&gt; |i| i,</span>
<span class="line" id="L483">                .reg =&gt; <span class="tok-number">0</span>,</span>
<span class="line" id="L484">            },</span>
<span class="line" id="L485">        };</span>
<span class="line" id="L486">    }</span>
<span class="line" id="L487"></span>
<span class="line" id="L488">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">alu</span>(<span class="tok-kw">comptime</span> width: <span class="tok-type">comptime_int</span>, op: AluOp, dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L489">        <span class="tok-kw">const</span> width_bitfield = <span class="tok-kw">switch</span> (width) {</span>
<span class="line" id="L490">            <span class="tok-number">32</span> =&gt; ALU,</span>
<span class="line" id="L491">            <span class="tok-number">64</span> =&gt; ALU64,</span>
<span class="line" id="L492">            <span class="tok-kw">else</span> =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;width must be 32 or 64&quot;</span>),</span>
<span class="line" id="L493">        };</span>
<span class="line" id="L494"></span>
<span class="line" id="L495">        <span class="tok-kw">return</span> imm_reg(width_bitfield | <span class="tok-builtin">@intFromEnum</span>(op), dst, src, <span class="tok-number">0</span>);</span>
<span class="line" id="L496">    }</span>
<span class="line" id="L497"></span>
<span class="line" id="L498">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mov</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L499">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .mov, dst, src);</span>
<span class="line" id="L500">    }</span>
<span class="line" id="L501"></span>
<span class="line" id="L502">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L503">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .add, dst, src);</span>
<span class="line" id="L504">    }</span>
<span class="line" id="L505"></span>
<span class="line" id="L506">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sub</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L507">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .sub, dst, src);</span>
<span class="line" id="L508">    }</span>
<span class="line" id="L509"></span>
<span class="line" id="L510">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mul</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L511">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .mul, dst, src);</span>
<span class="line" id="L512">    }</span>
<span class="line" id="L513"></span>
<span class="line" id="L514">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">div</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L515">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .div, dst, src);</span>
<span class="line" id="L516">    }</span>
<span class="line" id="L517"></span>
<span class="line" id="L518">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">alu_or</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L519">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .alu_or, dst, src);</span>
<span class="line" id="L520">    }</span>
<span class="line" id="L521"></span>
<span class="line" id="L522">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">alu_and</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L523">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .alu_and, dst, src);</span>
<span class="line" id="L524">    }</span>
<span class="line" id="L525"></span>
<span class="line" id="L526">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lsh</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L527">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .lsh, dst, src);</span>
<span class="line" id="L528">    }</span>
<span class="line" id="L529"></span>
<span class="line" id="L530">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rsh</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L531">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .rsh, dst, src);</span>
<span class="line" id="L532">    }</span>
<span class="line" id="L533"></span>
<span class="line" id="L534">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">neg</span>(dst: Reg) Insn {</span>
<span class="line" id="L535">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .neg, dst, <span class="tok-number">0</span>);</span>
<span class="line" id="L536">    }</span>
<span class="line" id="L537"></span>
<span class="line" id="L538">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mod</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L539">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .mod, dst, src);</span>
<span class="line" id="L540">    }</span>
<span class="line" id="L541"></span>
<span class="line" id="L542">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">xor</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L543">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .xor, dst, src);</span>
<span class="line" id="L544">    }</span>
<span class="line" id="L545"></span>
<span class="line" id="L546">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">arsh</span>(dst: Reg, src: <span class="tok-kw">anytype</span>) Insn {</span>
<span class="line" id="L547">        <span class="tok-kw">return</span> alu(<span class="tok-number">64</span>, .arsh, dst, src);</span>
<span class="line" id="L548">    }</span>
<span class="line" id="L549"></span>
<span class="line" id="L550">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jmp</span>(op: JmpOp, dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L551">        <span class="tok-kw">return</span> imm_reg(JMP | <span class="tok-builtin">@intFromEnum</span>(op), dst, src, off);</span>
<span class="line" id="L552">    }</span>
<span class="line" id="L553"></span>
<span class="line" id="L554">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ja</span>(off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L555">        <span class="tok-kw">return</span> jmp(.ja, .r0, <span class="tok-number">0</span>, off);</span>
<span class="line" id="L556">    }</span>
<span class="line" id="L557"></span>
<span class="line" id="L558">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jeq</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L559">        <span class="tok-kw">return</span> jmp(.jeq, dst, src, off);</span>
<span class="line" id="L560">    }</span>
<span class="line" id="L561"></span>
<span class="line" id="L562">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jgt</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L563">        <span class="tok-kw">return</span> jmp(.jgt, dst, src, off);</span>
<span class="line" id="L564">    }</span>
<span class="line" id="L565"></span>
<span class="line" id="L566">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jge</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L567">        <span class="tok-kw">return</span> jmp(.jge, dst, src, off);</span>
<span class="line" id="L568">    }</span>
<span class="line" id="L569"></span>
<span class="line" id="L570">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jlt</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L571">        <span class="tok-kw">return</span> jmp(.jlt, dst, src, off);</span>
<span class="line" id="L572">    }</span>
<span class="line" id="L573"></span>
<span class="line" id="L574">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jle</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L575">        <span class="tok-kw">return</span> jmp(.jle, dst, src, off);</span>
<span class="line" id="L576">    }</span>
<span class="line" id="L577"></span>
<span class="line" id="L578">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jset</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L579">        <span class="tok-kw">return</span> jmp(.jset, dst, src, off);</span>
<span class="line" id="L580">    }</span>
<span class="line" id="L581"></span>
<span class="line" id="L582">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jne</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L583">        <span class="tok-kw">return</span> jmp(.jne, dst, src, off);</span>
<span class="line" id="L584">    }</span>
<span class="line" id="L585"></span>
<span class="line" id="L586">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jsgt</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L587">        <span class="tok-kw">return</span> jmp(.jsgt, dst, src, off);</span>
<span class="line" id="L588">    }</span>
<span class="line" id="L589"></span>
<span class="line" id="L590">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jsge</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L591">        <span class="tok-kw">return</span> jmp(.jsge, dst, src, off);</span>
<span class="line" id="L592">    }</span>
<span class="line" id="L593"></span>
<span class="line" id="L594">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jslt</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L595">        <span class="tok-kw">return</span> jmp(.jslt, dst, src, off);</span>
<span class="line" id="L596">    }</span>
<span class="line" id="L597"></span>
<span class="line" id="L598">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">jsle</span>(dst: Reg, src: <span class="tok-kw">anytype</span>, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L599">        <span class="tok-kw">return</span> jmp(.jsle, dst, src, off);</span>
<span class="line" id="L600">    }</span>
<span class="line" id="L601"></span>
<span class="line" id="L602">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">xadd</span>(dst: Reg, src: Reg) Insn {</span>
<span class="line" id="L603">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L604">            .code = STX | XADD | DW,</span>
<span class="line" id="L605">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L606">            .src = <span class="tok-builtin">@intFromEnum</span>(src),</span>
<span class="line" id="L607">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L608">            .imm = <span class="tok-number">0</span>,</span>
<span class="line" id="L609">        };</span>
<span class="line" id="L610">    }</span>
<span class="line" id="L611"></span>
<span class="line" id="L612">    <span class="tok-kw">fn</span> <span class="tok-fn">ld</span>(mode: Mode, size: Size, dst: Reg, src: Reg, imm: <span class="tok-type">i32</span>) Insn {</span>
<span class="line" id="L613">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L614">            .code = <span class="tok-builtin">@intFromEnum</span>(mode) | <span class="tok-builtin">@intFromEnum</span>(size) | LD,</span>
<span class="line" id="L615">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L616">            .src = <span class="tok-builtin">@intFromEnum</span>(src),</span>
<span class="line" id="L617">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L618">            .imm = imm,</span>
<span class="line" id="L619">        };</span>
<span class="line" id="L620">    }</span>
<span class="line" id="L621"></span>
<span class="line" id="L622">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_abs</span>(size: Size, dst: Reg, src: Reg, imm: <span class="tok-type">i32</span>) Insn {</span>
<span class="line" id="L623">        <span class="tok-kw">return</span> ld(.abs, size, dst, src, imm);</span>
<span class="line" id="L624">    }</span>
<span class="line" id="L625"></span>
<span class="line" id="L626">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_ind</span>(size: Size, dst: Reg, src: Reg, imm: <span class="tok-type">i32</span>) Insn {</span>
<span class="line" id="L627">        <span class="tok-kw">return</span> ld(.ind, size, dst, src, imm);</span>
<span class="line" id="L628">    }</span>
<span class="line" id="L629"></span>
<span class="line" id="L630">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ldx</span>(size: Size, dst: Reg, src: Reg, off: <span class="tok-type">i16</span>) Insn {</span>
<span class="line" id="L631">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L632">            .code = MEM | <span class="tok-builtin">@intFromEnum</span>(size) | LDX,</span>
<span class="line" id="L633">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L634">            .src = <span class="tok-builtin">@intFromEnum</span>(src),</span>
<span class="line" id="L635">            .off = off,</span>
<span class="line" id="L636">            .imm = <span class="tok-number">0</span>,</span>
<span class="line" id="L637">        };</span>
<span class="line" id="L638">    }</span>
<span class="line" id="L639"></span>
<span class="line" id="L640">    <span class="tok-kw">fn</span> <span class="tok-fn">ld_imm_impl1</span>(dst: Reg, src: Reg, imm: <span class="tok-type">u64</span>) Insn {</span>
<span class="line" id="L641">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L642">            .code = LD | DW | IMM,</span>
<span class="line" id="L643">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L644">            .src = <span class="tok-builtin">@intFromEnum</span>(src),</span>
<span class="line" id="L645">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L646">            .imm = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(imm)))),</span>
<span class="line" id="L647">        };</span>
<span class="line" id="L648">    }</span>
<span class="line" id="L649"></span>
<span class="line" id="L650">    <span class="tok-kw">fn</span> <span class="tok-fn">ld_imm_impl2</span>(imm: <span class="tok-type">u64</span>) Insn {</span>
<span class="line" id="L651">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L652">            .code = <span class="tok-number">0</span>,</span>
<span class="line" id="L653">            .dst = <span class="tok-number">0</span>,</span>
<span class="line" id="L654">            .src = <span class="tok-number">0</span>,</span>
<span class="line" id="L655">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L656">            .imm = <span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@truncate</span>(imm &gt;&gt; <span class="tok-number">32</span>)))),</span>
<span class="line" id="L657">        };</span>
<span class="line" id="L658">    }</span>
<span class="line" id="L659"></span>
<span class="line" id="L660">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_dw1</span>(dst: Reg, imm: <span class="tok-type">u64</span>) Insn {</span>
<span class="line" id="L661">        <span class="tok-kw">return</span> ld_imm_impl1(dst, .r0, imm);</span>
<span class="line" id="L662">    }</span>
<span class="line" id="L663"></span>
<span class="line" id="L664">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_dw2</span>(imm: <span class="tok-type">u64</span>) Insn {</span>
<span class="line" id="L665">        <span class="tok-kw">return</span> ld_imm_impl2(imm);</span>
<span class="line" id="L666">    }</span>
<span class="line" id="L667"></span>
<span class="line" id="L668">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_map_fd1</span>(dst: Reg, map_fd: fd_t) Insn {</span>
<span class="line" id="L669">        <span class="tok-kw">return</span> ld_imm_impl1(dst, <span class="tok-builtin">@as</span>(Reg, <span class="tok-builtin">@enumFromInt</span>(PSEUDO_MAP_FD)), <span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@intCast</span>(map_fd)));</span>
<span class="line" id="L670">    }</span>
<span class="line" id="L671"></span>
<span class="line" id="L672">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ld_map_fd2</span>(map_fd: fd_t) Insn {</span>
<span class="line" id="L673">        <span class="tok-kw">return</span> ld_imm_impl2(<span class="tok-builtin">@as</span>(<span class="tok-type">u64</span>, <span class="tok-builtin">@intCast</span>(map_fd)));</span>
<span class="line" id="L674">    }</span>
<span class="line" id="L675"></span>
<span class="line" id="L676">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">st</span>(<span class="tok-kw">comptime</span> size: Size, dst: Reg, off: <span class="tok-type">i16</span>, imm: <span class="tok-type">i32</span>) Insn {</span>
<span class="line" id="L677">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L678">            .code = MEM | <span class="tok-builtin">@intFromEnum</span>(size) | ST,</span>
<span class="line" id="L679">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L680">            .src = <span class="tok-number">0</span>,</span>
<span class="line" id="L681">            .off = off,</span>
<span class="line" id="L682">            .imm = imm,</span>
<span class="line" id="L683">        };</span>
<span class="line" id="L684">    }</span>
<span class="line" id="L685"></span>
<span class="line" id="L686">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">stx</span>(size: Size, dst: Reg, off: <span class="tok-type">i16</span>, src: Reg) Insn {</span>
<span class="line" id="L687">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L688">            .code = MEM | <span class="tok-builtin">@intFromEnum</span>(size) | STX,</span>
<span class="line" id="L689">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L690">            .src = <span class="tok-builtin">@intFromEnum</span>(src),</span>
<span class="line" id="L691">            .off = off,</span>
<span class="line" id="L692">            .imm = <span class="tok-number">0</span>,</span>
<span class="line" id="L693">        };</span>
<span class="line" id="L694">    }</span>
<span class="line" id="L695"></span>
<span class="line" id="L696">    <span class="tok-kw">fn</span> <span class="tok-fn">endian_swap</span>(endian: std.builtin.Endian, <span class="tok-kw">comptime</span> size: Size, dst: Reg) Insn {</span>
<span class="line" id="L697">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L698">            .code = <span class="tok-kw">switch</span> (endian) {</span>
<span class="line" id="L699">                .Big =&gt; <span class="tok-number">0xdc</span>,</span>
<span class="line" id="L700">                .Little =&gt; <span class="tok-number">0xd4</span>,</span>
<span class="line" id="L701">            },</span>
<span class="line" id="L702">            .dst = <span class="tok-builtin">@intFromEnum</span>(dst),</span>
<span class="line" id="L703">            .src = <span class="tok-number">0</span>,</span>
<span class="line" id="L704">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L705">            .imm = <span class="tok-kw">switch</span> (size) {</span>
<span class="line" id="L706">                .byte =&gt; <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;can't swap a single byte&quot;</span>),</span>
<span class="line" id="L707">                .half_word =&gt; <span class="tok-number">16</span>,</span>
<span class="line" id="L708">                .word =&gt; <span class="tok-number">32</span>,</span>
<span class="line" id="L709">                .double_word =&gt; <span class="tok-number">64</span>,</span>
<span class="line" id="L710">            },</span>
<span class="line" id="L711">        };</span>
<span class="line" id="L712">    }</span>
<span class="line" id="L713"></span>
<span class="line" id="L714">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">le</span>(<span class="tok-kw">comptime</span> size: Size, dst: Reg) Insn {</span>
<span class="line" id="L715">        <span class="tok-kw">return</span> endian_swap(.Little, size, dst);</span>
<span class="line" id="L716">    }</span>
<span class="line" id="L717"></span>
<span class="line" id="L718">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">be</span>(<span class="tok-kw">comptime</span> size: Size, dst: Reg) Insn {</span>
<span class="line" id="L719">        <span class="tok-kw">return</span> endian_swap(.Big, size, dst);</span>
<span class="line" id="L720">    }</span>
<span class="line" id="L721"></span>
<span class="line" id="L722">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">call</span>(helper: Helper) Insn {</span>
<span class="line" id="L723">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L724">            .code = JMP | CALL,</span>
<span class="line" id="L725">            .dst = <span class="tok-number">0</span>,</span>
<span class="line" id="L726">            .src = <span class="tok-number">0</span>,</span>
<span class="line" id="L727">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L728">            .imm = <span class="tok-builtin">@intFromEnum</span>(helper),</span>
<span class="line" id="L729">        };</span>
<span class="line" id="L730">    }</span>
<span class="line" id="L731"></span>
<span class="line" id="L732">    <span class="tok-comment">/// exit BPF program</span></span>
<span class="line" id="L733">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">exit</span>() Insn {</span>
<span class="line" id="L734">        <span class="tok-kw">return</span> Insn{</span>
<span class="line" id="L735">            .code = JMP | EXIT,</span>
<span class="line" id="L736">            .dst = <span class="tok-number">0</span>,</span>
<span class="line" id="L737">            .src = <span class="tok-number">0</span>,</span>
<span class="line" id="L738">            .off = <span class="tok-number">0</span>,</span>
<span class="line" id="L739">            .imm = <span class="tok-number">0</span>,</span>
<span class="line" id="L740">        };</span>
<span class="line" id="L741">    }</span>
<span class="line" id="L742">};</span>
<span class="line" id="L743"></span>
<span class="line" id="L744"><span class="tok-kw">test</span> <span class="tok-str">&quot;insn bitsize&quot;</span> {</span>
<span class="line" id="L745">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@bitSizeOf</span>(Insn), <span class="tok-number">64</span>);</span>
<span class="line" id="L746">}</span>
<span class="line" id="L747"></span>
<span class="line" id="L748"><span class="tok-kw">fn</span> <span class="tok-fn">expect_opcode</span>(code: <span class="tok-type">u8</span>, insn: Insn) !<span class="tok-type">void</span> {</span>
<span class="line" id="L749">    <span class="tok-kw">try</span> expectEqual(code, insn.code);</span>
<span class="line" id="L750">}</span>
<span class="line" id="L751"></span>
<span class="line" id="L752"><span class="tok-comment">// The opcodes were grabbed from https://github.com/iovisor/bpf-docs/blob/master/eBPF.md</span>
</span>
<span class="line" id="L753"><span class="tok-kw">test</span> <span class="tok-str">&quot;opcodes&quot;</span> {</span>
<span class="line" id="L754">    <span class="tok-comment">// instructions that have a name that end with 1 or 2 are consecutive for</span>
</span>
<span class="line" id="L755">    <span class="tok-comment">// loading 64-bit immediates (imm is only 32 bits wide)</span>
</span>
<span class="line" id="L756"></span>
<span class="line" id="L757">    <span class="tok-comment">// alu instructions</span>
</span>
<span class="line" id="L758">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x07</span>, Insn.add(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L759">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x0f</span>, Insn.add(.r1, .r2));</span>
<span class="line" id="L760">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x17</span>, Insn.sub(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L761">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x1f</span>, Insn.sub(.r1, .r2));</span>
<span class="line" id="L762">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x27</span>, Insn.mul(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L763">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x2f</span>, Insn.mul(.r1, .r2));</span>
<span class="line" id="L764">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x37</span>, Insn.div(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L765">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x3f</span>, Insn.div(.r1, .r2));</span>
<span class="line" id="L766">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x47</span>, Insn.alu_or(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L767">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x4f</span>, Insn.alu_or(.r1, .r2));</span>
<span class="line" id="L768">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x57</span>, Insn.alu_and(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L769">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x5f</span>, Insn.alu_and(.r1, .r2));</span>
<span class="line" id="L770">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x67</span>, Insn.lsh(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L771">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x6f</span>, Insn.lsh(.r1, .r2));</span>
<span class="line" id="L772">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x77</span>, Insn.rsh(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L773">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x7f</span>, Insn.rsh(.r1, .r2));</span>
<span class="line" id="L774">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x87</span>, Insn.neg(.r1));</span>
<span class="line" id="L775">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x97</span>, Insn.mod(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L776">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x9f</span>, Insn.mod(.r1, .r2));</span>
<span class="line" id="L777">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xa7</span>, Insn.xor(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L778">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xaf</span>, Insn.xor(.r1, .r2));</span>
<span class="line" id="L779">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xb7</span>, Insn.mov(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L780">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xbf</span>, Insn.mov(.r1, .r2));</span>
<span class="line" id="L781">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xc7</span>, Insn.arsh(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L782">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xcf</span>, Insn.arsh(.r1, .r2));</span>
<span class="line" id="L783"></span>
<span class="line" id="L784">    <span class="tok-comment">// atomic instructions: might be more of these not documented in the wild</span>
</span>
<span class="line" id="L785">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xdb</span>, Insn.xadd(.r1, .r2));</span>
<span class="line" id="L786"></span>
<span class="line" id="L787">    <span class="tok-comment">// TODO: byteswap instructions</span>
</span>
<span class="line" id="L788">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xd4</span>, Insn.le(.half_word, .r1));</span>
<span class="line" id="L789">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">16</span>)), Insn.le(.half_word, .r1).imm);</span>
<span class="line" id="L790">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xd4</span>, Insn.le(.word, .r1));</span>
<span class="line" id="L791">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">32</span>)), Insn.le(.word, .r1).imm);</span>
<span class="line" id="L792">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xd4</span>, Insn.le(.double_word, .r1));</span>
<span class="line" id="L793">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">64</span>)), Insn.le(.double_word, .r1).imm);</span>
<span class="line" id="L794">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xdc</span>, Insn.be(.half_word, .r1));</span>
<span class="line" id="L795">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">16</span>)), Insn.be(.half_word, .r1).imm);</span>
<span class="line" id="L796">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xdc</span>, Insn.be(.word, .r1));</span>
<span class="line" id="L797">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">32</span>)), Insn.be(.word, .r1).imm);</span>
<span class="line" id="L798">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xdc</span>, Insn.be(.double_word, .r1));</span>
<span class="line" id="L799">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">i32</span>, <span class="tok-builtin">@intCast</span>(<span class="tok-number">64</span>)), Insn.be(.double_word, .r1).imm);</span>
<span class="line" id="L800"></span>
<span class="line" id="L801">    <span class="tok-comment">// memory instructions</span>
</span>
<span class="line" id="L802">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x18</span>, Insn.ld_dw1(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L803">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x00</span>, Insn.ld_dw2(<span class="tok-number">0</span>));</span>
<span class="line" id="L804"></span>
<span class="line" id="L805">    <span class="tok-comment">//   loading a map fd</span>
</span>
<span class="line" id="L806">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x18</span>, Insn.ld_map_fd1(.r1, <span class="tok-number">0</span>));</span>
<span class="line" id="L807">    <span class="tok-kw">try</span> expectEqual(<span class="tok-builtin">@as</span>(<span class="tok-type">u4</span>, <span class="tok-builtin">@intCast</span>(PSEUDO_MAP_FD)), Insn.ld_map_fd1(.r1, <span class="tok-number">0</span>).src);</span>
<span class="line" id="L808">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x00</span>, Insn.ld_map_fd2(<span class="tok-number">0</span>));</span>
<span class="line" id="L809"></span>
<span class="line" id="L810">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x38</span>, Insn.ld_abs(.double_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L811">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x20</span>, Insn.ld_abs(.word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L812">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x28</span>, Insn.ld_abs(.half_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L813">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x30</span>, Insn.ld_abs(.byte, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L814"></span>
<span class="line" id="L815">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x58</span>, Insn.ld_ind(.double_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L816">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x40</span>, Insn.ld_ind(.word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L817">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x48</span>, Insn.ld_ind(.half_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L818">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x50</span>, Insn.ld_ind(.byte, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L819"></span>
<span class="line" id="L820">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x79</span>, Insn.ldx(.double_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L821">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x61</span>, Insn.ldx(.word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L822">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x69</span>, Insn.ldx(.half_word, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L823">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x71</span>, Insn.ldx(.byte, .r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L824"></span>
<span class="line" id="L825">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x62</span>, Insn.st(.word, .r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L826">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x6a</span>, Insn.st(.half_word, .r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L827">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x72</span>, Insn.st(.byte, .r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L828"></span>
<span class="line" id="L829">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x63</span>, Insn.stx(.word, .r1, <span class="tok-number">0</span>, .r2));</span>
<span class="line" id="L830">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x6b</span>, Insn.stx(.half_word, .r1, <span class="tok-number">0</span>, .r2));</span>
<span class="line" id="L831">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x73</span>, Insn.stx(.byte, .r1, <span class="tok-number">0</span>, .r2));</span>
<span class="line" id="L832">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x7b</span>, Insn.stx(.double_word, .r1, <span class="tok-number">0</span>, .r2));</span>
<span class="line" id="L833"></span>
<span class="line" id="L834">    <span class="tok-comment">// branch instructions</span>
</span>
<span class="line" id="L835">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x05</span>, Insn.ja(<span class="tok-number">0</span>));</span>
<span class="line" id="L836">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x15</span>, Insn.jeq(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L837">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x1d</span>, Insn.jeq(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L838">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x25</span>, Insn.jgt(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L839">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x2d</span>, Insn.jgt(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L840">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x35</span>, Insn.jge(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L841">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x3d</span>, Insn.jge(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L842">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xa5</span>, Insn.jlt(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L843">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xad</span>, Insn.jlt(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L844">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xb5</span>, Insn.jle(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L845">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xbd</span>, Insn.jle(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L846">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x45</span>, Insn.jset(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L847">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x4d</span>, Insn.jset(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L848">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x55</span>, Insn.jne(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L849">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x5d</span>, Insn.jne(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L850">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x65</span>, Insn.jsgt(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L851">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x6d</span>, Insn.jsgt(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L852">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x75</span>, Insn.jsge(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L853">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x7d</span>, Insn.jsge(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L854">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xc5</span>, Insn.jslt(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L855">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xcd</span>, Insn.jslt(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L856">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xd5</span>, Insn.jsle(.r1, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L857">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0xdd</span>, Insn.jsle(.r1, .r2, <span class="tok-number">0</span>));</span>
<span class="line" id="L858">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x85</span>, Insn.call(.unspec));</span>
<span class="line" id="L859">    <span class="tok-kw">try</span> expect_opcode(<span class="tok-number">0x95</span>, Insn.exit());</span>
<span class="line" id="L860">}</span>
<span class="line" id="L861"></span>
<span class="line" id="L862"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Cmd = <span class="tok-kw">enum</span>(<span class="tok-type">usize</span>) {</span>
<span class="line" id="L863">    <span class="tok-comment">/// Create  a map and return a file descriptor that refers to the map.  The</span></span>
<span class="line" id="L864">    <span class="tok-comment">/// close-on-exec file descriptor flag is automatically enabled for the new</span></span>
<span class="line" id="L865">    <span class="tok-comment">/// file descriptor.</span></span>
<span class="line" id="L866">    <span class="tok-comment">///</span></span>
<span class="line" id="L867">    <span class="tok-comment">/// uses MapCreateAttr</span></span>
<span class="line" id="L868">    map_create,</span>
<span class="line" id="L869"></span>
<span class="line" id="L870">    <span class="tok-comment">/// Look up an element by key in a specified map and return its value.</span></span>
<span class="line" id="L871">    <span class="tok-comment">///</span></span>
<span class="line" id="L872">    <span class="tok-comment">/// uses MapElemAttr</span></span>
<span class="line" id="L873">    map_lookup_elem,</span>
<span class="line" id="L874"></span>
<span class="line" id="L875">    <span class="tok-comment">/// Create or update an element (key/value pair) in a specified map.</span></span>
<span class="line" id="L876">    <span class="tok-comment">///</span></span>
<span class="line" id="L877">    <span class="tok-comment">/// uses MapElemAttr</span></span>
<span class="line" id="L878">    map_update_elem,</span>
<span class="line" id="L879"></span>
<span class="line" id="L880">    <span class="tok-comment">/// Look up and delete an element by key in a specified map.</span></span>
<span class="line" id="L881">    <span class="tok-comment">///</span></span>
<span class="line" id="L882">    <span class="tok-comment">/// uses MapElemAttr</span></span>
<span class="line" id="L883">    map_delete_elem,</span>
<span class="line" id="L884"></span>
<span class="line" id="L885">    <span class="tok-comment">/// Look up an element by key in a specified map and return the key of the</span></span>
<span class="line" id="L886">    <span class="tok-comment">/// next element.</span></span>
<span class="line" id="L887">    map_get_next_key,</span>
<span class="line" id="L888"></span>
<span class="line" id="L889">    <span class="tok-comment">/// Verify and load an eBPF program, returning a new file descriptor</span></span>
<span class="line" id="L890">    <span class="tok-comment">/// associated with  the  program.   The close-on-exec file descriptor flag</span></span>
<span class="line" id="L891">    <span class="tok-comment">/// is automatically enabled for the new file descriptor.</span></span>
<span class="line" id="L892">    <span class="tok-comment">///</span></span>
<span class="line" id="L893">    <span class="tok-comment">/// uses ProgLoadAttr</span></span>
<span class="line" id="L894">    prog_load,</span>
<span class="line" id="L895"></span>
<span class="line" id="L896">    <span class="tok-comment">/// Pin a map or eBPF program to a path within the minimal BPF filesystem</span></span>
<span class="line" id="L897">    <span class="tok-comment">///</span></span>
<span class="line" id="L898">    <span class="tok-comment">/// uses ObjAttr</span></span>
<span class="line" id="L899">    obj_pin,</span>
<span class="line" id="L900"></span>
<span class="line" id="L901">    <span class="tok-comment">/// Get the file descriptor of a BPF object pinned to a certain path</span></span>
<span class="line" id="L902">    <span class="tok-comment">///</span></span>
<span class="line" id="L903">    <span class="tok-comment">/// uses ObjAttr</span></span>
<span class="line" id="L904">    obj_get,</span>
<span class="line" id="L905"></span>
<span class="line" id="L906">    <span class="tok-comment">/// uses ProgAttachAttr</span></span>
<span class="line" id="L907">    prog_attach,</span>
<span class="line" id="L908"></span>
<span class="line" id="L909">    <span class="tok-comment">/// uses ProgAttachAttr</span></span>
<span class="line" id="L910">    prog_detach,</span>
<span class="line" id="L911"></span>
<span class="line" id="L912">    <span class="tok-comment">/// uses TestRunAttr</span></span>
<span class="line" id="L913">    prog_test_run,</span>
<span class="line" id="L914"></span>
<span class="line" id="L915">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L916">    prog_get_next_id,</span>
<span class="line" id="L917"></span>
<span class="line" id="L918">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L919">    map_get_next_id,</span>
<span class="line" id="L920"></span>
<span class="line" id="L921">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L922">    prog_get_fd_by_id,</span>
<span class="line" id="L923"></span>
<span class="line" id="L924">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L925">    map_get_fd_by_id,</span>
<span class="line" id="L926"></span>
<span class="line" id="L927">    <span class="tok-comment">/// uses InfoAttr</span></span>
<span class="line" id="L928">    obj_get_info_by_fd,</span>
<span class="line" id="L929"></span>
<span class="line" id="L930">    <span class="tok-comment">/// uses QueryAttr</span></span>
<span class="line" id="L931">    prog_query,</span>
<span class="line" id="L932"></span>
<span class="line" id="L933">    <span class="tok-comment">/// uses RawTracepointAttr</span></span>
<span class="line" id="L934">    raw_tracepoint_open,</span>
<span class="line" id="L935"></span>
<span class="line" id="L936">    <span class="tok-comment">/// uses BtfLoadAttr</span></span>
<span class="line" id="L937">    btf_load,</span>
<span class="line" id="L938"></span>
<span class="line" id="L939">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L940">    btf_get_fd_by_id,</span>
<span class="line" id="L941"></span>
<span class="line" id="L942">    <span class="tok-comment">/// uses TaskFdQueryAttr</span></span>
<span class="line" id="L943">    task_fd_query,</span>
<span class="line" id="L944"></span>
<span class="line" id="L945">    <span class="tok-comment">/// uses MapElemAttr</span></span>
<span class="line" id="L946">    map_lookup_and_delete_elem,</span>
<span class="line" id="L947">    map_freeze,</span>
<span class="line" id="L948"></span>
<span class="line" id="L949">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L950">    btf_get_next_id,</span>
<span class="line" id="L951"></span>
<span class="line" id="L952">    <span class="tok-comment">/// uses MapBatchAttr</span></span>
<span class="line" id="L953">    map_lookup_batch,</span>
<span class="line" id="L954"></span>
<span class="line" id="L955">    <span class="tok-comment">/// uses MapBatchAttr</span></span>
<span class="line" id="L956">    map_lookup_and_delete_batch,</span>
<span class="line" id="L957"></span>
<span class="line" id="L958">    <span class="tok-comment">/// uses MapBatchAttr</span></span>
<span class="line" id="L959">    map_update_batch,</span>
<span class="line" id="L960"></span>
<span class="line" id="L961">    <span class="tok-comment">/// uses MapBatchAttr</span></span>
<span class="line" id="L962">    map_delete_batch,</span>
<span class="line" id="L963"></span>
<span class="line" id="L964">    <span class="tok-comment">/// uses LinkCreateAttr</span></span>
<span class="line" id="L965">    link_create,</span>
<span class="line" id="L966"></span>
<span class="line" id="L967">    <span class="tok-comment">/// uses LinkUpdateAttr</span></span>
<span class="line" id="L968">    link_update,</span>
<span class="line" id="L969"></span>
<span class="line" id="L970">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L971">    link_get_fd_by_id,</span>
<span class="line" id="L972"></span>
<span class="line" id="L973">    <span class="tok-comment">/// uses GetIdAttr</span></span>
<span class="line" id="L974">    link_get_next_id,</span>
<span class="line" id="L975"></span>
<span class="line" id="L976">    <span class="tok-comment">/// uses EnableStatsAttr</span></span>
<span class="line" id="L977">    enable_stats,</span>
<span class="line" id="L978"></span>
<span class="line" id="L979">    <span class="tok-comment">/// uses IterCreateAttr</span></span>
<span class="line" id="L980">    iter_create,</span>
<span class="line" id="L981">    link_detach,</span>
<span class="line" id="L982">    _,</span>
<span class="line" id="L983">};</span>
<span class="line" id="L984"></span>
<span class="line" id="L985"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MapType = <span class="tok-kw">enum</span>(<span class="tok-type">u32</span>) {</span>
<span class="line" id="L986">    unspec,</span>
<span class="line" id="L987">    hash,</span>
<span class="line" id="L988">    array,</span>
<span class="line" id="L989">    prog_array,</span>
<span class="line" id="L990">    perf_event_array,</span>
<span class="line" id="L991">    percpu_hash,</span>
<span class="line" id="L992">    percpu_array,</span>
<span class="line" id="L993">    stack_trace,</span>
<span class="line" id="L994">    cgroup_array,</span>
<span class="line" id="L995">    lru_hash,</span>
<span class="line" id="L996">    lru_percpu_hash,</span>
<span class="line" id="L997">    lpm_trie,</span>
<span class="line" id="L998">    array_of_maps,</span>
<span class="line" id="L999">    hash_of_maps,</span>
<span class="line" id="L1000">    devmap,</span>
<span class="line" id="L1001">    sockmap,</span>
<span class="line" id="L1002">    cpumap,</span>
<span class="line" id="L1003">    xskmap,</span>
<span class="line" id="L1004">    sockhash,</span>
<span class="line" id="L1005">    cgroup_storage,</span>
<span class="line" id="L1006">    reuseport_sockarray,</span>
<span class="line" id="L1007">    percpu_cgroup_storage,</span>
<span class="line" id="L1008">    queue,</span>
<span class="line" id="L1009">    stack,</span>
<span class="line" id="L1010">    sk_storage,</span>
<span class="line" id="L1011">    devmap_hash,</span>
<span class="line" id="L1012">    struct_ops,</span>
<span class="line" id="L1013"></span>
<span class="line" id="L1014">    <span class="tok-comment">/// An ordered and shared CPU version of perf_event_array. They have</span></span>
<span class="line" id="L1015">    <span class="tok-comment">/// similar semantics:</span></span>
<span class="line" id="L1016">    <span class="tok-comment">///     - variable length records</span></span>
<span class="line" id="L1017">    <span class="tok-comment">///     - no blocking: when full, reservation fails</span></span>
<span class="line" id="L1018">    <span class="tok-comment">///     - memory mappable for ease and speed</span></span>
<span class="line" id="L1019">    <span class="tok-comment">///     - epoll notifications for new data, but can busy poll</span></span>
<span class="line" id="L1020">    <span class="tok-comment">///</span></span>
<span class="line" id="L1021">    <span class="tok-comment">/// Ringbufs give BPF programs two sets of APIs:</span></span>
<span class="line" id="L1022">    <span class="tok-comment">///     - ringbuf_output() allows copy data from one place to a ring</span></span>
<span class="line" id="L1023">    <span class="tok-comment">///     buffer, similar to bpf_perf_event_output()</span></span>
<span class="line" id="L1024">    <span class="tok-comment">///     - ringbuf_reserve()/ringbuf_commit()/ringbuf_discard() split the</span></span>
<span class="line" id="L1025">    <span class="tok-comment">///     process into two steps. First a fixed amount of space is reserved,</span></span>
<span class="line" id="L1026">    <span class="tok-comment">///     if that is successful then the program gets a pointer to a chunk of</span></span>
<span class="line" id="L1027">    <span class="tok-comment">///     memory and can be submitted with commit() or discarded with</span></span>
<span class="line" id="L1028">    <span class="tok-comment">///     discard()</span></span>
<span class="line" id="L1029">    <span class="tok-comment">///</span></span>
<span class="line" id="L1030">    <span class="tok-comment">/// ringbuf_output() will incurr an extra memory copy, but allows to submit</span></span>
<span class="line" id="L1031">    <span class="tok-comment">/// records of the length that's not known beforehand, and is an easy</span></span>
<span class="line" id="L1032">    <span class="tok-comment">/// replacement for perf_event_outptu().</span></span>
<span class="line" id="L1033">    <span class="tok-comment">///</span></span>
<span class="line" id="L1034">    <span class="tok-comment">/// ringbuf_reserve() avoids the extra memory copy but requires a known size</span></span>
<span class="line" id="L1035">    <span class="tok-comment">/// of memory beforehand.</span></span>
<span class="line" id="L1036">    <span class="tok-comment">///</span></span>
<span class="line" id="L1037">    <span class="tok-comment">/// ringbuf_query() allows to query properties of the map, 4 are currently</span></span>
<span class="line" id="L1038">    <span class="tok-comment">/// supported:</span></span>
<span class="line" id="L1039">    <span class="tok-comment">///     - BPF_RB_AVAIL_DATA: amount of unconsumed data in ringbuf</span></span>
<span class="line" id="L1040">    <span class="tok-comment">///     - BPF_RB_RING_SIZE: returns size of ringbuf</span></span>
<span class="line" id="L1041">    <span class="tok-comment">///     - BPF_RB_CONS_POS/BPF_RB_PROD_POS returns current logical position</span></span>
<span class="line" id="L1042">    <span class="tok-comment">///     of consumer and producer respectively</span></span>
<span class="line" id="L1043">    <span class="tok-comment">///</span></span>
<span class="line" id="L1044">    <span class="tok-comment">/// key size: 0</span></span>
<span class="line" id="L1045">    <span class="tok-comment">/// value size: 0</span></span>
<span class="line" id="L1046">    <span class="tok-comment">/// max entries: size of ringbuf, must be power of 2</span></span>
<span class="line" id="L1047">    ringbuf,</span>
<span class="line" id="L1048"></span>
<span class="line" id="L1049">    _,</span>
<span class="line" id="L1050">};</span>
<span class="line" id="L1051"></span>
<span class="line" id="L1052"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ProgType = <span class="tok-kw">enum</span>(<span class="tok-type">u32</span>) {</span>
<span class="line" id="L1053">    unspec,</span>
<span class="line" id="L1054"></span>
<span class="line" id="L1055">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1056">    socket_filter,</span>
<span class="line" id="L1057"></span>
<span class="line" id="L1058">    <span class="tok-comment">/// context type: bpf_user_pt_regs_t</span></span>
<span class="line" id="L1059">    kprobe,</span>
<span class="line" id="L1060"></span>
<span class="line" id="L1061">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1062">    sched_cls,</span>
<span class="line" id="L1063"></span>
<span class="line" id="L1064">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1065">    sched_act,</span>
<span class="line" id="L1066"></span>
<span class="line" id="L1067">    <span class="tok-comment">/// context type: u64</span></span>
<span class="line" id="L1068">    tracepoint,</span>
<span class="line" id="L1069"></span>
<span class="line" id="L1070">    <span class="tok-comment">/// context type: xdp_md</span></span>
<span class="line" id="L1071">    xdp,</span>
<span class="line" id="L1072"></span>
<span class="line" id="L1073">    <span class="tok-comment">/// context type: bpf_perf_event_data</span></span>
<span class="line" id="L1074">    perf_event,</span>
<span class="line" id="L1075"></span>
<span class="line" id="L1076">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1077">    cgroup_skb,</span>
<span class="line" id="L1078"></span>
<span class="line" id="L1079">    <span class="tok-comment">/// context type: bpf_sock</span></span>
<span class="line" id="L1080">    cgroup_sock,</span>
<span class="line" id="L1081"></span>
<span class="line" id="L1082">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1083">    lwt_in,</span>
<span class="line" id="L1084"></span>
<span class="line" id="L1085">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1086">    lwt_out,</span>
<span class="line" id="L1087"></span>
<span class="line" id="L1088">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1089">    lwt_xmit,</span>
<span class="line" id="L1090"></span>
<span class="line" id="L1091">    <span class="tok-comment">/// context type: bpf_sock_ops</span></span>
<span class="line" id="L1092">    sock_ops,</span>
<span class="line" id="L1093"></span>
<span class="line" id="L1094">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1095">    sk_skb,</span>
<span class="line" id="L1096"></span>
<span class="line" id="L1097">    <span class="tok-comment">/// context type: bpf_cgroup_dev_ctx</span></span>
<span class="line" id="L1098">    cgroup_device,</span>
<span class="line" id="L1099"></span>
<span class="line" id="L1100">    <span class="tok-comment">/// context type: sk_msg_md</span></span>
<span class="line" id="L1101">    sk_msg,</span>
<span class="line" id="L1102"></span>
<span class="line" id="L1103">    <span class="tok-comment">/// context type: bpf_raw_tracepoint_args</span></span>
<span class="line" id="L1104">    raw_tracepoint,</span>
<span class="line" id="L1105"></span>
<span class="line" id="L1106">    <span class="tok-comment">/// context type: bpf_sock_addr</span></span>
<span class="line" id="L1107">    cgroup_sock_addr,</span>
<span class="line" id="L1108"></span>
<span class="line" id="L1109">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1110">    lwt_seg6local,</span>
<span class="line" id="L1111"></span>
<span class="line" id="L1112">    <span class="tok-comment">/// context type: u32</span></span>
<span class="line" id="L1113">    lirc_mode2,</span>
<span class="line" id="L1114"></span>
<span class="line" id="L1115">    <span class="tok-comment">/// context type: sk_reuseport_md</span></span>
<span class="line" id="L1116">    sk_reuseport,</span>
<span class="line" id="L1117"></span>
<span class="line" id="L1118">    <span class="tok-comment">/// context type: __sk_buff</span></span>
<span class="line" id="L1119">    flow_dissector,</span>
<span class="line" id="L1120"></span>
<span class="line" id="L1121">    <span class="tok-comment">/// context type: bpf_sysctl</span></span>
<span class="line" id="L1122">    cgroup_sysctl,</span>
<span class="line" id="L1123"></span>
<span class="line" id="L1124">    <span class="tok-comment">/// context type: bpf_raw_tracepoint_args</span></span>
<span class="line" id="L1125">    raw_tracepoint_writable,</span>
<span class="line" id="L1126"></span>
<span class="line" id="L1127">    <span class="tok-comment">/// context type: bpf_sockopt</span></span>
<span class="line" id="L1128">    cgroup_sockopt,</span>
<span class="line" id="L1129"></span>
<span class="line" id="L1130">    <span class="tok-comment">/// context type: void *</span></span>
<span class="line" id="L1131">    tracing,</span>
<span class="line" id="L1132"></span>
<span class="line" id="L1133">    <span class="tok-comment">/// context type: void *</span></span>
<span class="line" id="L1134">    struct_ops,</span>
<span class="line" id="L1135"></span>
<span class="line" id="L1136">    <span class="tok-comment">/// context type: void *</span></span>
<span class="line" id="L1137">    ext,</span>
<span class="line" id="L1138"></span>
<span class="line" id="L1139">    <span class="tok-comment">/// context type: void *</span></span>
<span class="line" id="L1140">    lsm,</span>
<span class="line" id="L1141"></span>
<span class="line" id="L1142">    <span class="tok-comment">/// context type: bpf_sk_lookup</span></span>
<span class="line" id="L1143">    sk_lookup,</span>
<span class="line" id="L1144"></span>
<span class="line" id="L1145">    <span class="tok-comment">/// context type: void *</span></span>
<span class="line" id="L1146">    syscall,</span>
<span class="line" id="L1147"></span>
<span class="line" id="L1148">    _,</span>
<span class="line" id="L1149">};</span>
<span class="line" id="L1150"></span>
<span class="line" id="L1151"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> AttachType = <span class="tok-kw">enum</span>(<span class="tok-type">u32</span>) {</span>
<span class="line" id="L1152">    cgroup_inet_ingress,</span>
<span class="line" id="L1153">    cgroup_inet_egress,</span>
<span class="line" id="L1154">    cgroup_inet_sock_create,</span>
<span class="line" id="L1155">    cgroup_sock_ops,</span>
<span class="line" id="L1156">    sk_skb_stream_parser,</span>
<span class="line" id="L1157">    sk_skb_stream_verdict,</span>
<span class="line" id="L1158">    cgroup_device,</span>
<span class="line" id="L1159">    sk_msg_verdict,</span>
<span class="line" id="L1160">    cgroup_inet4_bind,</span>
<span class="line" id="L1161">    cgroup_inet6_bind,</span>
<span class="line" id="L1162">    cgroup_inet4_connect,</span>
<span class="line" id="L1163">    cgroup_inet6_connect,</span>
<span class="line" id="L1164">    cgroup_inet4_post_bind,</span>
<span class="line" id="L1165">    cgroup_inet6_post_bind,</span>
<span class="line" id="L1166">    cgroup_udp4_sendmsg,</span>
<span class="line" id="L1167">    cgroup_udp6_sendmsg,</span>
<span class="line" id="L1168">    lirc_mode2,</span>
<span class="line" id="L1169">    flow_dissector,</span>
<span class="line" id="L1170">    cgroup_sysctl,</span>
<span class="line" id="L1171">    cgroup_udp4_recvmsg,</span>
<span class="line" id="L1172">    cgroup_udp6_recvmsg,</span>
<span class="line" id="L1173">    cgroup_getsockopt,</span>
<span class="line" id="L1174">    cgroup_setsockopt,</span>
<span class="line" id="L1175">    trace_raw_tp,</span>
<span class="line" id="L1176">    trace_fentry,</span>
<span class="line" id="L1177">    trace_fexit,</span>
<span class="line" id="L1178">    modify_return,</span>
<span class="line" id="L1179">    lsm_mac,</span>
<span class="line" id="L1180">    trace_iter,</span>
<span class="line" id="L1181">    cgroup_inet4_getpeername,</span>
<span class="line" id="L1182">    cgroup_inet6_getpeername,</span>
<span class="line" id="L1183">    cgroup_inet4_getsockname,</span>
<span class="line" id="L1184">    cgroup_inet6_getsockname,</span>
<span class="line" id="L1185">    xdp_devmap,</span>
<span class="line" id="L1186">    cgroup_inet_sock_release,</span>
<span class="line" id="L1187">    xdp_cpumap,</span>
<span class="line" id="L1188">    sk_lookup,</span>
<span class="line" id="L1189">    xdp,</span>
<span class="line" id="L1190">    _,</span>
<span class="line" id="L1191">};</span>
<span class="line" id="L1192"></span>
<span class="line" id="L1193"><span class="tok-kw">const</span> obj_name_len = <span class="tok-number">16</span>;</span>
<span class="line" id="L1194"><span class="tok-comment">/// struct used by Cmd.map_create command</span></span>
<span class="line" id="L1195"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MapCreateAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1196">    <span class="tok-comment">/// one of MapType</span></span>
<span class="line" id="L1197">    map_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1198"></span>
<span class="line" id="L1199">    <span class="tok-comment">/// size of key in bytes</span></span>
<span class="line" id="L1200">    key_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1201"></span>
<span class="line" id="L1202">    <span class="tok-comment">/// size of value in bytes</span></span>
<span class="line" id="L1203">    value_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1204"></span>
<span class="line" id="L1205">    <span class="tok-comment">/// max number of entries in a map</span></span>
<span class="line" id="L1206">    max_entries: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1207"></span>
<span class="line" id="L1208">    <span class="tok-comment">/// .map_create related flags</span></span>
<span class="line" id="L1209">    map_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1210"></span>
<span class="line" id="L1211">    <span class="tok-comment">/// fd pointing to the inner map</span></span>
<span class="line" id="L1212">    inner_map_fd: fd_t,</span>
<span class="line" id="L1213"></span>
<span class="line" id="L1214">    <span class="tok-comment">/// numa node (effective only if MapCreateFlags.numa_node is set)</span></span>
<span class="line" id="L1215">    numa_node: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1216">    map_name: [obj_name_len]<span class="tok-type">u8</span>,</span>
<span class="line" id="L1217"></span>
<span class="line" id="L1218">    <span class="tok-comment">/// ifindex of netdev to create on</span></span>
<span class="line" id="L1219">    map_ifindex: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1220"></span>
<span class="line" id="L1221">    <span class="tok-comment">/// fd pointing to a BTF type data</span></span>
<span class="line" id="L1222">    btf_fd: fd_t,</span>
<span class="line" id="L1223"></span>
<span class="line" id="L1224">    <span class="tok-comment">/// BTF type_id of the key</span></span>
<span class="line" id="L1225">    btf_key_type_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1226"></span>
<span class="line" id="L1227">    <span class="tok-comment">/// BTF type_id of the value</span></span>
<span class="line" id="L1228">    bpf_value_type_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1229"></span>
<span class="line" id="L1230">    <span class="tok-comment">/// BTF type_id of a kernel struct stored as the map value</span></span>
<span class="line" id="L1231">    btf_vmlinux_value_type_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1232">};</span>
<span class="line" id="L1233"></span>
<span class="line" id="L1234"><span class="tok-comment">/// struct used by Cmd.map_*_elem commands</span></span>
<span class="line" id="L1235"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MapElemAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1236">    map_fd: fd_t,</span>
<span class="line" id="L1237">    key: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1238">    result: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L1239">        value: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1240">        next_key: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1241">    },</span>
<span class="line" id="L1242">    flags: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1243">};</span>
<span class="line" id="L1244"></span>
<span class="line" id="L1245"><span class="tok-comment">/// struct used by Cmd.map_*_batch commands</span></span>
<span class="line" id="L1246"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MapBatchAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1247">    <span class="tok-comment">/// start batch, NULL to start from beginning</span></span>
<span class="line" id="L1248">    in_batch: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1249"></span>
<span class="line" id="L1250">    <span class="tok-comment">/// output: next start batch</span></span>
<span class="line" id="L1251">    out_batch: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1252">    keys: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1253">    values: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1254"></span>
<span class="line" id="L1255">    <span class="tok-comment">/// input/output:</span></span>
<span class="line" id="L1256">    <span class="tok-comment">/// input: # of key/value elements</span></span>
<span class="line" id="L1257">    <span class="tok-comment">/// output: # of filled elements</span></span>
<span class="line" id="L1258">    count: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1259">    map_fd: fd_t,</span>
<span class="line" id="L1260">    elem_flags: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1261">    flags: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1262">};</span>
<span class="line" id="L1263"></span>
<span class="line" id="L1264"><span class="tok-comment">/// struct used by Cmd.prog_load command</span></span>
<span class="line" id="L1265"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ProgLoadAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1266">    <span class="tok-comment">/// one of ProgType</span></span>
<span class="line" id="L1267">    prog_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1268">    insn_cnt: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1269">    insns: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1270">    license: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1271"></span>
<span class="line" id="L1272">    <span class="tok-comment">/// verbosity level of verifier</span></span>
<span class="line" id="L1273">    log_level: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1274"></span>
<span class="line" id="L1275">    <span class="tok-comment">/// size of user buffer</span></span>
<span class="line" id="L1276">    log_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1277"></span>
<span class="line" id="L1278">    <span class="tok-comment">/// user supplied buffer</span></span>
<span class="line" id="L1279">    log_buf: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1280"></span>
<span class="line" id="L1281">    <span class="tok-comment">/// not used</span></span>
<span class="line" id="L1282">    kern_version: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1283">    prog_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1284">    prog_name: [obj_name_len]<span class="tok-type">u8</span>,</span>
<span class="line" id="L1285"></span>
<span class="line" id="L1286">    <span class="tok-comment">/// ifindex of netdev to prep for.</span></span>
<span class="line" id="L1287">    prog_ifindex: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1288"></span>
<span class="line" id="L1289">    <span class="tok-comment">/// For some prog types expected attach type must be known at load time to</span></span>
<span class="line" id="L1290">    <span class="tok-comment">/// verify attach type specific parts of prog (context accesses, allowed</span></span>
<span class="line" id="L1291">    <span class="tok-comment">/// helpers, etc).</span></span>
<span class="line" id="L1292">    expected_attach_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1293"></span>
<span class="line" id="L1294">    <span class="tok-comment">/// fd pointing to BTF type data</span></span>
<span class="line" id="L1295">    prog_btf_fd: fd_t,</span>
<span class="line" id="L1296"></span>
<span class="line" id="L1297">    <span class="tok-comment">/// userspace bpf_func_info size</span></span>
<span class="line" id="L1298">    func_info_rec_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1299">    func_info: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1300"></span>
<span class="line" id="L1301">    <span class="tok-comment">/// number of bpf_func_info records</span></span>
<span class="line" id="L1302">    func_info_cnt: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1303"></span>
<span class="line" id="L1304">    <span class="tok-comment">/// userspace bpf_line_info size</span></span>
<span class="line" id="L1305">    line_info_rec_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1306">    line_info: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1307"></span>
<span class="line" id="L1308">    <span class="tok-comment">/// number of bpf_line_info records</span></span>
<span class="line" id="L1309">    line_info_cnt: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1310"></span>
<span class="line" id="L1311">    <span class="tok-comment">/// in-kernel BTF type id to attach to</span></span>
<span class="line" id="L1312">    attact_btf_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1313"></span>
<span class="line" id="L1314">    <span class="tok-comment">/// 0 to attach to vmlinux</span></span>
<span class="line" id="L1315">    attach_prog_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1316">};</span>
<span class="line" id="L1317"></span>
<span class="line" id="L1318"><span class="tok-comment">/// struct used by Cmd.obj_* commands</span></span>
<span class="line" id="L1319"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ObjAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1320">    pathname: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1321">    bpf_fd: fd_t,</span>
<span class="line" id="L1322">    file_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1323">};</span>
<span class="line" id="L1324"></span>
<span class="line" id="L1325"><span class="tok-comment">/// struct used by Cmd.prog_attach/detach commands</span></span>
<span class="line" id="L1326"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ProgAttachAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1327">    <span class="tok-comment">/// container object to attach to</span></span>
<span class="line" id="L1328">    target_fd: fd_t,</span>
<span class="line" id="L1329"></span>
<span class="line" id="L1330">    <span class="tok-comment">/// eBPF program to attach</span></span>
<span class="line" id="L1331">    attach_bpf_fd: fd_t,</span>
<span class="line" id="L1332"></span>
<span class="line" id="L1333">    attach_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1334">    attach_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1335"></span>
<span class="line" id="L1336">    <span class="tok-comment">// TODO: BPF_F_REPLACE flags</span>
</span>
<span class="line" id="L1337">    <span class="tok-comment">/// previously attached eBPF program to replace if .replace is used</span></span>
<span class="line" id="L1338">    replace_bpf_fd: fd_t,</span>
<span class="line" id="L1339">};</span>
<span class="line" id="L1340"></span>
<span class="line" id="L1341"><span class="tok-comment">/// struct used by Cmd.prog_test_run command</span></span>
<span class="line" id="L1342"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TestRunAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1343">    prog_fd: fd_t,</span>
<span class="line" id="L1344">    retval: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1345"></span>
<span class="line" id="L1346">    <span class="tok-comment">/// input: len of data_in</span></span>
<span class="line" id="L1347">    data_size_in: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1348"></span>
<span class="line" id="L1349">    <span class="tok-comment">/// input/output: len of data_out. returns ENOSPC if data_out is too small.</span></span>
<span class="line" id="L1350">    data_size_out: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1351">    data_in: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1352">    data_out: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1353">    repeat: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1354">    duration: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1355"></span>
<span class="line" id="L1356">    <span class="tok-comment">/// input: len of ctx_in</span></span>
<span class="line" id="L1357">    ctx_size_in: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1358"></span>
<span class="line" id="L1359">    <span class="tok-comment">/// input/output: len of ctx_out. returns ENOSPC if ctx_out is too small.</span></span>
<span class="line" id="L1360">    ctx_size_out: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1361">    ctx_in: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1362">    ctx_out: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1363">};</span>
<span class="line" id="L1364"></span>
<span class="line" id="L1365"><span class="tok-comment">/// struct used by Cmd.*_get_*_id commands</span></span>
<span class="line" id="L1366"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> GetIdAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1367">    id: <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L1368">        start_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1369">        prog_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1370">        map_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1371">        btf_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1372">        link_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1373">    },</span>
<span class="line" id="L1374">    next_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1375">    open_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1376">};</span>
<span class="line" id="L1377"></span>
<span class="line" id="L1378"><span class="tok-comment">/// struct used by Cmd.obj_get_info_by_fd command</span></span>
<span class="line" id="L1379"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> InfoAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1380">    bpf_fd: fd_t,</span>
<span class="line" id="L1381">    info_len: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1382">    info: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1383">};</span>
<span class="line" id="L1384"></span>
<span class="line" id="L1385"><span class="tok-comment">/// struct used by Cmd.prog_query command</span></span>
<span class="line" id="L1386"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> QueryAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1387">    <span class="tok-comment">/// container object to query</span></span>
<span class="line" id="L1388">    target_fd: fd_t,</span>
<span class="line" id="L1389">    attach_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1390">    query_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1391">    attach_flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1392">    prog_ids: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1393">    prog_cnt: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1394">};</span>
<span class="line" id="L1395"></span>
<span class="line" id="L1396"><span class="tok-comment">/// struct used by Cmd.raw_tracepoint_open command</span></span>
<span class="line" id="L1397"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> RawTracepointAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1398">    name: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1399">    prog_fd: fd_t,</span>
<span class="line" id="L1400">};</span>
<span class="line" id="L1401"></span>
<span class="line" id="L1402"><span class="tok-comment">/// struct used by Cmd.btf_load command</span></span>
<span class="line" id="L1403"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> BtfLoadAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1404">    btf: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1405">    btf_log_buf: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1406">    btf_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1407">    btf_log_size: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1408">    btf_log_level: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1409">};</span>
<span class="line" id="L1410"></span>
<span class="line" id="L1411"><span class="tok-comment">/// struct used by Cmd.task_fd_query</span></span>
<span class="line" id="L1412"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> TaskFdQueryAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1413">    <span class="tok-comment">/// input: pid</span></span>
<span class="line" id="L1414">    pid: pid_t,</span>
<span class="line" id="L1415"></span>
<span class="line" id="L1416">    <span class="tok-comment">/// input: fd</span></span>
<span class="line" id="L1417">    fd: fd_t,</span>
<span class="line" id="L1418"></span>
<span class="line" id="L1419">    <span class="tok-comment">/// input: flags</span></span>
<span class="line" id="L1420">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1421"></span>
<span class="line" id="L1422">    <span class="tok-comment">/// input/output: buf len</span></span>
<span class="line" id="L1423">    buf_len: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1424"></span>
<span class="line" id="L1425">    <span class="tok-comment">/// input/output:</span></span>
<span class="line" id="L1426">    <span class="tok-comment">///     tp_name for tracepoint</span></span>
<span class="line" id="L1427">    <span class="tok-comment">///     symbol for kprobe</span></span>
<span class="line" id="L1428">    <span class="tok-comment">///     filename for uprobe</span></span>
<span class="line" id="L1429">    buf: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1430"></span>
<span class="line" id="L1431">    <span class="tok-comment">/// output: prod_id</span></span>
<span class="line" id="L1432">    prog_id: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1433"></span>
<span class="line" id="L1434">    <span class="tok-comment">/// output: BPF_FD_TYPE</span></span>
<span class="line" id="L1435">    fd_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1436"></span>
<span class="line" id="L1437">    <span class="tok-comment">/// output: probe_offset</span></span>
<span class="line" id="L1438">    probe_offset: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1439"></span>
<span class="line" id="L1440">    <span class="tok-comment">/// output: probe_addr</span></span>
<span class="line" id="L1441">    probe_addr: <span class="tok-type">u64</span>,</span>
<span class="line" id="L1442">};</span>
<span class="line" id="L1443"></span>
<span class="line" id="L1444"><span class="tok-comment">/// struct used by Cmd.link_create command</span></span>
<span class="line" id="L1445"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkCreateAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1446">    <span class="tok-comment">/// eBPF program to attach</span></span>
<span class="line" id="L1447">    prog_fd: fd_t,</span>
<span class="line" id="L1448"></span>
<span class="line" id="L1449">    <span class="tok-comment">/// object to attach to</span></span>
<span class="line" id="L1450">    target_fd: fd_t,</span>
<span class="line" id="L1451">    attach_type: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1452"></span>
<span class="line" id="L1453">    <span class="tok-comment">/// extra flags</span></span>
<span class="line" id="L1454">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1455">};</span>
<span class="line" id="L1456"></span>
<span class="line" id="L1457"><span class="tok-comment">/// struct used by Cmd.link_update command</span></span>
<span class="line" id="L1458"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> LinkUpdateAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1459">    link_fd: fd_t,</span>
<span class="line" id="L1460"></span>
<span class="line" id="L1461">    <span class="tok-comment">/// new program to update link with</span></span>
<span class="line" id="L1462">    new_prog_fd: fd_t,</span>
<span class="line" id="L1463"></span>
<span class="line" id="L1464">    <span class="tok-comment">/// extra flags</span></span>
<span class="line" id="L1465">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1466"></span>
<span class="line" id="L1467">    <span class="tok-comment">/// expected link's program fd, it is specified only if BPF_F_REPLACE is</span></span>
<span class="line" id="L1468">    <span class="tok-comment">/// set in flags</span></span>
<span class="line" id="L1469">    old_prog_fd: fd_t,</span>
<span class="line" id="L1470">};</span>
<span class="line" id="L1471"></span>
<span class="line" id="L1472"><span class="tok-comment">/// struct used by Cmd.enable_stats command</span></span>
<span class="line" id="L1473"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> EnableStatsAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1474">    <span class="tok-type">type</span>: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1475">};</span>
<span class="line" id="L1476"></span>
<span class="line" id="L1477"><span class="tok-comment">/// struct used by Cmd.iter_create command</span></span>
<span class="line" id="L1478"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> IterCreateAttr = <span class="tok-kw">extern</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1479">    link_fd: fd_t,</span>
<span class="line" id="L1480">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1481">};</span>
<span class="line" id="L1482"></span>
<span class="line" id="L1483"><span class="tok-comment">/// Mega struct that is passed to the bpf() syscall</span></span>
<span class="line" id="L1484"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Attr = <span class="tok-kw">extern</span> <span class="tok-kw">union</span> {</span>
<span class="line" id="L1485">    map_create: MapCreateAttr,</span>
<span class="line" id="L1486">    map_elem: MapElemAttr,</span>
<span class="line" id="L1487">    map_batch: MapBatchAttr,</span>
<span class="line" id="L1488">    prog_load: ProgLoadAttr,</span>
<span class="line" id="L1489">    obj: ObjAttr,</span>
<span class="line" id="L1490">    prog_attach: ProgAttachAttr,</span>
<span class="line" id="L1491">    test_run: TestRunAttr,</span>
<span class="line" id="L1492">    get_id: GetIdAttr,</span>
<span class="line" id="L1493">    info: InfoAttr,</span>
<span class="line" id="L1494">    query: QueryAttr,</span>
<span class="line" id="L1495">    raw_tracepoint: RawTracepointAttr,</span>
<span class="line" id="L1496">    btf_load: BtfLoadAttr,</span>
<span class="line" id="L1497">    task_fd_query: TaskFdQueryAttr,</span>
<span class="line" id="L1498">    link_create: LinkCreateAttr,</span>
<span class="line" id="L1499">    link_update: LinkUpdateAttr,</span>
<span class="line" id="L1500">    enable_stats: EnableStatsAttr,</span>
<span class="line" id="L1501">    iter_create: IterCreateAttr,</span>
<span class="line" id="L1502">};</span>
<span class="line" id="L1503"></span>
<span class="line" id="L1504"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Log = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L1505">    level: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1506">    buf: []<span class="tok-type">u8</span>,</span>
<span class="line" id="L1507">};</span>
<span class="line" id="L1508"></span>
<span class="line" id="L1509"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">map_create</span>(map_type: MapType, key_size: <span class="tok-type">u32</span>, value_size: <span class="tok-type">u32</span>, max_entries: <span class="tok-type">u32</span>) !fd_t {</span>
<span class="line" id="L1510">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1511">        .map_create = std.mem.zeroes(MapCreateAttr),</span>
<span class="line" id="L1512">    };</span>
<span class="line" id="L1513"></span>
<span class="line" id="L1514">    attr.map_create.map_type = <span class="tok-builtin">@intFromEnum</span>(map_type);</span>
<span class="line" id="L1515">    attr.map_create.key_size = key_size;</span>
<span class="line" id="L1516">    attr.map_create.value_size = value_size;</span>
<span class="line" id="L1517">    attr.map_create.max_entries = max_entries;</span>
<span class="line" id="L1518"></span>
<span class="line" id="L1519">    <span class="tok-kw">const</span> rc = linux.bpf(.map_create, &amp;attr, <span class="tok-builtin">@sizeOf</span>(MapCreateAttr));</span>
<span class="line" id="L1520">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1521">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-builtin">@as</span>(fd_t, <span class="tok-builtin">@intCast</span>(rc)),</span>
<span class="line" id="L1522">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.MapTypeOrAttrInvalid,</span>
<span class="line" id="L1523">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1524">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1525">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1526">    }</span>
<span class="line" id="L1527">}</span>
<span class="line" id="L1528"></span>
<span class="line" id="L1529"><span class="tok-kw">test</span> <span class="tok-str">&quot;map_create&quot;</span> {</span>
<span class="line" id="L1530">    <span class="tok-kw">const</span> map = <span class="tok-kw">try</span> map_create(.hash, <span class="tok-number">4</span>, <span class="tok-number">4</span>, <span class="tok-number">32</span>);</span>
<span class="line" id="L1531">    <span class="tok-kw">defer</span> std.os.close(map);</span>
<span class="line" id="L1532">}</span>
<span class="line" id="L1533"></span>
<span class="line" id="L1534"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">map_lookup_elem</span>(fd: fd_t, key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: []<span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1535">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1536">        .map_elem = std.mem.zeroes(MapElemAttr),</span>
<span class="line" id="L1537">    };</span>
<span class="line" id="L1538"></span>
<span class="line" id="L1539">    attr.map_elem.map_fd = fd;</span>
<span class="line" id="L1540">    attr.map_elem.key = <span class="tok-builtin">@intFromPtr</span>(key.ptr);</span>
<span class="line" id="L1541">    attr.map_elem.result.value = <span class="tok-builtin">@intFromPtr</span>(value.ptr);</span>
<span class="line" id="L1542"></span>
<span class="line" id="L1543">    <span class="tok-kw">const</span> rc = linux.bpf(.map_lookup_elem, &amp;attr, <span class="tok-builtin">@sizeOf</span>(MapElemAttr));</span>
<span class="line" id="L1544">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1545">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1546">        .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadFd,</span>
<span class="line" id="L1547">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1548">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FieldInAttrNeedsZeroing,</span>
<span class="line" id="L1549">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotFound,</span>
<span class="line" id="L1550">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1551">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1552">    }</span>
<span class="line" id="L1553">}</span>
<span class="line" id="L1554"></span>
<span class="line" id="L1555"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">map_update_elem</span>(fd: fd_t, key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, value: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, flags: <span class="tok-type">u64</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1556">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1557">        .map_elem = std.mem.zeroes(MapElemAttr),</span>
<span class="line" id="L1558">    };</span>
<span class="line" id="L1559"></span>
<span class="line" id="L1560">    attr.map_elem.map_fd = fd;</span>
<span class="line" id="L1561">    attr.map_elem.key = <span class="tok-builtin">@intFromPtr</span>(key.ptr);</span>
<span class="line" id="L1562">    attr.map_elem.result = .{ .value = <span class="tok-builtin">@intFromPtr</span>(value.ptr) };</span>
<span class="line" id="L1563">    attr.map_elem.flags = flags;</span>
<span class="line" id="L1564"></span>
<span class="line" id="L1565">    <span class="tok-kw">const</span> rc = linux.bpf(.map_update_elem, &amp;attr, <span class="tok-builtin">@sizeOf</span>(MapElemAttr));</span>
<span class="line" id="L1566">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1567">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1568">        .@&quot;2BIG&quot; =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.ReachedMaxEntries,</span>
<span class="line" id="L1569">        .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadFd,</span>
<span class="line" id="L1570">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1571">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FieldInAttrNeedsZeroing,</span>
<span class="line" id="L1572">        .NOMEM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SystemResources,</span>
<span class="line" id="L1573">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1574">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1575">    }</span>
<span class="line" id="L1576">}</span>
<span class="line" id="L1577"></span>
<span class="line" id="L1578"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">map_delete_elem</span>(fd: fd_t, key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L1579">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1580">        .map_elem = std.mem.zeroes(MapElemAttr),</span>
<span class="line" id="L1581">    };</span>
<span class="line" id="L1582"></span>
<span class="line" id="L1583">    attr.map_elem.map_fd = fd;</span>
<span class="line" id="L1584">    attr.map_elem.key = <span class="tok-builtin">@intFromPtr</span>(key.ptr);</span>
<span class="line" id="L1585"></span>
<span class="line" id="L1586">    <span class="tok-kw">const</span> rc = linux.bpf(.map_delete_elem, &amp;attr, <span class="tok-builtin">@sizeOf</span>(MapElemAttr));</span>
<span class="line" id="L1587">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1588">        .SUCCESS =&gt; <span class="tok-kw">return</span>,</span>
<span class="line" id="L1589">        .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadFd,</span>
<span class="line" id="L1590">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1591">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FieldInAttrNeedsZeroing,</span>
<span class="line" id="L1592">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.NotFound,</span>
<span class="line" id="L1593">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1594">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1595">    }</span>
<span class="line" id="L1596">}</span>
<span class="line" id="L1597"></span>
<span class="line" id="L1598"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">map_get_next_key</span>(fd: fd_t, key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, next_key: []<span class="tok-type">u8</span>) !<span class="tok-type">bool</span> {</span>
<span class="line" id="L1599">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1600">        .map_elem = std.mem.zeroes(MapElemAttr),</span>
<span class="line" id="L1601">    };</span>
<span class="line" id="L1602"></span>
<span class="line" id="L1603">    attr.map_elem.map_fd = fd;</span>
<span class="line" id="L1604">    attr.map_elem.key = <span class="tok-builtin">@intFromPtr</span>(key.ptr);</span>
<span class="line" id="L1605">    attr.map_elem.result.next_key = <span class="tok-builtin">@intFromPtr</span>(next_key.ptr);</span>
<span class="line" id="L1606"></span>
<span class="line" id="L1607">    <span class="tok-kw">const</span> rc = linux.bpf(.map_get_next_key, &amp;attr, <span class="tok-builtin">@sizeOf</span>(MapElemAttr));</span>
<span class="line" id="L1608">    <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1609">        .SUCCESS =&gt; <span class="tok-kw">return</span> <span class="tok-null">true</span>,</span>
<span class="line" id="L1610">        .BADF =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.BadFd,</span>
<span class="line" id="L1611">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1612">        .INVAL =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.FieldInAttrNeedsZeroing,</span>
<span class="line" id="L1613">        .NOENT =&gt; <span class="tok-kw">return</span> <span class="tok-null">false</span>,</span>
<span class="line" id="L1614">        .PERM =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1615">        <span class="tok-kw">else</span> =&gt; |err| <span class="tok-kw">return</span> unexpectedErrno(err),</span>
<span class="line" id="L1616">    }</span>
<span class="line" id="L1617">}</span>
<span class="line" id="L1618"></span>
<span class="line" id="L1619"><span class="tok-kw">test</span> <span class="tok-str">&quot;map lookup, update, and delete&quot;</span> {</span>
<span class="line" id="L1620">    <span class="tok-kw">const</span> key_size = <span class="tok-number">4</span>;</span>
<span class="line" id="L1621">    <span class="tok-kw">const</span> value_size = <span class="tok-number">4</span>;</span>
<span class="line" id="L1622">    <span class="tok-kw">const</span> map = <span class="tok-kw">try</span> map_create(.hash, key_size, value_size, <span class="tok-number">1</span>);</span>
<span class="line" id="L1623">    <span class="tok-kw">defer</span> std.os.close(map);</span>
<span class="line" id="L1624"></span>
<span class="line" id="L1625">    <span class="tok-kw">const</span> key = std.mem.zeroes([key_size]<span class="tok-type">u8</span>);</span>
<span class="line" id="L1626">    <span class="tok-kw">var</span> value = std.mem.zeroes([value_size]<span class="tok-type">u8</span>);</span>
<span class="line" id="L1627"></span>
<span class="line" id="L1628">    <span class="tok-comment">// fails looking up value that doesn't exist</span>
</span>
<span class="line" id="L1629">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.NotFound, map_lookup_elem(map, &amp;key, &amp;value));</span>
<span class="line" id="L1630"></span>
<span class="line" id="L1631">    <span class="tok-comment">// succeed at updating and looking up element</span>
</span>
<span class="line" id="L1632">    <span class="tok-kw">try</span> map_update_elem(map, &amp;key, &amp;value, <span class="tok-number">0</span>);</span>
<span class="line" id="L1633">    <span class="tok-kw">try</span> map_lookup_elem(map, &amp;key, &amp;value);</span>
<span class="line" id="L1634"></span>
<span class="line" id="L1635">    <span class="tok-comment">// fails inserting more than max entries</span>
</span>
<span class="line" id="L1636">    <span class="tok-kw">const</span> second_key = [key_size]<span class="tok-type">u8</span>{ <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">1</span> };</span>
<span class="line" id="L1637">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.ReachedMaxEntries, map_update_elem(map, &amp;second_key, &amp;value, <span class="tok-number">0</span>));</span>
<span class="line" id="L1638"></span>
<span class="line" id="L1639">    <span class="tok-comment">// succeed at iterating all keys of map</span>
</span>
<span class="line" id="L1640">    <span class="tok-kw">var</span> lookup_key = [_]<span class="tok-type">u8</span>{ <span class="tok-number">1</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> };</span>
<span class="line" id="L1641">    <span class="tok-kw">var</span> next_key = [_]<span class="tok-type">u8</span>{ <span class="tok-number">2</span>, <span class="tok-number">3</span>, <span class="tok-number">4</span>, <span class="tok-number">5</span> }; <span class="tok-comment">// garbage value</span>
</span>
<span class="line" id="L1642">    <span class="tok-kw">const</span> status = <span class="tok-kw">try</span> map_get_next_key(map, &amp;lookup_key, &amp;next_key);</span>
<span class="line" id="L1643">    <span class="tok-kw">try</span> expectEqual(status, <span class="tok-null">true</span>);</span>
<span class="line" id="L1644">    <span class="tok-kw">try</span> expectEqual(next_key, key);</span>
<span class="line" id="L1645">    lookup_key = next_key;</span>
<span class="line" id="L1646">    <span class="tok-kw">const</span> status2 = <span class="tok-kw">try</span> map_get_next_key(map, &amp;lookup_key, &amp;next_key);</span>
<span class="line" id="L1647">    <span class="tok-kw">try</span> expectEqual(status2, <span class="tok-null">false</span>);</span>
<span class="line" id="L1648"></span>
<span class="line" id="L1649">    <span class="tok-comment">// succeed at deleting an existing elem</span>
</span>
<span class="line" id="L1650">    <span class="tok-kw">try</span> map_delete_elem(map, &amp;key);</span>
<span class="line" id="L1651">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.NotFound, map_lookup_elem(map, &amp;key, &amp;value));</span>
<span class="line" id="L1652"></span>
<span class="line" id="L1653">    <span class="tok-comment">// fail at deleting a non-existing elem</span>
</span>
<span class="line" id="L1654">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.NotFound, map_delete_elem(map, &amp;key));</span>
<span class="line" id="L1655">}</span>
<span class="line" id="L1656"></span>
<span class="line" id="L1657"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">prog_load</span>(</span>
<span class="line" id="L1658">    prog_type: ProgType,</span>
<span class="line" id="L1659">    insns: []<span class="tok-kw">const</span> Insn,</span>
<span class="line" id="L1660">    log: ?*Log,</span>
<span class="line" id="L1661">    license: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L1662">    kern_version: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1663">    flags: <span class="tok-type">u32</span>,</span>
<span class="line" id="L1664">) !fd_t {</span>
<span class="line" id="L1665">    <span class="tok-kw">var</span> attr = Attr{</span>
<span class="line" id="L1666">        .prog_load = std.mem.zeroes(ProgLoadAttr),</span>
<span class="line" id="L1667">    };</span>
<span class="line" id="L1668"></span>
<span class="line" id="L1669">    attr.prog_load.prog_type = <span class="tok-builtin">@intFromEnum</span>(prog_type);</span>
<span class="line" id="L1670">    attr.prog_load.insns = <span class="tok-builtin">@intFromPtr</span>(insns.ptr);</span>
<span class="line" id="L1671">    attr.prog_load.insn_cnt = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(insns.len));</span>
<span class="line" id="L1672">    attr.prog_load.license = <span class="tok-builtin">@intFromPtr</span>(license.ptr);</span>
<span class="line" id="L1673">    attr.prog_load.kern_version = kern_version;</span>
<span class="line" id="L1674">    attr.prog_load.prog_flags = flags;</span>
<span class="line" id="L1675"></span>
<span class="line" id="L1676">    <span class="tok-kw">if</span> (log) |l| {</span>
<span class="line" id="L1677">        attr.prog_load.log_buf = <span class="tok-builtin">@intFromPtr</span>(l.buf.ptr);</span>
<span class="line" id="L1678">        attr.prog_load.log_size = <span class="tok-builtin">@as</span>(<span class="tok-type">u32</span>, <span class="tok-builtin">@intCast</span>(l.buf.len));</span>
<span class="line" id="L1679">        attr.prog_load.log_level = l.level;</span>
<span class="line" id="L1680">    }</span>
<span class="line" id="L1681"></span>
<span class="line" id="L1682">    <span class="tok-kw">const</span> rc = linux.bpf(.prog_load, &amp;attr, <span class="tok-builtin">@sizeOf</span>(ProgLoadAttr));</span>
<span class="line" id="L1683">    <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (errno(rc)) {</span>
<span class="line" id="L1684">        .SUCCESS =&gt; <span class="tok-builtin">@as</span>(fd_t, <span class="tok-builtin">@intCast</span>(rc)),</span>
<span class="line" id="L1685">        .ACCES =&gt; <span class="tok-kw">error</span>.UnsafeProgram,</span>
<span class="line" id="L1686">        .FAULT =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L1687">        .INVAL =&gt; <span class="tok-kw">error</span>.InvalidProgram,</span>
<span class="line" id="L1688">        .PERM =&gt; <span class="tok-kw">error</span>.AccessDenied,</span>
<span class="line" id="L1689">        <span class="tok-kw">else</span> =&gt; |err| unexpectedErrno(err),</span>
<span class="line" id="L1690">    };</span>
<span class="line" id="L1691">}</span>
<span class="line" id="L1692"></span>
<span class="line" id="L1693"><span class="tok-kw">test</span> <span class="tok-str">&quot;prog_load&quot;</span> {</span>
<span class="line" id="L1694">    <span class="tok-comment">// this should fail because it does not set r0 before exiting</span>
</span>
<span class="line" id="L1695">    <span class="tok-kw">const</span> bad_prog = [_]Insn{</span>
<span class="line" id="L1696">        Insn.exit(),</span>
<span class="line" id="L1697">    };</span>
<span class="line" id="L1698"></span>
<span class="line" id="L1699">    <span class="tok-kw">const</span> good_prog = [_]Insn{</span>
<span class="line" id="L1700">        Insn.mov(.r0, <span class="tok-number">0</span>),</span>
<span class="line" id="L1701">        Insn.exit(),</span>
<span class="line" id="L1702">    };</span>
<span class="line" id="L1703"></span>
<span class="line" id="L1704">    <span class="tok-kw">const</span> prog = <span class="tok-kw">try</span> prog_load(.socket_filter, &amp;good_prog, <span class="tok-null">null</span>, <span class="tok-str">&quot;MIT&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>);</span>
<span class="line" id="L1705">    <span class="tok-kw">defer</span> std.os.close(prog);</span>
<span class="line" id="L1706"></span>
<span class="line" id="L1707">    <span class="tok-kw">try</span> expectError(<span class="tok-kw">error</span>.UnsafeProgram, prog_load(.socket_filter, &amp;bad_prog, <span class="tok-null">null</span>, <span class="tok-str">&quot;MIT&quot;</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>));</span>
<span class="line" id="L1708">}</span>
<span class="line" id="L1709"></span>
</code></pre></body>
</html>